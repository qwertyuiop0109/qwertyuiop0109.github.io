
		location ~* ^\/05suban(\/.*|$) {
			error_page  439 = @http05suban;
			error_page  440 = @https05suban;

			if ( $scheme != 'https' ) {
				return 439;
			}

			if ( $scheme = 'https' ) {
				return 440;
			}

		}


		location @https05suban {

#передаем ip-адрес клиента в строке запроса, не надо отслеживать ? & - это nginx сам сделает
			rewrite \/05suban(.*) $1?uip=$remote_addr break;



			proxy_pass         https://www.googleadservices.com;
			proxy_set_header   Host             www.googleadservices.com;

			proxy_redirect     off;

			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;


		}


		location @http05suban {

#передаем ip-адрес клиента в строке запроса, не надо отслеживать ? & - это nginx сам сделает
			rewrite \/05suban(.*) $1?uip=$remote_addr break;



			proxy_pass         http://www.googleadservices.com;
			proxy_set_header   Host             www.googleadservices.com;


			proxy_redirect     off;

			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

		}




		location ~* ^\/06suban(\/.*|$) {
			error_page  441 = @http06suban;
			error_page  442 = @https06suban;

			if ( $scheme != 'https' ) {
				return 441;
			}

			if ( $scheme = 'https' ) {
				return 442;
			}

		}


		location @https06suban {

#передаем ip-адрес клиента в строке запроса, не надо отслеживать ? & - это nginx сам сделает
			rewrite \/06suban(.*) $1?uip=$remote_addr break;



			proxy_pass         https://googleads.g.doubleclick.net;
			proxy_set_header   Host             googleads.g.doubleclick.net;

			proxy_redirect     off;

			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;


		}


		location @http06suban {

#передаем ip-адрес клиента в строке запроса, не надо отслеживать ? & - это nginx сам сделает
			rewrite \/06suban(.*) $1?uip=$remote_addr break;



			proxy_pass         http://googleads.g.doubleclick.net;
			proxy_set_header   Host             googleads.g.doubleclick.net;


			proxy_redirect     off;

			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

		}





		include whiteip.conf;
		if ( $remote_addr = $mainwhiteip ) {
			set $whitelistip 1;
			set $exploitprotect 0;
		}

		if ($proxy_ip ~* \:) {
			set $proxy_ip [$proxy_ip];
		}
		set $proxy_pass http://$proxy_ip:$proxy_port;


		if ( $scheme = 'https' ) {
			set $proxy_pass https://$proxy_ip:$proxy_ssl_port;
		}


		recursive_error_pages on;
		error_page  589 = @444;
		if ($request_method !~ ^(GET|HEAD|POST)$ ) {
			return 589;
		}

		location @clickurls {
			error_page  503 = @humanverifyclick;

			limit_req   zone=req_click  burst=11 nodelay;
			limit_conn  conn_click  12;

#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/clickaccess.log main;
			access_log /var/log/nginx/unblockedaccess.log main;

			recursive_error_pages on;

			error_page  599 = @humanverifiedclick;

			error_page  596 = @whiteipclick;

			error_page  580 = @onepagelocation;

			error_page  598 = @notclickurls;

			error_page  581 = @401;


			if ($request_uri ~* ^\/(pagescripts|pagehtml|manimg)\/) {
				set $scritpsonpages 1;
			}


			if ( $scritpsonpages ) {
				return 598;
			}

			if ($whitelistip) {
				return 596;
			}

			if ($exploitprotect) {
				set $exploitprotect $exploit;
			}
			if ($exploitprotect) {
				return 581;
			}

			set $capcha_invite '';
			if ( $check_ha = "0" ) {
				set $capcha_invite INV;
			}
			if ( -f "/var/log/503ips/$remote_addr" ) {
				set $capcha_invite 1$capcha_invite;
			}
			if ($capcha_invite ~ 1INV) {
				set $forfu $set503andcookie;
				return 580;
			}
			if ($capcha_invite !~ INV) {
				return 599;
			}



			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;

		}

		location / {


			location = /map.php {
				error_page  503 = @503;
				limit_req   zone=req_click  burst=1 nodelay;
				limit_conn  conn_click  2;
#				access_log /var/log/nginx/access.log  main;
				access_log /var/log/nginx/scanaccess.log main;
				access_log /var/log/nginx/slowrobotaccess.log main;
				access_log /var/log/nginx/unblockedaccess.log main;
				root /home/nginx;
			}


			location / {
				error_page  503 = @humanverify;
				limit_req   zone=req_img  burst=200 nodelay;
				limit_conn  conn_img  200;

#				access_log /var/log/nginx/access.log  main;
				access_log /var/log/nginx/unblockedaccess.log main;

				recursive_error_pages on;

				error_page  599 = @humanverified;

				error_page  596 = @whiteip;

				error_page  580 = @onepagelocation;

				error_page  597 = @clickurls;
				if ($clickpageurl) {
					return 597;
				}

				if ($whitelistip) {
					return 596;
				}

				set $capcha_invite '';
				if ( $check_ha = "0" ) {
					set $capcha_invite INV;
				}
				if ( -f "/var/log/503ips/$remote_addr" ) {
					set $capcha_invite 1$capcha_invite;
				}


				if ( $cookie_fu ) {
					set $capcha_invite 2$capcha_invite;
				}
				if ($capcha_invite ~ 21INV) {
					set $forfu $set503withoutcookie;
					return 580;
				}


				if ($capcha_invite ~ 1INV) {
					set $forfu $set503andcookie;
					return 580;
				}
				if ($capcha_invite !~ INV) {
					return 599;
				}

proxy_cache one;
proxy_cache_key "$request_method|$http_if_modified_since|$http_if_none_match|$is_args|$host|$request_uri";
proxy_hide_header "Set-Cookie";
proxy_ignore_headers "Cache-Control" "Expires";
proxy_cache_valid 200 10m;
proxy_cache_valid 302 304 5m;
proxy_cache_valid 301 1h;
proxy_cache_valid 503 4s;
proxy_cache_valid any 10m;
proxy_cache_use_stale http_502 http_503 http_504;


				proxy_pass         $proxy_pass;
				proxy_redirect     off;
				proxy_set_header   Host             $host;
				proxy_set_header   X-Real-IP        $remote_addr;
				proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

				client_max_body_size       10m;
				client_body_buffer_size    128k;
				proxy_connect_timeout      90;
				proxy_send_timeout         90;
				proxy_read_timeout         90;
				proxy_buffer_size          4k;
				proxy_buffers              4 32k;
				proxy_busy_buffers_size    64k;
				proxy_temp_file_write_size 64k;

			}

		}



		location @notclickurls {
			error_page  503 = @humanverify;
			limit_req   zone=req_scriptonpage  burst=19 nodelay;
			limit_conn  conn_scriptonpage  20;

#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/noclickaccess.log main;
			access_log /var/log/nginx/unblockedaccess.log main;

			recursive_error_pages on;

			error_page  599 = @humanverified;

			error_page  596 = @whiteip;

			error_page  580 = @onepagelocation;

			error_page  581 = @401;

			if ($whitelistip) {
				return 596;
			}

			if ($exploitprotect) {
				set $exploitprotect $exploit;
			}
			if ($exploitprotect) {
				return 581;
			}

			set $capcha_invite '';
			if ( $check_ha = "0" ) {
				set $capcha_invite INV;
			}
			if ( -f "/var/log/503ips/$remote_addr" ) {
				set $capcha_invite 1$capcha_invite;
			}


			if ( $cookie_fu ) {
				set $capcha_invite 2$capcha_invite;
			}
			if ($capcha_invite ~ 21INV) {
				set $forfu $set503withoutcookie;
				return 580;
			}


			if ($capcha_invite ~ 1INV) {
				set $forfu $set503andcookie;
				return 580;
			}
			if ($capcha_invite !~ INV) {
				return 599;
			}

			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;

		}

		location /captchaimgfl/ { # это ссылка на папку captcha для приложений
			error_page  503 = @503_captcha_image_fl;
			limit_req   zone=req_scriptonpage  burst=3 nodelay;
			limit_conn  conn_scriptonpage  4;

#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/slowrobotaccess.log main;

			recursive_error_pages on;

			random_index on;
			add_header Set-Cookie "captchaimgfl=$crc32_captchaimgfl; path=/; domain=$cookiehost";
			add_header Pragma "no-cache";
			add_header Cache-Control "private, max-age=0, no-cache";
			root /home/nginx;
		}
		location @503_captcha_image_fl {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			random_index on;
			add_header Set-Cookie "captchaimgfl=$crc32_captchaimgfl; path=/; domain=$cookiehost";
			add_header Pragma "no-cache";
			add_header Cache-Control "private, max-age=0, no-cache";
			root /home/nginx;
		}


		location /icaptcha/ {
			error_page  503 = @503_captcha_image;
			limit_req   zone=req_scriptonpage  burst=3 nodelay;
			limit_conn  conn_scriptonpage  4;

#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/slowrobotaccess.log main;

			recursive_error_pages on;

			random_index on;
			add_header Set-Cookie "ct=$crc32_ct; path=/; domain=$cookiehost";
			add_header Pragma "no-cache";
			add_header Cache-Control "private, max-age=0, no-cache";
			root /home/nginx;
		}

		location @503_captcha_image {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			random_index on;
			add_header Set-Cookie "ct=$crc32_ct; path=/; domain=$cookiehost";
			add_header Pragma "no-cache";
			add_header Cache-Control "private, max-age=0, no-cache";
			root /home/nginx;
		}



		location /ncaptcha/ {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/humanclickaccess.log main;
#			access_log /var/log/nginx/humanaccess.log main;

			error_page  590 = @onepagelocation;
			recursive_error_pages on;

			set $tmpfu /;
			if ( $cookie_fu ) {
				set $tmpfu $cookie_fu;
			}

			if ( $check_input ) {
				set $rmip $removeip;
				add_header Set-Cookie "ha=$crc32_ha; path=/; domain=$cookiehost";
				add_header Set-Cookie "fu=; path=/; domain=$cookiehost";
				rewrite ^ $tmpfu? redirect;

			}
			if ( $cookie_fu ) {
				set $forfu $set503withoutcookie;
				return 590;
			}
			set $forfu $set503andmaincookie;
			return 590;
		}


		location /rcaptcha/ {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/humanclickaccess.log main;
#			access_log /var/log/nginx/humanaccess.log main;

			error_page  590 = @503false_captcha;
			recursive_error_pages on;

			set $tmpfu /;
			if ( $cookie_fu ) {
				set $tmpfu $cookie_fu;
			}

			if ( $check_input ) {
				set $rmip $removeip;
				add_header Set-Cookie "ha=$crc32_ha; path=/; domain=$cookiehost";
				add_header Set-Cookie "fu=; path=/; domain=$cookiehost";
				rewrite ^ $tmpfu? redirect;
			}
			if ( $cookie_fu ) {
				set $forfu $set503withoutcookie;
				return 590;
			}
			set $forfu $set503andmaincookie;
			return 590;
		}



		location @503false_captcha {
			error_page  503 = @503false_captcha_quick;
			limit_req   zone=req_click  burst=3 nodelay;
			limit_conn  conn_click  4;

#		        access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/slowrobotaccess.log main;
			try_files /503false.html =404;
			root /home/nginx;
		}


		location @503false_captcha_quick {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			try_files /503false.html =404;
			root /home/nginx;
		}


	        location @onepagelocation {
			error_page  503 = @503_captcha_quick;
			limit_req   zone=req_click  burst=3 nodelay;
			limit_conn  conn_click  4;

#		        access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/slowrobotaccess.log main;
			try_files /503.html =404;
			root /home/nginx;

		}


		location @503_captcha_quick {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			try_files /503.html =404;
			root /home/nginx;
		}

		location @503_captcha_quick_unblocked {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			access_log /var/log/nginx/quickrobotunblockedaccess.log main;
			try_files /503.html =404;
			root /home/nginx;
		}


	        location @humanverifiedclick {

#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/humanclickaccess.log main;

#			access_log /var/log/nginx/humanaccess.log main;

			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;


			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;
		}


	        location @humanverified {

#			access_log /var/log/nginx/access.log  main;
#			access_log /var/log/nginx/humanaccess.log main;
			access_log /var/log/nginx/humannoclickaccess.log main;

			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;


			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;
		}


	        location @humanverifyclick {

#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/humanclickaccess.log main;
#			access_log /var/log/nginx/humanaccess.log main;

			error_page  590 = @503_captcha_quick_unblocked;

			error_page  596 = @whiteipclick;
			if ($whitelistip) {
				return 596;
			}

			if ( $check_ha = "0" ) {
				set $forfu $set503andcookie;
				return 590;
			}

			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;


		}

	        location @humanverify {

#			access_log /var/log/nginx/access.log  main;
#			access_log /var/log/nginx/humanaccess.log main;
			access_log /var/log/nginx/humannoclickaccess.log main;

			error_page  590 = @503_captcha_quick_unblocked;

			error_page  596 = @whiteip;
			if ($whitelistip) {
				return 596;
			}

			set $capcha_invite '';
			if ( $check_ha = "0" ) {
				set $capcha_invite INV;
			}
			if ( $cookie_fu ) {
				set $capcha_invite 1$capcha_invite;
			}
			set $capcha_invite 2$capcha_invite;

			if ($capcha_invite ~ 2INV) {
				set $forfu $set503andcookie;
				return 590;
			}
			if ($capcha_invite ~ 1INV) {
				set $forfu $set503withoutcookie;
				return 590;
			}

			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;


		}


	        location @whiteipclick {

#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/whiteipclickaccess.log main;
			access_log /var/log/nginx/whiteipaccess.log main;


			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;


			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;

		}


	        location @whiteip {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/whiteipnoclickaccess.log main;
			access_log /var/log/nginx/whiteipaccess.log main;

			proxy_pass         $proxy_pass;
			proxy_redirect     off;
			proxy_set_header   Host             $host;
			proxy_set_header   X-Real-IP        $remote_addr;
			proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;


			client_max_body_size       10m;
			client_body_buffer_size    128k;
			proxy_connect_timeout      90;
			proxy_send_timeout         90;
			proxy_read_timeout         90;
			proxy_buffer_size          4k;
			proxy_buffers              4 32k;
			proxy_busy_buffers_size    64k;
			proxy_temp_file_write_size 64k;


		}

		location @444 {
			error_page  503 = @444quick;
			limit_req   zone=req_click  burst=1 nodelay;
			limit_conn  conn_click  2;
			recursive_error_pages on;
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/slowrobotaccess.log main;
			try_files /444.html =444;
			root /home/nginx/emptu;
		}


		location @444quick {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			return 444;
		}


		location @401 {
			error_page  503 = @401quick;
			limit_req   zone=req_click  burst=1 nodelay;
			limit_conn  conn_click  2;
			recursive_error_pages on;
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/slowrobotaccess.log main;
			try_files /401.html =401;
			root /home/nginx/emptu;
		}

		location @401quick {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			return 401;
		}

		location @503 {
#			access_log /var/log/nginx/access.log  main;
			access_log /var/log/nginx/quickrobotaccess.log main;
			return 503;
		}
