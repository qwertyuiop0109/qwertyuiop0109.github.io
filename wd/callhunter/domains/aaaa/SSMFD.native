==========================================================================================================

Общая проблема, которая была обнаружена на SSMFD

при копировании массивов/хешей через JSON.stringify и JSON.parse
теряется содержимое regexp, например [/ddd/] - такое не передастся в другой массив (заменит на [null])
JSON.stringify это удалит, также удалит функции и даты, а JSON.parse не восстановит их

пришлось делать свои функции прямого и обратного преобразования JSON для всех типов 
приятным моментом является что ничего переделывать не надо в скриптах, только добавить функции как написано ниже
все будет работать как раньше (возможно медленнее JSON.stringify, но быстрее JSON.parse),
но главное - теперь сохраняются regexp, функции и даты, 
то есть копирование массивов/хешей абсолютно полное

Примечание: это небезопасное преобразование (как и любые функции с такими преобразованиями)
Также: У меня нет обработки дополнительных параметров JSON.stringify и JSON.parse (я их нигде не использую),
если сильно надо - изучаем например вторую ссылку ниже и долбимся.



КАК СТАВИТЬ:

скопировать функцию JSONparsestringifyInit
и вставить (как правило в начале нужного кода) вызов инициализации новых JSON:
JSONparsestringifyInit()

так же можно:
скопировать функцию JSONparsestringifyStopInit
там где нужно вернуть стандартные функции JSON (в конце нужного кода), вставить:
JSONparsestringifyStopInit()

в SSMFD есть оба варианта


тестовый хеш для браузера
var foo = { rgx: /\.qux$/ig, date: new Date, aa: [111,{dd:[1,'4']}] , ss: function aad() { var sss="1" + "\""}, ff: (x, y) => { return x + y; }}
тестовый хеш для гугла
var foo = { rgx: /\.qux$/ig, date: new Date, aa: [111,{dd:[1,'4']}] , ss: function aad() { var sss="1" + "\""}}

тестовые примеры
Logger.log(foo);
Logger.log({}.toString.call(foo['rgx']));    
Logger.log({}.toString.call(foo['ss']));  
Logger.log({}.toString.call(foo['date']));  
Logger.log(JSON.stringify(foo));
  
var foo2=JSON.parse(JSON.stringify(foo));
Logger.log(foo2);
Logger.log(JSON.stringify(foo2));
  
var foo3=JSON.parse(JSON.stringify(foo2));
Logger.log(foo3);
Logger.log(JSON.stringify(foo3));

//все данные сохраняются 
Logger.log(foo3['rgx']);  
Logger.log({}.toString.call(foo3['rgx']));
Logger.log({}.toString.call(foo3['ss']));  
Logger.log({}.toString.call(foo3['date']));  
  



функция на основе которой доработал свою
https://www.sitepoint.com/javascript-json-serialization/

вторая функция, которая потом спасла, помогла конкретно исправить мой первый вариант
здесь еще учитываются дополнительные параметры (если сильно надо, то изучаем обработчики дополнительных параметров)
https://github.com/douglascrockford/JSON-js

---

хороший вариант, но использует непосредсвенно функции JSON
как она работает, до конца не знаю, но тоже исправляет regexp/даты/функции
https://github.com/yahoo/serialize-javascript


функция, которая исправляет regexp/даты/функции, но также небезопасна
и форматирует формируемый JSON объект по своему, что несовместимо с обычным eval и обычными JSON.stringify и JSON.parse
http://www.eslinstructor.net/jsonfn/

основной сайт
http://www.json.org/json-ru.html


==========================================================================================================
Пытаемся преодолеть ограничение на 20 000 запросов url в день
Кратко - нужно создавать скрипты от имени других пользователей аккаунта, которые то же получать свои 20 000 запросов url в день


Как подключать пользователей к аккаунту:

Добавляем из основного юзера папки в общее пользование заданным пользователям (обязательно предоставить права Редактора).

Создаем почту для пользователя (у гугла лучше) что бы не было проблем
Даем запрос из МСС аккаунта на стандартный доступ (или админа) этой почте
Подтверждаем и заходим новым юзером в его гугл диск, в папку "Доступные мне" (либо, если не видны сначала подключаем по ссылкам папки).
Затем правой кнопкой на папке - добавляем ее ярлык в мой диск.

Дальше новым юзером создаем скрипты.


Кратко как организовать скрипты

SSMFDM всегда один для всех формирует задания

SSMFD SCRIPT_USED SCRIPT_ID - обычный скрипт, который запускается через payments (SCRIPT_USED и SCRIPT_ID подставляетяс значение из шапки скрипта)
например
SSMFD MAX 1 - скрипт для всех юзеров номер 1
SSMFD ONE 1 - скрипт для одного юзера номер 1
	Есть два варианта SCRIPT_USED:
	SCRIPT_USED = MAX - определяет число юзеров в группе (20)
	SCRIPT_USED = ONE - определяет число юзеров в группе (1)
	SCRIPT_ID - это как и раньше, идентификатор стартующей группы (здесь в группу может входить 20 юзеров как в других скриптах (но в других 50) или 1)


SSMFD T testing_ID - тестовый скрипт, который запускается сразу, без payments (testing_ID подставляется значение из шапки скрипта)
например
SSMFD T 1

в режиме просмотра указываем в самом скрипте данные по юзеру
	//var testingJob = '276-251-2831 demodomain.com'; //закомментировать, если нужно задание тестового запуска читать в файле testing.txt
	если закомментировано, то берет из файла testing.txt или завершается
	хорошая переменная, если срочно в любом тестовом скрипте нужно запустить проверку в режиме просмотра 
	если просмотр запускать с настройкой через файл будут ограничения, 
		связанные с запуском тестов в рабочем режиме - совпадение имени или ads id c такими же параметрами в payments


в режиме выполнения обязательно указываем в файле testing.txt (в папке с payments) построчно
	какому тестовому скрипту с какими параметрами запускаться постоянно (нет параметров - не запускается)

	что бы визуально контролировать в файле, что нет дублей аккаунтов на разные скрипты! 
	(нет автоматического контроля этого файла на дубликаты)

	например строка для запуска первого тестового скрипта
	1 233-444-4566 demodomain.com [дальше нет смысла копировать из задания юзера]
	здесь первое число
	1 - это соотв. значение testing_ID, указанный в шапке

	в чьи данные может писать тестовый скрипт зависит от настройки SCRIPT_USED и SCRIPT_ID (хотя это неважно совершенно)
	для тестового наверное стоит всегда задавать
	SCRIPT_USED = MAX
	SCRIPT_ID = 1
	Примечание - теперь тестовый скрипт не будет писать никуда,
	так как программно блокируется такая возможность, блокируется запуск тестов всегда для аккаунтов, где есть настройка запуска фидов
	тесты нужно запускать тогда для этого клиента на другом аккаунте/имени домена

	для тестов имя домена может быть любым набором символов (так как в скрипте не используется код статистики оптимизации)
	имя влияет только на ссылку доступа к фидам





Как в задании отличаются пользователи общего и индивидуального плана
MERCHANTXMLMAX
MERCHANTXMLONE - индивидуальный



Ограничиваем группу юзеров общего пользования до 20, а не 50 (то есть для небольших сайтов до 500-1000 позиций)


Кому какие скрипты:
Итак придерживаемся правил, что бы не запутатся окончательно:

Есть
1.Мои пользователи, которые имею ограничение на 20000 запросов в сутки для любых скриптов
2.Рабочие юзеры (индивидуальные и общего пользования) (которые уже есть в payments)
3.Соответсвенно, Рабочие скрипты (индивидуальные и общего пользования)
4.Тестовые юзеры 
5.Тестове скрипты

Для рабочих юзеров идентификация - уникальный Id google и уникальный сайт (размещенные в payments)
Например,
234-455-6789 vinkod.com.ua
файл vinkod.com.ua.merchantfeed.txt
или
234-455-6789 vinkod.com.ua-ADONLY
файл vinkod.com.ua-ADONLY.merchantfeed.txt

что бы не менять зараннее конфиг у рабочего юзера,
можно скопировать его в другой (например ..._test), указать другое имя (..._test), поменять время на 'test' и запустить просмотр,
либо скопировать его в другой (например ..._test), указать другие Id google/имя и запустить тест на короткое время с ограниченным числом товаров



Для тестовых юзеров, записанных в testing.txt идентификация:
общий для тестов Id google (либо один из таких общих для тестов Id google)
и уникальный сайт или уникальный набор букв для тестового юзера, который не совпадает с payments (если юзер уже там),
Хотя не возбраняется делать без приставки _test, если клиент уже в payments, но там еще не указано MERCHANTXMLMAX/ONE
То есть для новых можно создавать тестовые конфиги без приставки _test
Что бы не запутаться берем уникальный сайт юзера с приставкой test
Например,
123-456-7890 vinkod.com.ua_test
файл vinkod.com.ua_test.merchantfeed.txt
или
123-456-7890 vinkod.com.ua-ADONLY_test
файл vinkod.com.ua-ADONLY_test.merchantfeed.txt

То есть должны отличаться Id сайта и Id adwords у рабочего и теста (если в payments еще не указано MERCHANTXMLMAX/ONE для юзера)
У теста - тестовый аккаунт google и название конфига отличается от реального
Тесты в testing.txt между собой не должны иметь совпадений в названиях сайта, это отслеживается
Тесты в режиме просмотра и с var testingJob могут запускаться как угодно, ничего не отслеживается


Не отслеживается, что тесты могут иметь одинаковые названия РК.
Поэтому нужно контролировать что все тесты, указанные в testing.txt,
должны иметь разные названия РК в настройках (GASearch -> Id) или значение по умолчанию (''),
Иначе на тестовом аккауте начнет куролесится несколькими скриптами в режиме выполнения одна РК 
(так разве что можно посмотреть отлупы при создании, но нельзя посмотреть отлупы одобрений позже, если другой скрипт затрет группу)




Основной пользователь
SSMFDM - создает задания для всех (MAX и ONE)
SSMFD T 1 - тестовый запуск делать только в режиме просмотра, (не запускать каждый час!)
		если нужно запустить тест постоянно - заносим другому юзеру в файл testing.txt
		связано это с тем что бы удобно просмотреть и потом запустить, если нужно постоянно (у другого юзера)
		но при этом основной юзер не получит блокировку запросов на 1 день (мало тестирует)
		то есть можно запускать и получать готовые образцы фидов, но на мало, например, на 300 запросов

Пользователи для общего пользования
SSMFD MAX 1		
им только один скрипт, иначе будет блокировка, если тестировать что-то у них
если стало больше 20 юзеров, то создаем нового своего пользователя SSMFD MAX 2 и т.д.

Пользователи для индивидуального пользования
SSMFD ONE 1		
SSMFD T 2 (необязательно) (убрать запуск каждый час) (он не нужен уже реальному юзеру, но может быть)
то есть одного индивидуального и для него же можно оставить тестового либо когда еще мало пользователей, хотя когда уже всего много то не нужно
тестовый важно вначале, когда мало реальных юзеров, что бы не городить много своих пользователей
Пользователи для индивидуалов добавляются по мере добавления индивидуальных юзеров

Пользователи тестовые (можно несколько тестов, но нужно смотреть, если превысит блокировку, то можно переключить на нового пользователя)
Нужны для тестовых юзеров или если нужно сменить пользователя у тестового юзера (при блокировке 20000 запросов)
SSMFD T 3 (запускать каждый час)
То есть оттестировали индивидуала и потом создали нового индивидуального юзера (отключили его в тесте, не забыть)
либо оттестировали общего юзера и потом добавили его к общему пользователю (отключили его в тесте, не забыть)


Тестовых юзеров, которые всегда "на парах", стоит добавить постоянно в файл testing.txt (только не забывать комментировать)
Тестовых юзеров можно перекидывать между тестовыми скриптами (менять номер скрипта в testing.txt) при блокировке 20000 запросов
Тестовые скрипты/юзеры должны иметь один общий аккаунт, этого достаточно (главное, что бы названия РК не пересекались)

Если пользователь уже заведен в payment с MERCHANTXMLMAX/ONE, тестировать его можно только 
указав тестовый аккаунт и другое имя сайта (точнее просто набор букв достаточно), то есть скопировать в другое имя конфигурацию


Как-то так



==========================================================================================
Создание фидов и кампаний 

SSMFD 1

можно запускать повторно при работающем скрипте, у юзера вторая копия не запустится пока не закончится первая
только обновится время MCCStart, это непринципиально


//var testing_ID = 1 //для тестовых
//var testingJob = '276-251-2831 demodomain.com'; //для тестовых в режиме просмотра (необязательно)
var SCRIPT_ID = 1;
var SCRIPT_ID_NAME = 'SSMFD';
var SCRIPT_USED = 'MAX';
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('q 1h(){o;1i.9();1j.9();i.X();i.1k();i.1l();i.1m();i.1n();i.1o();i.1p();i.1q();i.1r();i.1s();i.1t();i.1u();i.9();i.1v();i.1w();7.1x();7.1y();7.1z();7.N();7.Y();7.1A();7.1B();7.1C();7.1D();7.1E();7.1F();7.O();7.1G();7.9();7.1H();7.1I();7.1J();7.1K();7.1L();7.1M();7.P();7.1N();7.1O();r.1P();r.1Q();r.1R();r.1S();r.1T();r.1U();r.9();r.1V();r.1W();p.1X();p.Z();p.1Y();p.1Z();p.20();p.21();p.22();p.23();p.9();p.24();p.25();F.26();F.27();F.28();F.9();29.9();3.2a();3.2b();3.2c();3.2d();3.2e();3.2f();3.2g();3.2h();3.2i();3.10();3.2j();3.2k();3.2l();3.2m();3.11();3.2n();3.2o();3.2p();3.2q();3.2r();3.A();3.2s();3.2t();3.2u();3.2v();3.9();3.2w();4.2x();4.2y();4.2z();4.2A();4.2B();4.2C();4.2D();4.2E();4.2F();4.10();4.2G();4.11();4.2H();4.X();4.2I();4.2J();4.2K();4.2L();4.2M();4.2N();4.2O();4.9();4.2P();4.2Q();4.2R();w.2S();w.2T();w.2U();w.2V();w.9();w.2W();6.2X();6.2Y();6.2Z();6.30();6.31();6.32();6.33();6.34();6.35();6.36();6.37();6.38();6.39();6.12();6.3a();6.3b();6.3c();6.3d();6.3e();6.3f();6.3g();6.9();6.3h();j.3i();j.3j();j.3k();j.3l();j.3m();j.3n();j.3o();j.3p();j.3q();j.3r();j.3s();j.3t();j.9();j.3u()};t 13="3v/3w/3x/"+3y,Q=["3z 3A: G."],R=H(14,[13],Q);8(R){t 15=H(q(b){o b.3B().3C()},[R],Q);3D(15)}q 14(b){t a=b.16("/");o(b=17(b))?(a=b.N(a[a.x-1]),a.I()?a.J():u):u}q 17(b){t a=G.P();8(b&&(b=b.16("/"),b.x)){t c=b[0];a=a.O(c);a=a.I()?a.J():u;8(!a)8(a=G.P().N(c),a.I()){a=a.J();a=a.3E();8(!a)o u;a=G.Y(a);8(!a)o u}S o u;B(t e T b)8(0!=e){8(e==b.x-1)3F;c=b[e];a=a.O(c);8(a.I())a=a.J();S o u}}o a}q H(b,a,c,e,g,f,k,h){q m(d){o c.3G(q(n){o-1!=d.9().3H(n)})}8(c&&("K"!==y c||"[K 18]"!=={}.9.19(c)))v"C L s D a U 1a V B M s A";8(!c.x)v"C L s D a U 1a V B M s A";e=z.W(e||3I);f=z.W(f||1);g=z.W(g||5);8(h&&"q"!==y h)v"8 C D a 3J 3K 3L 3M a q";8(!b||"q"!==y b)v"C L s D a q B M s A";8(!a||"K"===y a&&"[K 18]"==={}.9.19(a))3N{t l=b.3O(b,a);o h?h(l):l}3P(d){k&&p.Z("3Q "+f+":"+d);8(m(d)){8(f+1>g)v b=b.1b,d.E="1c"==y b&&b.x?d.E+" (T "+b+" 1d 1e 1f "+f+" 1g)":d.E+" (1d 1e 1f "+f+" 1g)",d;6.12(z.3R(z.3S(2,f)*e*(z.3T()+1)));o H(b,a,c,e,g,f+1,k)}b=b.1b;"1c"==y b&&b.x&&(d.E=d.E+" (T "+b+")");v d;}S v"C L s D a U 3U V B M s A";};',62,243,'|||ScriptyApp|SpreadsheetApp||Utilities|Drive|if|toString|||||||||Charts|XmlService|||||return|Logger|function|Jdbc|to|var|null|throw|UrlFetchApp|length|typeof|Math|execute|for|you|specify|message|MailApp|DriveApp|rateLimitExpBackoff|hasNext|next|object|need|rateLimitBackoff|getFilesByName|getFoldersByName|getRootFolder|backoffErrors|sFile|else|in|correct|array|abs|newTextStyle|getFolderById|log|flush|create|sleep|scrloc|getFile0000|sText|split|getFolder0000|Array|call|Errors|name|string|tried|backing|off|times|OuRauthFunc|AdWordsApp|MccApp|newColumnChart|newAreaChart|newPieChart|newCategoryFilter|newStringFilter|newBarChart|newLineChart|newNumberRangeFilter|newScatterChart|newTableChart|newDashboardPanel|newDataTable|newDataViewDefinition|getStorageUsed|getTrashedFolders|searchFolders|continueFileIterator|getTrashedFiles|getFiles|createFile|removeFile|getStorageLimit|searchFiles|getFilesByType|createFolder|removeFolder|addFolder|getFolders|getFileById|addFile|continueFolderIterator|getConnection|parseDate|newTime|newTimestamp|parseTimestamp|newDate|getCloudSqlConnection|parseTime|finest|fine|getLog|finer|severe|clear|warning|config|info|sendEmail|getRemainingDailyQuota|createMessage|MimeType|container|logMethodCall|isConfigured|secret|getErrors|getCachedByName|setHeader|createInMemory|createNow|getCached|get|getAccount|createFileUpload|createCsvUpload|getServices|getLabelByName|getExecutionInfo|configure|environment|throwUserException|invokeUserFunction|report|getClassName|setActiveRange|setActiveSpreadsheet|newConditionalFormatRule|openByKey|getActiveRange|newRichTextValue|getUi|newFilterCriteria|getActiveRangeList|setActiveSheet|openById|getCurrentCell|getActiveSpreadsheet|setActiveRangeList|setCurrentCell|getSelection|newDataValidation|getActive|openByUrl|getActiveSheet|open|removeOAuthService|getRequest|fetchAll|fetch|addOAuthService|formatDate|formatString|base64Encode|zip|computeDigest|sleepAndThrow|base64EncodeWebSafe|gzip|unzip|base64Decode|validateSleepTime|computeHmacSignature|newBlob|jsonParse|computeRsaSha256Signature|jsonStringify|ungzip|base64DecodeWebSafe|getUuid|computeHmacSha256Signature|parseCsv|getCompactFormat|getRawFormat|createElement|parse|getNoNamespace|createDocument|createDocType|createComment|getXmlNamespace|createCdata|createText|getNamespace|getPrettyFormat|context_settings|hidden|scripts|SCRIPT_ID_NAME|Limit|Exceeded|getBlob|getDataAsString|eval|getTargetId|break|some|indexOf|1E3|checker|it|must|be|try|apply|catch|backoff|round|pow|random|arguments'.split('|'),0,{}));function main(){eval(function(p,a,c,k,e,r){e=String;if(!''.replace(/^/,String)){while(c--)r[c]=k[c]||c;k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('0();',2,1,'main2'.split('|'),0,{}))}

ниже начинается код (для main2)
---------------------







//отправлять неизвестную ошибку или нет (она будет появляться но уже не критично вроде, оставил возможность отправки)
//ошибка (точнее задержка) удаления файлов в системе (критично для некоторых важных задач этого скрипта)
//ставить в 1 для теста, что бы проверять в письмах, когда появляется
//уже протестировано ее появление и исправление последствий, скрипт ее обнаруживает и знает что делать
var UNKNOWN_ERROR_SEND = 0;

//еще одна ошибка, при передаче фтп (связана опять же с задержкой появления файлов в системе)
//ставить в 1 для теста, что бы проверять в письмах, когда появляется
//уже протестировано ее появление и исправление последствий, скрипт ее обнаруживает и знает что делать
var UNKNOWN_ERROR_SEND_FTP = 0;

//если не 0, то обрезаем список ALL NOPARSED (NO ADD) URLS при выдаче
var NOparsed_urls_list_MAX = 15;


//код для одновременного запуска тестовых аккаунтов (подробности в начале скрипта)
if ((typeof testing_ID == "number")&&(testing_ID > 0)) {
	//запустился тестовый скрипт
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		//всегда удаляем, что бы не было одновременного неконтролируемого запуска разных скриптов в одном аккаунте юзера
		var testingJob = '';
	} else {
		if (typeof testingJob != "string") {
			var testingJob= '';
			//потом возьмет из файла text.txt
		}
	}
} else {
	var testing_ID = 0;
	var testingJob = '';
}


var GLtrashedfolder = null;
var COMMON = [];


//если нет созданных фидов или кампаний
var criticalsupportemail='oleg@inteprice.com';


//максимум групп в одной РК
//var MaxAdGroupsLimit = 19990;
var MaxAdGroupsLimit = 20000;

//var supportemail='oleg@inteprice.com';


//если закончился срок действия аккаунта, то файлы фидов и РК должны стать пустыми на след. день
var CONTROL_EMPTY_FEEDS = 0;


var now = getcurrentTime();
var todayAtMidn = new Date(now.getFullYear(), now.getMonth(), now.getDate());

var nowGMT = getcurrentGMTTime();
var nowGMTHour = nowGMT.getHours();

//у каждого скрипта свое время, поэтому нужно общее для всех
var nowAccountFileName = 'Optimizer-GMXMLAccountList' + SCRIPT_USED + '-' + nowGMTHour + '-' + SCRIPT_ID + '.json';

var TimeZone = AdWordsApp.currentAccount().getTimeZone();

//общий для всех файл с данными
//var [fileaccounts, NoStopNames, NoStopNamesAdwords] = ReadMainFile();
var [fileaccounts, NoStopNames, NoStopNamesAdwords] = rateLimitExpBackoff(ReadMainFile, [], backoffErrors);


//получаем директории для обработки фида
//var [mainfolder, filesfolder, domainsfolder, tmpfilesfolder, schedfilesfolder, trashedfolder] = getFeedfolders();
var [mainfolder, filesfolder, domainsfolder, tmpfilesfolder, schedfilesfolder, trashedfolder] = rateLimitExpBackoff(getFeedfolders, [], backoffErrors);



function main2() {

	if (COMMON.length) {
		//что бы увидеть невидимые сообщения
		for (var i=0; i < COMMON.length; i++) {
			Logger.log(COMMON[i])
		}
	}


	if ((!mainfolder) || (!filesfolder) || (!domainsfolder) || (!tmpfilesfolder) || (!schedfilesfolder) || (!trashedfolder)) {
		Logger.log('Отсутсвуют необходимые папки, нет обработанных аккаунтов');
		return;
	}


	if (!fileaccounts) {
		//Logger.log('Ошибка чтения файла данных, нет обработанных аккаунтов');
		Logger.log('Нет заданий для выполнения и обработанных аккаунтов');
		return;
	}


	if (testing_ID) {
		var GAIds = Object.keys(fileaccounts);
		if (GAIds.length&&GAIds[0]) {
			//должен был передаться только один аккаунт
			if (MccApp.accounts().withIds([GAIds[0]]).get().totalNumEntities()) {
				Logger.log('Checking the following accounts: ' + GAIds[0]);
				MccApp.accounts().withIds([GAIds[0]]).executeInParallel('processAccount');
			} else {
				//либо неверно указали, либо это клиент, который отключился
				Logger.log('Не cуществует аккаунта ' + GAIds[0]);
			}
		} else {
			Logger.log('Нет обработанных аккаунтов');
		}
	} else {


		if (AdWordsApp.getExecutionInfo().isPreview()) {
			Logger.log('For testing check file: ' + nowAccountFileName);
		}

		//var files = DriveApp.getRootFolder().getFilesByName(nowAccountFileName);
		var files = schedfilesfolder.getFilesByName(nowAccountFileName);

		if (!files.hasNext()) {
			Logger.log('Не обнаружен файл ' + nowAccountFileName + ', нет обработанных аккаунтов');
			return;
		}


		//var accountsList = readJSONFile(nowAccountFileName);
		var accountsList = readJSONFile(nowAccountFileName, schedfilesfolder);
		if ((typeof accountsList == 'object') && accountsList && Object.keys(accountsList).length) {
			var toCheck = [];
			for (var i in accountsList) {
				//i - это CustomerId
				var CustomerName = fileaccounts[i];
				//может уже не быть в файле такого задания, а в разнарядке на выполнение оно сохранилось, удаляем из выполняемых и записываем, что бы не было ошибки старта/завершения скриптов
				if (!CustomerName) {
					accountsList[i].MCCTimeZone = TimeZone;
					accountsList[i].MCCStart = now.toString();
					accountsList[i].CheckedStart = 'Not Run';
					accountsList[i].CheckedEnd = 'Not Run';
				} else {
					if (MccApp.accounts().withIds([i]).get().totalNumEntities()) {
						toCheck.push(i);
						accountsList[i].MCCTimeZone = TimeZone;
						accountsList[i].MCCStart = now.toString();
					} else {
						//это ситуация, когда клиент отключился от нашего центра клиентов (нужно будет подать сигнал)
						//выполнится один раз (если выполнится), в следующий раз не попадет в разнарядку аккаунтов
						accountsList[i].MCCTimeZone = TimeZone;
						accountsList[i].MCCStart = now.toString();
						accountsList[i].CheckedStart = 'Not Exists';
						accountsList[i].CheckedEnd = 'Not Exists';
					}
				}
				//ограничили здесь и в SSMFDM до 20 вместо 50-ти
				if (toCheck.length == 20) {
					break;
				}
			}
			if (!AdWordsApp.getExecutionInfo().isPreview()) {
				//writeJSONFile(nowAccountFileName, accountsList);
				writeJSONFile(nowAccountFileName, accountsList, schedfilesfolder);
			}
			Logger.log('Checking the following accounts: ' + JSON.stringify(toCheck));
			MccApp.accounts().withIds(toCheck).executeInParallel('processAccount', 'reportResults');
		} else {
			Logger.log('Нет обработанных аккаунтов');
		}

	} //end testing_ID

}


function processAccount() {
	var scriptName = SCRIPT_ID_NAME;
	try {

		JSONparsestringifyInit();

		// executeInParallel will automatically switch context to the account being
		// processed, so all calls to AdWordsApp will apply to the selected account.
		var starttime = getcurrentTime();
		var starttimeHour = starttime.getHours();;

		//...исполняемый код скрипта (начало)


		var account = AdWordsApp.currentAccount();
		var CustomerId = account.getCustomerId();
		//	var CustomerName = account.getName();



		var CustomerName = fileaccounts[CustomerId];

		//может уже не быть в файле такого задания, а в разнарядке на выполнение оно сохранилось и тогда дальше .match выдаст ошибку - Cannot call method "match" of undefined.
		if (!CustomerName)
			return;

		var found = CustomerName.match(/^\s*(\#?)\s*([^\s]+)/);
		if (found && (found[2])) {} else {
			return;
		}


		/*
		в этом скрипте функция account.getName() почему-то выдает случайным образом ошибку 
		Invalid reporting query: INVALID_INPUT: RequestError.INVALID_INPUT.
		и процесс аккаунта, у которого возникла ошибка, обрывается.
		Так этот как код проверки можно сказать избыточный то он закомменирован

			var AdvCustomerName = account.getName();
			var Advfound = AdvCustomerName.match(/^\s*(\#?)\s*([^\s]+)/);
			if (Advfound && (Advfound[2])) {
			} else {
				return;
			}

		//у аккаунта и в нашей записи ID нашей системы должны совпадать
			if (Advfound[2] != found[2]) {
				return;
			}

		*/

		if ((CustomerName.indexOf("OPT") == -1) && (CustomerName.indexOf("LOW") == -1)) {
			return;
		}
		if (CustomerName.substring(0, 1) == '#') {
			return;
		}


		var rea = new RegExp(/^\s*([^\s]+)/);
		var vArra = undefined;
		if ((vArra = rea.exec(CustomerName)) != null) {
			var IDName = vArra[1];
		} else {
			return;
		}



		
		//одномоментный запуск нескольких копий, либо запуск другой копии во время выполнения скрипта для одного аккаунта невозможен
		var startscriptDate = new Date(Number(getLabel(scriptName)));
		//флаг выхода из-за параллельного старта
		var retparallelstart = 0;
		//раньше при отсутствии ярлыка: new Date(null) выдавало 'Invalid Date'
		//теперь, так как Number(null) выдает 0, всегда нет 'Invalid Date' и сразу переходит на '} else {'
		if (startscriptDate == 'Invalid Date') {
			//вроде возможно продолжение
			//записываем текущее время в метку и продолжаем
			startscriptDate = new Date();
			setLabel(scriptName, startscriptDate.getTime());

			//проверка параллельного запуска нескольких копий
			if (!AdWordsApp.getExecutionInfo().isPreview()) {
				Utilities.sleep(500);
				var startscriptDate2 = new Date(Number(getLabel(scriptName)));
				if (startscriptDate2 == 'Invalid Date') {
					//выходим, возможно скрипт сейчас запущен одновременно с другим
					retparallelstart = 1;
					//return;
				} else if (startscriptDate2.getTime() != startscriptDate.getTime()) {
					//выходим, скрипт сейчас запущен одновременно с другим
					retparallelstart = 1;
					//return;
				}
			}

		} else {
			var currscriptDate = new Date();

			//30 минут максимум выполняется скрипт, можно запускать после того (если был обрыв выполнения или метку не удалили)
			if ((Math.abs(currscriptDate.getTime() - startscriptDate.getTime()) / 1000) > (60 * 30)) {
				//вроде возможно продолжение
				//перезаписываем метку
				startscriptDate = new Date();
				setLabel(scriptName, startscriptDate.getTime());

				//проверка параллельного запуска нескольких копий
				if (!AdWordsApp.getExecutionInfo().isPreview()) {
					Utilities.sleep(500);
					var startscriptDate2 = new Date(Number(getLabel(scriptName)));
					if (startscriptDate2 == 'Invalid Date') {
						//выходим, возможно скрипт сейчас запущен одновременно с другим
						retparallelstart = 1;
						//return;
					} else if (startscriptDate2.getTime() != startscriptDate.getTime()) {
						//выходим, скрипт сейчас запущен одновременно с другим
						retparallelstart = 1;
						//return;
					}
				}


			} else {
				//выходим, скрипт сейчас запущен
				if (!AdWordsApp.getExecutionInfo().isPreview()) {
					retparallelstart = 1;
					//return;
				}
			}

		}
		if (retparallelstart) {
			if (!testing_ID) {
				//если это не тестовый скрипт, то он должен оставить запись, что он запускался
				//иначе будут приходить сообщения, что не стартовал скрипт

				var endtime = getcurrentTime();
				JSONparsestringifyStopInit();
				return JSON.stringify({
					TimeZone: TimeZone,
					StartTime: starttime.toString(),
					EndTime: endtime.toString(),
					CustomerId: CustomerId,
					CustomerName: CustomerName,
					nowAccountFileName: nowAccountFileName
				});
			}
			Logger.log('Another Copy of the script is already Running, this duplicate exit');
			return;
		}



		if (SCRIPT_USED == 'ONE') {
			if (CustomerName.indexOf("MERCHANTXMLONE") == -1) {
				var endtime = getcurrentTime();
				//удаляем метку (пишем 2009 символов '-')
				setLabel(scriptName, Array(2010).join('-'));
				JSONparsestringifyStopInit()
				return JSON.stringify({
					TimeZone: TimeZone,
					StartTime: starttime.toString(),
					EndTime: endtime.toString(),
					CustomerId: CustomerId,
					CustomerName: CustomerName,
					nowAccountFileName: nowAccountFileName
				});
			}
		} else {
			if (CustomerName.indexOf("MERCHANTXMLMAX") == -1) {
				var endtime = getcurrentTime();
				//удаляем метку (пишем 2009 символов '-')
				setLabel(scriptName, Array(2010).join('-'));
				JSONparsestringifyStopInit()
				return JSON.stringify({
					TimeZone: TimeZone,
					StartTime: starttime.toString(),
					EndTime: endtime.toString(),
					CustomerId: CustomerId,
					CustomerName: CustomerName,
					nowAccountFileName: nowAccountFileName
				});
			}
		}



//теперь такая фишка сделана:
//для LOW аккаунтов (в т.ч. для всех тестовых скриптов) при окончании срока останов генерации файлов фидов и РК в SSMFD, останов РК в SSOPB за счет установки срока конца РК, через 10 дней все файлы фидов удаляются в SSCHE
//для OPT аккаунтов (кроме любых тестовых) при окончании срока останов генерации файлов фидов и РК в SSMFD, в SSMFD контроль обнуления файлов фидов и останова групп в РК в течение 7 дней после того, через 10 дней все файлы фидов удаляются в SSCHE
//для OPT аккаунтов (для всех тестовых скриптов) при окончании срока останов генерации файлов фидов и РК в SSMFD, через 10 дней все файлы фидов удаляются в SSCHE

	if (testing_ID||((CustomerName.indexOf("LOW") != -1)&&(CustomerName.indexOf("OPT") == -1))) {

//тепер этот выход из проги только для LOW (для OPT другой функционал ниже)

//если есть testing_ID, то здесь в любом случае продолжится!!!!!!!!!! 
//так как нет END, CustomerName при testing_ID всегда типа 'demodomain.com OPT MERCHANTXMLMAX'
//выход по END контролирует ReadMainFile

//отключено для OPT, так как позже теперь заканчивается выполнение этого скрипта для OPT
//и это отслеживание уже не столь важно, если SSCHE M, SSCHE 1 продолжают 
//контролировать фиды позже хотя бы на день, чем executeDaysAfterEnd в SSMFD M

		//этот скрипт не должен выполняться после 0 часов если закончился срок действия, но файлы выполнения будут еще созданы на этот час
		//соотвественно, SSCHE 1 может выполниться раньше него в первый час новых суток,
		//особенно критично это для SSBID 1, который вернет ставки после того как SSCHE 1 начнет их удалять и восстанавливать старые значения
		//даты полностью соответствуют SSCHE 1 - todayAtMidn берется из MMC аккаунта, а specificDate из текущего
		//так что полная синхронизация с датами SSCHE 1, на основании которых начинают удалятся наши настройки в SSCHE 1
		var red = new RegExp(/END(\d\d)\/(\d\d)\/(\d\d\d\d)/);
		var vArrd;
		if ((vArrd = red.exec(CustomerName)) != null) {

			// Set specificDate to a specified date at midnight.
			var specificDate = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);

			// Compare the two dates by comparing the millisecond
			// representations.
			if (todayAtMidn.getTime() >= specificDate.getTime()) {
				var endtime = getcurrentTime();
				//удаляем метку (пишем 2009 символов '-')
				setLabel(scriptName, Array(2010).join('-'));
				JSONparsestringifyStopInit()
				return JSON.stringify({
					TimeZone: TimeZone,
					StartTime: starttime.toString(),
					EndTime: endtime.toString(),
					CustomerId: CustomerId,
					CustomerName: CustomerName,
					nowAccountFileName: nowAccountFileName
				});
			}
		}
		red = new RegExp(/STOP(\d\d)\/(\d\d)\/(\d\d\d\d)/);
		if ((vArrd = red.exec(CustomerName)) != null) {

			// Set specificDate to a specified date at midnight.
			var specificDate = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);

			// Compare the two dates by comparing the millisecond
			// representations.
			if (todayAtMidn.getTime() >= specificDate.getTime()) {
				var endtime = getcurrentTime();
				//удаляем метку (пишем 2009 символов '-')
				setLabel(scriptName, Array(2010).join('-'));
				JSONparsestringifyStopInit()
				return JSON.stringify({
					TimeZone: TimeZone,
					StartTime: starttime.toString(),
					EndTime: endtime.toString(),
					CustomerId: CustomerId,
					CustomerName: CustomerName,
					nowAccountFileName: nowAccountFileName
				});
			}
		}


	} else {

//теперь вместо выхода для OPT (который отключен выше) формируются новые файлы фидов и РК с 0 позиций (CONTROL_EMPTY_FEEDS)

		var red = new RegExp(/END(\d\d)\/(\d\d)\/(\d\d\d\d)/);
		var vArrd;
		if ((vArrd = red.exec(CustomerName)) != null) {

			// Set specificDate to a specified date at midnight.
			var specificDate = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);

			// Compare the two dates by comparing the millisecond
			// representations.
			if (todayAtMidn.getTime() >= specificDate.getTime()) {
				CONTROL_EMPTY_FEEDS = 1;
			}
		}
		red = new RegExp(/STOP(\d\d)\/(\d\d)\/(\d\d\d\d)/);
		if ((vArrd = red.exec(CustomerName)) != null) {

			// Set specificDate to a specified date at midnight.
			var specificDate = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);

			// Compare the two dates by comparing the millisecond
			// representations.
			if (todayAtMidn.getTime() >= specificDate.getTime()) {
				CONTROL_EMPTY_FEEDS = 1;
			}
		}
		if (CONTROL_EMPTY_FEEDS) {
			Logger.log('For accaunt ' + IDName+ ' will be create empty feeds and exit !!!')
		}

	}



		//файл с последними данными по завершенным сканам сайтов
		var scanReport = IDName + '.scanreport.txt';


//		var SITES_CHECKED_FILE_NAME = 'SSSitesAlreadyChecked-' + CustomerId + '.json';
		var SITES_CHECKED_FILE_NAME = IDName + '.SSSitesAlreadyChecked.json';


		var didExitEarly = false;

		//только для режима просмотра
		var scanReportPreview = '';


		while (!didExitEarly) {


			for (var i=0; i < 5; i++) {

				//var [reterr,FeedConfig,scanids,configChecksum,configChangeFLG,configfolder,ClearConfig,conferrors] = readFeedConfig(IDName,mainfolder,domainsfolder,filesfolder);
				var [reterr,FeedConfig,scanids,configChecksum,configChangeFLG,configfolder,ClearConfig,conferrors] = rateLimitExpBackoff(readFeedConfig, [IDName, mainfolder, domainsfolder, filesfolder], backoffErrors);

				if (reterr) {

					//периодически выдает несуществующую ошибку, поэтому несколько раз выполняем

					//делаем задержку
					//возможен обрыв с таймаутом
					Utilities.sleep(10000);
				} else {
					break;
				}

			}


			if (reterr) {


				//if (!AdWordsApp.getExecutionInfo().isPreview()) {

					var confFile = IDName + '.merchantfeed.txt';

					//метка критических ошибок отличается по названию от аналогичных меток в других местах

					var Today = getcurrentTime();
					var todayString = ('0' + Today.getDate()).slice(-2) + '.' + ('0' + (Today.getMonth() + 1)).slice(-2);
		
					var LastDateCriticlaErrCheck = getLabel('LastcrConfErr');

					var subject = "Критические ошибки (ошибка в файле конфигурации, обработка фидов и РК сайта остановлена) в аккаунте Adwords " + IDName;

					var criticalerrors = subject + "\n" + conferrors + "\n" + confFile + "\n";
	
					if (!AdWordsApp.getExecutionInfo().isPreview()) {
						//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
						if (LastDateCriticlaErrCheck != todayString) {
							if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
								MailApp.sendEmail(criticalsupportemail, subject, criticalerrors);
							}
						}
					}
					Logger.log(criticalerrors)

					if (LastDateCriticlaErrCheck != todayString)
						setLabel('LastcrConfErr', todayString);

				//}




				//если ошибка - выходим, через час войдем повторно
				//ничего не удаляем (базу и фиды), так как случайная ошибка, а мы удалим

				//удаляем метку (пишем 2009 символов '-')
				setLabel(scriptName, Array(2010).join('-'));
				var endtime = getcurrentTime();
				JSONparsestringifyStopInit()
				return JSON.stringify({
					TimeZone: TimeZone,
					StartTime: starttime.toString(),
					EndTime: endtime.toString(),
					CustomerId: CustomerId,
					CustomerName: CustomerName,
					nowAccountFileName: nowAccountFileName
				});

			}

			//есть FeedConfig с рабочим конфигом, scanids со сканами сайтов с контрольной суммой сканов
			//и временем (часом) запуска (также там же записан /для справки/ уровень приоритета скана)

			//сохраняем начальные значения без дальшейших удалений (исп. для pausedFeeds)
			var FULLscanids = JSON.parse(JSON.stringify(scanids));
			var FULLFeedConfig = JSON.parse(JSON.stringify(FeedConfig));

			if (!AdWordsApp.getExecutionInfo().isPreview()) {


Logger.log('Run Execute mode, accaunt ' + IDName);

				//готовим конфиги без режима просмотра
				//удаляем все сканы или фиды имеющие только test или удаляем test из timeHours
				for (var i=0; i < FeedConfig.length; i++) {
					if (FeedConfig[i]['timeHours']&&(FeedConfig[i]['timeHours'].indexOf('test') != -1)&&(FeedConfig[i]['timeHours'].length == 1)) {
						delete scanids[FeedConfig[i]['Id']];
						FeedConfig.splice(i,1);
						ClearConfig.splice(i,1);
						for (var id in scanids) {
							//удалили элемент i в обоих массивах, уменьшаем IdNum у всех scanids, где он больше i
							if (scanids[id]['IdNum'] > i)
								scanids[id]['IdNum']--
						}
						i--;
						//для массива так некорректно: delete FeedConfig[i];
					} else {
						if (FeedConfig[i]['timeHours']&&(FeedConfig[i]['timeHours'].indexOf('test') != -1)) {
							for (var ii in FeedConfig[i]) {
								if (FeedConfig[i]['feeds'][ii]) {
									if (FeedConfig[i][ii]['timeHours']&&(FeedConfig[i][ii]['timeHours'].indexOf('test') != -1)&&(FeedConfig[i][ii]['timeHours'].length == 1)) {
										delete FeedConfig[i][ii];
										delete FeedConfig[i]['feeds'][ii];
										delete ClearConfig[i][ii];
										continue;
									} else if (FeedConfig[i][ii]['timeHours']&&(FeedConfig[i][ii]['timeHours'].indexOf('test') != -1)) {
										//удаляем test из массива
										FeedConfig[i][ii]['timeHours'].splice(FeedConfig[i][ii]['timeHours'].indexOf('test'),1);
									}

									//не могут создаваться кампании и группы в режиме просмотра
									if (FeedConfig[i][ii]['GASearch']) {
										if (FeedConfig[i][ii]['GASearch']['GAShtml'] == 1) {
											//выключаем обработку РК, только создание html-фида
											delete FeedConfig[i][ii]['GASearch']['Id'];
										}
									
									}


								}
							}
							//удаляем test из массива
							FeedConfig[i]['timeHours'].splice(FeedConfig[i]['timeHours'].indexOf('test'),1);

						} else {
							for (var ii in FeedConfig[i]) {
								if (FeedConfig[i]['feeds'][ii]) {
									//не могут создаваться кампании и группы в режиме просмотра
									if (FeedConfig[i][ii]['GASearch']) {
										if (FeedConfig[i][ii]['GASearch']['GAShtml'] == 1) {
											//выключаем обработку РК, только создание html-фида
											delete FeedConfig[i][ii]['GASearch']['Id'];
										}
									
									}
								}
							}
						}


						//переcчитываем контрольную сумму (без тестов, что бы не было перезапуска выполняющихся рабочих сканов при изменении тестовых фидов/сайтов)
						//тоже самое для тестов, хотя для них это неважно
						//копируем конфиг и удаляем элементы, которые не должны влиять на контрольную сумму и соотв. перескан

						//закомментировал, низзя убирать pausedFeeds, иначе
						//1. нужно анализировать РК (до, при и после создания групп)
						//2. если в процессе скана сначала добавили фид в pausedFeeds, а затем убрали, то фид и РК будут неполные, удаляться часть групп в РК и прочие косяки могут быть.
						//delete ClearConfig[i]['pausedFeeds'];


						delete ClearConfig[i]['notScanUrlsOnItemPages'];
						delete ClearConfig[i]['title'];
						delete ClearConfig[i]['description'];
						delete ClearConfig[i]['Debug_On'];
						delete ClearConfig[i]['MAX_CHECKED_URLS'];
						scanids[FeedConfig[i]['Id']]['checksum'] = murmurhash3_32_gc(JSON.stringify(ClearConfig))


					}
				}


				if (!FeedConfig.length) {
Logger.log('Config is empty. Exit, accaunt ' + IDName);

					scanReportPreview = rewriteScanReport(scanReport, filesfolder, scanids);
					//removeRootFile(SITES_CHECKED_FILE_NAME)
					//removeRootFile(SITES_CHECKED_FILE_NAME,tmpfilesfolder)
					removeAllScanFiles(IDName,tmpfilesfolder)
					break;
				}


/*

все сканы удалять ни в коем случае нельзя!, отключено
ниже контролируется чексумма отдельных сканов - for (var id in allscansTime) { ...

				if (configChangeFLG) {

					//был изменен конфиг в каком-то месте
					//обнуляем все даты создания всех сканов, обнуляем незаконченный скан, все начинаем сначала

					var allscansTime = [];
					var feedsAlreadyChecked = null;
					//removeRootFile(SITES_CHECKED_FILE_NAME);
					//removeRootFile(SITES_CHECKED_FILE_NAME,tmpfilesfolder)
					removeAllScanFiles(IDName,tmpfilesfolder)



				} else {

*/

					//читаем все предыдущие (последние) даты создания сканов сайтов
					//получаем предыдущий массив завершенных сканов для перебора (нужно узнать кого сканировать сейчас)
					var allscansTime = readScanReport(scanReport, filesfolder);

					//читаем файл незакончивщегося предыдущего запуска (это только для первого прохода может быть)
					//var feedsAlreadyChecked = readJSONFile(SITES_CHECKED_FILE_NAME);
					var feedsAlreadyChecked = readJSONFile(SITES_CHECKED_FILE_NAME,tmpfilesfolder);

//				}












				if (!AdWordsApp.getExecutionInfo().isPreview()) {

					if ((feedsAlreadyChecked&&feedsAlreadyChecked['unkwonw_abr'])||ScanCreateFeedsGlobalVars['unkwonw_abr']) {

//это обработка ошибки, связанной с тем что удаление файлов removeFile присходит с задержкой, 
//а нам надо сразу после удаления выполнять операции чтения с анализом отсутсвия файла (который еще не удалился через removeAllScanFiles)
//то есть надо учитывать, что файл может еще существовать (поэтому есть эта обработка unkwonw_abr в двух местах)
//хотя теперь внедрено в removeAllScanFiles решение, предотвращающее появление и обработку этой ошибки


//!!!обязательно выходим в конце, иначе продолжится зациклено выполнение последнего шага

						if (ScanCreateFeedsGlobalVars['unkwonw_abr']) {
							if (!feedsAlreadyChecked)
								feedsAlreadyChecked = {}
							feedsAlreadyChecked['unkwonw_abr'] = 1;
							if (!feedsAlreadyChecked['scannId'])
								feedsAlreadyChecked['scannId'] = {};
							feedsAlreadyChecked['scannId']['Id'] = ScanCreateFeedsGlobalVars['unkwonw_abr']['Id'];
						}



/*

зафиксирована ошибка (при завершении скана не удалены файлы через removeAllScanFiles(IDName,tmpfilesfolder) )
при таких обстоятельствах

режим выполнения (не просмотра)

07.04.2020 04:38:54	https://serebro.ua/
Scanned step: 5
Request to scanned 0 URLS
Scanned 2635 URLS


feedsAlreadyChecked.scanned.scanned.steps
feedsAlreadyChecked.scanned.scanned.length
feedsAlreadyChecked.scanned.scanned.checked_urls

отслеживаем 
feedsAlreadyChecked['unkwonw_abr']
так как отслеживать вышеуказанные значения неверно

*/


//если появилась то опять пытаемся все удалить





						//как это получается не знаю, но надо просто выйти, повторно удалив removeAllScanFiles(IDName,tmpfilesfolder)

						//Logger.log('Not have jobs for current execute (3), account ' + IDName);
						Logger.log('Error delete files in removeAllScanFiles !!!, message in script start, account ' + IDName);


//дебильная проверка (вроде может не удалить файл SITES_CHECKED_FILE_NAME и другие файлы при выполнении removeAllScanFiles(IDName,tmpfilesfolder))


						var badfiles1 = ''
						var filesfolderFiles = DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();
						var fileSiteId1 = IDName + '.';
						var fileSiteId1length = fileSiteId1.length;
						while (filesfolderFiles.hasNext()) {
							var nfile = filesfolderFiles.next();
							var FullFileName = nfile.getName();
							if (!FullFileName.indexOf(fileSiteId1)) { //если совпадает IDName с началом имени файла
							//if (FullFileName.substr(0, fileSiteId1length) == fileSiteId1) {
								badfiles1 += FullFileName + "\n";
							}
						}



						if (badfiles1) {
							Logger.log('Found 1 error file(s): ' + "\n" + badfiles1 + "\n" + 'account ' + IDName)
						} else {
							Logger.log('Not found 1 error file(s)' + "\n" + 'account ' + IDName)
						}




//опять пытаемся удалить и выходим

						Logger.log('Remove error file(s) with removeAllScanFiles for ' + IDName)
						removeAllScanFiles(IDName,tmpfilesfolder)

//делаем задержку
Utilities.sleep(10000);



						var badfiles2 = ''
						var filesfolderFiles = DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();
						var fileSiteId1 = IDName + '.';
						var fileSiteId1length = fileSiteId1.length;
						while (filesfolderFiles.hasNext()) {
							var nfile = filesfolderFiles.next();
							var FullFileName = nfile.getName();
							if (!FullFileName.indexOf(fileSiteId1)) { //если совпадает IDName с началом имени файла
							//if (FullFileName.substr(0, fileSiteId1length) == fileSiteId1) {
								badfiles2 += FullFileName + "\n";
							}
						}

						if (badfiles2) {

							//такого не должно быть но может быть!! почему не понятно
	

							Logger.log('Error delete files in removeAllScanFiles !!!, message in script start, account ' + IDName)
							Logger.log('Found error 2 file(s): ' + "\n" + badfiles2 + "\n" + 'account ' + IDName)

							//еще раз пытаемся удалить
							//removeAllScanFiles(IDName,tmpfilesfolder)

							//и перезаписываем для верности
							var feedsAlreadyChecked2 = {};

//при повторении проверяем наличие этой записи (контроль unkwonw_abr есть в двух местах)
							feedsAlreadyChecked2['unkwonw_abr'] = 1;

							feedsAlreadyChecked2['scannId'] = {};
							feedsAlreadyChecked2['scannId']['Id'] = feedsAlreadyChecked['scannId']['Id'];


							writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked2, tmpfilesfolder);



							//метка критических ошибок отличается по названию от аналогичных меток в других местах

							var Today = getcurrentTime();
							var todayString = ('0' + Today.getDate()).slice(-2) + '.' + ('0' + (Today.getMonth() + 1)).slice(-2);
		
							var LastDateCriticlaErrCheck = getLabel('LastcrUnknStErr');

							var subject = "Критические ошибки (неизвестная ошибка на старте скана) в аккаунте Adwords " + IDName;

							var criticalerrors = subject;
	
							//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
							if ((LastDateCriticlaErrCheck != todayString)&&UNKNOWN_ERROR_SEND) {
								if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
									MailApp.sendEmail(criticalsupportemail, subject, criticalerrors);
								}
							}

							Logger.log(criticalerrors)

							if (LastDateCriticlaErrCheck != todayString)
								setLabel('LastcrUnknStErr', todayString);

						}



						//записываем ошибку
						var scanresultFileErrorsReport = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.errorscan.txt';
						var scanresultFileErrorsReportid = filesfolder.getFilesByName(scanresultFileErrorsReport);
						while (scanresultFileErrorsReportid.hasNext()) {
							var nfile = scanresultFileErrorsReportid.next();
							//filesfolder.removeFile(nfile);
							deleteOrRemoveFile(nfile);
						}
						if (badfiles1||badfiles2) {
							var cmessg = 'Error delete files in removeAllScanFiles !!!, message in script start' + "\n" + 'Found 1 error file(s): ' + "\n" + badfiles1 + "\n" + 'Found 2 error file(s): ' + "\n" + badfiles2 + "\n" + 'account ' + IDName;
						} else {
							var cmessg = 'Error delete files in removeAllScanFiles !!!, message in script start, account ' + IDName;
						}
						checkSaveFile(filesfolder.createFile(scanresultFileErrorsReport, cmessg), cmessg);
						Logger.log(cmessg)

//!!!обязательно выходим, иначе продолжится зациклено выполнение последнего шага

						break;


					}
				}








			} else {


Logger.log('Run Preview mode, accaunt ' + IDName);

				var currt = getcurrentTime();
				var currtHour = currt.getHours();

				//готовим конфиги только для режима просмотра
				//удаляем все сканы и фиды кроме test и заменяем в них timeHours/startDays на текущий час
				for (var i=0; i < FeedConfig.length; i++) {
					if (FeedConfig[i]['timeHours']&&(FeedConfig[i]['timeHours'].indexOf('test') != -1)) {
						for (var ii in FeedConfig[i]) {
							if (FeedConfig[i]['feeds'][ii]) {
								if (FeedConfig[i][ii]['timeHours']&&(FeedConfig[i][ii]['timeHours'].indexOf('test') != -1)) {
									FeedConfig[i][ii]['startDays'] = [];
									FeedConfig[i][ii]['startDaysHash'] = {};
									FeedConfig[i][ii]['timeHours'] = [currtHour];
									FeedConfig[i][ii]['timeHoursHash'] = {currtHour: 1};

									//не могут создаваться кампании и группы в режиме просмотра
									if (FeedConfig[i][ii]['GASearch']) {
										//параметр GAShtml не трогаем, может создавать фид
										delete FeedConfig[i][ii]['GASearch']['Id'];
										if (FeedConfig[i][ii]['GASearch']['GAShtml'] == 2) {
											//это так, на всякий случай
											FeedConfig[i][ii]['GASearch']['GAShtml'] = 1;
										}
									
									}

								} else {
									delete FeedConfig[i][ii];
									delete FeedConfig[i]['feeds'][ii];
									delete ClearConfig[i][ii];
								}
							}
						}
						FeedConfig[i]['startDays'] = [];
						FeedConfig[i]['startDaysHash'] = {};
						FeedConfig[i]['timeHours'] = [currtHour];
						FeedConfig[i]['timeHoursHash'] = {currtHour: 1};

						//переcчитываем контрольную сумму (без тестов, что бы не было перезапуска выполняющихся рабочих сканов при изменении тестовых фидов/сайтов)
						//тоже самое для тестов, хотя для них это неважно
						//копируем конфиг и удаляем элементы, которые не должны влиять на контрольную сумму и соотв. перескан

						//закомментировал, низзя убирать pausedFeeds, иначе
						//1. нужно анализировать РК (до, при и после создания групп)
						//2. если в процессе скана сначала добавили фид в pausedFeeds, а затем убрали, то фид и РК будут неполные, удаляться часть групп в РК и прочие косяки могут быть.
						//delete ClearConfig[i]['pausedFeeds'];

						delete ClearConfig[i]['notScanUrlsOnItemPages'];
						delete ClearConfig[i]['title'];
						delete ClearConfig[i]['description'];
						delete ClearConfig[i]['Debug_On'];
						delete ClearConfig[i]['MAX_CHECKED_URLS'];
						scanids[FeedConfig[i]['Id']]['checksum'] = murmurhash3_32_gc(JSON.stringify(ClearConfig))


					} else {
						delete scanids[FeedConfig[i]['Id']];
						FeedConfig.splice(i,1);
						ClearConfig.splice(i,1);
						for (var id in scanids) {
							//удалили элемент i в обоих массивах, уменьшаем IdNum у всех scanids, где он больше i
							if (scanids[id]['IdNum'] > i)
								scanids[id]['IdNum']--
						}
						i--;
						//для массива так некорректно: delete FeedConfig[i];
					}
				}



				if (!FeedConfig.length) {
Logger.log('Config is empty. Exit, accaunt ' + IDName);
					scanReportPreview = rewriteScanReport(scanReport, filesfolder, scanids);
					break;
				}


				//не читаем последние сканы в режиме просмотра (только свои сканы проходим, какие успеем)
				var allscansTime = readScanReport(scanReport, scanReportPreview);

				var feedsAlreadyChecked = null;
			}



			//удаляем все сканы и их файлы (а также, незакончившийся запуск скана), которых нет в прочитанном конфиге
			//несуществующие или измененные фиды будем удалять при запуске нового скана

			//заносим в scanids (которые найдены в FeedConfig) последние даты законченных сканов


			var removeSites = 0;
			//var removeSitesID = null;



			if (feedsAlreadyChecked && feedsAlreadyChecked['scannId'] && feedsAlreadyChecked['scannId'].hasOwnProperty('Id')) {
				//есть сканируемый сайт, проверяем его наличие в файле конфига, а так же совпадение checksum, иначе удаляем его и сносим весь файл
				//любые малейшие изменения в незаконченном скане сайта приводят к перескану сайта и фидов
				if ((!scanids.hasOwnProperty(feedsAlreadyChecked['scannId']['Id'])) || (scanids[feedsAlreadyChecked['scannId']['Id']]['checksum'] != feedsAlreadyChecked['scannId']['checksum'])) {
					//удалить если есть любые изменения в скане
					//метки запуска скана будут удалены, если они есть
					//removeSitesID = feedsAlreadyChecked['scannId']['Id'];


					//удаляем все метки на группах поисковых кампаний

/*
ниже более короткий вариант

					if (feedsAlreadyChecked['config']&&feedsAlreadyChecked['scannId'].hasOwnProperty('IdNum')) {
						var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
						for (var feed_id in OneSiteConfig) {
							//перебираем разрешенные сейчас фиды сайта
							if (OneSiteConfig['feeds'][feed_id]) {
							//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
								if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
								//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта
									var OneFeedGASearch = feedsAlreadyChecked.scanned.GASearch[feed_id];
									var OneFeedConfig = OneSiteConfig[feed_id];
									if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {
							
										//это метки для групп поисковой кампании, которые в процессе проверки (добавлены в массив для дальнейшего сравнения)
										//эти метки каждый раз удаляется (или очищается от групп кампании) после завершения скана/скрипта
										var labelnameNo = SCRIPT_ID_NAME + ':SCANCADGRS:' + md5(OneFeedConfig['GASearch']['Id']);
										var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + labelnameNo.replace(/\'/gm, '\\\'') + "'").get();
										while (labels.hasNext()) {
											var label = labels.next();
											label.remove();
											label.remove();
										}


									}
								}
							}
						}
					}

*/

					//это метки для групп поисковой кампании, которые в процессе проверки (добавлены в массив для дальнейшего сравнения)
					//эти метки каждый раз удаляется (или очищается от групп кампании) после завершения скана/скрипта
					var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + SCRIPT_ID_NAME.replace(/\'/gm, '\\\'') + ":SCANCADGRS:'").get();
					while (labels.hasNext()) {
						var label = labels.next();
						label.remove();
						label.remove();
					}


					//удаляем метку абра сбора групп в базы, если есть
					var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
					var CheckL = getLabel(labelRunAttachLabelsName);
					if (CheckL !== null) {
						//удаляем метку (пишем 2009 символов '-')
						setLabel(labelRunAttachLabelsName, Array(2010).join('-'));
					}


					//удаляем метку абра запуска скана, если есть
					var labelRunScanName = SCRIPT_ID_NAME + '.SCANRUN';
					var CheckL = getLabel(labelRunScanName);
					if (CheckL !== null) {
						//удаляем метку (пишем 2009 символов '-')
						setLabel(labelRunScanName, Array(2010).join('-'));
					}


					//removeRootFile(SITES_CHECKED_FILE_NAME)
					//removeRootFile(SITES_CHECKED_FILE_NAME,tmpfilesfolder)
					removeAllScanFiles(IDName,tmpfilesfolder)

					feedsAlreadyChecked = null;
				}

			} else {
//это первый проход или проход после абра при самом первом проходе, не успел создаться feedsAlreadyChecked
//проверяем изменение конфига и удаляем метки, если есть
				if (configChangeFLG&&(!AdWordsApp.getExecutionInfo().isPreview())) {


					//это метки для групп поисковой кампании, которые в процессе проверки (добавлены в массив для дальнейшего сравнения)
					//эти метки каждый раз удаляется (или очищается от групп кампании) после завершения скана/скрипта
					var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + SCRIPT_ID_NAME.replace(/\'/gm, '\\\'') + ":SCANCADGRS:'").get();
					while (labels.hasNext()) {
						var label = labels.next();
						label.remove();
						label.remove();
					}


					//удаляем метку абра сбора групп в базы, если есть
					var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
					var CheckL = getLabel(labelRunAttachLabelsName);
					if (CheckL !== null) {
						//удаляем метку (пишем 2009 символов '-')
						setLabel(labelRunAttachLabelsName, Array(2010).join('-'));
					}


					//удаляем метку абра запуска скана, если есть
					var labelRunScanName = SCRIPT_ID_NAME + '.SCANRUN';
					var CheckL = getLabel(labelRunScanName);
					if (CheckL !== null) {
						//удаляем метку (пишем 2009 символов '-')
						setLabel(labelRunScanName, Array(2010).join('-'));
					}


					//на всякий случай добавили, хотя их нет по определению
					removeAllScanFiles(IDName,tmpfilesfolder)
					feedsAlreadyChecked = null;




				}


			}



			//находим существующие завершенные сканы, которых не должно быть
			//а также получаем время последнего перебора текущих действующих сканов scanids, которые найдены в FeedConfig
			for (var id in allscansTime) {
				//if (!scanids.hasOwnProperty(id)) {
				//не стоит давать сигнал на удаление если запускаем в режиме выполнения(непросмотра) и при наличии test и наоборот (будет постоянно давать такой сигнал при выполнении, если есть test), надо отслеживать весь конфиг
				if (!FULLscanids.hasOwnProperty(id)) {
					//даем сигнал на чистку лишнего у всех сканов, только если какой-то скан теперь отсутствует в фиде, либо при любом изменении конфига
					removeSites = 1;
				//} else {
				} else if (scanids.hasOwnProperty(id)) {
					if (scanids[id]['checksum']&&(scanids[id]['checksum'] === Number(allscansTime[id]['checksum']))) {
						//получаем время последнего перебора текущих сканов scanids, которые найдены в FeedConfig
						//если настройка скана сайта изменилась, то не берем время последнего скана, оставляем 0 (нужно перезапускать скан)
						scanids[id]['date'] = allscansTime[id]['date'];
						scanids[id]['time'] = allscansTime[id]['time'];
					}
				}
			}

			//новые сканы имеют date и time = undefined (ниже в SORTscanids это нужно будет исправить на 0 для сортировки)



//это можно закомментировать в рабочем режиме, после тестов
//раскомментировал, так как долго не удалялось лишнее и scanreport.txt не обновлялся (хотя может не обновлялся не из-за этого)
			if (configChangeFLG) {
				//даем сигнал на чистку лишнего у всех сканов, только если какой-то скан теперь отсутствует в фиде, либо при любом изменении конфига
				removeSites = 1;
			}



			if (removeSites && (!AdWordsApp.getExecutionInfo().isPreview())) {

	
				//не удаляем предыдущие файлы текущего скана, пока не получили новые! Будут удалены после получения и сохранения новых файлов при завершении скана

				//если нужно удалять, то чистим отсутствущие конфиги и их фиды
				//удаляем сканы, которых нет в конфиге и не должно быть на сервере (и их сопутствующие файлы, например, фиды)
				//так же удаляем несуществущие фиды действующих сканов

				//читаем директорию files, находим сначала все файлы всего аккаунта
				var removeFilesArr = [];
				var filesfolderFiles = DriveApp.getFolderById(filesfolder.getId()).getFiles();
				var fileSiteId1 = IDName + '.';
				var fileSiteId1length = fileSiteId1.length;
				while (filesfolderFiles.hasNext()) {
					var nfile = filesfolderFiles.next();
					var FullFileName = nfile.getName();
					//if (FullFileName.substr(0, fileSiteId1length) == fileSiteId1) {
					if (!FullFileName.indexOf(fileSiteId1)) { //если совпадает IDName с началом имени файла

						//обнаружили файл аккаунта, обрезаем IDName.
						var FileName = FullFileName.substr(fileSiteId1length);
						if (FileName) { //если строка непустая

							//в последний элемент у файла фида попадет расширение типа ext.ga.txt
							//разбиваем по '.' максимум на 3 элемента (последний включает все оставшиеся '.')
							var NameArr = FileName.split('.');
							var NameArr2 = NameArr.splice(2, NameArr.length - 2).join('.')
							//var NameArr2 = NameArr.splice(2, NameArr.length).join('.')
							if (NameArr2)
								NameArr.push(NameArr2)


//последние отчеты скана имеют размер 2 элемента (это не удаляем)
//demodomain.com-ADONLY.scanreport.txt
//demodomain.com-ADONLY.confreport.txt
//demodomain.com-ADONLY.errorconf.txt

//ниже все удаляем для несуществующих сканов

//последние отчеты фида имеют размер 3 элемента (это не удаляем для существующих сканов)
//demodomain.com-ADONLY.Id.ftperrors.txt
//demodomain.com-ADONLY.Id.errorscan.txt
//demodomain.com-ADONLY.Id.scanresult.txt
//demodomain.com-ADONLY.Id.interimresult.txt

//demodomain.com-ADONLY.Id.URLHASHdublicates.json (не удаляем никогда для существущих сканов)

//файлы фида имеют размер 3 элемента (это удаляем, если фида не существует, для существующих сканов)
//demodomain.com-ADONLY.Id.feed.ext.ga.txt
//demodomain.com-ADONLY.Id.feed.ext.html



							//есть такой id скана в фиде, не удаляем, точнее сначала проверяем на несуществующие фиды
							if (FULLscanids.hasOwnProperty(NameArr[0])) {

								//это не файл фида, а служебные файлы последних отчетов фидов, либо непонятные файлы, не удаляем (непонятные файлы удалятся после выполнения скана этого фида)
								//редкая ситуация когда зарезервированное слово, например confreport совпадает с Id скана
								//if (NameArr.length <= 2)
								if (NameArr.length == 2)
									continue;

								//это непонятные файлы, удаляем типа //demodomain.com-ADONLY.scanreport
								if (NameArr.length < 2) {
									//filesfolder.removeFile(nfile);
									removeFilesArr.push(nfile);
									continue;
								}



								//ниже могут быть файлы фида или его последние отчеты, надо проверить признак

								if (NameArr[1] != 'feed') {
									//это файлы последних отчетов фидов, возможно какие-то непонятные файлы, не удаляем (непонятные файлы удалятся после выполнения скана этого фида)
									//также это могут быть URLHASHdublicates.json
									continue;
								}



//теперь NameArr[2] - это точно должен быть FullExt, его ищем в конфиге
								var OneSiteConfig = FULLFeedConfig[FULLscanids[NameArr[0]]['IdNum']];
//действущий фид, но расширение не существует в конфиге
								if (!OneSiteConfig['feedsFullExts'][NameArr[2]]) {
									//filesfolder.removeFile(nfile);
									removeFilesArr.push(nfile);
								}


								continue;
							}


							//это текущие отчеты последнего скана, не удаляем
							//if (NameArr.length <= 2)
							if (NameArr.length == 2)
								continue;

//дальше NameArr[0] - это точно Id несуществующего в конфиге скана или неизвестные файлы аккаунта, например //demodomain.com-ADONLY.scanreport
//удаляем
							//filesfolder.removeFile(nfile);
							removeFilesArr.push(nfile);



						} else {
//это файл IDName + '.' удаляем
							//filesfolder.removeFile(nfile);
							removeFilesArr.push(nfile);

						}

					}
				}
				for (var i = 0; i < removeFilesArr.length; i++) {
					var FullName = removeFilesArr[i].getName();
//проблема что через removeFile файл удаляется не сразу а через время, пробуем отправку в корзину
//оказалось setTrashed дает ошибку "Access denied: DriveApp" на каких-то файлах (removeFile всегда работает нормально, но дольше в 2 раза, поэтому только removeFile, но потом чистим "бесхозные" файлы другим скриптом)
					//removeFilesArr[i].setTrashed(true);
					//filesfolder.removeFile(removeFilesArr[i]);
					deleteOrRemoveFile(removeFilesArr[i]);
					removeFilesArr[i] = FullName;
				}
				for (var i = 0; i < removeFilesArr.length; i++) {
//и добиваем вторым вариантом
					var files = filesfolder.getFilesByName(removeFilesArr[i]);
					while (files.hasNext()) {
						var nfile = files.next();
						//filesfolder.removeFile(nfile);
						deleteOrRemoveFile(nfile);
					}
				}





			}




			var StartScanFlg = 0;


			if (feedsAlreadyChecked && feedsAlreadyChecked['CURfeedsIds'] && feedsAlreadyChecked['scannId'] && (feedsAlreadyChecked['scannId'].hasOwnProperty('Id'))) {

				//незаконченный скан с предыдущего запуска скрипта


				feedsAlreadyChecked['config'] = FeedConfig;
				feedsAlreadyChecked['scanids'] = scanids;



				if (feedsAlreadyChecked.scanned&&feedsAlreadyChecked.scanned.steps&&(feedsAlreadyChecked.scanned.FeedsFilesOUT||feedsAlreadyChecked.scanned.SearchFeedsFilesOUT)) {
					//если оборвалась запись раньше, то скидываем буферные данные файлов фидов и обнуляем их значение в хеше
					//если нет в буфере частей файлов фидов, то значит было уже сброшены буферы при выходе, поэтому не форсируем удаление частей (устанавливаем флаг "не форсировать")

					if (!AdWordsApp.getExecutionInfo().isPreview()) {
						var savebuf = saveBufferFiles(SITES_CHECKED_FILE_NAME,IDName,feedsAlreadyChecked,tmpfilesfolder,1);
						if (savebuf) {
							//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
							writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);



/*

не нужно, не влияет, удалится в конце



							if (feedsAlreadyChecked['firstsaveended']) {

								//скопировано из окончания скана (кроме .SCANRUN)

								//удаляем все метки построения базы для поиска
//								if (feedsAlreadyChecked.scanned.steps < 2) { 
									var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + SCRIPT_ID_NAME.replace(/\'/gm, '\\\'') + ":SCANCADGRS:'").get();
									while (labels.hasNext()) {
										var label = labels.next();
										label.remove();
										label.remove();
									}
//								}



								//удаляем метку абра сбора групп в базы, если есть
//								if (feedsAlreadyChecked.scanned.steps < 2) { 
									var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
									var CheckL = getLabel(labelRunAttachLabelsName);
									if (CheckL !== null) {
										//удаляем метку (пишем 2009 символов '-')
										setLabel(labelRunAttachLabelsName, Array(2010).join('-'));
									}
//								}


							}


*/


							if (feedsAlreadyChecked['interimsave']) {


/*

не нужно, не влияет, удалится в конце


								//скопировано из продолжения в конце скана (кроме .SCANRUN)



								//удаляем все метки построения базы для поиска (нельзя удалять на проходе шага 0)
//								if (feedsAlreadyChecked.scanned.steps == 1) { 
								if (feedsAlreadyChecked.scanned.steps) { 
									var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + SCRIPT_ID_NAME.replace(/\'/gm, '\\\'') + ":SCANCADGRS:'").get();
									while (labels.hasNext()) {
										var label = labels.next();
										label.remove();
										label.remove();
									}
								}


								//удаляем метку абра сбора групп в базы, если есть
//								if (feedsAlreadyChecked.scanned.steps < 2) { 
									var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
									var CheckL = getLabel(labelRunAttachLabelsName);
									if (CheckL !== null) {
										//удаляем метку (пишем 2009 символов '-')
										setLabel(labelRunAttachLabelsName, Array(2010).join('-'));
									}
//								}


*/

								//записываем промежуточный отчет сканирования отдельного сайта
	
								var scanresultFileReport = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.interimresult.txt';
								var scanresultFileReportid = filesfolder.getFilesByName(scanresultFileReport);
								while (scanresultFileReportid.hasNext()) {
									var nfile = scanresultFileReportid.next();
									//filesfolder.removeFile(nfile);
									deleteOrRemoveFile(nfile)
								}

								if (feedsAlreadyChecked.scanned && feedsAlreadyChecked.scanned.report)
									checkSaveFile(filesfolder.createFile(scanresultFileReport, feedsAlreadyChecked.scanned.report), feedsAlreadyChecked.scanned.report);

							}



						}
					}

				}





			} else {


				StartScanFlg = 1;


				//новый скан


				feedsAlreadyChecked = new Object();
				//массив данных сканируемого сайта
				feedsAlreadyChecked['scanned'] = new Object();


				feedsAlreadyChecked['config'] = FeedConfig;


				//пересканируем scanids с сортировкой Id в порядке возрастания time и priorityLev
				scanids = SORTscanids(scanids);


				feedsAlreadyChecked['scanids'] = scanids;


				//идентификатор сайта, который будем сканировать
				var ScanId = null;
				//фиды сканируемого сайта, которые будем создавать
				var CreateFeedsIds = {};

				//все действующие фиды сканируемого сайта, которые можно было бы запускать
				var RealFeedsIds = {};


				//находим, если есть, первый по списку сайт, который пора сканировать/парсить
				for (var i in scanids) {
					if (CheackCreateFeedsNow(scanids[i]['date'], FeedConfig[scanids[i]['IdNum']]['timeHours']) && CheackScanningSiteNow(scanids[i]['date'], FeedConfig[scanids[i]['IdNum']]['startDays'])) {
						//					ScanId = scanids[i]['Id'];
						//нужно зафиксировать фиды, которые выполняются в этом проходе скана (иначе, если долго выполняется скан, потом "по дороге" могут добавится еще фиды на середине скана)
						for (var ii in FeedConfig[scanids[i]['IdNum']]) {
							if (FeedConfig[scanids[i]['IdNum']]['feeds'][ii]) {
								//проверяем, что ii - это идентификатор фида из конфига, а не другой параметр

								if (!FeedConfig[scanids[i]['IdNum']]['pausedFeedsIds'][ii]) {
								//не запускать остановленные фиды
									if (FeedConfig[scanids[i]['IdNum']][ii]['parentFeed']) {
										//дочерние фиды всегда запускаем только одновременно с родительскими
										if (CreateFeedsIds[FeedConfig[scanids[i]['IdNum']][ii]['parentFeed']]) {
											RealFeedsIds[ii] = 1;
											//есть уже родительский фид в запуске, запускаем дочерний
											CreateFeedsIds[ii] = 1;
											//на всякий случай присваиваем ScanId здесь, если раньше алгоритмически ошибочно сработал общий массив timeHours или startDays (CheackCreateFeedsNow/CheackScanningSiteNow)
											ScanId = scanids[i]['Id'];
										}
									} else {
										RealFeedsIds[ii] = 1;
										if (CheackCreateFeedsNow(scanids[i]['date'], FeedConfig[scanids[i]['IdNum']][ii]['timeHours']) && CheackScanningSiteNow(scanids[i]['date'], FeedConfig[scanids[i]['IdNum']][ii]['startDays'])) {
											CreateFeedsIds[ii] = 1;
											//на всякий случай присваиваем ScanId здесь, если раньше алгоритмически ошибочно сработал общий массив timeHours или startDays (CheackCreateFeedsNow/CheackScanningSiteNow)
											ScanId = scanids[i]['Id'];
										}
									}

								}

							}
						}
						if (ScanId !== null)
							break;
					}
				}

				if (ScanId === null) {
					//нет ничего для скана, выходим полностью

					Logger.log('Not have jobs for current execute, account ' + IDName);

					//остался прочитанный файл SITES_CHECKED_FILE_NAME в tmpfilesfolder
					//надо удалить его, хотя лучше все полностью, на всякий случай
					//но только не в режиме просмотра
					//removeRootFile(SITES_CHECKED_FILE_NAME,tmpfilesfolder)
					removeAllScanFiles(IDName,tmpfilesfolder)

					break;
				}




				//копируем массивы
				feedsAlreadyChecked['scannId'] = JSON.parse(JSON.stringify(scanids[ScanId]));
				feedsAlreadyChecked['CURfeedsIds'] = JSON.parse(JSON.stringify(CreateFeedsIds));

				feedsAlreadyChecked['ALLfeedsIds'] = JSON.parse(JSON.stringify(RealFeedsIds));



				if (!feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']]) {

					//один раз наблюдал ошибку - было undefined значение для feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']]
/*
вот так это было (после окончания скана из 1 шага, при повторном запуске, когда должен был выйти так как нет изменений)
при чем это был один только запуск скана, без повтора шага 0


10 мая 2019 г. 12:35:59
Успешно выполнено
Выполнено за 18 мин.
SSMFD MAX 1

после
Run Execute mode, accaunt vinkod.com.ua

получил эту ошибку

ERROR: TypeError: Cannot read property "CSVConfig" from undefined. 	at Code#4(eval)#1(eval):255 (startFeed)
	at Code#4(eval)#1(eval):203 (ScanCreateFeeds)
	at Code#4(eval)#1(eval):27 (processAccount)


вместо

Could not find file: vinkod.com.ua.SSSitesAlreadyChecked.json on Google Drive. Creating new file.
Not have jobs for current execute, account vinkod.com.ua

*/
					//как это получается не знаю, но надо просто выйти
					//скопирован код выше


					//нет ничего для скана, выходим полностью

					Logger.log('Not have jobs for current execute (2), account ' + IDName);

					//остался прочитанный файл SITES_CHECKED_FILE_NAME в tmpfilesfolder
					//надо удалить его, хотя лучше все полностью, на всякий случай
					//но только не в режиме просмотра
					//removeRootFile(SITES_CHECKED_FILE_NAME,tmpfilesfolder)
					removeAllScanFiles(IDName,tmpfilesfolder)

					break;



				}



			}


			//собираем все существующие расширения фидов скана, которые не относятся к данному запуску
			var ScanId = feedsAlreadyChecked['scannId']['Id'];
			var NotCURFeedsFullExts = {}
			for (var ii in FULLFeedConfig[FULLscanids[ScanId]['IdNum']]) {
				if (FULLFeedConfig[FULLscanids[ScanId]['IdNum']]['feeds'][ii]) {
					//проверяем, что ii - это идентификатор фида из конфига, а не другой параметр
					if (!feedsAlreadyChecked['CURfeedsIds'][ii]) {
						//формируем массив названий файлов фидов скана
						for (var feed_file_ext in FULLFeedConfig[FULLscanids[ScanId]['IdNum']][ii]['feed_fields_file_types']) {
//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'
							NotCURFeedsFullExts[FULLFeedConfig[FULLscanids[ScanId]['IdNum']][ii]['ext'] + feed_file_ext] = 1
						}
						if (FULLFeedConfig[FULLscanids[ScanId]['IdNum']][ii]['GASearch']&&FULLFeedConfig[FULLscanids[ScanId]['IdNum']][ii]['GASearch']['GAShtml']) {
							NotCURFeedsFullExts[FULLFeedConfig[FULLscanids[ScanId]['IdNum']][ii]['ext'] + '.gas.html'] = 1
						}


					}
				}
			}



			//читаем базу urlhash-дубликатов (база url-коллизий)
			//похоже на readJSONFile
			var foundURLHASHdublicatesFileName = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.URLHASHdublicates.json';
			var foundURLHASHdublicatesid = filesfolder.getFilesByName(foundURLHASHdublicatesFileName);
			if (foundURLHASHdublicatesid.hasNext()) {
				var fileData = foundURLHASHdublicatesid.next().getBlob().getDataAsString();
				var foundURLHASHdublicates = JSON.parse(fileData);
			} else {
				var foundURLHASHdublicates = {};
			}
			var foundURLHASHdublicateschecksum = murmurhash3_32_gc(JSON.stringify(foundURLHASHdublicates));







			//перед входом у нас должны быть готовы
			//foundURLHASHdublicates (зачитать)
			//feedsAlreadyChecked['config']
			//feedsAlreadyChecked['scanids']
			//feedsAlreadyChecked['scannId']
			//feedsAlreadyChecked['CURfeedsIds']
			//feedsAlreadyChecked['scanned']
			//Вызываем скан (за это отвечают CheackCreateFeedsNow и CheackScanningSiteNow)
			//в режиме просмотра вызывается только! при наличии test в timeHours
			didExitEarly = ScanCreateFeeds(feedsAlreadyChecked,foundURLHASHdublicates,SITES_CHECKED_FILE_NAME,IDName,CustomerName,StartScanFlg);

			//сначала активность, потом паузы, потом удаления
			pauseKeywordapply()
			removeKeywordapply()
			enableAdGroupapply()
			pauseAdGroupapply()
			removeAdGroupapply()
			removeCampaignapply()

			//записываем базу urlhash-дубликатов (база url-коллизий)
			//похоже на writeJSONFile
//			if (!AdWordsApp.getExecutionInfo().isPreview()) {
				if (foundURLHASHdublicates && foundURLHASHdublicates.array && Object.keys(foundURLHASHdublicates.array).length) {
//записываем только непустой массив, в котором есть изменения
					var foundURLHASHdublicateschecksumNew = murmurhash3_32_gc(JSON.stringify(foundURLHASHdublicates));
					if (foundURLHASHdublicateschecksumNew != foundURLHASHdublicateschecksum) {
						var foundURLHASHdublicatesid = filesfolder.getFilesByName(foundURLHASHdublicatesFileName);
						while (foundURLHASHdublicatesid.hasNext()) {
							var nfile = foundURLHASHdublicatesid.next();
							//filesfolder.removeFile(nfile);
							deleteOrRemoveFile(nfile)
						}
						var file = checkSaveFile(filesfolder.createFile(foundURLHASHdublicatesFileName, ''), '');
						var FileDataSave = JSON.stringify(foundURLHASHdublicates);
						checkSaveFile(file.setContent(FileDataSave),FileDataSave);
					}
				}

//			}




			if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {

				if (/^[^\n]*We\'re sorry\, a server error occurred\. Please wait a bit and try again\./.test(ScanCreateFeedsGlobalVars.errors)) {
					//при такой ошибке в первой строчке списка ошибок - нельзя выходить окончательно, надо попытаться сохранить данные для повторного запуска
					//это ошибка, которую выдает сервер на любой операции, в т.ч. "маскирует" под ошибки, которые мы контролируем

					Logger.log("Change didExitEarly to 'true' And Delete error 'server error occurred':\n" + ScanCreateFeedsGlobalVars.errors)
					didExitEarly = true;
					ScanCreateFeedsGlobalVars.errors = '';
				}

			}


			if (AdWordsApp.getExecutionInfo().isPreview()) {
				//надо завершить и сохранить для изучения неоконченные фиды
				//здесь фтп не успеет выполнится наверное
				didExitEarly = false;
			}


			if (CONTROL_EMPTY_FEEDS) {
				//на всякий случай, хотя никогда не может появится здесь true
				didExitEarly = false;
			}


			if ((!didExitEarly)||(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)) {
			//ошибки или закончен скан




				if (!feedsAlreadyChecked['notwriteanyfeeds']) {
					feedsAlreadyChecked['notwriteanyfeeds']={}
					feedsAlreadyChecked['notwriteanyfeeds']['AnotherModeFeedsFullExts'] = {}
					feedsAlreadyChecked['notwriteanyfeeds']['AnotherModeFeedsIds'] = {}
					feedsAlreadyChecked['notwriteanyfeeds']['notwriteanyfeeds'] = []
					feedsAlreadyChecked['notwriteanyfeeds']['notwriteanyfeeds'][0] = 0;
				}
				var AnotherModeFeedsFullExts = feedsAlreadyChecked['notwriteanyfeeds']['AnotherModeFeedsFullExts']
				var AnotherModeFeedsIds = feedsAlreadyChecked['notwriteanyfeeds']['AnotherModeFeedsIds']
				//флаг (notwriteanyfeeds[0]), что не записаны некоторые фиды (изменился тип запуска этих фидов, появился 'test' у режима выполнения или наоборот)
				var notwriteanyfeeds = feedsAlreadyChecked['notwriteanyfeeds']['notwriteanyfeeds'];


				//может возникнуть уже здесь необходимость выключения без окончания
				var didExitEarlyFTP = false;



				if (!(feedsAlreadyChecked['ended']&&feedsAlreadyChecked['ended']['feeds_files_saved'])) {

					//файлы фидов еще не сохранялись
					//если уже сохранялись файлы фидов, то не стоит их переписывать, во-первых - опять тратить время на запись, во-вторых, изменять дату их записи
        

					if (!didExitEarly) {
						if (!AdWordsApp.getExecutionInfo().isPreview()) {

							if (!feedsAlreadyChecked['firstsaveended']) {

								feedsAlreadyChecked['interimsave'] = 0;

								//флаг дает понять при рестарте, что это последний проход
								feedsAlreadyChecked['firstsaveended'] = 1;

								//обязательно записать перед saveBufferFiles!!, иначе может быть зациклен повтор на обрыве в saveBufferFiles
								//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
								writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);

							}

                                                        if (feedsAlreadyChecked.scanned.scanned.length) {

								var savebuf = saveBufferFiles(SITES_CHECKED_FILE_NAME,IDName,feedsAlreadyChecked,tmpfilesfolder);

//записи для файлов фидов сброшены в архиве
//удаляем ненужные теперь массивы данных, занимающие много места (потом будем писать фиды и там большие файлы могут быть, поэтому сокращаем общую память)
//удаляем так что бы если будет повторный проход, то ничего не сработало при проходе
								delete feedsAlreadyChecked.scanned.scanned;
								delete feedsAlreadyChecked.scanned.checked;
								delete feedsAlreadyChecked.scanned.referrer;
								delete feedsAlreadyChecked.scanned.referrer_field;
								delete feedsAlreadyChecked.scanned.URLHASHIDscanned;
								feedsAlreadyChecked.scanned.scanned = [];
								feedsAlreadyChecked.scanned.scnuncur = 1


								//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
								writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);
							}
						}



					}


					if (!feedsAlreadyChecked['firstsaveended']) {
						//если была ошибка или просмотр, то по любому пишем, что это последний проход (на всякий случай для единообразия)
						feedsAlreadyChecked['firstsaveended'] = 1;
						feedsAlreadyChecked['interimsave'] = 0;
					}



					//главное что сохранился массив, дальше еще может быть абр при записи фидов, 
					//но это уже не важно для базы поисковых групп РК
					//при ошибках, которые здесь проходят, также уже не нужна эта метка
					var labelRunScanName = SCRIPT_ID_NAME + '.SCANRUN';
					var CheckL = getLabel(labelRunScanName);
					//теоретически метка могла еще не появится в подпрограмме где нужно зафиксировать точку входа в генерацию групп РК, поэтому сначала проверяем наличие
					if (CheckL !== null) {
						//удаляем метку (пишем 2009 символов '-')
						setLabel(labelRunScanName, Array(2010).join('-'));
					}


					//удаляем все метки построения базы для поиска
//					if (feedsAlreadyChecked.scanned.steps < 2) { 
						var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + SCRIPT_ID_NAME.replace(/\'/gm, '\\\'') + ":SCANCADGRS:'").get();
						while (labels.hasNext()) {
							var label = labels.next();
							label.remove();
							label.remove();
						}
//					}



					//удаляем метку абра сбора групп в базы, если есть
//					if (feedsAlreadyChecked.scanned.steps < 2) { 
						var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
						var CheckL = getLabel(labelRunAttachLabelsName);
						if (CheckL !== null) {
							//удаляем метку (пишем 2009 символов '-')
							setLabel(labelRunAttachLabelsName, Array(2010).join('-'));
						}
//					}




					//читаем текущий конфиг
					//решаем теоретическую проблему, когда на лету был конфиг фида изменен на 'test' в timeHours, в это время заканчивает свою работу скрипт в режиме выполения (который уже не нужен), а мы запустили скрипт в режиме просмотра и тогда скрипт в режиме выполнения удалит файлы фида скрипта просмотра
					//или наоборот, еще одна теоретическая проблема, когда на лету был удален из конфига фида 'test' и когда заканчивается скрипт в просмотре (который уже не нужен), а сейчас запустился скрипт в режиме выполнения и тогда скрипт в режиме просмотра удалит файлы фида скрипта выполнения

					//var [reterr_current,FeedConfig_current,scanids_current,configChecksum_current,configChangeFLG_current,configfolder_current,ClearConfig_current,conferrors_current] = readFeedConfig(IDName,mainfolder,domainsfolder,filesfolder);
					var [reterr_current,FeedConfig_current,scanids_current,configChecksum_current,configChangeFLG_current,configfolder_current,ClearConfig_current,conferrors_current] = rateLimitExpBackoff(readFeedConfig, [IDName, mainfolder, domainsfolder, filesfolder], backoffErrors);

					if (reterr_current) {
						//ошибка конфига, продолжаем как есть, со старым конфигом
						FeedConfig_current = FULLFeedConfig;
						scanids_current = FULLscanids;

					//} else {

						//reterr_current == 0 //есть файл конфига, может старый, а может новый, долго проверять, поэтому просто проверяем на наличие 'test'
					}




					var ScanId = feedsAlreadyChecked['scannId']['Id'];


					if (!AdWordsApp.getExecutionInfo().isPreview()) {
		
						//собираем все существующие расширения фидов скана, которые относятся к режиму просмотра
						//собираем все идентификаторы фидов скана, которые относятся к режиму просмотра
						if (scanids_current[ScanId]&&FeedConfig_current[scanids_current[ScanId]['IdNum']]) {
							for (var ii in FeedConfig_current[scanids_current[ScanId]['IdNum']]) {
								if (FeedConfig_current[scanids_current[ScanId]['IdNum']]['feeds'][ii]) {
									//проверяем, что ii - это идентификатор фида из конфига, а не другой параметр
									if (FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['timeHours']&&(FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['timeHours'].indexOf('test') != -1)) {
										AnotherModeFeedsIds[ii] = 1;
										//формируем массив названий файлов фидов скана
										for (var feed_file_ext in FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['feed_fields_file_types']) {
//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'
											AnotherModeFeedsFullExts[FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['ext'] + feed_file_ext] = 1
											notwriteanyfeeds[0] = 1;

										}
										if (FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['GASearch']&&FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['GASearch']['GAShtml']) {
											AnotherModeFeedsFullExts[FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['ext'] + '.gas.html'] = 1
											notwriteanyfeeds[0] = 1;
										}


									}
								}
							}
						}

					} else {


		
						//собираем все существующие расширения фидов скана, которые относятся к режиму выполнения скрипта
						//собираем все идентификаторы фидов скана, которые относятся к режиму выполнения скрипта
						if (scanids_current[ScanId]&&FeedConfig_current[scanids_current[ScanId]['IdNum']]) {
							for (var ii in FeedConfig_current[scanids_current[ScanId]['IdNum']]) {
								if (FeedConfig_current[scanids_current[ScanId]['IdNum']]['feeds'][ii]) {
									//проверяем, что ii - это идентификатор фида из конфига, а не другой параметр
									if ((!FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['timeHours'])||(FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['timeHours'].indexOf('test') == -1)) {
										AnotherModeFeedsIds[ii] = 1;
										//формируем массив названий файлов фидов скана
										for (var feed_file_ext in FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['feed_fields_file_types']) {
//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'
											AnotherModeFeedsFullExts[FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['ext'] + feed_file_ext] = 1
											notwriteanyfeeds[0] = 1;
										}
										if (FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['GASearch']&&FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['GASearch']['GAShtml']) {
											AnotherModeFeedsFullExts[FeedConfig_current[scanids_current[ScanId]['IdNum']][ii]['ext'] + '.gas.html'] = 1
											notwriteanyfeeds[0] = 1;
										}


									}
								}
							}
						}

					}


	
					if (!(feedsAlreadyChecked['ended']&&feedsAlreadyChecked['ended']['feeds_files_removed'])) {

					//if ((!didExitEarly)&&(!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))) {
					//удаляем и записываем, если был скан (feedsAlreadyChecked.scanned.steps)
					if ((!didExitEarly)&&(!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))&&feedsAlreadyChecked.scanned.steps) {

						//не удаляем и ниже не записываем фиды, если ошибки есть


						//удаление всех данных скана сайта

						//читаем директорию files, находим сначала все файлы всего аккаунта



						//внимание !!! именно здесь, сами фиды - удалять только файлы фидов, которые относятся к данному скану
						//иначе удалятся другие фиды, которые запускаются в другое время


						var removeFilesArr = [];
						var filesfolderFiles = DriveApp.getFolderById(filesfolder.getId()).getFiles();
						var fileSiteId1 = IDName + '.';
						var fileSiteId1length = fileSiteId1.length;
						while (filesfolderFiles.hasNext()) {
							var nfile = filesfolderFiles.next();
							var FullFileName = nfile.getName();
							//if (FullFileName.substr(0, fileSiteId1length) == fileSiteId1) {
							if (!FullFileName.indexOf(fileSiteId1)) { //если совпадает IDName с началом имени файла

								//обнаружили файл аккаунта, обрезаем IDName.
								var FileName = FullFileName.substr(fileSiteId1length);
								if (FileName) { //если строка непустая

									//в последний элемент у файла фида попадет расширение типа ext.ga.txt
									//разбиваем по '.' максимум на 3 элемента (последний включает все оставшиеся '.')
									var NameArr = FileName.split('.');
									var NameArr2 = NameArr.splice(2, NameArr.length - 2).join('.')
									//var NameArr2 = NameArr.splice(2, NameArr.length).join('.')
									if (NameArr2)
										NameArr.push(NameArr2)


									//это не текущий скан, не удаляем
									if (NameArr[0] != feedsAlreadyChecked['scannId']['Id'])
										continue


//служебные отчеты скана (размер массива 2) удаляем
//demodomain.com-ADONLY.scanreport.txt
//demodomain.com-ADONLY.confreport.txt
//demodomain.com-ADONLY.errorconf.txt

//данные фида равны 3 элементам, 2-й это не feed  (это удаляем)
//demodomain.com-ADONLY.Id.ftperrors.txt
//demodomain.com-ADONLY.Id.errorscan.txt
//demodomain.com-ADONLY.Id.scanresult.txt
//demodomain.com-ADONLY.Id.interimresult.txt


//demodomain.com-ADONLY.Id.URLHASHdublicates.json (не удаляем никогда для существущих сканов)


//данные фида равны 3 элементам, 2-й это feed (это не удаляем)
//demodomain.com-ADONLY.Id.feed.ext.ga.txt
//demodomain.com-ADONLY.Id.feed.ext.html


									//это служебные файлы последних отчетов скана либо непонятные файлы, удаляем
									if (NameArr.length < 3) {
										if (AdWordsApp.getExecutionInfo().isPreview()) {
											//не удаляем последние отчеты скана в режиме просмотра
											continue;
										}
										//filesfolder.removeFile(nfile);
										removeFilesArr.push(nfile);
										continue;
									}

									//ниже должны быть файлы фида или их отчетов, надо проверить признак
									if (NameArr[1] != 'feed') {

										//не удаляем никогда файл хеша дубликатов
										if ((NameArr[1] == 'URLHASHdublicates')&&(NameArr[2] == 'json')&&(NameArr.length == 3))
											continue;

										//это файлы последних отчетов фидов и непонятные файлы, удаляем
										//это тоже отчеты последнего реального скана, не удаляем в режиме просмотра
										if (AdWordsApp.getExecutionInfo().isPreview()) {
											//не удаляем последние отчеты скана в режиме просмотра
											continue;
										}
										//filesfolder.removeFile(nfile);
										removeFilesArr.push(nfile);
										continue;
									}



//теперь NameArr[2] - это точно должен быть FullExt, его ищем в конфиге, не удаляем резервные приостановленного фиды и файлы фида из другого запуска скана


									//расширения фидов других запусков скана пропускаем, не удаляем
									if (NotCURFeedsFullExts[NameArr[2]])
										continue


			
									//это приостановленные фиды текущего скана, не удаляем
									if (FULLscanids[NameArr[0]]&&FULLFeedConfig[FULLscanids[NameArr[0]]['IdNum']]['pausedFeedsFullExts'][NameArr[2]])
										continue




									//расширения фидов обратного типа запуска, которые появились в конфиге перед завершением (то есть для режима выполнения обратный с 'test' в timeHours, для режима просмотра обратный без 'test' в timeHours)
									if (AnotherModeFeedsFullExts[NameArr[2]])
										continue




//дальше это точно несуществующего в конфиге скана фиды или неизвестные файлы
//теперь удаляем окончательно
									//filesfolder.removeFile(nfile);
									removeFilesArr.push(nfile);


								} else {
//это файл IDName + '.' удаляем
									//filesfolder.removeFile(nfile);
									removeFilesArr.push(nfile);

								}
					
							}
						}
						for (var i = 0; i < removeFilesArr.length; i++) {
							var FullName = removeFilesArr[i].getName();
//проблема что через removeFile файл удаляется не сразу а через время, пробуем отправку в корзину
//оказалось setTrashed дает ошибку "Access denied: DriveApp" на каких-то файлах (removeFile всегда работает нормально, но дольше в 2 раза, поэтому только removeFile, но потом чистим "бесхозные" файлы другим скриптом)
							//removeFilesArr[i].setTrashed(true);
							//filesfolder.removeFile(removeFilesArr[i]);
							deleteOrRemoveFile(removeFilesArr[i])
							removeFilesArr[i] = FullName;
						}
						for (var i = 0; i < removeFilesArr.length; i++) {
//и добиваем вторым вариантом
							var files = filesfolder.getFilesByName(removeFilesArr[i]);
							while (files.hasNext()) {
								var nfile = files.next();
								//filesfolder.removeFile(nfile);
								deleteOrRemoveFile(nfile)
							}
						}



						feedsAlreadyChecked['ended']={};
						feedsAlreadyChecked['ended']['feeds_files_removed']=1;

						//так как может быть обрыв-таймаут, сохраняем флаг после удаления, что бы не повторять

						if (!AdWordsApp.getExecutionInfo().isPreview()) {
							//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
							writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);
						}


					}




					}


					//if ((!didExitEarly)&&(!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))) {
					//удаляем и записываем, если был скан (feedsAlreadyChecked.scanned.steps)
					if ((!didExitEarly)&&(!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))&&feedsAlreadyChecked.scanned.steps) {

						//запись фидов скана сайта


//здесь допустимы все расширения файлов фидов (в т.ч..gas.html)
//var correctfeedExt = ['.html', '.gas.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'];

//допустимые расширения файлов фидов и их завершающие обработчики
	var correctfeedExtFunctions = {
		'.html': function(feed_file_ext,OneSiteConfig,OneFeedConfig,FeedOUT) {


			var TMPFeedOUT = "<html><head>\n<meta charset='" + OneSiteConfig['CHARSET'] + "'>\n";

			TMPFeedOUT += "<title>" + OneSiteConfig['SITE'] + "</title>\n";

			TMPFeedOUT += "</head><body>\n";

			if (OneSiteConfig['title'])
				TMPFeedOUT += OneSiteConfig['title'] + "<br><br>\n";

			TMPFeedOUT += OneSiteConfig['SITE'] + "<br>\n";
			TMPFeedOUT += OneFeedConfig.ext + "<br><br>\n";

			var TMPFeedOUTend = "<hr>\n" + "</body></html>";

			return TMPFeedOUT + FeedOUT + TMPFeedOUTend;


		},
		'.gas.html': function(feed_file_ext,OneSiteConfig,OneFeedConfig,FeedOUT) {


			var TMPFeedOUT = "<html><head>\n<meta charset='" + OneSiteConfig['CHARSET'] + "'>\n";

			TMPFeedOUT += "<title>" + OneSiteConfig['SITE'] + "</title>\n";


			TMPFeedOUT += '<style>.gL9Hy{font-size:18px}.spell_orig{font-size:15px}.renattw h3{font-size:18px !important;line-height:24px;}.renattw{color:#545454;line-height:20px;}.renattw a:active{color:#dd4b39}.renattw .pCA4Bd,.renattw .pCA4Bd a{color:#777}.renattw{}.renattw{margin-bottom:30px;position:relative}#center_col .C4eCVc{box-sizing:border-box;padding:0 20px 0 20px;position:relative;margin-left:0px;margin-right:0px;width:632px}#tads{margin-top:7px}.sA5rQ{display:inline-block}.useyer{display:inline-block;}.useyer{color:#006621;white-space:nowrap;font-size:14px;padding-bottom:1px;padding-top:0px;}.useyer cite{color:#006621;vertical-align:bottom}.UdQCqe{display:inline-block;max-width:558px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.useyer .Z98Wse{margin-right:7px;margin-left:0px}.Z98Wse{background-color:#fff;border-radius:3px;color:#006621;display:inline-block;font-size:11px;border:1px solid #006621;padding:1px 3px 0 2px;line-height:11px;vertical-align:baseline}.e1ycic{display:inline-block;margin:0 3px;position:initial;width:12px}.TxG06d{position:relative;top:0px;left:0px;cursor:pointer;display:inline-block}.YMEk9e,.action-menu.YMEk9e{margin:0px 0px 0px 0px;padding:0px 0px 0px 0px}.e1ycic .k1sBMc{display:inline-block}.C4eCVc .action-menu{line-height:0}.C4eCVc .action-menu .mn-dwn-arw{border-color:#006621 transparent;margin-top:-4px;margin-top:-4px;top:50%}.C4eCVc .action-menu:hover .mn-dwn-arw{border-color:#00591E transparent}.action-menu.YMEk9e{height:12px;position:relative;vertical-align:middle}.PXnpre{color:#545454;font-size:small;margin-left:8px;white-space:nowrap;vertical-align:bottom;vertical-align:top}.h5RoYd{display:-webkit-box;overflow:hidden;text-overflow:ellipsis;-webkit-box-orient:vertical}.jrjS0e{height:40px;-webkit-line-clamp:2}.I6vAHd{height:60px;-webkit-line-clamp:3}.tyusdg b{color:#6a6a6a}.OkkX2d>li+li:before{content:\' · \'}.OkkX2d{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.OkkX2d>li{display:inline;margin:0;padding:0;line-height:inherit}.Ak2Hcf{display:block;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAaBAMAAABMRsE0AAAAFVBMVEVMaXEAAAAAAAAAAAAAAAAAAAAAAACpf3wfAAAAB3RSTlMAEShid4hELiWJNAAAAIBJREFUeAFFyjUWAkEABNFCUzTHY3Ry9AArTYrf/wr0W+1kpD4wPFxmeM0gJVNgJS/2h7JNaTk4blzSafPmFnSGpRJu/nVP60vQCcZOPyX9RtDdD10O8ndX2Z40bvLSPkaSCRiZQI6eYJQTo5wY5cQoJxjlBEICOcoJtDbka06BPzdqJHaMPuOJAAAAAElFTkSuQmCC);background-position:left 3px;background-repeat:no-repeat;background-size:8px 13px;margin-left:2px;padding-left:13px}.vc7dXb{color:rgba(0,0,0,0.57);margin:12px 20px;font-size:14px}.VQ1yJb{box-shadow:0 1px 2px rgba(0,0,0,0.2);display:none;left:calc(100% + 64px);margin-top:10px;top:2px;opacity:0;transition:all 150ms ease-in-out;transform-origin:top left;white-space:nowrap;border:1px solid rgba(0,0,0,0.13);border-radius:2px}.qOrWEe{background-color:transparent;transform-origin:top}.f5ZhKb{display:inline-block;overflow-x:hidden;overflow-y:hidden;margin-left:-16px;padding-right:24px;width:100%;padding-left:20px}.f5ZhKb::-webkit-scrollbar{display:none}.vA0x9b{background-image:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2216px%22%20height%3D%2216px%22%20viewBox%3D%220%200%2048%2048%22%20fill%3D%22%23000000%22%3E%0D%0A%20%20%20%20%3Cpath%20d%3D%22M38%2012.83L35.17%2010%2024%2021.17%2012.83%2010%2010%2012.83%2021.17%2024%2010%2035.17%2012.83%2038%2024%2026.83%2035.17%2038%2038%2035.17%2026.83%2024z%22%2F%3E%0D%0A%20%20%20%20%3Cpath%20d%3D%22M0%200h48v48H0z%22%20fill%3D%22none%22%2F%3E%0D%0A%3C%2Fsvg%3E%0D%0A);background-repeat:no-repeat;background-position:center;position:absolute;right:0px;width:16px;height:16px;padding:12px;z-index:10;opacity:0.54}.vA0x9b:focus{outline:none}.qOrWEe{padding-left:15px}.VQ1yJb{box-shadow:none;margin-top:8px;margin-left:-15px;margin-right:-15px}.f5ZhKb{line-height:24px;margin-left:0;overflow-x:hidden;padding-left:0px;padding-right:0;white-space:normal;width:calc(100% - 24px)}.vc7dXb{margin-bottom:4px;margin-left:0px;margin-top:14px}.f5ZhKb{white-space:nowrap}.U5aBtb{position:relative;top:0.16em;display:inline-block;width:0.615em;height:1em;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAaBAMAAABMRsE0AAAAFVBMVEVMaXEAAAAAAAAAAAAAAAAAAAAAAACpf3wfAAAAB3RSTlMAEShid4hELiWJNAAAAIBJREFUeAFFyjUWAkEABNFCUzTHY3Ry9AArTYrf/wr0W+1kpD4wPFxmeM0gJVNgJS/2h7JNaTk4blzSafPmFnSGpRJu/nVP60vQCcZOPyX9RtDdD10O8ndX2Z40bvLSPkaSCRiZQI6eYJQTo5wY5cQoJxjlBEICOcoJtDbka06BPzdqJHaMPuOJAAAAAElFTkSuQmCC);background-size:100% 100%;background-repeat:no-repeat;border:0;margin-left:0.19em;margin-right:0.354em}a:hover h3.LC20lb{text-decoration:underline}.LC20lb{display:inline-block;line-height:1.33;}.TbwUpd{padding-bottom:1px;padding-top:1px}.brs{}.brs{margin-bottom:28px}.brs .med{color:#222;height:auto;padding-bottom:8px}.brs_col{font-size:12px;margin-top:-1px;padding-bottom:1px;display:inline-block;line-height:12px;vertical-align:top;max-width:100%;box-sizing:border-box}.brs .nVcaUb{margin:0;clear:both;}.brs a{padding:3px 40px 3px 0;display:inline-block;float:left}.brs a{text-decoration:none}g-section-with-header{display:block;margin:40px 0}.e2BEnf{font-size:18px;line-height:1.33;}.U7izfe{padding:0 0px 5px 0px}#foot{visibility:inherit}</style>'
			TMPFeedOUT += '<style id="gstyle">body{color:#000;margin:0}body{background:#fff}a.gb1,a.gb2,a.gb3,.link{color:#1a0dab !important}.ts{border-collapse:collapse}.ts td{padding:0}.g{line-height:1.2;text-align:left;}.ti,.bl{display:inline}.ti{display:inline-table}#rhs_block{padding-bottom:15px}a:link,.w,#prs a:visited,#prs a:active,.q:active,.q:visited,.kl:active,.tbotu{color:#1a0dab}.mblink:visited,a:visited{color:#609}.cur,.b{font-weight:bold}.j{width:42em;font-size:82%}.s{max-width:48em}.sl{font-size:82%}.hd{position:absolute;width:1px;height:1px;top:-1000em;overflow:hidden}.f,.f a:link,.m{color:#777;line-height:1.54}.c h2{color:#666}.mslg cite{display:none}.ng{color:#dd4b39}h1,ol,ul,li{margin:0;padding:0}.g,body,html,input,.std,h1{font-family:arial,sans-serif;font-size:small}.c h2,h1{font-weight:normal}.blk a{color:#000}#nav a{display:block}#nav .i{color:#a90a08;font-weight:bold}.csb,.ss,.micon{background:url(/images/nav_logo242_hr.png) no-repeat;background-size:167px;overflow:hidden}.csb,.ss{background-position:0 0;height:40px;display:block}#nav td{padding:0;text-align:center}.ch{cursor:pointer}h3,.med{font-size:medium;font-weight:normal;margin:0;padding:0}#res h3{font-size:18px;line-height:1.33;}.e{margin:2px 0 .75em}.slk div{padding-left:12px;text-indent:-10px}.blk{border-top:1px solid #6b90da;background:#f0f7f9}#cnt{clear:both}#res{padding-right:1em;margin:0 16px}.xsm{font-size:x-small}ol li{list-style:none}.sm li{margin:0}.gl,#foot a,.nobr{white-space:nowrap}#foot #navcnt a{color:#4285f4;font-weight:normal}#foot #navcnt .cur{color:rgba(0,0,0,0.87);font-weight:normal}.sl,.r{font-weight:normal;margin:0}.r{font-size:medium}h4.r{font-size:small}.vshid{display:none}.gic{position:relative;overflow:hidden;z-index:0}.nwd{font-size:10px;padding:0 16px 30px 16px;text-align:center}#rhs{display:block;margin-left:712px;padding-bottom:10px;min-width:268px}.mdm #rhs{margin-left:732px}.big #rhs{margin-left:792px;}body .big #subform_ctrl{margin-left:229px}.rhslink{width:68px}.rhsdw .rhslink{width:156px}.rhsimg{width:70px}.rhsimg.rhsdw{width:158px}.rhsimg.rhsn1st{margin-left:16px}#rhs .scrt.rhsvw,#rhs table.rhsvw{border:0}#rhs .rhsvw{border:1px solid #ebebeb;padding-left:15px;padding-right:15px;position:relative;width:424px;}#center_col .rhsl4,#center_col .rhsl5,#center_col .rhsn5{display:none}#rhs .rhstc4 .rhsvw,#nyc.rhstc4 .rhsvw{width:336px}#rhs .rhstc3 .rhsvw,#nyc.rhstc3 .rhsvw{width:248px}.rhstc4 .rhsg4,.rhstc3 .rhsg4,.rhstc3 .rhsg3{background:none !important;display:none !important}.rhstc5 .rhsl5,.rhstc5 .rhsl4,.rhstc4 .rhsl4{background:none !important;display:none !important}.rhstc4 .rhsn4{background:none !important;display:none !important}.nrgt{margin-left:22px}.mslg .vsc{border:1px solid transparent;border-radius:2px;border-radius:2px;-webkit-transition:opacity .2s ease;margin-top:2px;padding:3px 0 3px 5px;transition:opacity .2s ease;width:294px}.mslg>td{padding-right:6px;padding-top:4px}button.vspib{display:none}.vsc{display:inline-block;position:relative;width:100%}#res h3.r{display:block;overflow:hidden;text-overflow:ellipsis;-webkit-text-overflow:ellipsis;white-space:nowrap}#res h3.inl{display:inline;white-space:normal}em{font-weight:bold;font-style:normal}ol,ul,li{border:0;margin:0;padding:0}.g{margin-top:0;margin-bottom:30px}.ibk{display:inline-block;vertical-align:top}.tsw{width:595px}#cnt{min-width:833px;margin-left:0}.mw{max-width:1197px}.big .mw{max-width:1280px}#cnt #center_col,#cnt #foot{width:632px}.gbh{top:24px}#gbar{margin-left:8px;height:20px}#guser{margin-right:8px;padding-bottom:5px !important}.tsf-p{padding-left:150px;margin-right:46px;max-width:739px}.big .tsf-p{margin-right:322px;padding-left:150px}.uc{padding-left:8px;position:relative;margin-left:128px;}.ucm{padding-bottom:5px;padding-top:5px;margin-bottom:8px}.col{float:left}#leftnavc,#center_col,#rhs{position:relative}#center_col{margin-left:138px;margin-right:264px;}.mdm #center_col{margin-left:138px;}.big #center_col{margin-left:138px;}#subform_ctrl{font-size:11px;margin-right:480px;position:relative;z-index:99}#subform_ctrl a.gl{color:#1a0dab}#center_col{clear:both}#res{border:0;margin:0;padding:0 20px;}#extrares{padding:0 20px}#ires{margin-top:6px}.micon{border:0}.mitem{border-bottom:1px solid transparent;line-height:29px;opacity:1.0;}.mitem .kl{padding-left:16px}.mitem .kl:hover,.msel .kls:hover{color:#222;display:block}.mitem>.kl{color:#222;display:block}.msel{color:#dd4b39;cursor:pointer}.msel .kls{border-left:5px solid #dd4b39;padding-left:11px}.mitem>.kl,.msel{font-size:13px}#tbd{display:block;min-height:1px}.tbt{font-size:13px;line-height:1.2}.tbnow{white-space:nowrap}.tbos,.tbots{font-weight:bold}.tbst{margin-top:8px}#iszlt_sel.tbcontrol_vis{margin-left:0}.tbpc,.tbpo{font-size:13px}.tbpc,.tbo .tbpo{display:inline}.tbo .tbpc,.tbpo,#set_location_section{display:none}.lco #set_location_section{display:block}#cdr_opt{padding-left:8px;text-indent:0}.tbou #cdr_frm{display:none}#cdr_frm,#cdr_min,#cdr_max{color:rgb(102,102,102)}#cdr_min,#cdr_max{font-family:arial,sans-serif;width:100%}#cdr_opt label{display:block;font-weight:normal;margin-right:2px;white-space:nowrap}a:link,.w,.q:active,.q:visited{cursor:pointer}.osl a,.gl a,#tsf a,a.mblink,a.gl,a.fl,.slk a,.bc a,.flt,a.flt u,.blg a,#appbar a{text-decoration:none}.osl a:hover,.gl a:hover,#tsf a:hover,a.mblink:hover,a.gl:hover,a.fl:hover,.slk a:hover,.bc a:hover,.flt:hover,a.flt:hover u,.tbotu:hover,.blg a:hover{text-decoration:underline}#tads a,#tadsb a,#res a,#rhs a,#taw a{text-decoration:none}.brs a,.nsa,.tbt a,.tbotu:hover,#tbpi,#nycntg a:hover,.fl,.navend span,#botstuff a,.flt:hover u,.mlocsel span,#rhs .gl a,#nav a.pn{text-decoration:none}#ss-box a:hover{text-decoration:none}.osl a{line-height:1.54;}.osl{color:#777}#gbi,#gbg{border-color:#a2bff0 #558be3 #558be3 #a2bff0}#gbi a.gb2:hover,#gbg a.gb2:hover,.mi:hover{background-color:#558be3}#guser a.gb2:hover,.mi:hover,.mi:hover *{color:#fff !important}#guser{color:#000}#imagebox_bigimages .th{border:0}#foot .ftl{margin-right:12px}#foot{visibility:hidden}#fll a,#bfl a{color:#1a0dab;margin:0 12px;text-decoration:none}.stp{margin:7px 0 17px}body{color:#222}.s{color:#545454}.s .st em,.st.s.std em{color:#6a6a6a}.s a:visited em{color:#609}.s a:active em{color:#dd4b39}.sfcc{width:833px;}#tsf{width:833px;}.big .sfcc{max-width:1129px}.big #tsf{width:1109px}#topstuff .obp{padding-top:6px}.slk{margin-top:6px !important}.st{line-height:1.54;word-wrap:break-word;}.kt{border-spacing:2px 0;margin-top:1px}.esw{vertical-align:text-bottom;}.cpbb,.kpbb,.kprb,.kpgb,.kpgrb,.ksb{-webkit-border-radius:2px;border-radius:2px;cursor:default;font-family:arial,sans-serif;font-size:11px;font-weight:bold;height:27px;line-height:27px;margin:2px 0;min-width:54px;padding:0 8px;text-align:center;-webkit-transition:all 0.218s,visibility 0s;transition:all 0.218s,visibility 0s;-webkit-user-select:none}.ab_button{-webkit-border-radius:2px;border-radius:2px;cursor:default;font-family:arial,sans-serif;font-size:11px;font-weight:bold;height:27px;line-height:27px;margin:2px 0;min-width:54px;padding:0 8px;text-align:center;-webkit-transition:all 0.218s,visibility 0s;transition:all 0.218s,visibility 0s;-webkit-user-select:none}#top_nav .ab_button{background:none;border:none;font:inherit;height:auto;margin:0;min-width:0;padding:0;width:auto}#top_nav .ab_button:hover{-webkit-box-shadow:none;box-shadow:none;-webkit-transition:none;transition:none}.ab_button.left{-webkit-border-radius:2px 0 0 2px;border-radius:2px 0 0 2px;border-right-color:transparent;margin-right:0}.ab_button.right{-webkit-border-radius:0 2px 2px 0;border-radius:0 2px 2px 0;margin-left:-1px}.kbtn-small{min-width:26px;width:26px}.ksb{background-color:#f5f5f5;background-image:-webkit-gradient(linear,left top,left bottom,from(#f5f5f5),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f5f5f5,#f1f1f1);background-image:linear-gradient(top,#f5f5f5,#f1f1f1);border:1px solid #dcdcdc;border:1px solid rgba(0,0,0,0.1);color:#444;}.ab_button{background-color:#f5f5f5;background-image:-webkit-gradient(linear,left top,left bottom,from(#f5f5f5),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f5f5f5,#f1f1f1);background-image:linear-gradient(top,#f5f5f5,#f1f1f1);border:1px solid #dcdcdc;border:1px solid rgba(0,0,0,0.1);color:#444;}a.ksb,.div.ksb{color:#444;text-decoration:none;cursor:default}a.ab_button{color:#444;text-decoration:none;cursor:default}.cpbb:hover,.kpbb:hover,.kprb:hover,.kpgb:hover,.kpgrb:hover,.ksb:hover{-webkit-box-shadow:0 1px 1px rgba(0,0,0,0.1);box-shadow:0 1px 1px rgba(0,0,0,0.1);-webkit-transition:all 0.0s;transition:all 0.0s}.ab_button:hover{-webkit-box-shadow:0 1px 1px rgba(0,0,0,0.1);box-shadow:0 1px 1px rgba(0,0,0,0.1);-webkit-transition:all 0.0s;transition:all 0.0s}.ksb:hover{background-color:#f8f8f8;background-image:-webkit-gradient(linear,left top,left bottom,from(#f8f8f8),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f8f8f8,#f1f1f1);background-image:linear-gradient(top,#f8f8f8,#f1f1f1);border:1px solid #c6c6c6;color:#222;}.ab_button:hover{background-color:#f8f8f8;background-image:-webkit-gradient(linear,left top,left bottom,from(#f8f8f8),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f8f8f8,#f1f1f1);background-image:linear-gradient(top,#f8f8f8,#f1f1f1);border:1px solid #c6c6c6;color:#222;}.ksb:active{background-color:#f6f6f6;background-image:-webkit-gradient(linear,left top,left bottom,from(#f6f6f6),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f6f6f6,#f1f1f1);background-image:linear-gradient(top,#f6f6f6,#f1f1f1);-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);}.ksb.sbm{height:20px;line-height:18px;min-width:35px}.ksb.sbf{height:21px;line-height:21px;min-width:35px}.ksb.left{-webkit-border-radius:2px 0 0 2px}.ksb.mid{-webkit-border-radius:0;margin-left:-1px}.ksb.right{-webkit-border-radius:0 2px 2px 0;margin-left:-1px}#sbfrm_l{visibility:inherit !important}#rcnt{margin-top:0px;}#appbar,#rhscol{min-width:1100px}#top_nav{min-width:1100px}#appbar{background:white;-webkit-box-sizing:border-box;width:100%}.ab_wrp{height:57px;border-bottom:1px solid #ebebeb}#main{width:100%}#ab_name,#ab_shopping{color:#dd4b39;font:20px "Arial";margin-left:15px;position:absolute;top:17px}#ab_name a{color:#999}#ab_shopping a{color:#dd4b39}#ab_ctls{float:right;position:relative;right:29px;z-index:3;line-height:1;padding-top:28px}.ab_ctl{display:inline-block;position:relative;margin-left:16px;}.ab_ctl.action-menu{margin-top:1px;vertical-align:middle}#hdtbSum .ab_ctl{vertical-align:baseline}a.ab_button,a.ab_button:visited{display:inline-block;color:#444;margin-top:1px}a.ab_button:hover{color:#222}#appbar a.ab_button:active,a.ab_button.selected,a.ab_button.selected:hover{color:#333}.ab_button:focus{outline:none}.ab_button.selected:focus{border-color:#ccc}.ab_button:hover>span.ab_icon{opacity:0.9}.ab_dropdown{background:#fff;border:1px solid #dcdcdc;border:1px solid rgba(0,0,0,0.2);font-size:13px;padding:6px 0;position:absolute;right:0;top:32px;white-space:nowrap;z-index:3;-webkit-transition:opacity 0.218s;transition:opacity 0.218s;-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);box-shadow:0 2px 4px rgba(0,0,0,0.2)}.ab_dropdown:focus,.ab_dropdownitem:focus,.ab_dropdownitem a:focus{outline:none}.ab_dropdownitem{margin:0;padding:0;-webkit-user-select:none}.ab_dropdownitem.selected{background-color:#eee}.ab_dropdownitem.checked{background-image:url(//ssl.gstatic.com/ui/v1/menu/checkmark.png);background-position:left center;background-repeat:no-repeat}.ab_dropdownitem.disabled{cursor:default;border:1px solid #f3f3f3;border:1px solid rgba(0,0,0,0.05);pointer-events:none}a.ab_dropdownitem.disabled{color:#b8b8b8}.ab_dropdownitem.active{-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}.ab_dropdownlnk,.ab_dropdownlnkinfo{display:block;padding:8px 20px 8px 16px}a.ab_dropdownlnk,a.ab_dropdownlnk:visited,a.ab_dropdownlnk:hover,#appbar a.ab_dropdownlnk:active{color:#333}a.ab_dropdownlnkinfo,a.ab_dropdownlnkinfo:visited,a.ab_dropdownlnkinfo:hover,#appbar a.ab_dropdownlnkinfo:active{color:#15c}.ab_dropdownchecklist{padding-left:30px}.ab_dropdownrule{border-top:1px solid #ebebeb;margin-bottom:10px;margin-top:9px}#top_nav{-webkit-user-select:none}.ksb.mini{margin-top:0px}.ab_tnav_wrp{height:33px}#hdtb-msb>.hdtb-mitem:first-child,.ab_tnav_wrp,#cnt #center_col,.mw #center_col{margin-left:150px}.mw #rhs{margin-left:820px}.mw #nyc{margin-left:651px}.klnav.klleft{margin-left:14px !important}.tbt{margin-left:8px;margin-bottom:28px}#tbpi.pt.pi{margin-top:-20px}#tbpi.pi{margin-top:0}.tbo #tbpi.pt,.tbo #tbpi{margin-top:-20px}#tbpi.pt{margin-top:8px}#tbpi{margin-top:0}#tbrt{margin-top:-20px}.tbos,.tbots,.tbotu{color:#dd4b39}.tbou>a.q,#tbpi,#tbtro,.tbt label,#set_location_section a{color:#222}.th{border:1px solid #ebebeb}#resultStats{line-height:33px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#resultStats{padding-left:16px;padding-top:0;padding-bottom:0;padding-right:8px}#subform_ctrl{margin-left:149px}.big #subform_ctrl{padding-right:2px;margin-left:229px}.mdm .mitem .kl{padding-left:28px}.big .mitem .kl{padding-left:44px}.mdm .msel .kls{padding-left:23px}.big .msel .kls{padding-left:39px}.obsmo .dp0,.dp1{display:none}.obsmo .dp1{display:inline}#obsmtc a,.rscontainer a{text-decoration:none}#obsmtc a:hover .ul,.rscontainer a:hover .ul{text-decoration:underline}.authorship_attr{white-space:nowrap}.currency input[type=text]{background-color:white;border:1px solid #d9d9d9;border-top:1px solid #c0c0c0;box-sizing:border-box;color:#333;display:inline-block;height:29px;line-height:27px;padding-left:8px;vertical-align:top;-webkit-border-radius:1px;-webkit-box-sizing:border-box}.currency input[type=text]:hover{border:1px solid #b9b9b9;border-top:1px solid #a0a0a0;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1)}.currency input[type=text]:focus{border:1px solid #4d90fe;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);outline:none;-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3)}body.vasq #hdtbSum{height:58px}body.vasq #hdtb-msb .hdtb-mitem.hdtb-msel{height:15px;line-height:15px;padding:28px 16px 12px}#hdtb-msb .hdtb-mitem.hdtb-imb{height:15px;line-height:15px;padding-top:28px}body.vasq .ab_tnav_wrp{height:43px}body.vasq #topabar.vasqHeight{margin-top:-44px !important}body.vasq #resultStats{line-height:43px}body.vasq .hdtb-mn-o,body.vasq .hdtb-mn-c{top:38px}.ellip{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}</style><style>@-webkit-keyframes qs-timer {0%{}}</style>'
			TMPFeedOUT += '<style>.y,.yp,.yf,.yi,.yl,.ye{}.z1asCe{display:inline-block;fill:currentColor;height:24px;line-height:24px;position:relative;width:24px}.z1asCe svg{display:block;height:100%;width:100%}.iUh30{font-size:14px;padding-top:1px;line-height:1.43;}.hJND5c,.slp{display:block;}.f,.f a:link{color:#777}.a,cite,cite a:link,cite a:visited,.cite,.cite:link,#nygTcd>i,.bc a:link{color:#006621;font-style:normal}a.fl:link,.fl a,.flt,a.flt,.gl a:link,a.mblink,.mblink b{color:#1a0dab}.r a.fl{font-size:14px}#resultStats{color:#777}.osl{margin-top:0px}#ires .hJND5c{height:18px;line-height:16px}#rcnt a:hover,.brs a:hover,#nycp a:hover,#nav a.pn:hover{text-decoration:underline}#rcnt .ab_dropdownitem a:hover,#rcnt [role=button]:hover,#rcnt .kno-fb-ctx>a:hover,#nycp a.ab_button:hover,#rcnt a.kpbb:hover,#rcnt a.a-no-hover-decoration:hover,.brs a.a-no-hover-decoration:hover,#nycp a.a-no-hover-decoration:hover,#nav a.pn.a-no-hover-decoration:hover{text-decoration:none}.dPAwzb,.dPAwzb a{font-size:12px;line-height:1.33;}#lb{z-index:1001;position:absolute;top:-1000px}.rc{position:relative;}a:hover h3{text-decoration:underline}.r{font-size:small}.r{line-height:1.54}.gl:visited{color:#666}.rc .s{line-height:1.54;}.srg .g:last-of-type{margin-bottom:28px}.khgTR{border-bottom:1px solid #ebebeb;display:block;line-height:22px;margin:0px -16px 9px -16px;padding:0 16px 11px 16px}.khgTR .f.hJND5c{margin-top:0px}.khgTR.QEhTP{border-bottom:none;margin-bottom:0;padding-bottom:0}.khgTR.lWEpfd{border-bottom:none;margin-bottom:0;padding-bottom:0}.uZfOAb{clear:both;padding-top:6px}.jtDWfd{margin-left:-10px;margin-right:-10px}.gpeho{margin-left:-10px;margin-right:-10px;padding:12px 0 5px}.tTfzVd{padding-top:9px}.pb0Ufd{border-radius:4px;border:1px solid rgba(0,0,0,0.12);font-size:14px;line-height:16px;margin-left:10px;padding:7px 8px;display:inline-block;text-align:center}.pb0Ufd:last-child{margin-right:24px}#hdtb{color:#666;font-size:13px;border-bottom:1px solid #ebebeb;margin-top:-21px;outline-width:0;outline:none;position:relative;z-index:102}#hdtb.hdtba{border-bottom:none}.hdtb-mitem a,#hdtb-more-mn a{padding:0 16px;color:#777;text-decoration:none;display:block}.hdtb-mitem a{margin:0 8px;padding:0 8px}.hdtbItm label:hover,.hdtbItm a:hover,#hdtb-more-mn a:hover,#hdtb .hdtb-mitem a:hover,.hdtb-mn-hd:hover,#hdtb-more:hover,#hdtb-tls:hover{color:#222}#hdtb.notl a,#hdtb.notl div,#hdtb.notl li{outline-width:0;outline:none}#hdtb .hdtb-mitem a:active,#hdtb-more:active,.hdtb-mn-hd:active{color:#1A73E8}.hdtb-dd-mn a,.hdtb-dd-mn a:visited,.hdtb-dd-mn a:active{color:inherit;display:block;text-decoration:none}.hdtb-mitem a.hdtb-dd-b{padding-bottom:8px;padding-top:8px}#hdtb-more-mn a:hover,.hdtbItm.hdtbSel:hover,.hdtbItm a:hover,#cdrlnk:hover{background-color:#f1f1f1}.hdtbItm.hdtbSel,#hdtb .hdtbItm a,#hdtb-more-mn a,#cdrlnk{color:#777;text-decoration:none;padding:6px 44px 6px 30px;line-height:17px;display:block}.hdtb-mitem a{display:inline-block}#hdtb-more-mn a{display:block;padding:6px 16px;margin:0}#hdtb-more-mn{min-width:120px}#hdtbMenus{background-color:transparent;top:0;width:100%;height:22px;position:absolute;transition:top 220ms ease-in-out;-webkit-transition:top 220ms ease-in-out;}.hdtb-td-h{display:none}#hdtbMenus.hdtb-td-o{top:58px;padding-top:3px;padding-bottom:7px;top:0}body.vasq #hdtbMenus.hdtb-td-o{top:68px}#hdtb.hdtba #hdtbMenus{top:21px}body.vasq #hdtb.hdtba #hdtbMenus.hdtb-td-o{top:58px}#hdtb.hdtba #hdtbMenus{background-color:#fafafa;border-bottom:1px solid #ebebeb;padding:7px 0px}#botabar{-webkit-transition:margin-top 220ms ease-in-out;transition:margin-top 220ms ease-in-out}#hdtbMenus.hdtb-td-c{}#hdtbSum{background:#fff;height:58px;padding:0;position:relative;z-index:102}.hdtb-mn-o,.hdtb-mn-c{background:#fff;border:1px solid #d6d6d6;box-shadow:0 2px 4px rgba(0,0,0,.16);box-shadow:0 2px 4px rgba(0,0,0,.16);color:#333;position:absolute;z-index:103;line-height:17px;padding-top:5px;padding-bottom:5px;top:36px}.hdtb-mn-c{display:none}#hdtb-msb{float:left;position:relative;white-space:nowrap;align-items:baseline;display:flex;-ms-flex-pack:justify;justify-content:space-between;min-width:782px}#hdtb-msb-vis{display:inline}#hdtb-msb .hdtb-mitem{display:inline-block}#hdtb-more-mn .hdtb-mitem{display:block}#hdtb-msb .hdtb-mitem:first-child.hdtb-imb{margin-left:150px}#hdtb-msb .hdtb-mitem:first-child.hdtb-msel{margin-left:154px}#hdtb-msb .hdtb-mitem.hdtb-msel{border-bottom:3px solid #1A73E8;color:#1A73E8;font-weight:bold;}#hdtb.hdtba #hdtb-msb .hdtb-mitem.hdtb-msel{border-bottom:none}#hdtb-msb .hdtb-mitem.hdtb-msel:hover{cursor:pointer}#hdtb-msb .hdtb-mitem.hdtb-msel:active{background:none}#hdtb .hdtb-mitem a{color:#777}#hdtb-msb #hdtb-more,#hdtb-msb #hdtb-tls{color:#777}#hdtb-tls{text-decoration:none}#hdtb-more{display:inline-block;padding:0 16px;position:relative;-webkit-tap-highlight-color:rgba(255,255,255,0)}#hdtb-more:hover{cursor:pointer}.hdtb-mitem .micon,#hdtbMenus .lnsep{display:none}.hdtb-mitem .mcolor{display:inline-block;width:40px;height:10px;margin-left:-13px;margin-right:-13px}#hdtb-msb .hdtb-mitem.hdtb-imb.mlinesep{width:0px;margin-left:8px;margin-right:8px;padding:0px;border-left:1px solid rgba(0,0,0,.12)}.mn-hd-txt{display:inline-block;padding-right:6px;white-space:nowrap}.mn-dwn-arw{border-color:#777 transparent;border-style:solid;border-width:5px 4px 0 4px;width:0;height:0;margin-left:-2px;top:50%;margin-top:-2px;position:absolute}.hdtb-mn-hd:hover .mn-dwn-arw,#hdtb-more:hover .mn-dwn-arw{border-color:#222 transparent}.hdtb-mn-hd:active .mn-dwn-arw,#hdtb-more:active .mn-dwn-arw{border-color:#1A73E8 transparent}.hdtb-tl{border:1px solid transparent;display:inline-block;text-align:center;border-radius:2px;line-height:19px;cursor:pointer;margin-left:-1px;padding:4px 19px}#hdtb-msb .hdtb-tl-sel,#hdtb-msb .hdtb-tl-sel:hover{background:-webkit-linear-gradient(top,#eee,#e0e0e0);-webkit-box-shadow:inset 0 1px 2px 0 rgba(0,0,0,0.1);border:1px solid #d7d7d7;box-shadow:inset 0 1px 2px 0 rgba(0,0,0,0.1);}#hdtb #hdtb-tls:active{color:#000}.mn-hd-txt>.simg_thmb{display:none}.tmlo #hdtbSum,.tmlo #hdtbMenus,.tmhi #hdtbSum,.tmhi #hdtbMenus{padding-left:0}.mn-hd-txt .mn-col{width:14px;height:14px;border:1px solid #ccc;display:inline-block;margin-top:7px}#isz_lt.hdtbSel{padding-right:0;padding-left:30px}#hdtb-tls:hover{-webkit-box-shadow:0 1px 1px rgba(0,0,0,0.1);box-shadow:0 1px 1px rgba(0,0,0,0.1);-webkit-transition:all 0.0s;transition:all 0.0s}#hdtb-tls:hover{background-color:#f8f8f8;background-image:-webkit-gradient(linear,left top,left bottom,from(#f8f8f8),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f8f8f8,#f1f1f1);background-image:linear-gradient(top,#f8f8f8,#f1f1f1);border:1px solid #c6c6c6;color:#222;}#hdtb-tls:active{background-color:#f6f6f6;background-image:-webkit-gradient(linear,left top,left bottom,from(#f6f6f6),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f6f6f6,#f1f1f1);background-image:linear-gradient(top,#f6f6f6,#f1f1f1);-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);}.action-menu,.action-menu-item,.action-menu-panel,.selected{}.GHDvEf,.GHDvEf:hover,.GHDvEf.selected,.GHDvEf.selected:hover{background-color:white;background-image:none;border:0;border-radius:0;box-shadow:0 0 0 0;cursor:pointer;filter:none;height:12px;min-width:0;padding:0;transition:none;-webkit-user-select:none;width:13px}.action-menu .mn-dwn-arw{border-color:#006621 transparent;margin-top:-4px;margin-left:3px;left:0;}.action-menu:hover .mn-dwn-arw{border-color:#00591E transparent}.action-menu{display:inline;margin:0 3px;position:relative;-webkit-user-select:none}.action-menu-panel{left:0;padding:0;right:auto;top:12px;visibility:hidden}.action-menu-item{cursor:pointer;-webkit-user-select:none}.action-menu-item:hover{background-color:#eee}.action-menu-item a.fl{color:#333;display:block;padding:7px 18px;text-decoration:none;outline:0}.qB8Uve{display:block;line-height:20px;position:relative;white-space:nowrap}.lP8Inb{padding-right:0;white-space:normal}.J6AsYb{left:0;position:absolute;top:0}.mJ9kob{display:inline-block}.sbuwl{color:#222;overflow:hidden;text-overflow:ellipsis}.P1usbc{display:table;margin:5px 0;line-height:1.54;color:#777;}.G1Rrjc{display:table-cell;padding-left:15px;vertical-align:baseline}.i4vd5e{display:table-cell}.VNLkW{display:table-row;vertical-align:top}.h7mcFf{color:#999}.TXwUJf{color:#777}.PcHvNb{position:absolute}.N3nEGc{background-color:#fff;float:left;overflow:hidden;margin-top:4px;position:relative}.wEQKyf.N3nEGc{float:right;margin:7px 0 5px 12px}.Ixi80c{margin-top:0px}.i0PvJb{background-color:#000}.S59Brf{background:#F2F2F2}.mWTy7c{border-top-left-radius:2px;bottom:0;font-size:11px;font-weight:bold;padding:1px 3px;position:absolute;right:0;text-align:right;text-decoration:none;background-color:rgba(0,0,0,.7);color:#fff}.bc{}.TbwUpd a.fl{font-size:14px}.TbwUpd.rLwn0d{overflow:hidden;text-overflow:ellipsis}.TbwUpd{display:inline-block}.TbwUpd{line-height:1.54}.H89pHb{margin-right:6px}.st sup{line-height:0.9}.mOd06 em{font-weight:bold !important}.GXZmWe{background-color:rgba(0,0,0,0.07);border-width:0;color:rgba(0,0,0,0.07);height:1px}.GXZmWe{margin:28px -8px 28px -8px}.z69Mae{border-width:0;height:1px;margin:0 -8px 5px -8px}.tqS43.GXZmWe{margin-top:34px}.hdtbU{top:-500px;white-space:nowrap}.hdtbU .hdtbItm,.hdtbU li{list-style:none outside none}#hdtb form{display:inline}.hdtbSel,.hdtbSel span.q{color:#000;cursor:default;padding-right:15px;text-decoration:none}#cdr_opt{background-image:none;background:#fff;padding:0 !important}.cdr_sep{border-top:1px solid #ebebeb;height:0;margin:5px 0;width:100%}#cdrlnk{cursor:pointer}.hdtbItm{background:#fff}.hdtbSel,.hdtbSel #cdrlnk{background-image:url(//ssl.gstatic.com/ui/v1/menu/checkmark2.png);background-position:left center;background-repeat:no-repeat}.vk_h{}.vk_c a{text-decoration:none}.vk_gn{color:#3d9400 !important}.vk_rd{color:#dd4b39 !important}.vk_dgy{color:#545454 !important}.vk_gy{color:#878787 !important}.vk_lgy{color:#bababa !important}.vk_blgy{border-color:#bababa}.vk_bk{color:#212121 !important}.vk_fl a{color:#878787}.vk_fl a:hover{color:#1a0dab}.dDoNo{font-weight:lighter !important;margin-bottom:5px}.dDoNo{font-size:xx-large !important}.dDoNo.vk_long{font-size:20px !important}.vk_h{font-weight:lighter !important}.vk_h{font-size:x-large !important}.vk_sh,.vk_hs,.vk_med{font-weight:lighter !important}.vk_sh{font-size:medium !important}.Uekwlc{font-weight:lighter !important}.Uekwlc{font-size:13px}.p13zmc{font-weight:lighter !important}.vk_cdns{font-size:13px !important}.cYvRhe{font-weight:bold !important}.vk_c,.vk_cxp,#rhs .fIcnad{border:1px solid #dfe1e5;border-radius:8px;box-shadow:none;box-shadow:none}#rhs .fIcnad{border:none;margin-left:2px}.vk_c,.vk_cxp{background-color:#fff;position:relative}.vkc_np{margin-left:-16px;margin-right:-16px}.WIDPrb,.ts .WIDPrb{padding-left:16px}.iiFzhd,.ts .iiFzhd{padding-right:16px}.vk_pt,.ts .vk_pt{padding-top:20px}.QiLuMc{padding-bottom:20px}.vk_c,.vk_cxp{margin-left:-8px;margin-right:-35px}.vk_c,.vk_cxp{margin-left:-20px;margin-right:-20px}.vk_c,.vk_cxp,.vk_ic{padding:20px 16px 24px 16px}.vk_c .vk_c,.vk_c .vk_cxp{border-radius:0;box-shadow:none;background-color:transparent;border:0;box-shadow:none;margin:0;padding:0;position:static}.vk_cxp{padding-top:30px;padding-bottom:34px}.vk_c_cxp{margin-top:10px;margin-bottom:10px}.vk_gbb{border-bottom:1px solid #eee}.vk_gbr{border-right:1px solid #eee}.vk_gbt{border-top:1px solid #eee}.vk_cf{margin:0 -16px 0 -16px;padding:16px 16px 16px 16px}.vk_cf a,.vk_cf a:link,a.vk_cf,a.vk_cf:link{color:#878787}.vk_cf a:hover,a.vk_cf:hover{color:#1a0dab}.vk_slic{display:inline-block;margin-top:-3px;margin-right:16px;position:relative;height:24px;width:24px;vertical-align:middle}.vk_sli,.vk_slih{border:none;position:absolute;top:0;left:0;height:24px;width:24px}a:hover .vk_sli,.vk_slih{display:none}a:hover .vk_slih,.vk_sli{display:inline-block}.vk_spc{height:16px;width:100%}.vk_ra{transform:rotate(90deg)}.vk_arc{border-top:1px solid #ebebeb;cursor:pointer;height:0px;margin-bottom:-19px;overflow:hidden;padding:20px 0;text-align:center}.vk_ard{top:-11px}.vk_aru{bottom:-6px}.vk_ard,.vk_aru{background-color:#e5e5e5;margin-left:auto;margin-right:auto;position:relative}.vk_ard,.vk_aru{height:6px;width:64px}.vk_ard:after,.vk_ard:before,.vk_aru:after,.vk_aru:before{content:\' \';height:0;left:0;position:absolute;width:0}.vk_ard:after,.vk_ard:before,.vk_aru:after,.vk_aru:before{border-left:32px solid rgba(229,229,229,0);border-right:32px solid rgba(229,229,229,0)}.vk_ard:before{border-top:16px solid #e5e5e5;top:6px}.vk_aru:before{border-bottom:16px solid #e5e5e5;bottom:6px}.vk_ard:after{top:0}.vk_ard:after{border-top:16px solid #fff}.vk_aru:after{bottom:0}.vk_aru:after{border-bottom:16px solid #fff}.vk_bk.vk_ard,.vk_bk.vk_aru{background-color:#212121}.vk_bk.vk_ard:before{border-top-color:#212121}.vk_bk.vk_aru:before{border-bottom-color:#212121}.di8g3{font-size:11px !important;padding:6px 8px}#center_col .di8g3{margin:0 -35px 0 -8px;padding:6px 20px 0}#rhs .di8g3{margin-left:2px;padding-bottom:5px;padding-top:5px}.di8g3,.di8g3 a{color:#878787 !important;text-decoration:none}.di8g3 a:hover{text-decoration:underline}.hntNk.vk_c{padding-top:24px;padding-bottom:20px}.hntNk .dDoNo{margin-bottom:0;word-wrap:break-word}.hntNk .vk_gy{margin-bottom:5px}.pVFdhc{background-color:#ebebeb;height:1px}.vk_tbl{border-collapse:collapse}.vk_tbl td{padding:0}.xpdclps,.xpdxpnd{overflow:hidden}.xpdclps,.xpdxpnd{-webkit-transition:max-height 0.3s}.xpdxpnd,.xpdopen .xpdclps,.xpdopen .xpdxpnd.xpdnoxpnd{max-height:0}.xpdopen .xpdxpnd{max-height:none}.xpdopen .xpdbox .xpdxpnd,.xpdopen .xpdbox.xpdopen .xpdclps{max-height:0}.xpdopen .xpdbox.xpdopen .xpdxpnd,.xpdopen .xpdbox .xpdclps{max-height:none}.xpdclose .k5nfEc,.xpdopen .f9jNFb{display:none}.kno-ecr-pt{}.kno-ecr-pt{color:rgba(0,0,0,.87);line-height:1.2;margin-bottom:-3px;overflow:hidden;font-family:arial,sans-serif-light,sans-serif;display:inline;font-size:30px;font-weight:normal;position:relative;transform-origin:left top;transform-origin:left top;word-wrap:break-word}.GqKvT .kno-ecr-pt{color:#fff}.shop__a{text-decoration:none}.shop__a{color:#1a0dab}.shop__a:active{color:#1a0dab}.shop__clear{clear:both}.shop__secondary,.shop__secondary:link,.shop__secondary:visited{color:#666}a.shop__secondary,.shop__a.shop__secondary{text-decoration:none}.shop__a:hover{cursor:pointer;text-decoration:underline}a.shop__secondary:hover,.shop__a.shop__secondary:hover{text-decoration:underline}.bNg8Rb{clip:rect(1px,1px,1px,1px);height:1px;margin:0;overflow:hidden;padding:0;position:absolute;white-space:nowrap;width:1px;z-index:-1000}</style>'
			TMPFeedOUT += '<style>.wrap div {width: 600px;}'
			TMPFeedOUT += '.brs_col i{margin-right:7px;margin-left:0px}'
			TMPFeedOUT += '.brs_col i{background-color:#fff;border-radius:3px;color:#545454;display:inline-block;font-size:11px;border:1px solid #545454;padding:1px 3px 0 2px;line-height:11px;vertical-align:baseline}'
			TMPFeedOUT += '</style>'

			TMPFeedOUT += "</head><body>\n";

			TMPFeedOUT += "<div id='435267332345'><br><b>Loading data... Please wait !</b><br><br><br></div>\n";


			if (OneSiteConfig['title'])
				TMPFeedOUT += OneSiteConfig['title'] + "<br><br>\n";

			TMPFeedOUT += OneSiteConfig['SITE'] + "<br>\n";
			TMPFeedOUT += OneFeedConfig.ext + "<br><br>\n";


			TMPFeedOUT += "<div class='wrap'>\n";



			TMPFeedOUT += "<script>\n";



//FeedConfig[i][j]['GAShtmlForfeed'] = [FeedConfig[i][j]['GASearch']['GAShtmlAd'], FeedConfig[i][j]['GASearch']['GAShtmlComment'], FeedConfig[i][j]['GASearch']['GAShtmlExt'], parsed_url['hostname'] + '/']
			TMPFeedOUT += " var arrayGAShtml = " + JSON.stringify(OneFeedConfig.GAShtmlForfeed) + "\n";

//не должно быть в генерируемом тексте ad ads
//нельзя передавать keys - служебное слово
//передаются данные   
//arrayGA[i][ii].url
//arrayGA[i][ii].data
//arrayGA[i][ii].data[GASAId].Headlines сформированная строка с разделителем ' | '
//arrayGA[i][ii].data[GASAId].Paths сформированная строка с разделителем '/'
//arrayGA[i][ii].data[GASAId].Descriptions сформированная строка с разделителем ' ' (надо отслеживать [.!] в конце предыдущей строки и ставить . если нет)
//arrayGA[i][ii].keywrds = '<i>KEY1</i><i>KEY2</i>...'

			TMPFeedOUT += " var arrayGA = []\n";

//нужно делать ПС перед операторами и закрывающими кавычками, в подробностях не разбирался

//нужно повторять все символы, в т.ч. невидимые квадратики! например преобразовал квадратик с помощью Encoder.htmlEncode,  получил -  &lrm;

//первый перебор - это массив собранных кусков фидов
			var TMPFeedOUTend = "var nums=0;\n";
			TMPFeedOUTend += "for (var i=0; i < arrayGA.length; i++) {\n";

			TMPFeedOUTend += "if (!arrayGA[i]) continue;\n";

//второй перебор - это уже массив значений из массива собранных кусков фидов
			TMPFeedOUTend += "for (var ii=0; ii < arrayGA[i].length; ii++) {\n"

			TMPFeedOUTend += "document.write('<hr><div><ol>')\n";

			TMPFeedOUTend += "for (var GASAId in arrayGA[i][ii].data) {\n";

			TMPFeedOUTend += 'document.write(\'<li class="renattw"><div><a href="\' + arrayGA[i][ii].url + \'"><h3 class="sA5rQ">\' + arrayGA[i][ii].data[GASAId].Headlines + \'&lrm;</h3><br><div class="useyer"><span class="Z98Wse">\')' + "\n"

			TMPFeedOUTend += 'document.write(arrayGAShtml[0] + \'</span><cite class="UdQCqe" style="max-width:453px">\' + arrayGAShtml[3] + arrayGA[i][ii].data[GASAId].Paths + \'</cite>&lrm;</div></a></div><div>\' + arrayGA[i][ii].data[GASAId].Descriptions + arrayGAShtml[2] + \'</div></li>\')' + "\n"

			TMPFeedOUTend += "}\n"

			TMPFeedOUTend += 'document.write(\'</ol></div><div class="brs" data-hveid="CAcQAA"><div class="U7izfe"><h3 class="dPAwzb">\' + arrayGAShtml[1] + \'</h3></div><div class="brs_col">\' + arrayGA[i][ii].keywrds + \'</div></div>\')' + "\n"

//			TMPFeedOUTend += 'document.write(\'<hr>\');' + "\n"

			TMPFeedOUTend += "nums++\n"
			TMPFeedOUTend += "console.log('write ' + nums + ' Item')\n"
			TMPFeedOUTend += "}\n"
			TMPFeedOUTend += "}\n"
			TMPFeedOUTend += 'document.write(\'<hr>\')' + "\n"
			TMPFeedOUTend += "document.write('<br><br>Writed ' + nums + ' Items<br><br>')\n";


			TMPFeedOUTend += "var div = document.getElementById('435267332345');div.style.visibility = 'hidden';div.style.display = 'none';\n";


			TMPFeedOUTend += "</script>\n";
			TMPFeedOUTend += "</div>\n";


			TMPFeedOUTend += "</body></html>";

			return TMPFeedOUT + FeedOUT + TMPFeedOUTend;


		},
		'.ga.xml': function(feed_file_ext,OneSiteConfig,OneFeedConfig,FeedOUT) {

			var TMPFeedOUT = '<?xml version="1.0"?>' + "\n";
			TMPFeedOUT += '<rss xmlns:g="http://base.google.com/ns/1.0" version="2.0">' + "\n";
			TMPFeedOUT += "\t<channel>\n";

			if (OneSiteConfig['title'])
				TMPFeedOUT += "\t\t<title>" + OneSiteConfig['title'] + "</title>\n";

			TMPFeedOUT += "\t\t<link>" + OneSiteConfig['SITE'] + "</link>\n";

			if (OneSiteConfig['description'])
				TMPFeedOUT += "\t\t<description>" + OneSiteConfig['description'] + "</description>\n";


			var TMPFeedOUTend = "\t</channel>\n";

			TMPFeedOUTend += '</rss>' + "\n";

			return TMPFeedOUT + FeedOUT + TMPFeedOUTend;


		},
		'.ga.txt': function(feed_file_ext,OneSiteConfig,OneFeedConfig,FeedOUT) {

			var feed_fields_file_types = OneFeedConfig.feed_fields_file_types;
			var position_NUM = 0;
			var header_OUT = '';

			for (var feed_field_name in feed_fields_file_types[feed_file_ext]) {
				if (position_NUM) {
					header_OUT += "\t" + feed_field_name;
				} else {
					header_OUT = feed_field_name;
				}
				position_NUM++;
			}

			return header_OUT + "\n" + FeedOUT;

		},
		'.ga.tsv': function(feed_file_ext,OneSiteConfig,OneFeedConfig,FeedOUT) {
//полностью идентично .ga.txt (возможно потребуется для динамического ремаркетинга)

			var feed_fields_file_types = OneFeedConfig.feed_fields_file_types;
			var position_NUM = 0;
			var header_OUT = '';

			for (var feed_field_name in feed_fields_file_types[feed_file_ext]) {
				if (position_NUM) {
					header_OUT += "\t" + feed_field_name;
				} else {
					header_OUT = feed_field_name;
				}
				position_NUM++;
			}

			return header_OUT + "\n" + FeedOUT;

		}
	}




/*

перебор файлов фидов (первый вариант) - используется для передачи по ftp и теперь для записи файлов фидов

						var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
						for (var feed_id in OneSiteConfig) {
							//перебираем разрешенные сейчас фиды сайта
							if (OneSiteConfig['feeds'][feed_id]) {
							//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
								if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
								//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта

									var OneFeedConfig = OneSiteConfig[feed_id];
									if (feedsAlreadyChecked.scanned.FeedsFilesOUT&&feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id]) {
										var OneFeedFilesOUT = feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id];
									} else {
										var OneFeedFilesOUT = {};
									}
									for (var feed_file_ext in OneFeedFilesOUT) {
									//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'
										if (OneFeedFilesOUT[feed_file_ext]) {


										}
									}
									if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT&&feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id]) {
									}
		
								}
							}
						}
*/


/*

еще один вариант, раньше использовался
						var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
						if (!feedsAlreadyChecked.scanned.FeedsFilesOUT) {
							feedsAlreadyChecked.scanned.FeedsFilesOUT = {};
						}	
						for (var feed_id in feedsAlreadyChecked.scanned.FeedsFilesOUT) {
							var OneFeedConfig = OneSiteConfig[feed_id];
							if (feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id]) {
								var OneFeedFilesOUT = feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id];
							} else {
								var OneFeedFilesOUT = {};
							}
							for (var feed_file_ext in OneFeedFilesOUT) {
							//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'
								if (OneFeedFilesOUT[feed_file_ext]) {

						        		try {
										var OUT_ext = correctfeedExtFunctions[feed_file_ext](feed_file_ext,OneSiteConfig,OneFeedConfig,OneFeedFilesOUT[feed_file_ext]);

//										FeedConfig[0][i][j]['feedId'] = FeedConfig[0][i]['Id'] + ".feed." + ext;
										var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + feed_file_ext;

										var FEEDfilenameid = filesfolder.getFilesByName(FEEDfilename);
										while (FEEDfilenameid.hasNext()) {
											var nfile = FEEDfilenameid.next();
											//filesfolder.removeFile(nfile);
											deleteOrRemoveFile(nfile)
										}
										checkSaveFile(filesfolder.createFile(FEEDfilename, OUT_ext), OUT_ext);

								
									} catch (e) {
										ScanCreateFeedsGlobalVars.errors += 'bad field_type: ' + feed_file_ext + " in correctfeedExtFunctions, check script code\n";
										Logger.log(ScanCreateFeedsGlobalVars.errors);
									}



								}
							}
							if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT&&feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id]) {
								...
							}

						}

*/



					if (!AdWordsApp.getExecutionInfo().isPreview()) {

//нужна задержка после записи tmpfilesfolder (сброса буфера) перед последующим чтением/записью
//нужна задержка после удаления файлов в filesfolder перед последующим чтением/записью
//возможен обрыв с таймаутом
Utilities.sleep(10000);

						//не читаем в режиме просмотра у нас есть одна копия за единственный проход (в feedsAlreadyChecked.scanned.FeedsFilesOUT)
						//которую мы не сбросили из буфера, оставили в режиме чтения

						//читаем директорию tmpfiles, находим сначала все файлы всего аккаунта
						var AllfilesHash = {};
						var filesfolderFiles = DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();
						var fileSiteId1 = IDName + '.';
						var fileSiteId1length = fileSiteId1.length;
						while (filesfolderFiles.hasNext()) {
							var nfile = filesfolderFiles.next();
							var FullFileName = nfile.getName();
							if (!FullFileName.indexOf(fileSiteId1)) { //если совпадает IDName с началом имени файла
							//if (FullFileName.substr(0, fileSiteId1length) == fileSiteId1) {
								if (!AllfilesHash[FullFileName])
									AllfilesHash[FullFileName] = nfile;
							}
						}
					}




						var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];

						//проверка, что не все фиды выдают пустые страницы
						if (!feedsAlreadyChecked.hasOwnProperty('AllScanEmptyError')) {
							feedsAlreadyChecked['AllScanEmptyError'] = 0;
							var parsecriticalerrorsnum = 0
							var nums = 0
							for (var i in feedsAlreadyChecked['CURfeedsIds']) {
								var OneFeedConfig = OneSiteConfig[i];
								if (OneFeedConfig['No_Critical_Errors'] != 1)
									nums++;
								if (!feedsAlreadyChecked.scanned.parced_urls[i]) {
									if (OneFeedConfig['No_Critical_Errors'] != 1)
										parsecriticalerrorsnum++;
								}
							}

							//если все фиды сайта выдают ошибку, то нужно ее отправить, даже если указано у всех не отправлять
							//не может создаваться конфиг сайта, в котором нет страниц товаров
							//if ((parsecriticalerrorsnum == nums)&&(Object.keys(feedsAlreadyChecked['ALLfeedsIds']).length == Object.keys(feedsAlreadyChecked['CURfeedsIds']).length)) {
							//теперь отправлять если все фиды скана, а не сайта выдают ошибку (иначе можно пропустить ошибку, если сканы сайта в разное время)
							if (nums&&(parsecriticalerrorsnum == nums)) {
								feedsAlreadyChecked['AllScanEmptyError'] = 1;
							}
						}


//						var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
						for (var feed_id in OneSiteConfig) {
							//перебираем разрешенные сейчас фиды сайта
							if (OneSiteConfig['feeds'][feed_id]) {
							//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
								if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
								//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта


									//Id фидов обратного типа запуска, которые появились в конфиге перед завершением (то есть для режима выполнения обратный с 'test' в timeHours, для режима просмотра обратный без 'test' в timeHours)
									if (AnotherModeFeedsIds[feed_id]) {
										continue;
									}

									//в процессе выполнения мы могли добавить pausedFeeds, то есть без перескана, поэтому не пишем их результаты
									if (OneSiteConfig['pausedFeedsIds'][feed_id]) {
										continue;
									}


									var OneFeedConfig = OneSiteConfig[feed_id];
									if (feedsAlreadyChecked.scanned.FeedsFilesOUT&&feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id]) {
										//var OneFeedFilesOUT = feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id];
										var OneFeedFilesOUT = JSON.parse(JSON.stringify(feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id]));
									} else {
										var OneFeedFilesOUT = {};
									}


									if ((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError']))) {
										//если пустой файл, то нужно писать все равно его
										for (var feed_file_ext in OneFeedConfig.feed_fields_file_types) {
											if (!OneFeedFilesOUT.hasOwnProperty(feed_file_ext)) {
												OneFeedFilesOUT[feed_file_ext]='';
											}
										}
									}

									for (var feed_file_ext in OneFeedFilesOUT) {
									//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'



//										FeedConfig[0][i][j]['feedId'] = FeedConfig[0][i]['Id'] + ".feed." + ext;
										var MAINFEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + feed_file_ext;


										//проверяем, может был абр во время записи фидов и какой-то фид уже записался частично или полностью
										//а выше мы уже удалили и больше не удаляем текущие файлы фидов
										//поэтому надо удалить - не удаляем, лишняя задержка, запишется еще один файл, потом при повторном скане удалится




										if (!AdWordsApp.getExecutionInfo().isPreview()) {


											var OUT_ext = '';
											for (var st = 1; st <= feedsAlreadyChecked.scanned.steps; st++) {
												var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + '.' + st + feed_file_ext;
												if (AllfilesHash[FEEDfilename]) {
													OUT_ext += AllfilesHash[FEEDfilename].getBlob().getDataAsString();
												//закомментировано - могут быть пропуски (отсутствующие части)
												//} else {
												//	ScanCreateFeedsGlobalVars.errors += 'not fount part: ' + st + " of feed " + MAINFEEDfilename + "\n";
												//	Logger.log(ScanCreateFeedsGlobalVars.errors);
												}
											}



											//проверяем наличие данных фида (значит сформировался фид или фид должен быть записан, в т.ч. пустой (типа останов кампаний))
											if (OUT_ext||((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError'])))) {

									        		try {
													OUT_ext = correctfeedExtFunctions[feed_file_ext](feed_file_ext,OneSiteConfig,OneFeedConfig,OUT_ext);

													var FEEDfilenameid = filesfolder.getFilesByName(MAINFEEDfilename);
													while (FEEDfilenameid.hasNext()) {
														var nfile = FEEDfilenameid.next();
														//filesfolder.removeFile(nfile);
														deleteOrRemoveFile(nfile)
													}
													checkSaveFile(filesfolder.createFile(MAINFEEDfilename, OUT_ext), OUT_ext);

													feedsAlreadyChecked.scanned.FeedsFilesExistNames[MAINFEEDfilename] = 1;

								
												} catch (e) {
													ScanCreateFeedsGlobalVars.errors += 'bad field_type: ' + feed_file_ext + " in correctfeedExtFunctions, check script code\n";
													Logger.log(ScanCreateFeedsGlobalVars.errors);
												}

												//обнуляем переменную фида для уменьшения размера памяти
												OUT_ext = '';

											}

										} else {

											var OUT_ext = '';


											if (OneFeedFilesOUT[feed_file_ext]||((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError'])))) {

									        		try {

													//фид будет записан, в т.ч. пустой (типа останов кампаний)
			
													OUT_ext = correctfeedExtFunctions[feed_file_ext](feed_file_ext,OneSiteConfig,OneFeedConfig,OneFeedFilesOUT[feed_file_ext]);

													var FEEDfilenameid = filesfolder.getFilesByName(MAINFEEDfilename);
													while (FEEDfilenameid.hasNext()) {
														var nfile = FEEDfilenameid.next();
														//filesfolder.removeFile(nfile);
														deleteOrRemoveFile(nfile)
													}
													checkSaveFile(filesfolder.createFile(MAINFEEDfilename, OUT_ext), OUT_ext);

													feedsAlreadyChecked.scanned.FeedsFilesExistNames[MAINFEEDfilename] = 1;

								
												} catch (e) {
													ScanCreateFeedsGlobalVars.errors += 'bad field_type: ' + feed_file_ext + " in correctfeedExtFunctions, check script code\n";
													Logger.log(ScanCreateFeedsGlobalVars.errors);
												}


												//обнуляем переменную фида для уменьшения размера памяти
												OUT_ext = '';


											}


										}



									}


									var checkedOK = 0;
									if ((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError']))) {
										//если пустой файл, то нужно писать все равно его
										if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['GAShtml'])
											checkedOK = 1;
									} else {
										if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT&&feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id])
											checkedOK = 1;
									}


									if (checkedOK) {


										var feed_file_ext = '.gas.html'



										var MAINFEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + feed_file_ext;


										if (!AdWordsApp.getExecutionInfo().isPreview()) {

											var OUT_ext = '';
											for (var st = 1; st <= feedsAlreadyChecked.scanned.steps; st++) {
												var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + '.' + st + feed_file_ext;
												if (AllfilesHash[FEEDfilename]) {
													//читаем массив хешей в текстовом виде
													OUT_ext += 'arrayGA[' + (st-1) + ']='+ AllfilesHash[FEEDfilename].getBlob().getDataAsString() + "\n";
												//закомментировано - могут быть пропуски (отсутствующие части)
												//} else {
												//	ScanCreateFeedsGlobalVars.errors += 'not fount part: ' + st + " of feed " + MAINFEEDfilename + "\n";
												//	Logger.log(ScanCreateFeedsGlobalVars.errors);
												}
											}



											//проверяем наличие данных фида (значит сформировался фид или фид должен быть записан, в т.ч. пустой (типа останов кампаний))
											if (OUT_ext||((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError'])))) {

									        		try {
													OUT_ext = correctfeedExtFunctions[feed_file_ext](feed_file_ext,OneSiteConfig,OneFeedConfig,OUT_ext);

													var FEEDfilenameid = filesfolder.getFilesByName(MAINFEEDfilename);
													while (FEEDfilenameid.hasNext()) {
														var nfile = FEEDfilenameid.next();
														//filesfolder.removeFile(nfile);
														deleteOrRemoveFile(nfile)
													}
													checkSaveFile(filesfolder.createFile(MAINFEEDfilename, OUT_ext), OUT_ext);


													feedsAlreadyChecked.scanned.FeedsFilesExistNames[MAINFEEDfilename] = 1;

								
												} catch (e) {
													ScanCreateFeedsGlobalVars.errors += 'bad field_type: ' + feed_file_ext + " in correctfeedExtFunctions, check script code\n";
													Logger.log(ScanCreateFeedsGlobalVars.errors);
												}

												//обнуляем переменную фида для уменьшения размера памяти
												OUT_ext = '';

											}

										} else {

											var OUT_ext = '';

								        		try {

												var sv = 0;

												if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT&&feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id]) {
													OUT_ext = correctfeedExtFunctions[feed_file_ext](feed_file_ext,OneSiteConfig,OneFeedConfig,'arrayGA[0]='+JSON.stringify(feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id]) + "\n");
													sv = 1;
												} else if ((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError']))) {
													//фид будет записан, в т.ч. пустой (типа останов кампаний)
													OUT_ext = correctfeedExtFunctions[feed_file_ext](feed_file_ext,OneSiteConfig,OneFeedConfig,'');
													sv = 1;
												}

												if (sv) {
													var FEEDfilenameid = filesfolder.getFilesByName(MAINFEEDfilename);
													while (FEEDfilenameid.hasNext()) {
														var nfile = FEEDfilenameid.next();
														//filesfolder.removeFile(nfile);
														deleteOrRemoveFile(nfile)
													}
													checkSaveFile(filesfolder.createFile(MAINFEEDfilename, OUT_ext), OUT_ext);

													feedsAlreadyChecked.scanned.FeedsFilesExistNames[MAINFEEDfilename] = 1;

												}

								
											} catch (e) {
												ScanCreateFeedsGlobalVars.errors += 'bad field_type: ' + feed_file_ext + " in correctfeedExtFunctions, check script code\n";
												Logger.log(ScanCreateFeedsGlobalVars.errors);
											}


											//обнуляем переменную фида для уменьшения размера памяти
											OUT_ext = '';

										}




									}

		
								}
							}
						}



					}


				} else {

					//удаляем метку абра, эта метка нужна для учета абра до записи базы групп РК поиска,
					//поэтому абры ниже (если появятся на фтп) нам не нужно учитывать, а база была уже записана раньше
					var labelRunScanName = SCRIPT_ID_NAME + '.SCANRUN';
					var CheckL = getLabel(labelRunScanName);
					//теоретически метка могла еще не появится в подпрограмме где нужно зафиксировать точку входа в генерацию групп РК, поэтому сначала проверяем наличие
					if (CheckL !== null) {
						//удаляем метку (пишем 2009 символов '-')
						setLabel(labelRunScanName, Array(2010).join('-'));
					}


					//удаляем все метки построения базы для поиска
//					if (feedsAlreadyChecked.scanned.steps < 2) { 
						var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + SCRIPT_ID_NAME.replace(/\'/gm, '\\\'') + ":SCANCADGRS:'").get();
						while (labels.hasNext()) {
							var label = labels.next();
							label.remove();
							label.remove();
						}
//					}


					//удаляем метку абра сбора групп в базы, если есть
//					if (feedsAlreadyChecked.scanned.steps < 2) { 
						var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
						var CheckL = getLabel(labelRunAttachLabelsName);
						if (CheckL !== null) {
							//удаляем метку (пишем 2009 символов '-')
							setLabel(labelRunAttachLabelsName, Array(2010).join('-'));
						}
//					}



				}


				var FTPerrors = '';
				//записывать ошибки только когда происходят изменения в ошибках, что бы не писать постоянно в папку files
				var saveFTPerrors = 0;

				//есть задания для выгрузки по фтп
				var saveFTPs = 0;

				var errorsbeforeFTP = 0;

				if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {
					//ошибки могут появится как раньше (в ScanCreateFeeds) так и на предыдущем шаге записи фидов


					//запись ошибок скана сайта


					if (!AdWordsApp.getExecutionInfo().isPreview()) {
						var scanresultFileErrorsReport = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.errorscan.txt';
						var scanresultFileErrorsReportid = filesfolder.getFilesByName(scanresultFileErrorsReport);
						while (scanresultFileErrorsReportid.hasNext()) {
							var nfile = scanresultFileErrorsReportid.next();
							//filesfolder.removeFile(nfile);
							deleteOrRemoveFile(nfile)
						}
						checkSaveFile(filesfolder.createFile(scanresultFileErrorsReport, ScanCreateFeedsGlobalVars.errors), ScanCreateFeedsGlobalVars.errors);
					}

					errorsbeforeFTP = 1;



				//} else {
				//ошибок нет и был скан (если скана не было пропускаем эьтот шаг)
				} else if (feedsAlreadyChecked.scanned.steps) {

					//никаких ошибок, значит здесь точно завершение работы скрипта


					if (!(feedsAlreadyChecked['ended']&&feedsAlreadyChecked['ended']['feeds_files_saved'])) {
	

						//пишем флаг, что все файлы фидов сохранены

						if (!feedsAlreadyChecked['ended'])
							feedsAlreadyChecked['ended']={};
						feedsAlreadyChecked['ended']['feeds_files_saved']=1;
						feedsAlreadyChecked['ended']['feeds_ftp']={};



						//не нужно сейчас записывать массив, если будет фтп отправка, то запишеться перед ней



					}





					//записываем ftp
					var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
					for (var feed_id in OneSiteConfig) {
						//перебираем разрешенные сейчас фиды сайта
						if (OneSiteConfig['feeds'][feed_id]) {
						//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
							if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
							//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта

								//Id фидов обратного типа запуска, которые появились в конфиге перед завершением (то есть для режима выполнения обратный с 'test' в timeHours, для режима просмотра обратный без 'test' в timeHours)
								if (AnotherModeFeedsIds[feed_id]) {
									continue;
								}

								//в процессе выполнения мы могли добавить pausedFeeds, то есть без перескана, поэтому не пишем их результаты
								if (OneSiteConfig['pausedFeedsIds'][feed_id]) {
									continue;
								}

								var OneFeedConfig = OneSiteConfig[feed_id];
								if (OneFeedConfig.hasOwnProperty('ftp')) {

									if (feedsAlreadyChecked.scanned.FeedsFilesOUT&&feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id]) {
										//var OneFeedFilesOUT = feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id];
										var OneFeedFilesOUT = JSON.parse(JSON.stringify(feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id]));
									} else {
										var OneFeedFilesOUT = {};
									}

									if ((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError']))) {
										//если пустой файл, то нужно писать все равно его
										for (var feed_file_ext in OneFeedConfig.feed_fields_file_types) {
											if (!OneFeedFilesOUT.hasOwnProperty(feed_file_ext)) {
												OneFeedFilesOUT[feed_file_ext]='';
											}
										}
									}

									var filesArr = [];
									var filesExistErr = '';
									for (var feed_file_ext in OneFeedFilesOUT) {
									//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'

										var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + feed_file_ext;

										if (feedsAlreadyChecked.scanned.FeedsFilesExistNames[FEEDfilename]) {
											var tmp = filesfolder.getFilesByName(FEEDfilename);
											if (tmp.hasNext()) {
												filesArr[filesArr.length] = tmp.next();
											} else {
//должен быть записан, но еще не появился файл
												filesExistErr += FEEDfilename + "\n";
											}
										}

/*

старая обработка

										//такая проверка неверна - для режима непревью (выполнения) в OneFeedFilesOUT[feed_file_ext] будет пусто после скидывания буфера
										//достаточно проверить наличие передаваемого файла
										//if (OneFeedFilesOUT[feed_file_ext]) {

											var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + feed_file_ext;
											var tmp = filesfolder.getFilesByName(FEEDfilename);
											if (tmp.hasNext()) {
												filesArr[filesArr.length] = tmp.next();
											}


										//}

*/



									}

									var checkedOK = 0;
									if ((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError']))) {
										//если пустой файл, то нужно писать все равно его
										if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['GAShtml'])
											checkedOK = 1;
									} else {
										if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT&&feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id])
											checkedOK = 1;
									}

									if (checkedOK) {
										var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + '.gas.html';
										if (feedsAlreadyChecked.scanned.FeedsFilesExistNames[FEEDfilename]) {
											var tmp = filesfolder.getFilesByName(FEEDfilename);
											if (tmp.hasNext()) {
												filesArr[filesArr.length] = tmp.next();
											} else {
//должен быть записан, но еще не появился файл
												filesExistErr += FEEDfilename + "\n";
											}
										}


/*
старая обработка
										var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + '.gas.html';
										var tmp = filesfolder.getFilesByName(FEEDfilename);
										if (tmp.hasNext()) {
											filesArr[filesArr.length] = tmp.next();
										}

*/
									}

									if (filesArr.length||filesExistErr) {

										saveFTPs = 1;

										var zipfilename = IDName + '.' + OneFeedConfig['feedId'] + '.zip';

										if (!feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]) {
											feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]={};
											feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendattempt']=1;
											feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendres'] = false;
										} else {
											feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendattempt']++;
										}
										if ((feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendattempt'] < 3)&&(feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendres'] === false)) {

											//так как дальше может быть обрыв-таймаут, сохраняем файл перед фтп-отправкой
											if (!AdWordsApp.getExecutionInfo().isPreview()) {
												//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
												writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);
											}

											if (filesExistErr) {


//нужна задержка после записи filesfolder перед последующим чтением
//возможен обрыв с таймаутом
Utilities.sleep(10000);

//повторяем контрольное чтение (то что выше), но теперь после задержки

												filesArr = [];
												filesExistErr = '';
												for (var feed_file_ext in OneFeedFilesOUT) {

													var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + feed_file_ext;
		
													if (feedsAlreadyChecked.scanned.FeedsFilesExistNames[FEEDfilename]) {
														var tmp = filesfolder.getFilesByName(FEEDfilename);
														if (tmp.hasNext()) {
															filesArr[filesArr.length] = tmp.next();
														} else {
//должен быть записан, но еще не появился файл
															filesExistErr += FEEDfilename + "\n";
														}
													}
												}



												var checkedOK = 0;
												if ((OneFeedConfig.Write_emptyFeed_File == 1)||((OneFeedConfig.Write_emptyFeed_File == 2)&&(!feedsAlreadyChecked['AllScanEmptyError']))) {
													//если пустой файл, то нужно писать все равно его
													if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['GAShtml'])
														checkedOK = 1;
												} else {
													if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT&&feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id])
														checkedOK = 1;
												}

												if (checkedOK) {
													var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + '.gas.html';
													if (feedsAlreadyChecked.scanned.FeedsFilesExistNames[FEEDfilename]) {
														var tmp = filesfolder.getFilesByName(FEEDfilename);
														if (tmp.hasNext()) {
															filesArr[filesArr.length] = tmp.next();
														} else {
//должен быть записан, но еще не появился файл
															filesExistErr += FEEDfilename + "\n";
														}
													}
												}



											}





											if (filesExistErr) {

//файлы не готовы, пропускаем эту попытку записи (но считаем ее как попытку, что бы не зациклилось завершение скана)
//записываем это как таймаут ftp (хотя так не совсем корректно, но это скорее вопрос философский),
//и высылаем еще ошибку файловую для отслеживания как дальше скрипт отработает
												var ftpres = false;

	//из-за задержки записи файлов иногда появляется ошибка в sendftp
	//может так получится ее обнаружить

	//откорректированный кусок кода из sendftp
	var blobs = [];
	var names = [];
	var names2 = [];
	for (var i = 0; i < filesArr.length; i++) {
		var fname = filesArr[i].getName();
		names[i] = fname;
		//только разрешенные пропускаем и не пропускаем остальных
		var match = fname.match(/((?:\.(?:ga|yml|yrl|ycar|ya))?\.(?:[\w]+))$/i);
		if (match && match[1]) {
			var ext = match[1].toLowerCase();
			if (OneFeedConfig['ftp']['files_types'].indexOf(ext) == -1)
				continue;
		} else {
			continue;
		}
		var bnum = blobs.length;
		blobs[blobs.length] = filesArr[i].getBlob().getDataAsString().length;
		names2[bnum] = fname;
	}

	var ftplogerr = IDName + ' ftp error for ' + zipfilename + ', filesArr.length=' + filesArr.length + ', filesArr=' + JSON.stringify(filesArr) + ', names=' + JSON.stringify(names) + ', names2=' + JSON.stringify(names2) + ', blobs=' + JSON.stringify(blobs) + "\n\nNo exist Files:\n" + filesExistErr;

	//Logger.log(ftplogerr)


	var Today = getcurrentTime();
	var todayString = ('0' + Today.getDate()).slice(-2) + '.' + ('0' + (Today.getMonth() + 1)).slice(-2);
		
	var LastDateCriticlaErrCheck = getLabel('LastcrUnknFtpErr');

	var subject = "Критические ошибки (неизвестная ошибка при фтп-отправке) в аккаунте Adwords " + IDName;

	var criticalerrors = subject + "\n" + ftplogerr;
	
	//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
	if ((LastDateCriticlaErrCheck != todayString)&&UNKNOWN_ERROR_SEND_FTP) {
		if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
			MailApp.sendEmail(criticalsupportemail, subject, criticalerrors);
		}
	}

	Logger.log(criticalerrors)
        
	if (LastDateCriticlaErrCheck != todayString)
		setLabel('LastcrUnknFtpErr', todayString);




											} else {
												//первая попытка - это возможно фтп-передача файла(ов) вместе с другими операциями, вторая попытка - это точно все 30 минут попытки передать, поэтому третья попытка уже точно не нужна
												//может быть таймаут выполнения скрипта на передаче файлов по фтп
												var ftpres = sendftp(filesArr, OneFeedConfig['ftp'], zipfilename, IDName);
											}

											feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendres'] = ftpres;
											if (ftpres === false) {
												didExitEarlyFTP = true;
											}
											if (ftpres !== true) {
												saveFTPerrors = 1;
											}



										} else if ((feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendattempt'] == 3)&&(feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendres'] === false)) {
											saveFTPerrors = 1;
										}

										if (typeof feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendres'] == 'string') {
											FTPerrors += OneFeedConfig['feedId'] + ' ' + feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendres'] + "\n";
										} else if (feedsAlreadyChecked['ended']['feeds_ftp'][zipfilename]['sendres'] === false) {
											FTPerrors += OneFeedConfig['feedId'] + ' ' + 'Script Timeout' + "\n";
										}


									}
								}
	
							}
						}
					}



				}


				if (!errorsbeforeFTP) {

					if (FTPerrors&&saveFTPerrors) {

						//запись ошибок ftp

						if (!AdWordsApp.getExecutionInfo().isPreview()) {

							var scanresultFileErrorsReport = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.ftperrors.txt';
							var scanresultFileErrorsReportid = filesfolder.getFilesByName(scanresultFileErrorsReport);
							while (scanresultFileErrorsReportid.hasNext()) {
								var nfile = scanresultFileErrorsReportid.next();
								//filesfolder.removeFile(nfile);
								deleteOrRemoveFile(nfile)
							}
							checkSaveFile(filesfolder.createFile(scanresultFileErrorsReport, FTPerrors), FTPerrors);
						}

						Logger.log("\nFTP errors: \n" + FTPerrors + "\n for " + IDName);

					} else if (!FTPerrors) {

						//удаление ошибок ftp (если были записи таймаутов, но уже нет)


						if (saveFTPs) {
							Logger.log("\nAll FTP jobs ended without errors for " + IDName + "\n\n");
						}


						if (!AdWordsApp.getExecutionInfo().isPreview()) {
							var scanresultFileErrorsReport = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.ftperrors.txt';
							var scanresultFileErrorsReportid = filesfolder.getFilesByName(scanresultFileErrorsReport);
							while (scanresultFileErrorsReportid.hasNext()) {
								var nfile = scanresultFileErrorsReportid.next();
								//filesfolder.removeFile(nfile);
								deleteOrRemoveFile(nfile)
							}
						}

					}

				}


				if ((!didExitEarly)&&(!didExitEarlyFTP)) {

					if (!AdWordsApp.getExecutionInfo().isPreview()) {

						//записываем отчет по результату сканирования отдельного сайта

						var scanresultFileReport = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.scanresult.txt';
						var scanresultFileReportid = filesfolder.getFilesByName(scanresultFileReport);
						while (scanresultFileReportid.hasNext()) {
							var nfile = scanresultFileReportid.next();
							//filesfolder.removeFile(nfile);
							deleteOrRemoveFile(nfile)
						}


						if (notwriteanyfeeds[0]) {
							var msg = "Some feeds may be not write: you change for this feeds config parameter timeHours to 'test' (before exit execute script)\n";
							feedsAlreadyChecked.scanned.report += msg;
							Logger.log(msg)
						}


						if (feedsAlreadyChecked.scanned && feedsAlreadyChecked.scanned.report) {
							var FileDataSave = feedsAlreadyChecked.scanned.report + "Current Scan Status: ended.\n";
							checkSaveFile(filesfolder.createFile(scanresultFileReport, FileDataSave), FileDataSave);
							Logger.log("Current Scan Status: ended.");
						}


					} else {
						if (notwriteanyfeeds[0]) {
							var msg = "Some feeds may be not write: you delete 'test' in parameter timeHours in config for this feeds (before exit preview script)\n";
							Logger.log(msg)
						}

					}
				}



				if ((!didExitEarlyFTP)||errorsbeforeFTP) {


					//removeRootFile(SITES_CHECKED_FILE_NAME)
					//removeRootFile(SITES_CHECKED_FILE_NAME,tmpfilesfolder)
					removeAllScanFiles(IDName,tmpfilesfolder)




					if (!AdWordsApp.getExecutionInfo().isPreview()) {

//это обработка ошибки, связанной с тем что удаление файлов removeFile присходит с задержкой, 
//а нам надо сразу после удаления (после рестарта в while) нужно выполнять операции чтения tmpfilesfolder с анализом отсутсвия файла (который еще не удалился через removeAllScanFiles)
//то есть надо учитывать, что файл может еще существовать (поэтому есть эта обработка unkwonw_abr в двух местах)
//хотя теперь внедрено в removeAllScanFiles решение, предотвращающее появление и обработку этой ошибки

//дебильная проверка (вроде может не удалить файл SITES_CHECKED_FILE_NAME и другие файлы при выполнении removeAllScanFiles(IDName,tmpfilesfolder))


						var badfiles = ''
						var filesfolderFiles = DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();
						var fileSiteId1 = IDName + '.';
						var fileSiteId1length = fileSiteId1.length;
						while (filesfolderFiles.hasNext()) {
							var nfile = filesfolderFiles.next();
							var FullFileName = nfile.getName();
							if (!FullFileName.indexOf(fileSiteId1)) { //если совпадает IDName с началом имени файла
							//if (FullFileName.substr(0, fileSiteId1length) == fileSiteId1) {
								badfiles += FullFileName + "\n";
							}
						}

						if (badfiles) {
							//такого не должно быть но может быть!! почему не понятно
	

							Logger.log('Error delete files in removeAllScanFiles !!!, message in script end, account ' + IDName)
							Logger.log('Found error file(s): ' + "\n" + badfiles + "\n" + 'account ' + IDName)

							//еще раз пытаемся удалить
							//removeAllScanFiles(IDName,tmpfilesfolder)


							//и перезаписываем для верности
							var feedsAlreadyChecked2 = {};

//при повторении проверяем наличие этой записи (контроль unkwonw_abr есть в двух местах)
							feedsAlreadyChecked2['unkwonw_abr'] = 1;

							feedsAlreadyChecked2['scannId'] = {};
							feedsAlreadyChecked2['scannId']['Id'] = feedsAlreadyChecked['scannId']['Id'];

							ScanCreateFeedsGlobalVars['unkwonw_abr'] = {};
							ScanCreateFeedsGlobalVars['unkwonw_abr']['Id'] = feedsAlreadyChecked['scannId']['Id'];


							writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked2, tmpfilesfolder);




							//метка критических ошибок отличается по названию от аналогичных меток в других местах

							var Today = getcurrentTime();
							var todayString = ('0' + Today.getDate()).slice(-2) + '.' + ('0' + (Today.getMonth() + 1)).slice(-2);
		
							var LastDateCriticlaErrCheck = getLabel('LastcrUnknEndErr');

							var subject = "Критические ошибки (неизвестная ошибка в конце скана) в аккаунте Adwords " + IDName;

							var criticalerrors = subject;
	
							//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
							if ((LastDateCriticlaErrCheck != todayString)&&UNKNOWN_ERROR_SEND) {
								if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
									MailApp.sendEmail(criticalsupportemail, subject, criticalerrors);
								}
							}

							Logger.log(criticalerrors)

							if (LastDateCriticlaErrCheck != todayString)
								setLabel('LastcrUnknEndErr', todayString);

						}

					}





					//всегда надо записывать этот блок, в т.ч. в режиме просмотра, иначе зациклится
					//либо выйти из цикла (break)
					//не надо писать, только если появился didExitEarly

					//начало блока перезаписи scanReport (сканы, у которых не нулевой date)
					//скан с ошибками тоже считается выполненным, иначе следующие за ним сканы никогда не выполняться (пока не исправим его ошибки), что некорректно


					var curtim = getcurrentTime();

					scanids[feedsAlreadyChecked['scannId']['Id']]['time'] = curtim.getTime();

					//взято из function getNewDate для вырезания часового пояса
					var timezone = /\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}\:?\d{2})?)\b\)?/g;
					scanids[feedsAlreadyChecked['scannId']['Id']]['date'] = curtim.toString().replace(timezone, '');



					//перезапись scanReport (сканы, у которых не нулевой date)
					scanReportPreview = rewriteScanReport(scanReport, filesfolder, scanids);


					//конец блока перезаписи scanReport



					//if (!AdWordsApp.getExecutionInfo().isPreview()) {
						//проверяем наличие нового конфига для замены после скана

						//var [reterr_new,FeedConfig_new,scanids_new,configChecksum_new,configChangeFLG_new,configfolder_new,ClearConfig_new,conferrors_new] = readFeedConfig(IDName,mainfolder,domainsfolder,filesfolder,1);
						var [reterr_new,FeedConfig_new,scanids_new,configChecksum_new,configChangeFLG_new,configfolder_new,ClearConfig_new,conferrors_new] = rateLimitExpBackoff(readFeedConfig, [IDName, mainfolder, domainsfolder, filesfolder, 1], backoffErrors);

						if (!reterr_new) {
							//файл есть, заменяем текущий



							var BACKUPconfFile = IDName + '.merchantfeed_old.txt';
							var NEWconfFile = IDName + '.merchantfeed_new.txt';
							var confFile = IDName + '.merchantfeed.txt';

							Logger.log("Good new config file: " + NEWconfFile + '. Rename it to file ' + confFile);


					if (!AdWordsApp.getExecutionInfo().isPreview()) {

							var BACKUPconfFileid = configfolder_new.getFilesByName(BACKUPconfFile);
							while (BACKUPconfFileid.hasNext()) {
								var BACKUPnfile = BACKUPconfFileid.next();
								//configfolder_new.removeFile(BACKUPnfile);
								deleteOrRemoveFile(BACKUPnfile)
							}


							var NEWconfFileid = configfolder_new.getFilesByName(NEWconfFile);
							if (NEWconfFileid.hasNext()) {
								var NEWnfile = NEWconfFileid.next();
								var fileData = NEWnfile.getBlob().getDataAsString();
								if (fileData) {
									var confFileid = configfolder_new.getFilesByName(confFile);
									if (confFileid.hasNext()) {
										var nfile = confFileid.next();
										//nfile.makeCopy(BACKUPconfFile);
								        	checkSaveFile(nfile.makeCopy(BACKUPconfFile), nfile.getBlob().getDataAsString());
										checkSaveFile(nfile.setContent(fileData),fileData);

										Logger.log("OwerWrited config file: " + confFile);

										while (confFileid.hasNext()) {
											var nfile = confFileid.next();
											//configfolder_new.removeFile(nfile);
											deleteOrRemoveFile(nfile)
										}
									} else {
										checkSaveFile(configfolder_new.createFile(confFile, fileData, "text/plain"), fileData)
										Logger.log("Writed new config file: " + confFile);
									}

								} else {
									Logger.log("No writed new config file: " + confFile + '. Remove empty file ' + NEWconfFile);
									var BACKUPconfFileid = configfolder_new.getFilesByName(BACKUPconfFile);
									while (BACKUPconfFileid.hasNext()) {
										var BACKUPnfile = BACKUPconfFileid.next();
										//configfolder_new.removeFile(BACKUPnfile);
										deleteOrRemoveFile(BACKUPnfile)
									}

								}
								//configfolder_new.removeFile(NEWnfile);
								deleteOrRemoveFile(NEWnfile);
								while (NEWconfFileid.hasNext()) {
									var NEWnfile = NEWconfFileid.next();
									//configfolder_new.removeFile(NEWnfile);
									deleteOrRemoveFile(NEWnfile)
								}

							}

					}


						} else if (reterr_new == 1) {
							//у файла ошибка, переименовываем


							var NEWconfFile = IDName + '.merchantfeed_new.txt';
							var confFile = IDName + '.merchantfeed_newbad.txt';

							Logger.log("Errors in new config file: " + NEWconfFile + '. Rename it to file ' + confFile);

					if (!AdWordsApp.getExecutionInfo().isPreview()) {


							var NEWconfFileid = configfolder_new.getFilesByName(NEWconfFile);
							if (NEWconfFileid.hasNext()) {
								var NEWnfile = NEWconfFileid.next();
								var fileData = NEWnfile.getBlob().getDataAsString();
								if (fileData) {
									var confFileid = configfolder_new.getFilesByName(confFile);
									if (confFileid.hasNext()) {
										var nfile = confFileid.next();

										//сохраняем также ошибку
										var FileDataSave = '/*' + "\n" + conferrors_new + "\n" + '*/' + "\n" + fileData;
										checkSaveFile(nfile.setContent(FileDataSave),FileDataSave);

										Logger.log("OwerWrited bad config file: " + confFile);

										while (confFileid.hasNext()) {
											var nfile = confFileid.next();
											//configfolder_new.removeFile(nfile);
											deleteOrRemoveFile(nfile)
										}
									} else {
										//сохраняем также ошибку
										var FileDataSave = '/*' + "\n" + conferrors_new + "\n" + '*/' + "\n" + fileData;
										checkSaveFile(configfolder_new.createFile(confFile, FileDataSave, "text/plain"), FileDataSave);
										Logger.log("Writed bad config file: " + confFile);
									}

								} else {
									Logger.log("No writed bad config file: " + confFile + '. Remove empty file ' + NEWconfFile);
								}
								//configfolder_new.removeFile(NEWnfile);
								deleteOrRemoveFile(NEWnfile)
								while (NEWconfFileid.hasNext()) {
									var NEWnfile = NEWconfFileid.next();
									//configfolder_new.removeFile(NEWnfile);
									deleteOrRemoveFile(NEWnfile)
								}

							}


					}


							//метка критических ошибок отличается по названию от аналогичных меток в других местах

							var Today = getcurrentTime();
							var todayString = ('0' + Today.getDate()).slice(-2) + '.' + ('0' + (Today.getMonth() + 1)).slice(-2);

							var LastDateCriticlaErrCheck = getLabel('LastcrNewConfErr');


							var subject = "Критические ошибки (ошибка при обновлении в новом файле конфигурации, обновление настроек не выполнено) в аккаунте Adwords " + IDName;

							var criticalerrors = subject + "\n" + conferrors_new + "\n" + confFile + "\n";

							if (!AdWordsApp.getExecutionInfo().isPreview()) {
								//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
								//здесь не нужно удалять
								//письмо отсылается один раз по определению, поэтому не отслеживаем отправку один раз в день
								//if (LastDateCriticlaErrCheck != todayString) {
									if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
										MailApp.sendEmail(criticalsupportemail, subject, criticalerrors);
									}
								//}
							}
							Logger.log(criticalerrors)

							if (LastDateCriticlaErrCheck != todayString)
								setLabel('LastcrNewConfErr', todayString);




						

						} //reterr_new = 2 файла просто нет, ничего не делаем
					//}




					//if (!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)) {
					//если не было скана, то не может быть ошибок скана
					//не проверяем ошибки отсутствия фидов при наличии CONTROL_EMPTY_FEEDS
					if ((!CONTROL_EMPTY_FEEDS)&&(!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))&&feedsAlreadyChecked.scanned&&feedsAlreadyChecked.scanned.steps) {


						//метка критических ошибок отличается по названию от аналогичных меток в других местах


						var Today = getcurrentTime();
						var todayString = ('0' + Today.getDate()).slice(-2) + '.' + ('0' + (Today.getMonth() + 1)).slice(-2);

							var LastDateCriticlaErrCheck = getLabel('LastcrFErr');
								

							var criticalerrors = ''
							var parsecriticalerrors = ''
							var criticalerrors2 = ''
							var criticalerrors2num = 0
							var criticalerrors21num = 0
							var criticalerrors3 = ''
							var criticalerrors3num = 0
							var criticalerrors31num = 0
							var parsecriticalerrors2 = ''
							var parsecriticalerrorsnum = 0
							var nums = 0
							var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
							for (var i in feedsAlreadyChecked['CURfeedsIds']) {
								var OneFeedConfig = OneSiteConfig[i];
								if (OneFeedConfig['No_Critical_Errors'] != 1)
									nums++;
								if (!feedsAlreadyChecked.scanned.parced_urls[i]) {
									if (OneFeedConfig['No_Critical_Errors'] != 1) {
										parsecriticalerrorsnum++;
										if (OneFeedConfig['No_Critical_Errors'] == 2) {
//здесь отправляется ошибка только если окажется что все фиды пустые (ошибка парсинга)
											parsecriticalerrors2 += 'Not exist parsed items for feedId: ' + i + ', site Id:' + OneSiteConfig['Id'] + "\n";
										} else {
											parsecriticalerrors += 'Not exist parsed items for feedId: ' + i + ', site Id:' + OneSiteConfig['Id'] + "\n";
										}
									}
								} else if ((OneFeedConfig['No_Critical_Errors'] != 1)&&(OneFeedConfig['No_Critical_Errors'] != 2)) {
									if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {
										criticalerrors21num++;
										if (!feedsAlreadyChecked.scanned.GASearch_urls[i]) {
											criticalerrors2num++;
											if ((OneFeedConfig['No_Critical_Errors'] == 3)||(OneFeedConfig['No_Critical_Errors'] == 5)) {
//здесь не отправляется ошибка
												criticalerrors2 += 'Not exist items in GASearch for feedId: ' + i + ', site Id:' + OneSiteConfig['Id'] + "\n";
											} else {
												criticalerrors += 'Not exist items in GASearch for feedId: ' + i + ', site Id:' + OneSiteConfig['Id'] + "\n";
											}
										}
									}
									if (Object.keys(OneFeedConfig['feed_fields_file_types']).length||(OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['GAShtml'])) {
										criticalerrors31num++;
										if (!feedsAlreadyChecked.scanned.addfeed_urls[i]) {
											criticalerrors3num++;
											if ((OneFeedConfig['No_Critical_Errors'] == 3)||(OneFeedConfig['No_Critical_Errors'] == 4)) {
//здесь не отправляется ошибка
												criticalerrors3 += 'Not exist items for feedId: ' + i + ', site Id:' + OneSiteConfig['Id'] + "\n";
											} else {
												criticalerrors += 'Not exist items for feedId: ' + i + ', site Id:' + OneSiteConfig['Id'] + "\n";
											}
										}
									}
								}
							}




							//если все фиды сайта выдают ошибку, то нужно ее отправить, даже если указано у всех не отправлять
							//не может создаваться конфиг сайта, в котором нет страниц товаров
							//if ((parsecriticalerrorsnum == nums)&&(Object.keys(feedsAlreadyChecked['ALLfeedsIds']).length == Object.keys(feedsAlreadyChecked['CURfeedsIds']).length))
							//теперь отправлять если все фиды скана, а не сайта выдают ошибку (иначе можно пропустить ошибку, если сканы сайта в разное время)
							if (nums&&(parsecriticalerrorsnum == nums))
								parsecriticalerrors += parsecriticalerrors2;

/*

весьма спорная необходимость выдавать такую ошибку, если нет записей во всех фидах, где эти записи должны как бы быть
закомментировано, нужно придумать зачем это нужно)
прежде чем вдруг использовать, хорошо продумать логику - не проверялось на последних вариантах

							//если все фиды сайта выдают ошибку, то нужно ее отправить
							//не может создаваться конфиг сайта, в котором нет товаров фида или кампаний
							if ((criticalerrors2num == criticalerrors21num)&&(Object.keys(feedsAlreadyChecked['ALLfeedsIds']).length == Object.keys(feedsAlreadyChecked['CURfeedsIds']).length))
								criticalerrors += criticalerrors2;
							if ((criticalerrors3num == criticalerrors31num)&&(Object.keys(feedsAlreadyChecked['ALLfeedsIds']).length == Object.keys(feedsAlreadyChecked['CURfeedsIds']).length))
								criticalerrors += criticalerrors3;

*/

							var CURfeedsIds = Object.keys(feedsAlreadyChecked['CURfeedsIds']);


							if (!CURfeedsIds.length) {
								//информируем о пустом конфиге, хотя пустой конфиг не пропустится в самом начале (с ошибкой)
								Logger.log('Not found feeds for site Id:' + OneSiteConfig + ', Client ' + IDName)
							}


							if (parsecriticalerrors) {

								var subject = "Критические ошибки (не найдены страницы) при парсинге сайтов в аккаунте Adwords " + IDName;

								parsecriticalerrors = subject + "\n" + parsecriticalerrors + "\nChecked feedsNum: " + CURfeedsIds.length + "\nChecked feeds: " + CURfeedsIds.join(',');

								if (!AdWordsApp.getExecutionInfo().isPreview()) {
								//если нет ошибок и нет результата скана, но должен быть, отправляем письмо о критической ошибке
								//файлы удалены, но массив еще остался, поэтому данные есть
									//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
									if (LastDateCriticlaErrCheck != todayString) {
										if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
											MailApp.sendEmail(criticalsupportemail, subject, parsecriticalerrors);
										}
									}



								}
								Logger.log(parsecriticalerrors)
							}

							if (criticalerrors) {

								var subject = "Критические ошибки (не найдены товары) при создании фидов/кампаний в аккаунте Adwords " + IDName;

								criticalerrors = subject + "\n" + criticalerrors + "\nChecked feedsNum: " + CURfeedsIds.length + "\nChecked feeds: " + CURfeedsIds.join(',');

								if (!AdWordsApp.getExecutionInfo().isPreview()) {
								//если нет ошибок и нет результата скана, но должен быть, отправляем письмо о критической ошибке
								//файлы удалены, но массив еще остался, поэтому данные есть
									//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
									if (LastDateCriticlaErrCheck != todayString) {
										if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
											MailApp.sendEmail(criticalsupportemail, subject, criticalerrors);
										}
									}
								}
								Logger.log(criticalerrors)
							}

							if (parsecriticalerrors || criticalerrors) {
								if (LastDateCriticlaErrCheck != todayString)
									setLabel('LastcrFErr', todayString);
							}



					}



				}



				if (!((!didExitEarlyFTP)||errorsbeforeFTP)) {

					break;
				}



			} else {

				if (!AdWordsApp.getExecutionInfo().isPreview()) {

					if (!feedsAlreadyChecked['interimsave']) {
						//флаг дает понять при рестарте, что это промежуточный проход
						feedsAlreadyChecked['interimsave'] = 1;

					}

					//обязательно записать перед saveBufferFiles!!, иначе может быть зациклен повтор на обрыве в saveBufferFiles
					//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
					writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);

					var savebuf = saveBufferFiles(SITES_CHECKED_FILE_NAME,IDName,feedsAlreadyChecked,tmpfilesfolder);
					//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
					writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);
				}

				var labelRunScanName = SCRIPT_ID_NAME + '.SCANRUN';
				var CheckL = getLabel(labelRunScanName);
				//теоретически метка могла еще не появится в подпрограмме где нужно зафиксировать точку входа в генерацию групп РК, поэтому сначала проверяем наличие
				if (CheckL !== null) {
					//удаляем метку (пишем 2009 символов '-')
					setLabel(labelRunScanName, Array(2010).join('-'));
				}


				//удаляем все метки построения базы для поиска (нельзя удалять на проходе шага 0)
//				if (feedsAlreadyChecked.scanned.steps == 1) { 
				if (feedsAlreadyChecked.scanned.steps) { 
					var labels = AdWordsApp.labels().withCondition("Name STARTS_WITH '" + SCRIPT_ID_NAME.replace(/\'/gm, '\\\'') + ":SCANCADGRS:'").get();
					while (labels.hasNext()) {
						var label = labels.next();
						label.remove();
						label.remove();
					}
				}


				//удаляем метку абра сбора групп в базы, если есть
//				if (feedsAlreadyChecked.scanned.steps < 2) { 
					var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
					var CheckL = getLabel(labelRunAttachLabelsName);
					if (CheckL !== null) {
						//удаляем метку (пишем 2009 символов '-')
						setLabel(labelRunAttachLabelsName, Array(2010).join('-'));
					}
//				}



				if (!AdWordsApp.getExecutionInfo().isPreview()) {

					//записываем промежуточный отчет сканирования отдельного сайта

					var scanresultFileReport = IDName + '.' + feedsAlreadyChecked['scannId']['Id'] + '.interimresult.txt';
					var scanresultFileReportid = filesfolder.getFilesByName(scanresultFileReport);
					while (scanresultFileReportid.hasNext()) {
						var nfile = scanresultFileReportid.next();
						//filesfolder.removeFile(nfile);
						deleteOrRemoveFile(nfile)
					}

					if (feedsAlreadyChecked.scanned && feedsAlreadyChecked.scanned.report)
						checkSaveFile(filesfolder.createFile(scanresultFileReport, feedsAlreadyChecked.scanned.report), feedsAlreadyChecked.scanned.report);


				}



			}


		}




		//	SetnewKeys(CustomerName);




		//...исполняемый код скрипта (конец)

		//удаляем метку (пишем 2009 символов '-')
		setLabel(scriptName, Array(2010).join('-'));
		var endtime = getcurrentTime();
		JSONparsestringifyStopInit()
		return JSON.stringify({
			TimeZone: TimeZone,
			StartTime: starttime.toString(),
			EndTime: endtime.toString(),
			CustomerId: CustomerId,
			CustomerName: CustomerName,
			nowAccountFileName: nowAccountFileName
		});


	} catch (tryerr) {
		if (tryerr && tryerr.message && tryerr.stack) {
			var cerrmess = tryerr.name + ': ' + tryerr.message + ' ' + tryerr.stack.toString();
		} else {
			var cerrmess = tryerr.toString();
		}
		Logger.log("\n\nERROR: " + cerrmess + "\n\n");
		//удаляем метку (пишем 2009 символов '-')
		setLabel(scriptName, Array(2010).join('-'));
		return JSON.stringify({
			nowAccountFileName: nowAccountFileName,
			EndError: cerrmess
		});
	}


}


//https://stackoverflow.com/questions/16216868/get-back-a-string-representation-from-computedigestalgorithm-value-byte  
function md5(str) {
	return Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, str).reduce(function(str, chr) {
		chr = (chr < 0 ? chr + 256 : chr).toString(16);
		return str + (chr.length == 1 ? '0' : '') + chr;
	}, '');
}


function saveBufferFiles(SITES_CHECKED_FILE_NAME,IDName,feedsAlreadyChecked,tmpfilesfolder,no_force_delete) {

//устанавливаем флаг "не форсировать" только на старте, зачем:
//если оборвалась запись раньше, то скидываем буферные данные файлов фидов и обнуляем их значение в хеше
//если нет в буфере частей файлов фидов, то значит было уже сброшены буферы при выходе, поэтому не форсируем удаление частей


//скидываем буферные данные файлов фидов и обнуляем их значение в хеше feedsAlreadyChecked
//возвращаем 1 если произошло скидывание буфера в tmp-директорию

	var clearbuf = 0;


//каждые 30 сохраняем, что бы не зациклилось
	var savednum = 0;

	var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
if (feedsAlreadyChecked.scanned.FeedsFilesOUT) {
	for (var feed_id in feedsAlreadyChecked.scanned.FeedsFilesOUT) {
		var OneFeedConfig = OneSiteConfig[feed_id];
		if (feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id]) {
			var OneFeedFilesOUT = feedsAlreadyChecked.scanned.FeedsFilesOUT[feed_id];
		} else {
			var OneFeedFilesOUT = {};
		}
		for (var feed_file_ext in OneFeedFilesOUT) {
		//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'

//			FeedConfig[0][i][j]['feedId'] = FeedConfig[0][i]['Id'] + ".feed." + ext;
			var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + '.' + feedsAlreadyChecked.scanned.steps + feed_file_ext;

			if (!no_force_delete) {
				var FEEDfilenameid = tmpfilesfolder.getFilesByName(FEEDfilename);
				while (FEEDfilenameid.hasNext()) {
					var nfile = FEEDfilenameid.next();
					//tmpfilesfolder.removeFile(nfile);
					deleteOrRemoveFile(nfile)
				}
			}

			if (OneFeedFilesOUT[feed_file_ext]) {

				if (no_force_delete) {
					var FEEDfilenameid = tmpfilesfolder.getFilesByName(FEEDfilename);
					while (FEEDfilenameid.hasNext()) {
						var nfile = FEEDfilenameid.next();
						//tmpfilesfolder.removeFile(nfile);
						deleteOrRemoveFile(nfile)
					}
				}

				var OUT_ext = OneFeedFilesOUT[feed_file_ext];

				checkSaveFile(tmpfilesfolder.createFile(FEEDfilename, OUT_ext), OUT_ext);

				OneFeedFilesOUT[feed_file_ext] = '';
				clearbuf = 1;


				savednum++;

				if (parseInt(savednum/30)*30 == savednum) {
					//на каждом 30-том сохраняем (если много файлов, то не зациклится при повторном запуске)
					//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
					writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);
				}

			}
		}

	}

}

if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT) {
	for (var feed_id in feedsAlreadyChecked.scanned.SearchFeedsFilesOUT) {
		var OneFeedConfig = OneSiteConfig[feed_id];
		if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id]) {
			feed_file_ext = '.gas.html'


			var FEEDfilename = IDName + '.' + OneFeedConfig['feedId'] + '.' + feedsAlreadyChecked.scanned.steps + feed_file_ext;

			if (!no_force_delete) {
				var FEEDfilenameid = tmpfilesfolder.getFilesByName(FEEDfilename);
				while (FEEDfilenameid.hasNext()) {
					var nfile = FEEDfilenameid.next();
					//tmpfilesfolder.removeFile(nfile);
					deleteOrRemoveFile(nfile)
				}
			}

			if (feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id].length) {

				if (no_force_delete) {
					var FEEDfilenameid = tmpfilesfolder.getFilesByName(FEEDfilename);
					while (FEEDfilenameid.hasNext()) {
						var nfile = FEEDfilenameid.next();
						//tmpfilesfolder.removeFile(nfile);
						deleteOrRemoveFile(nfile)
					}
				}

				var file = checkSaveFile(tmpfilesfolder.createFile(FEEDfilename, ''), '');
				var FileDataSave = JSON.stringify(feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id]);
				checkSaveFile(file.setContent(FileDataSave),FileDataSave);


				feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[feed_id] = [];
				clearbuf = 1;

				savednum++;

				if (parseInt(savednum/30)*30 == savednum) {
					//на каждом 30-том сохраняем (если много файлов, то не зациклится при повторном запуске)
					//writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
					writeJSONFile(SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);
				}

			}

		}

	}
}


	return clearbuf;

}



function removeAllScanFiles(IDName,tmpfilesfolder) {
	//удаляем из дополнительной директории все файлы всех сканов аккаунта (хотя на самом деле мы всегда держим только один скан аккаунта на диске и в памяти)
	if (!AdWordsApp.getExecutionInfo().isPreview()) {

		//читаем директорию files, находим сначала все файлы всего аккаунта и все их удаляем
		var removeFilesArr = [];
		var filesfolderFiles = DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();
		var fileSiteId1 = IDName + '.';
		var fileSiteId1length = fileSiteId1.length;
		while (filesfolderFiles.hasNext()) {
			var nfile = filesfolderFiles.next();
			var FullFileName = nfile.getName();
			if (!FullFileName.indexOf(fileSiteId1)) { //если совпадает IDName с началом имени файла
			//if (FullFileName.substr(0, fileSiteId1length) == fileSiteId1) {
				//tmpfilesfolder.removeFile(nfile);
				removeFilesArr.push(nfile);
			}
		}
		for (var i = 0; i < removeFilesArr.length; i++) {
			var FullName = removeFilesArr[i].getName();
//проблема что через removeFile файл удаляется не сразу а через время, пробуем отправку в корзину
//оказалось setTrashed дает ошибку "Access denied: DriveApp" на каких-то файлах (removeFile всегда работает нормально, но дольше в 2 раза, поэтому только removeFile, но потом чистим "бесхозные" файлы другим скриптом)
			//removeFilesArr[i].setTrashed(true);
			//tmpfilesfolder.removeFile(removeFilesArr[i]);
			deleteOrRemoveFile(removeFilesArr[i])
			removeFilesArr[i] = FullName;
		}
		for (var i = 0; i < removeFilesArr.length; i++) {
//и добиваем вторым вариантом
			var files = tmpfilesfolder.getFilesByName(removeFilesArr[i]);
			while (files.hasNext()) {
				var nfile = files.next();
				//tmpfilesfolder.removeFile(nfile);
				deleteOrRemoveFile(nfile)
			}
		}


	}
}


function reportResults(responses) {


	var now2 = getcurrentTime();

	var allerr = '';

	scriptTypeReport(responses);

	if (allerr) {
		Logger.log('При выполнении скриптов возникли ошибки !!! (ищите в отчете слово Error)');
		if (!AdWordsApp.getExecutionInfo().isPreview()) {
			if ((typeof supportemail != 'undefined') && (supportemail)) {
				var subject = "В аккаунтах Adwords возникли ошибки, scriptID: " + SCRIPT_ID;
				MailApp.sendEmail(supportemail, subject, allerr + "\n\n" + now2);
			}
		}
	} else {
		Logger.log('Скрипт выполнен без ошибок');
	}




	function scriptTypeReport(responses) {


		for (var i = 0; i < responses.length; i++) {
			// Get the ExecutionResult for an account.
			var result = responses[i];

			var CustomerId = result.getCustomerId() + '';
			var resStatus = result.getStatus()


			// Check the execution status. This can be one of ERROR, OK, or TIMEOUT.
			if (resStatus == 'ERROR') {

				//сюда попадает в том числе Exceeded maximum execution time

				//сначала ищем файл, который принадлежит скрипту c ERROR (это час запуска reportResults или предыдущий)
				var AccountFileName = nowAccountFileName;
				//var accountsList = readJSONFile(AccountFileName);
				var accountsList = readJSONFile(AccountFileName, schedfilesfolder);
				if (!(accountsList && accountsList[CustomerId] && accountsList[CustomerId].MCCStart)) {
					var prGMTHour = nowGMTHour - 1;
					if (prGMTHour < 0) {
						prGMTHour = 23;
					}
					var AccountFileName = 'Optimizer-GMXMLAccountList-' + prGMTHour + '-' + SCRIPT_ID + '.json';
					//var accountsList = readJSONFile(AccountFileName);
					var accountsList = readJSONFile(AccountFileName, schedfilesfolder);
				}

				if (accountsList && accountsList[CustomerId] && (!accountsList[CustomerId].EndError)) {
					//функция scriptTypeReport может много раз вызываться, поэтому, надо не дублировать

					Logger.log(CustomerId + " scriptID: " + SCRIPT_ID + ' Error: ошибка при выполнении скрипта клиента: ' + result.getError());
					Logger.log('Обработка данных аккаунта ' + CustomerId + ' прекращена');
					allerr = allerr + "\n\n" + CustomerId + " scriptID: " + SCRIPT_ID + ' Error: ошибка при выполнении скрипта клиента: ' + result.getError() + "\n" + 'Обработка данных аккаунта ' + CustomerId + ' прекращена';

					accountsList[CustomerId].EndError = result.getError();
//только ошибки разрешаем писать тестовым скриптам
//другое не разрешаем, что бы случайно не попортить файл двойной и более записью
//хотя ошибки не запишуться, так как мы обычно не запускаем параллельно тест на уже работающем официально с фидами аккаунте
//крайне не желательно запускать параллельно, иначе могут просто запуститься одновременно несмотря на защиту (если разница 10 секунд например - проверено)
					if (!AdWordsApp.getExecutionInfo().isPreview()) {
						//writeJSONFile(AccountFileName, accountsList);
						writeJSONFile(AccountFileName, accountsList, schedfilesfolder);
					}
				}


			} else if (resStatus == 'OK') {
				if (!result.getReturnValue()) {
					continue;
				}
				//return; возвращает строку "undefined", а не undefined,  без такой проверки скрипт слетит с ошибкой "unexpected token u"
				//можно конечно проверить такой fix: var res = JSON.parse(result.getReturnValue(), :quirks_mode => true); но неизвестно как поведет себя в этом случае парсер на "нормальных" ответах после полного выполнения скрипта
				if (result.getReturnValue() == "undefined") {
					continue;
				}
				var res = JSON.parse(result.getReturnValue());
				////			var accountsList = readJSONFile(nowAccountFileName);//при переходе на след час возьмет данные след часа, что неверно
				//			var accountsList = readJSONFile(nowAccountFileName, schedfilesfolder);//при переходе на след час возьмет данные след часа, что неверно
				//var accountsList = readJSONFile(res.nowAccountFileName);
				var accountsList = readJSONFile(res.nowAccountFileName, schedfilesfolder);
				if (res.EndError) {
					//новый вариант обработки if (resStatus == 'ERROR'), теперь resStatus вообще не должно принимать значание 'ERROR')
					//сделано, что бы можно было передать ошибку при выполнении скрипта в файловый отчет

					if (accountsList && accountsList[CustomerId] && (!accountsList[CustomerId].EndError)) {
						//функция scriptTypeReport может много раз вызываться, поэтому, надо не дублировать

						Logger.log(CustomerId + " scriptID: " + SCRIPT_ID + ' Error: ошибка при выполнении скрипта клиента: ' + res.EndError);
						Logger.log('Обработка данных аккаунта ' + CustomerId + ' прекращена');
						allerr = allerr + "\n\n" + CustomerId + " scriptID: " + SCRIPT_ID + ' Error: ошибка при выполнении скрипта клиента: ' + res.EndError + "\n" + 'Обработка данных аккаунта ' + CustomerId + ' прекращена';

						accountsList[CustomerId].EndError = res.EndError;
//только ошибки разрешаем писать тестовым скриптам
//другое не разрешаем, что бы случайно не попортить файл двойной и более записью
//хотя ошибки не запишуться, так как мы обычно не запускаем параллельно тест на уже работающем официально с фидами аккаунте
//крайне не желательно запускать параллельно, иначе могут просто запуститься одновременно несмотря на защиту (если разница 10 секунд например - проверено)
						if (!AdWordsApp.getExecutionInfo().isPreview()) {
							////				writeJSONFile(nowAccountFileName,accountsList);//при переходе на след час возьмет данные след часа, что неверно
							//				writeJSONFile(nowAccountFileName,accountsList, schedfilesfolder);//при переходе на след час возьмет данные след часа, что неверно
							//writeJSONFile(res.nowAccountFileName, accountsList);
							writeJSONFile(res.nowAccountFileName, accountsList, schedfilesfolder);
						}
					}
					continue;
				}


				if (accountsList && accountsList[CustomerId] && (!accountsList[CustomerId].CheckedEnd)) {
					//функция scriptTypeReport может много раз вызываться, поэтому, надо не дублировать
					//запишется время старта и окончания в локальном времени аккаунта клиента (для оборвавшихся скриптов - останеться время старта в локальном времени аккаунта MCC)
					accountsList[CustomerId].TimeZone = res.TimeZone;
					accountsList[CustomerId].CheckedStart = res.StartTime;
					accountsList[CustomerId].CheckedEnd = res.EndTime;
					if ((!AdWordsApp.getExecutionInfo().isPreview())&&(!testing_ID)) {
						////				writeJSONFile(nowAccountFileName,accountsList);//при переходе на след час возьмет данные след часа, что неверно
						//				writeJSONFile(nowAccountFileName,accountsList, schedfilesfolder);//при переходе на след час возьмет данные след часа, что неверно
						//writeJSONFile(res.nowAccountFileName, accountsList);
						writeJSONFile(res.nowAccountFileName, accountsList, schedfilesfolder);
					}
				}

				//.... исполняемый код для подсчета итогов (начало)




				//.... исполняемый код для подсчета итогов (конец)



			} else {
				// Handle timeouts here.
				Logger.log(CustomerId + " scriptID: " + SCRIPT_ID + ' Error: превышен таймаут (30 минут) выполнения скрипта клиента');
				Logger.log('Обработка данных аккаунта ' + CustomerId + ' прекращена');
				allerr = allerr + "\n\n" + CustomerId + " scriptID: " + SCRIPT_ID + ' Error: превышен таймаут (30 минут) выполнения скрипта клиента' + "\n" + 'Обработка данных аккаунта ' + CustomerId + ' прекращена';
			}
		}

	}



}




function readScanReport(scanReport, filesfolder) {


	//читаем все предыдущие (последние) даты создания сканов сайтов
	var allscans = [];

	if (typeof filesfolder == 'string') {
//для режима просмотра читаем сформированную строку, а не из файла
		if (filesfolder)
			allscans = filesfolder.split(/[\r\n]+/);
	} else {
		var fileData = '';
		var fileIter = filesfolder.getFilesByName(scanReport);
		if (fileIter.hasNext()) {
			fileData = fileIter.next().getBlob().getDataAsString();
			allscans = fileData.split(/[\r\n]+/);
		}
	}




	//получаем предыдущий массив для перебора (нужно знать время последнего скана)
	var allscansTime = {};
	function read4 (string) { 
		var match = string.match(/^\s*([^\s]+)\s+([^\s]+)\s+([^\s]+)\s+([^\s].*)$/);
		if (match) {
      			return [match[1],match[2],match[3],match[4]]
		} else {
			return [undefined,undefined,undefined,undefined];
		}
	}
	for (var i = 0; i < allscans.length; i++) {
		//формат одной строки - id checksum priorityLev Date
		if (!allscans[i]) continue;
//виснет или некорректно работает AdWordsAPP при таком var [tmpid] = tmpid;
//		var [tmpid, tmpchecksum, tmppriorityLev, tmptime] = allscans[i].split(/[ ]+/, 4);
//должна быть функция с заданным кол-вом переменных в возвращаемом массиве
		var [tmpid, tmpchecksum, tmppriorityLev, tmptime] = read4(allscans[i]);

		//взято из function getNewDate для вырезания часового пояса
//		var timezone = /\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}\:?\d{2})?)\b\)?/g;
//		tmptime = String(tmptime).replace(timezone, '');

		var DateTime = new Date(tmptime);
		if (DateTime != 'Invalid Date') {
			DateTime = DateTime.getTime();
		} else {
			Logger.log(scanReport + ' have Invalid Date: new Date(' + tmptime + ')')
			DateTime = 0;
		}
		allscansTime[tmpid] = {
			Id: tmpid,
			checksum: tmpchecksum,
			priorityLev: tmppriorityLev,
			date: tmptime,
			time: DateTime
		};
	}


	return allscansTime;

}




function SORTscanids(scanids) {
	//пересканируем scanids с сортировкой Id в порядке возрастания IdNum time и priorityLev
	//в scanids должны присутствовать Id IdNum time и priorityLev, и ключ должен совпадать с Id

	//сортируем в порядке возрастания даты создания скана (точнее time) (от меньшей к большей) и с учетом priorityLev
	//получается - сначала все с максимальным приоритетом (0) в порядке от меньшего time к большему, потом ниже и ниже (и каждый приоритет в порядке time)
	//при одинаковом time сортируем в порядке нумерации (IdNum от меньшего к большему, такая последовательность в файле настроек) - это важно в самом начале, когда нет еще времени

	//для этого сначала добавляем совместный параметр (IdNum, time и priorityLev)
	var maxTime = 0;
	var maxIdNum = 0;
	for (var id in scanids) {
		//надо присваивать 0, иначе будет undefined, отсортирует undefined неправильно - поставит выше
		if (!scanids[id].time)
			scanids[id].time = 0;
		if (maxTime < scanids[id].time)
			maxTime = scanids[id].time;
		//на всякий случай, если нет параметра IdNum (хотя он должен быть всегда)
		if (!scanids[id].IdNum)
			scanids[id].IdNum = 0;
		if (maxIdNum < scanids[id].IdNum)
			maxIdNum = scanids[id].IdNum;
	}
//переводим в строку, дальше нужна только длина maxTime или maxIdNum, которая выдаст ошибку на числе
	maxTime = String(maxTime);
	maxIdNum = String(maxIdNum);

	//находим число цифр в максимальном time
	var maxTimenulstr = Array(maxTime.length + 1).join('0');
	//находим число цифр в максимальном IdNum
	var maxIdNumnulstr = Array(maxIdNum.length + 1).join('0');
	for (var id in scanids) {
		//слева направо: priorityLev time IdNum
		//добавляем конструкцию,типа   ('0' + '0123123123' + '5')*1 (то есть разрядность time береться по maxTime.length и слева добавляем priorityLev, точно также (по разрядности) справа добавляется IdNum)
		//получается - сначала все с максимальным приоритетом в порядке time, потом приоритет ниже и ниже (и каждый приоритет в порядке time)
		//при одинаковом time сортируем в порядке нумерации (IdNum от меньшего к большему, такая последовательность в файле настроек) - это важно в самом начале, когда нет еще времени
		scanids[id].time2 = (String(scanids[id].priorityLev) + (maxTimenulstr + scanids[id].time).slice(-maxTime.length) + (maxIdNumnulstr + scanids[id].IdNum).slice(-maxIdNum.length)) * 1;
	}



	//для сортировки сначала переводим в обычный массив
	var scanids2 = [];
	for (var id in scanids) {
		scanids2.push(scanids[id])
	}
	/*
		scanids2.sort(function(a,b) {
			if(a.time2 < b.time2) {
				return -1;
			} else if(a.time2 > b.time2) {
				return 1;
			} else {
				return 0;
			}
		});
	*/
	//более коротко sort:
	scanids2.sort(function(a, b) {
		return a.time2 - b.time2;
	});

	//перебор обычного массива scanids2 всегда сработает правильно (от меньшей к большей)
	//теперь у нас есть отсортированный по датам scanids2


	//возвращаем обратно в хеш
	//если id целочисленные, то перебор хеша сработает непредсказуемо!!! (нужно что бы были буквы в id !!!)
	//хотя вроде добавляем мы так как надо, но for (var i in scanids) сработает неверно на целых числах
	//https://learn.javascript.ru/object-for-in
	//поэтому проверяем Id на предмет целых чисел и добавляем буквы (это делается выше при проверке конфига)
	//УПС! Оказалось что в js гугла все работает правильно, без глюка, но все равно оставил добавление букв
	var scanids = {};
//полная переустановка (переприсваивание) объекта, поэтому передаваемый объект не изменится - https://metanit.com/web/javascript/3.7.php
//поэтому нужно передать измененный объект через: return scanids
	for (var i in scanids2) {
		scanids[scanids2[i]['Id']] = scanids2[i];
	}

	return scanids;

}






function readFeedConfig(IDName, mainfolder, domainsfolder, filesfolder, onlycheck) {
	//читаем и записываем конфиг фидов


	//читаем файл конфигурации и проверяем ошибки

	if (onlycheck) {
		//новый конфиг, только проверяем
		var confFile = IDName + '.merchantfeed_new.txt';
		var mapFile = '';
	} else {
		var confFile = IDName + '.merchantfeed.txt';
		var mapFile = IDName + '.feedsmap.txt';
	}

	var FeedConfig = readConfFile(confFile, mainfolder);
	var confFolderName = 'context_settings/' + confFile;
	var confFolderName2 = '/' + confFile;
	var confFolderName3 = '/' + confFile;
	var configFolder = mainfolder;

	if ((!FeedConfig[0]) && (FeedConfig[1] == 1)) {
		//если нет файла в основной папке, ищем в папке domains
		FeedConfig = readConfFile(confFile, domainsfolder);
		confFolderName = 'context_settings/callhunter/domains/' + confFile;
		confFolderName2 = "\n" + '/callhunter/domains/' + confFile;
		confFolderName3 += "\n" + '/callhunter/domains/' + confFile;
		configFolder = domainsfolder;
	}


	//получаем чистый конфиг для расчета контрольной суммы
	var ClearConfig = JSON.parse(JSON.stringify(FeedConfig[0]));

	var configChangeFLG = 0;
	var scanids = {};
	var configChecksum = false;
	var readRes = '';
	var CSVwarnings = '';


	if (onlycheck) {
		if ((!FeedConfig[0]) && (FeedConfig[1] == 1)) {
			//только для тестового конфига есть ошибка == 2 (нет файла при проверке наличия, что бы дальше не продолжать)
			//вместо отдельной проверки наличия файла проверяем прямо здесь
			return [2, FeedConfig[0], scanids, configChecksum, configChangeFLG, configFolder, ClearConfig, readRes];
		}
	}


	//карта ссылок фидов
	var mapurls = '';



	var reterr = 0;

	if (FeedConfig[1]) {
		//описание ошибки
		readRes = FeedConfig[2] + "\n" + confFolderName3;
		reterr = 1;
	} else {
		readRes = "Read Config File Ok" + "\n" + confFolderName2;
	}


	if ((!reterr) && (FeedConfig[1] || (!FeedConfig[0]) || (typeof FeedConfig[0] != 'object') || (!FeedConfig[0].length))) {
		//заодно проверили что это обычный массив (length) (хотя может быть дата)
		readRes += "\n" + "Config is empty";
		reterr = 1;
	}

	//https://learn.javascript.ru/class-instanceof - проверка типа массива ([object Array] и [object Object])
	//	var toString = {}.toString;


	if ((!reterr) && ({}.toString.call(FeedConfig[0]) !== '[object Array]')) {
		readRes += "\n" + "Config is not Array (first level)";
		reterr = 1;
	}


	//допустимые расширения файлов фидов
	var correctfeedExt = ['.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'];

	//получаем текущий массив перебора фидов
	var scansites = {};
	var zipnames = {};
	var searchADids = {};
	if (!reterr) {
		for (var i in FeedConfig[0]) {
			//настройки сканирования и парсинга одного сайта
			if ({}.toString.call(FeedConfig[0][i]) !== '[object Object]') {
				//должны быть только хеши у сайтов
				readRes += "\n" + "Config Array element number " + i + " is not Hash";
				reterr = 1;
				break;
			}

//этот фрагмент другой в скрипте тестового парсинга
if (FeedConfig[0][i]['soft_shutdown']) {
	CONTROL_EMPTY_FEEDS = 1;
}

			if ((!FeedConfig[0][i]['SITE']) || (typeof FeedConfig[0][i]['SITE'] != 'string')) {
				//должна быть ссылка у сайта
				readRes += "\n" + "Config Array element number " + i + " is not have parameter SITE";
				reterr = 1;
				break;
			}
			if (/\s/.test(FeedConfig[0][i]['SITE'])) {
				//не должно быть пробелов в ссылке
				readRes += "\n" + "Config Array element number " + i + " have space in parameter SITE";
				reterr = 1;
				break;
			}
			var parsed_url = parse_url(FeedConfig[0][i]['SITE']);
			if ((!parsed_url['hostname']) || (!parsed_url['protocol'])) {
				//должны быть protocol и hostname у сайта
				readRes += "\n" + "Config Array element number " + i + " is not have correct parameter SITE";
				reterr = 1;
				break;
			}

			//уже сделано в parse_url
			//parsed_url['hostname'] = parsed_url['hostname'].toLowerCase();


/*
не разрешено повторять сайты
могут возникнуть неучтенные коллизии URL ID (каждый скан одного сайта будет работать по разной схеме и пропустит часть дубликатов из другого скана)
	это произойдет так, как мы не храним базу URL ID между сканами
по этой же причине нужно хранить на время скана ID всех URL (точнее все уникальные ID),
а массив коллизии URL ID нужно хранить всегда (для заданного seed)

если же все же потом разрешим (если хранить базу URL), то в настройках Id скана:
если несколько сканов для одного сайта, то Id нельзя оставлять пустым (что бы не было дублирования Id)

*/
			if (!scansites.hasOwnProperty(parsed_url['hostname'])) {
				scansites[parsed_url['hostname']] = FeedConfig[0][i]['SITE'];
			} else {
				//не должны повторяться сайты
				readRes += "\n" + "Config Array element number " + i + " have dublicate hostname in parameter SITE";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}

			var seed = FeedConfig[0][i]['seed'];
			if (!seed) {
//				seed = 0;
				seed = undefined;
			} else if (isInteger(seed)) {
				seed = parseInt(seed);
			} else {
				//некорректный параметр seed
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter seed";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}
			FeedConfig[0][i]['seed'] = seed;




			var timeHoursHash = {};
			var timeHoursNotCorrect = 0;
			//не может быть в итоге пустой массив
			//если установлен test то не запускать никогда, кроме режима просмотра
			//если установлено в параметре пусто, 0 или нет параметра, то 0 часов
			if (!FeedConfig[0][i].hasOwnProperty('timeHours')) {
				var timeHours = ['0'];
			} else if (!FeedConfig[0][i]['timeHours']) {
				var timeHours = ['0'];
			} else if (typeof FeedConfig[0][i]['timeHours'] != 'string') {
				//некорректный параметер
				timeHoursNotCorrect = 1;
				var timeHours = [];
			} else if (FeedConfig[0][i]['timeHours'] === 'test') {
				//test
				var timeHours = ['test'];
			} else {
				var timeHours = FeedConfig[0][i]['timeHours'].split(/[\s\,]+/);
			}
			if (timeHoursNotCorrect) {
				//некорректный параметр timeHours
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter timeHours";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}
			for (var ii = 0; ii < timeHours.length; ii++) {
				if (isInteger(timeHours[ii])) {
					timeHours[ii] = parseInt(timeHours[ii]);
					timeHoursHash[timeHours[ii]] = 1;
					if ((timeHours[ii] < 0) || (timeHours[ii] > 23)) {
						//некорректный параметр timeHours
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter timeHours " + timeHours[ii];
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					}
				} else if ((timeHours[ii] == 'test') && (timeHours.length == 1)) {
					timeHoursHash[timeHours[ii]] = 1;
				} else {
					//некорректный параметр timeHours
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter timeHours " + timeHours[ii];
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}
			}
			//сначала инициализируем немассивов, что бы знать, когда фиды заполнять начнут этот параметр
			FeedConfig[0][i]['timeHours'] = [];
			FeedConfig[0][i]['timeHoursHash'] = {};

//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	var timeHours = ['0'];
	timeHours[0] = parseInt(timeHours[0]);
	var timeHoursHash = {};
	timeHoursHash[timeHours[0]] = 1;
	FeedConfig[0][i]['timeHours'] = [];
	FeedConfig[0][i]['timeHoursHash'] = {};
}



			var startDaysHash = {};
			var startDaysNotCorrect = 0;
			//может быть в итоге пустой массив (означает что скан при каждом запуске)
			//если установлено в параметре пусто, 0 или нет параметра, то скан при каждом запуске
			if (!FeedConfig[0][i].hasOwnProperty('startDays')) {
				var startDays = [];
			} else if (!FeedConfig[0][i]['startDays']) {
				var startDays = [];
			} else if (typeof FeedConfig[0][i]['startDays'] != 'string') {
				//некорректный параметер
				startDaysNotCorrect = 1;
				var startDays = [];
			} else {
				var startDays = FeedConfig[0][i]['startDays'].split(/[\s\,]+/);
			}
			if (startDaysNotCorrect) {
				//некорректный параметр startDays
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter startDays";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}
			for (var ii = 0; ii < startDays.length; ii++) {
				if (isInteger(startDays[ii])) {
					startDays[ii] = parseInt(startDays[ii]);
					startDaysHash[startDays[ii]] = 1;
					if ((startDays[ii] < 1) || (startDays[ii] > 31)) {
						//некорректный параметр startDays
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter startDays " + startDays[ii];
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					}
				} else {
					//некорректный параметр startDays
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter startDays";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}
			}
			//сначала инициализируем немассивов, что бы знать, когда фиды заполнять начнут этот параметр
			FeedConfig[0][i]['startDays'] = '';
			FeedConfig[0][i]['startDaysHash'] = '';


//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	var startDays = [];
	FeedConfig[0][i]['startDays'] = '';
	FeedConfig[0][i]['startDaysHash'] = '';
}



			if (FeedConfig[0][i]['repeaterUrl'] && (typeof FeedConfig[0][i]['repeaterUrl'] != 'string')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter repeaterUrl";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			} else if (FeedConfig[0][i]['repeaterUrl']) {
				if (!/\/$/.test(FeedConfig[0][i]['repeaterUrl'])) {
					FeedConfig[0][i]['repeaterUrl'] += '/';
				}
				FeedConfig[0][i]['repeaterUrl'] += 'srvrepeat.php';
				var parce_repeater = parse_url(FeedConfig[0][i]['repeaterUrl']);
				if ((!parce_repeater)||(!parce_repeater['host'])||(!parce_repeater['protocol'])||(!parce_repeater['pathname'])||parce_repeater['search']||parce_repeater['hash']) {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter repeaterUrl";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {
					FeedConfig[0][i]['repeaterUrl'] += '?url=';
				}
			}



//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	if (FeedConfig[0][i]['repeaterUrl'])
		delete FeedConfig[0][i]['repeaterUrl'];
}


			if ((FeedConfig[0][i].hasOwnProperty('utmDropShip')) && (typeof FeedConfig[0][i]['utmDropShip'] != 'string')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter utmDropShip";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}

			if ((FeedConfig[0][i].hasOwnProperty('title')) && (typeof FeedConfig[0][i]['title'] != 'string')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter title";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}



			if ((FeedConfig[0][i].hasOwnProperty('description')) && (typeof FeedConfig[0][i]['description'] != 'string')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter description";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}


			if ((!FeedConfig[0][i].hasOwnProperty('CHARSET')) || (typeof FeedConfig[0][i]['CHARSET'] != 'string')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CHARSET";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}



			if ((FeedConfig[0][i].hasOwnProperty('scanFun')) && (typeof FeedConfig[0][i]['scanFun'] != 'function')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter scanFun";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}


			if ((FeedConfig[0][i].hasOwnProperty('startInitFun')) && (typeof FeedConfig[0][i]['startInitFun'] != 'function')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter startInitFun";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}


			if ((FeedConfig[0][i].hasOwnProperty('endInitFun')) && (typeof FeedConfig[0][i]['endInitFun'] != 'function')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter endInitFun";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}

			if (FeedConfig[0][i].hasOwnProperty('firstNewPages')) {
				if ((typeof FeedConfig[0][i]['firstNewPages'] != 'number')||(FeedConfig[0][i]['firstNewPages'] < 0)) {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter firstNewPages";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}
			}

			if (FeedConfig[0][i].hasOwnProperty('reverseNewUrls')) {
				if ((typeof FeedConfig[0][i]['reverseNewUrls'] != 'number')||(FeedConfig[0][i]['reverseNewUrls'] < 0)) {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter reverseNewUrls";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}
			}

			if (FeedConfig[0][i].hasOwnProperty('Debug_On')) {
				if ((typeof FeedConfig[0][i]['Debug_On'] != 'number')||(FeedConfig[0][i]['Debug_On'] < 0)) {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter Debug_On";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}
			}


			if ((FeedConfig[0][i].hasOwnProperty('No_Critical_Errors')) && ((typeof FeedConfig[0][i]['No_Critical_Errors'] != 'number')||(FeedConfig[0][i]['No_Critical_Errors'] < 0)||(FeedConfig[0][i]['No_Critical_Errors'] > 5))) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter No_Critical_Errors";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}

			if ((FeedConfig[0][i].hasOwnProperty('Write_emptyFeed_File')) && ((typeof FeedConfig[0][i]['Write_emptyFeed_File'] != 'number')||(FeedConfig[0][i]['Write_emptyFeed_File'] < 0)||(FeedConfig[0][i]['Write_emptyFeed_File'] > 2))) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter Write_emptyFeed_File";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}


//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	FeedConfig[0][i]['Write_emptyFeed_File'] = 1;
}


			if (FeedConfig[0][i].hasOwnProperty('CSVSITE')) {
				if ({}.toString.call(FeedConfig[0][i]['CSVSITE']) !== '[object Array]') {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {
					FeedConfig[0][i]['CSVConfig'] = {}

					var CSVSITE = FeedConfig[0][i]['CSVSITE'];
					//проверяем первые пять элементов массива CSVSITE

					if ((typeof CSVSITE[0] !== 'number')||(CSVSITE[0] < 0)||(CSVSITE[0] > 1)) {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[0] (parseUrls)";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					} else {
						FeedConfig[0][i]['CSVConfig']['parseUrls'] = CSVSITE[0];
					}

					if ((!CSVSITE[1])||({}.toString.call(CSVSITE[1]) !== '[object Array]')) {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[1] (skip_errors)";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					} else {
						FeedConfig[0][i]['CSVConfig']['skip_errors'] = CSVSITE[1];
					}


					if ((typeof CSVSITE[2] !== 'number')||(CSVSITE[2] < 0)) {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[2] (MAX_TRIES)";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					} else {
						FeedConfig[0][i]['CSVConfig']['MAX_TRIES'] = CSVSITE[2];
					}

					if ((typeof CSVSITE[3] !== 'number')||(CSVSITE[3] < 0)) {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[3] (REQUEST_DELAY)";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					} else {
						FeedConfig[0][i]['CSVConfig']['REQUEST_DELAY'] = CSVSITE[3];
					}


					if (typeof CSVSITE[4] !== 'string') {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[4] (repeaterUrl)";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					} else {

						if (CSVSITE[4]) {
							if (!/\/$/.test(CSVSITE[4])) {
								CSVSITE[4] += '/';
							}
							CSVSITE[4] += 'srvrepeat.php';
							var parce_repeater = parse_url(CSVSITE[4]);
							if ((!parce_repeater)||(!parce_repeater['host'])||(!parce_repeater['protocol'])||(!parce_repeater['pathname'])||parce_repeater['search']||parce_repeater['hash']) {
								//некорректный параметер
								readRes += "\n" + "Config Array element number " + i + " is not have correct parameter CSVSITE[4] (repeaterUrl)";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;
							} else {
								CSVSITE[4] += '?url=';
								FeedConfig[0][i]['CSVConfig']['repeaterUrl'] = CSVSITE[4];

							}
						}


					}


					//проверяем остальные элементы массива CSVSITE (массив массивов ссылок)
					if (CSVSITE.length < 6) {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[5] (Url Array)";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					} else {

						FeedConfig[0][i]['CSVConfig']['CSVurls'] = []

						//перебираем массивы ссылок

						for (var ii = 5; ii < CSVSITE.length; ii++) {
							if (({}.toString.call(CSVSITE[ii]) !== '[object Array]')||(CSVSITE[ii].length != 7)) {
								//некорректный параметер
								readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "] (Urls Array)";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;
							} else {


								//попали в массив отдельной ссылки

								var num = FeedConfig[0][i]['CSVConfig']['CSVurls'].length;

								FeedConfig[0][i]['CSVConfig']['CSVurls'][num] = {};

								var CSVurlHash = FeedConfig[0][i]['CSVConfig']['CSVurls'][num];

								//хеш для отслеживания дубликатов ссылок
								var CSVurlsDubl = {}

								//перебираем параметры ссылки
								//проверяем первые семь элементов в массиве каждой ссылки (больше там нет и меньше тоже)


								if ((typeof CSVSITE[ii][0] !== 'string')||(!CSVSITE[ii][0])) {
									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][0] (CSVUrl in Url Array)";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;
								} else {

									//это ссылка

									CSVurlHash['url'] = CSVSITE[ii][0];

									if (/\s/.test(CSVurlHash['url'])) {
										//не должно быть пробелов в ссылке
										readRes += "\n" + "Config Array element number " + i + " have space in parameter CSVSITE[" + ii + "][0] (CSVUrl in Url Array)";
										reterr = 1;
										//можно идти дальше, что бы весь конфиг проверить
										//			break;
									}
									var parsed_csvurl = parse_url(CSVurlHash['url']);
									if ((!parsed_csvurl['hostname']) || (!parsed_csvurl['protocol'])) {
										//должны быть protocol и hostname у сайта
										readRes += "\n" + "Config Array element number " + i + " is not have correct parameter CSVSITE[" + ii + "][0] (CSVUrl in Url Array)";
										reterr = 1;
										//можно идти дальше, что бы весь конфиг проверить
										//			break;
									}


									if (CSVurlsDubl[CSVurlHash['url']]) {
										CSVwarnings += "\n" + "Config Array element number " + i + " have dublicate URL in parameter CSVSITE[" + ii + "][0] (CSVUrl in Url Array)";
									/*
										//проверяем на дубликаты
										readRes += "\n" + "Config Array element number " + i + " have dublicate URL in parameter CSVSITE[" + ii + "][0] (CSVUrl in Url Array)";
										reterr = 1;
										//можно идти дальше, что бы весь конфиг проверить
										//			break;
									*/
									} else {
										CSVurlsDubl[CSVurlHash['url']] = 1
									}


								}


								if ((typeof CSVSITE[ii][1] !== 'string')||(!CSVSITE[ii][1])) {
									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][1] (CHARSET in Url Array)";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;
								} else {
									//это чарсет
									CSVurlHash['CHARSET'] = CSVSITE[ii][1];
								}



								var xml_flg = 0;

								if ({}.toString.call(CSVSITE[ii][6]) !== '[object Object]') {
									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][6] (csvParserConfig in Url Array)";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;
								} else {

									if (CSVSITE[ii][6].hasOwnProperty('xml')) {

										xml_flg = 1;

										if ({}.toString.call(CSVSITE[ii][6]['xml']) !== '[object Array]') {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][6] (xml in csvParserConfig in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										} else if (!CSVSITE[ii][6]['xml'].length) {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][6] (xml in csvParserConfig in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										} else {
											for (var iii = 0; iii < CSVSITE[ii][6]['xml'].length; iii++) {
												if ((typeof CSVSITE[ii][6]['xml'][iii] != 'string')||(!CSVSITE[ii][6]['xml'][iii])) {
													//некорректный параметер
													readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][6].xml[" + iii + "] (in xml in csvParserConfig in Url Array)";
													reterr = 1;
													//можно идти дальше, что бы весь конфиг проверить
													//			break;
												}
											}
										}
									}


									//это csvParserConfig
									CSVurlHash['csvParserConfig'] = CSVSITE[ii][6];

								}




								if (({}.toString.call(CSVSITE[ii][2]) !== '[object Array]')||(CSVSITE[ii][2].length > 2)) {
									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][2] (url_column_replace in Url Array)";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;
								} else {
									//это url_column_replace
									CSVurlHash['url_column_replace'] = CSVSITE[ii][2];


									if (xml_flg) {

										if ({}.toString.call(CSVSITE[ii][2][0]) !== '[object Array]') {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][2][0] (url_column_replace in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										} else if (!CSVSITE[ii][2][0].length) {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][2][0] (url_column_replace in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										} else {
											for (var iii = 0; iii < CSVSITE[ii][2][0].length; iii++) {
												if ((typeof CSVSITE[ii][2][0][iii] != 'string')||(!CSVSITE[ii][2][0][iii])) {
													//некорректный параметер
													readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][2][0][" + iii + "] (url_column_replace in Url Array)";
													reterr = 1;
													//можно идти дальше, что бы весь конфиг проверить
													//			break;
												}
											}
										}



									} else {

										if ((typeof CSVSITE[ii][2][0] !== 'number')||(CSVSITE[ii][2][0] < 0)) {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][2][0] (url_column_replace in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										}


									}




									if (typeof CSVSITE[ii][2][1] == 'undefined') {
										//обрезаем массив url_column_replace, оставляем в нем только первый элемент, если есть undefined второй
										CSVSITE[ii][2].length = 1
									} else {
										if (typeof CSVSITE[ii][2][1] !== 'function') {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][2][1] (url_column_replace in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										}
									}

								}


								if (({}.toString.call(CSVSITE[ii][3]) !== '[object Array]')||(CSVSITE[ii][3].length > 2)||(CSVSITE[ii][3].length == 1)) {
									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][3] (onlySeparator in Url Array)";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;
								} else {
									//это onlySeparator
									CSVurlHash['onlySeparator'] = CSVSITE[ii][3];


									if (CSVSITE[ii][3].length) {


										if (xml_flg) {

											if ({}.toString.call(CSVSITE[ii][3][0]) !== '[object Array]') {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][3][0] (onlySeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
											} else if (!CSVSITE[ii][3][0].length) {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][3][0] (onlySeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
											} else {
												for (var iii = 0; iii < CSVSITE[ii][3][0].length; iii++) {
													if ((typeof CSVSITE[ii][3][0][iii] != 'string')||(!CSVSITE[ii][3][0][iii])) {
														//некорректный параметер
														readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][3][0][" + iii + "] (onlySeparator in Url Array)";
														reterr = 1;
														//можно идти дальше, что бы весь конфиг проверить
														//			break;
													}
												}
											}



										} else {

											if ((typeof CSVSITE[ii][3][0] !== 'number')||(CSVSITE[ii][3][0] < 0)) {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][3][0] (onlySeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
							
											}

										}


										if (({}.toString.call(CSVSITE[ii][3][1]) !== '[object Array]')||(!CSVSITE[ii][3][1].length)) {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][3][1] (onlySeparator in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										} else {


											var badseparators = 0;


											for (var iii = 0; iii < CSVSITE[ii][3][1].length; iii++) {
												if (CSVSITE[ii][3][1][iii]) {
													var typeSepr = {}.toString.call(CSVSITE[ii][3][1][iii]);
													if (!((typeSepr == '[object String]')||(typeSepr == '[object RegExp]'))) {
														badseparators = 1;
														break;
													}
												} else {
													badseparators = 1;
													break;
												}
                                                                                	}
											if (badseparators) {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][3][1] (onlySeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
											}


										}



									}




								}






								if (({}.toString.call(CSVSITE[ii][4]) !== '[object Array]')||(CSVSITE[ii][4].length > 2)||(CSVSITE[ii][4].length == 1)) {
									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][4] (skipSeparator in Url Array)";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;
								} else {
									//это skipSeparator
									CSVurlHash['skipSeparator'] = CSVSITE[ii][4];


									if (CSVSITE[ii][4].length) {


										if (xml_flg) {

											if ({}.toString.call(CSVSITE[ii][4][0]) !== '[object Array]') {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][4][0] (skipSeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
											} else if (!CSVSITE[ii][4][0].length) {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][4][0] (skipSeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
											} else {
												for (var iii = 0; iii < CSVSITE[ii][4][0].length; iii++) {
													if ((typeof CSVSITE[ii][4][0][iii] != 'string')||(!CSVSITE[ii][4][0][iii])) {
														//некорректный параметер
														readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][4][0][" + iii + "] (skipSeparator in Url Array)";
														reterr = 1;
														//можно идти дальше, что бы весь конфиг проверить
														//			break;
													}
												}
											}



										} else {

											if ((typeof CSVSITE[ii][4][0] !== 'number')||(CSVSITE[ii][4][0] < 0)) {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][4][0] (skipSeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
							
											}

										}


										if (({}.toString.call(CSVSITE[ii][4][1]) !== '[object Array]')||(!CSVSITE[ii][4][1].length)) {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][4][1] (skipSeparator in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										} else {


											var badseparators = 0;


											for (var iii = 0; iii < CSVSITE[ii][4][1].length; iii++) {
												if (CSVSITE[ii][4][1][iii]) {
													var typeSepr = {}.toString.call(CSVSITE[ii][4][1][iii]);
													if (!((typeSepr == '[object String]')||(typeSepr == '[object RegExp]'))) {
														badseparators = 1;
														break;
													}
												} else {
													badseparators = 1;
													break;
												}
                                                                                	}
											if (badseparators) {
												//некорректный параметер
												readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][4][1] (skipSeparator in Url Array)";
												reterr = 1;
												//можно идти дальше, что бы весь конфиг проверить
												//			break;
											}


										}



									}




								}


								if (({}.toString.call(CSVSITE[ii][5]) !== '[object Array]')||(CSVSITE[ii][5].length > 2)) {

									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][5] (StartEndLines in Url Array)";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;


								} else {


									//это StartEndLines
									CSVurlHash['StartEndLines'] = CSVSITE[ii][5];

									if (!CSVSITE[ii][5].length) {
										//делаем всегда 2 элемента
										CSVurlHash['StartEndLines'] = [0,0];
									} else {


										if ((typeof CSVSITE[ii][5][0] !== 'number')||(CSVSITE[ii][5][0] < 0)) {
											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][5][0] (StartEndLines in Url Array)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;

										} else {


											if (CSVSITE[ii][5].length == 1) {
												//делаем всегда 2 элемента
												CSVurlHash['StartEndLines'] = [CSVSITE[ii][5][0],0];
											} else {
					
												if ((typeof CSVSITE[ii][5][1] !== 'number')||(CSVSITE[ii][5][1] < 0)||(CSVSITE[ii][5][0] > CSVSITE[ii][5][1])) {
													//некорректный параметер
													readRes += "\n" + "Config Array element number " + i + " have incorrect parameter CSVSITE[" + ii + "][5][0] (StartEndLines in Url Array)";
													reterr = 1;
													//можно идти дальше, что бы весь конфиг проверить
													//			break;

												}


											}
										}


									}


								}





							}
						}
					}

					//сформировали хеш
					//['CSVConfig']['parseUrls']
					//['CSVConfig']['skip_errors']
					//['CSVConfig']['MAX_TRIES']
					//['CSVConfig']['REQUEST_DELAY']
					//['CSVConfig']['repeaterUrl']
					//['CSVConfig']['CSVurls'].length - массив ссылок и их параметров 
					//['CSVConfig']['CSVurls'][i]['url']
					//['CSVConfig']['CSVurls'][i]['CHARSET']
					//['CSVConfig']['CSVurls'][i]['url_column_replace'] - массив с 1.номером столбца со ссылкой и 2.функцией для анализа/вывода ссылки по данным в массиве CSV-строки
					//['CSVConfig']['CSVurls'][i]['onlySeparator']
					//['CSVConfig']['CSVurls'][i]['skipSeparator']
					//['CSVConfig']['CSVurls'][i]['StartEndLines']
					//['CSVConfig']['CSVurls'][i]['csvParserConfig']



				}
			}


//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	if (FeedConfig[0][i].hasOwnProperty('CSVSITE'))
		delete FeedConfig[0][i]['CSVSITE'];
	if (FeedConfig[0][i].hasOwnProperty('CSVConfig'))
		delete FeedConfig[0][i]['CSVConfig'];
}



			if (FeedConfig[0][i].hasOwnProperty('addscanUrls')) {

				if ({}.toString.call(FeedConfig[0][i]['addscanUrls']) !== '[object Array]') {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter addscanUrls";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else if (!FeedConfig[0][i]['addscanUrls'].length) {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter addscanUrls";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {                

					if ((FeedConfig[0][i].hasOwnProperty('valid_scheme')) && ({}.toString.call(FeedConfig[0][i]['valid_scheme']) !== '[object Array]')) {
						var valid_scheme = null;
					} else {
						var valid_scheme = FeedConfig[0][i]['valid_scheme'];
					}

					for (var ii = 0; ii < FeedConfig[0][i]['addscanUrls'].length; ii++) {
						if ((typeof FeedConfig[0][i]['addscanUrls'][ii] != 'string')||(!FeedConfig[0][i]['addscanUrls'][ii])) {
							//некорректный параметер
							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter addscanUrls[" + ii + "]";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;
						} else {

							var parsed_addscanUrl = parse_url(FeedConfig[0][i]['addscanUrls'][ii]);

							if ((!parsed_addscanUrl)||(parsed_addscanUrl['hostname']&&(parsed_addscanUrl['hostname'] !== parsed_url['hostname']))) {
								//некорректный параметер
								readRes += "\n" + "Config Array element number " + i + " have incorrect parameter addscanUrls[" + ii + "]";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;
								continue;
							}

							if (parsed_addscanUrl&&parsed_addscanUrl["protocol"]&&valid_scheme) {


								var scheme = parsed_addscanUrl["protocol"];


								if (valid_scheme && valid_scheme.length) {
									if (scheme) {
										var exists = 0;
										for (var v in valid_scheme) {
											if (valid_scheme[v] == scheme) {
												exists = 1;
											}
										}
										if (!exists) {

											//некорректный параметер
											readRes += "\n" + "Config Array element number " + i + " have incorrect parameter addscanUrls[" + ii + "]";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
											continue;

										}

									}

								}



							}

						}
					}
				}
			}



//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	if (FeedConfig[0][i].hasOwnProperty('addscanUrls'))
		delete FeedConfig[0][i]['addscanUrls'];
}


			if (FeedConfig[0][i].hasOwnProperty('scanSelectors')) {

				if ({}.toString.call(FeedConfig[0][i]['scanSelectors']) !== '[object Array]') {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter scanSelectors";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else if (!FeedConfig[0][i]['scanSelectors'].length) {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter scanSelectors";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {                
					for (var ii = 0; ii < FeedConfig[0][i]['scanSelectors'].length; ii++) {
						if ((typeof FeedConfig[0][i]['scanSelectors'][ii] != 'string')||(!FeedConfig[0][i]['scanSelectors'][ii])) {
							//некорректный параметер
							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter scanSelectors[" + ii + "]";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;
						}
					}
				}
			}




			if (FeedConfig[0][i].hasOwnProperty('onlyORskipSeparators')) {
				if ({}.toString.call(FeedConfig[0][i]['onlyORskipSeparators']) == '[object Array]') {

					if (FeedConfig[0][i]['onlyORskipSeparators'].length) {

						for (var ik = 0; ik < FeedConfig[0][i]['onlyORskipSeparators'].length; ik++) {

							if ((FeedConfig[0][i]['onlyORskipSeparators'][ik].length == 3) || (FeedConfig[0][i]['onlyORskipSeparators'][ik].length == 4))  {
								var typeSepr1 = {}.toString.call(FeedConfig[0][i]['onlyORskipSeparators'][ik][0]);
								var typeSepr2 = {}.toString.call(FeedConfig[0][i]['onlyORskipSeparators'][ik][1]);
								var typeSepr3 = {}.toString.call(FeedConfig[0][i]['onlyORskipSeparators'][ik][2]);
								var typeSepr4 = typeof FeedConfig[0][i]['onlyORskipSeparators'][ik][3];

								//2-й и 3-й массивы могут быть пустыми, второй элемент первого массива может отсутствовать, но первый элемент первого массива должен быть всегда
								//4-й элемент функция или отсутсвует
								if ( ( (typeSepr1 == '[object Array]') && (typeSepr2 == '[object Array]') && (typeSepr3 == '[object Array]') && ((typeSepr4 == 'function')||(typeSepr4 == 'undefined')) ) && FeedConfig[0][i]['onlyORskipSeparators'][ik][0].length && (FeedConfig[0][i]['onlyORskipSeparators'][ik][0].length < 3) && FeedConfig[0][i]['onlyORskipSeparators'][ik][0][0] ) {

									var badseparators = 0;

									for (var ii = 0; ii < FeedConfig[0][i]['onlyORskipSeparators'][ik][0].length; ii++) {
										var onlyORskipSeparatorSet = FeedConfig[0][i]['onlyORskipSeparators'][ik][0][ii];
										if (onlyORskipSeparatorSet) {
											if (!(({}.toString.call(onlyORskipSeparatorSet) == '[object String]')||({}.toString.call(onlyORskipSeparatorSet) == '[object RegExp]'))) {
												badseparators = 1;
												break;
											}
										} else {
											badseparators = 1;
											break;
										}
									}


									for (var ii = 0; ii < FeedConfig[0][i]['onlyORskipSeparators'][ik][1].length; ii++) {
										var onlyORskipSeparatorSet = FeedConfig[0][i]['onlyORskipSeparators'][ik][1][ii];
										if (onlyORskipSeparatorSet) {
											if (!(({}.toString.call(onlyORskipSeparatorSet) == '[object String]')||({}.toString.call(onlyORskipSeparatorSet) == '[object RegExp]'))) {
												badseparators = 1;
												break;
											}
										} else {
											badseparators = 1;
											break;
										}
									}


									for (var ii = 0; ii < FeedConfig[0][i]['onlyORskipSeparators'][ik][2].length; ii++) {
										if (onlyORskipSeparatorSet) {
											var onlyORskipSeparatorSet = FeedConfig[0][i]['onlyORskipSeparators'][ik][2][ii];
											if (!(({}.toString.call(onlyORskipSeparatorSet) == '[object String]')||({}.toString.call(onlyORskipSeparatorSet) == '[object RegExp]'))) {
												badseparators = 1;
												break;
											}
										} else {
											badseparators = 1;
											break;
										}
									}


									if (typeSepr4 == 'function') {
										try {
											FeedConfig[0][i]['onlyORskipSeparators'][ik][3]('   ');
										} catch (e) {
											badseparators = 1;
										}

									}


									if (badseparators) {
										//некорректный параметер
										readRes += "\n" + "Config Array element number " + i + " have incorrect parameter onlyORskipSeparators";
										reterr = 1;
										//можно идти дальше, что бы весь конфиг проверить
										//			break;
									} else {

										//удаляем пустые массивы 2, 3 и 4 (не забываем это при обработке!)
										if ((!FeedConfig[0][i]['onlyORskipSeparators'][ik][1].length)&&(!FeedConfig[0][i]['onlyORskipSeparators'][ik][2].length)&&(!FeedConfig[0][i]['onlyORskipSeparators'][ik][3]))
											FeedConfig[0][i]['onlyORskipSeparators'][ik].length = 1;


									}

								} else {
									//некорректный параметер
									readRes += "\n" + "Config Array element number " + i + " have incorrect parameter onlyORskipSeparators";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//			break;
								}

							} else {
								//некорректный параметер
								readRes += "\n" + "Config Array element number " + i + " have incorrect parameter onlyORskipSeparators";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;
							}

						}

					} else {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter onlyORskipSeparators";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					}
				} else {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter onlyORskipSeparators";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}
			}

			if (FeedConfig[0][i].hasOwnProperty('noSeparatorsNotScanUrls')) {

				if (FeedConfig[0][i].hasOwnProperty('onlyORskipSeparators')) {

					if (!((typeof FeedConfig[0][i]['noSeparatorsNotScanUrls'] == 'number')&&(FeedConfig[0][i]['noSeparatorsNotScanUrls'] >= 0))) {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter noSeparatorsNotScanUrls";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					}

				} else {
					readRes += "\n" + "Config Array element number " + i + " have parameter noSeparatorsNotScanUrls without parameter onlyORskipSeparators";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}

			}




			if ((FeedConfig[0][i].hasOwnProperty('valid_scheme')) && ({}.toString.call(FeedConfig[0][i]['valid_scheme']) !== '[object Array]')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter valid_scheme";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}



			if ((FeedConfig[0][i].hasOwnProperty('skip_query')) && ({}.toString.call(FeedConfig[0][i]['skip_query']) !== '[object Array]')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter skip_query";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			} else {

				var skip_url = FeedConfig[0][i].skip_query;

				if (skip_url && skip_url.length) {
					for (var v in skip_url) {
				        	var parsed_url_tmp = parse_url(skip_url[v]);
						if (typeof parsed_url_tmp != 'object') {

							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter skip_query";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;

						} else if (parsed_url_tmp.hash || parsed_url_tmp.protocol || parsed_url_tmp.hostname || parsed_url_tmp.port) {

							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter skip_query " + parsed_url_tmp;
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;

//							skip_url[v] = parsed_url.pathname + parsed_url.search;
						} else if (parsed_url_tmp.pathname.substr(0, 1) != '/') {

							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter skip_query " + parsed_url_tmp;
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;

//							skip_url[v] = '/' + parsed_url.pathname + parsed_url.search;
						}
				        }
				}



			}



			if ((FeedConfig[0][i].hasOwnProperty('only_query')) && ({}.toString.call(FeedConfig[0][i]['only_query']) !== '[object Array]')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter only_query";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			} else {


				var only_url = FeedConfig[0][i].only_query;

				if (only_url && only_url.length) {
					for (var v in only_url) {
				        	var parsed_url_tmp = parse_url(only_url[v]);
						if (typeof parsed_url_tmp != 'object') {

							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter only_query";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;


						} else if (parsed_url_tmp.hash || parsed_url_tmp.protocol || parsed_url_tmp.hostname || parsed_url_tmp.port) {

							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter only_query " + parsed_url_tmp;
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;

//							only_url[v] = parsed_url.pathname + parsed_url.search;
						} else if (parsed_url_tmp.pathname.substr(0, 1) != '/') {

							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter only_query " + parsed_url_tmp;
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;
//							only_url[v] = '/' + parsed_url.pathname + parsed_url.search;
						}
				        }
				}



			}



			if ((FeedConfig[0][i].hasOwnProperty('skip_errors')) && ({}.toString.call(FeedConfig[0][i]['skip_errors']) !== '[object Array]')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter skip_errors";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}

			if ((FeedConfig[0][i].hasOwnProperty('repeat_errors')) && ({}.toString.call(FeedConfig[0][i]['repeat_errors']) !== '[object Array]')) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter repeat_errors";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}


			FeedConfig[0][i]['shortWordsHash'] = {};
			if (FeedConfig[0][i].hasOwnProperty('shortWords')) {
				if ({}.toString.call(FeedConfig[0][i]['shortWords']) !== '[object Array]') {
					//некорректный параметер
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter shortWords";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {
					var ferr = 0;
					for (var ii = 0; ii < FeedConfig[0][i]['shortWords'].length; ii++) {
						if ((!FeedConfig[0][i]['shortWords'][ii])||(typeof FeedConfig[0][i]['shortWords'][ii] != 'string')) {
							ferr = 1;
						} else {
							FeedConfig[0][i]['shortWordsHash'][FeedConfig[0][i]['shortWords'][ii].toLowerCase()] = 1;
						}
					}
					if (ferr) {
						//некорректный параметер
						readRes += "\n" + "Config Array element number " + i + " have incorrect parameter shortWords";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//			break;
					}
				}
			}



			if ((FeedConfig[0][i].hasOwnProperty('REQUEST_DELAY')) && ((typeof FeedConfig[0][i]['REQUEST_DELAY'] != 'number') || (FeedConfig[0][i]['REQUEST_DELAY'] <= 0))) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter REQUEST_DELAY";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}



			if ((FeedConfig[0][i].hasOwnProperty('MAX_TRIES')) && ((typeof FeedConfig[0][i]['MAX_TRIES'] != 'number') || (FeedConfig[0][i]['MAX_TRIES'] <= 0))) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter MAX_TRIES";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}



			if ((FeedConfig[0][i].hasOwnProperty('MAX_CHECKED_URLS')) && ((typeof FeedConfig[0][i]['MAX_CHECKED_URLS'] != 'number')||(FeedConfig[0][i]['MAX_CHECKED_URLS'] < 0))) {
				//некорректный параметер
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter MAX_CHECKED_URLS";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}



//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	//максимум одна позиция в фиде, но скорее ее не будет тоже, так как первой в скане будет стартовая страница, которая как правило не страница товара
	FeedConfig[0][i]['MAX_CHECKED_URLS'] = 1;
}


			var existId = 1;
			if ((FeedConfig[0][i].hasOwnProperty('Id')) && (typeof FeedConfig[0][i]['Id'] != 'string')) {
				/*
				повторяет контроль, который внизу
							readRes += "\n" + "Config Array element number " + i +  " have incorrect parameter Id";
							reterr = 1;

				//можно идти дальше, что бы весь конфиг проверить
				//			break;
				*/
			} else {
				existId = 0;
				var Id = FeedConfig[0][i]['Id'];
				Id = ((typeof Id == 'string') && Id) ? Id.toLowerCase() : '';
				if (!Id) {
					//автоматически назначает hostname, если не указан Id
					Id = parsed_url['hostname'];
				} else if (isInteger(Id)) {
					//если id целочисленные, то перебор хеша дальше сработает непредсказуемо!!! (нужно что бы были буквы в id)
					//https://learn.javascript.ru/object-for-in
					Id = 'id' + Id;
				}
				//обязательно удаляем точки!!
				Id = Id.replace(/\.+/igm, '');
				FeedConfig[0][i]['Id'] = Id;
				if (/\s/.test(Id)) {
					//не должно быть пробелов в идентификаторе скана сайтов
					readRes += "\n" + "Config Array element number " + i + " have space in parameter Id";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}
			}
			//только английские символы, должен быть виден из сети
			FeedConfig[0][i]['Id'] = idndomain(FeedConfig[0][i]['Id']);
			FeedConfig[0][i]['Id'] = FeedConfig[0][i]['Id'].replace(/[^a-z0-9\_\-\.]+/igm, '');



			if (!FeedConfig[0][i].hasOwnProperty('priorityLev')) {
				var priorityLev = 0;
			} else if (typeof FeedConfig[0][i]['priorityLev'] != 'number') {
				//некорректный параметер
				var priorityLev = 0;
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter priorityLev";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			} else if (!isInteger(FeedConfig[0][i]['priorityLev'])) {
				//некорректный параметер
				var priorityLev = 0;
				readRes += "\n" + "Config Array element number " + i + " have incorrect parameter priorityLev";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			} else {
				var priorityLev = FeedConfig[0][i]['priorityLev'];
			}
			FeedConfig[0][i]['priorityLev'] = priorityLev;



			var mainall_fields_not_required_err = 0;


			//проверяем расширения фидов в пределах сайта
			var exts = {};

			var feedfiles = {};


			var feedsnum = 0;
			for (var j in FeedConfig[0][i]) {
				//только целые числа-строки пропускаем (фиды)
				//			if (!isInteger(j))
				//только id + целые числа пропускаем (фиды)
				if (!(((typeof j == 'string') && (/^id\d+$/.test(j)))))
					continue
				if ({}.toString.call(FeedConfig[0][i][j]) !== '[object Object]') {
					//должен быть хеш у фида
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " is not Hash";
					reterr = 1;
					break;
				}


				//добавляем признак фида, названия/ключи хеша скана, которые являются ключами хешей/идентификаторами фидов в скане
				if (!FeedConfig[0][i]['feeds']) {
					FeedConfig[0][i]['feeds'] = {};
				}
				FeedConfig[0][i]['feeds'][j] = 1;




				var ext = FeedConfig[0][i][j]['ext'];
				ext = ((typeof ext == 'string') && ext) ? ext.toLowerCase() : '';
				if (!ext) {
					//автоматически назначает j (номер фида), если не указан ext
					ext = j;
				}
				//обязательно убираем точки, что бы идентифицировать ext и другие элементы файлов (если разбить массив по количеству точек)
				ext = ext.replace(/\.+/igm, '');

				if (/\s/.test(ext)) {
					//не должно быть пробелов в ext
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have space in ext " + ext;
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}
				//только английские символы, должен быть виден из сети
				ext = idndomain(ext);
				ext = ext.replace(/[^a-z0-9\_\-\.]+/igm, '');
				FeedConfig[0][i][j]['ext'] = ext;

				if (!exts.hasOwnProperty(ext)) {
					exts[ext] = 1;
				} else {
					//не должны повторяться ext
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have dublicate ext " + ext;
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}



				//генерируемый параметр feedId с точкой в конце (используем для формирования файла фида, но без расширения)
//				FeedConfig[0][i][j]['feedId'] = FeedConfig[0][i]['Id'] + ".feed." + ext + ".";
				//без точки (точка есть в расширениях файлов)
				FeedConfig[0][i][j]['feedId'] = FeedConfig[0][i]['Id'] + ".feed." + ext;

				//необязательная проверка, так как все проверяется выше, но feedfiles может использоваться ниже
				if (!feedfiles.hasOwnProperty(FeedConfig[0][i][j]['feedId'])) {
					feedfiles[FeedConfig[0][i][j]['feedId']] = parsed_url['hostname'];
				} else {
					//не должны повторяться Id фидов 
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have dublicated feedId  " + FeedConfig[0][i][j]['feedId'];
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}


				if (FeedConfig[0][i][j]['ftp'] && FeedConfig[0][i][j]['ftp']['zipfilename']) {
					var zipfilename = FeedConfig[0][i][j]['ftp']['zipfilename']
					if (!zipnames.hasOwnProperty(zipfilename)) {
						zipnames[zipfilename] = 1;
					} else {
						//не должны повторяться zipfilename
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have dublicate zipfilename " + zipfilename;
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					}
				}



				if (FeedConfig[0][i][j].hasOwnProperty('keyword') && (typeof FeedConfig[0][i][j]['keyword'] !== 'string')) {
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct parameter keyword";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//					break;
				}


	function parcheck(parameterName,parameter,readRes) {
		//проверяем типовые значения параметров для поисковых кампаний

		var reterr = 0;
		var partype = '';

		if (({}.toString.call(parameter) === '[object Array]')&&(parameter.length > 0)) {
			partype = 'array3';
			if (typeof parameter[0] == "string") {
				if (parameter.length < 4) {
					for (var i = 0; i < parameter.length; i++) {
						if (typeof parameter[i] != 'string') {
							readRes += "\n" + 'bad parameter: ' + parameterName + " in GASearch";
							reterr = 1;
						}
				
					}
				} else {
					readRes += "\n" + 'bad parameter: ' + parameterName + " in GASearch";
					reterr = 1;
				}
			} else if ((parameterName == 'keys')&&(({}.toString.call(parameter[0]) === '[object Array]')||(typeof parameter[0] === 'function'))) {

					partype = [];
					for (var i = 0; i < parameter.length; i++) {
						if (({}.toString.call(parameter[i]) === '[object Array]')&&(parameter[i].length > 0)&&(parameter[i].length < 4)) {
							partype[i] = 'array3'
							for (var ii = 0; ii < parameter[i].length; ii++) {
								if (typeof parameter[i][ii] != 'string') {
									readRes += "\n" + 'bad parameter: ' + parameterName + " in GASearch";
									reterr = 1;
								}
				
							}
						} else if (typeof parameter[i] === 'function') {
							partype[i] = 'function';
						} else {
							partype[i] = '';
							readRes += "\n" + 'bad parameter: ' + parameterName + " in GASearch";
							reterr = 1;
						}
					}

			} else {
				readRes += "\n" + 'bad parameter: ' + parameterName + " in GASearch";
				reterr = 1;
			}
		} else if (typeof parameter === 'function') {
			partype = 'function';
		} else {
			readRes += "\n" + 'bad parameter: ' + parameterName + " in GASearch";
			reterr = 1;
		}


		return [reterr,readRes,partype];

	}




				if (FeedConfig[0][i][j].hasOwnProperty('childAddByRank')) {
					if (!FeedConfig[0][i][j].hasOwnProperty('parentFeed')) {
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter childAddByRank (without parentFeed)";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//				break;
					} else if ((typeof FeedConfig[0][i][j]['childAddByRank'] != 'number')||(FeedConfig[0][i][j]['childAddByRank'] < 0)) {
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter childAddByRank";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//				break;
					}
				}



				if (FeedConfig[0][i][j].hasOwnProperty('parentFeed')) {
					//родительский фид есть у фида, проверяем корректность

					var nocorrectfeed = 0;
					if (typeof FeedConfig[0][i][j]['parentFeed'] != 'string') {
						nocorrectfeed = 1;
					} else if (!FeedConfig[0][i][j]['parentFeed']) {
						nocorrectfeed = 1;
					} else if (FeedConfig[0][i][j]['parentFeed'] == j) {
						nocorrectfeed = 1;
					} else if (!FeedConfig[0][i]['feeds'][FeedConfig[0][i][j]['parentFeed']]) {
						nocorrectfeed = 1;
					}

					if (nocorrectfeed) {
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter parentFeed";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//				break;
						delete FeedConfig[0][i][j]['parentFeed'];
					} else {
						//формируем массив идентификаторов дочерних фидов
						var parFeed = FeedConfig[0][i][FeedConfig[0][i][j]['parentFeed']];
						if (!parFeed['childrenFeeds']) {
							parFeed['childrenFeeds'] = [];
						}
						parFeed['childrenFeeds'][parFeed['childrenFeeds'].length] = j;

						if (!FeedConfig[0][i][j]['childAddByRank']) {
							//устанавливаем родителю флаг, что есть хотя бы один child, который не участвует в игре "кто первый запишет"
							if (FeedConfig[0][i][FeedConfig[0][i][j]['parentFeed']])
								FeedConfig[0][i][FeedConfig[0][i][j]['parentFeed']]['ExistNotUsechildAddByRank'] = 1;
						}

					}
				}





				//для каждого фида вычисляем свои timeHours
				//не может быть в итоге пустой массив
				//может быть установлен только test для фида и не запускать никогда, кроме режима просмотра
				//если установлено в параметре пусто или 0, то 0 часов
				//если нет параметра, то берем вышестоящий параметр (для скана)
				var timeHoursFeedHash = {};
				var timeHoursFeedNotCorrect = 0;
				if (FeedConfig[0][i][j]['parentFeed']) {
					//копируем массив из родительского фида
					var timeHoursFeed = JSON.parse(JSON.stringify(FeedConfig[0][i][FeedConfig[0][i][j]['parentFeed']]['timeHours']));
					if (FeedConfig[0][i][j].hasOwnProperty('timeHours')) {
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have parameter timeHours in children feed, remove it";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//				break;
					}
				} else if (!FeedConfig[0][i][j].hasOwnProperty('timeHours')) {
					//копируем массив
					var timeHoursFeed = JSON.parse(JSON.stringify(timeHours));
				} else if (!FeedConfig[0][i][j]['timeHours']) {
					var timeHoursFeed = ['0'];
				} else if (typeof FeedConfig[0][i][j]['timeHours'] != 'string') {
					//некорректный параметер
					var timeHoursFeed = [];
					timeHoursFeedNotCorrect = 1;
				} else if (FeedConfig[0][i][j]['timeHours'] === 'test') {
					//test
					var timeHoursFeed = ['test'];
				} else {
					var timeHoursFeed = FeedConfig[0][i][j]['timeHours'].split(/[\s\,]+/);
				}
				if (timeHoursFeedNotCorrect) {
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter timeHours";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}
				for (var ii = 0; ii < timeHoursFeed.length; ii++) {
					if (isInteger(timeHoursFeed[ii])) {
						timeHoursFeed[ii] = parseInt(timeHoursFeed[ii]);
						timeHoursFeedHash[timeHoursFeed[ii]] = 1;
						if ((timeHoursFeed[ii] < 0) || (timeHoursFeed[ii] > 23)) {
							//некорректный параметр timeHoursFeed
							readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter timeHours " + timeHoursFeed[ii];
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//						break;
						}
					} else if ((timeHoursFeed[ii] == 'test') && (timeHoursFeed.length == 1)) {
						timeHoursFeedHash[timeHoursFeed[ii]] = 1;
					} else {
						//некорректный параметр timeHours
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter timeHours";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					}
				}
				FeedConfig[0][i][j]['timeHours'] = JSON.parse(JSON.stringify(timeHoursFeed));
				FeedConfig[0][i][j]['timeHoursHash'] = JSON.parse(JSON.stringify(timeHoursFeedHash));


//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	var timeHoursFeedHash = {};
	var timeHoursFeed = ['0'];
	timeHoursFeed[0] = parseInt(timeHoursFeed[0]);
	timeHoursFeedHash[timeHoursFeed[0]] = 1;
	FeedConfig[0][i][j]['timeHours'] = JSON.parse(JSON.stringify(timeHoursFeed));
	FeedConfig[0][i][j]['timeHoursHash'] = JSON.parse(JSON.stringify(timeHoursFeedHash));
}

				//собираем общий timeHours из чисел-часов (не может быть пустой в результате)
				//если у фида test, то добавляем этот параметр в общий timeHours
				for (var ii = 0; ii < timeHoursFeed.length; ii++) {
					if (!FeedConfig[0][i]['timeHoursHash'][timeHoursFeed[ii]]) {
						FeedConfig[0][i]['timeHoursHash'][timeHoursFeed[ii]] = 1;
						FeedConfig[0][i]['timeHours'][FeedConfig[0][i]['timeHours'].length] = timeHoursFeed[ii];
					}
				}




				if (FeedConfig[0][i][j]['timeHours']&&(FeedConfig[0][i][j]['timeHours'].indexOf('test') != -1)&&(FeedConfig[0][i][j]['timeHours'].length == 1)) {
					if (!FeedConfig[0][i][j].hasOwnProperty('all_fields_not_required')) {
						//без проверок корректности, просто флаг
						FeedConfig[0][i][j]['all_fields_not_required'] = FeedConfig[0][i]['all_fields_not_required'];
					}
				} else {
					//FeedConfig[0][i][j]['all_fields_not_required'] = 0;

					var mainall_fields_not_required = 0;
					//сначала установить значение all_fields_not_required для фида
					//если не пусто, то ошибка (он не может быть без test в timeHours)
					if (!FeedConfig[0][i][j].hasOwnProperty('all_fields_not_required')) {
						//без проверок корректности, просто флаг
						FeedConfig[0][i][j]['all_fields_not_required'] = FeedConfig[0][i]['all_fields_not_required'];
						mainall_fields_not_required = 1;
					}
					if (!FeedConfig[0][i][j]['all_fields_not_required']) {
						FeedConfig[0][i][j]['all_fields_not_required'] = 0;
					} else {
						if (mainall_fields_not_required) {
							if (!mainall_fields_not_required_err) {
								mainall_fields_not_required_err = 1;
								readRes += "\n" + "Config Array element number " + i + " have parameter all_fields_not_required without 'test' in timeHours, remove it or add  'test' in timeHours";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//				break;
							}
						} else {
							readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have parameter all_fields_not_required without 'test' in timeHours, remove it or add  'test' in timeHours";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//				break;
						}
					}
				}



				//для каждого фида вычисляем свои startDays
				//может быть в итоге пустой массив (означает что скан при каждом запуске)
				//если установлено в параметре пусто или 0, то скан при каждом запуске
				//если нет параметра, то берем вышестоящий параметр (для скана)
				var startDaysFeedHash = {};
				var startDaysFeedNotCorrect = 0;
				if (FeedConfig[0][i][j]['parentFeed']) {
					//копируем массив из родительского фида
					var startDaysFeed = JSON.parse(JSON.stringify(FeedConfig[0][i][FeedConfig[0][i][j]['parentFeed']]['startDays']));
					if (FeedConfig[0][i][j].hasOwnProperty('startDays')) {
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have parameter startDays in children feed, remove it";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//				break;
					}
				} else if (!FeedConfig[0][i][j].hasOwnProperty('startDays')) {
					var startDaysFeed = JSON.parse(JSON.stringify(startDays));
				} else if (!FeedConfig[0][i][j]['startDays']) {
					//скан при каждом запуске
					var startDaysFeed = [];
				} else if (typeof FeedConfig[0][i][j]['startDays'] != 'string') {
					//некорректный параметер
					var startDaysFeed = [];
					startDaysFeedNotCorrect = 1;
				} else {
					var startDaysFeed = FeedConfig[0][i][j]['startDays'].split(/[\s\,]+/);
				}
				if (startDaysFeedNotCorrect) {
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter startDays";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}
				for (var ii = 0; ii < startDaysFeed.length; ii++) {
					if (isInteger(startDaysFeed[ii])) {
						startDaysFeed[ii] = parseInt(startDaysFeed[ii]);
						startDaysFeedHash[startDaysFeed[ii]] = 1;
						if ((startDaysFeed[ii] < 1) || (startDaysFeed[ii] > 31)) {
							//некорректный параметр startDaysFeed
							readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter startDays " + startDaysFeed[ii];
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//						break;
						}
					} else {
						//некорректный параметр startDays
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter startDays";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					}
				}
				FeedConfig[0][i][j]['startDays'] = JSON.parse(JSON.stringify(startDaysFeed));
				FeedConfig[0][i][j]['startDaysHash'] = JSON.parse(JSON.stringify(startDaysFeedHash));

//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	var startDaysFeedHash = {};
	var startDaysFeed = [];
	FeedConfig[0][i][j]['startDays'] = JSON.parse(JSON.stringify(startDaysFeed));
	FeedConfig[0][i][j]['startDaysHash'] = JSON.parse(JSON.stringify(startDaysFeedHash));
}


				//собираем общий startDays из чисел месяца (может быть пустой в результате, то есть скан при каждом запуске)
				if (!startDaysFeed.length) {
					//если пустой в фиде, то общий делаем пустой (больше в общий нельзя добавлять значения)
					//даже если повторно здесь сделаем общий пустым - это не страшно
					FeedConfig[0][i]['startDays'] = [];
					FeedConfig[0][i]['startDaysHash'] = {};
				} else {

					if (!FeedConfig[0][i]['startDays']) {
						//еще не был создан массив (даже пустой), создаем, клонируем
						FeedConfig[0][i]['startDays'] = JSON.parse(JSON.stringify(startDaysFeed));
						FeedConfig[0][i]['startDaysHash'] = JSON.parse(JSON.stringify(startDaysFeedHash));
					} else if (FeedConfig[0][i]['startDays'].length) {
						//уже есть массив, добавляем значения - но только если общий массив не пустой (иначе нельзя добавлять, так как уже установлен скан при каждом запуске)
						for (var ii = 0; ii < startDaysFeed.length; ii++) {
							if (!FeedConfig[0][i]['startDaysHash'][startDaysFeed[ii]]) {
								FeedConfig[0][i]['startDaysHash'][startDaysFeed[ii]] = 1;
								FeedConfig[0][i]['startDays'][FeedConfig[0][i]['startDays'].length] = startDaysFeed[ii];
							}
						}
					}
				}




				//для каждого фида вычисляем свой noDropShip
				if (!FeedConfig[0][i][j].hasOwnProperty('noDropShip')) {
					if (FeedConfig[0][i].hasOwnProperty('noDropShip')) {
						FeedConfig[0][i][j]['noDropShip'] = FeedConfig[0][i]['noDropShip'];
					}
				}



				//для каждого фида вычисляем свой utmDropShip
				if (!FeedConfig[0][i][j].hasOwnProperty('utmDropShip')) {
					if (FeedConfig[0][i].hasOwnProperty('utmDropShip')) {
						FeedConfig[0][i][j]['utmDropShip'] = FeedConfig[0][i]['utmDropShip'];
					}
				} else if (typeof FeedConfig[0][i][j]['utmDropShip'] != 'string') {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter utmDropShip";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}



				if (FeedConfig[0][i][j].hasOwnProperty('file_type')) {
					var file_type = FeedConfig[0][i][j]['file_type']
					if ({}.toString.call(file_type) !== '[object Array]') {
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter file_type";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					} else {
						for (var ii = 0; ii < file_type.length; ii++) {
							if ((typeof file_type[ii] != 'string') || (correctfeedExt.indexOf(file_type[ii]) == -1)) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter file_type";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//							break;
							}
						}
					}
				}


				if (FeedConfig[0][i][j].hasOwnProperty('ftp')) {
					var ftp_config = FeedConfig[0][i][j]['ftp'];
					if (!(ftp_config['login'] && ftp_config['password'] && ftp_config['host'] && ftp_config['files_types'] && ftp_config['files_types'].length)) {
						readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter ftp";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					}
				}



	
				if ((FeedConfig[0][i][j].hasOwnProperty('skip_parse')) && ({}.toString.call(FeedConfig[0][i][j]['skip_parse']) !== '[object Array]')) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter skip_parse";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {

					var skip_url = FeedConfig[0][i].skip_parse;

					if (skip_url && skip_url.length) {
						for (var v in skip_url) {
				        		var parsed_url_tmp = parse_url(skip_url[v]);
							if (typeof parsed_url_tmp != 'string') {

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter skip_parse";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;

							} else if (parsed_url_tmp.hash || parsed_url_tmp.protocol || parsed_url_tmp.hostname || parsed_url_tmp.port) {

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter skip_parse " + parsed_url_tmp;
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;

							} else if (parsed_url_tmp.pathname.substr(0, 1) != '/') {


								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter skip_parse " + parsed_url_tmp;
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;

//								skip_url[v] = '/' + parsed_url.pathname + parsed_url.search;

							}
					        }
					}

				}



	
				if ((FeedConfig[0][i][j].hasOwnProperty('only_parse')) && ({}.toString.call(FeedConfig[0][i][j]['only_parse']) !== '[object Array]')) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter only_parse";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {

					var only_url = FeedConfig[0][i].only_parse;

					if (only_url && only_url.length) {
						for (var v in only_url) {
				        		var parsed_url_tmp = parse_url(only_url[v]);
							if (typeof parsed_url_tmp != 'string') {

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter only_parse";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;

							} else if (parsed_url_tmp.hash || parsed_url_tmp.protocol || parsed_url_tmp.hostname || parsed_url_tmp.port) {

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter only_parse " + parsed_url_tmp;
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;

							} else if (parsed_url_tmp.pathname.substr(0, 1) != '/') {

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter only_parse " + parsed_url_tmp;
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;
//								only_url[v] = '/' + parsed_url.pathname + parsed_url.search;

							}
					        }
					}

				}






				if ((FeedConfig[0][i][j].hasOwnProperty('parseUrlFun')) && (typeof FeedConfig[0][i][j]['parseUrlFun'] != 'function')) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter parseUrlFun";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}

				if ((FeedConfig[0][i][j].hasOwnProperty('checkFieldsFun')) && (typeof FeedConfig[0][i][j]['checkFieldsFun'] != 'function')) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter checkFieldsFun";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}



				if ((FeedConfig[0][i][j].hasOwnProperty('MAX_ADD_URLS')) && ((typeof FeedConfig[0][i][j]['MAX_ADD_URLS'] != 'number')||(FeedConfig[0][i][j]['MAX_ADD_URLS'] < 0))) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter MAX_ADD_URLS";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}


				//для каждого фида вычисляем свой No_Critical_Errors
				if (!FeedConfig[0][i][j].hasOwnProperty('No_Critical_Errors')) {
					if (FeedConfig[0][i].hasOwnProperty('No_Critical_Errors')) {
						FeedConfig[0][i][j]['No_Critical_Errors'] = FeedConfig[0][i]['No_Critical_Errors'];
					}
				} else if ((typeof FeedConfig[0][i][j]['No_Critical_Errors'] != 'number')||(FeedConfig[0][i][j]['No_Critical_Errors'] < 0)||(FeedConfig[0][i][j]['No_Critical_Errors'] > 5)) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter No_Critical_Errors";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}


				//для каждого фида вычисляем свой Write_emptyFeed_File
				if (!FeedConfig[0][i][j].hasOwnProperty('Write_emptyFeed_File')) {
					if (FeedConfig[0][i].hasOwnProperty('Write_emptyFeed_File')) {
						FeedConfig[0][i][j]['Write_emptyFeed_File'] = FeedConfig[0][i]['Write_emptyFeed_File'];
					}
				} else if ((typeof FeedConfig[0][i][j]['Write_emptyFeed_File'] != 'number')||(FeedConfig[0][i][j]['Write_emptyFeed_File'] < 0)||(FeedConfig[0][i][j]['Write_emptyFeed_File'] > 2)) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter Write_emptyFeed_File";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}

//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	FeedConfig[0][i][j]['Write_emptyFeed_File'] = 1;
}
				if ((FeedConfig[0][i][j].hasOwnProperty('SKIP_FIRST_URLS')) && ((typeof FeedConfig[0][i][j]['SKIP_FIRST_URLS'] != 'number')||(FeedConfig[0][i][j]['SKIP_FIRST_URLS'] < 0))) {
					//некорректный параметер
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter SKIP_FIRST_URLS";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				}



				var GAS = FeedConfig[0][i][j]['GASearch'];


				if (GAS && ({}.toString.call(GAS) !== '[object Object]')) {
					//настройки GASearch должны быть кешем
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter 'GASearch'";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				} else if (GAS) {


					if (GAS.hasOwnProperty('Id')) {
						if (typeof GAS['Id'] != 'string') {
							//Id в GASearch должен быть строкой
							readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter 'Id' in 'GASearch'";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//						break;
						} else {

							//сохраняем начальное установленное значение (требуется дальше)
							//Idmanual - это признак ручного задания Id, а не автоматического
							//нигде не используется сейчас
							GAS['Idmanual'] = GAS['Id'];

							if (!GAS['Id']) {
								//генерируем название кампании
								GAS['Id'] = FeedConfig[0][i][j]['feedId'];
							}

							//убираем какие-то символы, которые могут вызвать ошибку при создании кампании
							GAS['Id'] = GAS['Id'].replace(/[^\!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\(\)\" ]+/g, '');

							if (GAS['Id'].length > 100) {
								//ограничиваем длину названия кампании, что бы поместилась служебная информация
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " very long (> 100 chars) parameter 'Id' in 'GASearch' " + GAS['Id'];
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//							break;
							}

							//проверяем дубликаты РК по всем сайтам и фидам (так как один аккаунт GAds)
							if (!searchADids.hasOwnProperty(GAS['Id'])) {
								searchADids[GAS['Id']] = 1;
							} else {
								//не должны повторяться Id
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have dublicate parameter 'Id' in 'GASearch' " + GAS['Id'];
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//							break;
							}



							//должен быть указан бюджет
							if ((!GAS.hasOwnProperty('Budget')) || (typeof GAS['Budget'] !== 'number') || (GAS['Budget'] <= 0)) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter 'Budget' in 'GASearch' " + GAS['Id'];
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//							break;
							}




							if (GAS.hasOwnProperty('keyword') && (typeof GAS['keyword'] !== 'string')) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'keyword' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}



							if (GAS.hasOwnProperty('removeOutOfStockItem')) {
								if (!(({}.toString.call(GAS['removeOutOfStockItem']) === '[object Array]')&&(GAS['removeOutOfStockItem'].length == 3))) {
									readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'removeOutOfStockItem' in 'GASearch' ";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}
							}


//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	if (({}.toString.call(GAS['removeOutOfStockItem']) === '[object Array]')&&GAS['removeOutOfStockItem'][0] == 2) {
		GAS['removeOutOfStockItem'][0] = 1;
	}
}


							if (GAS.hasOwnProperty('removeNotFoundItem')) {
								if (typeof GAS['removeNotFoundItem'] != 'number') {
									readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'removeNotFoundItem' in 'GASearch' ";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}
							}


							if (GAS.hasOwnProperty('removeLSVKeywords')) {

								//контролировать наличие и целое число! (добавляется в название группы)

								if ((typeof GAS['removeLSVKeywords'] != 'number')||(!/^\d+$/.test(String(GAS['removeLSVKeywords'])))||(GAS['removeLSVKeywords'] < 0)||(GAS['removeLSVKeywords'] > 2)) {
									readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'removeLSVKeywords' in 'GASearch' ";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}
							} else {
								GAS['removeLSVKeywords'] = 0;
							}


							if (GAS.hasOwnProperty('powerControl')) {
								if (typeof GAS['powerControl'] != 'number') {
									readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'powerControl' in 'GASearch' ";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}
							}


							if ((!(GAS.hasOwnProperty('addkeystype')))||(typeof GAS['addkeystype'] != 'number')||(!/^\d+$/.test(String(GAS['addkeystype'])))||(GAS['addkeystype'] < 0)||(GAS['addkeystype'] > 8)) {

								//контролировать наличие и целое число! (добавляется в название группы)

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'addkeystype' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}


							if ((!(GAS.hasOwnProperty('maxNodigaddkeyNum')))||(typeof GAS['maxNodigaddkeyNum'] != 'number')||(!/^\d+$/.test(String(GAS['maxNodigaddkeyNum'])))||(GAS['maxNodigaddkeyNum'] < 3)) {

								//контролировать наличие и целое число! (добавляется в название группы)

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'maxNodigaddkeyNum' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}


							if ((!(GAS.hasOwnProperty('keywordtypes')))||(typeof GAS['keywordtypes'] != 'number')||(!/^\d+$/.test(String(GAS['keywordtypes'])))||(GAS['keywordtypes'] < 0)||(GAS['keywordtypes'] > 6)) {

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'keywordtypes' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}


							if ((!(GAS.hasOwnProperty('modifykeystype')))||(typeof GAS['modifykeystype'] != 'number')||(!/^\d+$/.test(String(GAS['modifykeystype'])))||(GAS['modifykeystype'] < 0)||(GAS['modifykeystype'] > 3)) {

								//контролировать наличие и целое число! (добавляется в название группы)

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'modifykeystype' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}


							if ((!(GAS.hasOwnProperty('modifykeysEnable')))||(typeof GAS['modifykeysEnable'] != 'number')||(!/^\d+$/.test(String(GAS['modifykeysEnable'])))||(GAS['modifykeysEnable'] < 0)||(GAS['modifykeysEnable'] > 2)) {

								//контролировать наличие и целое число! (добавляется в название группы)

								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'modifykeysEnable' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}

							if ((!GAS['priceRound'])||(typeof GAS['priceRound'] != 'number')||(GAS['priceRound'] < 0)) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'priceRound' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}


							if ((!(GAS.hasOwnProperty('startbid')))||(typeof GAS['startbid'] != 'number')||(GAS['startbid'] <= 0)) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'startbid' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}

							//проверяем обязательные моменты в настройках поисковой РК (если существуют параметры header и price, то проверяем на валидность)


							//обязательный параметр, поэтому добавляем что-то обязательно, если нет его
							if (!GAS.hasOwnProperty('header2')) 
								GAS['header2'] = [parsed_url['hostname']];


//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@

							//обязательный параметр, поэтому добавляем фиксированное значение {Keyword:domain.com}
                                                        //при создании кампаний значение header3 не проверяется, вставляется как есть отсюда, поэтому внимательно его формируем
							var dm = parsed_url['hostname'];
//обрезаем если вдруг длинный домен
							dm = dm.substring(0,30);
							GAS['header3'] = '{KeyWord:' + dm + '}';



							if ((GAS.hasOwnProperty('keysmixtype'))&&((typeof GAS['keysmixtype'] != 'number')||(GAS['keysmixtype'] < 0)||(GAS['keysmixtype'] > 4))) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'keysmixtype' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;
							} else if (!GAS['keysmixtype']) {
								GAS['keysmixtype'] = 0;
							}

							if ((GAS.hasOwnProperty('masskeysmixtype'))&&((typeof GAS['masskeysmixtype'] != 'number')||(GAS['masskeysmixtype'] < 0)||(GAS['masskeysmixtype'] > 4))) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'masskeysmixtype' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;
							} else if (!GAS['masskeysmixtype']) {
								GAS['masskeysmixtype'] = 0;
							}


							if ((GAS.hasOwnProperty('notReqfixedkeys'))&&((typeof GAS['notReqfixedkeys'] != 'number')||(GAS['notReqfixedkeys'] < 0)||(GAS['notReqfixedkeys'] > 4))) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have correct 'notReqfixedkeys' in 'GASearch' ";

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;
							} else if (!GAS['notReqfixedkeys']) {
								GAS['notReqfixedkeys'] = 0;
							}


							var GASparams = ['url','mobileurl','keys','fixedkeys','masskeys','onekeys','header','paths','header2','price','description','afterdescription'];

							GAS.GASparams = [];
							for (var ii = 0; ii < GASparams.length; ii++) {
								if (GAS.hasOwnProperty(GASparams[ii])) {
									var [reterr2,readRes,partype] = parcheck(GASparams[ii],GAS[GASparams[ii]],readRes)
									if (reterr2) {
										readRes += ", Feed number " + j + " in Config Array element number " + i;
										reterr = 1;
									}
									GAS.GASparams[GAS.GASparams.length] = [GASparams[ii],partype];
								} else {
									GAS.GASparams[GAS.GASparams.length] = [GASparams[ii],''];
								}
							}


							//проверка наличия обязательных полей
							if (!GAS['url']) {
								//должна быть хотя бы одна настройка у объявления
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have 'url' in 'GASearch' " + GAS['Id'];

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}

							if (!GAS['GAShtmlAd']) {
								GAS['GAShtmlAd'] = 'Ad';
							} else if (typeof GAS['GAShtmlAd'] != 'string') {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect 'GAShtmlAd' in 'GASearch' " + GAS['Id'];

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;
							}

							if (!GAS['GAShtmlComment']) {
								GAS['GAShtmlComment'] = 'Examples of keywords. Will be filtered when added to a campaign';
							} else if (typeof GAS['GAShtmlComment'] != 'string') {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect 'GAShtmlComment' in 'GASearch' " + GAS['Id'];

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;
							}

							if (!GAS['GAShtmlExt']) {
								GAS['GAShtmlExt'] = '';
							} else if (typeof GAS['GAShtmlExt'] != 'string') {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect 'GAShtmlExt' in 'GASearch' " + GAS['Id'];

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;
							} else if (/^\s+$/.test(GAS['GAShtmlExt'])) {
								GAS['GAShtmlExt'] = '';
							} else if (!/^\s/.test(GAS['GAShtmlExt'])) {
								//добавляем пробел вначале
								GAS['GAShtmlExt'] = ' ' + GAS['GAShtmlExt'];
							}


							GAS['adids'] = [];

							var adsnum = 0;

							//проверяем настройки объявлений поисковой рекламы
							for (var k in GAS) {
								//только целые числа-строки пропускаем сейчас (объявления)
								//							if (!isInteger(k))
								//только id + целые числа пропускаем сейчас (объявления)
								if (!(((typeof k == 'string') && (/^id\d+$/.test(k)))))
									continue

								if ({}.toString.call(GAS[k]) !== '[object Object]') {
									//должен быть хеш у объявления
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not Hash";
									reterr = 1;
									break;
								}

								if (!GAS[k].hasOwnProperty('priceaddtype')) {
									//если закомментировано, то ставим 0
									GAS[k]['priceaddtype'] = 0;
								}


								var GASADparams = ['header','paths','header2','keys','fixedkeys','masskeys','onekeys','startdescription','description','beforeprice','afterprice','afterdescription'];
								GAS[k].GASADparams = [];
								for (var ii = 0; ii < GASADparams.length; ii++) {
									if (GAS[k].hasOwnProperty(GASADparams[ii])) {
										var [reterr2,readRes,partype] = parcheck(GASADparams[ii],GAS[k][GASADparams[ii]],readRes)
										if (reterr2) {
											readRes += ", Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i;
											reterr = 1;
										}
										GAS[k].GASADparams[GAS[k].GASADparams.length] = [GASADparams[ii],partype];
									} else {
										GAS[k].GASADparams[GAS[k].GASADparams.length] = [GASADparams[ii],''];
									}
								}




								//проверяем обязательные моменты в настройках объявлений


								//параметры из основных настроек РК
								GAS[k]['FromGAS'] = {};

								if (!GAS[k].hasOwnProperty('header')) {
									if (GAS.hasOwnProperty('header')) {
										GAS[k]['header'] = GAS['header'];
									}
									GAS[k]['FromGAS']['header'] = 1;
								}

								if (!GAS[k].hasOwnProperty('paths')) {
									if (GAS.hasOwnProperty('paths')) {
										GAS[k]['paths'] = GAS['paths'];
									}
									GAS[k]['FromGAS']['paths'] = 1;
								}

								if (!GAS[k].hasOwnProperty('header2')) {
									if (GAS.hasOwnProperty('header2')) {
										GAS[k]['header2'] = GAS['header2'];
									}
									GAS[k]['FromGAS']['header2'] = 1;
								}


								if (!GAS[k].hasOwnProperty('addkeystype')) {
									if (GAS.hasOwnProperty('addkeystype')) {
										GAS[k]['addkeystype'] = GAS['addkeystype'];
									}
									GAS[k]['FromGAS']['addkeystype'] = 1;
								}


								if (!GAS[k].hasOwnProperty('maxNodigaddkeyNum')) {
									if (GAS.hasOwnProperty('maxNodigaddkeyNum')) {
										GAS[k]['maxNodigaddkeyNum'] = GAS['maxNodigaddkeyNum'];
									}
									GAS[k]['FromGAS']['maxNodigaddkeyNum'] = 1;
								}


								if (!GAS[k].hasOwnProperty('keys')) {
									if (GAS.hasOwnProperty('keys')) {
										GAS[k]['keys'] = GAS['keys'];
									}
									GAS[k]['FromGAS']['keys'] = 1;
								}

								if (!GAS[k].hasOwnProperty('fixedkeys')) {
									if (GAS.hasOwnProperty('fixedkeys')) {
										GAS[k]['fixedkeys'] = GAS['fixedkeys'];
									}
									GAS[k]['FromGAS']['fixedkeys'] = 1;
								}


								if (!GAS[k].hasOwnProperty('masskeys')) {
									if (GAS.hasOwnProperty('masskeys')) {
										GAS[k]['masskeys'] = GAS['masskeys'];
									}
									GAS[k]['FromGAS']['masskeys'] = 1;
								}


								if (!GAS[k].hasOwnProperty('onekeys')) {
									if (GAS.hasOwnProperty('onekeys')) {
										GAS[k]['onekeys'] = GAS['onekeys'];
									}
									GAS[k]['FromGAS']['onekeys'] = 1;
								}


								if (!GAS[k].hasOwnProperty('description')) {
									if (GAS.hasOwnProperty('description')) {
										GAS[k]['description'] = GAS['description'];
									}
									GAS[k]['FromGAS']['description'] = 1;
								}


								if (!GAS[k].hasOwnProperty('afterdescription')) {
									if (GAS.hasOwnProperty('afterdescription')) {
										GAS[k]['afterdescription'] = GAS['afterdescription'];
									}
									GAS[k]['FromGAS']['afterdescription'] = 1;
								}

								if (!GAS[k].hasOwnProperty('noPaths')) {
									if (GAS.hasOwnProperty('noPaths')) {
										GAS[k]['noPaths'] = GAS['noPaths'];
									}
									GAS[k]['FromGAS']['noPaths'] = 1;
								}


								if (!GAS[k].hasOwnProperty('afterdescrNeed')) {
									if (GAS.hasOwnProperty('afterdescrNeed')) {
										GAS[k]['afterdescrNeed'] = GAS['afterdescrNeed'];
									}
									GAS[k]['FromGAS']['afterdescrNeed'] = 1;
								}


								if (!GAS[k].hasOwnProperty('keysmixtype')) {
									if (GAS.hasOwnProperty('keysmixtype')) {
										GAS[k]['keysmixtype'] = GAS['keysmixtype'];
									}
									GAS[k]['FromGAS']['keysmixtype'] = 1;
								}

								if (!GAS[k].hasOwnProperty('masskeysmixtype')) {
									if (GAS.hasOwnProperty('masskeysmixtype')) {
										GAS[k]['masskeysmixtype'] = GAS['masskeysmixtype'];
									}
									GAS[k]['FromGAS']['masskeysmixtype'] = 1;
								}


								if (!GAS[k].hasOwnProperty('notReqfixedkeys')) {
									if (GAS.hasOwnProperty('notReqfixedkeys')) {
										GAS[k]['notReqfixedkeys'] = GAS['notReqfixedkeys'];
									}
									GAS[k]['FromGAS']['notReqfixedkeys'] = 1;
								}

								if (!GAS[k].hasOwnProperty('requiredescr')) {
									if (GAS.hasOwnProperty('requiredescr')) {
										GAS[k]['requiredescr'] = GAS['requiredescr'];
									}
									GAS[k]['FromGAS']['requiredescr'] = 1;
								}

								if (!GAS[k].hasOwnProperty('keyword')) {
									if (GAS.hasOwnProperty('keyword')) {
										GAS[k]['keyword'] = GAS['keyword'];
									}
									GAS[k]['FromGAS']['keyword'] = 1;
								}

								//header проверяем на уровне объявлений
								if (!GAS[k]['header']) {
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have parameter header";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}

								//keys проверяем на уровне объявлений (может отсутсвовать, если есть masskeys или onekeys)
								if ((!GAS[k]['keys'])&&(!GAS[k]['masskeys'])&&(!GAS[k]['onekeys'])) {
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have parameter keys";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}

								if ((!GAS[k].hasOwnProperty('priceaddtype'))||(typeof GAS[k]['priceaddtype'] != 'number')) {
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have correct parameter priceaddtype";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}

								if ((GAS[k].hasOwnProperty('headerTo1Line'))&&(typeof GAS[k]['headerTo1Line'] != 'number')) {
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have correct parameter headerTo1Line";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								}


								//addkeystype проверяем на уровне объявлений и на уровне кампании тоже
								if ((!(GAS[k].hasOwnProperty('addkeystype')))||(typeof GAS[k]['addkeystype'] != 'number')||(!/^\d+$/.test(String(GAS[k]['addkeystype'])))||(GAS[k]['addkeystype'] < 0)||(GAS[k]['addkeystype'] > 8)) {

									//контролировать наличие и целое число! (добавляется в название группы)
			
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have correct parameter addkeystype";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;

								}


								//maxNodigaddkeyNum проверяем на уровне объявлений и на уровне кампании тоже
								if ((!(GAS[k].hasOwnProperty('maxNodigaddkeyNum')))||(typeof GAS[k]['maxNodigaddkeyNum'] != 'number')||(!/^\d+$/.test(String(GAS[k]['maxNodigaddkeyNum'])))||(GAS[k]['maxNodigaddkeyNum'] < 3)) {

									//контролировать наличие и целое число! (добавляется в название группы)

									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have correct parameter maxNodigaddkeyNum";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;

								}


								//keysmixtype проверяем на уровне объявлений и на уровне кампании тоже
								if ((GAS[k].hasOwnProperty('keysmixtype'))&&(!GAS[k]['FromGAS']['keysmixtype'])&&((typeof GAS[k]['keysmixtype'] != 'number')||(GAS[k]['keysmixtype'] < 0)||(GAS[k]['keysmixtype'] > 4))) {
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have correct parameter keysmixtype";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								} else if (!GAS[k]['keysmixtype']) {
									GAS[k]['keysmixtype'] = 0;
								}

								//masskeysmixtype проверяем на уровне объявлений и на уровне кампании тоже
								if ((GAS[k].hasOwnProperty('masskeysmixtype'))&&(!GAS[k]['FromGAS']['masskeysmixtype'])&&((typeof GAS[k]['masskeysmixtype'] != 'number')||(GAS[k]['masskeysmixtype'] < 0)||(GAS[k]['masskeysmixtype'] > 4))) {
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have correct parameter masskeysmixtype";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								} else if (!GAS[k]['masskeysmixtype']) {
									GAS[k]['masskeysmixtype'] = 0;
								}


								//notReqfixedkeys проверяем на уровне объявлений и на уровне кампании тоже
								if ((GAS[k].hasOwnProperty('notReqfixedkeys'))&&(!GAS[k]['FromGAS']['notReqfixedkeys'])&&((typeof GAS[k]['notReqfixedkeys'] != 'number')||(GAS[k]['notReqfixedkeys'] < 0)||(GAS[k]['notReqfixedkeys'] > 4))) {
									readRes += "\n" + "Ad number " + k + " in 'GASearch' in Feed number " + j + " in Config Array element number " + i + " is not have correct parameter notReqfixedkeys";

									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//								break;
								} else if (!GAS[k]['notReqfixedkeys']) {
									GAS[k]['notReqfixedkeys'] = 0;
								}

								GAS['adids'][GAS['adids'].length] = k;

								adsnum++;

							}


							if (!adsnum) {
								//должно быть хотя бы одно объявление
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " not have ads in 'GASearch' " + GAS['Id'];

								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//								break;

							}



						}


					}


					if (GAS.hasOwnProperty('GAShtml')) {
						if ((typeof GAS['GAShtml'] != 'number')||(GAS['GAShtml'] > 2)||(GAS['GAShtml'] < 0)) {
							readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " have incorrect parameter 'GAShtml' in 'GASearch'";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//						break;
						}
						//добавляем параметры для фида GAShtml
						FeedConfig[0][i][j]['GAShtmlForfeed'] = [GAS['GAShtmlAd'], GAS['GAShtmlComment'], GAS['GAShtmlExt'], parsed_url['hostname'] + '/']

					}

					//здесь уже должен быть GAS['Id'], если он раскомментирован и пустой
					if (!GAS['Id']) {
						if (GAS.hasOwnProperty('GAShtml')) {
							//обязательно удаляем, нет GAS['Id'], иначе пропустит дальше без проверки полей, если вдруг захочется отдельно запускать GAShtml то нужно что бы поля рекламы проверялись
							delete GAS['GAShtml']
						}
					}



				}


				if (FeedConfig[0][i][j]['all_fields_not_required']&&FeedConfig[0][i][j].hasOwnProperty('GASearch')) {
					//удаляем поиск, иначе возникнут ошибки при выполнении
					delete FeedConfig[0][i][j]['GASearch'];
					if (FeedConfig[0][i][j]['GAShtmlForfeed'])
						delete FeedConfig[0][i][j]['GAShtmlForfeed'];
				}



				var same_field_name_attrs = {};

				//проверка что хотя бы одно поле видимое в фиде (если нет заданий это подсказка)
				FeedConfig[0][i][j]['onefieldvisible'] = 0

				var fieldsnum = 0;
				//дальше просто проверка, что есть хотя бы одно поле у фида
				for (var k in FeedConfig[0][i][j]) {
					//только целые числа-строки пропускаем сейчас (поля фида)
					//				if (!isInteger(k))
					//только id + целые числа пропускаем сейчас (поля фида)
					if (!(((typeof k == 'string') && (/^id\d+$/.test(k)))))
						continue
					if ({}.toString.call(FeedConfig[0][i][j][k]) !== '[object Object]') {
						//должен быть хеш у поля фида
						readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " is not Hash";
						reterr = 1;
						break;
					}


					//добавляем признак поля фида, названия/ключи хеша фида, которые являются ключами хешей/идентификаторами полей в фиде
					if (!FeedConfig[0][i][j]['fields']) {
						FeedConfig[0][i][j]['fields'] = {};
					}
					FeedConfig[0][i][j]['fields'][k] = 1;



					//проверка, что есть хотя бы одна настройка у поля фида (field_name)
					if (!FeedConfig[0][i][j][k].hasOwnProperty('field_name')) {
						//должна быть хотя бы одна настройка у поля фида сайта
						readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " is not have field_name";
						reterr = 1;
						//можно идти дальше, что бы весь конфиг проверить
						//					break;
					} else {
						if (typeof FeedConfig[0][i][j][k]['field_name'] != 'string') {
							//field_name должно быть строкой
							readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter field_name";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//					break;
						} else {
							if (FeedConfig[0][i][j][k].hasOwnProperty('multifield_name')) {
								if ((typeof FeedConfig[0][i][j][k]['multifield_name'] != 'string')||(!FeedConfig[0][i][j][k]['multifield_name'])) {
									readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter multifield_name";
									reterr = 1;
									//можно идти дальше, что бы весь конфиг проверить
									//					break;
								} else {
									if (FeedConfig[0][i][j][k]['multifield_name'].length > FeedConfig[0][i][j][k]['field_name'].length) {
										readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter multifield_name";
										reterr = 1;
										//можно идти дальше, что бы весь конфиг проверить
										//					break;
									} else if (FeedConfig[0][i][j][k]['field_name'].slice(0, FeedConfig[0][i][j][k]['multifield_name'].length) !== FeedConfig[0][i][j][k]['multifield_name']) {
//multifield_name должен быть началом параметра field_name
										readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter multifield_name";
										reterr = 1;
										//можно идти дальше, что бы весь конфиг проверить
										//					break;
									}
								}
							}
						}
					}
	

					//делаем другие обязательные проверки


					if (FeedConfig[0][i][j][k].hasOwnProperty('field_visible')) {
						if (typeof FeedConfig[0][i][j][k]['field_visible'] != 'number') {
							readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter field_visible";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//						break;
						}
					} else {
						FeedConfig[0][i][j][k]['field_visible'] = 0;
					}


				
					if (FeedConfig[0][i][j][k]['field_visible']) {
						FeedConfig[0][i][j]['onefieldvisible'] = 1;
						if (FeedConfig[0][i][j][k].hasOwnProperty('file_type')) {
							var file_type = FeedConfig[0][i][j][k]['file_type'];
							if ({}.toString.call(file_type) !== '[object Array]') {
								readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter file_type";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//						break;
							} else {
								for (var ii = 0; ii < file_type.length; ii++) {
									if ((typeof file_type[ii] != 'string') || (correctfeedExt.indexOf(file_type[ii]) == -1)) {
										readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter file_type";
										reterr = 1;
										//можно идти дальше, что бы весь конфиг проверить
										//								break;
									}
								}
							}
						} else if (FeedConfig[0][i][j].hasOwnProperty('file_type')) {
							FeedConfig[0][i][j][k]['file_type'] = FeedConfig[0][i][j]['file_type'];
						}
					} else {
						//удаляем file_type если есть (можно присвоить undefined, без разницы)
						FeedConfig[0][i][j][k]['file_type'] = [];
					}


					//проверяем, что у одинаковых по названию полей должны быть одинаковые field_visible и file_type
					if (FeedConfig[0][i][j][k]['multifield_name']&&(typeof FeedConfig[0][i][j][k]['multifield_name'] == 'string')) {
						if (!same_field_name_attrs.hasOwnProperty(FeedConfig[0][i][j][k]['multifield_name'])) {
							same_field_name_attrs[FeedConfig[0][i][j][k]['multifield_name']] = JSON.stringify(FeedConfig[0][i][j][k]['field_visible']) + "\t" + JSON.stringify(FeedConfig[0][i][j][k]['file_type']);
						} else if ( same_field_name_attrs[FeedConfig[0][i][j][k]['multifield_name']] !== JSON.stringify(FeedConfig[0][i][j][k]['field_visible']) + "\t" + JSON.stringify(FeedConfig[0][i][j][k]['file_type']) ) {
							readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter field_visible or file_type (not equal to another same multifield_name)";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//						break;
						}
						
					} else if (FeedConfig[0][i][j][k]['field_name']&&(typeof FeedConfig[0][i][j][k]['field_name'] == 'string')) {
						if (!same_field_name_attrs.hasOwnProperty(FeedConfig[0][i][j][k]['field_name'])) {
							same_field_name_attrs[FeedConfig[0][i][j][k]['field_name']] = JSON.stringify(FeedConfig[0][i][j][k]['field_visible']) + "\t" + JSON.stringify(FeedConfig[0][i][j][k]['file_type']);
						} else if ( same_field_name_attrs[FeedConfig[0][i][j][k]['field_name']] !== JSON.stringify(FeedConfig[0][i][j][k]['field_visible']) + "\t" + JSON.stringify(FeedConfig[0][i][j][k]['file_type']) ) {
							readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter field_visible or file_type (not equal to another same field_name)";
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//						break;
						}
					}




//выше уже проверены/установлены field_name multifield_name file_type для текущего поля
//в этом блоке делаются два действия
//	1.создание хеша фида feed_fields_file_types - состоит из списка типов расширений, которые в свою очередь состоят из списка названий полей field_name/multifield_name, входящих в эти расширения (поля multifield_name в свою очередь состоят из списка field_name)
//	2.проверка дублирования field_name и multifield_name в разных полях фида (поэтому всегда добавлен тип 'CheckAlwaysExistNoext', который потом удаляется)
//этот блок нужен для формирования файлов фидов, поэтому в хеш вносятся списки хешей названий полей для каждого файла фида:
//									если есть multifield_name, то вносится multifield_name и массив относящихся к нему field_name,
//									если нет multifield_name, то вносится field_name
					if (!FeedConfig[0][i][j]['feed_fields_file_types'])
						FeedConfig[0][i][j]['feed_fields_file_types']={}
					if ({}.toString.call(FeedConfig[0][i][j][k]['file_type']) === '[object Array]') {
						var file_type = JSON.parse(JSON.stringify(FeedConfig[0][i][j][k]['file_type']));
						file_type[file_type.length] = 'CheckAlwaysExistNoext';
					} else {
						var file_type = ['CheckAlwaysExistNoext'];
					}
					var field_name = FeedConfig[0][i][j][k]['field_name'];
					var multifield_name = FeedConfig[0][i][j][k]['multifield_name'];
					var feed_fields_file_types = FeedConfig[0][i][j]['feed_fields_file_types'];
					if ((typeof field_name == 'string')&&((typeof multifield_name == 'string')||(typeof multifield_name == 'undefined'))) {
						for (var ii = 0; ii < file_type.length; ii++) {
							if (typeof file_type[ii] == 'string') {
								if (!feed_fields_file_types[file_type[ii]])
									feed_fields_file_types[file_type[ii]] = {};
								var file_type_hash = feed_fields_file_types[file_type[ii]];
								if (multifield_name) {
									if (file_type_hash.hasOwnProperty(multifield_name)) {
										if ({}.toString.call(file_type_hash[multifield_name]) != '[object Array]') {
											readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter multifield_name (equal to param field_name form another feed field)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//	break;// здесь надо делать двойной выход из двух циклов

											break; //этот break не связан с закомментированным break выше
										}
									} else {
										file_type_hash[multifield_name] = [];
									}
									if (file_type_hash[multifield_name].indexOf(field_name) == -1)
										file_type_hash[multifield_name][file_type_hash[multifield_name].length] = field_name;
								} else {
									if (file_type_hash.hasOwnProperty(field_name)) {
										if (typeof file_type_hash[field_name] != 'number') {
											readRes += "\n" + "Field number " + k + " in Feed number " + j + " in Config Array element number " + i + " have incorrect parameter field_name (equal to param multifield_name form another feed field)";
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//	break;// здесь надо делать двойной выход из двух циклов
								
											break; //этот break не связан с закомментированным break выше
										}
									}
									file_type_hash[field_name] = 1;
								}
							}
						}
					}







					if ((!FeedConfig[0][i][j][k].hasOwnProperty('htmlencode')) && (FeedConfig[0][i][j].hasOwnProperty('htmlencode')))
						FeedConfig[0][i][j][k]['htmlencode'] = FeedConfig[0][i][j]['htmlencode'];



					if (FeedConfig[0][i][j]['all_fields_not_required']) {
						FeedConfig[0][i][j][k]['field_required'] = 0;

/*
поле всегда необязательное.
что бы не получилось других вариантов из-за строки в field_required - поэтому закомментировано здесь и вставлено выше 

						if (FeedConfig[0][i][j][k].hasOwnProperty('field_required')) {
							if (typeof FeedConfig[0][i][j][k]['field_required'] == 'number') {
								//только числа изменяем, строка - это необязатальное поле
								FeedConfig[0][i][j][k]['field_required'] = 0;
							}
						} else {
							FeedConfig[0][i][j][k]['field_required'] = 0;
						}
*/
					}



					fieldsnum++;
				}


				if (FeedConfig[0][i][j]['feed_fields_file_types']) {
//после проверки дублирования field_name и multifield_name в разных полях фида больше не нужен элемент 'CheckAlwaysExistNoext'
					delete FeedConfig[0][i][j]['feed_fields_file_types']['CheckAlwaysExistNoext'];
				} else {
					FeedConfig[0][i][j]['feed_fields_file_types']={};
				}

				feedsnum++;
				if (!fieldsnum) {
					//должно быть хотя бы одно поле у фида сайта
					readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " is not have fields";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;
				}
			}

			if (!FeedConfig[0][i]['timeHours'].length) {
				//если не заполнено фидами, то заполняем значения по умолчанию
				//такое возможно в некоторых ситуациях
				FeedConfig[0][i]['timeHours'] = JSON.parse(JSON.stringify(timeHours));
				FeedConfig[0][i]['timeHoursHash'] = JSON.parse(JSON.stringify(timeHoursHash));
			}


			if (!FeedConfig[0][i]['startDays']) {
				//если не заполнено фидами, то заполняем значения по умолчанию
				//такое возможно в некоторых ситуациях
				FeedConfig[0][i]['startDays'] = JSON.parse(JSON.stringify(startDays));
				FeedConfig[0][i]['startDaysHash'] = JSON.parse(JSON.stringify(startDaysHash));
			}



			if (!feedsnum) {
				//должен быть хотя бы один фид у сайта
				readRes += "\n" + "Config Array element number " + i + " is not have feeds";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			} else {
				for (var j in FeedConfig[0][i]['feeds']) {

					if (FeedConfig[0][i][j]['GASearch']&&FeedConfig[0][i][j]['GASearch']['GAShtml']) {
						FeedConfig[0][i][j]['onefieldvisible'] = 1;
					}

					if (!((FeedConfig[0][i][j]['GASearch']&&FeedConfig[0][i][j]['GASearch']['Id'])||(Object.keys(FeedConfig[0][i][j]['feed_fields_file_types']).length)||(FeedConfig[0][i][j]['GASearch']&&FeedConfig[0][i][j]['GASearch']['GAShtml']))) {
//нет никакого задания на выполнение (нет заданий на создание файлов фида или создание поисковой кампании)

						if (!(FeedConfig[0][i][j]['childrenFeeds']&&FeedConfig[0][i][j]['childrenFeeds'].length)) {
//а так же у фида нет дочерних фидов, что по сути тоже является заданием (если дочерние фиды используют поля родительского - то есть родитель раздает поля детям)
							if (FeedConfig[0][i][j]['onefieldvisible']) {
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " is not have jobs (create feed and/or create search company and/or have children feeds) ";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//				break;
							} else {
//специально подсказка что нет ни одного видимого поля в фиде
								readRes += "\n" + "Feed number " + j + " in Config Array element number " + i + " is not have jobs (create feed with VISIBLE fields and/or create search company and/or have children feeds) ";
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//				break;
							}
						}

					}
				}
			}




			FeedConfig[0][i]['feedsFullExts'] = {}
			//добавляем признак полного расширения фида, для быстрой проверки наличия расширения в скане (для удаления файлов)
			for (var j in FeedConfig[0][i]['feeds']) {
				for (var feed_file_ext in FeedConfig[0][i][j]['feed_fields_file_types']) {
//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'
					FeedConfig[0][i]['feedsFullExts'][FeedConfig[0][i][j]['ext'] + feed_file_ext] = 1
				}
				if (FeedConfig[0][i][j]['GASearch']&&FeedConfig[0][i][j]['GASearch']['GAShtml'])
					FeedConfig[0][i]['feedsFullExts'][FeedConfig[0][i][j]['ext'] + '.gas.html'] = 1
			}

			//pausedFeedsIds используется только для анализа запуска фидов (эти не запускать)
			FeedConfig[0][i]['pausedFeedsIds'] = {}
			//pausedFeedsFullExts используется только для анализа удаления файлов фидов (сюда нужно добавлять GAShtml расширение)
			FeedConfig[0][i]['pausedFeedsFullExts'] = {}
			if (FeedConfig[0][i].hasOwnProperty('pausedFeeds')) {
				if (typeof FeedConfig[0][i]['pausedFeeds'] != 'string') {
					//некорректный параметр timeHours
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter pausedFeeds";
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//			break;
				} else {
					var pausedFeeds = FeedConfig[0][i]['pausedFeeds'].split(/[\s\,]+/);
					var pausedFeedsIds = FeedConfig[0][i]['pausedFeedsIds']
					for (var ii = 0; ii < pausedFeeds.length; ii++) {
						var pausedFeedId = pausedFeeds[ii];
//						if (FeedConfig[0][i][pausedFeedId]) {
						if (FeedConfig[0][i]['feeds'][pausedFeedId]) {
							if (!pausedFeedsIds[pausedFeedId]) {
								pausedFeedsIds[pausedFeedId] = 1
								//формируем массив названий файлов остановленных фидов скана
								for (var feed_file_ext in FeedConfig[0][i][pausedFeedId]['feed_fields_file_types']) {
//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'
									FeedConfig[0][i]['pausedFeedsFullExts'][FeedConfig[0][i][pausedFeedId]['ext'] + feed_file_ext] = 1
								}
								if (FeedConfig[0][i][pausedFeedId]['GASearch']&&FeedConfig[0][i][pausedFeedId]['GASearch']['GAShtml'])
									FeedConfig[0][i]['pausedFeedsFullExts'][FeedConfig[0][i][pausedFeedId]['ext'] + '.gas.html'] = 1
								if (FeedConfig[0][i][pausedFeedId]['childrenFeeds']&&FeedConfig[0][i][pausedFeedId]['childrenFeeds'].length) {
									//это родительский фид, проверяем что все дети остановлены у него
									var childrenFeeds = FeedConfig[0][i][pausedFeedId]['childrenFeeds'];
									for (var iii = 0; iii < childrenFeeds.length; iii++) {
										var childrenFeed = childrenFeeds[iii];
										if (FeedConfig[0][i][childrenFeed]&&(pausedFeeds.indexOf(childrenFeed) == -1)) {
											//некорректный параметр timeHours
											readRes += "\n" + "Config Array element number " + i + ' not have paused children feed ' + childrenFeed + ' in parameter pausedFeeds for paused parent feed ' + pausedFeedId;
											reterr = 1;
											//можно идти дальше, что бы весь конфиг проверить
											//			break;
										}
									}
								}
							} else {
								//некорректный параметр pausedFeeds
								readRes += "\n" + "Config Array element number " + i + " have dublicate in parameter pausedFeeds: " + pausedFeedId;
								reterr = 1;
								//можно идти дальше, что бы весь конфиг проверить
								//			break;
							}
						} else {
							//некорректный параметр pausedFeeds
							readRes += "\n" + "Config Array element number " + i + " have incorrect parameter pausedFeeds. Not found feed: " + pausedFeedId;
							reterr = 1;
							//можно идти дальше, что бы весь конфиг проверить
							//			break;
						}
					}
				}
			}


if (CONTROL_EMPTY_FEEDS) {
	//этот фрагмент отсутствует в скрипте тестового парсинга
	FeedConfig[0][i]['pausedFeedsIds'] = {}
	FeedConfig[0][i]['pausedFeedsFullExts'] = {}
}



			if ((!FeedConfig[0][i]['Id']) || (typeof FeedConfig[0][i]['Id'] != 'string')) {
				//идентификаторы сайтов должны быть непустой строкой
				if (existId) {
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter Id for site";
				} else {
//так как разрешено дублировать сайты, то нужно указать разные Id вручную
					readRes += "\n" + "Config Array element number " + i + " have incorrect parameter Id for site (not empty Id for dublicate hostname)";
				}
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			} else if (!scanids.hasOwnProperty(FeedConfig[0][i]['Id'])) {
				//записываем очередной идентификатор сайта
				try {
					if (CONTROL_EMPTY_FEEDS) {
						//этот фрагмент отсутствует в скрипте тестового парсинга
						scanids[FeedConfig[0][i]['Id']] = {
							Id: FeedConfig[0][i]['Id'],
							IdNum: i,
							timeHours: FeedConfig[0][i]['timeHours'],
							startDays: FeedConfig[0][i]['startDays'],
							priorityLev: FeedConfig[0][i]['priorityLev'],
							checksum: murmurhash3_32_gc(JSON.stringify(ClearConfig[i])+'ag246dsfgsdgw34653456346')
						};
					} else {
						scanids[FeedConfig[0][i]['Id']] = {
							Id: FeedConfig[0][i]['Id'],
							IdNum: i,
							timeHours: FeedConfig[0][i]['timeHours'],
							startDays: FeedConfig[0][i]['startDays'],
							priorityLev: FeedConfig[0][i]['priorityLev'],
							checksum: murmurhash3_32_gc(JSON.stringify(ClearConfig[i]))
						};
					}
				} catch (e) {

					readRes += "\n" + "Config Array element number " + i + " have bad structure for JSON.stringify: " + e.message;
					reterr = 1;
					//можно идти дальше, что бы весь конфиг проверить
					//				break;

				}

			} else {
				//не должны повторяться идентификаторы сайтов
				readRes += "\n" + "Config Array element number " + i + " have dublicate parameter Id for site";
				reterr = 1;
				//можно идти дальше, что бы весь конфиг проверить
				//			break;
			}


			//добавляем карту ссылок фидов (только в этом скрипте, не в программе тестового парсинга)
			for (var j in FeedConfig[0][i]['feeds']) {
				var test = 0;
				if (FeedConfig[0][i][j]['timeHours']&&(FeedConfig[0][i][j]['timeHours'].indexOf('test') != -1)) {
					test = 1;
				} else {
					var stHs = 'Hours: ' + FeedConfig[0][i][j]['timeHours'].join(',')
					if (FeedConfig[0][i][j]['startDays'].length) {
						var stDs = 'Days: ' + FeedConfig[0][i][j]['startDays'].join(',');
					} else {
						var stDs = 'Every day';
					}
				}
				for (var feed_file_ext in FeedConfig[0][i][j]['feed_fields_file_types']) {
					if (test) {
						mapurls += FeedConfig[0][i]['Id'] + ' ' + j + ' (test only) https://cdn.sale-storm.com/wd/files/' + IDName + '.' + FeedConfig[0][i][j]['feedId'] + feed_file_ext + "\n";
					} else {
						mapurls += FeedConfig[0][i]['Id'] + ' ' + j + ' ' + stDs + ' ' + stHs + ' https://cdn.sale-storm.com/wd/files/' + IDName + '.' + FeedConfig[0][i][j]['feedId'] + feed_file_ext + "\n";
					}
				}
				if (FeedConfig[0][i][j]['GASearch']&&FeedConfig[0][i][j]['GASearch']['GAShtml']) {
					if (test) {
						mapurls += FeedConfig[0][i]['Id'] + ' ' + j + ' (test only) https://cdn.sale-storm.com/wd/files/' + IDName + '.' + FeedConfig[0][i][j]['feedId'] + '.gas.html' + "\n";
					} else {
						mapurls += FeedConfig[0][i]['Id'] + ' ' + j + ' ' + stDs + ' ' + stHs + ' https://cdn.sale-storm.com/wd/files/' + IDName + '.' + FeedConfig[0][i][j]['feedId'] + '.gas.html' + "\n";
					}
				}

			}
			mapurls += 'https://cdn.sale-storm.com/wd/files/' + IDName + '.' + 'excluded_goods.txt' + "\n";
			mapurls += 'https://cdn.sale-storm.com/wd/files/' + IDName + '.' + 'excluded_pages_conotall.txt' + "\n";



		}



	}




	if (!reterr) {
		try {
			if (CONTROL_EMPTY_FEEDS) {
				//этот фрагмент отсутствует в скрипте тестового парсинга
				configChecksum = murmurhash3_32_gc(JSON.stringify(ClearConfig)+'sdgsh2345fhdfhdfhhdfh5555');
			} else {
				configChecksum = murmurhash3_32_gc(JSON.stringify(ClearConfig));
			}
			readRes += "\n" + "Ok. Config checksum: " + configChecksum;

		} catch (e) {
			readRes += "\n" + "Config have bad structure for JSON.stringify: " + e.message;
			reterr = 1;
		}
	}

	if (reterr) {
		readRes += "\n" + "Config is not working . Exit";
	}



	if (CSVwarnings) {
		if (reterr) {
			readRes = "Warning, dublicate csv-lists:" + CSVwarnings + "\n\nERRORS:\n" + readRes;
		} else {
			readRes = "Warning, dublicate csv-lists:" + CSVwarnings + "\n\n" + readRes;
		}
	}


	if (onlycheck) {
		Logger.log("Checked new configuration:\n" + readRes);
		return [reterr, FeedConfig[0], scanids, configChecksum, configChangeFLG, configFolder, ClearConfig, readRes];
	}



	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		//записываем отчет по результату чтения конфига (нужно в т.ч. как флаг в другом скрипте для удаления всех файлов сайта при окончании договора и затем удалить его самого)
		var confFileReport = IDName + '.confreport.txt';
		var fileData = '';
		var fileIter = filesfolder.getFilesByName(confFileReport);
		var filesN = 0;
		while (fileIter.hasNext()) {
			fileData = fileIter.next().getBlob().getDataAsString();
			filesN++;
		}

		if ((fileData != readRes) || (filesN > 1)) {
			//записываем только если есть изменения (что бы каждый час не передавало файлы)
			var confFileReportid = filesfolder.getFilesByName(confFileReport);
			while (confFileReportid.hasNext()) {
				var nfile = confFileReportid.next();
				//filesfolder.removeFile(nfile);
				deleteOrRemoveFile(nfile)
			}
			checkSaveFile(filesfolder.createFile(confFileReport, readRes), readRes);
			//заодно передаем информацию, что конфиг изменился
			configChangeFLG = 1;
		}


	}


	if ((!reterr)&&mapFile) {
		//записываем карту ссылок всех фидов
		var fileData = '';
		var fileIter = configFolder.getFilesByName(mapFile);
		var filesN = 0;
		while (fileIter.hasNext()) {
			fileData = fileIter.next().getBlob().getDataAsString();
			filesN++;
		}

		if ((fileData != mapurls) || (filesN > 1)) {
			//записываем только если есть изменения (что бы каждый час не передавало файлы)
			var confFileReportid = configFolder.getFilesByName(mapFile);
			while (confFileReportid.hasNext()) {
				var nfile = confFileReportid.next();
				//configFolder.removeFile(nfile);
				deleteOrRemoveFile(nfile)
			}
			checkSaveFile(configFolder.createFile(mapFile, mapurls), mapurls);
		}

/*
это лишнее
		if (AdWordsApp.getExecutionInfo().isPreview()) {
			if (mapurls) {
				Logger.log("FeedsMap\n" + mapurls);
			} else {
				Logger.log('Not exist FeedsMap');
			}
		}
*/

	}




	var scanresultFileErrorsReport = IDName + '.errorconf.txt';
	var fileData = '';
	var fileIter = filesfolder.getFilesByName(scanresultFileErrorsReport);
	var filesN = 0;
	while (fileIter.hasNext()) {
		fileData = fileIter.next().getBlob().getDataAsString();
		filesN++;
	}

	if (reterr) {
		//запись ошибок конфига сайта (обязательно в т.ч. в режиме просмотра)

		if ((fileData != readRes) || (filesN > 1)) {
			//записываем только если есть изменения (что бы каждый час не передавало файлы)
			var confFileReportid = filesfolder.getFilesByName(scanresultFileErrorsReport);
			while (confFileReportid.hasNext()) {
				var nfile = confFileReportid.next();
				//filesfolder.removeFile(nfile);
				deleteOrRemoveFile(nfile)
			}
			checkSaveFile(filesfolder.createFile(scanresultFileErrorsReport, readRes), readRes);
		}
	} else {

		if (filesN) {
			//удаляем только если есть файл
			var confFileReportid = filesfolder.getFilesByName(scanresultFileErrorsReport);
			while (confFileReportid.hasNext()) {
				var nfile = confFileReportid.next();
				//filesfolder.removeFile(nfile);
				deleteOrRemoveFile(nfile)
			}
		}

	}


	Logger.log(readRes);

	return [reterr, FeedConfig[0], scanids, configChecksum, configChangeFLG, configFolder, ClearConfig, readRes];
}




//перезапись scanReport
function rewriteScanReport(scanReport, filesfolder, scanids) {
	var ScanFiles = '';
	for (var id in scanids) {
		if (scanids[id]['date']) {
			//пишем только те которые уже сохранялись полностью (есть последняя дата создания)
			//в т.ч. текущие, которые в обработке, если есть предыдущая дата создания
			ScanFiles += id + ' ' + scanids[id]['checksum'] + ' ' + scanids[id]['priorityLev'] + ' ' + scanids[id]['date'] + "\n";
		}
	}


	if (AdWordsApp.getExecutionInfo().isPreview()) {
		if (ScanFiles) {
			Logger.log('Preview, Rewrite ' + scanReport + " :\n" + ScanFiles)
		} else {
			Logger.log('Preview, Delete ' + scanReport)
		}
		return ScanFiles;
	} else {
		if (ScanFiles) {
			Logger.log('Rewrite ' + scanReport + " :\n" + ScanFiles)
		} else {
			Logger.log('Delete ' + scanReport)
		}
	}

	//удаляем файл scanReport
	var fileIter = filesfolder.getFilesByName(scanReport);
	while (fileIter.hasNext()) {
		var nfile = fileIter.next();
		//filesfolder.removeFile(nfile);
		deleteOrRemoveFile(nfile)
	}
	//записываем файл scanReport
	//может быть пустой файл, тогда можно не писать
	if (ScanFiles)
		checkSaveFile(filesfolder.createFile(scanReport, ScanFiles), ScanFiles);

	//можно закомментировать
	return ScanFiles;


}


function CheackCreateFeedsNow(lastdate, timeHoursArray) {
	//обязательна ли сейчас генерация фида/фидов на основе текущих настроек сайта/фида timeHours
	//lastdate - предыдущая дата генерации скана
	//используется текущий сформированный массив часов генерации фида или сайта
	//проверяются часы в timeHoursArray на вхождение в диапазон 0...23 (это важно, иначе перескочит на другие сутки)

	//может присутсвовать в массиве test - не запускать никогда, кроме режима просмотра
	//иначе список разрешенных часов запуска 0...23



	if (!timeHoursArray.length) {
		//пустой массив, это ошибка, не запускать никогда
		return 0;
	}

/*
теперь test заменяется на текущий час и ежедневный скан
	if (AdWordsApp.getExecutionInfo().isPreview()) {
		if (timeHoursArray.indexOf('test') == -1) {
			//нет test, не запускать в режиме просмотра
			return 0;
		} else {
			//есть test, можно запускать в режиме просмотра
			return 1;
		}
	} else {
		if ((timeHoursArray.indexOf('test') != -1) && (timeHoursArray.length == 1)) {
			//есть только test, не запускать без режима просмотра
			return 0;
		}
	}
*/

	//взято из function getNewDate для вырезания часового пояса
//	var timezone = /\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}\:?\d{2})?)\b\)?/g;
//	lastdate = String(lastdate).replace(timezone, '');
	lastdate = new Date(lastdate);
	if (lastdate == 'Invalid Date') {
		//если еще нет lastdate, то запускать
		return 1;
	}
	lastdate = new Date(lastdate.getFullYear(), lastdate.getMonth(), lastdate.getDate(), lastdate.getHours());


	//вычисляем текущее время начала часа
	var now = getcurrentTime();
	//	var now = new Date();


	var currHour = now.getHours();


	//ищем максимальный час для формирования текущей даты на основе меньших часов чем текущий из timeHours
	var currMaxHour = -1;
	//ищем максимальный час для формирования предыдущей даты на основе больших часов чем текущий из timeHours
	var prevMaxHour = -1;
	for (var i = 0; i < timeHoursArray.length; i++) {
		//контролируем невыход за пределы возможных часов в сутках (это важно, иначе перескочит на другие сутки)
/*
теперь test заменяется на текущий час и ежедневный скан
		if (timeHoursArray[i] == 'test') {
			continue;
		} else if (timeHoursArray[i] > 23) {
*/
		if (timeHoursArray[i] > 23) {
			timeHoursArray[i] = 23;
		} else if (timeHoursArray[i] < 0) {
			//такого не должно быть, но если есть то не запускаем (значит где-то ошибка в массиве/параметре/алгоритме)
			return 0;
			//			timeHoursArray[i] = 0;
		}
		if (timeHoursArray[i] == currHour) {
			//найден текущий час в списке часов, сразу выходим, другие не проверяем
			currMaxHour = -1;
			prevMaxHour = -1;
			break;
		}
		if ((timeHoursArray[i] > currMaxHour) && (timeHoursArray[i] < currHour))
			currMaxHour = timeHoursArray[i];
		if ((timeHoursArray[i] > prevMaxHour) && (timeHoursArray[i] > currHour))
			prevMaxHour = timeHoursArray[i];

	}
	if (currMaxHour >= 0) {
		//нашли час меньше текущего
		//генерируем текущую минимальную дату генерации скана
		var lastneedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), currMaxHour);
	} else if (prevMaxHour >= 0) {
		//ищем час больше текущего
		//генерируем предыдущую минимальную дату генерации скана
		var lastneedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, prevMaxHour);
	} else {
		//не нашли ничего, берем час равный текущему
		//генерируем текущую дату генерации скана
		var lastneedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), currHour);
	}


	if (lastneedDate == 'Invalid Date') {
		//такого не должно быть, но если есть то не запускаем (значит где-то ошибка в массиве/параметре/алгоритме)
		return 0;
	}


	if (lastneedDate.getTime() <= lastdate.getTime()) {
		return 0;
	} else {
		return 1;
	}



}



function CheackScanningSiteNow(lastdate, startDaysArray) {
	//обязателен ли сейчас скан сайта на основе текущих настроек сайта/фида startDays
	//lastdate - предыдущая дата генерации скана
	//используется текущий сформированный массив дней месяца запуска сканирования для фида или сайта
	//проверяются дни в startDaysArray на вхождение в диапазон 1...31 и конец месяца! (это важно, иначе перескочит на другой месяц)

	//может быть пустой массив (означает что скан при каждом запуске)
	//иначе список разрешенных дней пересканирования 1...31

/*
теперь test заменяется на текущий час и ежедневный скан
	if (AdWordsApp.getExecutionInfo().isPreview()) {
		return 1;
	}
*/

	if (!startDaysArray.length) {
		return 1;
	}


	//взято из function getNewDate для вырезания часового пояса
//	var timezone = /\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}\:?\d{2})?)\b\)?/g;
//	lastdate = String(lastdate).replace(timezone, '');
	lastdate = new Date(lastdate);
	if (lastdate == 'Invalid Date') {
		//если еще нет lastdate, то запускать
		return 1;
	}
	lastdate = new Date(lastdate.getFullYear(), lastdate.getMonth(), lastdate.getDate());


	//вычисляем текущее время начала дня
	var now = getcurrentTime();
	//	var now = new Date();

	var currDay = now.getDate();


	//ищем максимальный день для формирования даты текущего месяца на основе меньших дней чем текущий из startDays
	var currMaxDay = 0;
	//ищем максимальный день для формирования даты предыдущего месяца на основе больших дней чем текущий из startDays
	var prevMaxDay = 0;
	for (var i = 0; i < startDaysArray.length; i++) {
		//контролируем невыход за пределы возможных дней в месяце (это важно, иначе перескочит на другой месяц)
		if (startDaysArray[i] > 31) {
			startDaysArray[i] = 31;
		} else if (startDaysArray[i] < 1) {
			//такого не должно быть, но если есть то не запускаем (значит где-то ошибка в массиве/параметре/алгоритме)
			return 0;
			//			startDaysArray[i] = 1;
		}
		if (startDaysArray[i] > 28) {
			//вычисляем последний день текущего месяца
			var tmpDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
			var tmpcurrMaxDay = tmpDate.getDate();
			if (tmpcurrMaxDay < startDaysArray[i]) {
				//здесь нельзя изменять startDaysArray[i] на макс дату текушего месяца,
				//так как если не совпало ниже, то потом в разных месяцах будут разные максимальные значения
				//поэтому введена временная переменная startDaysArrayi
				var startDaysArrayi = tmpcurrMaxDay;
			} else {
				var startDaysArrayi = startDaysArray[i];
			}
			if (tmpcurrMaxDay < currDay) {
				var currDayReal = tmpcurrMaxDay;
			} else {
				var currDayReal = currDay;
			}
			if (startDaysArrayi == currDayReal) {
				//найден текущий день в списке дней, сразу выходим, другие не проверяем
				currMaxDay = 0;
				prevMaxDay = 0;
				break;
			}
		} else {
			if (startDaysArray[i] == currDay) {
				//найден текущий день в списке дней, сразу выходим, другие не проверяем
				currMaxDay = 0;
				prevMaxDay = 0;
				break;
			}
		}
		if ((startDaysArray[i] > currMaxDay) && (startDaysArray[i] < currDay))
			currMaxDay = startDaysArray[i];
		if ((startDaysArray[i] > prevMaxDay) && (startDaysArray[i] > currDay))
			prevMaxDay = startDaysArray[i];

	}

	if (currMaxDay > 0) {
		//нашли день меньше текущего
		//генерируем минимальную дату текущего месяца генерации скана
		if (currMaxDay > 28) {
			//вычисляем максимальный день в текущем месяце (это важно, иначе перескочит на другой месяц)
			var tmpDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
			var tmpcurrMaxDay = tmpDate.getDate();
			if (tmpcurrMaxDay < currMaxDay) {
				currMaxDay = tmpcurrMaxDay;
			}
		}
		var lastneedDate = new Date(now.getFullYear(), now.getMonth(), currMaxDay);
	} else if (prevMaxDay > 0) {
		//ищем час больше текущего
		//генерируем минимальную дату предыдущего месяца генерации скана
		if (prevMaxDay > 28) {
			//вычисляем максимальный день в предыдущем месяце (это важно, иначе перескочит на другой месяц)
			var tmpDate = new Date(now.getFullYear(), now.getMonth(), 0);
			var tmpprevMaxDay = tmpDate.getDate();
			if (tmpprevMaxDay < prevMaxDay) {
				prevMaxDay = tmpprevMaxDay;
			}
		}
		var lastneedDate = new Date(now.getFullYear(), now.getMonth() - 1, prevMaxDay);
	} else {
		//не нашли ничего, берем день равный текущему
		//генерируем дату текущего месяца генерации скана
		var lastneedDate = new Date(now.getFullYear(), now.getMonth(), currDay);
	}


	if (lastneedDate == 'Invalid Date') {
		//такого не должно быть, но если есть то не запускаем (значит где-то ошибка в массиве/параметре/алгоритме)
		return 0;
	}


	if (lastneedDate.getTime() <= lastdate.getTime()) {
		return 0;
	} else {
		return 1;
	}



}


function sendftp(filesArr, ftpsettings, zipfilename, IDName) {
	//архивируем и отправляем на ftp-сервер, или не архивируем
	//filesArr - массив найденных ссылок на объекты файлов

	//требуется папка gasrvconn с ее файлами


	//	var urlupload = 'http://inteprice.com/uploadftp.php'
	//var urlupload = 'http://inteprice.com/a2/srvconn.php'
	var urlupload = 'http://inteprice.com/gasrvconn/';
	//MAXPOSTSIZE конктретно под интепрайс, можно везде так оставить
	//снимается ограничение в php.ini (благодаря скрипту на сервере)
	var MAXPOSTSIZE = 10240000;


	//в общем надо application/octet-stream (что бы работало php://input в скрипте на сервере)
	//тогда не работают ограничения в php.ini на длину запроса или передаваемого файла
	//остается только ограничение на общую длину запроса для порционной передачи каждого файла
	//правда в большинстве случаев такого ограничения нет (на интепрайсе есть), 
	//но все же нужно ограничивать длину передаваемых данных, что бы не было таймаута при передаче данных

	//https://codereview.stackexchange.com/questions/99002/chunked-file-upload
	//https://github.com/blueimp/jQuery-File-Upload
	//https://github.com/blueimp/jQuery-File-Upload/blob/master/server/php/UploadHandler.php
	//https://habr.com/company/Techart/blog/100189/

	//send post chunk file js
	//https://stackoverflow.com/questions/20212851/slice-large-file-into-chunks-and-upload-using-ajax-and-html5-filereader
	//https://mytechbites.blogspot.com/2016/07/uploading-large-files-in-js.html

	//Multipart-POST Request Using Google Apps Script
	//https://gist.github.com/tanaikech/d595d30a592979bbf0c692d1193d260c
	//https://stackoverflow.com/questions/16220972/google-docs-script-to-fetch-some-web-information

	//Resumable uploads - writing large files to Drive with Apps Script
	//http://ramblings.mcpher.com/Home/excelquirks/gassnips/resumable

	//application/octet-stream
	//https://ctrlq.org/code/20573-upload-google-drive-files-dropbox
	//https://itif.ru/chto-takoe-http_raw_post_data/


	//https://developers.google.com/google-ads/scripts/docs/examples/miscellaneous


	//http://www.php.su/articles/?cat=protocols&page=001
	//http://www.internet-technologies.ru/articles/php-skript-dlya-zagruzki-faylov.html
	//https://gist.github.com/steveosoule/7592774
	//http://www.w3programmers.com/file-upload-and-download-with-php/

	//php - ftp uploader с возможностью докачки
	//https://php.ru/forum/threads/php-ftp-uploader-s-vozmozhnostju-dokachki.15313/



	if (shouldExitEarly()) {
		return false;
	}


	if (!(ftpsettings && ftpsettings['login'] && ftpsettings['password'] && ftpsettings['host'] && ftpsettings['files_types'] && ftpsettings['files_types'].length))
		return 'Error: not found ftp parameters';


	if (!((typeof filesArr == 'object') && filesArr.length))
		return 'Error: not found files to send';


	if (ftpsettings['directory']) {
		var directory = ftpsettings['directory'];
	} else {
		var directory = '';
	}

	if (ftpsettings['passive_mode']) {
		var passive_mode = ftpsettings['passive_mode'];
	} else {
		var passive_mode = '';
	}

	if (ftpsettings['ssl_mode']) {
		var ssl_mode = ftpsettings['ssl_mode'];
	} else {
		var ssl_mode = '';
	}



	if (ftpsettings && (typeof ftpsettings['zipfilename'] == 'string') && ftpsettings['zipfilename']) {
		zipfilename = ftpsettings['zipfilename'];
	}

	//готовим blobs

	var blobs = [];
	for (var i = 0; i < filesArr.length; i++) {
		var fname = filesArr[i].getName();
		//только разрешенные пропускаем и не пропускаем остальных
		var match = fname.match(/((?:\.(?:ga|yml|yrl|ycar|ya))?\.(?:[\w]+))$/i);
		if (match && match[1]) {
			var ext = match[1].toLowerCase();
			if (ftpsettings['files_types'].indexOf(ext) == -1)
				continue;
		} else {
			continue;
		}
		blobs[blobs.length] = filesArr[i].getBlob();
	}


	//нужно сообщить, что нечего передавать, согласно заданных files_types в фтп-настройках фида
	if (!blobs.length)
		return 'Error: in files_types not found files to send';



	//если zip то один файл/blob
	if (ftpsettings && ftpsettings['createzip'] && zipfilename && blobs.length) {
		//это zip blob
		var zip = Utilities.zip(blobs, zipfilename);
		var blobs = [];
		blobs[blobs.length] = zip;
	}



	var errorsleep = 0;

	var emessage = '';

	//передаем "скрытый" параметр (Referer), на который проверять нужно в скрипте загрузки
	//короче это два обязательных заголовка
	var header = {
		"Content-Type": "application/octet-stream",
		'Referer': 'http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885'
	}
	var options = {
		method: 'post',
		muteHttpExceptions: true,
		followRedirects: true,
		headers: header
	};



	for (var i = 0; i < blobs.length; i++) {


		var filenane = blobs[i].getName();
		var content = blobs[i].getBytes();

		//var filemimeType = blobs[i].getContentType();


		//файл должен быть абсолютно уникальный, с учетом разных аккаунтов, которые могут загружать одинаковые по названию zip и теоретически сработать в одно и тоже время
		if (IDName) {
			var tmpfilename = IDName + "." + new Date().getTime();
		} else {
			var tmpfilename = new Date().getTime() + '';
		}

		var MAX_TRIES = 5;

		var numTries = 0;

		var responseCode = 0;

		emessage = '';

		while (numTries < MAX_TRIES) {

			numTries++;


			emessage = '';


			// now do the chunks
			var pos = 0;
			responseCode = 0;

			do {

				var chunk = content.slice(pos, Math.min(pos + MAXPOSTSIZE, content.length));



				// load this chunk of data
				options.payload = chunk;


				if (errorsleep)
					Utilities.sleep(errorsleep);


				emessage = '';
				try {

					if (!pos) {
						var response = UrlFetchApp.fetch(urlupload + "?fileName=" + filenane + "&tmp=" + tmpfilename + "&start=1", options);
					} else {
						var response = UrlFetchApp.fetch(urlupload + "?fileName=" + filenane + "&tmp=" + tmpfilename, options);
					}

				} catch (e) {

					emessage = e.message;
					if (!emessage)
						emessage = 'Unknown fetch error';
				}

				if (emessage) {

					if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
						//это значит, что слишком частые запросы

						var sleeptime = 1000;
						var match = emessage.match(/Try Utilities\.sleep\((\d+)\)/);
						if (match && match[1] && (match[1] * 1)) {
							sleeptime = match[1] * 1;
						}

						if (sleeptime > errorsleep) {
							errorsleep = sleeptime;
						} else {
							errorsleep = errorsleep * 2;
						}


						//			Utilities.sleep(sleeptime);
						//повторить
						//переходим к следующей попытке полной записи файла с увеличенной постоянной задержкой
						break;


					} else if (emessage.indexOf('Service invoked too many times') != -1) {
						//это значит, что превышено разрешенное количество запросов (за день наверное)
						//Service invoked too many times for one day: urlfetch
						Logger.log("Ftp Service error: " + emessage + "\n" + IDName);
						return false;

					} else {
						//сюда попадет в т.ч. 'Timeout:'
						if (emessage.indexOf('Timeout:') != -1) {
							//если Timeout: то нужно сразу выходить, иначе появится каша в передаваемых данных
							//этот запрос еще будет выполняться, а уже пойдут следующие!
							Logger.log("Ftp Service error: " + emessage + "\n" + IDName);
							return emessage;
						}
						break;
					}

					//ниже не должно проходить отсюда

				}




				responseCode = response.getResponseCode();
				var responseContent = response.getContentText();

				responseContent = responseContent.replace(/\r/g, " "); // Remove newlines
				responseContent = responseContent.replace(/\n/g, " "); // Remove newlines
				responseContent = responseContent.replace(/\t/g, " "); // Remove tabs
				responseContent = responseContent.replace(/(\<\!\-\-76639386656585\-\-\>.*)$/, ""); // Remove commented text

				// the actual data size transferred
				var size = chunk.length;


				if (responseCode !== 200) {

					//сюда попадет в т.ч. пустой responseCode
					//может быть ошибка гугла (пустой responseCode) (как я сам видел - почему то вставил http://technotest. а не полный путь, сам вставил, сам же и ругнулся без запроса и соотвественно без ответа) и тогда нет responseCode (хотя тоже самое будет если совсем некорректная url, например тотже  http://technotest.)

					//если ошибка сервера, то нельзя повторно качать chunk, 
					//можно выходить полностью, либо заново весь файл качать
					//эксперимент на интепрайсе показал, что не собирается полный файл почему-то при повторной закачке отдельного chunk

					//закомментировал, сделал второй вариант поведения
					//return responseCode + " " + responseContent;

					//не выходим пробуем повторно передать весь файл, но устанавливаем задержку перед запросами

					var sleeptime = 1000;
					if (sleeptime > errorsleep) {
						errorsleep = sleeptime;
					} else {
						errorsleep = errorsleep * 2;
					}

					emessage = responseCode + " " + responseContent;

					if (shouldExitEarly()) {
						return false;
					}

					//переходим к следующей попытке полной записи файла с увеличенной постоянной задержкой
					break;


				} else if (size && responseContent) {
					//не пустой chunk и есть непустой ответ сервера, значит какая-то ошибка в передаваемых данных
					return responseCode + " " + responseContent;
				}



				if (shouldExitEarly()) {
					return false;
				}


				pos += size;


			} while (pos < content.length);


			if (!emessage) {
				//отправляем полный файл на сервер фтп
				delete options.payload;

				responseCode = 0;


				try {

					var response = UrlFetchApp.fetch(urlupload + "?fileName=" + filenane + "&tmp=" + tmpfilename + "&log=" + ftpsettings['login'] + "&pass=" + ftpsettings['password'] + "&host=" + ftpsettings['host'] + "&dir=" + directory + "&pm=" + passive_mode + "&ssl=" + ssl_mode + "&end=1", options);

				} catch (e) {

					emessage = e.message;
					if (!emessage)
						emessage = 'Unknown fetch error';
				}

				if (emessage) {

					if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
						//это значит, что слишком частые запросы

						var sleeptime = 1000;
						var match = emessage.match(/Try Utilities\.sleep\((\d+)\)/);
						if (match && match[1] && (match[1] * 1)) {
							sleeptime = match[1] * 1;
						}

						if (sleeptime > errorsleep) {
							errorsleep = sleeptime;
						} else {
							errorsleep = errorsleep * 2;
						}


						//			Utilities.sleep(sleeptime);
						//повторить
						//переходим к следующей попытке полной записи файла с увеличенной постоянной задержкой
						continue;


					} else if (emessage.indexOf('Service invoked too many times') != -1) {
						//это значит, что превышено разрешенное количество запросов (за день наверное)
						//Service invoked too many times for one day: urlfetch
						Logger.log("Ftp Service error: " + emessage + "\n" + IDName);
						return false;
					} else {
						//сюда попадет в т.ч. 'Timeout:'
						if (emessage.indexOf('Timeout:') != -1) {
							//если Timeout: то нужно сразу выходить, иначе появится каша в передаваемых данных
							//этот запрос еще будет выполняться, а уже пойдут следующие!
							Logger.log("Ftp Service error: " + emessage + "\n" + IDName);
							return emessage;
						}
						continue;
					}

					//ниже не должно проходить отсюда

				}


				responseCode = response.getResponseCode();
				var responseContent = response.getContentText();

				responseContent = responseContent.replace(/\r/g, " "); // Remove newlines
				responseContent = responseContent.replace(/\n/g, " "); // Remove newlines
				responseContent = responseContent.replace(/\t/g, " "); // Remove tabs
				responseContent = responseContent.replace(/(\<\!\-\-76639386656585\-\-\>.*)$/, ""); // Remove commented text


				if (responseCode !== 200) {

					//сюда попадет в т.ч. пустой responseCode
					//может быть ошибка гугла (пустой responseCode) (как я сам видел - почему то вставил http://technotest. а не полный путь, сам вставил, сам же и ругнулся без запроса и соотвественно без ответа) и тогда нет responseCode (хотя тоже самое будет если совсем некорректная url, например тотже  http://technotest.)

					//можно выходить полностью, либо заново весь файл качать

					//закомментировал, сделал второй вариант поведения
					//return responseCode + " " + responseContent;

					//не выходим пробуем повторно передать весь файл, но устанавливаем задержку перед запросами


					var sleeptime = 1000;
					if (sleeptime > errorsleep) {
						errorsleep = sleeptime;
					} else {
						errorsleep = errorsleep * 2;
					}

					emessage = responseCode + " " + responseContent;

					if (shouldExitEarly()) {
						return false;
					}

					//переходим к следующей попытке полной записи файла с увеличенной постоянной задержкой
					continue;


				} else if (responseContent) {
					//есть непустой ответ сервера, значит какая-то ошибка в передаваемых данных или в передаче данных на фтп
					return responseCode + " " + responseContent;
				}


				//завершаем попытки передать полный файл, успешно передан
				break;
			}



			//конец while (numTries < MAX_TRIES) {
		}

		if (emessage) {
			return emessage;
		}




		//конец for (var i=0; i<blobs.length; i++) {
	}


	if (emessage) {
		return emessage;
	}



	return true;



}




function getFeedfolders() {

	//получаем нужные директории

	var mainfolder = null;
	var trashedfolder = null;

	var filesfolder = null;
	var tmpfilesfolder = null;
	var schedfilesfolder = null;

	var callhunterfolder = null;

	var domainsfolder = null;


	var folders = DriveApp.getRootFolder().getFolders();

	while (folders.hasNext()) {
		var folder = folders.next();
		var folderName = folder.getName();

		if (folderName == 'context_settings') {
			if (!mainfolder)
				mainfolder = folder;
		} else if (folderName == 'trashed') {
			if (!trashedfolder)
				trashedfolder = folder;
		} else if (folderName == 'tmpfiles') {
			if (!tmpfilesfolder)
				tmpfilesfolder = folder;
		} else if (folderName == 'schedfiles') {
			if (!schedfilesfolder)
				schedfilesfolder = folder;
		} else {
			continue;
		}
	}

//добавлен поиск по ярлыку в директории root для общих папок (ярлыки - это файлы)
	var folders = DriveApp.getRootFolder().getFiles();

	while (folders.hasNext()) {
		var folder = folders.next();
		var folderName = folder.getName();
		var fileTargetId = folder.getTargetId();

		if (!fileTargetId)
			continue;

		var folder = DriveApp.getFolderById(fileTargetId);
		if (folder) {
			var folderName = folder.getName();
		} else {
			continue;
		}

		if (folderName == 'context_settings') {
			if (!mainfolder)
				mainfolder = folder;
		} else if (folderName == 'trashed') {
			if (!trashedfolder)
				trashedfolder = folder;
		} else if (folderName == 'tmpfiles') {
			if (!tmpfilesfolder)
				tmpfilesfolder = folder;
		} else if (folderName == 'schedfiles') {
			if (!schedfilesfolder)
				schedfilesfolder = folder;
		} else {
			continue;
		}
	}

	if (!mainfolder) {
		Logger.log('Not found folder "context_settings" !!!, exit');
		return '';
	}
	if (!trashedfolder) {
		Logger.log('Not found folder "trashed" !!!, exit');
		return '';
	}
	if (!tmpfilesfolder) {
		Logger.log('Not found folder "tmpfiles" !!!, exit');
		return '';
	}
	if (!schedfilesfolder) {
		Logger.log('Not found folder "schedfiles" !!!, exit');
		return '';
	}

	if (typeof GLtrashedfolder != 'undefined')
		GLtrashedfolder	= trashedfolder;


	var folders2 = mainfolder.getFolders();

	while (folders2.hasNext()) {
		var folder = folders2.next();
		var folderName = folder.getName();

		if (folderName != 'files') {
			continue;
		} else {
			filesfolder = folder;
			break;
		}
	}

	if (!filesfolder) {
		Logger.log('Not found folder "context_settings/files" !!!, exit');
		return '';
	}



	var folders2 = mainfolder.getFolders();

	while (folders2.hasNext()) {
		var folder = folders2.next();
		var folderName = folder.getName();

		if (filesfolder && callhunterfolder) {
			break;
		} else if ((!filesfolder) && (folderName == 'files')) {
			filesfolder = folder;
		} else if ((!callhunterfolder) && (folderName == 'callhunter')) {
			callhunterfolder = folder;
		}

	}

	if (!filesfolder) {
		Logger.log('Not found folder "context_settings/files" !!!, exit');
		return '';
	}

	if (!callhunterfolder) {
		Logger.log('Not found folder "context_settings/callhunter" !!!, exit');
		return '';
	}


	var folders3 = callhunterfolder.getFolders();

	while (folders3.hasNext()) {
		var folder = folders3.next();
		var folderName = folder.getName();
		if (folderName == 'domains') {
			domainsfolder = folder;
			break;
		}
	}

	if (!domainsfolder) {
		Logger.log('Not found folder "context_settings/callhunter/domains" !!!, exit');
		return '';
	}

	return [mainfolder, filesfolder, domainsfolder, tmpfilesfolder, schedfilesfolder, trashedfolder];

}


function getLabel(LabelName) {
	//получить описание ярлыка LabelName
	if (typeof LabelName != 'string') {
		return null;
	}
	//пробелов не можеть быть в конце строки
	LabelName = LabelName.replace(/\s+$/, '');
	var labels = AdWordsApp.labels().withCondition("Name = '" + LabelName.replace(/\'/gm, '\\\'') + "'").get();
	var remlabels = 0;
	while (labels.hasNext()) {
		var label = labels.next();
		var trackstring = label.getDescription();
		if (typeof trackstring != 'string') {
			remlabels = 1;
		} else {
			return trackstring;
		}
		break;
	}
	if (remlabels) {
		var labels = AdWordsApp.labels().withCondition("Name = '" + LabelName.replace(/\'/gm, '\\\'') + "'").get();
		while (labels.hasNext()) {
			var label = labels.next();
			label.remove();
			label.remove();
		}
	}
	return null;
}


function setLabel(LabelName, Description) {
	//записать описание ярлыка LabelName
	if (typeof LabelName != 'string') {
		return 0;
	}
	//пробелов не можеть быть в конце строки, иначе ошибка и останов скрипта
	LabelName = LabelName.replace(/\s+$/, '');
	//!!!!!!!!!!!!!! пишут что 100, а теперь на самом деле 80
	if (LabelName.length > 80)
		return 0;
	var labels = AdWordsApp.labels().withCondition("Name = '" + LabelName.replace(/\'/gm, '\\\'') + "'").get();
	while (labels.hasNext()) {
		var label = labels.next();
		label.remove();
		label.remove();
	}
	if (typeof Description != 'string') {
		Description = Description.toString();
	}
	if (typeof Description != 'string') {
		return 0;
	}
	if (Description.length > 200) {
		return 0;
	}
	AdWordsApp.createLabel(LabelName, Description, '#C0C0C0');
	return 1;
}



function readConfFile(fileName, folder) {

	try {
		var fileIter = folder.getFilesByName(fileName);
		if (!fileIter.hasNext()) {
			//нет файла
			return [null, 1, 'File: ' + fileName + ' not found'];
		}
		var fileData = fileIter.next().getBlob().getDataAsString();
		if (fileData) {
			var ret = eval('(' + fileData + ')');
			return [ret, 0];
		} else {
			//файл пустой
			return [null, 2, 'File: ' + fileName + ' is empty'];
		}
	} catch (e) {
		//ошибка чтения файла
		return [null, 3, 'Could not read file: ' + fileName + ' Error: ' + e.message];
	}

}




function isInteger(num) {
	//целое число-строка или целое число
	if (typeof num == 'number') num = String(num);
	if (typeof num != 'string') return false;
	if (/^\d+$/.test(num)) {
		return true;
	} else {
		return false;
	}
}



function getPriceCurrencyFromStr(a) {
	//находим цену и валюту, и по ней код валюты (ISO 4217)

	//https://gist.github.com/beautyfree/8fba66ee44bb2124b2b9
	//https://github.com/chartbeat-labs/visualbigboard/blob/master/closure-library/closure/goog/i18n/.svn/text-base/currency.js.svn-base

	if (a) {

		a = a.replace(/\<[^\>]*\>/g, '');

		//убираем пробелы внутри чисел
		//var v = a.replace(/(?<=[\d\.\,])\s+(?=[\d\.\,])/g, ''); //просмотр назад не работает в гугле
		function replacer(match, offset, string) {
			match = match.replace(/\s+/g, '');
			return match;
		}
		var v = a.replace(/[\d\.\,][\d\.\,\s]+[\d\.\,]/g, replacer);

		var match = v.match(/((?:[\d]|(?:[\.\,][\d]))[\d\.\,]*)/);
		if (match && match[1]) {
			var sum = match[1];
			//принудительная замена запятых на точки
			//условие: количество запятых только одна и нет точек и после запятой не больше 2-х цифр
			if ((sum.match(/,/g)||[]).length == 1) {
				if (/\,\d\d?$/.test(sum)) {
					sum = sum.replace(/^(?!\.)(.*)\,/, '$1.');
				}
			}
//проверяем, что это число (могут быть запятые, которые удаляем для проверки) и число не равно 0
//sum - для nativeprice (здесь будет 0 на 0 грн, то есть непустое значение)
//sum2 - для iso4217price (здесь будет null на 0 грн, то есть пустое значение)
			var sumt = sum.replace(/\,/g, '');
			x = Number(sumt)
			if (x !== x) { //NaN
				sum2 = null;
			} else if (!x) { //zero
				sum2 = null;
			} else {
				sum2 = sum;
			}
		} else {
			var sum = null;
			var sum2 = null;
		}



		//                    a = a.toUpperCase();
		var b = [{
				pattern: /((?:EUR)|€)/i,
				currency: "EUR"
			}, {
				pattern: /((?:USD)|(?:У\.Е\.)|\$)/i,
				currency: "USD"
			}, {
				pattern: /((?:UAH)|(?:ГРН\.?)|(?:₴))/i,
				currency: "UAH"
			}, {
				pattern: /((?:RUR)|(?:RUB)|(?:Р\.)|(?:РУБ\.?))/i,
				currency: "RUB"
			}, {
				pattern: /((?:ТГ)|(?:KZT)|(?:₸)|(?:ТҢГ)|(?:TENGE)|(?:ТЕНГЕ))/i,
				currency: "KZT"
			}, {
				pattern: /((?:[A-Z][A-Z][A-Z]))/,
				currency: "MAYBE"
			}],
			c = b.map(function(b) {
				return {
					currency: b.currency,
					index: a.search(b.pattern),
					match: a.match(b.pattern)
				}
			}).filter(function(a) {
				return a.index > -1
			}).sort(function(a, b) {
				return a.index - b.index
			});
		//                    return c.length ? c[0].currency : void 0

		return [[sum, sum2], c.length ? [c[0].currency == 'MAYBE' ? c[0].match[1] : c[0].currency, c[0].match[1]] : null];
	}
}


function murmurhash3_32_gc(key, seed) {

//маленькая корректировка, иначе на числах выдает одинаковое значение
	key += '';

	var remainder, bytes, h1, h1b, c1, c1b, c2, c2b, k1, i;

	remainder = key.length & 3; // key.length % 4
	bytes = key.length - remainder;
	h1 = seed;
	c1 = 0xcc9e2d51;
	c2 = 0x1b873593;
	i = 0;

	while (i < bytes) {
		k1 =
			((key.charCodeAt(i) & 0xff)) |
			((key.charCodeAt(++i) & 0xff) << 8) |
			((key.charCodeAt(++i) & 0xff) << 16) |
			((key.charCodeAt(++i) & 0xff) << 24);
		++i;

		k1 = ((((k1 & 0xffff) * c1) + ((((k1 >>> 16) * c1) & 0xffff) << 16))) & 0xffffffff;
		k1 = (k1 << 15) | (k1 >>> 17);
		k1 = ((((k1 & 0xffff) * c2) + ((((k1 >>> 16) * c2) & 0xffff) << 16))) & 0xffffffff;

		h1 ^= k1;
		h1 = (h1 << 13) | (h1 >>> 19);
		h1b = ((((h1 & 0xffff) * 5) + ((((h1 >>> 16) * 5) & 0xffff) << 16))) & 0xffffffff;
		h1 = (((h1b & 0xffff) + 0x6b64) + ((((h1b >>> 16) + 0xe654) & 0xffff) << 16));
	}

	k1 = 0;

	switch (remainder) {
		case 3:
			k1 ^= (key.charCodeAt(i + 2) & 0xff) << 16;
		case 2:
			k1 ^= (key.charCodeAt(i + 1) & 0xff) << 8;
		case 1:
			k1 ^= (key.charCodeAt(i) & 0xff);

			k1 = (((k1 & 0xffff) * c1) + ((((k1 >>> 16) * c1) & 0xffff) << 16)) & 0xffffffff;
			k1 = (k1 << 15) | (k1 >>> 17);
			k1 = (((k1 & 0xffff) * c2) + ((((k1 >>> 16) * c2) & 0xffff) << 16)) & 0xffffffff;
			h1 ^= k1;
	}

	h1 ^= key.length;

	h1 ^= h1 >>> 16;
	h1 = (((h1 & 0xffff) * 0x85ebca6b) + ((((h1 >>> 16) * 0x85ebca6b) & 0xffff) << 16)) & 0xffffffff;
	h1 ^= h1 >>> 13;
	h1 = ((((h1 & 0xffff) * 0xc2b2ae35) + ((((h1 >>> 16) * 0xc2b2ae35) & 0xffff) << 16))) & 0xffffffff;
	h1 ^= h1 >>> 16;

	return h1 >>> 0;
}


function getcurrentTime() {
	var now = new Date(Utilities.formatDate(new Date(),
		AdWordsApp.currentAccount().getTimeZone(), "MMM dd,yyyy HH:mm:ss"));
	var today = new Date(now.getTime());
	return today;
}



function getNewDate(date, days, TimeZone) {
	//текущее время в текущем аккаунте/часовом поясе, либо, с параметром TimeZone - в другом аккаунте/часовом поясе
	//или время для существущей строки-даты (в этом случае TimeZone указывает на часовой пояс передаваемой строки-даты)
	//функцию можно не вызывать для строки-даты в текущем аккаунте/часовом поясе, если известно, что в ней нет часового пояса, например '11/25/2018 11:12:44' - тогда достаточно new Date('...')

	//date - если не задан, то возвращает текущее время в соответствии с days, иначе задать строку или объект new Date
	//days - дней вперед или назад от указаной даты или текущей (пустой) даты (можно указать 'currentime', 'yesterday', 'today' или 'tomorrow')
	//currentime в days обнуляет date, то есть получаем исключительно текущее время в соответствии с TimeZone или локальным аккаунтом/часовым поясом
	//TimeZone - для получения текущего времени другого аккаунта/часового пояса (дата пустая), либо 

	/*
	Итак зачем эта функция

	Работать с датами удобно через объект Date, но все даты выводятся в скрипте в часовом поясе сервера (GMT-7)
	Если мы передадим дату с другим часовым поясом, то дата будет переведена в GMT-7 (изменяться часы и пр.)
	Пересчитывать в часовой пояс аккаунта неприемлемо, в т.ч. визуально тоже нужно пересчитывать всегда

	Поэтому идея заключается в том, что даты храняться и обрабатываются в часовом поясе сервера (GMT-7),
	но при этом отображаются реальные часы и минуты часового пояса аккаунта (то есть у нас всегда неверный часовой пояс в датах)
	То есть мы работаем с абсолютным временем нужного нам часового пояса, необращая внимание на установленный часовой пояс в датах

	Для этого 
	для получения текущего времени используется конструкция new Date(Utilities.formatDate(new Date(), TimeZone, "MMM dd,yyyy HH:mm:ss"))
	для получения времени из строки/даты используется просто new Date()
	Но если мы передадим строку/дату с указанным явно часовым поясом, отличающимся от часового пояса сервера (GMT-7),
	то опять получим пересчет и неверную дату. Поэтому при передаче даты важно вырезать часовой пояс.


	Как использовать: есть 4 варианта

	1.Получение текущего локального времени (либо на несколько суток назад/вперед)
	Получение текущего времени в часовом поясе текущего аккаунта
	входные данные: пустая дата и days 0
	На выходе: дата в локальном часовом поясе/аккаунте текущего юзера

	2.Получение текущего времени в часовом поясе TimeZone (либо на несколько суток назад/вперед)
	Получение текущего времени в любом часовом поясе (например, подчиненного аккаунта)
	входные данные: пустая дата, days 0 и TimeZone (нужный нам часовой пояс)
	На выходе: дата в в часовом поясе TimeZone

	3.Преобразование локального времени в локальную дату-объект (либо на несколько суток назад/вперед)
	Преобразование в объект-дату строки-даты/объекта-даты, переданной в часовом поясе текущего аккаунта
	входные данные: строка-дата/объект-дата и days 0
	На выходе: дата в локальном часовом поясе/аккаунте текущего юзера

	4.Преобразование времени в часовом поясе TimeZone в локальную дату-объект (либо на несколько суток назад/вперед)
	Преобразование в объект-дату строки-даты/объекта-даты, переданной в любом часовом поясе (например, подчиненного аккаунта)
	входные данные: строка-дата/объект-дата и days 0 и TimeZone (часовой пояс переданной даты)
	На выходе: дата в локальном часовом поясе/аккаунте текущего юзера




	Соблюдать простое правило - работать с определенными датами всегда только с TimeZone или только без TimeZone
	То есть, в обработке попарно можно применять 1-3 или 2-4 и никак иначе






	ВАЖНОЕ ЗАМЕЧАНИЕ ПО ОБРАБОТКЕ ВРЕМЕНИ В СКРИПТАХ, КОТОРОЕ Я ВСЕГДА ЗАБЫВАЮ!
	Есть MCC и AdWords аккаунты, есть глобальная общая область скрипта
	Глобальная область скрипта всегда вызывается в контексте вызвавшего юзера.
	То есть:
	MCC получит часовой пояс своего аккаунта везде (в том числе в глобальной общей области скрипта), 
		он может узнать часовой пояс аккаунта юзера через спец. функции
	вызванный им AdWords получит часовой пояс своего аккаунта везде (в том числе в глобальной общей области скрипта)
		он НЕ может узнать часовой пояс аккаунта MCC

	Что я всегда забываю:
	Функция processAccount (скрипт выполняемый от имени юзера) получает везде, в т.ч. в глобальных переменных СВОЕ время и таймзону.
	Он НЕ МОЖЕТ получит через глобальную область в getcurrentTime() время и часовой пояс MCC (если как-то не передавать специально - через переменную, ярлык или гугл-диск)

	ПОЭТОМУ ВСЕ ДАТЫ КОНТРОЛЯ НАЧАЛА И ЗАВЕРШЕНИЯ СЕРВИСОВ РАБОТАЮТ ВЕЗДЕ ВНУТРИ processAccount КАК ВРЕМЯ ЮЗЕРА, А НЕ ВРЕМЯ МСС
	то есть переделывать не надо, кроме области МСС-main(), где включение/отключение происходит по часовому поясу МСС.
	НО в общем можно оставить все как есть. 
	Хотя лучше
	в скриптах выполнения перенести контроль времени завершения из области МСС в область processAccount,
	а в сриптах формирования запуска использовать для проверки времени acc.getTimeZone() и применить в.2 в.4 в getNewDate
	можно пересмотреть все new Date, может гдето заменить на эту функцию, например для CaCL3 - если гугл поменяет чаосовой пояс вдруг)

	Переделывать под окончание сервиса по времени MCC определенно ни в коем случае не делать, можно напутать и добится ошибок,
	так как нужно детально пересматривать и анализировать весь код, а не только передать как-то юзеру часовой пояс МСС.



	Примеры применения функции:

	Установлены даты окончания сервиса по времени клиента, нужно проверить
	На МСС - узнаем TimeZone клиента, получаем его текущую дату через в.2, проверяем окончание сервиса через в.4
	На AdWords-скрипте клиента получаем его текущую дату через в.1, проверяем окончание сервиса через в.3

	Получение статистики и других данных клиента, текущего или вчерашнего времени и пр.
	На МСС - не требуется
	На AdWords-скрипте клиента применяем в.1, проверяем текущее время через в.1 и входящие даты через в.3
	Хотя проще использовать то что уже есть (типа getcurrentTime()), 
	кроме проверки входящих дат (CaCL3, например) на предмет вырезания часового пояса гугла, но это лишнее.

	*/

	//вырезаем часовой пояс для входящих дат, иначе может быть неверная дата, если изменился часовой пояс системы или появился другой совсем
	//вырезание часового пояса взял и исправил var timezone отсюда http://blog.stevenlevithan.com/archives/date-time-format
	//для GMT, во всяком случае, работает, и даже так Sun Sep 30 2018 04:18:03 GMT-0700 (PDT)
	//AM PM не вырезает

	//эти 3 строки работают одинаково в replace и match (символы ?: можно удалить, тогда будет запоминаться содержимое скобок, но! только если убрать флаг g)
	//а так, как сейчас, в любом варианте в match получаем одномерный массив с найденными часовыми поясами 	[' GMT-0700', ' (PDT)']
	//	var timezone = /(\s*\(?\b([PMCEA][SDP]T|(Pacific|Mountain|Central|Eastern|Atlantic) (Standard|Daylight|Prevailing) Time|(GMT|UTC)([-+]\d{2}\:?\d{2})?)\b\)?)/g;
	//	var timezone = /(\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}\:?\d{2})?)\b\)?)/g;
	var timezone = /\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}\:?\d{2})?)\b\)?/g;


	if (days) {
		if (typeof days == 'string') {
			var lcdays = days.toLowerCase();
			if (lcdays == 'currentime') {
				days = 0;
				date = null;
			} else if (lcdays == 'yesterday') {
				days = -1;
			} else if (lcdays == 'today') {
				days = 0;
			} else if (lcdays == 'tomorrow') {
				days = 1;
			} else {
				days = 0;
			}

		} else if (typeof days != 'number') {
			days = 0;
		}
	}

	if ((date === undefined) || (date === null)) {
		if (typeof TimeZone == 'string') {
			var now = new Date(Utilities.formatDate(new Date(),
				TimeZone, "MMM dd,yyyy HH:mm:ss"));
		} else {
			var now = new Date(Utilities.formatDate(new Date(),
				AdWordsApp.currentAccount().getTimeZone(), "MMM dd,yyyy HH:mm:ss"));
		}
	} else {


		if (TimeZone && (typeof TimeZone == 'string')) {

			var kDate = new Date();
			var curdata = Utilities.formatDate(kDate, AdWordsApp.currentAccount().getTimeZone(), "Z");
			var match = curdata.match(/^([+-]?)(\d\d)(\:?(\d\d))?$/);
			var TZdata = Utilities.formatDate(kDate, TimeZone, "Z");
			var matchTZ = TZdata.match(/^([+-]?)(\d\d)(\:?(\d\d))?$/);
			//ниже идет постоянное контролируемой преобразование строк в числа и обратно (в т.ч. внутри выражений)
			if (match.length == 5) {
				var min = (match[2] * 60) + ((match[4] ? match[4] : 0) * 1);
				min = '' + match[1] + min;
			} else {
				var min = 0;
			}

			if (matchTZ.length == 5) {
				var minTZ = (matchTZ[2] * 60) + ((matchTZ[4] ? matchTZ[4] : 0) * 1);
				minTZ = '' + matchTZ[1] + minTZ;
			} else {
				var minTZ = 0;
			}

			//разница в минутах между часовыми поясами
			var razn = min - minTZ;

			date = String(date).replace(timezone, '');
			var now = new Date(date);

			now.setTime(now.getTime() + (razn * 1000 * 60));


		} else {

			date = String(date).replace(timezone, '');
			var now = new Date(date);
		}
	}

	if (now == 'Invalid Date') {
		return false;
	}

	if (days) {
		now.setDate(now.getDate() + days);
	}

	return now;
}



function removeRootFile(fileName,folder) {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		if (!folder) {
			folder = DriveApp.getRootFolder();
		}
		var file = folder.getFilesByName(fileName);
		while (file.hasNext()) {
			var nfile = file.next();
			//folder.removeFile(nfile);
			deleteOrRemoveFile(nfile)
		}
	}
}


//This function quickly writes the url data to a file
//that can be loaded again for the next run
function writeJSONFile(fileName, toWrite, folder) {
	var file = getFile(fileName, folder);
	var FileData = JSON.stringify(toWrite);
	checkSaveFile(file.setContent(FileData),FileData);
}


//And this loads that stored file and converts it to an object
function readJSONFile(fileName, folder) {
	var file = getFile(fileName, folder);
	var fileData = file.getBlob().getDataAsString();
	if (fileData) {
		return JSON.parse(fileData);
	} else {
		return null;
	}
}



//This function finds a given file on Google Drive
//If it does not exist, it creates a new text file
function getFile(fileName, folder) {
	var maxRetries = 3;
	var errors = [];
	if (!folder) {
		folder = DriveApp.getRootFolder();
	}
	while (maxRetries > 0) {
		try {
			var fileIter = folder.getFilesByName(fileName);
			if (!fileIter.hasNext()) {
				Logger.log('Could not find file: ' + fileName + ' on Google Drive. Creating new file.');
				return checkSaveFile(folder.createFile(fileName, ''), '');
			} else {
				return fileIter.next();
			}
		} catch (e) {
			errors.push(e);
			maxRetries--;
			Utilities.sleep(1000);
		}
	}
	if (maxRetries === 0) {
		throw new Error(errors.join('. '));
	}
}



function ReadMainFile() {

	var mainfolder = null;
	var hiddenfolder = null;

	var folders = DriveApp.getRootFolder().getFolders();

	while (folders.hasNext()) {
		var folder = folders.next();
		var folderName = folder.getName();

		if (folderName == 'context_settings') {
			if (!mainfolder)
				mainfolder = folder;
		} else {
			continue;
		}
	}


//добавлен поиск по ярлыку в директории root для общих папок (ярлыки - это файлы)
	var folders = DriveApp.getRootFolder().getFiles();

	while (folders.hasNext()) {
		var folder = folders.next();
		var folderName = folder.getName();
		var fileTargetId = folder.getTargetId();

		if (!fileTargetId)
			continue;

		var folder = DriveApp.getFolderById(fileTargetId);
		if (folder) {
			var folderName = folder.getName();
		} else {
			continue;
		}

		if (folderName == 'context_settings') {
			if (!mainfolder)
				mainfolder = folder;
		} else {
			continue;
		}
	}

	if (!mainfolder) {
		COMMON[COMMON.length] = 'Not found folder "context_settings" !!!, exit';
		Logger.log('Not found folder "context_settings" !!!, exit');
		return '';
	}


	var folders2 = mainfolder.getFolders();

	while (folders2.hasNext()) {
		var folder = folders2.next();
		var folderName = folder.getName();

		if (folderName != 'hidden') {
			continue;
		} else {
			hiddenfolder = folder;
			break;
		}
	}

	if (!hiddenfolder) {
		COMMON[COMMON.length] = 'Not found folder "context_settings/hidden" !!!, exit';
		Logger.log('Not found folder "context_settings/hidden" !!!, exit');
		return '';
	}

	var folders3 = hiddenfolder.getFolders();

	while (folders3.hasNext()) {
		var folder = folders3.next();
		var folderName = folder.getName();

		if (folderName != 'history') {
			continue;
		} else {
			historyfolder = folder;
			break;
		}
	}

	if (!historyfolder) {
		COMMON[COMMON.length] = 'Not found folder "context_settings/hidden/history" !!!, exit';
		Logger.log('Not found folder "context_settings/hidden/history" !!!, exit');
		return '';
	}


	var mainfileprev = 'payments.last.txt';

	if (testing_ID) {


		var TestCustomerId = '';
		var TestName = '';


		var TestNames = {}
		var TestCustomerIds = {}
		var TestNamesFromCustomerIds = {}
		var TestCustomerIdsFromCustomerIds = {}
		var TestNamesDubl = 0
		var TestScriptsIds = {}
		var TestScriptsIdsDubl = 0


		var testfile= 'testing.txt';

		if (!testingJob) {
			//читаем файл testing.txt
			//если есть ошибки в нем, останавливаем всегда, так как даже если сейчас режим просмотра, то скрипт может быть запущен в режиме исполнения


			var files = hiddenfolder.getFilesByName(testfile);
			if (files.hasNext()) {
				var file = files.next();
				var fileData = file.getBlob().getDataAsString();
				fileData = fileData.replace(/[\r]+/g, '');

				var alltests = fileData.split("\n");
				for (var i = 0; i < alltests.length; i++) {
					var found = alltests[i].match(/^\s*([\d]+)\s+([\d\-]+)\s+(([^\s\#][^\s]*)[\s\S]*)$/);
					if (found && found[1] && found[2] && found[3] && found[4]) {

						if (!TestNames[found[4]]) {
							TestNames[found[4]] = 1;
							TestCustomerIds[found[4]] = found[2];
							TestNamesFromCustomerIds[found[2]] = found[4]
							TestCustomerIdsFromCustomerIds[found[2]] = 1
						} else {
							TestNamesDubl = 1
							COMMON[COMMON.length] = 'Dublicate TestNames in test jobs file ' + found[4] + ', exit. Not working all testing scripts, check test jobs file';
							Logger.log('Dublicate TestNames in test jobs file ' + found[4] + ', exit. Not working all testing scripts, check test jobs file');
						}
						if (!TestScriptsIds[found[1]]) {
							TestScriptsIds[found[1]] = 1;
						} else {
							TestScriptsIdsDubl = 1
							COMMON[COMMON.length] = 'Dublicate TestScript Ids in test jobs file ' + found[1] + ', exit. Not working all testing scripts, check test jobs file';
							Logger.log('Dublicate TestScript Ids in test jobs file ' + found[1] + ', exit. Not working all testing scripts, check test jobs file');
						}
						if (TestNamesDubl || TestScriptsIdsDubl)
							return '';

						if (found[1] === String(testing_ID)) {
							TestCustomerId = found[2];
							testingJob = found[2] + ' ' + found[3]
							TestName = found[4];
						}
						
					}
				}

				
			}

		} else {

			//здесь точно режим просмотра

			//здесь тоже читаем файл testing.txt, что бы проверить ошибки в нем или совпадение с ним
			//если есть ошибки в нем, останавливаем всегда, так как даже если сейчас режим просмотра, то скрипт может быть запущен в режиме исполнения

			var files = hiddenfolder.getFilesByName(testfile);
			if (files.hasNext()) {
				var file = files.next();
				var fileData = file.getBlob().getDataAsString();
				fileData = fileData.replace(/[\r]+/g, '');

				var alltests = fileData.split("\n");
				for (var i = 0; i < alltests.length; i++) {
					var found = alltests[i].match(/^\s*([\d]+)\s+([\d\-]+)\s+(([^\s\#][^\s]*)[\s\S]*)$/);
					if (found && found[1] && found[2] && found[3] && found[4]) {

						if (!TestNames[found[4]]) {
							TestNames[found[4]] = 1;
							TestCustomerIds[found[4]] = found[2];
							TestNamesFromCustomerIds[found[2]] = found[4]
							TestCustomerIdsFromCustomerIds[found[2]] = 1
						} else {
							TestNamesDubl = 1
							COMMON[COMMON.length] = 'Dublicate TestNames in test jobs file ' + found[4] + ', exit. Not working all testing scripts, check test jobs file';
							Logger.log('Dublicate TestNames in test jobs file ' + found[4] + ', exit. Not working all testing scripts, check test jobs file');
						}
						if (!TestScriptsIds[found[1]]) {
							TestScriptsIds[found[1]] = 1;
						} else {
							TestScriptsIdsDubl = 1
							COMMON[COMMON.length] = 'Dublicate TestScript Ids in test jobs file ' + found[1] + ', exit. Not working all testing scripts, check test jobs file';
							Logger.log('Dublicate TestScript Ids in test jobs file ' + found[1] + ', exit. Not working all testing scripts, check test jobs file');
						}
						if (TestNamesDubl || TestScriptsIdsDubl)
							return '';
						
					}
				}

				
			}



			var found = testingJob.match(/^\s*([\d\-]+)\s+(([^\s\#][^\s]*)[\s\S]*)$/);
			if (found && found[1] && found[2] && found[3]) {
				TestCustomerId = found[1];
				TestName = found[3];
			}



/*

и опять закомментировал, так как максимум что произойдет, если на лету поменяли в конфиге фид на режим просмотра - если сейчас так попало, что полностью завершается любой исполняемый скрипт (а не завершается с продолжением), то он просто может переписать наш фид, который  тест в режиме просмотра, а потом он перезапустится с новыми настройками с другими фидами и уже не будет трогать наш тестовый фид, созданный в режиме просмотра
потому что вещь полезная - провести тест в режиме просмотра сразу без копирования конфигов, если видно что что-то не так, а так сильно ограничиваем эти возможности
в результате уже сделано, что бы не удаляли файлы друг друга 'test' и не 'test' (просмотр и выполнение)

то есть в итоге здесь (выше) надо только проверить корректность файла testing, но всегда, при любых запусках (что бы видеть проблему, которая в режиме просмотра не всплывет)



			if (TestNames[TestName]) {
//это неверно сделано, забыл что в режиме просмотра выполняются только фиды для просмотра, поэтому никак не перезапишет режим исполнения
//поэтому закомментировал

//опять раскомментировал ниже, так как даже в режиме просмотра, если изменили конфиг, и сейчас выполняется исполняемый режим, то режим просмотра будет конфликтовать и перезапишет, так как скрипт в любом режиме сначала завершает работу и все записывает, а потом только перечитывает конфиг, иначе заморочка нужна в конце не только с перечитыванием конфига, но и учетом всех переменных которые не меняют конфиг и с учетом в каком режиме запускалось все (так как делается в самом начале при старте)
//эта проверка делается только в режиме просмотра


				//нельзя тоже что бы повторялось c конфигом тестов, перезапишет файлы фида в режиме просмотра, а в конфиге тестов возможно задание на исполнение (мы не знаем здесь, поэтому так низзя)
				COMMON[COMMON.length] = 'Dublicate with TestName in test jobs file (need comment testingJob or this job in test file), exit';
				Logger.log('Dublicate with TestName in test jobs file (need comment testingJob or this job in test file), exit');
				return '';
			}
*/



		}


		if ((!TestCustomerId)||(!TestName)) {
			if (!AdWordsApp.getExecutionInfo().isPreview()) {
				COMMON[COMMON.length] = 'Empty or incorrect job (not found it in test jobs file), exit';
				Logger.log('Empty or incorrect job (not found it in test jobs file), exit');
			} else {
				COMMON[COMMON.length] = 'Empty or incorrect job (not found it in file testing.txt or in var testingJob), exit';
				Logger.log('Empty or incorrect job (not found it in file testing.txt or in var testingJob), exit');
			}
			return '';
		}


		if (SCRIPT_USED == 'ONE') {
			testingJob += ' LOW MERCHANTXMLONE';
		} else {
			testingJob += ' LOW MERCHANTXMLMAX';
		}


		var errorRealconf = 0

		var files = historyfolder.getFilesByName(mainfileprev);

		var allpayments = null;

		while (files.hasNext()) {
			var file = files.next();
			var fileData = file.getBlob().getDataAsString();
			fileData = fileData.replace(/[\r]+/g, '');
			var q = /^\s*START[\s\S]*\nEND\s*/;
			if (q.test(fileData)) {
				allpayments = fileData.split("\n");
			} else {
				//wait 30 sec
				Logger.log('Empty file or read error for "context_settings/hidden/history/' + mainfileprev + ' !!!, wait 30 sec');
				Utilities.sleep(30000);
				var fileData = file.getBlob().getDataAsString();
				fileData = fileData.replace(/[\r]+/g, '');
				if (q.test(fileData)) {
					allpayments = fileData.split("\n");
				} else {
					COMMON[COMMON.length] = 'Empty file or read error for "context_settings/hidden/history/' + mainfileprev + ' !!!, exit';
					Logger.log('Empty file or read error for "context_settings/hidden/history/' + mainfileprev + ' !!!, exit');
					errorRealconf = 1
					break;
					//return '';
				}
			}
			break;
		}


		if (!errorRealconf) {
			//проверка, что если есть в payments такой же пользователь, то должны совпадать CustomerId и CustomerName
			//если не совпадают, то в будет каша из запусков разных конфигов, каждый раз будет перезапускаться заново другой конфиг

			//переделал - это справедливо в режиме исполнения, в режиме просмотра фиды не пересекаются с исполнением, а РК не обновляются
			//поэтому надо сравнивать полностью payments с файлом testing, так как в нем может быть задание на исполнение, поэтому при пересечении файла testing и payments останавливаем всегда, что бы показать ошибку
			//если же запустится режим просмотра с указанием testingJob, то тогда можно задавать любые параметры - не пересечется ни с чем (разве что между собой, если я одновременно запущу режим просмотра в нескольких окнах, но это лишнее)
			//поэтому параметры из testingJob отслеживать на пересечение не нужно
			//поэтому закомментировал ниже кусок

			//все таки нужно, вернул то что было, но и оставил доработку, описанную в верхнем абзаце
			//опять раскомментировал ниже, так как даже в режиме просмотра, если изменили конфиг, и сейчас выполняется исполняемый режим, то режим просмотра будет конфликтовать и перезапишет, так как скрипт в любом режиме сначала завершает работу и все записывает, а потом только перечитывает конфиг, иначе заморочка нужна в конце не только с перечитыванием конфига, но и учетом всех переменных которые не меняют конфиг и с учетом в каком режиме запускалось все (так как делается в самом начале при старте)
			//фактически эта проверка делается только в режиме просмотра, так как для остальных уже проверили выше

			//и опять закомментировал, так как максимум что произойдет, если на лету поменяли в конфиге фид на режим просмотра - если сейчас так попало, что полностью завершается любой исполняемый скрипт (а не завершается с продолжением), то он просто может переписать наш фид, который  тест в режиме просмотра, а потом он перезапустится с новыми настройками с другими фидами и уже не будет трогать наш тестовый фид, созданный в режиме просмотра
			//потому что вещь полезная - провести тест в режиме просмотра сразу без копирования конфигов, если видно что что-то не так, а так сильно ограничиваем эти возможности
			//в результате уже сделано, что бы не удаляли файлы друг друга 'test' и не 'test' (просмотр и выполнение)

			//то есть в итоге, повторюсь - надо только полностью сравнивать payments с файлом testing, но всегда, при любых запусках (что бы видеть проблему, которая в режиме просмотра не всплывет)


			var now = getcurrentTime();
			var todayAtMidn = new Date(now.getFullYear(), now.getMonth(), now.getDate());


			var haveerrors = 0

			//for (var i = 0; i < allpayments.length; i++) {
			//нужно наоборот просматривать (нас интересует текущее, то есть последнее состояние клиента)
			var checkedCust = {}
			for (var i = allpayments.length - 1; i >= 0; i--) {
				var q = /^\s*\/\//;
				if (q.test(allpayments[i])) {
					continue;
				}
				var found = allpayments[i].match(/^\s*([\d\-]+)\s+(([^\s\#][^\s]*)[\s\S]*)$/);
				if (found && found[1] && found[2] && found[3]) {
					var CustomerId = found[1];
					var CustName = found[2];
					var Name = found[3];

					if (checkedCust[CustomerId]) {
						continue;
					} else {
						//только последнюю строку с этим ID проверяем (поэтому перебор с конца)
						checkedCust[CustomerId] = 1;
					}


					//если запускаем тестовый скрипт, то нельзя продолжать его запуск, если закончилось время обслуживания основного скрипта
					//иначе будут удаляться каждый час все промежуточные и другие файлы скриптом проверки SSCHE 1 (и будет полная ерунда)

					//SSCHE 1 может контролировать (удалять) фиды и др. файлы не сразу после окончания срока,
					//но здесь мы запрещаем запуск тестового скрипта сразу после окончания срока,
					//что бы не синхронизировать с изменениями в SSCHE 1 .
					//поэтому просто не разрешаем здесь запуск тестов, если в конфиге окончен срок работы аккаунта

					//это важный блок, если вдруг захочу убирать - никогда! или протестить все варианты логики
					//в т.ч. если этого блока ниже не будет, то для тестовых скриптов никто не проверит время окончания - так как если тестовый скрипт, то имя аккаунта всегда типа 'demodomain.com OPT MERCHANTXMLMAX'

					var endexist = 0;

					var red = new RegExp(/END(\d\d)\/(\d\d)\/(\d\d\d\d)/);
					var vArrd;
					if ((vArrd = red.exec(CustName)) != null) {

						// Set specificDate to a specified date at midnight.
						var specificDate1 = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);

						// Compare the two dates by comparing the millisecond
						// representations.
						if (todayAtMidn.getTime() >= specificDate1.getTime()) {
							endexist = 1;
						}
					}



					if (!endexist) {
						red = new RegExp(/STOP(\d\d)\/(\d\d)\/(\d\d\d\d)/);
						if ((vArrd = red.exec(CustName)) != null) {

							// Set specificDate to a specified date at midnight.
							var specificDate2 = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);

							// Compare the two dates by comparing the millisecond
							// representations.
							if (todayAtMidn.getTime() >= specificDate2.getTime()) {
								endexist = 1;
							}
						}
					}



					if ((TestCustomerIdsFromCustomerIds[CustomerId])&&(Name != TestNamesFromCustomerIds[CustomerId])) {
						if (endexist) {
							COMMON[COMMON.length] = 'TestCustomerId from test jobs file ' + CustomerId +' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file';
							Logger.log('TestCustomerId from test jobs file ' + CustomerId +' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file');
							haveerrors = 1
						} else if (CustName.indexOf("MERCHANTXML") == -1) {
							COMMON[COMMON.length] = 'TestCustomerId from test jobs file ' + CustomerId +' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now';
							Logger.log('TestCustomerId from test jobs file ' + CustomerId +' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now');
						} else {
							COMMON[COMMON.length] = 'TestCustomerId from test jobs file ' + CustomerId +' exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file';
							Logger.log('TestCustomerId from test jobs file ' + CustomerId +' exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file');
							haveerrors = 1
						}
					} else if (TestNames[Name]&&(CustomerId != TestCustomerIds[Name])) {
						if (endexist) {
							COMMON[COMMON.length] = 'TestCustomerName from test jobs file ' + Name + ' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file';
							Logger.log('TestCustomerName from test jobs file ' + Name + ' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file');
							haveerrors = 1
						} else if (CustName.indexOf("MERCHANTXML") == -1) {
							COMMON[COMMON.length] = 'TestCustomerName from test jobs file ' + Name +' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now';
							Logger.log('TestCustomerName from test jobs file ' + Name +' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now');
						} else {
							COMMON[COMMON.length] = 'TestCustomerName from test jobs file ' + Name + ' exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file';
							Logger.log('TestCustomerName from test jobs file ' + Name + ' exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file');
							haveerrors = 1
						}
					} else if (TestNames[Name]&&(CustomerId == TestCustomerIds[Name])) {

						if (endexist) {
							COMMON[COMMON.length] = 'TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file';
							Logger.log('TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file');
							haveerrors = 1
						} else {
							COMMON[COMMON.length] = 'TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now';
							Logger.log('TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now');
						}


					/*

теперь лучше срабатывает обнаружение одновременного запуска
поэтому закомментирована ошибка в SSMFD и в скрипте проверки аккаунтов - теперь всегда выдается предупреждение, но выполнение продолжается


						if (endexist) {
							COMMON[COMMON.length] = 'TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file';
							Logger.log('TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file');
							haveerrors = 1
						} else if (CustName.indexOf("MERCHANTXML") == -1) {
							COMMON[COMMON.length] = 'TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now';
							Logger.log('TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now');
						} else {
							//все таки ограничиваем, что нельзя запускать тест у тех кто может запустится официально 
							//(иначе есть шанс запустится одновременно, так как защита сейчас не дает гарантий 
							//в пределах одновременного запуска в течение 10 сек)
							//можно просто запустить тест для клиента на другом аккаунте
							COMMON[COMMON.length] = 'TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file';
							Logger.log('TestCustomer from test jobs file '+ CustomerId + ' ' + Name + ' exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file');
							haveerrors = 1
						}
					*/

					}


/*


выше комментарий, почему переделал и этот кусок закомментировал

раскомментировал, выше комментарий, почему
фактически эта проверка делается только в режиме просмотра, так как для остальных уже проверили выше

и опять закомментировал, так как максимум что произойдет, если на лету поменяли в конфиге фид на режим просмотра - если сейчас так попало, что полностью завершается любой исполняемый скрипт (а не завершается с продолжением), то он просто может переписать наш фид, который  тест в режиме просмотра, а потом он перезапустится с новыми настройками с другими фидами и уже не будет трогать наш тестовый фид, созданный в режиме просмотра
потому что вещь полезная - провести тест в режиме просмотра сразу без копирования конфигов, если видно что что-то не так, а так сильно ограничиваем эти возможности
в результате уже сделано, что бы не удаляли файлы друг друга 'test' и не 'test' (просмотр и выполнение)


			if (!haveerrors)

					if ((CustomerId == TestCustomerId)&&(Name != TestName)) {
						if (CustName.indexOf("MERCHANTXML") == -1) {
							COMMON[COMMON.length] = 'CustomerId = TestCustomerId from test jobs file, this is only inform comment now';
							Logger.log('In test jobs file CustomerId = TestCustomerId from test jobs file, this is only inform comment now');
						} else {
							COMMON[COMMON.length] = 'CustomerId = TestCustomerId from test jobs file !!!, exit';
							Logger.log('CustomerId = TestCustomerId from test jobs file !!!, exit');
							return '';
						}
					} else if ((Name == TestName)&&(CustomerId != TestCustomerId)) {
						if (CustName.indexOf("MERCHANTXML") == -1) {
							COMMON[COMMON.length] = 'CustomerName = TestCustomerName from test jobs file, this is only inform comment now';
							Logger.log('CustomerName = TestCustomerName from test jobs file, this is only inform comment now');
						} else {
							COMMON[COMMON.length] = 'CustomerName = TestCustomerName from test jobs file !!!, exit';
							Logger.log('CustomerName = TestCustomerName from test jobs file !!!, exit');
							return '';
						}
					} else if ((Name == TestName)&&(CustomerId == TestCustomerId)) {

						COMMON[COMMON.length] = 'Customer exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now';
						Logger.log('Customer exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now');

---комментируем кусок, начало----------
теперь лучше срабатывает обнаружение одновременного запуска
поэтому закомментирована ошибка здесь и в скрипте проверки аккаунтов - теперь всегда выдается предупреждение, но выполнение продолжается

						if (CustName.indexOf("MERCHANTXML") == -1) {
							COMMON[COMMON.length] = 'Customer exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now';
							Logger.log('Customer exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now');
						} else {
							//все таки ограничиваем, что нельзя запускать тест у тех кто может запустится официально 
							//(иначе есть шанс запустится одновременно, так как защита сейчас не дает гарантий 
							//в пределах одновременного запуска в течение 10 сек)
							//можно просто запустить тест для клиента на другом аккаунте
							COMMON[COMMON.length] = 'Customer exist in payments base with MERCHANTXMLMAX/ONE !!!, exit';
							Logger.log('Customer exist in payments base with MERCHANTXMLMAX/ONE !!!, exit');
							return '';
						}

---комментируем кусок, конец----------

					}

			}

*/


				}
			}


			if (haveerrors)
				return '';



		}



		var allpayments = [testingJob];



	} else {

		var files = historyfolder.getFilesByName(mainfileprev);

		var allpayments = null;

		while (files.hasNext()) {
			var file = files.next();
			var fileData = file.getBlob().getDataAsString();
			fileData = fileData.replace(/[\r]+/g, '');
			var q = /^\s*START[\s\S]*\nEND\s*/;
			if (q.test(fileData)) {
				allpayments = fileData.split("\n");
			} else {
				//wait 30 sec
				Logger.log('Empty file or read error for "context_settings/hidden/history/' + mainfileprev + ' !!!, wait 30 sec');
				Utilities.sleep(30000);
				var fileData = file.getBlob().getDataAsString();
				fileData = fileData.replace(/[\r]+/g, '');
				if (q.test(fileData)) {
					allpayments = fileData.split("\n");
				} else {
					COMMON[COMMON.length] = 'Empty file or read error for "context_settings/hidden/history/' + mainfileprev + ' !!!, exit';
					Logger.log('Empty file or read error for "context_settings/hidden/history/' + mainfileprev + ' !!!, exit');
					return '';
				}
			}
			break;
		}

	} // end testing_ID

	if (allpayments) {

		var AdwordsList = new Object();
		var paymentsCheckDublNoStop = new Object();
		var paymentsCheckDublNoStopAdwords = new Object();
		var paymentsCheckDubl = new Object();
		var paymentsCheckDublTime = new Object();
		var paymentsName = new Object();


		for (var i = 0; i < allpayments.length; i++) {
			var q = /^\s*\/\//;
			if (q.test(allpayments[i])) {
				continue;
			}
			var found = allpayments[i].match(/^\s*([\d\-]+)\s+(([^\s\#][^\s]*)[\s\S]*)$/);
			if (found && found[1] && found[2] && found[3]) {
				var CustomerId = found[1];
				var CustName = found[2];
				var Name = found[3];

				var startDateTime = 1;
				var now = getcurrentTime();
				var todayAtMidn = new Date(now.getFullYear(), now.getMonth(), now.getDate());
				var red = new RegExp(/START(\d\d)\/(\d\d)\/(\d\d\d\d)/);
				var vArrd;
				if ((vArrd = red.exec(CustName)) != null) {
					// Set specificDate to a specified date at midnight.
					var startDate = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);
					startDateTime = startDate.getTime();
				}

				if (startDateTime > todayAtMidn.getTime()) {
					paymentsCheckDublNoStop[Name] = 1;
					paymentsCheckDublNoStopAdwords[Name] = 1;
					continue;
				}

				if (paymentsCheckDubl[Name]) {
					if ((startDateTime <= todayAtMidn.getTime()) && (startDateTime > paymentsCheckDublTime[Name])) {
						paymentsCheckDublTime[Name] = startDateTime;
					} else {
						continue;
					}
				} else {
					paymentsCheckDubl[Name] = 1;
					paymentsCheckDublTime[Name] = startDateTime;
				}

				AdwordsList[CustomerId] = CustName;
				paymentsName[Name] = CustomerId;

			} else {

				var found = allpayments[i].match(/^\s*(([^\s\#][^\s]*)\s[\s\S]*CALL[\s\S]*)$/);
				if (found && found[1] && found[2]) {

					var CustName = found[1];
					var Name = found[2];

					var startDateTime = 1;
					var now = getcurrentTime();
					var todayAtMidn = new Date(now.getFullYear(), now.getMonth(), now.getDate());
					var red = new RegExp(/START(\d\d)\/(\d\d)\/(\d\d\d\d)/);
					var vArrd;
					if ((vArrd = red.exec(CustName)) != null) {
						// Set specificDate to a specified date at midnight.
						var startDate = new Date(vArrd[2] + "/" + vArrd[1] + "/" + vArrd[3]);
						startDateTime = startDate.getTime();
					}

					if (startDateTime > todayAtMidn.getTime()) {
						paymentsCheckDublNoStop[Name] = 1;
						continue;
					}

					if (paymentsCheckDubl[Name]) {
						if ((startDateTime <= todayAtMidn.getTime()) && (startDateTime > paymentsCheckDublTime[Name])) {
							paymentsCheckDublTime[Name] = startDateTime;
							//удаляем данные о записи Adwords (если есть) (запись CALL "победила", у нее старше дата начала START)
							if (paymentsName.hasOwnProperty(Name)) {
								delete AdwordsList[paymentsName[Name]];
								delete paymentsName[Name];
							}
						} else {
							continue;
						}
					} else {
						paymentsCheckDubl[Name] = 1;
						paymentsCheckDublTime[Name] = startDateTime;
					}

				}

			}
		}

		return [AdwordsList, paymentsCheckDublNoStop, paymentsCheckDublNoStopAdwords];

	}


	COMMON[COMMON.length] = 'Not found file "context_settings/hidden/history/' + mainfileprev + ' !!!, exit';
	Logger.log('Not found file "context_settings/hidden/history/' + mainfileprev + ' !!!, exit');
	return '';

}


function getcurrentGMTTime() {
	return new Date(Utilities.formatDate(new Date(), "GMT", "EEE, dd MMM yyyy HH:mm:ss"));
}


//stopscan - полная остановка дальнейшего сканирования всего сайта, если все фиды имеют параметр MAX_ADD_URLS и у всех фидов он превышен
var ScanCreateFeedsGlobalVars = {errors: "", warnings: "", messages: "", stopscan: 0, init: {}};
         

function ScanCreateFeeds(feedsAlreadyChecked,foundURLHASHdublicates,SITES_CHECKED_FILE_NAME,IDName,CustomerName,StartScanFlg) {

	var didExitEarly = false;

	ScanCreateFeedsGlobalVars = {errors: "", warnings: "", messages: "", stopscan: 0, SITES_CHECKED_FILE_NAME: SITES_CHECKED_FILE_NAME, NOparsed_urls_list: '', init: {}};



			//feedsAlreadyChecked['config']
			//feedsAlreadyChecked['scanids']
			//feedsAlreadyChecked['scannId']
			//feedsAlreadyChecked['CURfeedsIds']
			//feedsAlreadyChecked['scanned']

	var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];



	//если нужн трассировка
	if (AdWordsApp.getExecutionInfo().isPreview()||OneSiteConfig['Debug_On']) {
		if (OneSiteConfig['Debug_On']) {
			ScanCreateFeedsGlobalVars.debug = OneSiteConfig['Debug_On'];
		} else {
			ScanCreateFeedsGlobalVars.debug = 1;
		}
	}


	ScanCreateFeedsGlobalVars.CustomerName = CustomerName;


	ScanCreateFeedsGlobalVars.SITE = OneSiteConfig['SITE'];


	ScanCreateFeedsGlobalVars.CHARSET = OneSiteConfig['CHARSET'];


	ScanCreateFeedsGlobalVars.seed = OneSiteConfig['seed'];


	if (OneSiteConfig.hasOwnProperty('skip_query'))
		ScanCreateFeedsGlobalVars.skip_query = OneSiteConfig['skip_query'];


	if (OneSiteConfig.hasOwnProperty('only_query'))
		ScanCreateFeedsGlobalVars.only_query = OneSiteConfig['only_query'];


	if (OneSiteConfig.hasOwnProperty('scanFun'))
		ScanCreateFeedsGlobalVars.scanFun = OneSiteConfig['scanFun'];


	if (OneSiteConfig.hasOwnProperty('skip_errors'))
		ScanCreateFeedsGlobalVars.skip_errors = OneSiteConfig['skip_errors'];

	if (OneSiteConfig.hasOwnProperty('repeat_errors'))
		ScanCreateFeedsGlobalVars.repeat_errors = OneSiteConfig['repeat_errors'];


	if (OneSiteConfig.hasOwnProperty('valid_scheme'))
		ScanCreateFeedsGlobalVars.valid_scheme = OneSiteConfig['valid_scheme'];


	if (OneSiteConfig.hasOwnProperty('REQUEST_DELAY'))
		ScanCreateFeedsGlobalVars.REQUEST_DELAY=OneSiteConfig['REQUEST_DELAY'];



	if (OneSiteConfig.hasOwnProperty('IGNORE_EMPTY_CONTENT_TYPE'))
		ScanCreateFeedsGlobalVars.IGNORE_EMPTY_CONTENT_TYPE = OneSiteConfig['IGNORE_EMPTY_CONTENT_TYPE'];


	if (OneSiteConfig.hasOwnProperty('MAX_TRIES'))
		ScanCreateFeedsGlobalVars.MAX_TRIES = OneSiteConfig['MAX_TRIES'];



	if (OneSiteConfig.hasOwnProperty('MAX_CHECKED_URLS'))
		ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS=OneSiteConfig['MAX_CHECKED_URLS'];


	if (OneSiteConfig.no_urlsearchtoLowerCase)
		ScanCreateFeedsGlobalVars.no_urlsearchtoLowerCase=1;


	//перед startInitFun
	ScanCreateFeedsGlobalVars.init = {};
	ScanCreateFeedsGlobalVars.init.feedsAlreadyChecked = feedsAlreadyChecked;
	ScanCreateFeedsGlobalVars.init.foundURLHASHdublicates = foundURLHASHdublicates;
	ScanCreateFeedsGlobalVars.init.IDName = IDName;
//эта строка есть только в parseHtml.php, здесь она не нужна (можно получить конфиг одного сайта)
//	ScanCreateFeedsGlobalVars.init.OneSiteConfig = OneSiteConfig;


	preparestartFeed();


//этот фрагмент отсутствует в скрипте тестового парсинга
if (CONTROL_EMPTY_FEEDS) {
	startFeed(feedsAlreadyChecked,foundURLHASHdublicates,IDName);
	return didExitEarly;
}


	if ((!ScanCreateFeedsGlobalVars.errors)&&OneSiteConfig.hasOwnProperty('startInitFun')) {

		try {

	        	OneSiteConfig.startInitFun(StartScanFlg);
			if (ScanCreateFeedsGlobalVars.stopscan) {
				Logger.log('All feeds added MAX_ADD_URLS num urls, stop Scan and exit');
				didExitEarly = false;
			}


		} catch (e) {
			ScanCreateFeedsGlobalVars.errors += 'bad function startInitFun:' + e.message + "\n";
			Logger.log(ScanCreateFeedsGlobalVars.errors);
		}

	}


	//при наличии stopscan или ошибок не запускаем endInitFun
	if ((!ScanCreateFeedsGlobalVars.errors)&&(!ScanCreateFeedsGlobalVars.stopscan)) {

		didExitEarly = startFeed(feedsAlreadyChecked,foundURLHASHdublicates,IDName);

		if ((!ScanCreateFeedsGlobalVars.errors)&&OneSiteConfig.hasOwnProperty('endInitFun')) {

			try {

				if (ScanCreateFeedsGlobalVars.stopscan) {
					var stscex = 1;
				} else {
					var stscex = 0;
				}

				//что бы понять что это последний шаг, передаем !didExitEarly (флаг последнего шага EndScanFlg)
	        		OneSiteConfig.endInitFun(!didExitEarly);
				if ((!stscex)&&ScanCreateFeedsGlobalVars.stopscan) {
					//stopscan появился в endInitFun (до этого не было)
					Logger.log('All feeds added MAX_ADD_URLS num urls, stop Scan and exit');
					didExitEarly = false;
				}

			} catch (e) {
				ScanCreateFeedsGlobalVars.errors += 'bad function endInitFun:' + e.message + "\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
			}

		}


	} else {
		//есть stopscan в startInitFun или ошибка, не запускаем endInitFun, запускаем startFeed до момента создания начальных данных и завершаем ее (что бы уменьшить вероятность возникновения ошибок)
		// для stopscan didExitEarly уже установлен, для ошибки didExitEarly не имеет значения
		//в обоих случаях didExitEarly все равно равен false (еще нигде не мог изменится)
		startFeed(feedsAlreadyChecked,foundURLHASHdublicates,IDName);

	}


	return didExitEarly;

}





function GetQuotedUrl(str) {
    var quote = str.substring(0, 1);
    if ((quote != "\"") && (quote != "'")) // Only process a string 
    { // starting with singe or
        return str; // double quotes
    }

    var ret = "";
    var len = str.length;
    for (var i = 1; i < len; i++) // Start with 1 to skip first quote
    {
        var ch = str.substr(i, 1);

        if (ch == quote) break; // End quote reached

        ret += ch;
    }

    return ret;
}


function GetHREFValue(anchor) {

    var split1 = anchor.split('href=');

    //если нет href= выходим
    if (split1[0] == anchor) return '';

    var split2 = split1[1].split(">");

    var spaces_split = split2[0].split(" ");

    var url = spaces_split[0];

    var first_ch = url.substring(0, 1);
    if ((first_ch == "\"") || (first_ch == "'")) {
        url = GetQuotedUrl(url);
    }
    return url;
}



function ValidateCSVURL(url_base, url) {


	var parsed_base_url = parse_url(url_base);
	if (parsed_base_url === false)
		return false;


	var SITE_SCHEME = parsed_base_url["protocol"];
	var SITE_HOST = parsed_base_url["host"];


	if (!SITE_HOST) return false;
	if (!SITE_SCHEME) return false;

	var match;
	if (SITE_HOST && (match = SITE_HOST.match(/([^a-zA-Z0-9\-\.])/)) && match[1]) {

		SITE_HOST = idndomain(SITE_HOST);
		var schemeIDN = parsed_base_url['protocol'] ? parsed_base_url['protocol'] + '://' : '';
		var portIDN = parsed_base_url['port'] ? ':' + parsed_base_url['port'] : '';
		var queryIDN = parsed_base_url['query'] ? parsed_base_url['query'] : '';
		var url_base = schemeIDN + SITE_HOST + portIDN + queryIDN;
		parsed_base_url = parse_url(url_base);
		if (parsed_base_url === false)
			return false;

	}





	var parsed_url = parse_url(url);

	if (!parsed_url)
		return false;


	var host = parsed_url["host"];


	var match;
	if (host && (match = host.match(/([^a-zA-Z0-9\-\.])/)) && match[1]) {


		host = idndomain(host);

		var schemeIDN = parsed_url['protocol'] ? parsed_url['protocol'] + '://' : '';
		var portIDN = parsed_url['port'] ? ':' + parsed_url['port'] : '';
		var queryIDN = parsed_url['query'] ? parsed_url['query'] : '';
		url = schemeIDN + host + portIDN + queryIDN;
		parsed_url = parse_url(url);
		if (parsed_url === false)
			return false;


	}



	var scheme = parsed_url["protocol"];



	if (!host) // Handle URLs without host value
	{

		if (parsed_url.pathname.substr(0, 1) == '/')  // Handle absolute URL
		{

			url = SITE_SCHEME + "://" + SITE_HOST + url;
		} else // Handle relative URL
		{


			path = parsed_base_url['pathname'];


			if (substr(path, -1) == '/') // URL is a directory
			{
				// Construct full URL
				url = SITE_SCHEME + "://" + SITE_HOST + path + url;

			} else // URL is a file
			{
				var dirname = dirnameFun(path);

				// Add slashes if needed
				if (substr(dirname, -1) != '/') {
					dirname = dirname + "/";
				}

				// Construct full URL
				url = SITE_SCHEME + "://" + SITE_HOST + dirname + url;
			}
		}


		parsed_url = parse_url(url);
		if (parsed_url === false)
			return false;

	} else if (!scheme) {
//если неуказан протокол, то берем с парсируемого сайта
                url = SITE_SCHEME + "://" + url;
		parsed_url = parse_url(url);
		if (parsed_url === false)
			return false;
	}



	var url2 = urlEncoding(url);
	if (url2 !== url) {
		url = url2;
		parsed_url = parse_url(url);
	} else {
		url = url2;
	}

	if (host)  {
//добавил условие host, что бы явно указать, что правило ниже используется только на изначально полном url (хост указан на странице)
		if (parsed_url["pathname"].substr(0, 1) != '/') {
//добавляем слеш, если нет (скорее всего нет pathname) - не по правилам сформирована ссылка на сайте, например http://domain.com?aaa=1
			parsed_url = parse_url(url);
			url = (parsed_url.protocol ? parsed_url.protocol + '://' : '') + parsed_url.hostname + parsed_url.port + '/' + parsed_url.pathname + parsed_url.search;
			parsed_url = parse_url(url);
			if (parsed_url === false)
				return false;
		}
	}


//убираем /../ /./ из pathname
	var changepath = 0;
	var re = new RegExp('(?!\\/\\.\\.\\/)\\/[^\\/]+\\/\\.\\.\\/');
	while (1) {
		var path = parsed_url.pathname.replace(re, "/")
		if (path !== parsed_url.pathname) {
			changepath = 1;
			parsed_url.pathname = path;
		} else {
			break;
		}
	}

	var re = new RegExp('\\/\\.(?=\\/)', "g");
	var path = parsed_url.pathname.replace(re, "")
	if (path !== parsed_url.pathname) {
		changepath = 1;
		parsed_url.pathname = path;
	}


	if (changepath) {
		url = (parsed_url.protocol ? parsed_url.protocol + '://' : '') + parsed_url.hostname + parsed_url.port + parsed_url.pathname + parsed_url.search;
//		parsed_url = parse_url(url);
//		if (parsed_url === false)
//			return false;
	}





	return url;
}


function ValidateURL(url_base, url, noSkipUrl) {

	var SITE_SCHEME = ScanCreateFeedsGlobalVars.SITE_SCHEME;
	var SITE_HOST = ScanCreateFeedsGlobalVars.SITE_HOST;

	var valid_scheme = ScanCreateFeedsGlobalVars.valid_scheme;


	var parsed_url = parse_url(url);

	if (!parsed_url)
		return false;



	var match;
	if (parsed_url["pathname"] && (match = parsed_url["pathname"].match(/(\.[^\/\.]+)$/)) && match[1]) {
		var ras = {
			'.wml': 1,
			'.txt': 1,
			'.java': 1,
			'.fcgi': 1,
			'.pdf': 1,
			'.xls': 1,
			'.js': 1,
			'.swf': 1,
			'.zip': 1,
			'.bin': 1,
			'.dms': 1,
			'.exe': 1,
			'.class': 1,
			'.so': 1,
			'.dll': 1,
			'.mid': 1,
			'.midi': 1,
			'.kar': 1,
			'.wav': 1,
			'.gif': 1,
			'.jpeg': 1,
			'.jpg': 1,
			'.jpe': 1,
			'.wbmp': 1,
			'.css': 1,
			'.rtf': 1,
			'.gz': 1,
			'.doc': 1,
			'.tar': 1,
			'.png': 1,
			'.rar': 1
		};
		if (ras[match[1]] && ras[match[1].toLowerCase()]) {
			return false;
		}
	}


	var host = parsed_url["host"];


	var match;
	if (host && (match = host.match(/([^a-zA-Z0-9\-\.])/)) && match[1]) {


		host = idndomain(host);

		var schemeIDN = parsed_url['protocol'] ? parsed_url['protocol'] + '://' : '';
		var portIDN = parsed_url['port'] ? ':' + parsed_url['port'] : '';
		var queryIDN = parsed_url['query'] ? parsed_url['query'] : '';
		url = schemeIDN + host + portIDN + queryIDN;
		parsed_url = parse_url(url);
		if (parsed_url === false)
			return false;


	}


	// Skip URL if different host
	if ((host != SITE_HOST) && host) return false;


	var scheme = parsed_url["protocol"];


	if (valid_scheme && valid_scheme.length) {
		if (scheme) {
			var exists = 0;
			for (var v in valid_scheme) {
				if (valid_scheme[v] == scheme) {
					exists = 1;
				}
			}
			if (!exists)
				return false;
		}
	} else {
		// Skip URL if different scheme or not relative URL (skips also mailto)
		if ((scheme != SITE_SCHEME) && scheme) return false;
	}



	// Check for page anchor in url
	if (parsed_url.hash) {
		if (url === parsed_url.hash) {
			//если есть только anchor и нет хоста, например, #001 значит это anchor на текущей странице, а она уже проверена раньше, выходим
			return false;
		} else {
			//убираем анчор
			url = (parsed_url.protocol ? parsed_url.protocol + '://' : '') + parsed_url.hostname + parsed_url.port + parsed_url.pathname + parsed_url.search;
			parsed_url = parse_url(url);
			if (parsed_url === false)
				return false;

		}
	}




	if (!host) // Handle URLs without host value
	{

		if (parsed_url.pathname.substr(0, 1) == '/')  // Handle absolute URL
		{

			url = SITE_SCHEME + "://" + SITE_HOST + url;
		} else // Handle relative URL
		{


			var parsed_base_url = parse_url(url_base);
			if (parsed_base_url === false)
				return false;

			path = parsed_base_url['pathname'];


			if (path && (path.substr(-1) == '/')) // URL is a directory
			{
				// Construct full URL
				url = SITE_SCHEME + "://" + SITE_HOST + path + url;

			} else // URL is a file
			{
				var dirname = dirnameFun(path);

				// Add slashes if needed
				if (!(dirname && (dirname.substr(-1) == '/'))) {
					dirname = dirname + "/";
				}

				// Construct full URL
				url = SITE_SCHEME + "://" + SITE_HOST + dirname + url;
			}
		}


		parsed_url = parse_url(url);
		if (parsed_url === false)
			return false;

	} else if (!scheme) {
//если неуказан протокол, то берем с парсируемого сайта
                url = SITE_SCHEME + "://" + url;
		parsed_url = parse_url(url);
		if (parsed_url === false)
			return false;
	}



	var url2 = urlEncoding(url);
	if (url2 !== url) {
		url = url2;
		parsed_url = parse_url(url);
	} else {
		url = url2;
	}


	if (host)  {
//добавил условие host, что бы явно указать, что правило ниже используется только на изначально полном url (хост указан на странице)
		if (parsed_url["pathname"].substr(0, 1) != '/') {
//добавляем слеш, если нет (скорее всего нет pathname) - не по правилам сформирована ссылка на сайте, например http://domain.com?aaa=1
			parsed_url = parse_url(url);
			url = (parsed_url.protocol ? parsed_url.protocol + '://' : '') + parsed_url.hostname + parsed_url.port + '/' + parsed_url.pathname + parsed_url.search;
			parsed_url = parse_url(url);
			if (parsed_url === false)
				return false;
		}
	}


//убираем /../ /./ из pathname
	var changepath = 0;
	var re = new RegExp('(?!\\/\\.\\.\\/)\\/[^\\/]+\\/\\.\\.\\/');
	while (1) {
		var path = parsed_url.pathname.replace(re, "/")
		if (path !== parsed_url.pathname) {
			changepath = 1;
			parsed_url.pathname = path;
		} else {
			break;
		}
	}

	var re = new RegExp('\\/\\.(?=\\/)', "g");
	var path = parsed_url.pathname.replace(re, "")
	if (path !== parsed_url.pathname) {
		changepath = 1;
		parsed_url.pathname = path;
	}


	if (changepath) {
		url = (parsed_url.protocol ? parsed_url.protocol + '://' : '') + parsed_url.hostname + parsed_url.port + parsed_url.pathname + parsed_url.search;
//		parsed_url = parse_url(url);
//		if (parsed_url === false)
//			return false;
	}




	if ((!noSkipUrl)&&(SkipURL(parsed_url["pathname"] + parsed_url["search"]))) {
		//не проверяются ссылки href='#...' (проверены выше)
		//везде удалены из ссылок анчоры #...
		//        Logger.log("Skip URL " + url);
		return false;
	}



	return url;
}


function idndomain(domain, decodeflg) {


    //на базе https://github.com/bestiejs/punycode.js
    //что бы реально получить домен надо доработать
    //проверка
    //http://wservices.ru/idnconv.php

    if (typeof domain != 'string') {
        return domain;
    }

    if (domain == '') {
        return domain;
    }


    domain = domain.toLowerCase();


    var TMIN = 1;
    var TMAX = 26;
    var BASE = 36;
    var SKEW = 38;
    var DAMP = 700; // initial bias scaler
    var INITIAL_N = 128;
    var INITIAL_BIAS = 72;
    var MAX_INTEGER = Math.pow(2, 53);

    function adapt_bias(delta, n_points, is_first) {
        // scale back, then increase delta
        delta /= is_first ? DAMP : 2;
        delta += ~~(delta / n_points);

        var s = (BASE - TMIN);
        var t = ~~((s * TMAX) / 2); // threshold=455

        for (var k = 0; delta > t; k += BASE) {
            delta = ~~(delta / s);
        }

        var a = (BASE - TMIN + 1) * delta;
        var b = (delta + SKEW);

        return k + ~~(a / b);
    }

    function next_smallest_codepoint(codepoints, n) {
        var m = 0x110000; // unicode upper bound + 1

        for (var i = 0, len = codepoints.length; i < len; ++i) {
            var c = codepoints[i];
            if (c >= n && c < m) {
                m = c;
            }
        }

        // sanity check - should not happen
        if (m >= 0x110000) {
            throw new Error('Next smallest code point not found.');
        }

        return m;
    }

    function encode_digit(d) {
        return d + (d < 26 ? 97 : 22);
    }

    function decode_digit(d) {
        if (d >= 48 && d <= 57) {
            return d - 22; // 0..9
        }
        if (d >= 65 && d <= 90) {
            return d - 65; // A..Z
        }
        if (d >= 97 && d <= 122) {
            return d - 97; // a..z
        }
        throw new Error('Illegal digit #' + d);
    }

    function threshold(k, bias) {
        if (k <= bias + TMIN) {
            return TMIN;
        }
        if (k >= bias + TMAX) {
            return TMAX;
        }
        return k - bias;
    }

    function encode_int(bias, delta) {
        var result = [];

        for (var k = BASE, q = delta;; k += BASE) {
            var t = threshold(k, bias);
            if (q < t) {
                result.push(encode_digit(q));
                break;
            } else {
                result.push(encode_digit(t + ((q - t) % (BASE - t))));
                q = ~~((q - t) / (BASE - t));
            }
        }

        return result;
    }

    function encode(input) {
        if (typeof input != 'string') {
            return input;
        }

        input = input.split('').map(function(c) {
            return c.charCodeAt(0);
        });

        var output = [];
        var non_basic = [];

        for (var i = 0, len = input.length; i < len; ++i) {
            var c = input[i];
            if (c < 128) {
                output.push(c);
            } else {
                non_basic.push(c);
            }
        }

        var b, h;
        b = h = output.length;

        if (b) {
            output.push(45); // delimiter '-'
        }

        var n = INITIAL_N;
        var bias = INITIAL_BIAS;
        var delta = 0;

        for (var len = input.length; h < len; ++n, ++delta) {
            var m = next_smallest_codepoint(non_basic, n);
            delta += (m - n) * (h + 1);
            n = m;

            for (var i = 0; i < len; ++i) {
                var c = input[i];
                if (c < n) {
                    if (++delta == MAX_INTEGER) {
                        throw new Error('Delta overflow.');
                    }
                } else if (c == n) {
                    // TODO append in-place?
                    // i.e. -> output.push.apply(output, encode_int(bias, delta));
                    output = output.concat(encode_int(bias, delta));
                    bias = adapt_bias(delta, h + 1, b == h);
                    delta = 0;
                    h++;
                }
            }
        }

        return String.fromCharCode.apply(String, output);
    }

    function decode(input) {
        if (typeof input != 'string') {
            return input;
        }

        // find basic code points/delta separator
        var b = 1 + input.lastIndexOf('-');

        input = input.split('').map(function(c) {
            return c.charCodeAt(0);
        });

        // start with a copy of the basic code points
        var output = input.slice(0, b ? (b - 1) : 0);

        var n = INITIAL_N;
        var bias = INITIAL_BIAS;

        for (var i = 0, len = input.length; b < len; ++i) {
            var org_i = i;

            for (var k = BASE, w = 1;; k += BASE) {
                var d = decode_digit(input[b++]);

                // TODO overflow check
                i += d * w;

                var t = threshold(k, bias);
                if (d < t) {
                    break;
                }

                // TODO overflow check
                w *= BASE - t;
            }

            var x = 1 + output.length;
            bias = adapt_bias(i - org_i, x, org_i == 0);
            // TODO overflow check
            n += ~~(i / x);
            i %= x;

            output.splice(i, 0, n);
        }

        return String.fromCharCode.apply(String, output);
    }



    domain = domain.split('.');

    if (decodeflg) {
        for (var i = 0, len = domain.length; i < len; ++i) {
            if (domain[i] != '') {
                if (domain[i].substring(0, 4) == 'xn--') {
                    var d = domain[i].substring(4);
                    var c = decode(d);
                    if (c != d) {
                        domain[i] = c;
                    }
                }
            }
        }
    } else {
        for (var i = 0, len = domain.length; i < len; ++i) {
            var c = encode(domain[i]);
            var l = c.length;
            //если это английские буквы то в конце появится -, то есть на входе domain а на выходе domain-
            var d = c.substring(l - 1, l);
            if (!((d == '-') && (c.substring(0, l - 1) == domain[i]))) {
                if (c != '')
                    domain[i] = 'xn--' + c;
            }
        }
    }


    domain = domain.join('.');

    return domain;




}
//конец function idndomain


function urlEncode(string, escaped) {
    //https://support.google.com/adwords/answer/6305348
    //https://gist.github.com/jarrodbell/1214016
    function hex(code) {
        var hex = code.toString(16).toUpperCase();
        if (hex.length < 2) {
            hex = 0 + hex;
        }
        return '%' + hex;
    }

    if (!string) {
        return '';
    }

    string = string + '';


    //стандартный набор
    //		var reserved_chars = /[ \r\n!*"'();:@&=+$,\/?%#\[\]<>{}|`^\\\u0080-\uffff]/;



    if (escaped == 'beforequest') {
        //зачем перед отправкой еще раз кодировать: например на такой строке гугл fetch выдаст ошибку
        //http://technotest.com.ua/dlya-zernovoy-promyshlennosti/laboratornye-melnicy/laboratornaya-melnica-s-vodyanym-ohlazhdeniem-lm7020.html?utm_source=yandex&utm_medium=cpc&utm_campaign=cid|{campaign_id}|{source_type}&utm_content=gid|{gbid}|aid|{ad_id}|{phrase_id}_{retargeting_id}&utm_term={keyword}'
        //http://technotest.com.ua/dlya-zernovoy-promyshlennosti/laboratornye-melnicy/laboratornaya-melnica-s-vodyanym-ohlazhdeniem-lm7020.html?utm_source=yandex&utm_medium=cpc&utm_campaign=cid||&utm_content=gid||aid||_&utm_term=';
        //поэтому перед запросом еще раз обрабатываем url (но без дополнительной перекодировки кодированных символов, поэтому убрано %)
        //все исключенные символы: &=+/?%#:  - так не будет коряжится основной url, но проблемы уйдут
        var reserved_chars = /[ \r\n!*"'();@$,\[\]<>{}|`^\\\u0080-\uffff]/
    } else if (escaped == 'beforequest2') {
	//добавили &=?+ в кодирование beforequest, что бы полностью url можно было передавать в качестве параметра
	//+ обязательно тоже добавлен, иначе если в url есть + то заменит при раскодировке на пробелы
        var reserved_chars = /[ \r\n!*"'();@&=?+$,\[\]<>{}|`^\\\u0080-\uffff]/
    } else if (escaped) {
        //{escapedlpurl}
        //			var reserved_chars = /[:/?=%"#]/
        //чего не перекодирует escapedlpurl реально, а не по документации '() все остальное кодирует
        //еще у него глюк при перекодировке
        var reserved_chars = /[ \r\n!*";:@&=+$,\/?%#\[\]<>{}|`^\\\u0080-\uffff]/
    } else {
        //{lpurl}
        //			var reserved_chars = /[%?="#\t' ]/
        //чего не перекодирует lpurl реально, а не по документации :,/() все остальное кодирует
        //еще у него глюк при перекодировке
        var reserved_chars = /[ \r\n!*"';@&=+$?%#\[\]<>{}|`^\\\u0080-\uffff]/
    }

    var str_len = string.length,
        i, string_arr = string.split(''),
        c;

    for (i = 0; i < str_len; i++) {
        if (c = string_arr[i].match(reserved_chars)) {
            c = c[0].charCodeAt(0);

            if (c < 128) {
                string_arr[i] = hex(c);
            } else if (c < 2048) {
                string_arr[i] = hex(192 + (c >> 6)) + hex(128 + (c & 63));
            } else if (c < 65536) {
                string_arr[i] = hex(224 + (c >> 12)) + hex(128 + ((c >> 6) & 63)) + hex(128 + (c & 63));
            } else if (c < 2097152) {
                string_arr[i] = hex(240 + (c >> 18)) + hex(128 + ((c >> 12) & 63)) + hex(128 + ((c >> 6) & 63)) + hex(128 + (c & 63));
            }
        }
    }
    return string_arr.join('');
};


function urlDecode(string) {
    //https://gist.github.com/jarrodbell/1214016
	if (!string) {
		return '';
	}
	return string.replace(/%[a-fA-F0-9]{2}/ig, function (match) {
		return String.fromCharCode(parseInt(match.replace('%', ''), 16));
	});
};



function parseHtmlEnteties(str) {
    //может и не надо для гугла, возможно он сам преобразует, но на всякий случай убираем HTML-сущности
    //сделал сборную функцию
    str = str.replace(/\&amp;#/mg, '&#') // The rest, for double-encodings
        .replace(/\&quot;/mg, '"')
        .replace(/\&quote;/mg, '"')
        .replace(/&amp;/mg, "&")
        .replace(/&lt;/mg, "<")
        .replace(/&gt;/mg, ">");

    return str.replace(/&#([0-9]{1,3});/gi, function(match, numStr) {
        var num = parseInt(numStr, 10); // read num as normal number
        return String.fromCharCode(num);
    });
}



function dirnameFun(path) {
    //  discuss at: http://locutus.io/php/dirname/
    // original by: Ozh
    // improved by: XoraX (http://www.xorax.info)
    //   example 1: dirname('/etc/passwd')
    //   returns 1: '/etc'
    //   example 2: dirname('c:/Temp/x')
    //   returns 2: 'c:/Temp'
    //   example 3: dirname('/dir/test/')
    //   returns 3: '/dir'

    if (path[0] != '/') {
        path = "/" + path;
    }

    return path.replace(/\\/g, '/')
        .replace(/\/[^/]*\/?$/, '')
}


function parse_url(url) {
    var url = url.trim();
    if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.no_urlsearchtoLowerCase) {
    	var match = url.match(/^([^?]*)(\?.*)?$/);
    	url = (match && match[1] !== undefined ? match[1].toLowerCase() : '') + (match && match[2] !== undefined ? match[2] : '');
    } else {
    	url = url.toLowerCase();
    }
//    var match = url.match(/^((https?)\:\/\/)?((([^:\/?&#]+[\.][^:\/?&#]+)|(\[[^\/?&#]+\]))?(?:\:([0-9]+))?)?((\/[^?&#]*)?(\?[^#]*)?(#.*)?)?$/);
    //учтены вроде все варианты, в том числе плохие ссылки не будут отдаваться, например /pathname/&, даже IP ipv6 и ../aaaa ./fffff
//    var match = url.match(/^((https?)\:\/\/)?((([^:\/?&#]+[\.][^:\/?&#]+)|(\[[^\/?&#]+\]))?(?:\:([0-9]+))?(?!\.))?(([\/\.][^?&#]*)?(\?[^#]*)?(#.*)?)?$/);
//еще нужно учеть вариант без слеша типа href = aaaa.html?3333 (такие ссылки обрабатываются в ValidateUrl и т.п.)
//    var match = url.match(/^((https?)\:\/\/)?((([^:\/?&#]+[\.][^:\/?&#]+)|(\[[^\/?&#]+\]))?(?:\:([0-9]+))?(?!\.))?(([\/\.\w\-][^?&#]*)?(\?[^#]*)?(#.*)?)?$/);
//    if (match && ( match[2] || match[3] || match[4] || match[7] ) && match[9] && !(match[9].substr(0, 1) == '/' || match[9].substr(0, 1) == '.'))
//если нет слеша у pathname, то не может быть protocol и host
//         match = null


    //http://example.com:3000/pathname/?search=test#hash  
//    var parsed = {};
//   parsed.href = url; // => "http://example.com:3000/pathname/?search=test#hash"
//    parsed.protocol = match && match[2] !== undefined ? match[2] : ''; // => "http:"
//    parsed.host = match && match[3] !== undefined ? match[3] : ''; // => "example.com:3000"
//    parsed.hostname = match && match[4] !== undefined ? match[4] : ''; // => "example.com"
//    parsed.port = match && match[7] !== undefined ? match[7] : ''; // => "3000"
//    parsed.query = match && match[8] !== undefined ? match[8] : ''; // => "/pathname/?search=test#hash"
//    parsed.pathname = match && match[9] !== undefined ? match[9] : ''; // => "/pathname/"
//    parsed.search = match && match[10] !== undefined ? match[10] : ''; // => "?search=test"
//    parsed.hash = match && match[11] !== undefined ? match[11] : ''; // => "#hash"

//если только отдельно делать toLowerCase() для элементов, то следующая проверка ниже не пройдет при наличии больших букв

//    if ((parsed.protocol ? parsed.protocol + '://' : '') + parsed.hostname + parsed.port + parsed.pathname + parsed.search + parsed.hash !== url) {
//        return false;
//    }


    //домен не может быть без протокола, точнее без // (это по правилам ссылок, иначе product-Mobil_1__FS_x1_5W_40_5_l._PROMO-u будет востприниматься как домен)
    //https://stackoverflow.com/questions/43803778/href-without-https-prefix
    var match = url.match(/^((((https?)\:)?\/\/)((([^:\/?&#]+[\.][^:\/?&#]+)|(\[[^\/?&#]+\]))?(?:\:([0-9]+))?(?!\.)))?(([\/\.\w\-][^?&#]*)?(\?[^#]*)?(#.*)?)?$/);

    if (match && ( match[2] || match[5] ) && match[11] && !(match[11].substr(0, 1) == '/' || match[11].substr(0, 1) == '.'))
       match = null

    full_protocol = match && match[2] !== undefined ? match[2] : ''; // => "http://"

    //http://example.com:3000/pathname/?search=test#hash  
    var parsed = {};
    parsed.href = url; // => "http://example.com:3000/pathname/?search=test#hash"
    parsed.protocol = match && match[4] !== undefined ? match[4] : ''; // => "http:"
    parsed.host = match && match[5] !== undefined ? match[5] : ''; // => "example.com:3000"
    parsed.hostname = match && match[6] !== undefined ? match[6] : ''; // => "example.com"
    parsed.port = match && match[9] !== undefined ? match[9] : ''; // => "3000"
    parsed.query = match && match[10] !== undefined ? match[10] : ''; // => "/pathname/?search=test#hash"
    parsed.pathname = match && match[11] !== undefined ? match[11] : ''; // => "/pathname/"
    parsed.search = match && match[12] !== undefined ? match[12] : ''; // => "?search=test"
    parsed.hash = match && match[13] !== undefined ? match[13] : ''; // => "#hash"


//если только отдельно делать toLowerCase() для элементов, то следующая проверка ниже не пройдет при наличии больших букв

    if (full_protocol + parsed.host + parsed.pathname + parsed.search + parsed.hash !== url) {
//full_protocol может быть просто  // тогда протокол не передается, а только домен
        return false;
    }

    return parsed;

}

//https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions
//строка экранирования символов
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
}


function urlEncoding(url) {

//убираем html-сущности
//	url = parseHtmlEnteties(url);
	if (Encoder.hasEncoded(url)) {
		url = Encoder.htmlDecode(url);
	}

//переводим в нижний регистр, это обязательно, иначе в базу будут попадать ссылки с разным регистром
	if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.no_urlsearchtoLowerCase) {
		var match = url.match(/^([^?]*)(\?.*)?$/);
		url = (match && match[1] !== undefined ? match[1].toLowerCase() : '') + (match && match[2] !== undefined ? match[2] : '');
	} else {
		url = url.toLowerCase();
	}

//теперь кодируем всякие служебные символы и символы из верхней таблицы (при этом не будет повторной перекодировки)
	url = urlEncode(url, 'beforequest')

	return url;

}


//https://plainjs.com/javascript/utilities/merge-two-javascript-objects-19/
//самая быстрая функция объединения хешей (в гугле нет Object.extend)
Object.extend = function(obj, src) {
    Object.keys(src).forEach(function(key) { obj[key] = src[key]; });
    return obj;
}

//самая быстрая функция определения пустого хеша
function HashisEmpty(obj) {
    return Object.keys(obj).length === 0;
}  

//еще намного быстрее если знаем элемент, для хеша абров меток
function ABORTHashisEmpty(obj) {
//но! должен быть элемент ''
    return !obj[''];
}  


function CreatePauseCampaign(FeedId,CampaignNum,Budget,addToName,IDName) {
//создает/делает неактивной кампанию
//новый вариант
//пособирал из разных источников нужные поля и провел эксперименты, вроде работает
//https://support.google.com/adwords/editor/answer/30570?hl=en
//https://support.google.com/adwords/editor/answer/48538
//https://support.google.com/adwords/editor/answer/57747?hl=en

	if (AdWordsApp.getExecutionInfo().isPreview())
		return null;

	var columns = [
		"Campaign", "Budget", "Bid Strategy type", "Networks", "Campaign type", "Campaign status"
	];
 

	var CampaignName = FeedId + '.' + CampaignNum + '.'
	if (addToName) {
		CampaignName += ' ' + addToName;
	}


try {
	var upload = AdWordsApp.bulkUploads().newCsvUpload(columns, { moneyInMicros: false });

	//можно указать еще партнеров, например
	//"Networks": "Google search; Search Partners"
	//"Networks": "Google search; Search Partners; Display Network"

	upload.append({
		"Campaign": CampaignName,
		"Budget": Budget,
		"Bid Strategy type": "Manual CPC",
		"Campaign type": "Search",
  		"Campaign status": "Paused",
		"Networks": "Google search"
	});

	upload.forCampaignManagement();
	upload.apply();

	//сейчас нужно подождать пару секунд, иначе кампания не успеет создаться
	Utilities.sleep(5000);

} catch (e) {
	ScanCreateFeedsGlobalVars.warnings += 'Search Campaign with name "' + CampaignName + ' not created: ' + "Exception: " + e.message + "\n";
	Logger.log(ScanCreateFeedsGlobalVars.warnings);
}


	//может не сработать, тогда нужно отследить и выйти

	var caIter = AdWordsApp.campaigns()
		.withCondition("CampaignName = '" + CampaignName.replace(/\'/gm, '\\\'') + "'")
		.withCondition('CampaignStatus = PAUSED')
		.withCondition("CampaignTrialType IN ['BASE']")
		.get();


	if (caIter.hasNext()) {
		var campaign = caIter.next();
		return campaign;
	} else {


								//метка критических ошибок отличается по названию от аналогичных меток в других местах

								var Today = getcurrentTime();
								var todayString = ('0' + Today.getDate()).slice(-2) + '.' + ('0' + (Today.getMonth() + 1)).slice(-2);
		
								var LastDateCriticlaErrCheck = getLabel('LastcrUnknCaErr');

								var subject = "Критическaя ошибка (нужно создать вручную одну или несколько кампаний - см. лог) в аккаунте Adwords " + IDName;

								var criticalerrors = subject;
	
								//после первой отправки блокируем повторные отправки за теже сутки писем по этому клиенту
								if (LastDateCriticlaErrCheck != todayString) {
									if ((typeof criticalsupportemail != 'undefined') && (criticalsupportemail)) {
										MailApp.sendEmail(criticalsupportemail, subject, criticalerrors);
									}
								}

//								Logger.log(criticalerrors)

								if (LastDateCriticlaErrCheck != todayString) {
									Logger.log(criticalerrors)
									setLabel('LastcrUnknCaErr', todayString);
								}



		Logger.log('Search Campaign with name "' + CampaignName + '" and with Budget ' + Budget + ' is not created in account, please create manually, exit');
		var campaign = null;


	}
	return campaign;


}


function CreatePauseCampaignOld(FeedId,CampaignNum,Budget,addToName) {
//создает/делает неактивной кампанию
//старый вариант, уже не работает

//примеры добавления/модификации кампаний
//https://pastebin.com/xhxmqQcV
//https://developers.google.com/google-ads/scripts/docs/examples/bulk-upload
//https://developers.google.com/google-ads/scripts/docs/reference/adsapp/adsapp_csvupload
//https://support.google.com/adwords/editor/answer/56368
//https://developers.google.com/adwords/scripts/docs/features/bulk-upload-entities


	if (AdWordsApp.getExecutionInfo().isPreview())
		return null;

	var columns = [
		'Campaign', 'Budget', 'Campaign type', 'Campaign subtype', 'Bid Strategy type', 'Campaign state'
	];
 
	var upload = AdWordsApp.bulkUploads().newCsvUpload(columns, { moneyInMicros: false });
 
	var CampaignName = FeedId + '.' + CampaignNum + '.'
	if (addToName) {
		CampaignName += ' ' + addToName;
	}

	upload.append({
		'Campaign': CampaignName,
		'Budget': Budget,
		'Campaign type': 'Search Only',
		'Campaign subtype': 'All features',
		'Bid Strategy type': 'cpc',
		'Campaign state': 'paused'
	});

	upload.forCampaignManagement();
	upload.apply();

	//сейчас нужно подождать пару секунд, иначе кампания не успеет создаться
	Utilities.sleep(5000);

	//может не сработать, тогда нужно отследить и выйти

	var caIter = AdWordsApp.campaigns()
		.withCondition("CampaignName = '" + CampaignName.replace(/\'/gm, '\\\'') + "'")
		.withCondition('CampaignStatus = PAUSED')
		.withCondition("CampaignTrialType IN ['BASE']")
		.get();


	if (caIter.hasNext()) {
		var campaign = caIter.next();
		return campaign;
	} else {
		Logger.log('Search Campaign with name ' + CampaignName + ' and with Budget ' + Budget + ' is not created in account, please create manually, exit');
		var campaign = null;
	}
	return campaign;


}



// Helper function to transform AdWordsDate
// objects to normal Date objects.
function awDateToDate(awDate) {
	return new Date(awDate.year,
		floorN(awDate.month, 0) - 1,
		awDate.day, 0, 0, 0);
}

function DateToawDate(Date) {
	return {
		year: Date.getFullYear(),
		month: floorN(Date.getMonth(), 0) + 1,
		day: Date.getDate()
	};
}


function SetCampaignadSchedules(campaign) {
//при создании кампании 0 устанавливаем ей подробное круглосуточное расписание каждый день по всем часам, что бы можно было потом легко управлять


	var adScheduleIterator = campaign.targeting().adSchedules().get();
	if (adScheduleIterator.hasNext()) {
		//есть расписание
		return;
	}


	var weekday = new Array(7);
	weekday[0] = "SUNDAY";
	weekday[1] = "MONDAY";
	weekday[2] = "TUESDAY";
	weekday[3] = "WEDNESDAY";
	weekday[4] = "THURSDAY";
	weekday[5] = "FRIDAY";
	weekday[6] = "SATURDAY";



	for (var i = 0; i < weekday.length; i++) {
//не больше 6 периодов в сутки может быть, делаем каждые 4 часа
		for (var ii = 0; ii < 6; ii++) {
			campaign.addAdSchedule({
			   dayOfWeek: weekday[i],
			   startHour: ii*4,
			   startMinute: 0,
			   endHour: ii*4 + 4,
			   endMinute: 0,
			   bidModifier: 1
			 });
		}
	}


}


function CopyCampaignSettings(SourceCampaign,campaign) {
//копируем настройки кампании 0 в другую кампанию (новую или остановленную)
//все настройки, кроме языков и ставки, если есть она

	var errors = '';

	var targeting = SourceCampaign.targeting();
	var campaigntargeting = campaign.targeting();


        var scheduleIter = campaigntargeting.adSchedules().get();
	while (scheduleIter.hasNext()) {
		var schedule = scheduleIter.next();
		schedule.remove();
		schedule.remove();
	}
	var scheduleIter = targeting.adSchedules().get();
	while (scheduleIter.hasNext()) {
		var schedule = scheduleIter.next();
		campaign.addAdSchedule(schedule);
	}


//к сожалению невозможно установить/скопировать "Люди из целевых местоположений"
        var locationIter = campaigntargeting.targetedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		location.remove();
		location.remove();
	}
	var locationIter = targeting.targetedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		campaign.addLocation(location);
	}


	var locationIter = campaigntargeting.excludedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		location.remove();
		location.remove();
	}
	var locationIter = targeting.excludedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		campaign.excludeLocation(location);
	}


	var proximityIter = campaigntargeting.targetedProximities().get();
	while (proximityIter.hasNext()) {
		var proximity = proximityIter.next();
		proximity.remove();
		proximity.remove();
	}
	var proximityIter = targeting.targetedProximities().get();
	while (proximityIter.hasNext()) {
		var proximity = proximityIter.next();
		campaign.addProximity(proximity);
	}



        var platformIter = targeting.platforms().get();
	var platformBid = {};
	while (platformIter.hasNext()) {
		var platform = platformIter.next();
		var BidModifier = platform.getBidModifier();
		var Name = platform.getName();
		platformBid[Name] = BidModifier;
	}
	var platformIter = campaigntargeting.platforms().get();
	while (platformIter.hasNext()) {
		var platform = platformIter.next();
		var Name = platform.getName();
		if (platformBid.hasOwnProperty(Name)) {
			platform.setBidModifier(platformBid[Name]);
		} else {
			platform.setBidModifier(0);
		}												
	}



	campaign.setAdRotationType(SourceCampaign.getAdRotationType())


	var budget = SourceCampaign.getBudget().getAmount();
	if (campaign.getBudget().getAmount() != budget)
		campaign.getBudget().setAmount(budget)



	var Strategy = SourceCampaign.bidding().getStrategy();
	if (!Strategy) {
		//это не гибкая стратегия, а анонимная
		var Strategy = SourceCampaign.bidding().getStrategyType();
		if (Strategy) {
			try {
				campaign.bidding().setStrategy(Strategy);
			} catch(e) {
				//эта анонимная стратегия здесь не может быть установлена, применяем что-то стандартное TARGET_SPEND или MANUAL_CPC
				campaign.bidding().setStrategy("MANUAL_CPC");
			}
		} else {
			campaign.bidding().setStrategy("MANUAL_CPC");
		}
	} else {
		campaign.bidding().setStrategy(Strategy);
	}


	var sEndDate = SourceCampaign.getEndDate();
	var caEndDate = campaign.getEndDate();
	if (JSON.stringify(sEndDate) != JSON.stringify(caEndDate)) {
		if (sEndDate === null) {
			//null - поэтому делаем максимум
			campaign.setEndDate("20371230");
		} else {
			var now = getcurrentTime();
			var todayAtMidn = new Date(now.getFullYear(), now.getMonth(), now.getDate());
			var EndDate = awDateToDate(sEndDate);
			if (EndDate.getTime() < todayAtMidn.getTime()) {
				//нельзя устанавливать дату меньше сегодняшней - выдаст ошибку
				campaign.setEndDate(DateToawDate(todayAtMidn));
			} else {
				campaign.setEndDate(sEndDate);
			}
		}
	}


	var campaignextensions = campaign.extensions();
	var extensions = SourceCampaign.extensions();


	//уточнения
	var CampaignCalloutIter = campaignextensions.callouts().get()
	while (CampaignCalloutIter.hasNext()) {
		var CampaignCallout = CampaignCalloutIter.next();
		campaign.removeCallout(CampaignCallout);
	}
	var CampaignCalloutIter = extensions.callouts().get()
	while (CampaignCalloutIter.hasNext()) {
		var CampaignCallout = CampaignCalloutIter.next();
		campaign.addCallout(CampaignCallout)  
	}



	var PhoneNumberIter = campaignextensions.phoneNumbers().get()
	while (PhoneNumberIter.hasNext()) {
		var PhoneNumber = PhoneNumberIter.next();
		campaign.removePhoneNumber(PhoneNumber);
	}
	var PhoneNumberIter = extensions.phoneNumbers().get()
	while (PhoneNumberIter.hasNext()) {
		var PhoneNumber = PhoneNumberIter.next();
		campaign.addPhoneNumber(PhoneNumber)  
	}
										


	var MobileAppIter = campaignextensions.mobileApps().get()
	while (MobileAppIter.hasNext()) {
		var MobileApp = MobileAppIter.next();
		campaign.removeMobileApp(MobileApp);
	}
	var MobileAppIter = extensions.mobileApps().get()
	while (MobileAppIter.hasNext()) {
		var MobileApp = MobileAppIter.next();
		campaign.addMobileApp(MobileApp)  
	}



	var CampaignSitelinkIter = campaignextensions.sitelinks().get()
	while (CampaignSitelinkIter.hasNext()) {
		var CampaignSitelink = CampaignSitelinkIter.next();
		campaign.removeSitelink(CampaignSitelink);
	}
	var CampaignSitelinkIter = extensions.sitelinks().get()
	while (CampaignSitelinkIter.hasNext()) {
		var CampaignSitelink = CampaignSitelinkIter.next();
		campaign.addSitelink(CampaignSitelink)  
	}


	//структурированные описания
	var CampaignSnippetIter = campaignextensions.snippets().get()
	while (CampaignSnippetIter.hasNext()) {
		var CampaignSnippet = CampaignSnippetIter.next();
		campaign.removeSnippet(CampaignSnippet);
	}
	var CampaignSnippetIter = extensions.snippets().get()
	while (CampaignSnippetIter.hasNext()) {
		var CampaignSnippet = CampaignSnippetIter.next();
		campaign.addSnippet(CampaignSnippet)  
	}



	var negativeKeywordListIterator = campaign.negativeKeywordLists().get();
	while (negativeKeywordListIterator.hasNext()) {
		var negativeKeywordList = negativeKeywordListIterator.next();
		campaign.removeNegativeKeywordList(negativeKeywordList);
	}
	var negativeKeywordListIterator = SourceCampaign.negativeKeywordLists().get();
	while (negativeKeywordListIterator.hasNext()) {
		var negativeKeywordList = negativeKeywordListIterator.next();
		campaign.addNegativeKeywordList(negativeKeywordList);
	}



	var ExcludedPlacementListIterator = campaign.excludedPlacementLists().get();
	while (ExcludedPlacementListIterator.hasNext()) {
		var ExcludedPlacementList = ExcludedPlacementListIterator.next();
		campaign.removeExcludedPlacementList(ExcludedPlacementList);
	}
	var ExcludedPlacementListIterator = SourceCampaign.excludedPlacementLists().get();
	while (ExcludedPlacementListIterator.hasNext()) {
		var ExcludedPlacementList = ExcludedPlacementListIterator.next();
		campaign.addExcludedPlacementList(ExcludedPlacementList);
	}


//нашел скрипт для копирования аудиторий https://www.brainlabsdigital.com/copy-audiences-to-campaigns/
//https://searchengineland.com/heres-script-copies-audiences-campaigns-271089
//кое-что взял оттуда
	var Audiences = campaigntargeting.audiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		var AudienceType = audience.getAudienceType()
		//выдает ошибку при копировании "внутренних" аудиторий, только можно из общей библиотеки
		if (AudienceType == 'USER_INTEREST') continue;
		audience.remove()
		audience.remove()
	}
	var Audiences = campaigntargeting.excludedAudiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		audience.remove()
		audience.remove()
	}

	var targetingSetting = targeting.getTargetingSetting("USER_INTEREST_AND_LIST");
	campaigntargeting.setTargetingSetting("USER_INTEREST_AND_LIST", targetingSetting);

	var Audiences = targeting.audiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		var audienceId = audience.getAudienceId()
		var BidModifier = audience.bidding().getBidModifier()
		var AudienceType = audience.getAudienceType()
		//выдает ошибку при копировании "внутренних" аудиторий, только можно из общей библиотеки
		if (AudienceType == 'USER_INTEREST') continue;
	
		var audienceBuilder = campaigntargeting.newUserListBuilder()
		.withAudienceId(audienceId)
		.withBidModifier(BidModifier)
		.build()

		if (audienceBuilder.isSuccessful()) {
			var campaignaudience = audienceBuilder.getResult();
		} else {
			errors += audienceBuilder.getErrors() + "\n";
		}
	}
	var Audiences = targeting.excludedAudiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		var audienceId = audience.getAudienceId()

		var audienceBuilder = campaigntargeting.newUserListBuilder()
		.withAudienceId(audienceId)
		.exclude()

		if (audienceBuilder.isSuccessful()) {
			var campaignaudience = audienceBuilder.getResult();
		} else {
			errors += audienceBuilder.getErrors() + "\n";
		}
	}

	return errors;

}

function preparestartFeed() {

	var didExitEarly = false;


	var SITE = ScanCreateFeedsGlobalVars.SITE;


	var parsed_url = parse_url(SITE);
	if (parsed_url === false) {
		ScanCreateFeedsGlobalVars.errors += "Not good parameter SITE.\n";
		Logger.log(ScanCreateFeedsGlobalVars.errors);
		return didExitEarly;
	}


	var host = parsed_url['host'];


	var match;
	if ((host) && (match = host.match(/([^a-zA-Z0-9\-\.])/)) && match[1]) {

	        host = idndomain(host);

	        var schemeIDN = parsed_url['protocol'] ? parsed_url['protocol'] + '://' : '';
	        var portIDN = parsed_url['port'] ? ':' + parsed_url['port'] : '';
        	var queryIDN = parsed_url['query'] ? parsed_url['query'] : '';
	        var url = schemeIDN + host + portIDN + queryIDN;
        	parsed_url = parse_url(url);
		if (parsed_url === false) {
			ScanCreateFeedsGlobalVars.errors += "Not good parameter SITE.\n";
			Logger.log(ScanCreateFeedsGlobalVars.errors);
			return didExitEarly;
		}

	} else {
		var url = SITE;
	}




	var url2 = urlEncoding(url);
	if (url2 !== url) {
		url = url2;
		parsed_url = parse_url(url);
	} else {
		url = url2;
	}


	if (host)  {
//добавил условие host, что бы явно указать, что правило ниже используется только на изначально полном url (хост указан на странице)
		if (parsed_url["pathname"].substr(0, 1) != '/') {
//добавляем слеш, если нет (скорее всего нет pathname) - не по правилам сформирована ссылка на сайте, например http://domain.com?aaa=1
			parsed_url = parse_url(url);
			url = (parsed_url.protocol ? parsed_url.protocol + '://' : '') + parsed_url.hostname + parsed_url.port + '/' + parsed_url.pathname + parsed_url.search;
			parsed_url = parse_url(url);
			if (parsed_url === false) {
				ScanCreateFeedsGlobalVars.errors += "Not good parameter SITE.\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
				return didExitEarly;
			}
		}
	}



	ScanCreateFeedsGlobalVars.SITE_SCHEME = parsed_url['protocol'];
	var SITE_SCHEME = ScanCreateFeedsGlobalVars.SITE_SCHEME;
	ScanCreateFeedsGlobalVars.SITE_HOST = parsed_url['host'];
	var SITE_HOST = ScanCreateFeedsGlobalVars.SITE_HOST;

	ScanCreateFeedsGlobalVars.url = url;



	if (!SITE_SCHEME) {
		ScanCreateFeedsGlobalVars.errors += "Not good parameter SITE (protocol not exist).\n";
		Logger.log(ScanCreateFeedsGlobalVars.errors);
		return didExitEarly;
	}

	var valid_scheme = ScanCreateFeedsGlobalVars.valid_scheme;
	if (valid_scheme && valid_scheme.length) {
		if (SITE_SCHEME) {
			var exists = 0;
			for (var v in valid_scheme) {
				if (valid_scheme[v] == SITE_SCHEME) {
					exists = 1;
				}
			}
			if (!exists) {
				ScanCreateFeedsGlobalVars.errors += "Not good parameter SITE (it protocol not exist in parameter valid_scheme).\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
				return didExitEarly;
			}
		}
	}


	return didExitEarly;

}


function startFeed(feedsAlreadyChecked,foundURLHASHdublicates,IDName) {

	var didExitEarly = false;

	var url = ScanCreateFeedsGlobalVars.url;


	if ((!foundURLHASHdublicates.array)||(foundURLHASHdublicates.seed !== ScanCreateFeedsGlobalVars.seed)||(foundURLHASHdublicates.host !== ScanCreateFeedsGlobalVars.host)) {
		foundURLHASHdublicates.seed = ScanCreateFeedsGlobalVars.seed;
		foundURLHASHdublicates.host = ScanCreateFeedsGlobalVars.SITE_HOST;
		foundURLHASHdublicates.array = {};
	}



	if (!feedsAlreadyChecked.scanned.scanned) {
//		feedsAlreadyChecked.scanned = {};
//массив найденных ссылок при сканировании (присутствует значение ссылки)
		feedsAlreadyChecked.scanned.scanned = [];
//массив проверенных ссылок после того как их нашли (присутствует 1 если проверена)
		feedsAlreadyChecked.scanned.checked = [];

		feedsAlreadyChecked.scanned.referrer = [];
		feedsAlreadyChecked.scanned.referrer_field = [];

		feedsAlreadyChecked.scanned.URLHASHIDscanned = {};

		feedsAlreadyChecked.scanned.errors = {};
		feedsAlreadyChecked.scanned.errors.response = {};
		feedsAlreadyChecked.scanned.errors.unknown = 0;
		feedsAlreadyChecked.scanned.errors.unknownCSV = 0;
		feedsAlreadyChecked.scanned.errors.abnormal_exits = 0;
		feedsAlreadyChecked.scanned.errors.quick_exits = 0;
		feedsAlreadyChecked.scanned.errors.emptyCType = 0;
		feedsAlreadyChecked.scanned.errors.notHtml = 0;
		feedsAlreadyChecked.scanned.scnuncur = 0;
//		feedsAlreadyChecked.scanned.add_urls = 0;
		feedsAlreadyChecked.scanned.FeedsFilesOUT = {};
		feedsAlreadyChecked.scanned.SearchFeedsFilesOUT = {}
		feedsAlreadyChecked.scanned.parced_urls = {};
		feedsAlreadyChecked.scanned.GASearch_urls = {};
		feedsAlreadyChecked.scanned.addfeed_urls = {};
		feedsAlreadyChecked.scanned.GASearch_modifyurls = {};
		feedsAlreadyChecked.scanned.NOparced_urls = {};
		feedsAlreadyChecked.scanned.dublicates_urls = 0;
		feedsAlreadyChecked.scanned.GASearch = {};
		feedsAlreadyChecked.scanned.GASearchForEachCompany = {};
		feedsAlreadyChecked.scanned.GASearchCurrentCompany = {};
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			feedsAlreadyChecked.scanned.parced_urls[i] = 0;
			feedsAlreadyChecked.scanned.GASearch_urls[i] = 0;
			feedsAlreadyChecked.scanned.addfeed_urls[i] = 0;
			feedsAlreadyChecked.scanned.GASearch_modifyurls[i] = 0;
			feedsAlreadyChecked.scanned.NOparced_urls[i] = 0;
			feedsAlreadyChecked.scanned.FeedsFilesOUT[i] = {};
//SearchFeedsFilesOUT нет значения, это важно, он один и не должен быть массив пока не началась запись, все аналогично FeedsFilesOUT только там многомерный для каждого расширения и строчный а не массив значений
			feedsAlreadyChecked.scanned.SearchFeedsFilesOUT[i] = '';
			feedsAlreadyChecked.scanned.GASearch[i] = {};
			feedsAlreadyChecked.scanned.GASearchForEachCompany[i] = [];
			feedsAlreadyChecked.scanned.GASearchCurrentCompany[i] = 0;
		}
		feedsAlreadyChecked.scanned.checked_urls = 0;
		feedsAlreadyChecked.scanned.FeedsFilesExistNames = {};

	}


	var scanned = feedsAlreadyChecked.scanned;

	if (!scanned.steps)
		scanned.steps = 0;



	//если при инициализации уже есть stopscan или ошибка, то сюда надо зайти, что бы установить начальные данные, что бы уменьшить вероятность возникновения ошибок при выходе
	if (ScanCreateFeedsGlobalVars.stopscan||ScanCreateFeedsGlobalVars.errors) {

		//надо заблокировать выдачу критических ошибок (скан не запускался)
		//используем что обязательно feedsAlreadyChecked.scanned.steps == 0 !

		return didExitEarly;
	}


	//мы не можем сохранить на диске реальный полный хеш селектора/итератора каждой группы или другого объекта гугл рекламы с помощью JSON,
	//поэтому пишем в массив то что можно сохранить на текущее выполнение скрипта,
	//что бы не запрашивать повторно хеш группы (так как это долгий запрос), если сейчас понадобятся данные этой группы
	//кстати - что бы съэкономить память - можно этот хеш не сохранять, тогда точно каждый запрос данных группы будет реальным, а не браться из буферного массива
	ScanCreateFeedsGlobalVars.GASearchHASH={};
	for (var i in feedsAlreadyChecked['CURfeedsIds']) {
		ScanCreateFeedsGlobalVars.GASearchHASH[i] = {}
	}



	//каждый раз собираем инфу о существующих кампаниях в каждом фиде и количестве используемых групп в них
	ScanCreateFeedsGlobalVars.GASearchCampaigns={};
	ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum = {}
	for (var i in feedsAlreadyChecked['CURfeedsIds']) {
		ScanCreateFeedsGlobalVars.GASearchCampaigns[i] = []
		ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[i] = 0
	}


	var readyToScan = 0;

if ((!scanned.scnuncur)||(scanned.scnuncur <= scanned.scanned.length)) {
//иначе насильно не выполняем эту операцию, так как дальше скана не будет точно

	readyToScan = 1;


	//проверка корректности репитера
	var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
	if (OneSiteConfig.repeaterUrl) {
		var httpOptions = {
			contentType: "text/html",
			muteHttpExceptions: true,
			followRedirects: false,
  			headers : {
//				"User-Agent": "Mozilla/5.0",
				"Referer" : "http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"
			}
		}

		var response = UrlFetchApp.fetch(OneSiteConfig.repeaterUrl, httpOptions);
		var responseCode = response.getResponseCode();

		if (!((responseCode == 200)&&(!response.getContentText()))) {
			ScanCreateFeedsGlobalVars.errors += 'Not found repeater from parameter repeaterUrl' + "\n";
			Logger.log(ScanCreateFeedsGlobalVars.errors);

//			var report = ScanCreateFeedsGlobalVars.SITE + "\n" ;
//			report += 'EXECUTE ERRORS: ' + ScanCreateFeedsGlobalVars.errors + "\n\n"; //Ошибка при выполнении
//			scanned.report = report;
			return didExitEarly;
        	}

	}




//находим все кампании в фидах и заносим в массив
	var warnstart = '';
//	ScanCreateFeedsGlobalVars.GASearchCampaign = {}
	var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
	for (var feed_id in OneSiteConfig) {
		//перебираем разрешенные сейчас фиды сайта
		if (OneSiteConfig['feeds'][feed_id]) {
		//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
			if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
			//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта
				var OneFeedGASearch = scanned.GASearch[feed_id];
				var OneFeedConfig = OneSiteConfig[feed_id];
				var GAS = OneFeedConfig['GASearch'];
				if (GAS&&GAS['Id']) {

					//сначала ищем все камании, которые принадлежать фиду (всегда отделяем точкой)
					//например первая сгенерированная кампания site.feed.id0.0. остальные site.feed.id0.1. site.feed.id0.2. и так далее
					//ищем все по признаку site.feed.id0.
					//кампания site.feed.id0.0. является основной, у нее берутся настройки для других кампаний


					//почему при каждом проходе надо проверять кампании
					//основная причина - надо знать реальное число "живых" групп в них после удалений, абров и пр.
					//иначе будет сложнейший алгоритм учета, который все равно даст ошибки при длительном скане

					var caIter = AdWordsApp.campaigns()
						.withCondition("CampaignName CONTAINS '" + GAS['Id'].replace(/\'/gm, '\\\'') + '.' + "'")
						.withCondition('CampaignStatus != REMOVED')
						.withCondition("CampaignTrialType IN ['BASE']")
						.get();


					while (caIter.hasNext()) {
						var campaign = caIter.next();

						var campaignId = campaign.getId();
						var campaignName = campaign.getName();

  						var match = campaignName.match(new RegExp('(?:^|\\s)' + escapeRegExp(GAS['Id']) + '\\.(\\d+)\\.'));
						if (match&&match[1]) {
							//подходит под шаблон названия кампании

							var canum = Number(match[1])

							var agNum = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').get().totalNumEntities();


							if (!ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][canum]) {

								if (ScanCreateFeedsGlobalVars.CustomerName.indexOf("NOBIDM") != -1) {
									var Campaignstartbid = GAS.startbid;
								} else {
									campaignName = campaignName.replace(/(MCLSET1?:\d*\:\d+)\,/gm, '$1.');
									var red = new RegExp(/MCLSET1?:\d*\:(\d+(\.\d+)?)/);
									var vArrd;
									if (((vArrd = red.exec(campaignName)) !== null)&&vArrd[1]) {
										//заменяем startbid если есть
										//есть ставка для кампании, нет умножения ставок, можно брать число
										var Campaignstartbid = floorN(vArrd[1], 2);
									} else {
										var Campaignstartbid = GAS.startbid;
									}
								}
								ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][canum] = [campaign,agNum,Campaignstartbid];

								if (!canum) {
									//для кампании 0 ставим или проверяем подробное круглосуточное расписание
									SetCampaignadSchedules(campaign);
								}


							} else {

								removeCampaignbuffer(campaignId)
								Logger.log('Campaign (' + canum +  ') with GASearch Id ' + GAS['Id'] + " have duplicate company name in account. Removed\n");

								//надо все остановить, здесь однозначно непонятно, что наковыряли
								//ScanCreateFeedsGlobalVars.errors += 'Campaign (' + canum +  ') with GASearch Id ' + GAS['Id'] + " have duplicate company name in account\n";
								//Logger.log(ScanCreateFeedsGlobalVars.errors);
							}

						} else {


							//короче здесь ничего не делаем - может быть совсем другая кампания, а мы ее удалим
							//выдаем только предупреждение в лог
							Logger.log('Campaign have Name: ' + campaignName + " similar with GASearch Id: ' + GAS['Id'] + '. Better change this name\n");


							//removeCampaignbuffer(campaignId)
							//Logger.log('Campaign with GASearch Id ' + GAS['Id'] + ' have incorrect Name: ' + campaignName + ". Removed.\n");

							//останавливаем всю рекламу, чего-то наковыряли (хотя здесь типа можно было бы продолжить)
							//ScanCreateFeedsGlobalVars.errors += 'Check Campaign with GASearch Id ' + GAS['Id'] + ', it have incorrect Name: ' + campaignName + ". Change name or remove company.\n";
							//Logger.log(ScanCreateFeedsGlobalVars.errors);


						}

					}

/*
все ошибки при поиске кампаний теперь учитываются или удаляется кампания, так что все они убраны
иначе будет останавливать алгоритм, если кто-то наковырял, а я не в курсе
					if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length&&(!ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0])) {
						//есть кампании, но нет основной из них
						//здесь точно надо остановится и все остановить, так как наша логика не будет работать
						ScanCreateFeedsGlobalVars.errors += 'Not found main company (.0.) for GASearch Id ' + GAS['Id'] + ",  check MAIN company name or remove any company fot this Id.\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
					}
тоже самое сделано ниже для просмотра

*/

					if (AdWordsApp.getExecutionInfo().isPreview()) {
						if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length&&(!ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0])) {
							//есть кампании, но нет основной из них
							//здесь точно надо остановится и все остановить, так как наша логика не будет работать для просмотра

							var CampaignName = GAS['Id'] + '.' + 0 + '.' + 'MCLSET1:2:'+GAS.startbid

							ScanCreateFeedsGlobalVars.errors += 'Not found main company (.0.) for GASearch Id ' + GAS['Id'] + ",  create main company '" +CampaignName+ "' and repeat test.\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
						}
					}




					if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {

						//теперь сюда не зайдет, но оставил

						//останавливаем всю рекламу
						for (var ii = 0; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
							if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {
								if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0].isEnabled()) {
									ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0].pause();
								}
							}
						}
					

					} else {

						//ищем в кампаниях самую младшую у которой есть свободные группы
						//заодно считаем кол-во текущее кампаний
						var campaignwithgroups = null;
						var campaignnotexist = null;
						for (var ii = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length - 1; ii >= 0; ii--) {
							if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {
								if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][1] < MaxAdGroupsLimit) {
									//получаем самую меньшую по номеру кампанию у которой есть группы
									campaignwithgroups = ii;
								}
								ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[feed_id]++
							} else {
								//получаем самую младшую несуществущую кампанию в промещутке от 0 до максимальной существующей
								//!!!!так делать обязательно, кампания 0 должна быть всегда !!!!!
								//таким образом мы всегда будем ее иметь
								campaignnotexist = ii;
							}
						}

						//проверяем необходимость создания новой кампании и устанавливаем текущую кампанию
						//если нет кампании 0 то всегда будет она создаваться
						var createnewcompNum = null;
						if (campaignwithgroups === null) {
							//не обнаружена кампания со свободными группами
							if (campaignnotexist === null) {
								createnewcompNum = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length;
							} else {
								createnewcompNum = campaignnotexist;
							}
							scanned.GASearchCurrentCompany[feed_id] = createnewcompNum;
						} else {
							//обнаружена кампания со свободными группами
							if ((campaignnotexist !== null)&&(campaignnotexist === 0)) {
								//это кампания 0, которой нет сейчас, но должна быть всегда
								createnewcompNum = campaignnotexist;
								scanned.GASearchCurrentCompany[feed_id] = createnewcompNum;
							} else {
								//здесь находим кампанию со свободными группами или исправляем проблему, если текущая кампания почему-то не существует
								var goodcurrcomp = 0;
								if (scanned.GASearchCurrentCompany[feed_id] === campaignwithgroups) {
									//выше точно проверено на наличие свободных групп и все правильно с текущей кампанией, не меняем
									goodcurrcomp = 1;
								} else if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id]) {
									//выше проверено на наличие свободных групп но мы их не все не записываем а только самую младшую, поэтому проверяем повторно текушую кампанию на свободные группы
									if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][scanned.GASearchCurrentCompany[feed_id]]) {
										if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][scanned.GASearchCurrentCompany[feed_id]][1] < MaxAdGroupsLimit) {
											//уже есть с предыдущих запусков кампания которая имеет свободные группы, не меняем, пусть в нее пишется
											goodcurrcomp = 1;
										}
									}
								}
								if (!goodcurrcomp)
									scanned.GASearchCurrentCompany[feed_id] = campaignwithgroups;
							}
						}



						if (createnewcompNum !== null) {

							var campaign = CreatePauseCampaign(GAS['Id'],createnewcompNum,GAS['Budget'],'MCLSET1:2:'+GAS.startbid,IDName);

							if (!campaign) {
								//ниже выходим, не дождались создания
								warnstart += 'Campaign with GASearch Id ' + GAS['Id'] + ' maybe creating now in account, exit' + "\n";;
								Logger.log(warnstart);

							}


							if (campaign) {
								var CampaignName = campaign.getName();

								Logger.log('Campaign ' + CampaignName + ' with GASearch Id ' + GAS['Id'] + ' is now created in account, continue');

								var agNum = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').get().totalNumEntities();

								ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][createnewcompNum] = [campaign,agNum,GAS.startbid];

								ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[feed_id]++

								if (createnewcompNum) {
									//для компании 0 больше ничего не делаем
									//копируем настройки из кампании 0
									//запускаем, если запущена 0 (кампанию 0 не активируем автоматом)


									var err = CopyCampaignSettings(ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0][0],campaign)
									if (err) {
										Logger.log('Campaign (' + createnewcompNum +  ') with GASearch Id ' + GAS['Id'] + " have errors when copy audiences:\n" + err);
									}

									if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0][0].isEnabled())
										campaign.enable();
	
								} else {
									//для кампании 0 ставим или проверяем подробное круглосуточное расписание
									SetCampaignadSchedules(campaign);
								}

							}


						}




						if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0]) {
							//если была/появилась базовая кампания 0, то

							//если кампания 0 остановлена, то остановить всех остальных
							//если кампания 0 активна, то копировать ее установки в неактивные и сделать их активными

							if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0][0].isEnabled()) {
								for (var ii = 1; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
									if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {
										if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0].isPaused()) {
											var err = CopyCampaignSettings(ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0][0],ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0])
											if (err) {
												Logger.log('Campaign (' + ii +  ') with GASearch Id ' + GAS['Id'] + " have errors when copy audiences:\n" + err);
											}
											ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0].enable();
										}
									}
								}
							} else {
								for (var ii = 1; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
									if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {
										if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0].isEnabled()) {
											ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0].pause();
										}
									}
								}
							}


						}


					}



				}
			}
		}
	}


	if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {
//		var report = ScanCreateFeedsGlobalVars.SITE + "\n" ;
//		report += 'EXECUTE ERRORS: ' + ScanCreateFeedsGlobalVars.errors + "\n\n"; //Ошибка при выполнении
//		scanned.report = report;
		return didExitEarly;
	}

	if (warnstart) {
		//выходим, ждем следующего запуска
		var report = ScanCreateFeedsGlobalVars.SITE + "\n" ;
		report += 'CREATE SEARCH CAMPAIGNS: ' + warnstart + "\n\n";
		scanned.report = report;
		Logger.log(report);
		return true;
	}







	if (!scanned.steps) {


		//определяем был ли абр при выполнении скана при аттаче меток (важно для аттача меток)
		var labelRunAttachLabelsName = SCRIPT_ID_NAME + '.SCANCADGRSRUN';
		var CheckL = getLabel(labelRunAttachLabelsName);
		if (CheckL !== null) {
			//был абр при предыдущем запуске скрипта
			Logger.log('Previos start was aborted for attach adgroups bases ' + ScanCreateFeedsGlobalVars.SITE)
			var RunAttachLabelsNameABORT = 1;
			scanned.errors.abnormal_exits = 1;
		} else {
			var RunAttachLabelsNameABORT = 0;
			setLabel(labelRunAttachLabelsName, 'analytics data');
		}



/*

теперь кампании всегда создаются автоматом, поэтому эту проверку можно убрать, только лишняя задержка


		//проверяем поисковые кампании (наличие и что это поисковая кампания)
		var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
		for (var feed_id in OneSiteConfig) {
			//перебираем разрешенные сейчас фиды сайта
			if (OneSiteConfig['feeds'][feed_id]) {
			//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
				if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
				//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта
					var OneFeedGASearch = scanned.GASearch[feed_id];
					var OneFeedConfig = OneSiteConfig[feed_id];
					if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {



						for (var ii = 0; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
							if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {

								var campaign = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0];

								var CaType = CheckSearchDisplay(campaign.getId());
								if (CaType) {
									if (CaType != 'Search') {
										ScanCreateFeedsGlobalVars.errors += 'Campaign (' + ii +  ') with GASearch Id ' + OneFeedConfig['GASearch']['Id'] + " is not Search Type\n";
										Logger.log(ScanCreateFeedsGlobalVars.errors);
									}
								} else {
									ScanCreateFeedsGlobalVars.errors += 'Campaign (' + ii +  ') with GASearch Id ' + OneFeedConfig['GASearch']['Id'] + " is not found\n";
									Logger.log(ScanCreateFeedsGlobalVars.errors);
								}



							}
						}


					}
				}
			}
		}

		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {
//			var report = ScanCreateFeedsGlobalVars.SITE + "\n" ;
//			report += 'EXECUTE ERRORS: ' + ScanCreateFeedsGlobalVars.errors + "\n\n"; //Ошибка при выполнении
//			scanned.report = report;
			return didExitEarly;
		}


*/

		var existdublicatesgroups = 0

		//создаем массив проверки ссылок для поисковых кампаний
		var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
		for (var feed_id in OneSiteConfig) {
			//перебираем разрешенные сейчас фиды сайта
			if (OneSiteConfig['feeds'][feed_id]) {
			//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
				if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
				//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта
					var OneFeedGASearch = scanned.GASearch[feed_id];
					var OneFeedGASearchForEachCompany = scanned.GASearchForEachCompany[feed_id];
					var OneFeedConfig = OneSiteConfig[feed_id];
					if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {

//уже прошли проверку, все нормально, можно опять не проверять наличие и тип кампании


						//дальше насчет меток - надо отдельно на каждую кампанию фида свою метку делать
						//так как всего к одной метке можно привязать да 100 000 объектов, что может переполнить этот стек если все кампании фида на одну метку прикреплять
						//а потом уже когда все фиды пройдены, все метки всех фидов одновременно удалять

						for (var ii = 0; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
							if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {

								//итак по поводу абра - 1.мы никак не можем сохранить данные, а метки сохраняются
								//2.на этапе подключения групп к меткам к абрам надо относится очень внимательно 
								//иначе из базы выпадут десятки тысяч позиций, которые аттачаться на одном проходе
								//промежуточные метки - тоже не выход, если был второй абр сразу за первым, метки уже попадут в основные метки и  опять все тоже самое

								//сделано аккумуляция всей кампании в промежуточном массиве
								//а не один проход, что бы можно было при абре сразу все метки удалить и весь промежуточный массив и начать все заново


								var campaign = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0];



								var labelnameNo = SCRIPT_ID_NAME + ':SCANCADGRS:' + md5(OneFeedConfig['GASearch']['Id']) + '.' + ii + '.';
								var CheckL = getLabel(labelnameNo);
								if (CheckL === null) {
									//если нет метки, то это первый проход шага 0
									OneFeedGASearchForEachCompany[ii] = {};
									setLabel(labelnameNo, 'analytics data');
								} else {
									//есть метка, это не первый проход шага 0 или абр после любого прохода шага 0

									//при абре после первого прохода массива не будет
									if (!OneFeedGASearchForEachCompany[ii])
										OneFeedGASearchForEachCompany[ii] = {};

									if (!AdWordsApp.getExecutionInfo().isPreview()) {

										var hashkeyslength = Object.keys(OneFeedGASearchForEachCompany[ii]).length;

										if (RunAttachLabelsNameABORT) {
											//был абр, все сносим для кампании начинаем сначала

											//прежде чем удалять
											//можно сначала проверить, что количество подключенных к метке групп не совпадает с количеством элементов массива

											if (!AdWordsApp.getExecutionInfo().isPreview()) {
												var agNums = campaign.adGroups()
													.withCondition("LabelNames CONTAINS_ANY ['" + labelnameNo.replace(/\'/gm, '\\\'') + "']")
													.withCondition('CampaignStatus != REMOVED')
													.withCondition('AdGroupStatus != REMOVED')
													.get().totalNumEntities();

											} else {
												var agNums = campaign.adGroups()
													.withCondition('CampaignStatus != REMOVED')
													.withCondition('AdGroupStatus != REMOVED')
													.get().totalNumEntities();
											}


											if (hashkeyslength != agNums) {

												//сбрасываем подключенные группы к метке путем ее удаления
												//удаляем метку (пишем 2009 символов '-')
												setLabel(labelnameNo, Array(2010).join('-'));

												//заводим новую
												setLabel(labelnameNo, 'analytics data');

												//обнуляем хеш
												OneFeedGASearchForEachCompany[ii] = {};

												//этот итак обнулен (всегда заполняется только на текущий запуск шага 0)
												//ScanCreateFeedsGlobalVars.GASearchHASH[feed_id] = {};
											}

										} else {

											if (!hashkeyslength) {
												//нет массива, уже скопирован в базу и удален хеш кампании, переходим к следующей кампании
												continue;
											}

										}

									}


								}


								//ищем все группы этой кампании, которые без метки (то есть не занесены еще в scanned.GASearch)

								if (!AdWordsApp.getExecutionInfo().isPreview()) {

									var agIter = campaign.adGroups()
										.withCondition("LabelNames CONTAINS_NONE ['" + labelnameNo.replace(/\'/gm, '\\\'') + "']")
										.withCondition('CampaignStatus != REMOVED')
										.withCondition('AdGroupStatus != REMOVED')
									.get();

								} else {

									var agIter = campaign.adGroups()
										.withCondition('CampaignStatus != REMOVED')
										.withCondition('AdGroupStatus != REMOVED')
									.get();


								}

								var adgrs = [];
								while (agIter.hasNext()) {
									//тут вела себя непредсказуемо в режиме выполнения на ag.applyLabel(labelnameNo);
									//долго вычислял, глюки возникали - оказалось после 10500 позиций прекращал работать цикл!
									//возникали необъяснимые вещи!!!
									//где это было ищем по словам - было много слов, нигде не исправило и закончилось по абру
									adgrs.push(agIter.next());
								}



								var dublicatesgroupsNum = 0;

								var numoptmp = 0;
								for (var iii = 0; iii < adgrs.length; iii++) {
                                              				var ag = adgrs[iii];
									var agID = String(ag.getId());
									var agname = ag.getName();
									var AGpaused = ag.isPaused();

/*
									//формат имени: st:уникальный хеш URLID для конкретного URL (без учета протокола и домена, с учетом коллизий и базы всех найденных дубликатов):хеш всех объявлений (с учетом полных ссылок):макс.длина поля цены:макс.длина второго параметра(зарезервировано):хеш текущих параметров (цены и второго пар-ра):хеш стартовых ключей:POLICY_ERROR:end
									//пример: st:34563456-1:345345345:3:0:3456345:345634566:0:end

ниже новый
*/
									//формат имени: st:уникальный хеш URLID для конкретного URL (без учета протокола и домена, с учетом коллизий и базы всех найденных дубликатов):хеш всех объявлений (с учетом полных ссылок):макс.длина поля цены:макс.длина второго параметра(зарезервировано):хеш текущих параметров (цены и второго пар-ра):хеш стартовых ключей:параметр maxNodigaddkeyNum:параметр addkeystype:параметр removeLSVKeywords:параметр modifykeystype:параметр modifykeysEnable:POLICY_ERROR:end
									//пример: st:34563456-1:345345345:3:0:3456345:345634566:0:0:0:0:0:0:end

									//groupsID[agID] = ag;


//									var found = agname.match(/st\:(\d+(?:\-\d+)?)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:end/);
									var found = agname.match(/st\:(\d+(?:\-\d+)?)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:end/);
									if (found && found[1] && found[2] && found[3] && found[4] && found[5]) {

										var URLID = found[1];
										var ADS = found[2];
										var MXLNPR = found[3];
										var MXLNPR2 = found[4];
										var PARAMS = found[5];
										var KEYS = found[6];

										var PARmaxNodigaddkeyNum = found[7];
										var PARaddkeystype = found[8];
										var PARremoveLSVKeywords = found[9];
										var PARmodifykeystype = found[10];
										var PARmodifykeysEnable = found[11];

										var POLICY = found[12];

										if ((!OneFeedGASearch[URLID])&&(!OneFeedGASearchForEachCompany[ii][URLID])) {

											ScanCreateFeedsGlobalVars.GASearchHASH[feed_id][URLID] = ag;

											//OneFeedGASearchForEachCompany[ii][URLID] = [agID,AGpaused,ADS,MXLNPR,MXLNPR2,PARAMS,KEYS,POLICY];
											OneFeedGASearchForEachCompany[ii][URLID] = [agID,AGpaused,ADS,MXLNPR,MXLNPR2,PARAMS,KEYS,PARmaxNodigaddkeyNum,PARaddkeystype,PARremoveLSVKeywords,PARmodifykeystype,PARmodifykeysEnable,POLICY];

											if (!AdWordsApp.getExecutionInfo().isPreview()) {
												ag.applyLabel(labelnameNo);
											}


										} else {

											//if (!((OneFeedGASearch[URLID] && (OneFeedGASearch[URLID][0] == agID)) || (OneFeedGASearchForEachCompany[ii][URLID] && (OneFeedGASearchForEachCompany[ii][URLID][0] == agID)))) {
											if ((OneFeedGASearchForEachCompany[ii][URLID] && (OneFeedGASearchForEachCompany[ii][URLID][0] != agID)) || ((!OneFeedGASearchForEachCompany[ii][URLID])&&(OneFeedGASearch[URLID] && (OneFeedGASearch[URLID][0] != agID)))) {

												//сначала проверяем, что там другая группа, иначе если не проверить поудаляем все группы при нестандартном абре (например перед следующим проходом шага 0 удалилась метка)
												//принимаем решение в первую очередь на основе OneFeedGASearchForEachCompany[ii][URLID] - так как это значение перепишет значение в основном массиве (если в основном массиве есть другое значение)

												//очень важно сразу удалить перед сканом, иначе при скане могут быть ошибки с дубликатами
												//была проблема, которая так и не нашла объяснения - одно из объяснений - наличие дубликатов
												//где это было ищем по словам - было много слов, нигде не исправило и закончилось по абру
												existdublicatesgroups = 1;
												Logger.log('Exit when check groups in search campaign ' + OneFeedConfig['GASearch']['Id'] + '.' + ii + '.' + ', for ' + URLID + ' dublicate adroup ' + agname);


												//найден дубликат по URLID (по уникальной ссылке)
												dublicatesgroupsNum++;
												removeAdGroupbuffer(agID);


											} else {
												//при повторном проходе шага 0 массив OneFeedGASearchForEachCompany[ii] может быть пустой и не пройдет проверку ниже, если не заполнить его
												//пустой он будет если до этого вышли по флагу existdublicatesgroups
												//его можно заполнять, он продублирует повторно ниже свои значения в OneFeedGASearch
												if ((!OneFeedGASearchForEachCompany[ii][URLID])&&OneFeedGASearch[URLID]&&(OneFeedGASearch[URLID][0] == agID)) {
													ScanCreateFeedsGlobalVars.GASearchHASH[feed_id][URLID] = ag;
													OneFeedGASearchForEachCompany[ii][URLID] = OneFeedGASearch[URLID];
													//if (!AdWordsApp.getExecutionInfo().isPreview()) {
													//	ag.applyLabel(labelnameNo);
													//}
												}

											}
										}
									} else {

										//важно сразу удалить перед сканом, иначе при скане возможны неучтенные ошибки с дубликатами

										existdublicatesgroups = 1;

										Logger.log('Exit when check groups in search campaign ' + OneFeedConfig['GASearch']['Id'] + '.' + ii + '.' + ', incorrect adroup ' + agname);

										//не найден заданный формат названия
										dublicatesgroupsNum++;
										removeAdGroupbuffer(agID);





									}

									numoptmp++;
									if (numoptmp > 50) {
										//для кампаний с очень большим количеством групп
										if (shouldExitEarly()) {
											Logger.log('Exit when check search campaigns');
											scanned.report = "Exit when check search campaigns\n";
											didExitEarly = true;
											return didExitEarly;
										}
										numoptmp=0;
									}
								}


								if (!AdWordsApp.getExecutionInfo().isPreview()) {

									//в конце проверяем, что все группы подсоединились
									var hashkeyslength = Object.keys(OneFeedGASearchForEachCompany[ii]).length;


									var agNums = campaign.adGroups()
										.withCondition('CampaignStatus != REMOVED')
										.withCondition('AdGroupStatus != REMOVED')
										.get().totalNumEntities();


									if (hashkeyslength != (agNums - dublicatesgroupsNum)) {
										//если не все группы присоединились, выходим с ошибкой, такого не должно быть
										ScanCreateFeedsGlobalVars.errors += 'Exit when check search campaign ' + OneFeedConfig['GASearch']['Id'] + '.' + ii + '.' + ', adroups num ' + (agNums - dublicatesgroupsNum) + ' is not equal dbase elements num ' + hashkeyslength + ' in it, error' + "\n";
										Logger.log('Exit when check search campaign ' + OneFeedConfig['GASearch']['Id'] + '.' + ii + '.' + ', adroups num ' + (agNums - dublicatesgroupsNum) + ' is not equal dbase elements num ' + hashkeyslength + ' in it, error');
									}

								}


								//дописываем в основной массив
								OneFeedGASearch = Object.extend(OneFeedGASearch, OneFeedGASearchForEachCompany[ii]);
								//обязательно обнуляем массив кампании
								OneFeedGASearchForEachCompany[ii] = {};





							}
						}



							if (shouldExitEarly()) {
								Logger.log('Exit when check search campaigns');
								scanned.report = "Exit when check search campaigns\n";
								didExitEarly = true;
								return didExitEarly;
							}



					}
				}
			}
		}

		//все метки :SCANCADGRS: удаляем в конце, когда записан основной файл базы



		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {
//			var report = ScanCreateFeedsGlobalVars.SITE + "\n" ;
//			report += 'EXECUTE ERRORS: ' + ScanCreateFeedsGlobalVars.errors + "\n\n"; //Ошибка при выполнении
//			scanned.report = report;
			return didExitEarly;
		}


		if (existdublicatesgroups) {
			//выходим на удаление дубликатов и некорректных групп перед началом скана
			scanned.report = "Exit existdublicatesgroups\n";
			didExitEarly = true;
			return didExitEarly;
		}



	}




	//определяем был ли абр при выполнении скана (важно для поиска)
	var labelRunScanName = SCRIPT_ID_NAME + '.SCANRUN';
	var CheckL = getLabel(labelRunScanName);
	if (CheckL !== null) {
		//был абр при предыдущем запуске скрипта
		Logger.log('Previos start was aborted for scan ' + ScanCreateFeedsGlobalVars.SITE)
		ScanCreateFeedsGlobalVars.warnings += 'Previos start was aborted for scan ' + ScanCreateFeedsGlobalVars.SITE + "\n";

		ScanCreateFeedsGlobalVars.ABORT = 1;
		scanned.errors.abnormal_exits = 1;
	} else {
		ScanCreateFeedsGlobalVars.ABORT = 0;
		setLabel(labelRunScanName, 'analytics data');
	}




}




//	scanned.steps++;

	//отслеживаем для scanned.steps (что бы увеличить scanned.steps только если есть продолжение скана и соответсвенно продолжение записи файлов фидов)
	var currnum = 0;


	//флаг нужен только при вызове стартовой страницы для проверки некоторых условий окончания скана
	var startexit = 0;

	var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];

	if ((OneSiteConfig['CSVConfig']&&(!OneSiteConfig['CSVConfig']['parseUrls']))||OneSiteConfig['notScanUrlsOnAnyPages']) {
		var notScanUrlsonAnyPages = 1;
	} else {
		var notScanUrlsonAnyPages = 0;
	}


if (!CONTROL_EMPTY_FEEDS) {

//первый вызов (стартовая страница)
	if (!scanned.scnuncur) {



		//сначала проверяем csv-списки и вызываем
		if (OneSiteConfig['CSVConfig']) {
			//есть корректный массив ссылок

			//сформировали хеш
			//['CSVConfig']['parseUrls']
			//['CSVConfig']['skip_errors']
			//['CSVConfig']['MAX_TRIES']
			//['CSVConfig']['REQUEST_DELAY']
			//['CSVConfig']['repeaterUrl']
			//['CSVConfig']['CSVurls'].length - массив ссылок и их параметров 
			//['CSVConfig']['CSVurls'][i]['url']
			//['CSVConfig']['CSVurls'][i]['CHARSET']
			//['CSVConfig']['CSVurls'][i]['url_column_replace'] - массив с 1.номером столбца со ссылкой и 2.функцией для анализа/вывода ссылки по данным в массиве CSV-строки
			//['CSVConfig']['CSVurls'][i]['onlySeparator']
			//['CSVConfig']['CSVurls'][i]['skipSeparator']
			//['CSVConfig']['CSVurls'][i]['StartEndLines']
			//['CSVConfig']['CSVurls'][i]['csvParserConfig']


			var CSVConfig = OneSiteConfig['CSVConfig'];

			//проверка корректности репитера
			if (CSVConfig['repeaterUrl']) {
				var httpOptions = {
					contentType: "text/html",
					muteHttpExceptions: true,
					followRedirects: false,
  					headers : {
//						"User-Agent": "Mozilla/5.0",
						"Referer" : "http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"
					}
				}

				var response = UrlFetchApp.fetch(CSVConfig['repeaterUrl'], httpOptions);
				var responseCode = response.getResponseCode();

				if (!((responseCode == 200)&&(!response.getContentText()))) {
					ScanCreateFeedsGlobalVars.errors += 'Not found repeater from parameter repeaterUrl in CSVSITE' + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);

//					var report = ScanCreateFeedsGlobalVars.SITE + "\n" ;
//					report += 'EXECUTE ERRORS: ' + ScanCreateFeedsGlobalVars.errors + "\n\n"; //Ошибка при выполнении
//					scanned.report = report;
					return didExitEarly;
		        	}

			}

			if (CSVConfig['parseUrls']) {
				//разрешено сканирование всех страниц на предмет наличия ссылок, поэтому добавляем главную первой
				if (!scanned.scanned[scanned.scnuncur]) {
					scanned.scanned[scanned.scnuncur] = url;
					scanned.checked[scanned.scnuncur] = 0;
					scanned.referrer[scanned.scnuncur] = '';
					scanned.referrer_field[scanned.scnuncur] = '';
				}
			}

			if (!feedsAlreadyChecked.hasOwnProperty('CSVlisturlnum')) {
				//номер элемента в массиве csv-ссылок, который сейчас выполняется
				feedsAlreadyChecked['CSVlisturlnum'] = 0;
				//номер последнего недобавленного элемента (ссылки товара) из текущей csv-ссылки
				feedsAlreadyChecked['CSVsiteurlnum'] = 0;
				//проверка последнего загруженного элемента, если изменился - все удаляем и выходим, грузим заново все
				feedsAlreadyChecked['CSVsiteurlLastelem'] = null;
			}

			var startnum = feedsAlreadyChecked['CSVlisturlnum'];

			for (var i = startnum; i < CSVConfig['CSVurls'].length; i++) {
				//проверяем наличие минимум 10 минут до окончания перед запросом (3-6 минут уходит на запрос и парсинг 50 МГб)
				if (shouldExitEarly10()) {
					Logger.log('Exit when get csv-list');
					ScanCreateFeedsGlobalVars.warnings += "Exit when get csv-list\n";
					didExitEarly = true;
					break;
				}
				if (CSVConfig['CSVurls'][i]['csvParserConfig']['xml']) {
				    	didExitEarly = XMLScan(CSVConfig,i,OneSiteConfig,feedsAlreadyChecked,notScanUrlsonAnyPages);
				} else {
				    	didExitEarly = CSVScan(CSVConfig,i,OneSiteConfig,feedsAlreadyChecked,notScanUrlsonAnyPages);
				}
				if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {
					//завершаем однозначно, поэтому признак ставим независимо от его состояния
					didExitEarly = false;
					startexit = 1;
					break;
				}
				if (didExitEarly) {
					break;
				} else {
					feedsAlreadyChecked['CSVlisturlnum'] = i+1;
					feedsAlreadyChecked['CSVsiteurlnum'] = 0;
					feedsAlreadyChecked['CSVsiteurlLastelem'] = null;
				}
			}


		} else {
			if (!scanned.scanned[scanned.scnuncur]) {
				scanned.scanned[scanned.scnuncur] = url;
				scanned.checked[scanned.scnuncur] = 0;
				scanned.referrer[scanned.scnuncur] = '';
				scanned.referrer_field[scanned.scnuncur] = '';
			}
		}


		if (!(startexit || didExitEarly)) {

			if (scanned.scanned[scanned.scnuncur]&&(!scanned.checked[scanned.scnuncur])) {
				OneAddtoScan(OneSiteConfig,feedsAlreadyChecked,notScanUrlsonAnyPages);
				currnum++
				if (currnum == 1) {
					scanned.steps++;
					var currnumsculs = scanned.checked_urls;
				}
			    	didExitEarly = Scan(scanned.scanned[scanned.scnuncur],scanned.scnuncur,OneSiteConfig,feedsAlreadyChecked,foundURLHASHdublicates,notScanUrlsonAnyPages,IDName);
				if (currnum == 1) {
					if (currnumsculs == scanned.checked_urls) {
						//если не изменилось число проверенных страниц, то не увеличиваем scanned.steps
						scanned.steps--;
						//если страница не просканировалась, то обнуляем счетчик для другой страницы (если не выходим)
						currnum=0;
					}
				}
			}
			if (!didExitEarly)
				scanned.scnuncur++;
			if (ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&(scanned.checked_urls >= ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS)) {
				//завершаем однозначно, поэтому признак ставим независимо от его состояния
				Logger.log('Current Scan checked MAX_CHECKED_URLS num urls, stop Scan and exit');
				didExitEarly = false;
				startexit = 1;
				//break;
			}
			if (ScanCreateFeedsGlobalVars.stopscan) {
				//завершаем однозначно, поэтому признак ставим независимо от его состояния
				Logger.log('All feeds added MAX_ADD_URLS num urls, stop Scan and exit');
				didExitEarly = false;
				startexit = 1;
				//break;
			}


		}
	}


} else {

	//завершаем однозначно, поэтому признак ставим независимо от его состояния
	if (!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)) {
		Logger.log('Create all feeds empty, no Scan and exit for accaunt ' + IDName);
		scanned.steps++;
	}
	didExitEarly = false;
	startexit = 1;

}




	if (!(startexit || didExitEarly || (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))) {

//вызовы остальных страниц

//		var diskcurrnum = 0; //каждые 200 ссылок скана сбрасывать на диск

		while (scanned.scnuncur <= scanned.scanned.length) {
			if (scanned.scanned[scanned.scnuncur]&&(!scanned.checked[scanned.scnuncur])) {
					currnum++
					if (currnum == 1) {
						scanned.steps++;
						var currnumsculs = scanned.checked_urls
					}
					didExitEarly = Scan(scanned.scanned[scanned.scnuncur],scanned.scnuncur,OneSiteConfig,feedsAlreadyChecked,foundURLHASHdublicates,notScanUrlsonAnyPages,IDName);
					if (currnum == 1) {
						if (currnumsculs == scanned.checked_urls) {
							//если не изменилось число проверенных страниц, то не увеличиваем scanned.steps
							scanned.steps--;
							//если страница не просканировалась, то обнуляем счетчик для другой страницы (если не выходим)
							currnum=0;
						}
					}
					if (didExitEarly) {
						break;
					}
					if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {
						break;
					}
/*
					diskcurrnum++;
					if (diskcurrnum > 200) {
						//добавлено на случай, если раньше оборвется выполнение скрипта
						if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.SITES_CHECKED_FILE_NAME) {
							if (!AdWordsApp.getExecutionInfo().isPreview()) {
								//writeJSONFile(ScanCreateFeedsGlobalVars.SITES_CHECKED_FILE_NAME, feedsAlreadyChecked);
								writeJSONFile(ScanCreateFeedsGlobalVars.SITES_CHECKED_FILE_NAME, feedsAlreadyChecked, tmpfilesfolder);
							}
						}
						diskcurrnum=0;
					}
*/

			}
			if (!didExitEarly)
				scanned.scnuncur++;
			if (ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&(scanned.checked_urls >= ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS)) {
				break;
			}
			if (ScanCreateFeedsGlobalVars.stopscan) {
				break;
			}
		}

		//нужно проверку продублировать, так как могли выйти до нее из цикла и заодно признак окончания ставим
		if (ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&(scanned.checked_urls >= ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS)) {
			//завершаем однозначно, поэтому признак ставим независимо от его состояния
			Logger.log('Current Scan checked MAX_CHECKED_URLS num urls, stop Scan and exit');
			didExitEarly = false;
		}
		if (ScanCreateFeedsGlobalVars.stopscan) {
			//завершаем однозначно, поэтому признак ставим независимо от его состояния
			Logger.log('All feeds added MAX_ADD_URLS num urls, stop Scan and exit');
			didExitEarly = false;
		}




	}



if (readyToScan) {
//иначе это завершающий проход в попытке записать фиды, уже эти операции не нужны, были сделаны раньше и главное - нет данных, будут ошибки


//останавливаем/удаляем поисковые группы объявлений, которые не должны быть в РК
//останавливаем/запускаем РК, если задано
	if ((!didExitEarly)&&(!(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))) {


		var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
		for (var feed_id in OneSiteConfig) {
			//перебираем разрешенные сейчас фиды сайта
			if (OneSiteConfig['feeds'][feed_id]) {
			//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
				if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
				//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта
					var OneFeedGASearch = scanned.GASearch[feed_id];
					var OneFeedConfig = OneSiteConfig[feed_id];
					if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {

						var chagnum = 0;

						for (var URLID in OneFeedGASearch) {
							//оставщиеся группы нужно удалить/остановить
							//OneFeedGASearch[URLID] = [agID,AGpaused,ADS,MXLNPR,MXLNPR2,PARAMS,KEYS,PARmaxNodigaddkeyNum,PARaddkeystype,PARremoveLSVKeywords,PARmodifykeystype,PARmodifykeysEnable,POLICY];


							if (OneFeedConfig['GASearch']['removeNotFoundItem']) {
								removeAdGroupbuffer(OneFeedGASearch[URLID][0]);
							} else if (!OneFeedGASearch[URLID][1]) {
								pauseAdGroupbuffer(OneFeedGASearch[URLID][0])
							}
							//удаляем, что бы не вызывать повторно
							delete OneFeedGASearch[URLID];

							chagnum++

							if (chagnum > 100) {
								chagnum = 0;
								if (shouldExitEarly()) {
									ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly\n";
									didExitEarly = true;
									break;
								}
							}

						}

						if (!didExitEarly) {
							if (OneFeedConfig['GASearch']['powerControl']) {
								for (var ii = 0; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
									if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {
										var campaign = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0];
										if (campaign.isPaused()) {
											campaign.enable();
										}
									}
								}

							}
						} else {
							break;
						}

						if (shouldExitEarly()) {
							ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly\n";
							didExitEarly = true;
							break;
						}

					}
				}
			}
		}




	} else if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {


		var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];
		for (var feed_id in OneSiteConfig) {
			//перебираем разрешенные сейчас фиды сайта
			if (OneSiteConfig['feeds'][feed_id]) {
			//проверяем, что feed_id - это идентификатор фида из конфига сайта, а не другой параметр
				if (feedsAlreadyChecked['CURfeedsIds'][feed_id]) {
				//проверяем, что идентификатор фида feed_id сейчас разрешен для текущего скана сайта
					var OneFeedGASearch = scanned.GASearch[feed_id];
					var OneFeedConfig = OneSiteConfig[feed_id];
					if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {

						if (OneFeedConfig['GASearch']['powerControl'] == 2) {
							for (var ii = 0; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
								if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {
									var campaign = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0];
									if (campaign.isEnabled()) {
										campaign.pause();
									}
								}
							}

						}

						if (shouldExitEarly()) {
							//не устанавливаем didExitEarly = true; !!!
							break;
						}

					}
				}
			}
		}



	}


}


//	if ((!didExitEarly)||(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)) {


		var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];

		if (readyToScan) {
			//иначе не будет данных, если нет скана, надо предварительно записать в основной массив
			feedsAlreadyChecked.GASearchAllCampaignsNum = JSON.parse(JSON.stringify(ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum));
		}


		var report = ScanCreateFeedsGlobalVars.SITE + "\n" ;
		report += 'Scanned step: ' + scanned.steps + "\n"; //какой шаг сканирования (запуска скрипта)
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors) {
			report += 'EXECUTE ERRORS: ' + ScanCreateFeedsGlobalVars.errors + "\n\n"; //Ошибка при выполнении
		}
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.warnings) {
			report += 'EXECUTE WARNINGS: ' + ScanCreateFeedsGlobalVars.warnings + "\n\n"; //предупреждения при выполнении
		}
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.messages) {
			report += 'EXECUTE MESSAGES: ' + ScanCreateFeedsGlobalVars.messages + "\n\n"; //сообщения при выполнении
		}
		report += 'Request to scanned ' + scanned.scanned.length + ' URLS' + "\n"; //заявлено к сканированию
		report += 'Scanned ' + scanned.checked_urls + ' URLS' + "\n\n";
//		report += 'Add to scan ' + scanned.add_urls + ' URLS' + "\n\n";
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			if (OneSiteConfig[i].GASearch&&OneSiteConfig[i].GASearch.GAShtmlExt) {
				if (OneSiteConfig[i].GASearch.Id||OneSiteConfig[i].GASearch.GAShtml) {
					report += 'For GASearch ' + i + " don't forget! add Campaigns Extensions:" + OneSiteConfig[i].GASearch.GAShtmlExt + "\n\n";
				}
			}
			if (feedsAlreadyChecked.GASearchAllCampaignsNum[i]||scanned.GASearch_modifyurls[i]||scanned.GASearch_urls[i]) {
				report += 'Campaigns in GASearch ' + i + ' ' + feedsAlreadyChecked.GASearchAllCampaignsNum[i] + ' Num' + "\n";
				report += 'Add / Modify urls in GASearch ' + i + ' ' + scanned.GASearch_modifyurls[i] + ' URLS' + "\n";
				report += 'All urls in GASearch ' + i + ' ' + scanned.GASearch_urls[i] + ' URLS' + "\n";
			} else {
				report += 'Campaigns in GASearch ' + i + ' ' + feedsAlreadyChecked.GASearchAllCampaignsNum[i] + ' Num' + "\n";
			}
			report += 'All urls in feed ' + i + ' ' + scanned.addfeed_urls[i] + ' URLS' + "\n";


			if (OneSiteConfig[i].SKIP_FIRST_URLS) {
				report += 'Found parsed item urls for ' + i + ' ' + scanned.parced_urls[i] + ' URLS' + ", but first " + OneSiteConfig[i].SKIP_FIRST_URLS + " items skipped\n";
			} else {
				report += 'Found parsed item urls for ' + i + ' ' + scanned.parced_urls[i] + ' URLS' + "\n";
			}


			if (scanned.NOparced_urls[i]) {
				report += 'Not found parsed item urls for ' + i + ' ' + scanned.NOparced_urls[i] + ' URLS (see in log details)' + "\n";
			} else {
				report += 'Not found parsed item urls for ' + i + ' ' + scanned.NOparced_urls[i] + ' URLS' + "\n";
			}
			report += "\n";




		}
		report += 'Unknown errors: ' + scanned.errors.unknown + "\n";
		if (scanned.errors.unknownCSV)
			report += 'Unknown CSV errors: ' + scanned.errors.unknownCSV + "\n";
		report += 'Empty Content-Type errors: ' + scanned.errors.emptyCType + "\n";
		report += 'No html page errors: ' + scanned.errors.notHtml + "\n";
		var er_resp = 0;
		for (var v in scanned.errors.response) {
			report += 'Responce errors (' +v+ '): ' + scanned.errors.response[v] + "\n";
			er_resp = 1;
	        }
		if (!er_resp)
			report += 'Responce errors: 0' + "\n";

		if (scanned.errors.abnormal_exits) {
			report += "Abnormal exits: YES\n";
		} else {
			report += "Abnormal exits: no\n";
		}

		report += 'Add dublicates urls: ' + scanned.dublicates_urls + "\n";

		if (scanned.errors.quick_exits) 
			report += "Quick exits num: " + scanned.errors.quick_exits + "\n";
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.debug)
			report += "Debug_On: yes\n";
		report += "Last execute time: " + floorN((1800 - AdWordsApp.getExecutionInfo().getRemainingTime())/60, 2) + "\n";
		report += "\n";




		if ((!didExitEarly)||(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)) {
			Logger.log(report + "Current Scan Status: ended. Prepare to exit.\n");
			//допишем потом "Current Scan Status: ended." когда будем точно выходить, без возвожных таймаутов
		} else {
			if (!AdWordsApp.getExecutionInfo().isPreview()) {
				report += "Current Scan Status: continue.\n";
			} else {
				report += "Current Scan Status: continue, but stopped in Preview.\nFeeds saved without waiting for completion.\n";
			}
			report += "\n";
			Logger.log(report);
		}

		scanned.report = report;


		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.NOparsed_urls_list) {
			if (NOparsed_urls_list_MAX) {
				var short = 0;
				var NOparsed_urls_list_arr = ScanCreateFeedsGlobalVars.NOparsed_urls_list.split('\n');
				var alllen = NOparsed_urls_list_arr.length;
				if (alllen > NOparsed_urls_list_MAX) {
					NOparsed_urls_list_arr.length = NOparsed_urls_list_MAX;
					short = 1;
				}
				var NOparsed_urls_list = NOparsed_urls_list_arr.join('\n');
				if (short) {
					Logger.log("ALL NOPARSED (NO ADD) URLS: " + alllen + "\n" + "FIRST " + NOparsed_urls_list_MAX + " NOPARSED (NO ADD) URLS: \n" + NOparsed_urls_list);
				} else {
					Logger.log("ALL NOPARSED (NO ADD) URLS: \n" + NOparsed_urls_list);
				}
			} else {
				Logger.log("ALL NOPARSED (NO ADD) URLS: \n" + ScanCreateFeedsGlobalVars.NOparsed_urls_list);
			}
		}


//	}


	return didExitEarly;

}



function removeCampaignbuffer(Id) {
//примеры добавления/модификации кампаний
//https://pastebin.com/xhxmqQcV
//https://developers.google.com/google-ads/scripts/docs/examples/bulk-upload
//https://developers.google.com/google-ads/scripts/docs/reference/adsapp/adsapp_csvupload
//https://support.google.com/adwords/editor/answer/56368
//https://developers.google.com/adwords/scripts/docs/features/bulk-upload-entities


	if (ScanCreateFeedsGlobalVars) {
		if (!ScanCreateFeedsGlobalVars.removeCampaignupload) {
			ScanCreateFeedsGlobalVars.removeCampaignupload = AdsApp.bulkUploads().newCsvUpload(['Campaign ID', 'Campaign state'], {moneyInMicros: false});
		}
		ScanCreateFeedsGlobalVars.removeCampaignupload.append({
			'Campaign ID': Id,
			'Campaign state': 'removed'

		});
	}
//завершение
//removeCampaignapply()
//но сначала нужно вызвать
//enableAdGroupapply()
//pauseAdGroupapply()
//removeAdGroupapply()
}

function removeCampaignapply() {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.removeCampaignupload) {
			ScanCreateFeedsGlobalVars.removeCampaignupload.apply();
		}
	}
}



function enableAdGroupbuffer(Id) {
//примеры добавления/модификации кампаний
//https://pastebin.com/xhxmqQcV
//https://developers.google.com/google-ads/scripts/docs/examples/bulk-upload
//https://developers.google.com/google-ads/scripts/docs/reference/adsapp/adsapp_csvupload
//https://support.google.com/adwords/editor/answer/56368
//https://developers.google.com/adwords/scripts/docs/features/bulk-upload-entities


	if (ScanCreateFeedsGlobalVars) {
		if (!ScanCreateFeedsGlobalVars.enableAdGroupupload) {
			ScanCreateFeedsGlobalVars.enableAdGroupupload = AdsApp.bulkUploads().newCsvUpload(['Ad group ID', 'Ad group state'], {moneyInMicros: false});
		}
		ScanCreateFeedsGlobalVars.enableAdGroupupload.append({
			'Ad group ID': Id,
			'Ad group state': 'enabled'

		});
	}
//завершение
//enableAdGroupapply()
}

function enableAdGroupapply() {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.enableAdGroupupload) {
			ScanCreateFeedsGlobalVars.enableAdGroupupload.apply();
		}
	}
}



function removeAdGroupbuffer(Id) {
//примеры добавления/модификации кампаний
//https://pastebin.com/xhxmqQcV
//https://developers.google.com/google-ads/scripts/docs/examples/bulk-upload
//https://developers.google.com/google-ads/scripts/docs/reference/adsapp/adsapp_csvupload
//https://support.google.com/adwords/editor/answer/56368
//https://developers.google.com/adwords/scripts/docs/features/bulk-upload-entities


	if (ScanCreateFeedsGlobalVars) {
		if (!ScanCreateFeedsGlobalVars.removeAdGroupupload) {
			ScanCreateFeedsGlobalVars.removeAdGroupupload = AdsApp.bulkUploads().newCsvUpload(['Ad group ID', 'Ad group state'], {moneyInMicros: false});
		}
		ScanCreateFeedsGlobalVars.removeAdGroupupload.append({
			'Ad group ID': Id,
			'Ad group state': 'removed'

		});
	}
//завершение
//removeAdGroupapply()
//но сначала нужно вызвать
//enableAdGroupapply()
//pauseAdGroupapply()
}

function removeAdGroupapply() {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.removeAdGroupupload) {
			ScanCreateFeedsGlobalVars.removeAdGroupupload.apply();
		}
	}
}



function pauseAdGroupbuffer(Id) {
//примеры добавления/модификации кампаний
//https://pastebin.com/xhxmqQcV
//https://developers.google.com/google-ads/scripts/docs/examples/bulk-upload
//https://developers.google.com/google-ads/scripts/docs/reference/adsapp/adsapp_csvupload
//https://support.google.com/adwords/editor/answer/56368
//https://developers.google.com/adwords/scripts/docs/features/bulk-upload-entities

	if (ScanCreateFeedsGlobalVars) {
		if (!ScanCreateFeedsGlobalVars.pauseAdGroupupload) {
			ScanCreateFeedsGlobalVars.pauseAdGroupupload = AdsApp.bulkUploads().newCsvUpload(['Ad group ID', 'Ad group state'], {moneyInMicros: false});
		}
		ScanCreateFeedsGlobalVars.pauseAdGroupupload.append({
			'Ad group ID': Id,
			'Ad group state': 'paused'
		});
	}
//завершение
//pauseAdGroupapply()
}


function pauseAdGroupapply() {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.pauseAdGroupupload) {
			ScanCreateFeedsGlobalVars.pauseAdGroupupload.apply();
		}
	}
}






function removeKeywordbuffer(Id,AgId) {
//примеры добавления/модификации кампаний
//https://pastebin.com/xhxmqQcV
//https://developers.google.com/google-ads/scripts/docs/examples/bulk-upload
//https://developers.google.com/google-ads/scripts/docs/reference/adsapp/adsapp_csvupload
//https://support.google.com/adwords/editor/answer/56368
//https://developers.google.com/adwords/scripts/docs/features/bulk-upload-entities


	if (ScanCreateFeedsGlobalVars) {
		if (!ScanCreateFeedsGlobalVars.removeKeywordupload) {
			ScanCreateFeedsGlobalVars.removeKeywordupload = AdsApp.bulkUploads().newCsvUpload(['Keyword ID', 'Ad group ID', 'Ad group state'], {moneyInMicros: false});
		}
		ScanCreateFeedsGlobalVars.removeKeywordupload.append({
			'Ad group ID': AgId,
			'Keyword ID': Id,
			'Keyword state': 'removed'

		});
	}
//завершение
//removeKeywordapply()
//но сначала нужно вызвать
//pauseKeywordapply()
}

function removeKeywordapply() {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.removeKeywordupload) {
			ScanCreateFeedsGlobalVars.removeKeywordupload.apply();
		}
	}
}



function pauseKeywordbuffer(Id,AgId) {
//примеры добавления/модификации кампаний
//https://pastebin.com/xhxmqQcV
//https://developers.google.com/google-ads/scripts/docs/examples/bulk-upload
//https://developers.google.com/google-ads/scripts/docs/reference/adsapp/adsapp_csvupload
//https://support.google.com/adwords/editor/answer/56368
//https://developers.google.com/adwords/scripts/docs/features/bulk-upload-entities

	if (ScanCreateFeedsGlobalVars) {
		if (!ScanCreateFeedsGlobalVars.pauseKeywordupload) {
			ScanCreateFeedsGlobalVars.pauseKeywordupload = AdsApp.bulkUploads().newCsvUpload(['Keyword ID', 'Ad group ID', 'Ad group state'], {moneyInMicros: false});
		}
		ScanCreateFeedsGlobalVars.pauseKeywordupload.append({
			'Ad group ID': AgId,
			'Keyword ID': Id,
			'Keyword state': 'paused'
		});
	}
//завершение
//pauseKeywordapply()
}


function pauseKeywordapply() {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
		if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.pauseKeywordupload) {
			ScanCreateFeedsGlobalVars.pauseKeywordupload.apply();
		}
	}
}




//!!!!нельзя обнаружить отдельно поиск и совмещенный поиск-кмс (но нам и не надо вроде)
function CheckSearchDisplay(CompanyId) {
	var API_VERSION = {
		includeZeroImpressions: true
	};
	//	var cols = ['CampaignId','CampaignName','CampaignStatus','AdNetworkType1','AdNetworkType2','AdvertisingChannelType'];
	//AdvertisingChannelType !!!! не дает данных по каналу при совмещенной кампании!!! - дает только Search постоянно
	var cols = ['AdvertisingChannelType'];
	var report = 'CAMPAIGN_PERFORMANCE_REPORT';
	var query = ['select', cols.join(','), 'from', report, 'where CampaignId IN [' + CompanyId + ']', 'during', 'TODAY'].join(' ');
	var reportIter = AdWordsApp.report(query, API_VERSION).rows();

	/*
	возможные варианты для AdvertisingChannelType
	Search
	Display
	Shopping
	Video
	Multi Channel
	*/

	while (reportIter.hasNext()) {
		var row2 = reportIter.next();
		return row2.AdvertisingChannelType;
	}
	return '';
}



function shouldExitEarly10() {
//не менее 10 минут осталось
	return (AdWordsApp.getExecutionInfo().getRemainingTime() < 600);
}


function shouldExitEarly() {
	if (!AdWordsApp.getExecutionInfo().isPreview()) {
//		return (AdWordsApp.getExecutionInfo().getRemainingTime() < 180);
		return (AdWordsApp.getExecutionInfo().getRemainingTime() < 80);
//3 минуты частичного выполнения для тестов
//		return (AdWordsApp.getExecutionInfo().getRemainingTime() < 1620);
	} else {
//20 минут частичного выполнения для тестов (что бы еще успел фтп выполнится, если есть)
		return (AdWordsApp.getExecutionInfo().getRemainingTime() < 600);
	}
}


function EXTREMEshouldExitEarly() {
//срочный выход, на длительной операции ждем до последнего
//	return (AdWordsApp.getExecutionInfo().getRemainingTime() < 15);
	return (AdWordsApp.getExecutionInfo().getRemainingTime() < 20);
}



// Skip URLs from the skip_url array
// url - здесь все после домена и порта
//не проверяются ссылки href='#...' (проверены до вызова этой функции)
//удалены из ссылок #...
function SkipURL(url) {
	var skip_url = ScanCreateFeedsGlobalVars.skip_query;
	var only_url = ScanCreateFeedsGlobalVars.only_query;
	var scanFun = ScanCreateFeedsGlobalVars.scanFun;

	if ((skip_url && skip_url.length) || (only_url && only_url.length) || scanFun) {


		var firsts = url.substr(0, 1);
		if (firsts != '/') {
			url = '/' + url;
		}


		if (skip_url && skip_url.length) {
			for (var v in skip_url) {
				if (skip_url[v] == '/') {
					if (url == '/') return true;
				} else {
					if (url.substr(0, skip_url[v].length) == skip_url[v]) return true; // Skip this URL
				}
			}
		}

		if (only_url && only_url.length) {
			var exist = 0;
			for (var v in only_url) {
				if (only_url[v] == '/') {
					if (url == '/') exist = 1;
				} else {
					if (url.substr(0, only_url[v].length) == only_url[v]) exist = 1; // Skip this URL
				}
			}
			if (!exist)
				return true;
		}

		if (scanFun) {
	            try {
	                var noskip = scanFun(url);
			if (!noskip)
				return true;
        	    } catch (e) {
				ScanCreateFeedsGlobalVars.errors += 'bad function scanFun:' + e.message + "\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
	            }
		}


	}

	return false;
}


function Scan(url, urlnum, OneSiteConfig, feedsAlreadyChecked, foundURLHASHdublicates,notScanUrlsonAnyPages, IDName) {

        var referrer_url = url

        var referrer_field = ''

	var repeat_errors = ScanCreateFeedsGlobalVars.repeat_errors;

	var CHARSET = ScanCreateFeedsGlobalVars.CHARSET;

	var IGNORE_EMPTY_CONTENT_TYPE = ScanCreateFeedsGlobalVars.IGNORE_EMPTY_CONTENT_TYPE

	var scanned = feedsAlreadyChecked.scanned;

/*

Это лишнее

	if (!scanned.scanned)
		scanned.scanned = [];


	if (!scanned.checked)
		scanned.checked = [];


	if (!scanned.referrer)
		scanned.referrer = [];


	if (!scanned.referrer_field)
		scanned.referrer_field = [];


	if (!scanned.URLHASHIDscanned) {
		scanned.URLHASHIDscanned = {};
	}


	if (!scanned.errors)
		scanned.errors = {};


	if (!scanned.errors.response)
		scanned.errors.response = {};


	if (!scanned.errors.unknown)
		scanned.errors.unknown = 0;


	if (!scanned.errors.unknownCSV)
		scanned.errors.unknownCSV = 0;


	if (!scanned.errors.abnormal_exits)
		scanned.errors.abnormal_exits = 0;



	if (!scanned.errors.quick_exits)
		scanned.errors.quick_exits = 0;


	if (!scanned.errors.emptyCType)
		scanned.errors.emptyCType = 0;


	if (!scanned.errors.notHtml)
		scanned.errors.notHtml = 0;



//	if (!scanned.add_urls)
//		scanned.add_urls = 0;


	if (!scanned.checked_urls)
		scanned.checked_urls = 0;




	if (!scanned.GASearch_urls) {
		scanned.GASearch_urls = {};
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			scanned.GASearch_urls[i] = 0;
		}
	}

	if (!scanned.GASearch_modifyurls) {
		scanned.GASearch_modifyurls = {};
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			scanned.GASearch_modifyurls[i] = 0;
		}
	}

	if (!scanned.addfeed_urls) {
		scanned.addfeed_urls = {};
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			scanned.addfeed_urls[i] = 0;
		}
	}


	if (!scanned.parced_urls) {
		scanned.parced_urls = {};
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			scanned.parced_urls[i] = 0;
		}
	}


	if (!scanned.NOparced_urls) {
		scanned.NOparced_urls = {};
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			scanned.NOparced_urls[i] = 0;
		}
	}

	if (!scanned.dublicates_urls) {
		scanned.dublicates_urls = 0;
	}


	if (!scanned.FeedsFilesOUT) {
		scanned.FeedsFilesOUT = {};
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			scanned.FeedsFilesOUT[i] = {};
		}
	}

	if (!scanned.SearchFeedsFilesOUT) {
		scanned.SearchFeedsFilesOUT = {};
//это важно, не должно быть ничего до первой записи
		for (var i in feedsAlreadyChecked['CURfeedsIds']) {
			scanned.SearchFeedsFilesOUT[i] = '';
		}
	}


*/

	var didExitEarly = false;


	//    var urlnum = scanned.scanned.indexOf(url);

	//на всякий случай доп. проверка, раз есть этот номер
	if ((urlnum < 0) || (scanned.checked[urlnum] > 0))
		return didExitEarly;




	if (ScanCreateFeedsGlobalVars.debug)
		Logger.log("Scan " + url);


	scanned.checked_urls++;


	//    var html = UrlFetchApp.fetch(url).getContentText();



//	var ScanId = feedsAlreadyChecked['scannId']['Id'];
//	var OneSiteConfig = feedsAlreadyChecked['config'][feedsAlreadyChecked['scannId']['IdNum']];


	if (OneSiteConfig.repeaterUrl) {
		var httpOptions = {
			contentType: "text/html",
			muteHttpExceptions: true,
			followRedirects: false,
  			headers : {
//				"User-Agent": "Mozilla/5.0",
				"Referer" : "http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"
			}
		};
	} else {
		var httpOptions = {
			contentType: "text/html",
			muteHttpExceptions: true,
			followRedirects: false
		};
	}


	var MAX_TRIES = ScanCreateFeedsGlobalVars.MAX_TRIES;
	if (!MAX_TRIES)
		MAX_TRIES = 5;

	var responseCode = 0;
	var numTries = 0;

	var emessage = '';


	var known_error = 0;

	while (numTries < MAX_TRIES && !responseCode) {

		known_error = 0;

		numTries++;

		//здесь проверка приближения таймаута
		if (shouldExitEarly()) {
			ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly 1\n";
			scanned.checked_urls--;
			didExitEarly = true;
			return didExitEarly;
		}


		emessage = '';
		try {
			if (OneSiteConfig.repeaterUrl) {
				var response = UrlFetchApp.fetch(OneSiteConfig.repeaterUrl + urlEncode(url, 'beforequest2'), httpOptions);
			} else {
				var response = UrlFetchApp.fetch(url, httpOptions);
			}
			responseCode = response.getResponseCode();
		} catch (e) {

			emessage = e.message;
			if (!emessage)
				emessage = ' ';
		}

		if (emessage) {

			if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
				//это значит, что слишком частые запросы

				var sleeptime = 1000;
				var match = emessage.match(/Try Utilities\.sleep\((\d+)\)/);
				if (match && match[1]) {
					sleeptime = match[1] * 1;
				}

				Utilities.sleep(sleeptime);


			} else if (emessage.indexOf('Service invoked too many times') != -1) {
				//это значит, что превышено разрешенное количество запросов (за день наверное)
				//Service invoked too many times for one day: urlfetch
				if (ScanCreateFeedsGlobalVars.debug) {
					Logger.log("Service error: " + emessage);
				} else {
					Logger.log("Scan " + url + "\nService error: " + emessage);
				}
				ScanCreateFeedsGlobalVars.warnings += 'Exit ' + emessage + "\n";
				scanned.checked_urls--;
				if (scanned.checked[urlnum])
					scanned.checked[urlnum] = 0;
				didExitEarly = true;
				return didExitEarly;
			}

		} else {

			if (!isValidResponseCode(responseCode)) {
				var headers = response.getHeaders();
				if (headers['Location']) {

					if (numTries < MAX_TRIES) {
						if (repeat_errors && repeat_errors.length) {
							for (var v in repeat_errors) {
								if (repeat_errors[v] == responseCode) {
									known_error = 1;
									//устанавливаем, что бы пропустило дальше по кругу (повтор при ошибках)
									responseCode = 0;
									if (ScanCreateFeedsGlobalVars.REQUEST_DELAY) {
										Utilities.sleep(ScanCreateFeedsGlobalVars.REQUEST_DELAY);
									}
									break;
								}
							}
							if (known_error) {
								continue;
							}
						}
					}


					var next_url = headers['Location'];
					next_url = ValidateURL(url, next_url);

					if (next_url == false) {

						if (ScanCreateFeedsGlobalVars.debug)
							Logger.log("Redirect to not valid url for scan: " + headers['Location'] + "\n");

						scanned.errors.unknown++;
						return didExitEarly;
					}

					if (scanned.scanned.indexOf(next_url) >= 0) {

						//уже есть ссылка редиректа
						scanned.errors.unknown++;
						return didExitEarly;


					} else if (numTries < MAX_TRIES) {
						//если еще такой ссылки нет, то записываем текущую, как проверенную и создаем новый элемент массива для проверки
						scanned.checked[urlnum] = 1;

						url = next_url;
						urlnum = scanned.scanned.length
						scanned.scanned[urlnum] = next_url;
						scanned.checked[urlnum] = 0;
						//scanned.referrer[urlnum] = scanned.referrer[urlnum];
                                                //scanned.referrer_field[urlnum] = scanned.referrer_field[urlnum];

						if (ScanCreateFeedsGlobalVars.debug)
							Logger.log("Redirect to url: " + headers['Location'] + " responceCode: " + responseCode + "\n");

						//устанавливаем, что бы пропустило дальше по кругу
						scanned.checked_urls++;
						responseCode = 0;


					} else {
						//завершится и так при выходе наверх, но форсируем в этой точке
						break;
					}
				} else if (numTries < MAX_TRIES) {
					if (repeat_errors && repeat_errors.length) {
						for (var v in repeat_errors) {
							if (repeat_errors[v] == responseCode) {
								known_error = 1;
								//устанавливаем, что бы пропустило дальше по кругу (повтор при ошибках)
								responseCode = 0;
								if (ScanCreateFeedsGlobalVars.REQUEST_DELAY) {
									Utilities.sleep(ScanCreateFeedsGlobalVars.REQUEST_DELAY);
								}
								break;
							}
						}

						if (known_error) {
							continue;
						}


					}
					break;
				} else {
					if (repeat_errors && repeat_errors.length) {
						for (var v in repeat_errors) {
							if (repeat_errors[v] == responseCode) {
								known_error = 1;
							}
						}
					}
					//завершится и так при выходе наверх, но форсируем в этой точке
					break;
				}
			}

		}

	}

	if (emessage) {


		if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
			//это значит, что слишком частые запросы

			if (ScanCreateFeedsGlobalVars.debug) {
				Logger.log("Service error: " + emessage);
			}

			ScanCreateFeedsGlobalVars.warnings += 'Exit ' + emessage + "\n";

			scanned.checked_urls--;
			if (scanned.checked[urlnum])
				scanned.checked[urlnum] = 0;
			didExitEarly = true;
			return didExitEarly;
		}

		if (ScanCreateFeedsGlobalVars.debug) {
			Logger.log("Unknown error: " + emessage);
		} else {
			Logger.log("Scan " + url + "\nUnknown error: " + emessage);
		}


		scanned.errors.unknown++;

		scanned.checked[urlnum] = 1;
		return didExitEarly;

	}


	//нужно если будет повторное прохождение,
	//установить не ниже запроса ссылки, так как потом в любой момент може выйти
	//установить после проверки на приближение таймаута
	scanned.checked[urlnum] = 1;

if (!isValidResponseCode(responseCode)) {

		if (ScanCreateFeedsGlobalVars.debug) {
			Logger.log("Not valid responce: " + responseCode);
		}

		var errorresponce = 1;
		if (!scanned.errors.response[responseCode + '']) {
			scanned.errors.response[responseCode + ''] = 1;
		} else {
			scanned.errors.response[responseCode + '']++;
		}
//		return didExitEarly;
} else {
	var errorresponce = 0;

	var content = null;

	var headers = response.getHeaders();
	if (headers['Content-Type']) {
		content = headers["Content-Type"].split(';');
	}

	if (content && content[0]) {
		var content_type = content[0].toLowerCase().trim();
	} else {
		var content_type = '';
	}




	// Check content type for website
	if (content_type != "text/html") {

		if (content_type == "" && IGNORE_EMPTY_CONTENT_TYPE) {
			//            echo "Info: Ignoring empty Content-Type." . NL;
		} else {
			if (content_type == "") {
				//                echo "Info: Content-Type is not sent by the web server. Change " .
				//                     "'IGNORE_EMPTY_CONTENT_TYPE' to 'true' in the sitemap script " .
				//                     "to scan those pages too." . NL;

				scanned.errors.emptyCType++;


			} else {
				//                echo "Info: $url is not a html page: $content[0]" . NL;

				scanned.errors.notHtml++;


			}
			return didExitEarly;
		}
	}




	var html = response.getContentText(CHARSET);

	if (CHARSET == 'UTF-8') {

		//если установлен жестко чарсет то сюда не заходим

		//    https://en.wikipedia.org/wiki/Charset_detection
		var charset = '';
		var headers = response.getHeaders();
		if (headers && headers['Content-Type']) {
			var match = headers['Content-Type'].match(/charset\s*=\s*[\"\']?([^\\\"\'\>\/\s]+)/);
			if (match && match[1]) {
				charset = match[1]
				//        Logger.log(charset);
			}

		}
		if (!charset) {
			//      <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" >
			//          <meta charset="utf-8" >
			var regExp = new RegExp("\\<meta[^\\>]+charset\\s*\\=\\s*[\\'\\\"]?\\s*([^\\/\\\"\\'\\> ]+)", "i");
			var ch = regExp.exec(html);
			if (ch) {
				charset = ch[1];
				//        Logger.log(charset);
			}
		}
		if (charset) {
			//определили чарсет
			charset = charset.toUpperCase();
			if (CHARSET != charset)
				html = response.getContentText(charset);
		}


	}


	if (ScanCreateFeedsGlobalVars.debug) {
		if (ScanCreateFeedsGlobalVars.debug > 3) {
			Logger.log("Valid responceCode: " + responseCode + "\nresponce (JSON.stringify):\n" + JSON.stringify(html));
		} else if (ScanCreateFeedsGlobalVars.debug > 1) {
			Logger.log("Valid responceCode: " + responseCode + ", responce length: " + html.length);
		}
	}



}



	//меняем протокол перед сканом, важно для относительных ссылок на странице
	//но сейчас нам понадобится сначала данные parsed_url
	var parsed_url = parse_url(url);
	if (parsed_url['protocol'])
		ScanCreateFeedsGlobalVars.SITE_SCHEME = parsed_url['protocol'];



//ниже мы парсим страницу 
//сюда по определению не может попаcть одна и таже страница повторно - этим занимается сканер а не парсер.
//на самом деле сюда может попасть дубликат из-за отсутствия слешей в пути (например, domain.com и domain.com/)
//в парсере учитывается теоретическая возможность повторного попадания одинаковой ссылки (так что не страшно если попадет повторно)


//	scanned.add_urls++;






	var setURLHASHIDscanned = 0;

//URLID для URL (без учета коллизий)
//какую часть url используем для генерации идентификатора
	var checkurl = parsed_url["pathname"] + parsed_url["search"];
//	var URLHASHID = getURLHASHID(checkurl, OneSiteConfig.seed);
//	var URLHASHID = murmurhash3_32_gc(checkurl, OneSiteConfig.seed);
//без учета лишних элементов в url (корректное наличие / в parsed_url["pathname"] обеспечивает ValidateURL)
//поэтому, например, если pathname пустой, то туда добавится слеш (/)
	var URLHASHID = murmurhash3_32_gc(checkurl, OneSiteConfig.seed);





//база найденных дубликатов имеет такие значения
//foundURLHASHdublicates.seed 
//foundURLHASHdublicates.host
//foundURLHASHdublicates.array = {};


//генерируем уникальный URLID для конкретного URL (с учетом коллизий)
//генерируем для всех url, в т.ч. рубрикаторы и пр. страницы, которые не попадут в каталог
//почему для всех:
//	если есть несколько фидов, запускаемых в разное время на разные части каталога,
//	то если генерить и записывать только попавшие в фид, то получим дубликаты в разное время, которые невозможно отфильтровать без полной базы
//	а так мы их отфильтруем на этапе скана

//получаем уникальный URLID для конкретного URL (с учетом коллизий и базы всех найденных дубликатов)
//первый элемент [0] записывается без -0 (как минимум потому что мы еще не знаем, будут ли коллизии)
//в базе всех найденных дубликатов (foundURLHASHdublicates.array) номер элемента является реальным
//в текущей базе всех url (scanned.URLHASHIDscanned) номер элемента может не совпадать с реальным

	if ((!scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID))&&(!foundURLHASHdublicates.array.hasOwnProperty(URLHASHID))) {
		var URLID = URLHASHID + '';
		scanned.URLHASHIDscanned[URLHASHID] = [urlnum];
		setURLHASHIDscanned = 1;
	} else {


//можно покороче все написать (убрать одинаковые блоки), но оставил так, для лучшего понимания, что происходит

		if (foundURLHASHdublicates.array.hasOwnProperty(URLHASHID)) {
//есть массив URLHASH в базе всех найденных дубликатов
//для справки:
//может быть или не быть в текущей базе (исходя из правила выше if ((!scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID))&&(!foundURLHASHdublicates.array.hasOwnProperty(URLHASHID))))
//поэтому добавлен в текущую базу (если его нет там)

			var arrnumURL = foundURLHASHdublicates.array[URLHASHID].indexOf(checkurl);
			if (arrnumURL == -1) {
//нет url в базе всех найденных дубликатов, нужно добавить
				foundURLHASHdublicates.array[URLHASHID][foundURLHASHdublicates.array[URLHASHID].length] = checkurl;
				var URLID = URLHASHID + '-' + foundURLHASHdublicates.array[URLHASHID].length;
				scanned.dublicates_urls++;
				Logger.log('Add dublicate url ' + checkurl + ' in HASH ' + URLHASHID);
			} else {
//есть url в базе всех найденных дубликатов, не добавляем
				if (arrnumURL) {
					var URLID = URLHASHID + '-' + arrnumURL;
				} else {
					var URLID = URLHASHID + '';
				}

			}


		} else {
//нет URLHASH в базе всех найденных дубликатов, надо создать массив
//для справки:
//но есть в текущей базе (исходя из правила выше if ((!scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID))&&(!foundURLHASHdublicates.array.hasOwnProperty(URLHASHID))))

//поэтому нужно добавить дважды (хотя ниже идет полная проверка, но должно добавится всегда дважды)

			foundURLHASHdublicates.array[URLHASHID] = [];

//первым добавляем существующее значение из текущей базы
			if (scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID)) {
//проверка на всякий случай, хотя значение здесь должно быть обязательно
//также на всякий случай добавляем все что есть в массиве текущей базы, хотя там должен быть только один элемент
//заодно проверяем на дубликаты в текущей базе (хотя их там не должно быть)

				for (i = 0; i < scanned.URLHASHIDscanned[URLHASHID].length; i++) {
					var tmpurlnum = scanned.URLHASHIDscanned[URLHASHID][i];
					var tmpurl = scanned.scanned[tmpurlnum];
					var tmpparsed_url = parse_url(tmpurl);

					var tmpcheckurl = tmpparsed_url["pathname"] + tmpparsed_url["search"];

					var arrnumURL = foundURLHASHdublicates.array[URLHASHID].indexOf(tmpcheckurl);
					if (arrnumURL == -1) {
						foundURLHASHdublicates.array[URLHASHID][foundURLHASHdublicates.array[URLHASHID].length] = tmpcheckurl;
						scanned.dublicates_urls++;
						Logger.log('Add previos dublicate url ' + tmpcheckurl + ' in HASH ' + URLHASHID + ' for url ' + checkurl);
					}

				}

			}


//вторым добавляем текущую url (ее еще не должно быть, если это не повторная попытка прохода сканера)
			var arrnumURL = foundURLHASHdublicates.array[URLHASHID].indexOf(checkurl);
			if (arrnumURL == -1) {
//нет url в базе всех найденных дубликатов, нужно добавить
				foundURLHASHdublicates.array[URLHASHID][foundURLHASHdublicates.array[URLHASHID].length] = checkurl;
				var URLID = URLHASHID + '-' + foundURLHASHdublicates.array[URLHASHID].length;
				scanned.dublicates_urls++;
				Logger.log('Add dublicate url ' + checkurl + ' in HASH ' + URLHASHID);
			} else {
//есть url в базе всех найденных дубликатов, не добавляем
				if (arrnumURL) {
					var URLID = URLHASHID + '-' + arrnumURL;
				} else {
					var URLID = URLHASHID + '';
				}

			}


		}


		if (!scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID)) {
//URLHASH нет в текущей базе, надо создать массив
//для справки:
//но есть в базе всех найденных дубликатов (исходя из правила выше if ((!scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID))&&(!foundURLHASHdublicates.array.hasOwnProperty(URLHASHID))))
			scanned.URLHASHIDscanned[URLHASHID] = [urlnum];
			setURLHASHIDscanned = 1;

		} else {
//URLHASH есть в текущей базе, проверяем наличие нашей ссылки
//для справки:
//может быть или не быть в базе всех найденных дубликатов  (исходя из правила выше if ((!scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID))&&(!foundURLHASHdublicates.array.hasOwnProperty(URLHASHID))))
//поэтому добавлен в базу всех найденных дубликатов (если его нет там)

			var arrnumel = scanned.URLHASHIDscanned[URLHASHID].indexOf(urlnum);
			if (arrnumel == -1) {
//нет ссылки добавим
				scanned.URLHASHIDscanned[URLHASHID][scanned.URLHASHIDscanned[URLHASHID].length] = urlnum;
			} else {
//ссылка уже есть в базе скана сайта, пропускаем повторные заходы по дубликатам url, не обрабатываем парсингом
				var URLID = false;
			}

		}


	}

/*
старый вариант, без foundURLHASHdublicates.array
	if (!scanned.URLHASHIDscanned.hasOwnProperty(URLHASHID)) {
		//уникальный URLID для конкретного URL (с учетом коллизий)
		//это запись 0 в массив коллизий
		//первый номер (0) записывается без -0 (как минимум потому что мы еще не знаем, будут ли коллизии)
		var URLID = URLHASHID + '';
		scanned.URLHASHIDscanned[URLHASHID] = [urlnum];
	} else {
		var arrnumel = scanned.URLHASHIDscanned[URLHASHID].indexOf(urlnum);
		if (arrnumel == -1) {
			//уникальный URLID для конкретного URL (с учетом коллизий)
			var URLID = URLHASHID + '-' + scanned.URLHASHIDscanned[URLHASHID].length;
			scanned.URLHASHIDscanned[URLHASHID][scanned.URLHASHIDscanned[URLHASHID].length] = urlnum;
		} else {
//пропускаем повторные заходы по дубликатам url, не обрабатываем парсингом
			var URLID = false;
		}
	}
*/




if (errorresponce) {
//не удаляем страницы из поиска, которые уже в базе и на которых сейчас возникла известная ошибка (в следующий раз проверим, сейчас плохо работает сервер наверное)

		if (URLID !== false) {
			if (known_error) {
				for (var i in OneSiteConfig) {
//перебираем разрешенные сейчас фиды сайта
					if (OneSiteConfig['feeds'][i]) {
					//проверяем, что i - это идентификатор фида из конфига сайта, а не другой параметр
						if (feedsAlreadyChecked['CURfeedsIds'][i]) {
							var OneFeedConfig = OneSiteConfig[i];
							if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {
								var OneFeedGASearch = scanned.GASearch[i];
								if (OneFeedGASearch[URLID]) {
									//убираем из базы, что бы потом не удалились как необработанные
									delete OneFeedGASearch[URLID];
								}
							}
						}
					}
				}

			}
		}

		//обязательно выходим при ошибке
		return didExitEarly;
}



/*

в общем опять убрал, мало ли, вдруг чего-то ошибочно не пропустили, можно повторно просканить наличие ссылок, заодно убрали лишнюю постоянную проверку, редкая ситуация
ну а для парсинга добавления фидов это принципиально - не допустить дублей в базе
	if (URLID === false) {
		//так и не понял пока почему раньше не было этого условия, зачем дальше после парсера проходить и искать ссылки, если это конкретно дубликат страницы
		return didExitEarly;
	}

*/




	if (Encoder.hasEncoded(html)) {
		html = Encoder.htmlDecode(html);
	}




//вставлено один раз перед всеми парсерами страницы
    html = html.replace(/\r/g, " "); // Remove newlines
    html = html.replace(/\n/g, " "); // Remove newlines
    html = html.replace(/\t/g, " "); // Remove tabs

//сохраняем полный html (может понадобиться текст скриптов например)
var fullhtml = html;

    html = html.replace(/(\<\!\-\-.*?\-\-\>)/g, ""); // Remove commented text
    html = html.replace(/(\<script.*?\<\/script\>)/igm, '<s'+'cript></s'+'cript>');
    html = html.replace(/(\<noscript.*?\<\/noscript\>)/igm, '<nos'+'cript></nos'+'cript>');
    html = html.replace(/(\<link .*?\>)/igm, '<l'+'ink>');
    html = html.replace(/(\<style.*?\<\/style\>)/igm, '<s'+'tyle></s'+'tyle>');


if (URLID !== false) {


	if (shouldExitEarly()) {
		ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly 2\n";
		scanned.checked_urls--;
		if (scanned.checked[urlnum])
			scanned.checked[urlnum] = 0;
		if (setURLHASHIDscanned)
			delete scanned.URLHASHIDscanned[URLHASHID];
		didExitEarly = true;
		return didExitEarly;
	}



//полная остановка дальнейшего сканирования всего сайта, если все фиды имеют параметр MAX_ADD_URLS и у всех фидов он превышен
	ScanCreateFeedsGlobalVars.stopscan = 1;


	//если найден хотя бы один подходящий фид для добавления в него товара, то не сканируем страницу на добавление ссылок
	//при наличии notScanUrlsOnItemPages
	var FoundFeedPosFLG=0;

	//если хотя бы один фид не делает скип текущего url (при наличии skip_parse only_parse или parseUrlFun), то не сканируем страницу на добавление ссылок
	//при наличии notScanUrlsOnItemPages
	var NoSkeepFeedUrlFlg=0;


	var feedsfields = {};
	var feedsranks = {};

	var warnstart = '';

	for (var i in OneSiteConfig) {
//перебираем разрешенные сейчас фиды сайта
		if (OneSiteConfig['feeds'][i]) {
		//проверяем, что i - это идентификатор фида из конфига сайта, а не другой параметр
			if (feedsAlreadyChecked['CURfeedsIds'][i]) {
			//проверяем, что идентификатор фида i сейчас разрешен для текущего скана сайта
				

				//возможно длительная операция (если много фидов у скана)
				//наверное лучше продублировать отдельные записи в фидах на одном url
				//чем разбираться потом с полным таймаутом
				//так что тупо выходим
				if (EXTREMEshouldExitEarly()) {
					var report = OneSiteConfig.SITE + "\n" ;
					report += 'Abnormal quick exit for url: ' + url + "\n\n";
					Logger.log(report);
					ScanCreateFeedsGlobalVars.warnings += "Exit EXTREMEshouldExitEarly 1\n";

					//scanned.report = report;
					scanned.checked_urls--;
					if (scanned.checked[urlnum])
						scanned.checked[urlnum] = 0;
					if (setURLHASHIDscanned)
						delete scanned.URLHASHIDscanned[URLHASHID];
					scanned.errors.quick_exits++;
					didExitEarly = true;
					return didExitEarly;
				}



				//указываем, что есть такой фид для дочерних, и он сейчас выполняеться, можно использовать для дочерних
				//ниже будет значение, если будет
				feedsfields[i] = null;

				//создаем запись (потом туда кто-то первый запишет), если есть младшие, дочерние фиды, то они участвуют в игре при наличии childAddByRank
				feedsranks[i] = 0;


				var OneFeedConfig = OneSiteConfig[i];

				var OneFeedFilesOUT = scanned.FeedsFilesOUT[i];


				var OneFeedGASearch = scanned.GASearch[i];



				//здесь родитель, участник игры "кто первый запишет" старшего родителя,
					//передает по цепочке - своим детям, возможным участникам его игры, флаг "уже записано"
					//передает здесь, потому что ниже он может выйти, остальные условия ниже (в т.ч. выход этого родителя без записи)
				//когда любой родитель реально сделает запись (ниже),
					//он всегда пишет этот флаг своим детям, без отслеживания есть дети-участники игры или нет (так как это лишняя проверка)

				if (OneFeedConfig['childrenFeeds']) {
					if (OneFeedConfig['parentFeed']&&OneFeedConfig['childAddByRank']) {
						if (feedsranks[OneFeedConfig['parentFeed']]) {
							feedsfields[i] = 1;
						}
					}
				}



/*
старый вариант без родительского фида
				if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {
					//если есть поиск, то ориентируемся по нему
					if (OneFeedConfig.MAX_ADD_URLS&&(scanned.GASearch_urls[i] >= OneFeedConfig.MAX_ADD_URLS)) {
						//фид может закончить
						continue;
					} else {
						//фиду надо продолжить сканирование
						ScanCreateFeedsGlobalVars.stopscan = 0;
					}
				} else {
					if (OneFeedConfig.MAX_ADD_URLS&&(scanned.addfeed_urls[i] >= OneFeedConfig.MAX_ADD_URLS)) {
						//фид может закончить
						continue;
					} else {
						//фиду надо продолжить сканирование
						ScanCreateFeedsGlobalVars.stopscan = 0;
					}
				}

*/


				if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {

					if (OneFeedConfig.MAX_ADD_URLS&&(scanned.GASearch_urls[i] >= OneFeedConfig.MAX_ADD_URLS)) {

						if (OneFeedConfig['childrenFeeds']) {
							//это родительский фид, проверяем MAX_ADD_URLS детей

							//родитель может закончить, спрашиваем у детей


							//остановка дальнейшего сканирования для родителя, если все дочерние фиды имеют параметр MAX_ADD_URLS и у всех фидов он превышен
							var stopscan = 1;

							for (var ii = 0; ii < OneFeedConfig['childrenFeeds'].length; ii++) {
								// OneFeedConfig['childrenFeeds'][ii] - идентификатор дочернего фида
								var ChildFeedId = OneFeedConfig['childrenFeeds'][ii];
								var ChildOneFeedConfig = OneSiteConfig[ChildFeedId];

								if (ChildOneFeedConfig['GASearch']&&ChildOneFeedConfig['GASearch']['Id']) {

									if (!(ChildOneFeedConfig.MAX_ADD_URLS&&(scanned.GASearch_urls[ChildFeedId] >= ChildOneFeedConfig.MAX_ADD_URLS))) {
										//хотя бы одному чилду надо продолжать
										stopscan = 0;
										break;
									}


								} else {


									if (!(ChildOneFeedConfig.MAX_ADD_URLS&&(scanned.addfeed_urls[ChildFeedId] >= ChildOneFeedConfig.MAX_ADD_URLS))) {
										//хотя бы одному чилду надо продолжать
										stopscan = 0;
										break;
									}

								}


							}

							if (stopscan) {
								//все чилды готовы закончить
								continue;
							} else {
								//кто-то из чилдов не готов закончить
								ScanCreateFeedsGlobalVars.stopscan = 0;
							}


						} else {
							continue;
						}


					} else {
						ScanCreateFeedsGlobalVars.stopscan = 0;
					}


				} else {

					if (OneFeedConfig.MAX_ADD_URLS&&(scanned.addfeed_urls[i] >= OneFeedConfig.MAX_ADD_URLS)) {

						if (OneFeedConfig['childrenFeeds']) {
							//это родительский фид, проверяем MAX_ADD_URLS детей

							//родитель может закончить, спрашиваем у детей


							//остановка дальнейшего сканирования для родителя, если все дочерние фиды имеют параметр MAX_ADD_URLS и у всех фидов он превышен
							var stopscan = 1;

							for (var ii = 0; ii < OneFeedConfig['childrenFeeds'].length; ii++) {
								// OneFeedConfig['childrenFeeds'][ii] - идентификатор дочернего фида
								var ChildFeedId = OneFeedConfig['childrenFeeds'][ii];
								var ChildOneFeedConfig = OneSiteConfig[ChildFeedId];

								if (ChildOneFeedConfig['GASearch']&&ChildOneFeedConfig['GASearch']['Id']) {

									if (!(ChildOneFeedConfig.MAX_ADD_URLS&&(scanned.GASearch_urls[ChildFeedId] >= ChildOneFeedConfig.MAX_ADD_URLS))) {
										//хотя бы одному чилду надо продолжать
										stopscan = 0;
										break;
									}


								} else {


									if (!(ChildOneFeedConfig.MAX_ADD_URLS&&(scanned.addfeed_urls[ChildFeedId] >= ChildOneFeedConfig.MAX_ADD_URLS))) {
										//хотя бы одному чилду надо продолжать
										stopscan = 0;
										break;
									}

								}


							}

							if (stopscan) {
								//все чилды готовы закончить
								continue;
							} else {
								//кто-то из чилдов не готов закончить
								ScanCreateFeedsGlobalVars.stopscan = 0;
							}


						} else {
							continue;
						}


					} else {
						ScanCreateFeedsGlobalVars.stopscan = 0;
					}


				}


				//выходы делаем здесь, а не раньше, что бы не нарушать алгоритм ScanCreateFeedsGlobalVars.stopscan
				if (!OneFeedConfig['childrenFeeds']) {
					//это не родительский фид, родительские которые сами дети, обработаем ниже
					if (OneFeedConfig['parentFeed']&&OneFeedConfig['childAddByRank']) {
		        			//это только дочерний фид, участник "игры", кто первый запишет
						//не является для кого-то родителем
						//уже записал кто-то старший, выходим
						if (feedsranks[OneFeedConfig['parentFeed']])
							continue;
					}
				} else if (!OneFeedConfig['ExistNotUsechildAddByRank']) {
					//это родительский фид, у которого все дети играют в игру
					if (OneFeedConfig['parentFeed']&&OneFeedConfig['childAddByRank']) {
						//это родительский фид - участник игры его родителя
						if (feedsranks[OneFeedConfig['parentFeed']]) {
							//уже сделал запись кто-то старший, выходим
							//так как некому передавать его поля:
							//у него нет детей, которые не участвуют в игре, поэтому здесь сразу выходим
							//уже записал раньше по цепочке своим детям возможным участникам игры флаг "занято"
							continue;
						}
					}
					//родителей у которых есть дети, которые не участвуют в игре, будем обрабатывать позже
				}



				var skipret = SkipParseURL(parsed_url["pathname"] + parsed_url["search"],OneFeedConfig);
				if (skipret) {
					//не проверяются ссылки href='#...' (проверены при скане)
					//везде удалены из ссылок анчоры #...
					//        Logger.log("Skip URL " + url);
					continue;
				} else if (skipret === false) {
					NoSkeepFeedUrlFlg=1;
				}

//проверяем наличие полей на странице
				var checkedfields = ParceFeedFields(html,fullhtml,OneFeedConfig,OneSiteConfig,URLID,url,scanned.referrer[urlnum],feedsfields[OneFeedConfig['parentFeed']]);

				if (checkedfields&&checkedfields.checkedfields&&(Object.keys(checkedfields.checkedfields).length)) {
//проверка полей прошла успешно, поля подходят для записи фида

//проверяем в конце поля через checkFieldsFun

					var checkFieldsFun = OneFeedConfig.checkFieldsFun;

					if (checkFieldsFun) {
						try {
					                var noskip = checkFieldsFun(checkedfields.checkedfields,url,i);
							if (!noskip)
								continue;
						} catch (e) {
							ScanCreateFeedsGlobalVars.errors += 'bad function checkFieldsFun:' + e.message + "\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
						}
					}

					if (!ScanCreateFeedsGlobalVars.errors) {

						FoundFeedPosFLG=1;

						//передаем поля в общую базу, если это родитель, то дети их используют
						feedsfields[i] = checkedfields.checkedfields;


						//здесь фид может писать, он не запишет только если ошибки в РК, или в настройкам файла фида. Он прошел (есть checkedfields.feedfiles_exist или checkedfields.search_exist)
						//поэтому мы уже даем сигнал записи, иначе, например, если возникла ошибка при создании объявления РК, то у другого то же возникнет наверное эта ошибка
						//всвязи с тем что предполагаются однотипные фиды по настройкам, то принимаем решение здесь указать что запись уже сделана, а не по результату реальной записи
						//в общем основная задача что бы не пересекались, сначала один пишет, потом другой, так что так правильно, 
							//иначе завтра может быть эта ошибка здесь пропадет и 
							//тогда старший заберет запись у младшего (будет каша с пересечениями)
						//к тому же так быстрее будет, не пытатся повторно делать младшему ошибочные записи
						//к тому же, если конфиги не однотипные, то на них эта настройка не влияет,
							//так как одновременно они не зайдут в одну запись из-за разных настроек


						if (OneFeedConfig['childrenFeeds']) {
							//это родительский фид

							if (OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {
								if (OneFeedConfig.MAX_ADD_URLS&&(scanned.GASearch_urls[i] >= OneFeedConfig.MAX_ADD_URLS)) {
									//родитель может закончить, поля детям переданы
									continue;
								}
							} else {
								if (OneFeedConfig.MAX_ADD_URLS&&(scanned.addfeed_urls[i] >= OneFeedConfig.MAX_ADD_URLS)) {
									//родитель может закончить, поля детям переданы
									continue;
								}
							}



							//теперь надо окончательно разобраться с контролем своей невозможности записи
							//сначала проверяем, является ли он участником игры другого родителя
							if (OneFeedConfig['parentFeed']&&OneFeedConfig['childAddByRank']) {
								if (feedsranks[OneFeedConfig['parentFeed']]) {
									//в самом начале он подал сигнал "занято" детям-участникам от его родителя, так как ниже мог не пройти
									continue;
								}
							}


							//теперь считаем сколько товаров он нашел (за исключением тех которые захватили старшие)
							scanned.parced_urls[i]++;
							//здесь же проверяем первые записи, которые не писать
							if (OneFeedConfig.SKIP_FIRST_URLS&&(scanned.parced_urls[i] <= OneFeedConfig.SKIP_FIRST_URLS)) {
								//выходим, еще не достигли разрешенного начала записи
								continue;
							}



							//тут проходим, теперь пишем свою запись родителю и запись для детей, что "занято" им
							//не могут никогда писать в родительскую запись дети, которые не участвуют в игре (это касается и родителей, которые являются детьми)


							//раньше были проверки что есть запись - тогда бы он сюда не дошел
							//сначала проверяем, является ли он участником игры другого родителя
							if (OneFeedConfig['parentFeed']&&OneFeedConfig['childAddByRank']) {
								if (!feedsranks[OneFeedConfig['parentFeed']]) {
									//если нет записи у родителя - пишет в родительскую запись, но только если он участник игры родителя
									feedsranks[OneFeedConfig['parentFeed']] = 1;
								}
							}


							//пишет в свою запись, для возможных детей-участников (дети-участники теперь не могут писать эту страницу)
							feedsranks[i] = 1;



						} else {


							//теперь считаем сколько товаров он нашел (за исключением тех которые захватили старшие)
							scanned.parced_urls[i]++;
							//здесь же проверяем первые записи, которые не писать
							if (OneFeedConfig.SKIP_FIRST_URLS&&(scanned.parced_urls[i] <= OneFeedConfig.SKIP_FIRST_URLS)) {
								//выходим, еще не достигли разрешенного начала записи
								continue;
							}


							//не могут никогда писать в родительскую запись дети, которые не участвуют в игре (это касается и родителей, которые являются детьми)
							//это чистый ребенок, ни для кого не родитель, если он участник игры, то записываем своему родителю, что есть запись
							if (OneFeedConfig['parentFeed']&&OneFeedConfig['childAddByRank']) {
								feedsranks[OneFeedConfig['parentFeed']] = 1;
							}

						}


						//scanned.parced_urls[i]++;

						if (ScanCreateFeedsGlobalVars.debug)
							Logger.log("Found parsed item url, all found parsed: " + scanned.parced_urls[i]);


//по алгоритму ParceFeedFields хотя бы один вариант должен записаться


//записываем поля в фид

						var feedsaved = 0;
						if (checkedfields.feedfiles_exist) {
							if (CreateFeed(checkedfields.checkedfields,OneFeedConfig.feed_fields_file_types,OneFeedFilesOUT)) {
								feedsaved = 1;
								scanned.addfeed_urls[i]++; //этот параметр нельзя трогать, суммарное кол-во считает для расчетов окончания парсинга
								if (ScanCreateFeedsGlobalVars.debug)
									Logger.log("Add url to feed, all found parsed: " + scanned.parced_urls[i]);
							}
						}


//еще раз записываем в поисковый фид
						if (checkedfields.search_exist&&OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['GAShtml']) {
							//данные получаем как для поиска, а заносим в статистику фида, при этом нельзя дублировать, если уже статистика получена в CreateFeed
							//нужно передать значение существующего массива scanned.SearchFeedsFilesOUT, так как scanned.SearchFeedsFilesOUT[i] вначале не будет
							if (CreateFeedSearch(checkedfields.checkedfields,OneSiteConfig.shortWordsHash,OneFeedConfig['GASearch'],scanned.SearchFeedsFilesOUT,i)) {
								if (!feedsaved) {
									scanned.addfeed_urls[i]++; //этот параметр нельзя трогать, суммарное кол-во считает для расчетов окончания парсинга
									if (ScanCreateFeedsGlobalVars.debug)
										Logger.log("Add url to feed, all found parsed: " + scanned.parced_urls[i]);
								}
							}
						}



//обновляем/записываем поля в поисковой рекламной кампании
						if (checkedfields.search_exist&&OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id']) {
							var sres = CreateSearch(checkedfields.checkedfields,OneSiteConfig.shortWordsHash,OneFeedGASearch,OneFeedConfig,URLID,i,url,scanned.GASearchCurrentCompany[i]);
							if (sres) {
								scanned.GASearch_urls[i]++; //этот параметр нельзя трогать, суммарное кол-во считает для расчетов окончания парсинга
								if (sres == 1) {
									//это добавлено или изменено, в т.ч. полный снос старой группы
									scanned.GASearch_modifyurls[i]++;
									if (ScanCreateFeedsGlobalVars.debug)
										Logger.log("Add/Modify url in GASearch, all found parsed: " + scanned.GASearch_urls[i]);


									ScanCreateFeedsGlobalVars.GASearchCampaigns[i][scanned.GASearchCurrentCompany[i]][1]++;
									if (ScanCreateFeedsGlobalVars.GASearchCampaigns[i][scanned.GASearchCurrentCompany[i]][1] >= MaxAdGroupsLimit) {
										//вышли за лимит групп, нужно найти другую кампанию или создавать новую кампанию

										//ищем сначала в промежутке от 0 до конца ближайщую к началу кампанию

										//хотя не может в массиве отсутствовать кампания 0 по определению (ее могли по дороге удалить, но в массиве она осталась)
										//но оставил код такой же как на старте, что бы не менять
										var currentcampaign = null;
										var createnewcompNum = null;
										for (var ii = ScanCreateFeedsGlobalVars.GASearchCampaigns[i].length; ii >=0; ii--) {
											if (ScanCreateFeedsGlobalVars.GASearchCampaigns[i][ii]) {
												if (ScanCreateFeedsGlobalVars.GASearchCampaigns[i][ii][1] < MaxAdGroupsLimit) {
													currentcampaign = ii;
												}
											} else {
												createnewcompNum = ii;
											}
										}
										if (currentcampaign !== null) {
											//есть кампания, можно следующие записи продолжать с ней
											scanned.GASearchCurrentCompany[i] = currentcampaign;
										} else {
											if (createnewcompNum === null) {
												createnewcompNum = ScanCreateFeedsGlobalVars.GASearchCampaigns[i].length;
											}

											scanned.GASearchCurrentCompany[i] = createnewcompNum;

											//определились с номером новой кампании, создаем и копируем настройки
											var campaign = CreatePauseCampaign(OneFeedConfig['GASearch']['Id'],createnewcompNum,OneFeedConfig['GASearch']['Budget'],'MCLSET1:2:'+OneFeedConfig['GASearch'].startbid,IDName);


											if (!campaign) {
												//ниже выходим, не дождались создания
												warnstart += 'Campaign with GASearch Id ' + OneFeedConfig['GASearch']['Id'] + ' maybe creating now in account, exit' + "\n";;
												Logger.log(warnstart);
											}


											if (campaign) {
												var CampaignName = campaign.getName();

												Logger.log('Campaign ' + CampaignName + ' with GASearch Id ' + OneFeedConfig['GASearch']['Id'] + ' is now created in account, continue');

												var agNum = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').get().totalNumEntities();

												ScanCreateFeedsGlobalVars.GASearchCampaigns[i][createnewcompNum] = [campaign,agNum,OneFeedConfig['GASearch'].startbid];

												ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[i]++

												if (createnewcompNum) {
													//для компании 0 больше ничего не делаем
													//копируем настройки из кампании 0
													//запускаем, если запущена 0 (кампанию 0 не активируем автоматом)


													var err = CopyCampaignSettings(ScanCreateFeedsGlobalVars.GASearchCampaigns[i][0][0],campaign)
													if (err) {
														Logger.log('Campaign (' + createnewcompNum +  ') with GASearch Id ' + OneFeedConfig['GASearch']['Id'] + " have errors when copy audiences:\n" + err);
													}

													if (ScanCreateFeedsGlobalVars.GASearchCampaigns[i][0][0].isEnabled())
														campaign.enable();

/*
эта проверка теперь делается постоянно ниже

													//возможно длительная операция
													//наверное лучше продублировать отдельные записи в фидах на одном url
													//чем разбираться потом с полным таймаутом
													//так что тупо выходим
													if (EXTREMEshouldExitEarly()) {
														var report = OneSiteConfig.SITE + "\n" ;
														report += 'CREATE SEARCH CAMPAIGNS: ' + warnstart + "\n";
														report += 'Abnormal exit for url: ' + url + "\n\n";
														Logger.log(report);
														ScanCreateFeedsGlobalVars.warnings += "Exit EXTREMEshouldExitEarly 2\n";

														//scanned.report = report;
														scanned.checked_urls--;
														if (scanned.checked[urlnum])
															scanned.checked[urlnum] = 0;
														if (setURLHASHIDscanned)
															delete scanned.URLHASHIDscanned[URLHASHID];
														scanned.errors.quick_exits++;
														didExitEarly = true;
														return didExitEarly;
													}

*/

	
												}
		
											}



										}



									}



								} else {
									//проверено (=2)
									if (ScanCreateFeedsGlobalVars.debug)
										Logger.log("Check url in GASearch, all found parsed: " + scanned.GASearch_urls[i]);
								}
							}
						}




					}


				} else {

					if (skipret === false) {
						//фид делает скип текущего url (при наличии skip_parse only_parse или parseUrlFun)
						//возможно это проблема, так как сама ссылка подходит под описание отличительных черт ссылки карточки товара
						//но карточка товара не найдена (так же возможно мы указали неуникальные признаки ссылок товара)

						scanned.NOparced_urls[i]++;

						if (ScanCreateFeedsGlobalVars.debug)
							Logger.log("Not found parsed item! all found NOparsed: " + scanned.NOparced_urls[i]);


						ScanCreateFeedsGlobalVars.NOparsed_urls_list += i + ' ' + url + "\n";


					}

					continue;
				}




			}
		}
	}


	if (ScanCreateFeedsGlobalVars.errors) {
		//если ошибка, обязательно добавляем, где произошла ошибка
		var mess = "Errors found for url: " + url + "\n";
		ScanCreateFeedsGlobalVars.errors += mess;
		Logger.log(mess);
	}


	if (warnstart) {
		//выходим, ждем следующего запуска
		var report = OneSiteConfig.SITE + "\n" ;
		report += 'CREATE SEARCH CAMPAIGNS: ' + warnstart + "\n\n";
		ScanCreateFeedsGlobalVars.warnings += "Exit warnstart 1\n";
		ScanCreateFeedsGlobalVars.warnings += report;
//		scanned.report = report;
		Logger.log(report);
		didExitEarly = true;
		return didExitEarly;
	}



	if (ScanCreateFeedsGlobalVars.stopscan) {
		return didExitEarly;
	} else if (scanned.checked_urls > 1) {
		//если первая страница скана является картой товара, то сканируем ее дальше всегда, иначе здесь остановится, выйдет
		//поэтому применяем эти правила со второй страницы скана
		if (OneSiteConfig.notScanUrlsOnItemPages) {
			if (FoundFeedPosFLG || NoSkeepFeedUrlFlg)
				return didExitEarly;
		}
	}


}



	if (notScanUrlsonAnyPages) {
		return didExitEarly;
	}




	var onlyORskipSeparatorselements = 0;
	var foundskipSeparators = 0;
	var foundonlySeparators = 0;
	var foundSeparators = 0;
	var foundscanSelectors = 0;
	var foundscanSelectorsArr = [];
	if (OneSiteConfig.scanSelectors) {
//дальше заменяем html на его частичные области
		var newHtml = '';

		for (var ii = 0; ii < OneSiteConfig.scanSelectors.length; ii++) {
			var h = parseHtml(html, OneSiteConfig.scanSelectors[ii], 'text');

			if (h['errors']) {
				ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', in parameter scanSelectors: ' + OneSiteConfig.scanSelectors[ii] + "\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
			} else {

				var partHtml = h['result'];
		if (partHtml) {

				foundscanSelectors++;
				foundscanSelectorsArr.push(OneSiteConfig.scanSelectors[ii]);
				if (OneSiteConfig.onlyORskipSeparators) {

					//тот же код что и ниже


					var addpartHtml = '';
					//флаг, что найден первый сепаратор (сепаратор обвязки, его начало и, если задан то, конец)
					var foundstartenditem = 0;
					//разбиваем на куски по каждому первому сепаратору OneSiteConfig.onlyORskipSeparators[iii][0]
					for (var iii = 0; iii < OneSiteConfig.onlyORskipSeparators.length; iii++) {
						var resitems = partHtml.split(OneSiteConfig.onlyORskipSeparators[iii][0][0]);
						//if (resitems.length == 1) {
						//if ((resitems.length == 1)&&(resitems[0] == partHtml)) {
						//самый быстрый вариант
						if (resitems[0] == partHtml) {
							//не найден первый сепаратор (начало)
							//выходим, ищем следующий первый сепаратор
							continue;
						} else {

							if (OneSiteConfig.onlyORskipSeparators[iii][0][1]) {
								//есть конец элемента обвязки, обрезаем везде, если он найден везде (во всех блоках) или выходим
								var notfoundenditem = 0;
								for (var iiii = 1; iiii < resitems.length; iiii++) {
									//ищем, начиная со второго значения массива (первое - всегда до нашего обвязывающего сепаратора, а нужные куски кода - начиная со 2-го значения)
									if (resitems[iiii]) {
										var resitemsend = resitems[iiii].split(OneSiteConfig.onlyORskipSeparators[iii][0][1]);
										//if (resitemsend.length == 1) {
										//if ((resitemsend.length == 1)&&(resitemsend[0] == partHtml)) {
										//самый быстрый вариант
										if (resitemsend[0] == resitems[iiii]) {
											//не найден первый сепаратор (конец)
											notfoundenditem = 1;
											break;
										} else {
											//найден, но может получится и пустой в результате элемент, ниже проверим
											//обрезаем блок до сепаратора окончания блока
											resitems[iiii] = resitemsend[0];
										}
									} else {
										//не найден первый сепаратор (конец)
										//вообще пустой элемент остался, там нечего искать (то есть не сможем найти непустой конец)
										notfoundenditem = 1;
										break;
									}
								}
								if (notfoundenditem) {
									//не найден хотя бы один конец обвязки
									//выходим, ищем следующий первый сепаратор
        								//как правило, такого не должно быть, выдаем в лог при отладке
									if (ScanCreateFeedsGlobalVars.debug) {
										Logger.log("Not found end separator '" + OneSiteConfig.onlyORskipSeparators[iii][0][1].toString() + "' after start separator '" + OneSiteConfig.onlyORskipSeparators[iii][0][0].toString() + "' in onlyORskipSeparators for url " + url);
									}
									continue;
								}

							}


							//найден первый сепаратор (для iii элемента в массиве onlyORskipSeparators), обрабатываем все вхождения по этому сепаратору и по окончании переходим к следующему элементу массива onlyORskipSeparators

							foundstartenditem++;

							if (OneSiteConfig.onlyORskipSeparators[iii][1]) {
								//если есть 2-й сепаратор, то 2-й или 3-й или 4-й сепаратор непустой и надо их или один из них искать в кусках
								//иначе (если нет 2-го сепаратора) добавляем все как есть (внизу)


								if (OneSiteConfig.onlyORskipSeparators[iii][1].length) {
									var checkonlySeparators = OneSiteConfig.onlyORskipSeparators[iii][1];
								} else {
									var checkonlySeparators = null;
								}
								if (OneSiteConfig.onlyORskipSeparators[iii][2].length) {
									var checkskipSeparators = OneSiteConfig.onlyORskipSeparators[iii][2];
								} else {
									var checkskipSeparators = null;
								}
								//добавлен новый элемент - функция
								if (typeof OneSiteConfig.onlyORskipSeparators[iii][3] == 'function') {
									var checkfunction = OneSiteConfig.onlyORskipSeparators[iii][3];
								} else {
									var checkfunction = null;
								}

								var resitemsgood = '';
								for (var iiii = 1; iiii < resitems.length; iiii++) {
									//ищем куски html, относящиеся к существующим товарным позициям (согласно данным из настроек)
									//ищем, начиная со второго значения массива (первое - всегда до нашего обвязывающего сепаратора, а нужные куски кода - начиная со 2-го значения)
									if (resitems[iiii]) {

										foundSeparators++;

										var findonlySeparator = 0;
										if (checkonlySeparators) {

											var foundlabel = 0;
											//ищем признак продолжения поиска ссылок
											for (var iiiii = 0; iiiii < checkonlySeparators.length; iiiii++) {
												var findsplit = checkonlySeparators[iiiii];
												var resfindsplit = resitems[iiii].split(findsplit);
												//if (resfindsplit.length != 1) {
												//if (!((resfindsplit.length == 1)&&(resfindsplit[0] == resitems[iiii]))) {
												//самый быстрый вариант
												if (resfindsplit[0] != resitems[iiii]) {
													//найден один признак вхождения, можно добавлять этот кусок в общий код поиска ссылок, если другие критерии не отвергнут его
													foundlabel = 1;
													break;
												}
											}
											if (foundlabel) {
												foundonlySeparators++;
												findonlySeparator = 1;
											} else {
												//пишем в статистику как skip сепаратор (что бы не перегружать ее лишними данными)
												foundskipSeparators++;
												continue;
											}
										}

										var nofindskipSeparator = 0;
										if (checkskipSeparators) {
											var foundlabel = 0;
											//ищем признак непродолжения поиска ссылок
											for (var iiiii = 0; iiiii < checkskipSeparators.length; iiiii++) {
												var findsplit = checkskipSeparators[iiiii];
												var resfindsplit = resitems[iiii].split(findsplit);
												//if (resfindsplit.length != 1) {
												//if (!((resfindsplit.length == 1)&&(resfindsplit[0] == resitems[iiii]))) {
												//самый быстрый вариант
												if (resfindsplit[0] != resitems[iiii]) {
													//найден стопор, низзя добавлять этот кусок в общий код поиска ссылок
													foundlabel = 1;
													break;
												}
											}
											if (foundlabel) {
												foundskipSeparators++;
												if (findonlySeparator)
													foundonlySeparators--;
												continue;
											} else {
												//пишем в статистику как add сепаратор (что бы не перегружать ее лишними данными)
												if (!findonlySeparator)
													foundonlySeparators++;
												nofindskipSeparator = 1;
											}

										}

										if (checkfunction) {
											try {
												if (checkfunction(resitems[iiii])) {
													if ((!findonlySeparator)&&(!nofindskipSeparator))
														foundonlySeparators++;
												} else {
													foundskipSeparators++;
													continue;
												}
											} catch (e) {
												ScanCreateFeedsGlobalVars.errors += 'error ' + e.message + ', in function of onlyORskipSeparators element: ' + iii + " with parameter: " + resitems[iiii] +"\n";
												Logger.log(ScanCreateFeedsGlobalVars.errors);
												continue;
											}
										}


										resitemsgood += resitems[iiii];

									} else {
										continue;
									}
								}
								//partHtml = resitemsgood;
								addpartHtml += resitemsgood;
								//break;


							} else {
								//2-й и 3-й сепараторы пустые, добавляем все как есть

								var resitemsgood = '';
								for (var iiii = 1; iiii < resitems.length; iiii++) {
									//ищем, начиная со второго значения массива (первое - всегда до нашего обвязывающего сепаратора, а нужные куски кода - начиная со 2-го значения)
									if (resitems[iiii]) {
										foundSeparators++;
										resitemsgood += resitems[iiii];
									} else {
										continue;
									}
								}
								//partHtml = resitemsgood;
								addpartHtml += resitemsgood;
								//break;

							}

						}
					}

					if (!foundstartenditem) {
						//не найден ни один первый сепаратор (сепаратор обвязки) из массива onlyORskipSeparators
						//если задано не добавлять, то не добавляем ссылки
						if (OneSiteConfig.noSeparatorsNotScanUrls)
							partHtml = '';
					} else {
						//если найден хотя бы один сепаратор обвязки (foundstartenditem >= 1), то всегда записываем addpartHtml вместо partHtml
						partHtml = addpartHtml;
						onlyORskipSeparatorselements += foundstartenditem;
					}


					//конец того же блока что и ниже


				}

		}
				newHtml += partHtml;
			}

		}
		html = newHtml;
	} else if (html&&OneSiteConfig.onlyORskipSeparators) {

					var partHtml = html;

					//тот же код что и выше

					var addpartHtml = '';
					//флаг, что найден первый сепаратор (сепаратор обвязки, его начало и, если задан то, конец)
					var foundstartenditem = 0;
					//разбиваем на куски по каждому первому сепаратору OneSiteConfig.onlyORskipSeparators[iii][0]
					for (var iii = 0; iii < OneSiteConfig.onlyORskipSeparators.length; iii++) {
						var resitems = partHtml.split(OneSiteConfig.onlyORskipSeparators[iii][0][0]);
						//if (resitems.length == 1) {
						//if ((resitems.length == 1)&&(resitems[0] == partHtml)) {
						//самый быстрый вариант
						if (resitems[0] == partHtml) {
							//не найден первый сепаратор (начало)
							//выходим, ищем следующий первый сепаратор
							continue;
						} else {

							if (OneSiteConfig.onlyORskipSeparators[iii][0][1]) {
								//есть конец элемента обвязки, обрезаем везде, если он найден везде (во всех блоках) или выходим
								var notfoundenditem = 0;
								for (var iiii = 1; iiii < resitems.length; iiii++) {
									//ищем, начиная со второго значения массива (первое - всегда до нашего обвязывающего сепаратора, а нужные куски кода - начиная со 2-го значения)
									if (resitems[iiii]) {
										var resitemsend = resitems[iiii].split(OneSiteConfig.onlyORskipSeparators[iii][0][1]);
										//if (resitemsend.length == 1) {
										//if ((resitemsend.length == 1)&&(resitemsend[0] == partHtml)) {
										//самый быстрый вариант
										if (resitemsend[0] == resitems[iiii]) {
											//не найден первый сепаратор (конец)
											notfoundenditem = 1;
											break;
										} else {
											//найден, но может получится и пустой в результате элемент, ниже проверим
											//обрезаем блок до сепаратора окончания блока
											resitems[iiii] = resitemsend[0];
										}
									} else {
										//не найден первый сепаратор (конец)
										//вообще пустой элемент остался, там нечего искать (то есть не сможем найти непустой конец)
										notfoundenditem = 1;
										break;
									}
								}
								if (notfoundenditem) {
									//не найден хотя бы один конец обвязки
									//выходим, ищем следующий первый сепаратор
        								//как правило, такого не должно быть, выдаем в лог при отладке
									if (ScanCreateFeedsGlobalVars.debug) {
										Logger.log("Not found end separator '" + OneSiteConfig.onlyORskipSeparators[iii][0][1].toString() + "' after start separator '" + OneSiteConfig.onlyORskipSeparators[iii][0][0].toString() + "' in onlyORskipSeparators for url " + url);
									}
									continue;
								}

							}


							//найден первый сепаратор (для iii элемента в массиве onlyORskipSeparators), обрабатываем все вхождения по этому сепаратору и по окончании переходим к следующему элементу массива onlyORskipSeparators

							foundstartenditem++;

							if (OneSiteConfig.onlyORskipSeparators[iii][1]) {
								//если есть 2-й сепаратор, то 2-й или 3-й или 4-й сепаратор непустой и надо их или один из них искать в кусках
								//иначе (если нет 2-го сепаратора) добавляем все как есть (внизу)


								if (OneSiteConfig.onlyORskipSeparators[iii][1].length) {
									var checkonlySeparators = OneSiteConfig.onlyORskipSeparators[iii][1];
								} else {
									var checkonlySeparators = null;
								}
								if (OneSiteConfig.onlyORskipSeparators[iii][2].length) {
									var checkskipSeparators = OneSiteConfig.onlyORskipSeparators[iii][2];
								} else {
									var checkskipSeparators = null;
								}
								//добавлен новый элемент - функция
								if (typeof OneSiteConfig.onlyORskipSeparators[iii][3] == 'function') {
									var checkfunction = OneSiteConfig.onlyORskipSeparators[iii][3];
								} else {
									var checkfunction = null;
								}

								var resitemsgood = '';
								for (var iiii = 1; iiii < resitems.length; iiii++) {
									//ищем куски html, относящиеся к существующим товарным позициям (согласно данным из настроек)
									//ищем, начиная со второго значения массива (первое - всегда до нашего обвязывающего сепаратора, а нужные куски кода - начиная со 2-го значения)
									if (resitems[iiii]) {

										foundSeparators++;

										var findonlySeparator = 0;
										if (checkonlySeparators) {

											var foundlabel = 0;
											//ищем признак продолжения поиска ссылок
											for (var iiiii = 0; iiiii < checkonlySeparators.length; iiiii++) {
												var findsplit = checkonlySeparators[iiiii];
												var resfindsplit = resitems[iiii].split(findsplit);
												//if (resfindsplit.length != 1) {
												//if (!((resfindsplit.length == 1)&&(resfindsplit[0] == resitems[iiii]))) {
												//самый быстрый вариант
												if (resfindsplit[0] != resitems[iiii]) {
													//найден один признак вхождения, можно добавлять этот кусок в общий код поиска ссылок, если другие критерии не отвергнут его
													foundlabel = 1;
													break;
												}
											}
											if (foundlabel) {
												foundonlySeparators++;
												findonlySeparator = 1;
											} else {
												//пишем в статистику как skip сепаратор (что бы не перегружать ее лишними данными)
												foundskipSeparators++;
												continue;
											}
										}

										var nofindskipSeparator = 0;
										if (checkskipSeparators) {
											var foundlabel = 0;
											//ищем признак непродолжения поиска ссылок
											for (var iiiii = 0; iiiii < checkskipSeparators.length; iiiii++) {
												var findsplit = checkskipSeparators[iiiii];
												var resfindsplit = resitems[iiii].split(findsplit);
												//if (resfindsplit.length != 1) {
												//if (!((resfindsplit.length == 1)&&(resfindsplit[0] == resitems[iiii]))) {
												//самый быстрый вариант
												if (resfindsplit[0] != resitems[iiii]) {
													//найден стопор, низзя добавлять этот кусок в общий код поиска ссылок
													foundlabel = 1;
													break;
												}
											}
											if (foundlabel) {
												foundskipSeparators++;
												if (findonlySeparator)
													foundonlySeparators--;
												continue;
											} else {
												//пишем в статистику как add сепаратор (что бы не перегружать ее лишними данными)
												if (!findonlySeparator)
													foundonlySeparators++;
												nofindskipSeparator = 1;
											}

										}


										if (checkfunction) {
											try {
												if (checkfunction(resitems[iiii])) {
													if ((!findonlySeparator)&&(!nofindskipSeparator))
														foundonlySeparators++;
												} else {
													foundskipSeparators++;
													continue;
												}
											} catch (e) {
												ScanCreateFeedsGlobalVars.errors += 'error ' + e.message + ', in function of onlyORskipSeparators element: ' + iii + " with parameter: " + resitems[iiii] +"\n";
												Logger.log(ScanCreateFeedsGlobalVars.errors);
												continue;
											}
										}


										resitemsgood += resitems[iiii];

									} else {
										continue;
									}
								}
								//partHtml = resitemsgood;
								addpartHtml += resitemsgood;
								//break;


							} else {
								//2-й и 3-й сепараторы пустые, добавляем все как есть

								var resitemsgood = '';
								for (var iiii = 1; iiii < resitems.length; iiii++) {
									//ищем, начиная со второго значения массива (первое - всегда до нашего обвязывающего сепаратора, а нужные куски кода - начиная со 2-го значения)
									if (resitems[iiii]) {
										foundSeparators++;
										resitemsgood += resitems[iiii];
									} else {
										continue;
									}
								}
								//partHtml = resitemsgood;
								addpartHtml += resitemsgood;
								//break;

							}

						}
					}

					if (!foundstartenditem) {
						//не найден ни один первый сепаратор (сепаратор обвязки) из массива onlyORskipSeparators
						//если задано не добавлять, то не добавляем ссылки
						if (OneSiteConfig.noSeparatorsNotScanUrls)
							partHtml = '';
					} else {
						//если найден хотя бы один сепаратор обвязки (foundstartenditem >= 1), то всегда записываем addpartHtml вместо partHtml
						partHtml = addpartHtml;
						onlyORskipSeparatorselements += foundstartenditem;
					}

					//конец того же блока что и выше

					html = partHtml;

	}

	if (ScanCreateFeedsGlobalVars.debug) {
		var tmpout = '';
		if (OneSiteConfig.scanSelectors) {
		//if (foundscanSelectors) {
			tmpout += "found scanSelectors: " + foundscanSelectors;
			if (foundscanSelectors&&(ScanCreateFeedsGlobalVars.debug > 2)) {
				tmpout += " : ";
				for (var ii = 0; ii < foundscanSelectorsArr.length; ii++) {
					if (ii) {
						tmpout += ",'" + foundscanSelectorsArr[ii] + "'";
					} else {
						tmpout += "'" + foundscanSelectorsArr[ii] + "'";
					}
				}
			}
			tmpout += "\n";
		}
		if (OneSiteConfig.onlyORskipSeparators) {
		//if (foundSeparators) {
			if (OneSiteConfig.scanSelectors) {
				tmpout += "found All onlyORskipSeparators elements: " + onlyORskipSeparatorselements + " for found scanSelectors: " + foundscanSelectors + ", All Item's Separators: " + foundSeparators + ", good Separators: " + foundonlySeparators + ", skip Separators: " + foundskipSeparators + "\n";
			} else {
				tmpout += "found onlyORskipSeparators elements: " + onlyORskipSeparatorselements + ", All Item's Separators: " + foundSeparators + ", good Separators: " + foundonlySeparators + ", skip Separators: " + foundskipSeparators + "\n";
			}

		}
		if (tmpout) {
			Logger.log(tmpout);
		}
	}






/*
перенесено наверх, что бы не делать много раз
    html = html.replace(/\r/g, " "); // Remove newlines
    html = html.replace(/\n/g, " "); // Remove newlines
    html = html.replace(/\t/g, " "); // Remove tabs
    html = html.replace(/(\<\!\-\-.*?\-\-\>)/g, ""); // Remove commented text
    html = html.replace(/(\<script.*?\<\/script\>)/igm, '<s'+'cript></s'+'cript>');
    html = html.replace(/(\<noscript.*?\<\/noscript\>)/igm, '<nos'+'cript></nos'+'cript>');
    html = html.replace(/(\<link .*?\>)/igm, '<l'+'ink>');
    html = html.replace(/(\<style.*?\<\/style\>)/igm, '<s'+'tyle></s'+'tyle>');
*/

	var first_anchor = html.indexOf("<a ");
	if (first_anchor == -1) {
//отсутствие ссылок на странице или ее части не является ошибкой
//		scanned.errors.unknown++;
		return didExitEarly;
	}

	html = html.substring(first_anchor);

	var a1 = html.split('<a ');

	var curaddurls = 0;
	var curaddurlsArr = [];

//вычисляем, куда будем добавлять новые элементы, в конец стека или на место следующей для скана страницы
	if (OneSiteConfig.firstNewPages) {
		//следующий элемент для сканирования нельзя брать urlnum + 1, так как мог измениться urlnum
		var urlnumnext = scanned.scnuncur + 1;
	} else {
		var urlnumnext = scanned.scanned.length;
	}

	if (OneSiteConfig.reverseNewUrls) {
		//ссылки со страницы в реверсном порядке
		var notreverseurlnumnext = 0;
	} else {
		var notreverseurlnumnext = 1;
	}



	for (var i = 0; i < a1.length; i++) {
		var next_url = a1[i];

		next_url = next_url.trim();
		if (!next_url) continue;


		next_url = GetHREFValue(next_url);

		if (!next_url) continue;

		next_url = ValidateURL(url, next_url);

		//if (next_url == false) continue;
		if (!next_url) continue;

		// Don't scan when already scanned
		if (scanned.scanned.indexOf(next_url) >= 0) continue;


		//добавляем в позицию urlnumnext элемент
		scanned.scanned.splice(urlnumnext, 0, next_url);
		scanned.checked.splice(urlnumnext, 0, 0);
		scanned.referrer.splice(urlnumnext, 0, referrer_url);
		scanned.referrer_field.splice(urlnumnext, 0, '');

		//следующий элемент надо добавлять в старшую позицию, поэтому увеличиваем urlnumnext,
		//иначе ссылки со страницы попадут в реверсном порядке в стек,
		//что неправильно с точки зрения нашей договоренности - "предполагаем, что сначала должны быть товары, потом ссылки каталога в структуре страницы"
		//теперь добавлено специально реверс добавления ссылок
		if (notreverseurlnumnext)
			urlnumnext++;

		//старый алгоритм без splice работает быстрее на 100 мс на одном проходе скрипта, сущие мелочи
		//var snnum = scanned.scanned.length
		//scanned.scanned[snnum] = next_url;
		//scanned.checked[snnum] = 0;
		//scanned.referrer[snnum] = referrer_url;
		//scanned.referrer_field[snnum] = '';

		curaddurls++;
		curaddurlsArr.push(next_url);


	}


	if (ScanCreateFeedsGlobalVars.debug) {
		var tmpout = "found new urls: " + curaddurls;

		if (ScanCreateFeedsGlobalVars.debug > 2) {
			for (var ii = 0; ii < curaddurlsArr.length; ii++) {
				tmpout += "\n" + curaddurlsArr[ii];
			}
		}
		Logger.log(tmpout);
	}


	return didExitEarly;


}






function OneAddtoScan(OneSiteConfig, feedsAlreadyChecked, notScanUrlsonAnyPages) {
//одноразовое добавление ссылок из настроек

	if (OneSiteConfig.hasOwnProperty('addscanUrls')) {
		if ({}.toString.call(OneSiteConfig.addscanUrls) !== '[object Array]') {
			Logger.log("NOT CORRECT param addscanUrls");
			ScanCreateFeedsGlobalVars.warnings += "NOT CORRECT param addscanUrls\n";
			return;
		}
	} else {
		return;
	}

	if (!OneSiteConfig.addscanUrls.length) {
		Logger.log("NOT CORRECT param addscanUrls");
		ScanCreateFeedsGlobalVars.warnings += "NOT CORRECT param addscanUrls\n";
		return;
	}

	if (notScanUrlsonAnyPages) return;

	var url = ScanCreateFeedsGlobalVars.SITE_SCHEME + '://' + ScanCreateFeedsGlobalVars.SITE_HOST;

        var referrer_url = ''

	var scanned = feedsAlreadyChecked.scanned;


	var curaddurls = 0;
	var curaddurlsnotReal = 0;


	if (OneSiteConfig.firstNewPages) {
		//следующий элемент для сканирования нельзя брать urlnum + 1, так как мог измениться urlnum
		var urlnumnext = scanned.scnuncur + 1;
	} else {
		var urlnumnext = scanned.scanned.length;
	}

	if (OneSiteConfig.reverseNewUrls) {
		//ссылки со страницы в реверсном порядке
		var notreverseurlnumnext = 0;
	} else {
		var notreverseurlnumnext = 1;
	}

	var a1 = OneSiteConfig.addscanUrls;

	for (var i = 0; i < a1.length; i++) {
		var next_url = a1[i];

		if ((typeof next_url != 'string')||(!next_url)) continue;

		//next_url = ValidateURL(url, next_url);
		next_url = ValidateURL(url, next_url, 1);

		//if (next_url == false) continue;
		if (!next_url) continue;

		curaddurlsnotReal++;

		// Don't scan when already scanned
		if (scanned.scanned.indexOf(next_url) >= 0) continue;


		//добавляем в позицию urlnumnext элемент
		scanned.scanned.splice(urlnumnext, 0, next_url);
		scanned.checked.splice(urlnumnext, 0, 0);
		scanned.referrer.splice(urlnumnext, 0, referrer_url);
		scanned.referrer_field.splice(urlnumnext, 0, '');

		//следующий элемент надо добавлять в старшую позицию, поэтому увеличиваем urlnumnext,
		//иначе ссылки со страницы попадут в реверсном порядке в стек,
		//что неправильно с точки зрения нашей договоренности - "предполагаем, что сначала должны быть товары, потом ссылки каталога в структуре страницы"
		//теперь добавлено специально реверс добавления ссылок
		if (notreverseurlnumnext)
			urlnumnext++;

		//старый алгоритм без splice работает быстрее на 100 мс на одном проходе скрипта, сущие мелочи
		//var snnum = scanned.scanned.length
		//scanned.scanned[snnum] = next_url;
		//scanned.checked[snnum] = 0;
		//scanned.referrer[snnum] = referrer_url;
		//scanned.referrer_field[snnum] = '';

		curaddurls++;

	}


	if (ScanCreateFeedsGlobalVars.debug) {
		if (curaddurlsnotReal != a1.length) {
			Logger.log("NOT ALL urls in addscanUrls add to scan urls: " + curaddurlsnotReal + " from:" + a1.length);
			ScanCreateFeedsGlobalVars.warnings += "NOT ALL urls in addscanUrls add to scan urls: " + curaddurlsnotReal + " from:" + a1.length + "\n";
		} else {
			if (curaddurlsnotReal) {
				if (curaddurls == curaddurlsnotReal) {
					Logger.log("all urls in addscanUrls add to scan urls: " + curaddurlsnotReal);
				} else {
					Logger.log("all urls in addscanUrls add to scan urls: " + curaddurlsnotReal + ", but real add urls:" + curaddurls);
					ScanCreateFeedsGlobalVars.warnings += "all urls in addscanUrls add to scan urls: " + curaddurlsnotReal + ", but real add urls:" + curaddurls + "\n";
				}
			}
		}
	} else {
		if (curaddurlsnotReal != a1.length) {
			Logger.log("NOT ALL urls in addscanUrls add to scan urls: " + curaddurlsnotReal + " from:" + a1.length);
			ScanCreateFeedsGlobalVars.warnings += "NOT ALL urls in addscanUrls add to scan urls: " + curaddurlsnotReal + " from:" + a1.length + "\n";
		}
	}


}



function CSVScan(CSVConfig, CSVurlnum, OneSiteConfig, feedsAlreadyChecked, notScanUrlsonAnyPages) {


	//сформировали хеш
	//['CSVConfig']['parseUrls']
	//['CSVConfig']['skip_errors']
	//['CSVConfig']['MAX_TRIES']
	//['CSVConfig']['REQUEST_DELAY']
	//['CSVConfig']['repeaterUrl']
	//['CSVConfig']['CSVurls'].length - массив ссылок и их параметров 
	//['CSVConfig']['CSVurls'][i]['url']
	//['CSVConfig']['CSVurls'][i]['CHARSET']
	//['CSVConfig']['CSVurls'][i]['url_column_replace'] - массив с 1.номером столбца со ссылкой и 2.функцией для анализа/вывода ссылки по данным в массиве CSV-строки
	//['CSVConfig']['CSVurls'][i]['onlySeparator']
	//['CSVConfig']['CSVurls'][i]['skipSeparator']
	//['CSVConfig']['CSVurls'][i]['StartEndLines']
	//['CSVConfig']['CSVurls'][i]['csvParserConfig']


	var repeat_errors = ScanCreateFeedsGlobalVars.repeat_errors;

	var CHARSET = CSVConfig['CSVurls'][CSVurlnum]['CHARSET'];


	var url = CSVConfig['CSVurls'][CSVurlnum]['url'];

        var referrer_url = ''

	var scanned = feedsAlreadyChecked.scanned;

	var didExitEarly = false;


//	if (ScanCreateFeedsGlobalVars.debug)
		Logger.log("Get CSV " + url);




	if (CSVConfig.repeaterUrl) {
		var httpOptions = {
//			contentType: "text/anytext",
			contentType: "text/plain",
			muteHttpExceptions: true,
			followRedirects: false,
  			headers : {
//				"User-Agent": "Mozilla/5.0",
				"Referer" : "http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"
			}
		};
	} else {
		var httpOptions = {
//			contentType: "text/anytext",
			contentType: "text/plain",
			muteHttpExceptions: true,
			followRedirects: false
		};
	}



	var MAX_TRIES = CSVConfig.MAX_TRIES;
	if (!MAX_TRIES)
		MAX_TRIES = 5;

	var responseCode = 0;
	var numTries = 0;

	var emessage = '';


	var known_error = 0;


	while (numTries < MAX_TRIES && !responseCode) {

		known_error = 0;

		numTries++;

		//здесь проверка приближения таймаута
		if (shouldExitEarly10()) {
			ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly 11\n";
			didExitEarly = true;
			return didExitEarly;
		}


		emessage = '';
		try {

			if (CSVConfig.repeaterUrl) {
				var response = UrlFetchApp.fetch(CSVConfig.repeaterUrl + urlEncode(url, 'beforequest2'), httpOptions);
			} else {
				var response = UrlFetchApp.fetch(url, httpOptions);
			}
			responseCode = response.getResponseCode();
		} catch (e) {

			emessage = e.message;
			if (!emessage)
				emessage = ' ';
		}

		if (emessage) {

			if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
				//это значит, что слишком частые запросы

				var sleeptime = 1000;
				var match = emessage.match(/Try Utilities\.sleep\((\d+)\)/);
				if (match && match[1]) {
					sleeptime = match[1] * 1;
				}

				Utilities.sleep(sleeptime);


			} else if (emessage.indexOf('Service invoked too many times') != -1) {
				//это значит, что превышено разрешенное количество запросов (за день наверное)
				//Service invoked too many times for one day: urlfetch
				if (ScanCreateFeedsGlobalVars.debug) {
					Logger.log("Service error: " + emessage);
				} else {
					Logger.log("Get CSV " + url + "\nService error: " + emessage);
				}
				ScanCreateFeedsGlobalVars.warnings += 'Exit ' + emessage + "\n";
				didExitEarly = true;
				return didExitEarly;
			}

		} else {

			if (!isValidResponseCodeCSV(responseCode,CSVConfig)) {
				var headers = response.getHeaders();
				if (headers['Location']) {


					if (numTries < MAX_TRIES) {
						if (repeat_errors && repeat_errors.length) {
							for (var v in repeat_errors) {
								if (repeat_errors[v] == responseCode) {
									known_error = 1;
									//устанавливаем, что бы пропустило дальше по кругу (повтор при ошибках)
									responseCode = 0;
									if (CSVConfig.REQUEST_DELAY) {
										Utilities.sleep(CSVConfig.REQUEST_DELAY);
									}
									break;
								}
							}
							if (known_error) {
								continue;
							}
						}
					}


					var next_url = headers['Location'];
					next_url = ValidateCSVURL(url, next_url);

					if (next_url == false) {

						ScanCreateFeedsGlobalVars.errors += "Get CSV " + url + ", redirect to not valid url: " + headers['Location'] + "\n";
						Logger.log("CSV redirect to not valid url: " + headers['Location'] + "\n");

//при неизвестных ошибках на CSV выходим, в отличии от скана
						scanned.errors.unknownCSV++;
						return didExitEarly;
					}

					if (numTries < MAX_TRIES) {
						url = next_url;

						if (ScanCreateFeedsGlobalVars.debug)
							Logger.log("CSV redirect to url: " + headers['Location'] + " responceCode: " + responseCode + "\n");


						//устанавливаем, что бы пропустило дальше по кругу
						responseCode = 0;
					} else {
						//завершится и так при выходе наверх, но форсируем в этой точке
						break;
					}
				} else if (numTries < MAX_TRIES) {
					if (repeat_errors && repeat_errors.length) {
						for (var v in repeat_errors) {
							if (repeat_errors[v] == responseCode) {
								known_error = 1;
								//устанавливаем, что бы пропустило дальше по кругу (повтор при ошибках)
								responseCode = 0;
								if (CSVConfig.REQUEST_DELAY) {
									Utilities.sleep(CSVConfig.REQUEST_DELAY);
								}
								break;
							}
						}
						if (known_error) {
							continue;
						}
					}
					break;
				} else {
					if (repeat_errors && repeat_errors.length) {
						for (var v in repeat_errors) {
							if (repeat_errors[v] == responseCode) {
								known_error = 1;
							}
						}
					}
					//завершится и так при выходе наверх, но форсируем в этой точке
					break;
				}
			}

		}

	}

	if (emessage) {


		if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
			//это значит, что слишком частые запросы

			if (ScanCreateFeedsGlobalVars.debug) {
				Logger.log("Service error: " + emessage);
			}

			ScanCreateFeedsGlobalVars.warnings += 'Exit ' + emessage + "\n";

			didExitEarly = true;
			return didExitEarly;
		}



		ScanCreateFeedsGlobalVars.errors += "Get CSV " + url + ", Unknown error: " + emessage + "\n";
		Logger.log(ScanCreateFeedsGlobalVars.errors);


		scanned.errors.unknownCSV++;



//при неизвестных ошибках на CSV выходим, в отличии от скана


		return didExitEarly;

	}


	if (!isValidResponseCodeCSV(responseCode,CSVConfig)) {
		ScanCreateFeedsGlobalVars.errors += "Get CSV " + url + ", not valid responce for CSV-list: " + responseCode + "\n";
		Logger.log(ScanCreateFeedsGlobalVars.errors);
//здесь нужно выйти с ошибкой (а если допустимо отсутствие страницы, то занести в skip_errors 404 410 или какую другую выдаст сервер)
		if (!scanned.errors.response[responseCode + '']) {
			scanned.errors.response[responseCode + ''] = 1;
		} else {
			scanned.errors.response[responseCode + '']++;
		}
		return didExitEarly;
	}




	var html = response.getContentText(CHARSET);

	if (CHARSET == 'UTF-8') {

		//если установлен жестко чарсет то сюда не заходим

		//    https://en.wikipedia.org/wiki/Charset_detection
		var charset = '';
		var headers = response.getHeaders();
		if (headers && headers['Content-Type']) {
			var match = headers['Content-Type'].match(/charset\s*=\s*[\"\']?([^\\\"\'\>\/\s]+)/);
			if (match && match[1]) {
				charset = match[1]
				//        Logger.log(charset);
			}

		}
		if (!charset) {
			//      <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" >
			//          <meta charset="utf-8" >
			var regExp = new RegExp("\\<meta[^\\>]+charset\\s*\\=\\s*[\\'\\\"]?\\s*([^\\/\\\"\\'\\> ]+)", "i");
			var ch = regExp.exec(html);
			if (ch) {
				charset = ch[1];
				//        Logger.log(charset);
			}
		}
		if (charset) {
			//определили чарсет
			charset = charset.toUpperCase();
			if (CHARSET != charset)
				html = response.getContentText(charset);
		}


	}




	if (ScanCreateFeedsGlobalVars.debug) {
//слишком большая выдача, обрежет лог дальше для страниц, закомментирована выдача полного html
//		if (ScanCreateFeedsGlobalVars.debug > 3) {
//			Logger.log("Valid responceCode for CSV-list: " + responseCode + "\nresponce (JSON.stringify):\n" + JSON.stringify(html));
//		} else if (ScanCreateFeedsGlobalVars.debug > 1) {
//			Logger.log("Valid responceCode for CSV-list: " + responseCode + ", responce length: " + html.length);
//		}
		if (ScanCreateFeedsGlobalVars.debug > 1) {
			Logger.log("Valid responceCode for CSV-list: " + responseCode + ", responce length: " + html.length);
		}
	}


	if (!html.length) {
		ScanCreateFeedsGlobalVars.warnings += 'CSV file empty: ' + url + "\n";
		Logger.log('CSV file empty: ' + url);
		return didExitEarly;
	}


	var headers = response.getHeaders();
	if ((typeof headers["Content-Length"] == 'string')&&(/^\d+$/.test(headers["Content-Length"]))) {
		if (Number(headers["Content-Length"]) > html.length) {
			Logger.log('CSV file maybe truncated: ' + url + ', expected length:' + headers["Content-Length"] + ', real length:' + html.length);
			ScanCreateFeedsGlobalVars.warnings += 'CSV file maybe truncated: ' + url + ', expected length:' + headers["Content-Length"] + ', real length:' + html.length + "\n";
		}
	}



	//в CSV не должно быть кодировки html-сущностей, поэтому никогда не перекодировать
	//if (Encoder.hasEncoded(html)) {
	//	html = Encoder.htmlDecode(html);
	//}



	//здесь проверка приближения таймаута
	//может запрос долго выполнялся, поэтому перед началом обработки проверяем еще раз
	if (shouldExitEarly10()) {
		ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly 12\n";
		didExitEarly = true;
		return didExitEarly;
	}



	//подготовка конфига парсера
	//пропускать пустые строки и строки без контента
	CSVConfig['CSVurls'][CSVurlnum]['csvParserConfig']['skipEmptyLines'] = 'greedy';
	if (CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][0]&&CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1]) {
		//последняя строка
		CSVConfig['CSVurls'][CSVurlnum]['csvParserConfig']['preview'] = CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1];
	}

	var results = Papa.parse(html,CSVConfig['CSVurls'][CSVurlnum]['csvParserConfig']);



	var deletelastline = 0;
	var datalength = results.data.length;
	if (datalength > 1) {
		//проверка, что не обрезан последний элемент (можно конечно ошибки изучать...)
		if (results.data[datalength-1].length < results.data[datalength-2].length) {
			//последний элемент имеет меньше столбцов, чем предыдущий, удаляем последний (он обрезался)

			ScanCreateFeedsGlobalVars.warnings += 'Delete bad last element in CSV Array: ' + url + "\n";
			Logger.log('Delete bad last element in CSV Array: ' + url);

			datalength--;
			results.data.length = datalength;
			deletelastline = 1;
		}

	} else if (!datalength) {
		ScanCreateFeedsGlobalVars.warnings += 'CSV Array empty: ' + url + "\n";
		Logger.log('CSV file empty: ' + url);
		return didExitEarly;
	}



	ScanCreateFeedsGlobalVars.messages += 'CSV data.length = '+ results.data.length  + "\n";

	if (ScanCreateFeedsGlobalVars.debug) {
		if (deletelastline) {
			Logger.log('deleted last element in csv array');
		}

		Logger.log('csv data.length = '+ results.data.length);
		Logger.log('csv data first = '+ results.data[0]);
		Logger.log('csv data last = '+ results.data[results.data.length-1]);
		Logger.log('csv meta = '+ JSON.stringify(results.meta));
		Logger.log('csv errors = '+ JSON.stringify(results.errors));

		var mess="Columns in first csv element:\n"
		for (var i=0; i < results.data[0].length; i++) {
			mess += "Column[" + i + "]=`" + results.data[0][i] + "`\n"
		}
		Logger.log(mess);

		if (datalength > 1) {
			var mess="Columns in second csv element:\n"
			for (var i=0; i < results.data[1].length; i++) {
				mess += "Column[" + i + "]=`" + results.data[1][i] + "`\n"
			}
			Logger.log(mess);
		}

		if (datalength > 2) {
			var mess="Columns in last csv element:\n"
			for (var i=0; i < results.data[datalength - 1].length; i++) {
				mess += "Column[" + i + "]=`" + results.data[datalength - 1][i] + "`\n"
			}
			Logger.log(mess);
		}

	}


	if (feedsAlreadyChecked['CSVsiteurlnum']&&feedsAlreadyChecked['CSVsiteurlLastelem']) {
		var restart = 0;
		if (results.data[feedsAlreadyChecked['CSVsiteurlLastelem'][0]]) {
			if (JSON.stringify(results.data[feedsAlreadyChecked['CSVsiteurlLastelem'][0]]) != JSON.stringify(feedsAlreadyChecked['CSVsiteurlLastelem'][1]))
				restart = 1;
		} else {
			restart = 1;
		}
		if (restart) {
			//обнаружено несовпадение прошлой незаконченной загрузки файла с текущей
			//последняя запись в файле не соответсвует этой записи при прошлой загрузке
			//все сносим, перечитываем при следующем запуске все списки
			scanned.scanned = [];
			scanned.checked = [];
			scanned.referrer = [];
			scanned.referrer_field = [];

			feedsAlreadyChecked['CSVlisturlnum'] = 0;
			feedsAlreadyChecked['CSVsiteurlnum'] = 0;
			feedsAlreadyChecked['CSVsiteurlLastelem'] = null;

			ScanCreateFeedsGlobalVars.warnings += "Exit, reload all csv-lists. Was changed csv-list" + url + "\n";
			didExitEarly = true;
			return didExitEarly;
		}
	}


//это условие не будет выполняться, так как выше самому парсеру сказано в его конфиге - обрезать массив при формировании
//ну пусть будет, раз уже сделал, так сказать двойной контроль)
	if (CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][0]&&CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1]) {
		//в настройках указываются номера строк (начиная с 1)
		if (datalength > CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1]) {
			//обрезаем если меньше надо строк
			datalength = CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1];
			results.data.length = datalength;
			ScanCreateFeedsGlobalVars.messages += 'Truncate csv data.length, new CSV data.length = '+ results.data.length  + "\n";
			if (ScanCreateFeedsGlobalVars.debug) {
				Logger.log('Truncate csv data.length in parameter StartEndLines');
				Logger.log('new csv data.length = '+ results.data.length);
				Logger.log('csv data first = '+ results.data[0]);
				Logger.log('csv data last = '+ results.data[results.data.length-1]);
				var mess="Columns in last csv element:\n"
				for (var i=0; i < results.data[datalength - 1].length; i++) {
					mess += "Column[" + i + "]=`" + results.data[datalength - 1][i] + "`\n"
				}
				Logger.log(mess);

			}
		}
	}



	//находим начальную позицию
	var beginelnum = CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][0];
	if (beginelnum) {
		//в настройках указаны номера строк (начиная с 1), а нам нужен номер первого элемента
		beginelnum--

		//вычисляем номер максимально возможного добавляемого в массив скана элемента endnum

 		//сначала вычисляем по массиву results.data (больше вообще не получится)
		var endnum = results.data.length - 1;

		if (!notScanUrlsonAnyPages) {
			//мы уже добавили первую страницу, поэтому на один больше элементов должно быть
			endnum++;
		}


	} else {
		//в настройках указано число строк, поэтому стартовый элемент равен 0
		beginelnum = 0;

		//вычисляем номер максимально возможного добавляемого в массив скана элемента endnum

 		//сначала вычисляем по массиву results.data (больше вообще не получится)
		var endnum = results.data.length - 1;

		if (CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1]) {
			//здесь по максимальному количеству добавляемых элементов корректируем
			if (endnum > CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1] - 1)
				endnum = CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1] - 1;
		}
		
		if (!notScanUrlsonAnyPages) {
			//мы уже добавили первую страницу, поэтому на один больше элементов должно быть
			endnum++;
		}



	}
	
	if (feedsAlreadyChecked['CSVsiteurlnum'] > beginelnum) {
		var startnum = feedsAlreadyChecked['CSVsiteurlnum'];
	} else {
		var startnum = beginelnum;
		feedsAlreadyChecked['CSVsiteurlnum'] = beginelnum;
	}




	//['CSVConfig']['CSVurls'][i]['url']
	//['CSVConfig']['CSVurls'][i]['CHARSET']
	//['CSVConfig']['CSVurls'][i]['url_column_replace'] - массив с 1.номером столбца со ссылкой и 2.функцией для анализа/вывода ссылки по данным в массиве CSV-строки
	//['CSVConfig']['CSVurls'][i]['onlySeparator']
	//['CSVConfig']['CSVurls'][i]['skipSeparator']
	//['CSVConfig']['CSVurls'][i]['StartEndLines']
	//['CSVConfig']['CSVurls'][i]['csvParserConfig']



	var url_replace = ''; //что бы не было ошибки в Logger.log на url_replace.toString()
	if (CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'].length > 1)  {
		url_replace = CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][1];
		Logger.log('Url check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', example in first csv element : `' + results.data[0][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, CSVRow-Array: `' + JSON.stringify(results.data[0]) +  '`, ExecFun: `' + url_replace.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				Logger.log('Url check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', example in second csv element : `' + results.data[1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, CSVRow-Array: `' + JSON.stringify(results.data[1]) +  '`, ExecFun: `' + url_replace.toString() + '`');
			}
			if (datalength > 2) {
				Logger.log('Url check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', example in last csv element: `' + results.data[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, CSVRow-Array: `' + JSON.stringify(results.data[datalength - 1]) +  '`, ExecFun: `' + url_replace.toString() + '`');
			}
		}


	} else {
		Logger.log('Url check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', example in first csv element : `' + results.data[0][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, ExecFun: `' + url_replace.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				Logger.log('Url check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', example in second csv element : `' + results.data[1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, ExecFun: `' + url_replace.toString() + '`');
			}
			if (datalength > 2) {
				Logger.log('Url check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', example in last csv element: `' + results.data[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, ExecFun: `' + url_replace.toString() + '`');
			}
		}
	}



	var checkonlySeparator = null;
	if (CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'].length)  {
		checkonlySeparator = CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][1];
		Logger.log('onlySeparator check column ' + CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0] + ', example in first csv element : `' + results.data[0][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]] + '`, Separator: `' + checkonlySeparator.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				Logger.log('onlySeparator check column ' + CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0] + ', example in second csv element : `' + results.data[1][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]] + '`, Separator: `' + checkonlySeparator.toString() + '`');
			}
			if (datalength > 2) {
				Logger.log('onlySeparator check column ' + CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0] + ', example in last csv element : `' + results.data[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]] + '`, Separator: `' + checkonlySeparator.toString() + '`');
			}
		}
	}


	var checkskipSeparator = null;
	if (CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'].length)  {
		checkskipSeparator = CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][1];
		Logger.log('skipSeparator check column ' + CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0] + ', example in first csv element : `' + results.data[0][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]] + '`, Separator: `' + checkskipSeparator.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				Logger.log('skipSeparator check column ' + CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0] + ', example in second csv element : `' + results.data[1][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]] + '`, Separator: `' + checkskipSeparator.toString() + '`');
			}
			if (datalength > 2) {
				Logger.log('skipSeparator check column ' + CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0] + ', example in last csv element : `' + results.data[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]] + '`, Separator: `' + checkskipSeparator.toString() + '`');
			}
		}
	}


	var curaddurls = 0;
	var curaddurlsearly = 0;


	var errors1 = 0;
	var errors2 = 0;
	var errors3 = 0;
	var errors4 = 0;
	var errors5 = 0;

	for (var i=startnum; i < results.data.length; i++) {


		curaddurlsearly++;
		if (curaddurlsearly > 500) {
			curaddurlsearly = 0;
			if (shouldExitEarly()) {
				ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly CSV create dbase\n";
				feedsAlreadyChecked['CSVsiteurlnum'] = i;
				feedsAlreadyChecked['CSVsiteurlLastelem'] = [i,JSON.parse(JSON.stringify(results.data[i]))];

				didExitEarly = true;
				return didExitEarly;
			}
		}


		if (checkonlySeparator) {
			//мы не знаем что в массиве, надо всегда try и точное сравнение
			try {
				//ищем признак продолжения поиска ссылок
				var foundlabel = 0;
				for (var ii = 0; ii < checkonlySeparator.length; ii++) {
					var findsplit = checkonlySeparator[ii];
					var resfindsplit = results.data[i][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]].split(findsplit);
					//самый быстрый вариант
					if (resfindsplit[0] !== results.data[i][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]]) {
						//найден один признак вхождения, можно добавлять ссылку, если другие критерии не отвергнут ссылку
						foundlabel = 1;
						break;
					}
				}
				if (!foundlabel) {
					//не найдено ни одного вхождения, не добавляем ссылку
					continue
				}

			} catch (e) {
				//в массиве ошибка не заносим эту строку, выдаем сообщение при отладке
				if (ScanCreateFeedsGlobalVars.debug&&(errors1 < 10)) {
					errors1++;
					Logger.log('Error ' + e.message + ' in dataNum: ' + i + ' in onlySeparator, check column ' + CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0] + ', CSVRow-Array: `' + JSON.stringify(results.data[i]) + '`, Separator: `' + checkonlySeparator.toString() + '`')
				}
				scanned.errors.unknownCSV++;
				continue;
			}

		}



		if (checkskipSeparator) {
			//мы не знаем что в массиве, надо всегда try и точное сравнение
			try {
				//ищем признак непродолжения поиска ссылок
				var foundlabel = 0;
				for (var ii = 0; ii < checkskipSeparator.length; ii++) {
					var findsplit = checkskipSeparator[ii];
					var resfindsplit = results.data[i][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]].split(findsplit);
					//самый быстрый вариант
					if (resfindsplit[0] !== results.data[i][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]]) {
						//найден стопор, низзя добавлять ссылку
						foundlabel = 1;
						break;
					}
				}
				if (foundlabel) {
					//найдено одно вхождение, не добавляем ссылку
					continue
				}

			} catch (e) {
				//в массиве ошибка не заносим эту строку, выдаем сообщение при отладке
				if (ScanCreateFeedsGlobalVars.debug&&(errors2 < 10)) {
					errors2++
					Logger.log('Error ' + e.message + '  in dataNum: ' + i + ' in skipSeparator, check column ' + CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0] + ', CSVRow-Array: `' + JSON.stringify(results.data[i]) + '`, Separator: `' + checkskipSeparator.toString() + '`')
				}
				scanned.errors.unknownCSV++;
				continue;
			}

		}


		if (url_replace) {
			try {
		                var next_url = url_replace(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0], results.data[i]);
				if (!next_url) {
					//если пусто, то может быть что угодно, не только пустая строка, не ошибка
					continue;
				}
				if (typeof next_url != 'string') {
					//ошибка функции, может быть только строка (если не пусто), выдаем сообщение при отладке
					if (ScanCreateFeedsGlobalVars.debug&&(errors3 < 10)) {
						errors3++
						Logger.log('Bad return from ExecFun in dataNum: ' + i + ', function parameters: (' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ',' + JSON.stringify(results.data[i]) + ')');
					}
					scanned.errors.unknownCSV++;
					continue;
				}
		                next_url = next_url.trim();
				if (!next_url) {
					//если пусто, то здесь не ошибка
					continue;
				}
			} catch (e) {
				//в массиве или функции ошибка, не заносим эту строку, выдаем сообщение при отладке
				if (ScanCreateFeedsGlobalVars.debug&&(errors4 < 10)) {
					errors4++
					Logger.log('Error ' + e.message + ' in dataNum: ' + i + ' in ExecFun, function parameters: (' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ',' + JSON.stringify(results.data[i]) + ')');
				}
				scanned.errors.unknownCSV++;
				continue;
			}
		} else {
			var next_url = results.data[i][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]];
			if (!next_url) {
				//в данном случае записываем ошибку - должны быть всегда url в этой ячейке csv
				if (ScanCreateFeedsGlobalVars.debug&&(errors5 < 10)) {
					errors5++
					Logger.log('Empty url in dataNum: ' + i + ' check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', CSVRow-Array: `' + JSON.stringify(results.data[i]) + '`')
				}
				scanned.errors.unknownCSV++;
				continue;
			} else {
		                next_url = next_url.trim();
				if (!next_url) {
					//в данном случае записываем ошибку - должны быть всегда url в этой ячейке csv
					if (ScanCreateFeedsGlobalVars.debug&&(errors5 < 10)) {
						errors5++
						Logger.log('Empty url in dataNum: ' + i + ' check column ' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ', CSVRow-Array: `' + JSON.stringify(results.data[i]) + '`')
					}
					scanned.errors.unknownCSV++;
					continue;
				}
			}
		}


		next_url = ValidateURL(url, next_url);

		//if (next_url == false) continue;
		if (!next_url) continue;

		// Don't scan when already scanned
		if (scanned.scanned.indexOf(next_url) >= 0) continue;

		var snnum = scanned.scanned.length
		scanned.scanned[snnum] = next_url;
		scanned.checked[snnum] = 0;
		scanned.referrer[snnum] = referrer_url;
		scanned.referrer_field[snnum] = '';

		curaddurls++;

		//завершаем, если превысили масимально возможное кол-во элементов
		if (snnum >= endnum)
			break;


	}



//	feedsAlreadyChecked['CSVlisturlnum']++;
//	feedsAlreadyChecked['CSVsiteurlnum'] = 0;
//	feedsAlreadyChecked['CSVsiteurlLastelem'] = null;


	if (ScanCreateFeedsGlobalVars.debug) {
		Logger.log("found new urls: " + curaddurls);
	}


	return didExitEarly;


}



function XMLfindArray (XMLobj, setarr, setarrnum) {
//ищем массив (список товарных записей) в последнем элементе (согласно setarr)
//промежуточные элементы могут быть хеши или массивы

//пример
//var n = ['yml_catalog','shop','offers','offer'];
//var a = '{"yml_catalog":{"date":"2020-03-20 20:20","shop":{"name":{"Text":"EVIE"},"company":{"Text":"EVIE.shoes"},"url":{"Text":"https://evie.ua"},"platform":{"Text":"1C-Bitrix"},"currencies":{"currency":{"id":"UAH","rate":"1"},"Text":""},"categories":{"category":[{"id":"1","Text":"Обувь девочкам"},{"id":"115","parentId":"1","Text":"Школа"},{"id":"8","parentId":"1","Text":"Деми"},{"id":"82","parentId":"8","Text":"Ботинки"},{"id":"84","parentId":"8","Text":"Кроссовки"},{"id":"87","parentId":"8","Text":"Мокасины"},{"id":"90","parentId":"8","Text":"Резиновые сапоги"},{"id":"83","parentId":"8","Text":"Туфли"},{"id":"2","parentId":"1","Text":"Зима"},{"id":"4","parentId":"2","Text":"Ботинки"},{"id":"3","parentId":"2","Text":"Сапоги"},{"id":"11","parentId":"1","Text":"Лето"},{"id":"89","parentId":"11","Text":"Босоножки"},{"id":"93","parentId":"11","Text":"Кеды"},{"id":"71","Text":"Обувь мальчикам"},{"id":"116","parentId":"71","Text":"Школа"},{"id":"72","parentId":"71","Text":"Деми"},{"id":"85","parentId":"72","Text":"Ботинки"},{"id":"86","parentId":"72","Text":"Кроссовки"},{"id":"88","parentId":"72","Text":"Мокасины"},{"id":"91","parentId":"72","Text":"Резиновые сапоги"},{"id":"92","parentId":"72","Text":"Туфли"},{"id":"73","parentId":"71","Text":"Зима"},{"id":"74","parentId":"73","Text":"Ботинки"},{"id":"77","parentId":"71","Text":"Лето"},{"id":"94","parentId":"77","Text":"Босоножки"},{"id":"95","parentId":"77","Text":"Кеды"},{"id":"96","parentId":"77","Text":"Мокасины"},{"id":"120","Text":"SALE"}],"Text":""},"offers":{"offer":[{"id":"3540","available":"true","url":{"Text":"https://evie.ua/catalog/obuv_devochkam_2/botinki_timberland_navy.html?offerID=3540"},"price":{"Text":"847.5"},"oldprice":{"Text":"1695"},"currencyId":{"Text":"UAH"},"categoryId":{"Text":"120"},"picture":{"Text":"https://evie.ua/upload/iblock/d12/d12a2362bcf23a59fccb8bad3b580c07.jpg"},"vendor":{"Text":"Украина"},"name":{"Text":"Ботинки арт.034-1 Navy размер 24 (15,5)"},"description":{"Text":"Ботинки"},"country_of_origin":{"Text":"Украина"},"param":[{"name":"Вид застежки","Text":"Молния"},{"name":"Подкладка","Text":"100% шерсть"},{"name":"Материал верха","Text":"Натуральный нубук"},{"name":"Сезон","Text":"Зима"},{"name":"Вид товара","Text":"Ботинки"},{"name":"Артикул1","Text":"034-1 Navy"},{"name":"Дополнительные фотографии","Text":"https://evie.ua/upload/iblock/ff2/ff2fe072e6ed64fd70ee22b69d359b29.jpg, https://evie.ua/upload/iblock/7a6/7a6f869195c7621c716073f45c69007c.jpg"}],"Text":""},{"id":"3541","available":"true","url":{"Text":"https://evie.ua/catalog/obuv_devochkam_2/botinki_timberland_navy.html?offerID=3541"},"price":{"Text":"847.5"},"oldprice":{"Text":"1695"},"currencyId":{"Text":"UAH"},"categoryId":{"Text":"120"},"picture":{"Text":"https://evie.ua/upload/iblock/d12/d12a2362bcf23a59fccb8bad3b580c07.jpg"},"vendor":{"Text":"Украина"},"name":{"Text":"Ботинки арт.034-1 Navy размер 25 (6)"},"description":{"Text":"Ботинки"},"country_of_origin":{"Text":"Украина"},"param":[{"name":"Вид застежки","Text":"Молния"},{"name":"Подкладка","Text":"100% шерсть"},{"name":"Материал верха","Text":"Натуральный нубук"},{"name":"Сезон","Text":"Зима"},{"name":"Вид товара","Text":"Ботинки"},{"name":"Артикул1","Text":"034-1 Navy"},{"name":"Дополнительные фотографии","Text":"https://evie.ua/upload/iblock/ff2/ff2fe072e6ed64fd70ee22b69d359b29.jpg, https://evie.ua/upload/iblock/7a6/7a6f869195c7621c716073f45c69007c.jpg"}],"Text":""},{"id":"3545","available":"true","url":{"Text":"https://evie.ua/catalog/obuv_devochkam_2/mini_martens_black.html?offerID=3545"},"price":{"Text":"957"},"oldprice":{"Text":"1595"},"currencyId":{"Text":"UAH"},"categoryId":{"Text":"82"},"picture":{"Text":"https://evie.ua/upload/iblock/2a8/2a8c3aedaee6829f1e53fabe07069b2d.jpg"},"vendor":{"Text":"Украина"},"name":{"Text":"Mini Martens арт.018-1L Black размер 27(17)"},"description":{"Text":"Mini Martens Black 018-1L"},"country_of_origin":{"Text":"Украина"},"param":[{"name":"Вид застежки","Text":"Молния"},{"name":"Подкладка","Text":"Натуральная кожа"},{"name":"Материал верха","Text":"Лак на основе микрофибры, со специальным покрытием, который не поддается царапинам"},{"name":"Сезон","Text":"Деми"},{"name":"Вид товара","Text":"Ботинки"},{"name":"Артикул1","Text":"018-1L Black"},{"name":"Дополнительные фотографии","Text":"https://evie.ua/upload/iblock/236/23692247db3e0470392b00afe9395537.jpg, https://evie.ua/upload/iblock/505/505c8f1133e7217d28ebd1aa1b8dbca0.jpg, https://evie.ua/upload/iblock/0b0/0b05d847f921cf945e43b5cd5a8dd316.JPG, https://evie.ua/upload/iblock/27e/27e9149c13d2ee71520d247bb7f37d9b.jpg, https://evie.ua/upload/iblock/9ce/9cef2fb1634f1a80dbd9234f401e515b.JPG, https://evie.ua/upload/iblock/8cf/8cf8c45e3c308e5f2c777210f81c1722.jpg"}],"Text":""},{"id":"3546","available":"true","url":{"Text":"https://evie.ua/catalog/obuv_devochkam_2/mini_martens_black.html?offerID=3546"},"price":{"Text":"957"},"oldprice":{"Text":"1595"},"currencyId":{"Text":"UAH"},"categoryId":{"Text":"82"},"picture":{"Text":"https://evie.ua/upload/iblock/2a8/2a8c3aedaee6829f1e53fabe07069b2d.jpg"},"vendor":{"Text":"Украина"},"name":{"Text":"Mini Martens арт.018-1L Black размер 28(18)"},"description":{"Text":"Mini Martens Black 018-1L"},"country_of_origin":{"Text":"Украина"},"param":[{"name":"Вид застежки","Text":"Молния"},{"name":"Подкладка","Text":"Натуральная кожа"},{"name":"Материал верха","Text":"Лак на основе микрофибры, со специальным покрытием, который не поддается царапинам"},{"name":"Сезон","Text":"Деми"},{"name":"Вид товара","Text":"Ботинки"},{"name":"Артикул1","Text":"018-1L Black"},{"name":"Дополнительные фотографии","Text":"https://evie.ua/upload/iblock/236/23692247db3e0470392b00afe9395537.jpg, https://evie.ua/upload/iblock/505/505c8f1133e7217d28ebd1aa1b8dbca0.jpg, https://evie.ua/upload/iblock/0b0/0b05d847f921cf945e43b5cd5a8dd316.JPG, https://evie.ua/upload/iblock/27e/27e9149c13d2ee71520d247bb7f37d9b.jpg, https://evie.ua/upload/iblock/9ce/9cef2fb1634f1a80dbd9234f401e515b.JPG, https://evie.ua/upload/iblock/8cf/8cf8c45e3c308e5f2c777210f81c1722.jpg"}],"Text":""},{"id":"3559","available":"true","url":{"Text":"https://evie.ua/catalog/obuv_devochkam_2/mini_martens_gold.html?offerID=3559"},"price":{"Text":"478.5"},"oldprice":{"Text":"1595"},"currencyId":{"Text":"UAH"},"categoryId":{"Text":"120"},"picture":{"Text":"https://evie.ua/upload/iblock/594/59454cf9bfead890afdd0d293618b4bb.jpg"},"vendor":{"Text":"Украина"},"name":{"Text":"Mini Martens Gold арт.018-5L размер 25 (15)"},"description":{"Text":"Mini Martens Gold"},"country_of_origin":{"Text":"Украина"},"param":[{"name":"Вид застежки","Text":"Молния"},{"name":"Подкладка","Text":"Натуральная кожа"},{"name":"Материал верха","Text":"Натуральный лак на основе микрофибры с защитным покрытием"},{"name":"Сезон","Text":"Деми"},{"name":"Вид товара","Text":"Ботинки"},{"name":"Артикул1","Text":"018-5L Gold"},{"name":"Дополнительные фотографии","Text":"https://evie.ua/upload/iblock/173/17318c250035a4b20c227722335f4079.jpg"}],"Text":""},{"id":"3566","available":"true","url":{"Text":"https://evie.ua/catalog/obuv_devochkam_2/mini_martens_pink.html?offerID=3566"},"price":{"Text":"448.5"},"oldprice":{"Text":"1495"},"currencyId":{"Text":"UAH"},"categoryId":{"Text":"120"},"picture":{"Text":"https://evie.ua/upload/iblock/d41/d41a7b6553164971031b4d4fea61445f.jpg"},"vendor":{"Text":"Украина"},"name":{"Text":"Mini Martens Pink арт.018-2L размер 25 (15)"},"description":{"Text":"Mini Martens Pink"},"country_of_origin":{"Text":"Украина"},"param":[{"name":"Вид застежки","Text":"Молния"},{"name":"Подкладка","Text":"Натуральная кожа"},{"name":"Материал верха","Text":"Натуральный лак на основе микрофибры с защитным покрытием"},{"name":"Сезон","Text":"Деми"},{"name":"Вид товара","Text":"Ботинки"},{"name":"Дополнительные фотографии","Text":"https://evie.ua/upload/iblock/1e2/1e2d43fd381c0d1b9c27487730d00cf8.jpg, https://evie.ua/upload/iblock/747/74773eb6aed0f26cca889557094510c0.jpg, https://evie.ua/upload/iblock/830/830a54c3f776e776c05645df8d95b040.jpg, https://evie.ua/upload/iblock/ac1/ac17e7f1a410f00fc470d53dd7a0e59a.jpg, https://evie.ua/upload/iblock/711/71116601486f3faf24355369c1dadd0a.jpg, https://evie.ua/upload/iblock/312/31213a823e5c339fdce22d3330359bc7.jpg, https://evie.ua/upload/iblock/8b4/8b44445053c8011d22b28de278a157a4.jpg, https://evie.ua/upload/iblock/566/56668959b92661950d4e1f8e3412afb1.jpg, https://evie.ua/upload/iblock/95a/95a162bc0dba779f51d20459105ecc77.jpg"}],"Text":""}],"Text":""},"Text":""},"Text":""}}';
//XMLfindArray (a2, n)


	if (!setarrnum)
		setarrnum = 0;


	if (typeof XMLobj !== 'object')
		return;

	if ({}.toString.call(setarr) !== '[object Array]')
		return;

	if (typeof setarrnum !== 'number')
		return;


	var objt = {}.toString.call(XMLobj[setarr[setarrnum]]);

	if ((objt == '[object Array]')||(objt == '[object Object]')) {
		//здесь есть возможность перехода дальше на след уровень глобального хеша
		if (setarr.length <= setarrnum + 1) {
			//последний элемент
			if (objt !== '[object Array]') {
				//должен быть массив, а не хеш (эта функция используется только для выхода на список товаров, иначе убрать ограничение с возвратом undefined)
				return;
			} else {
				return XMLobj[setarr[setarrnum]];
			}
		} else {
			//индекс только цифровой элемент, если массив
			if ((objt == '[object Array]')&&(typeof setarr[setarrnum + 1] !== 'number'))
				return;

			//если не последний элемент, то всегда идет переход вглубь по setarr (и для массивов и для хешей)
			return XMLfindArray (XMLobj[setarr[setarrnum]], setarr, setarrnum + 1)
		}
	} else {
		return;
	}

}





function XMLobjectValue (XMLobj, setarr, setarrnum) {
//ищем значение в последнем элементе (согласно setarr) (может быть что угодно)
//если промежуточный элемент массив, то перебираем его и проходим дальше с помощь трех следущих элементов setarr (один - параметр, второй - его искомое значение, третий - элемент, значение которого надо получить или пройти дальше)
//промежуточные элементы могут быть хеши или массивы

//пример
//var nn = ['param','name','Сезон','Text']; //это поиск 'param' c 'name' = 'Сезон' и показ текста внутри тега 'param'
//var nn = ['param','name']; //это показ значения параметра 'name' тега 'param'
//var nn = ['param']; //это показ списка (массива) тегов 'param'
//var nn = ['url','Text']; //это показ текста внутри тега 'url'
//var aa = '{"id":"3540","available":"true","url":{"Text":"https://evie.ua/catalog/obuv_devochkam_2/botinki_timberland_navy.html?offerID=3540"},"price":{"Text":"847.5"},"oldprice":{"Text":"1695"},"currencyId":{"Text":"UAH"},"categoryId":{"Text":"120"},"picture":{"Text":"https://evie.ua/upload/iblock/d12/d12a2362bcf23a59fccb8bad3b580c07.jpg"},"vendor":{"Text":"Украина"},"name":{"Text":"Ботинки арт.034-1 Navy размер 24 (15,5)"},"description":{"Text":"Ботинки"},"country_of_origin":{"Text":"Украина"},"param":[{"name":"Вид застежки","Text":"Молния"},{"name":"Подкладка","Text":"100% шерсть"},{"name":"Материал верха","Text":"Натуральный нубук"},{"name":"Сезон","Text":"Зима"},{"name":"Вид товара","Text":"Ботинки"},{"name":"Артикул1","Text":"034-1 Navy"},{"name":"Дополнительные фотографии","Text":"https://evie.ua/upload/iblock/ff2/ff2fe072e6ed64fd70ee22b69d359b29.jpg, https://evie.ua/upload/iblock/7a6/7a6f869195c7621c716073f45c69007c.jpg"}],"Text":""}';
//XMLobjectValue (aa2, nn)

	if (!setarrnum)
		setarrnum = 0;

	if (typeof XMLobj !== 'object')
		return '';

	if ({}.toString.call(setarr) !== '[object Array]')
		return '';

	if (typeof setarrnum !== 'number')
		return '';

	var objt = {}.toString.call(XMLobj[setarr[setarrnum]]);

	if ((objt == '[object Array]')||(objt == '[object Object]')) {
		//здесь есть возможность перехода дальше на след уровень глобального хеша

		if (setarr.length <= setarrnum + 1) {
			//последний элемент
			return XMLobj[setarr[setarrnum]];
		} else {


			if (objt !== '[object Array]') {
				//если не массив а хеш, то переходим дальше на след уровень глобального хеша
				return XMLobjectValue (XMLobj[setarr[setarrnum]], setarr, setarrnum + 1)
			} else {

				if (setarr.length <= setarrnum + 3) {
					//нет вариантов выбора, так как это предпоследний элемент, отдаем первый попавшийся (нулевой как правило)

					if (setarr.length <= setarrnum + 1)
						return '';

//здесь при компиляции гугл выдает предупреждение типа
//unreachable code at line 14578 character 57
//абсолютно пока непонятное, так как код достижим
					for (var i=0; i < XMLobj[setarr[setarrnum]].length; i++) {
						if (typeof XMLobj[setarr[setarrnum]][i][setarr[setarrnum + 1]] !== 'string')
							return '';
						return XMLobjectValue (XMLobj[setarr[setarrnum]][i], setarr, setarrnum + 1);
					}

				} else {
					//не последний элемент, массив - перебираем,
					//ищем следующий за ним элемент в качестве значения, 
					//когда найдем первый из возможных, то выдаем значение элемента после следующего
					for (var i=0; i < XMLobj[setarr[setarrnum]].length; i++) {
						if (typeof XMLobj[setarr[setarrnum]][i][setarr[setarrnum + 1]] !== 'string')
							return '';
						if (XMLobj[setarr[setarrnum]][i][setarr[setarrnum + 1]] === setarr[setarrnum + 2]) {
		
							//идем дальше по третьему элементу
							return XMLobjectValue (XMLobj[setarr[setarrnum]][i], setarr, setarrnum + 3);

						}
					}
				}

				return '';


			}
		}
	} else if (objt == '[object String]') {
		return XMLobj[setarr[setarrnum]];
	} else {
		return '';
	}

}




function XMLScan(CSVConfig, CSVurlnum, OneSiteConfig, feedsAlreadyChecked, notScanUrlsonAnyPages) {


	//сформировали хеш
	//['CSVConfig']['parseUrls']
	//['CSVConfig']['skip_errors']
	//['CSVConfig']['MAX_TRIES']
	//['CSVConfig']['REQUEST_DELAY']
	//['CSVConfig']['repeaterUrl']
	//['CSVConfig']['CSVurls'].length - массив ссылок и их параметров 
	//['CSVConfig']['CSVurls'][i]['url']
	//['CSVConfig']['CSVurls'][i]['CHARSET']
	//['CSVConfig']['CSVurls'][i]['url_column_replace'] - массив с 1.массивом доступа к полю ссылки и 2.функцией для анализа/вывода ссылки по данным в массиве CSV-строки
	//['CSVConfig']['CSVurls'][i]['onlySeparator']
	//['CSVConfig']['CSVurls'][i]['skipSeparator']
	//['CSVConfig']['CSVurls'][i]['StartEndLines']
	//['CSVConfig']['CSVurls'][i]['csvParserConfig']


	var repeat_errors = ScanCreateFeedsGlobalVars.repeat_errors;

	var CHARSET = CSVConfig['CSVurls'][CSVurlnum]['CHARSET'];


	var url = CSVConfig['CSVurls'][CSVurlnum]['url'];

        var referrer_url = ''

	var scanned = feedsAlreadyChecked.scanned;

	var didExitEarly = false;


//	if (ScanCreateFeedsGlobalVars.debug)
		Logger.log("Get XML " + url);




	if (CSVConfig.repeaterUrl) {
		var httpOptions = {
//			contentType: "text/anytext",
			contentType: "text/plain",
			muteHttpExceptions: true,
			followRedirects: false,
  			headers : {
//				"User-Agent": "Mozilla/5.0",
				"Referer" : "http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"
			}
		};
	} else {
		var httpOptions = {
//			contentType: "text/anytext",
			contentType: "text/plain",
			muteHttpExceptions: true,
			followRedirects: false
		};
	}



	var MAX_TRIES = CSVConfig.MAX_TRIES;
	if (!MAX_TRIES)
		MAX_TRIES = 5;

	var responseCode = 0;
	var numTries = 0;

	var emessage = '';

	var known_error = 0;

	while (numTries < MAX_TRIES && !responseCode) {

		known_error = 0;

		numTries++;

		//здесь проверка приближения таймаута
		if (shouldExitEarly10()) {
			ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly 11\n";
			didExitEarly = true;
			return didExitEarly;
		}


		emessage = '';
		try {

			if (CSVConfig.repeaterUrl) {
				var response = UrlFetchApp.fetch(CSVConfig.repeaterUrl + urlEncode(url, 'beforequest2'), httpOptions);
			} else {
				var response = UrlFetchApp.fetch(url, httpOptions);
			}
			responseCode = response.getResponseCode();
		} catch (e) {

			emessage = e.message;
			if (!emessage)
				emessage = ' ';
		}

		if (emessage) {

			if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
				//это значит, что слишком частые запросы

				var sleeptime = 1000;
				var match = emessage.match(/Try Utilities\.sleep\((\d+)\)/);
				if (match && match[1]) {
					sleeptime = match[1] * 1;
				}

				Utilities.sleep(sleeptime);


			} else if (emessage.indexOf('Service invoked too many times') != -1) {
				//это значит, что превышено разрешенное количество запросов (за день наверное)
				//Service invoked too many times for one day: urlfetch
				if (ScanCreateFeedsGlobalVars.debug) {
					Logger.log("Service error: " + emessage);
				} else {
					Logger.log("Get XML " + url + "\nService error: " + emessage);
				}
				ScanCreateFeedsGlobalVars.warnings += 'Exit ' + emessage + "\n";
				didExitEarly = true;
				return didExitEarly;
			}

		} else {

			if (!isValidResponseCodeCSV(responseCode,CSVConfig)) {
				var headers = response.getHeaders();
				if (headers['Location']) {


					if (numTries < MAX_TRIES) {
						if (repeat_errors && repeat_errors.length) {
							for (var v in repeat_errors) {
								if (repeat_errors[v] == responseCode) {
									known_error = 1;
									//устанавливаем, что бы пропустило дальше по кругу (повтор при ошибках)
									responseCode = 0;
									if (CSVConfig.REQUEST_DELAY) {
										Utilities.sleep(CSVConfig.REQUEST_DELAY);
									}
									break;
								}
							}
							if (known_error) {
								continue;
							}
						}
					}



					var next_url = headers['Location'];
					next_url = ValidateCSVURL(url, next_url);

					if (next_url == false) {

						ScanCreateFeedsGlobalVars.errors += "Get XML " + url + ", redirect to not valid url: " + headers['Location'] + "\n";
						Logger.log("XML redirect to not valid url: " + headers['Location'] + "\n");

//при неизвестных ошибках на CSV выходим, в отличии от скана
						scanned.errors.unknownCSV++;
						return didExitEarly;
					}

					if (numTries < MAX_TRIES) {
						url = next_url;

						if (ScanCreateFeedsGlobalVars.debug)
							Logger.log("XML redirect to url: " + headers['Location'] + " responceCode: " + responseCode + "\n");


						//устанавливаем, что бы пропустило дальше по кругу
						responseCode = 0;
					} else {
						//завершится и так при выходе наверх, но форсируем в этой точке
						break;
					}
				} else if (numTries < MAX_TRIES) {
					if (repeat_errors && repeat_errors.length) {
						for (var v in repeat_errors) {
							if (repeat_errors[v] == responseCode) {
								known_error = 1;
								//устанавливаем, что бы пропустило дальше по кругу (повтор при ошибках)
								responseCode = 0;
								if (CSVConfig.REQUEST_DELAY) {
									Utilities.sleep(CSVConfig.REQUEST_DELAY);
								}
								break;
							}
						}
						if (known_error) {
							continue;
						}
					}
					break;
				} else {
					if (repeat_errors && repeat_errors.length) {
						for (var v in repeat_errors) {
							if (repeat_errors[v] == responseCode) {
								known_error = 1;
							}
						}
					}
					//завершится и так при выходе наверх, но форсируем в этой точке
					break;
				}
			}

		}

	}

	if (emessage) {


		if (emessage.indexOf('Service invoked too many times in a short time') != -1) {
			//это значит, что слишком частые запросы

			if (ScanCreateFeedsGlobalVars.debug) {
				Logger.log("Service error: " + emessage);
			}

			ScanCreateFeedsGlobalVars.warnings += 'Exit ' + emessage + "\n";

			didExitEarly = true;
			return didExitEarly;
		}



		ScanCreateFeedsGlobalVars.errors += "Get XML " + url + ", Unknown error: " + emessage + "\n";
		Logger.log(ScanCreateFeedsGlobalVars.errors);


		scanned.errors.unknownCSV++;



//при неизвестных ошибках на CSV выходим, в отличии от скана


		return didExitEarly;

	}


	if (!isValidResponseCodeCSV(responseCode,CSVConfig)) {
		ScanCreateFeedsGlobalVars.errors += "Get XML " + url + ", not valid responce for XML-list: " + responseCode + "\n";
		Logger.log(ScanCreateFeedsGlobalVars.errors);
//здесь нужно выйти с ошибкой (а если допустимо отсутствие страницы, то занести в skip_errors 404 410 или какую другую выдаст сервер)
		if (!scanned.errors.response[responseCode + '']) {
			scanned.errors.response[responseCode + ''] = 1;
		} else {
			scanned.errors.response[responseCode + '']++;
		}
		return didExitEarly;
	}




	var html = response.getContentText(CHARSET);

	if (CHARSET == 'UTF-8') {

		//если установлен жестко чарсет то сюда не заходим

		//    https://en.wikipedia.org/wiki/Charset_detection
		var charset = '';
		var headers = response.getHeaders();
		if (headers && headers['Content-Type']) {
			var match = headers['Content-Type'].match(/charset\s*=\s*[\"\']?([^\\\"\'\>\/\s]+)/);
			if (match && match[1]) {
				charset = match[1]
				//        Logger.log(charset);
			}

		}
		if (!charset) {
			//      <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" >
			//          <meta charset="utf-8" >
			var regExp = new RegExp("\\<meta[^\\>]+charset\\s*\\=\\s*[\\'\\\"]?\\s*([^\\/\\\"\\'\\> ]+)", "i");
			var ch = regExp.exec(html);
			if (ch) {
				charset = ch[1];
				//        Logger.log(charset);
			}
		}
		if (charset) {
			//определили чарсет
			charset = charset.toUpperCase();
			if (CHARSET != charset)
				html = response.getContentText(charset);
		}


	}




	if (ScanCreateFeedsGlobalVars.debug) {
//слишком большая выдача, обрежет лог дальше для страниц, закомментирована выдача полного html
//		if (ScanCreateFeedsGlobalVars.debug > 3) {
//			Logger.log("Valid responceCode for XML-list: " + responseCode + "\nresponce (JSON.stringify):\n" + JSON.stringify(html));
//		} else if (ScanCreateFeedsGlobalVars.debug > 1) {
//			Logger.log("Valid responceCode for XML-list: " + responseCode + ", responce length: " + html.length);
//		}
		if (ScanCreateFeedsGlobalVars.debug > 1) {
			Logger.log("Valid responceCode for XML-list: " + responseCode + ", responce length: " + html.length);
		}
	}


	if (!html.length) {
		ScanCreateFeedsGlobalVars.warnings += 'XML file empty: ' + url + "\n";
		Logger.log('XML file empty: ' + url);
		return didExitEarly;
	}


	var headers = response.getHeaders();
	if ((typeof headers["Content-Length"] == 'string')&&(/^\d+$/.test(headers["Content-Length"]))) {
		if (Number(headers["Content-Length"]) > html.length) {
			Logger.log('XML file maybe truncated: ' + url + ', expected length:' + headers["Content-Length"] + ', real length:' + html.length);
			ScanCreateFeedsGlobalVars.warnings += 'XML file maybe truncated: ' + url + ', expected length:' + headers["Content-Length"] + ', real length:' + html.length + "\n";
		}
	}



	//в XML не должно быть кодировки html-сущностей, поэтому никогда не перекодировать
	//if (Encoder.hasEncoded(html)) {
	//	html = Encoder.htmlDecode(html);
	//}



	//здесь проверка приближения таймаута
	//может запрос долго выполнялся, поэтому перед началом обработки проверяем еще раз
	if (shouldExitEarly10()) {
		ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly 12\n";
		didExitEarly = true;
		return didExitEarly;
	}



//https://gist.github.com/Spencer-Easton/9955d97fb1a6104aeb85
//https://www.labnol.org/code/19952-convert-xml-to-json
function xmlToJson(xml) { 
  var doc = XmlService.parse(xml);
  var result = {};
  var root = doc.getRootElement();
  result[root.getName()] = elementToJson(root);
  return result;
}

function elementToJson(element) {
  var result = {};
  // Attributes.
  element.getAttributes().forEach(function(attribute) {
    result[attribute.getName()] = attribute.getValue();
  });
  // Child elements.
  element.getChildren().forEach(function(child) {
    var key = child.getName();
    var value = elementToJson(child);
    if (result[key]) {
      if (!(result[key] instanceof Array)) {
        result[key] = [result[key]];
      }
      result[key].push(value);
    } else {
      result[key] = value;
    }
  });
  // Text content.
  if (element.getText()) {
    result['Text'] = element.getText();
  }
  return result;
}

	try {
		var results = xmlToJson(html);
	} catch (e) {
		//XmlService.parse может обрабатывать только валидную структуру XML (например, недозагрузка/обрезание файла, отсутствущие закрыващие теги - выдаст ошибку)
		ScanCreateFeedsGlobalVars.errors += 'XML structure error: ' + e.name + ': ' + e.message + "\n";
		Logger.log('XML structure error: ' + e.name + ': ' + e.message + "\n");
		return didExitEarly;
	}

	

	results = XMLfindArray(results, CSVConfig['CSVurls'][CSVurlnum]['csvParserConfig']['xml']);
	if ({}.toString.call(results) !== '[object Array]') {
		ScanCreateFeedsGlobalVars.errors += 'XML config error (not found array ' + CSVConfig['CSVurls'][CSVurlnum]['csvParserConfig']['xml'] + ')' + "\n";
		Logger.log('XML config error (not found array ' + CSVConfig['CSVurls'][CSVurlnum]['csvParserConfig']['xml'] + ')' + "\n");
		return didExitEarly;
	}


	var deletelastline = 0;
	var datalength = results.length;
	if (datalength > 1) {
		//проверка, что не обрезан последний элемент 
		//(эта проверка осталась из CSVScan, оставил если вдруг будет что-то другое вместо XmlService.parse)
		if (results[datalength-1].length < results[datalength-2].length) {
			//последний элемент имеет меньше столбцов, чем предыдущий, удаляем последний (он обрезался)

			ScanCreateFeedsGlobalVars.warnings += 'Delete bad last element in XML Array: ' + url + "\n";
			Logger.log('Delete bad last element in XML Array: ' + url);

			datalength--;
			results.length = datalength;
			deletelastline = 1;
		}

	} else if (!datalength) {
		ScanCreateFeedsGlobalVars.warnings += 'XML Array empty: ' + url + "\n";
		Logger.log('XML file empty: ' + url);
		return didExitEarly;
	}



	ScanCreateFeedsGlobalVars.messages += 'XML data.length = '+ results.length  + "\n";

	if (ScanCreateFeedsGlobalVars.debug) {
		if (deletelastline) {
			Logger.log('deleted last element in xml array');
		}

		Logger.log('xml data.length = '+ results.length);
//		Logger.log('xml data first = '+ JSON.stringify(results[0]));
//		Logger.log('xml data last = '+ JSON.stringify(results[results.length-1]));

		var mess="first xml element:\n"
		mess += JSON.stringify(results[0])
		Logger.log(mess);

		if (datalength > 1) {
			var mess="second xml element:\n"
			mess += JSON.stringify(results[1])
			Logger.log(mess);
		}

		if (datalength > 2) {
			var mess="last xml element:\n"
			mess += JSON.stringify(results[datalength - 1])
			Logger.log(mess);
		}

	}


	if (feedsAlreadyChecked['CSVsiteurlnum']&&feedsAlreadyChecked['CSVsiteurlLastelem']) {
		var restart = 0;
		if (results[feedsAlreadyChecked['CSVsiteurlLastelem'][0]]) {
			if (JSON.stringify(results[feedsAlreadyChecked['CSVsiteurlLastelem'][0]]) != JSON.stringify(feedsAlreadyChecked['CSVsiteurlLastelem'][1]))
				restart = 1;
		} else {
			restart = 1;
		}
		if (restart) {
			//обнаружено несовпадение прошлой незаконченной загрузки файла с текущей
			//последняя запись в файле не соответсвует этой записи при прошлой загрузке
			//все сносим, перечитываем при следующем запуске все списки
			scanned.scanned = [];
			scanned.checked = [];
			scanned.referrer = [];
			scanned.referrer_field = [];

			feedsAlreadyChecked['CSVlisturlnum'] = 0;
			feedsAlreadyChecked['CSVsiteurlnum'] = 0;
			feedsAlreadyChecked['CSVsiteurlLastelem'] = null;

			ScanCreateFeedsGlobalVars.warnings += "Exit, reload all xml-lists. Was changed xml-list" + url + "\n";
			didExitEarly = true;
			return didExitEarly;
		}
	}


//обрезаем массив
	if (CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][0]&&CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1]) {
		//в настройках указываются номера строк (начиная с 1)
		if (datalength > CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1]) {
			//обрезаем если меньше надо строк
			datalength = CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1];
			results.length = datalength;
			ScanCreateFeedsGlobalVars.messages += 'Truncate xml data.length, new XML data.length = '+ results.length  + "\n";
			if (ScanCreateFeedsGlobalVars.debug) {
				Logger.log('Truncate xml data.length in parameter StartEndLines');
				Logger.log('new xml data.length = '+ results.length);
				Logger.log('xml data first = '+ results[0]);
				Logger.log('xml data last = '+ results[results.length-1]);
				var mess="last xml element:\n"
				mess += JSON.stringify(results[datalength - 1])
				Logger.log(mess);

			}
		}
	}



	//находим начальную позицию
	var beginelnum = CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][0];
	if (beginelnum) {
		//в настройках указаны номера строк (начиная с 1), а нам нужен номер первого элемента
		beginelnum--

		//вычисляем номер максимально возможного добавляемого в массив скана элемента endnum

 		//сначала вычисляем по массиву results (больше вообще не получится)
		var endnum = results.length - 1;

		if (!notScanUrlsonAnyPages) {
			//мы уже добавили первую страницу, поэтому на один больше элементов должно быть
			endnum++;
		}


	} else {
		//в настройках указано число строк, поэтому стартовый элемент равен 0
		beginelnum = 0;

		//вычисляем номер максимально возможного добавляемого в массив скана элемента endnum

 		//сначала вычисляем по массиву results (больше вообще не получится)
		var endnum = results.length - 1;

		if (CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1]) {
			//здесь по максимальному количеству добавляемых элементов корректируем
			if (endnum > CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1] - 1)
				endnum = CSVConfig['CSVurls'][CSVurlnum]['StartEndLines'][1] - 1;
		}
		
		if (!notScanUrlsonAnyPages) {
			//мы уже добавили первую страницу, поэтому на один больше элементов должно быть
			endnum++;
		}



	}
	
	if (feedsAlreadyChecked['CSVsiteurlnum'] > beginelnum) {
		var startnum = feedsAlreadyChecked['CSVsiteurlnum'];
	} else {
		var startnum = beginelnum;
		feedsAlreadyChecked['CSVsiteurlnum'] = beginelnum;
	}




	//['CSVConfig']['CSVurls'][i]['url']
	//['CSVConfig']['CSVurls'][i]['CHARSET']
	//['CSVConfig']['CSVurls'][i]['url_column_replace'] - массив с 1.номером столбца со ссылкой и 2.функцией для анализа/вывода ссылки по данным в массиве CSV-строки
	//['CSVConfig']['CSVurls'][i]['onlySeparator']
	//['CSVConfig']['CSVurls'][i]['skipSeparator']
	//['CSVConfig']['CSVurls'][i]['StartEndLines']
	//['CSVConfig']['CSVurls'][i]['csvParserConfig']


	var url_replace = ''; //что бы не было ошибки в Logger.log на url_replace.toString()
	if (CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'].length > 1)  {
		url_replace = CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][1];
		//Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in first xml element : `' + results[0][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, XMLRow-Array: `' + JSON.stringify(results[0]) +  '`, ExecFun: `' + url_replace.toString() + '`');
		Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in first xml element : `' + XMLobjectValue(results[0], CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + '`, XMLRow-Array: `' + JSON.stringify(results[0]) +  '`, ExecFun: `' + url_replace.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				//Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in second xml element : `' + results[1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, XMLRow-Array: `' + JSON.stringify(results[1]) +  '`, ExecFun: `' + url_replace.toString() + '`');
				Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in second xml element : `' + XMLobjectValue(results[1], CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + '`, XMLRow-Array: `' + JSON.stringify(results[1]) +  '`, ExecFun: `' + url_replace.toString() + '`');
			}
			if (datalength > 2) {
				//Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in last xml element: `' + results[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, XMLRow-Array: `' + JSON.stringify(results[datalength - 1]) +  '`, ExecFun: `' + url_replace.toString() + '`');
				Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in last xml element: `' + XMLobjectValue(results[datalength - 1], CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + '`, XMLRow-Array: `' + JSON.stringify(results[datalength - 1]) +  '`, ExecFun: `' + url_replace.toString() + '`');
			}
		}


	} else {
		//Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in first xml element : `' + results[0][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, ExecFun: `' + url_replace.toString() + '`');
		Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in first xml element : `' + XMLobjectValue(results[0], CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + '`, ExecFun: `' + url_replace.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				//Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in second xml element : `' + results[1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, ExecFun: `' + url_replace.toString() + '`');
				Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in second xml element : `' + XMLobjectValue(results[1], CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + '`, ExecFun: `' + url_replace.toString() + '`');
			}
			if (datalength > 2) {
				//Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in last xml element: `' + results[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]] + '`, ExecFun: `' + url_replace.toString() + '`');
				Logger.log('Url find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', example in last xml element: `' + XMLobjectValue(results[datalength - 1], CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + '`, ExecFun: `' + url_replace.toString() + '`');
			}
		}
	}



	var checkonlySeparator = null;
	if (CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'].length)  {
		checkonlySeparator = CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][1];
		//Logger.log('onlySeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + ', example in first xml element : `' + results[0][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]] + '`, Separator: `' + checkonlySeparator.toString() + '`');
		Logger.log('onlySeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + ', example in first xml element : `' + XMLobjectValue(results[0], CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + '`, Separator: `' + checkonlySeparator.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				//Logger.log('onlySeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + ', example in second xml element : `' + results[1][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]] + '`, Separator: `' + checkonlySeparator.toString() + '`');
				Logger.log('onlySeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + ', example in second xml element : `' + XMLobjectValue(results[1], CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + '`, Separator: `' + checkonlySeparator.toString() + '`');
			}
			if (datalength > 2) {
				//Logger.log('onlySeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + ', example in last xml element : `' + results[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]] + '`, Separator: `' + checkonlySeparator.toString() + '`');
				Logger.log('onlySeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + ', example in last xml element : `' + XMLobjectValue(results[datalength - 1], CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + '`, Separator: `' + checkonlySeparator.toString() + '`');
			}
		}
	}


	var checkskipSeparator = null;
	if (CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'].length)  {
		checkskipSeparator = CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][1];
		//Logger.log('skipSeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + ', example in first xml element : `' + results[0][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]] + '`, Separator: `' + checkskipSeparator.toString() + '`');
		Logger.log('skipSeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + ', example in first xml element : `' + XMLobjectValue(results[0], CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + '`, Separator: `' + checkskipSeparator.toString() + '`');
		if (ScanCreateFeedsGlobalVars.debug) {
			if (datalength > 1) {
				//Logger.log('skipSeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + ', example in second xml element : `' + results[1][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]] + '`, Separator: `' + checkskipSeparator.toString() + '`');
				Logger.log('skipSeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + ', example in second xml element : `' + XMLobjectValue(results[1], CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + '`, Separator: `' + checkskipSeparator.toString() + '`');
			}
			if (datalength > 2) {
				//Logger.log('skipSeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + ', example in last xml element : `' + results[datalength - 1][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]] + '`, Separator: `' + checkskipSeparator.toString() + '`');
				Logger.log('skipSeparator find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + ', example in last xml element : `' + XMLobjectValue(results[datalength - 1], CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + '`, Separator: `' + checkskipSeparator.toString() + '`');
			}
		}
	}


	var curaddurls = 0;
	var curaddurlsearly = 0;


	var errors1 = 0;
	var errors2 = 0;
	var errors3 = 0;
	var errors4 = 0;
	var errors5 = 0;

	for (var i=startnum; i < results.length; i++) {


		curaddurlsearly++;
		if (curaddurlsearly > 500) {
			curaddurlsearly = 0;
			if (shouldExitEarly()) {
				ScanCreateFeedsGlobalVars.warnings += "Exit shouldExitEarly XML create dbase\n";
				feedsAlreadyChecked['CSVsiteurlnum'] = i;
				feedsAlreadyChecked['CSVsiteurlLastelem'] = [i,JSON.parse(JSON.stringify(results[i]))];

				didExitEarly = true;
				return didExitEarly;
			}
		}


		if (checkonlySeparator) {
			//мы не знаем что в массиве, надо всегда try и точное сравнение
			try {
				//ищем признак продолжения поиска ссылок
				var foundlabel = 0;
				for (var ii = 0; ii < checkonlySeparator.length; ii++) {
					var findsplit = checkonlySeparator[ii];
					//var resfindsplit = results[i][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]].split(findsplit);
					var resfindsplit = XMLobjectValue(results[i], CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]).split(findsplit);
					//самый быстрый вариант
					//if (resfindsplit[0] !== results[i][CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]]) {
					if (resfindsplit[0] !== XMLobjectValue(results[i], CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0])) {
						//найден один признак вхождения, можно добавлять ссылку, если другие критерии не отвергнут ссылку
						foundlabel = 1;
						break;
					}
				}
				if (!foundlabel) {
					//не найдено ни одного вхождения, не добавляем ссылку
					continue
				}

			} catch (e) {
				//в массиве ошибка не заносим эту строку, выдаем сообщение при отладке
				if (ScanCreateFeedsGlobalVars.debug&&(errors1 < 10)) {
					errors1++;
					Logger.log('Error ' + e.message + ' in dataNum: ' + i + ' in onlySeparator, find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['onlySeparator'][0]) + ', XMLRow-Array: `' + JSON.stringify(results[i]) + '`, Separator: `' + checkonlySeparator.toString() + '`')
				}
				scanned.errors.unknownCSV++;
				continue;
			}

		}



		if (checkskipSeparator) {
			//мы не знаем что в массиве, надо всегда try и точное сравнение
			try {
				//ищем признак непродолжения поиска ссылок
				var foundlabel = 0;
				for (var ii = 0; ii < checkskipSeparator.length; ii++) {
					var findsplit = checkskipSeparator[ii];
					//var resfindsplit = results[i][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]].split(findsplit);
					var resfindsplit = XMLobjectValue(results[i], CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]).split(findsplit);
					//самый быстрый вариант
					//if (resfindsplit[0] !== results[i][CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]]) {
					if (resfindsplit[0] !== XMLobjectValue(results[i], CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0])) {
						//найден стопор, низзя добавлять ссылку
						foundlabel = 1;
						break;
					}
				}
				if (foundlabel) {
					//найдено одно вхождение, не добавляем ссылку
					continue
				}

			} catch (e) {
				//в массиве ошибка не заносим эту строку, выдаем сообщение при отладке
				if (ScanCreateFeedsGlobalVars.debug&&(errors2 < 10)) {
					errors2++
					Logger.log('Error ' + e.message + '  in dataNum: ' + i + ' in skipSeparator, find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['skipSeparator'][0]) + ', XMLRow-Array: `' + JSON.stringify(results[i]) + '`, Separator: `' + checkskipSeparator.toString() + '`')
				}
				scanned.errors.unknownCSV++;
				continue;
			}

		}


		if (url_replace) {
			try {
		                var next_url = url_replace(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0], results[i]);
				if (!next_url) {
					//если пусто, то может быть что угодно, не только пустая строка, не ошибка
					continue;
				}
				if (typeof next_url != 'string') {
					//ошибка функции, может быть только строка (если не пусто), выдаем сообщение при отладке
					if (ScanCreateFeedsGlobalVars.debug&&(errors3 < 10)) {
						errors3++
						Logger.log('Bad return from ExecFun in dataNum: ' + i + ', function parameters: (' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ',' + JSON.stringify(results[i]) + ')');
					}
					scanned.errors.unknownCSV++;
					continue;
				}
		                next_url = next_url.trim();
				if (!next_url) {
					//если пусто, то здесь не ошибка
					continue;
				}
			} catch (e) {
				//в массиве или функции ошибка, не заносим эту строку, выдаем сообщение при отладке
				if (ScanCreateFeedsGlobalVars.debug&&(errors4 < 10)) {
					errors4++
					Logger.log('Error ' + e.message + ' in dataNum: ' + i + ' in ExecFun, function parameters: (' + CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0] + ',' + JSON.stringify(results[i]) + ')');
				}
				scanned.errors.unknownCSV++;
				continue;
			}
		} else {
			//var next_url = results[i][CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]];
			var next_url = XMLobjectValue(results[i], CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]);
			if (!next_url) {
				//в данном случае записываем ошибку - должны быть всегда url в этой ячейке csv
				if (ScanCreateFeedsGlobalVars.debug&&(errors5 < 10)) {
					errors5++
					Logger.log('Empty url in dataNum: ' + i + ' find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ',  XMLRow-Array: `' + JSON.stringify(results[i]) + '`')
				}
				scanned.errors.unknownCSV++;
				continue;
			} else {
		                next_url = next_url.trim();
				if (!next_url) {
					//в данном случае записываем ошибку - должны быть всегда url в этой ячейке csv
					if (ScanCreateFeedsGlobalVars.debug&&(errors5 < 10)) {
						errors5++
						Logger.log('Empty url in dataNum: ' + i + ' find array ' + JSON.stringify(CSVConfig['CSVurls'][CSVurlnum]['url_column_replace'][0]) + ', XMLRow-Array: `' + JSON.stringify(results[i]) + '`')
					}
					scanned.errors.unknownCSV++;
					continue;
				}
			}
		}


		next_url = ValidateURL(url, next_url);

		//if (next_url == false) continue;
		if (!next_url) continue;

		// Don't scan when already scanned
		if (scanned.scanned.indexOf(next_url) >= 0) continue;

		var snnum = scanned.scanned.length
		scanned.scanned[snnum] = next_url;
		scanned.checked[snnum] = 0;
		scanned.referrer[snnum] = referrer_url;
		scanned.referrer_field[snnum] = '';

		curaddurls++;

		//завершаем, если превысили масимально возможное кол-во элементов
		if (snnum >= endnum)
			break;


	}



//	feedsAlreadyChecked['CSVlisturlnum']++;
//	feedsAlreadyChecked['CSVsiteurlnum'] = 0;
//	feedsAlreadyChecked['CSVsiteurlLastelem'] = null;


	if (ScanCreateFeedsGlobalVars.debug) {
		Logger.log("found new urls: " + curaddurls);
	}


	return didExitEarly;


}




function CreateFeedSearch(checkedfields,shortWordsHash,GAS,SearchFeedsFilesOUT,feed_id) {
//сборная функция - маленькая часть из CreateFeed и остальное из CreateSearch

	function correctfeedsearchExtPositionFunction(GASvalues,GAShtmlExt,ads,keywordsToCreate) {
//проверка наличия слов и объявлений не производится, так как уже выполнена раньше

//не должно быть в генерируемом тексте ad ads
//нельзя передавать keys - служебное слово
//передаются данные   
//arrayGA[i][ii].url
//arrayGA[i][ii].data
//arrayGA[i][ii].data[GASAId].Headlines сформированная строка с разделителем ' | '
//arrayGA[i][ii].data[GASAId].Paths сформированная строка с разделителем '/'
//arrayGA[i][ii].data[GASAId].Descriptions сформированная строка с разделителем ' ' (надо отслеживать [.!] в конце предыдущей строки и ставить . если нет)
//arrayGA[i][ii].keywrds = '<i>KEY1</i><i>KEY2</i>...'


		var position_OUT = {'url': GASvalues['url'], 'data': {} };

		for (var GASADId in ads) {
//		for (var ii = 0; ii < adids.length; ii++) {
//			var GASADId = adids[ii];
//			if (ads[GASADId]) {


				position_OUT['data'][GASADId] = {};
				position_OUT['data'][GASADId].Headlines = ads[GASADId].Headlines[0] + ' | ' + ads[GASADId].Headlines[1];

				position_OUT['data'][GASADId].Descriptions = ads[GASADId].Descriptions[0];
				if (ads[GASADId].Descriptions[1]) {
					//точку ставит гугл в конце предыдущего описания
					//добавил контроль запятой для красоты, хотя гугл поставит точку если в конце запятая есть, будет ,.
//лучше не раздражать клиента лишними точками, не добавляем, а так будет красиво всегда
//					if (/[\.\!\,]\s*$/.test(ads[GASADId].Descriptions[0])) {
						position_OUT['data'][GASADId].Descriptions += ' ' + ads[GASADId].Descriptions[1]
//					} else {
//						position_OUT['data'][GASADId].Descriptions += '. ' + ads[GASADId].Descriptions[1]
//					}
				}
				if (GAShtmlExt&&(!/[\.\!\,]\s*$/.test(position_OUT['data'][GASADId].Descriptions))) {
//нужен знак завершения, так как дальше появится GAShtmlExt
//для красоты (и в соответсвии с гугл правилами) перед расширениями ставим точку в конце всего описания, если нет завершающего знака [\.\!\,]
					position_OUT['data'][GASADId].Descriptions += '.';
				}

				if (ads[GASADId].Paths[0]) {
					position_OUT['data'][GASADId].Paths = ads[GASADId].Paths[0];
					if (ads[GASADId].Paths[1])
						position_OUT['data'][GASADId].Paths += '/' + ads[GASADId].Paths[1];
				} else {
					position_OUT['data'][GASADId].Paths = '';
				}



/*
				GASvalues['url']
				ads[GASADId].Headlines[0]
				ads[GASADId].Headlines[1]

				if (GASvalues['mobileurl'])
					GASvalues['mobileurl']

				if (ads[GASADId].Headlines[2])
					ads[GASADId].Headlines[2]

				if (ads[GASADId].Descriptions[1]) {
					ads[GASADId].Descriptions[0]
					ads[GASADId].Descriptions[1]
				} else {
					ads[GASADId].Descriptions[0]
				}

				if (ads[GASADId].Paths[0])
					ads[GASADId].Paths[0]

				if (ads[GASADId].Paths[1])
					ads[GASADId].Paths[1]

*/



//			}
		}


		var keys = '';
		for (var ii = 0; ii < keywordsToCreate.length; ii++) {
			keys += '<i>' + keywordsToCreate[ii] + '</i>'
		}

		position_OUT['keywrds'] = keys;

		return position_OUT;


	}




	var addtofeed = 0;

	if (GAS&&GAS['GAShtml']) {



		//генерируем новые данные и хеши данных

		//генерируем GASvalues - хеш значений типовых переменных GAS РК (GASparams)
		var GASvalues = {};
		for (var ii = 0; ii < GAS.GASparams.length; ii++) {
			var GASparamName = GAS.GASparams[ii][0];
			var GASparamType = GAS.GASparams[ii][1];

			if ((GASparamName == 'keys')&&(typeof GASparamType == 'object')) {
				GASvalues[GASparamName] = [];
				for (var iii = 0; iii < GASparamType.length; iii++) {
					//если есть типовая переменная РК (из списка GAS.GASparams) то вычисляем ее значение (массив)
					GASvalues[GASparamName][iii] = parvalue(GASparamType[iii],GASparamName,GAS[GASparamName][iii],checkedfields);
				}
			} else {
				//если есть типовая переменная РК (из списка GAS.GASparams) то вычисляем ее значение
				GASvalues[GASparamName] = parvalue(GASparamType,GASparamName,GAS[GASparamName],checkedfields);
			}
		}


		//генерируем GASADvalues - хеш значений типовых переменных GAS объявлений (GASADparams)
		var GASADvalues = {};
		for (var ii = 0; ii < GAS['adids'].length; ii++) {
			var GASADId = GAS['adids'][ii];
			GASADvalues[GASADId] = {}
			for (var iii = 0; iii < GAS[GASADId].GASADparams.length; iii++) {
				var GASADparamName = GAS[GASADId].GASADparams[iii][0];
				var GASADparamType = GAS[GASADId].GASADparams[iii][1];

				//если есть типовая переменная объявления (из списка GASADparams) то вычисляем ее значение
				if (GAS[GASADId]['FromGAS'][GASADparamName]) {
					//этот параметр берется из настройки РК, а не Объявления, поэтому сокращаем время выполнения, присваиваем уже вычисленное значение
					GASADvalues[GASADId][GASADparamName] = GASvalues[GASADparamName];
				} else {
					if ((GASADparamName == 'keys')&&(typeof GASADparamType == 'object')) {
						GASADvalues[GASADId][GASADparamName] = [];
						for (var iii = 0; iii < GASADparamType.length; iii++) {
							GASADvalues[GASADId][GASADparamName][iii] = parvalue(GASADparamType[iii],GASADparamName,GAS[GASADId][GASADparamName][iii],checkedfields);
						}
					} else {
						GASADvalues[GASADId][GASADparamName] = parvalue(GASADparamType,GASADparamName,GAS[GASADId][GASADparamName],checkedfields);
					}
				}
			}
		}


		if (ScanCreateFeedsGlobalVars.errors)
			return;




//вычисляем значения для рекламы

		//проверяем, что хотя бы одно значение параметра keys не пустое
		var keysnotemptyflg = 0;


		var keys = {'EXACT': {},'BROAD': {},'PHRASE': {}};
		var dkeys = {'EXACT': {},'BROAD': {},'PHRASE': {}};
		var addkeys = {'EXACT': {},'BROAD': {},'PHRASE': {}};
		var ads = {};
		var params = '';
		var params2 = '';


		if (GASvalues['keys']) {
			if (typeof GASvalues['keys'] == 'object') {
				for (var ii = 0; ii < GASvalues['keys'].length; ii++) {
					if (GASvalues['keys'][ii]) {
						keysnotemptyflg = 1;
						var feedkeys = ItemKeys(GASvalues['keys'][ii],shortWordsHash,GAS.keysmixtype,GAS.maxNodigaddkeyNum,GASvalues['fixedkeys'],GAS.notReqfixedkeys,GASvalues['onekeys']);
						if (feedkeys) {

					        	try {
								addkeystypegen[GAS.addkeystype](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
							} catch (e) {
								ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch, check script code\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
							}

/*
						} else if (feedkeys !== '') {

есть непустое значение GASvalues['keys']
и это не ошибка еще (например название товара состоит из одного слова)

*/
                	
						}
					}
				}
			} else {
				keysnotemptyflg = 1;
				var feedkeys = ItemKeys(GASvalues['keys'],shortWordsHash,GAS.keysmixtype,GAS.maxNodigaddkeyNum,GASvalues['fixedkeys'],GAS.notReqfixedkeys,GASvalues['onekeys']);
				if (feedkeys) {

			        	try {
						addkeystypegen[GAS.addkeystype](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
					} catch (e) {
						ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch, check script code\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
					}

/*

				} else if (feedkeys !== '') {

есть непустое значение GASvalues['keys']
и это не ошибка еще (например название товара состоит из одного слова)

*/

				}
			}
		}
		if (GASvalues['masskeys']) {
			var masskeys = GASvalues['masskeys'].trim()
			masskeys = masskeys.split(/[\s\,]*\,[\s\,]*/);
			for (var iii = 0; iii < masskeys.length; iii++) {
				if (masskeys[iii]) {
					keysnotemptyflg = 1;
					var feedkeys = ItemKeys(masskeys[iii],shortWordsHash,GAS.masskeysmixtype,GAS.maxNodigaddkeyNum,GASvalues['fixedkeys'],GAS.notReqfixedkeys,GASvalues['onekeys']);
					if (feedkeys) {
				        	try {
							addkeystypegen[GAS.addkeystype](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
						} catch (e) {
							ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch, check script code\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
						}

					}

				}
			}
		}


		//хотя бы одно объявление сформировать
		var checkadsnum=0
		for (var ii = 0; ii < GAS['adids'].length; ii++) {
			var GASADId = GAS['adids'][ii];

//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@

//			var adheaders = ItemHeaders(GASADvalues[GASADId]['header'],shortWordsHash,GASADvalues[GASADId]['paths'],GASADvalues[GASADId]['header2'],GAS[GASADId]['keyword'],GASADvalues[GASADId]['startdescription'],GASADvalues[GASADId]['beforeprice'],GASvalues['price'],GASADvalues[GASADId]['afterprice'],GASADvalues[GASADId]['description'],GASADvalues[GASADId]['afterdescription'],GAS[GASADId]['priceaddtype'],GAS['priceRound'],GAS[GASADId]['noPaths'],GAS[GASADId]['headerTo1Line'],GAS[GASADId]['afterdescrNeed'],GAS[GASADId]['requiredescr'],1);
			var adheaders = ItemHeaders(GASADvalues[GASADId]['header'],shortWordsHash,GASADvalues[GASADId]['paths'],GASADvalues[GASADId]['header2'],GAS['header3'],GAS[GASADId]['keyword'],GASADvalues[GASADId]['startdescription'],GASADvalues[GASADId]['beforeprice'],GASvalues['price'],GASADvalues[GASADId]['afterprice'],GASADvalues[GASADId]['description'],GASADvalues[GASADId]['afterdescription'],GAS[GASADId]['priceaddtype'],GAS['priceRound'],GAS[GASADId]['noPaths'],GAS[GASADId]['headerTo1Line'],GAS[GASADId]['afterdescrNeed'],GAS[GASADId]['requiredescr'],1);

			if (adheaders) {

				ads[GASADId] = {};
				ads[GASADId].Headlines = adheaders.Headlines;
				ads[GASADId].Descriptions = adheaders.Descriptions;
				ads[GASADId].Paths = adheaders.Paths;
				ads[GASADId].Params = adheaders.Params;

				if (ads[GASADId].Params[0]) {
					//если хотя бы одно объявление имеет параметр (цену)
					params = ads[GASADId].Params[0];
				}
				if (ads[GASADId].Params[1]) {
					params2 = ads[GASADId].Params[1];
				}

				checkadsnum++;

				if (!(GAS[GASADId]['FromGAS']['addkeystype']&&GAS[GASADId]['FromGAS']['maxNodigaddkeyNum']&&GAS[GASADId]['FromGAS']['keys']&&GAS[GASADId]['FromGAS']['fixedkeys']&&GAS[GASADId]['FromGAS']['masskeys']&&GAS[GASADId]['FromGAS']['onekeys']&&GAS[GASADId]['FromGAS']['keysmixtype']&&GAS[GASADId]['FromGAS']['masskeysmixtype']&&GAS[GASADId]['FromGAS']['notReqfixedkeys'])) {
					//для КС исключаем повторную обработку (FromGAS)

					if (typeof GASADvalues[GASADId]['keys'] == 'object') {
						for (var iii = 0; iii < GASADvalues[GASADId]['keys'].length; iii++) {
							if (GASADvalues[GASADId]['keys'][iii]) {
								keysnotemptyflg = 1;
								var feedkeys = ItemKeys(GASADvalues[GASADId]['keys'][iii],shortWordsHash,GAS[GASADId]['keysmixtype'],GAS[GASADId]['maxNodigaddkeyNum'],GASADvalues[GASADId]['fixedkeys'],GAS[GASADId]['notReqfixedkeys'],GASADvalues[GASADId]['onekeys']);
								if (feedkeys) {

							        	try {
										addkeystypegen[GAS[GASADId]['addkeystype']](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
									} catch (e) {
										ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch in Ad number " + GASADId + ", check script code\n";
										Logger.log(ScanCreateFeedsGlobalVars.errors);
									}


								}
							}



						}


					} else {
						if (GASADvalues[GASADId]['keys']) {
							keysnotemptyflg = 1;
							var feedkeys = ItemKeys(GASADvalues[GASADId]['keys'],shortWordsHash,GAS[GASADId]['keysmixtype'],GAS[GASADId]['maxNodigaddkeyNum'],GASADvalues[GASADId]['fixedkeys'],GAS[GASADId]['notReqfixedkeys'],GASADvalues[GASADId]['onekeys']);
							if (feedkeys) {

						        	try {
									addkeystypegen[GAS[GASADId]['addkeystype']](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
								} catch (e) {
									ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch in Ad number " + GASADId + ", check script code\n";
									Logger.log(ScanCreateFeedsGlobalVars.errors);
								}


							}
						}


					}
					if (GASADvalues[GASADId]['masskeys']) {
						var masskeys = GASADvalues[GASADId]['masskeys'].trim()
						masskeys = masskeys.split(/[\s\,]*\,[\s\,]*/);
						for (var iii = 0; iii < masskeys.length; iii++) {
							if (masskeys[iii]) {
								keysnotemptyflg = 1;
								var feedkeys = ItemKeys(masskeys[iii],shortWordsHash,GAS[GASADId]['masskeysmixtype'],GAS[GASADId]['maxNodigaddkeyNum'],GASADvalues[GASADId]['fixedkeys'],GAS[GASADId]['notReqfixedkeys'],GASADvalues[GASADId]['onekeys']);
								if (feedkeys) {
							        	try {
										addkeystypegen[GAS[GASADId]['addkeystype']](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
									} catch (e) {
										ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch in Ad number " + GASADId + ", check script code\n";
										Logger.log(ScanCreateFeedsGlobalVars.errors);
									}

								}

							}
						}
					}

				}

			} else {

				if ((!GASADvalues[GASADId]['header'])||(!(GASADvalues[GASADId]['startdescription'] + GASADvalues[GASADId]['description'] + GASADvalues[GASADId]['afterdescription']))) {
					ScanCreateFeedsGlobalVars.errors += "bad parameters, header or etc. in GASearch\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
				} else {
					//если есть заголовки и описание, то это не ошибка, например, очень длинное слово не даст сформировать заголовок
					//просто выходим, но не сейчас, ниже, если нет ни одного объявления
				}
			}

		}


		var keysCOLLECT = [];
		var keysCOLLECT2 = {};
		var keysFULL = [];
		Object.keys(keys['EXACT']).forEach(function(key) { 
			var key2 = '[' + key + ']';
			keysFULL.push(key2);
			keysCOLLECT.push(key);
			keysCOLLECT2[key2] = key;
		});
		Object.keys(keys['PHRASE']).forEach(function(key) { 
			var key2 = '"' + key + '"';
			keysFULL.push(key2);
			keysCOLLECT.push(key);
			keysCOLLECT2[key2] = key;
		});
		Object.keys(keys['BROAD']).forEach(function(key) {
			var key2 = key.replace(/([^\s]+)/g, '+$1');
			keysFULL.push(key2);
			keysCOLLECT.push(key2);
			keysCOLLECT2[key2] = key;
		});


		var dkeysCOLLECT = [];
		var dkeysCOLLECT2 = {};
		var dkeysFULL = [];
		Object.keys(dkeys['EXACT']).forEach(function(key) { 
			var key2 = '[' + key + ']';
			dkeysFULL.push(key2);
			dkeysCOLLECT.push(key);
			dkeysCOLLECT2[key2] = key;
		});
		Object.keys(dkeys['PHRASE']).forEach(function(key) { 
			var key2 = '"' + key + '"';
			dkeysFULL.push(key2);
			dkeysCOLLECT.push(key);
			dkeysCOLLECT2[key2] = key;
		});
		Object.keys(dkeys['BROAD']).forEach(function(key) { 
			var key2 = key.replace(/([^\s]+)/g, '+$1');
			dkeysFULL.push(key2);
			dkeysCOLLECT.push(key2);
			dkeysCOLLECT2[key2] = key;
		});


		var addkeysCOLLECT = [];
		var addkeysCOLLECT2 = {};
		var addkeysFULL = [];
		Object.keys(addkeys['EXACT']).forEach(function(key) { 
			var key2 = '[' + key + ']';
			addkeysFULL.push(key2);
			addkeysCOLLECT.push(key);
			addkeysCOLLECT2[key2] = key;
		});
		Object.keys(addkeys['PHRASE']).forEach(function(key) { 
			var key2 = '"' + key + '"';
			addkeysFULL.push(key2);
			addkeysCOLLECT.push(key);
			addkeysCOLLECT2[key2] = key;
		});
		Object.keys(addkeys['BROAD']).forEach(function(key) { 
			var key2 = key.replace(/([^\s]+)/g, '+$1');
			addkeysFULL.push(key2);
			addkeysCOLLECT.push(key2);
			addkeysCOLLECT2[key2] = key;
		});

		var checkkeysnum = 1;
		if ((!keysCOLLECT.length)&&(!dkeysCOLLECT.length)&&(!addkeysCOLLECT.length)) {
			checkkeysnum = 0;
			//если нет ключей - выходим, но это не ошибка еще (например название товара состоит из одного слова)
			if (!keysnotemptyflg) {
				//если все значения для генерации ключей пустые - это точно ошибка
				ScanCreateFeedsGlobalVars.errors += "bad parameter keys in GASearch\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
			}
			//можно выходить, ниже выходим
		}


		if (ScanCreateFeedsGlobalVars.errors)
			return;


		//выходим, если нельзя создать хотя бы одно объявление или КС (нет данных для них)
		if ((!checkadsnum)||(!checkkeysnum))
			return;









//массив всех КС
			var keywordsToCreate = [];

//формируем добавляемые КС



			for (var ii = 0; ii < keysCOLLECT.length; ii++) {

					if (keysCOLLECT[ii].length > 80) {
						//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
						continue;
					}


					keywordsToCreate.push(keysFULL[ii]);

			}




			if (addkeysCOLLECT.length) {
				//значит это вариант с проверкой на "мало показов" и есть КС с 2-мя словами



//формируем дополнительные добавляемые КС

					for (var ii = 0; ii < addkeysCOLLECT.length; ii++) {


							if (addkeysCOLLECT[ii].length > 80) {
								//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
								continue;
							}


							keywordsToCreate.push(addkeysFULL[ii]);

					}


			}





			if (dkeysCOLLECT.length) {
				//значит это вариант с проверкой на "мало показов" без цифровых ключей (сначала проверяем только 3 КС)


//формируем в конце отдельно цифровые добавляемые КС

				for (var ii = 0; ii < dkeysCOLLECT.length; ii++) {

						if (dkeysCOLLECT[ii].length > 80) {
							//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
							continue;
						}


						keywordsToCreate.push(dkeysFULL[ii]);

				}


			}



			if (!keywordsToCreate.length) {
				return;
			}






       		try {


			if (!SearchFeedsFilesOUT[feed_id]) {
				SearchFeedsFilesOUT[feed_id]=[];
			}

			var OUT_hash = correctfeedsearchExtPositionFunction(GASvalues,GAS['GAShtmlExt'],ads,keywordsToCreate);
//тут массив надо подумать
			if (OUT_hash) {
				SearchFeedsFilesOUT[feed_id][SearchFeedsFilesOUT[feed_id].length] = OUT_hash;
				addtofeed = 1;
			}

		} catch (e) {
			ScanCreateFeedsGlobalVars.errors += "bad field_type: .gas.html in correctfeedsearchExtPositionFunction, check script code\n";
			Logger.log(ScanCreateFeedsGlobalVars.errors);
			return 0;
		}






	}

	return addtofeed;


}


function parvalue(parameterType,parameterName,parameter,checkedfields) {
		//вычисляем типовые значения параметров для поисковых кампаний


		var partype = { 
			'array3': function (parameterName,parameter,checkedfields) {
				var res = '';
				for (var i = 0; i < parameter.length; i++) {
//					if (typeof parameter[i] != 'string') {
//						ScanCreateFeedsGlobalVars.errors += 'bad parameter: ' + parameterName + " in GASearch\nfor url: " + url + "\n";
//						Logger.log(ScanCreateFeedsGlobalVars.errors);
//						return '';
//					}

					if (parameter[i]) {
						if (i == 1) {

//							var recfields = parameter[i].split(/[\s\,]+/);
							var recfields = parameter[i].split(/[\s\,]*\,[\s\,]*/);
							for (var ii = 0; ii < recfields.length; ii++) {

								if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['include_attributes']) {
//нельзя в поисковых параметрах использовать поля в виде вложенных аттрибутов 
									ScanCreateFeedsGlobalVars.errors += 'bad parameter: ' + parameterName + ' in GASearch,' + ' field_name ' + recfields[ii] + ' have "include attributes" type, not use it in GASearch.' + "\n";
									Logger.log(ScanCreateFeedsGlobalVars.errors);
									return '';

								} else if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
									if (res) {
										res += " " + checkedfields[recfields[ii]]['field_value'];
									} else {
										res += checkedfields[recfields[ii]]['field_value'];
									}

								} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует одно из полей в настройках фида
									ScanCreateFeedsGlobalVars.errors += 'bad parameter: ' + parameterName + ' in GASearch,' + ' not exists field_name ' + recfields[ii] + ' in feed fields.' + "\n";
									Logger.log(ScanCreateFeedsGlobalVars.errors);
									return '';
								}
							}

						} else {
							if (res) {
								res += " " + parameter[i];
							} else {
								res += parameter[i];
							}
						}
					}
				
				}

				return res;
			},
			'function': function (parameterName,parameter,checkedfields) {
		        	try {
					var res = parameter(checkedfields);
					if (typeof res != 'string') {
						ScanCreateFeedsGlobalVars.errors += 'bad function result (no string type), parameter: ' + parameterName + " in GASearch\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return '';
					} else if (/\n/.test(res)) {
						//проверяем наличие символа \n - его не должно быть, это признак поля в виде вложенных аттрибутов 
						ScanCreateFeedsGlobalVars.errors += 'bad parameter (function): ' + parameterName + ' in GASearch, some field have "include attributes" type or Newline symbol, not use it in GASearch function.' + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return '';
					}
					res = res.trim()
					return res;

				} catch (e) {
					ScanCreateFeedsGlobalVars.errors += 'bad function, parameter: ' + parameterName + " in GASearch\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return '';
				}
			},
			'': function (parameterName,parameter,checkedfields) {
				return '';
			}
		}

		try {
			return partype[parameterType](parameterName,parameter,checkedfields);
		} catch (e) {
			ScanCreateFeedsGlobalVars.errors += 'bad parameter: ' + parameterName + ', parameterType: ' + parameterType + " in GASearch\n";
			Logger.log(ScanCreateFeedsGlobalVars.errors);
			return '';
		}

}



var keywordtypesgen = {
		0: function(key,keys,phrase) {
			keys['EXACT'][key] = 1;
			keys['BROAD'][key] = 1;
		},
		1: function(key,keys,phrase) {
			keys['EXACT'][key] = 1;
		},
		2: function(key,keys,phrase) {
			keys['BROAD'][key] = 1;
		},
		3: function(key,keys,phrase) {
			keys['EXACT'][key] = 1;
			keys['PHRASE'][key] = 1;
		},
		4: function(key,keys,phrase) {
			keys['PHRASE'][key] = 1;
		},
		5: function(key,keys,phrase) {
			if (phrase) {
				keys['EXACT'][key] = 1;
				keys['PHRASE'][key] = 1;
			} else {
				keys['EXACT'][key] = 1;
				keys['BROAD'][key] = 1;
			}
		},
		6: function(key,keys,phrase) {
			if (phrase) {
				keys['PHRASE'][key] = 1;
			} else {
				keys['BROAD'][key] = 1;
			}
		}
}



var addkeystypegen = {
		0: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[0].length; ii++) {
				//цифровые КС
				keywordtypesgen[keywordtypes](feedkeys[0][ii],dkeys,keywordtypes > 4);
				//dkeys[feedkeys[0][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[1].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[1][ii],keys);
				//keys[feedkeys[1][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[2].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[2][ii],addkeys);
				//addkeys[feedkeys[2][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		1: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[0].length; ii++) {
				//цифровые КС
				keywordtypesgen[keywordtypes](feedkeys[0][ii],keys,keywordtypes > 4);
				//keys[feedkeys[0][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[1].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[1][ii],keys);
				//keys[feedkeys[1][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[2].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[2][ii],addkeys);
				//addkeys[feedkeys[2][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		2: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[1].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[1][ii],keys);
				//keys[feedkeys[1][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[2].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[2][ii],addkeys);
				//addkeys[feedkeys[2][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		3: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[0].length; ii++) {
				//цифровые КС
				keywordtypesgen[keywordtypes](feedkeys[0][ii],keys,keywordtypes > 4);
				//keys[feedkeys[0][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[1].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[1][ii],keys);
				//keys[feedkeys[1][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		4: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[0].length; ii++) {
				//цифровые КС
				keywordtypesgen[keywordtypes](feedkeys[0][ii],keys,keywordtypes > 4);
				//keys[feedkeys[0][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		5: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[1].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[1][ii],keys);
				//keys[feedkeys[1][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		6: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[0].length; ii++) {
				//цифровые КС
				keywordtypesgen[keywordtypes](feedkeys[0][ii],keys,keywordtypes > 4);
				//keys[feedkeys[0][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[1].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[1][ii],keys);
				//keys[feedkeys[1][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[2].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[2][ii],keys);
				//keys[feedkeys[2][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		7: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[1].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[1][ii],keys);
				//keys[feedkeys[1][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[2].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[2][ii],keys);
				//keys[feedkeys[2][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		},
		8: function(feedkeys,keys,dkeys,addkeys,keywordtypes) {
			for (var ii = 0; ii < feedkeys[2].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[2][ii],keys);
				//keys[feedkeys[2][ii]] = 1;
			}
			for (var ii = 0; ii < feedkeys[3].length; ii++) {
				keywordtypesgen[keywordtypes](feedkeys[3][ii],keys);
				//keys[feedkeys[3][ii]] = 1;
			}
		}
}



function CreateSearch(checkedfields,shortWordsHash,OneFeedGASearch,OneFeedConfig,URLID,feed_id,url,CampaignNum) {





	var GAS = OneFeedConfig['GASearch'];

	var resreturn;

	if (GAS&&GAS['Id']) {

		if (GAS.hasOwnProperty('removeOutOfStockItem')) {
			if (!checkedfields.hasOwnProperty(GAS['removeOutOfStockItem'][1])) {
				ScanCreateFeedsGlobalVars.errors += 'bad parameter: removeOutOfStockItem in GASearch, not exists field_name ' + GAS['removeOutOfStockItem'][1] + ' in feed fields.' + "\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
				return;
			}
			if (checkedfields[GAS['removeOutOfStockItem'][1]]['field_value'] == GAS['removeOutOfStockItem'][2]) {
				if (OneFeedGASearch[URLID]) {
					var agID = OneFeedGASearch[URLID][0];
					var AGpaused = OneFeedGASearch[URLID][1];
					//остановить или удалить существующую группу
					if (GAS['removeOutOfStockItem'][0] == 2) {
						removeAdGroupbuffer(agID);
					} else {
						if (GAS['removeOutOfStockItem'][0]) {
							if (!AGpaused)
								pauseAdGroupbuffer(agID)
						} else {
							if (!AGpaused) {
								pauseAdGroupbuffer(agID)
								//изменено (остановленная группа, но она включена в список групп РК фида)
								resreturn = 1
							} else {
								//проверено (остановленная группа, но она включена в список групп РК фида)
								resreturn = 2
							}
						}
					}

					//убираем обработанную группу, что бы в конце остановить/удалить оставшиеся необработанные
					delete OneFeedGASearch[URLID];
				}
				return resreturn;
			}

		}




		//генерируем новые данные и хеши данных

		//генерируем GASvalues - хеш значений типовых переменных GAS РК (GASparams)
		var GASvalues = {};
		for (var ii = 0; ii < GAS.GASparams.length; ii++) {
			var GASparamName = GAS.GASparams[ii][0];
			var GASparamType = GAS.GASparams[ii][1];

			if ((GASparamName == 'keys')&&(typeof GASparamType == 'object')) {
				GASvalues[GASparamName] = [];
				for (var iii = 0; iii < GASparamType.length; iii++) {
					//если есть типовая переменная РК (из списка GAS.GASparams) то вычисляем ее значение (массив)
					GASvalues[GASparamName][iii] = parvalue(GASparamType[iii],GASparamName,GAS[GASparamName][iii],checkedfields);
				}
			} else {
				//если есть типовая переменная РК (из списка GAS.GASparams) то вычисляем ее значение
				GASvalues[GASparamName] = parvalue(GASparamType,GASparamName,GAS[GASparamName],checkedfields);
			}
		}


		//генерируем GASADvalues - хеш значений типовых переменных GAS объявлений (GASADparams)
		var GASADvalues = {};
		for (var ii = 0; ii < GAS['adids'].length; ii++) {
			var GASADId = GAS['adids'][ii];
			GASADvalues[GASADId] = {}
			for (var iii = 0; iii < GAS[GASADId].GASADparams.length; iii++) {
				var GASADparamName = GAS[GASADId].GASADparams[iii][0];
				var GASADparamType = GAS[GASADId].GASADparams[iii][1];

				//если есть типовая переменная объявления (из списка GASADparams) то вычисляем ее значение
				if (GAS[GASADId]['FromGAS'][GASADparamName]) {
					//этот параметр берется из настройки РК, а не Объявления, поэтому сокращаем время выполнения, присваиваем уже вычисленное значение
					GASADvalues[GASADId][GASADparamName] = GASvalues[GASADparamName];
				} else {
					if ((GASADparamName == 'keys')&&(typeof GASADparamType == 'object')) {
						GASADvalues[GASADId][GASADparamName] = [];
						for (var iii = 0; iii < GASADparamType.length; iii++) {
							GASADvalues[GASADId][GASADparamName][iii] = parvalue(GASADparamType[iii],GASADparamName,GAS[GASADId][GASADparamName][iii],checkedfields);
						}
					} else {
						GASADvalues[GASADId][GASADparamName] = parvalue(GASADparamType,GASADparamName,GAS[GASADId][GASADparamName],checkedfields);
					}
				}
			}
		}


		if (ScanCreateFeedsGlobalVars.errors)
			return;




//вычисляем значения для рекламы

		//проверяем, что хотя бы одно значение параметра keys не пустое
		var keysnotemptyflg = 0;


		var keys = {'EXACT': {},'BROAD': {},'PHRASE': {}};
		var dkeys = {'EXACT': {},'BROAD': {},'PHRASE': {}};
		var addkeys = {'EXACT': {},'BROAD': {},'PHRASE': {}};
		var ads = {};
		var params = '';
		var params2 = '';


		if (GASvalues['keys']) {
			if (typeof GASvalues['keys'] == 'object') {
				for (var ii = 0; ii < GASvalues['keys'].length; ii++) {
					if (GASvalues['keys'][ii]) {
						keysnotemptyflg = 1;
						var feedkeys = ItemKeys(GASvalues['keys'][ii],shortWordsHash,GAS.keysmixtype,GAS.maxNodigaddkeyNum,GASvalues['fixedkeys'],GAS.notReqfixedkeys,GASvalues['onekeys']);
						if (feedkeys) {

					        	try {
								addkeystypegen[GAS.addkeystype](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
							} catch (e) {
								ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch, check script code\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
							}

/*
						} else if (feedkeys !== '') {

есть непустое значение GASvalues['keys']
и это не ошибка еще (например название товара состоит из одного слова)

*/

						}
					}

				}
			} else {
				keysnotemptyflg = 1;
				var feedkeys = ItemKeys(GASvalues['keys'],shortWordsHash,GAS.keysmixtype,GAS.maxNodigaddkeyNum,GASvalues['fixedkeys'],GAS.notReqfixedkeys,GASvalues['onekeys']);
				if (feedkeys) {

			        	try {
						addkeystypegen[GAS.addkeystype](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
					} catch (e) {
						ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch, check script code\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
					}

/*

				} else if (feedkeys !== '') {

есть непустое значение GASvalues['keys']
и это не ошибка еще (например название товара состоит из одного слова)

*/

				}
			}
		}
		if (GASvalues['masskeys']) {
			var masskeys = GASvalues['masskeys'].trim()
			masskeys = masskeys.split(/[\s\,]*\,[\s\,]*/);
			for (var iii = 0; iii < masskeys.length; iii++) {
				if (masskeys[iii]) {
					keysnotemptyflg = 1;
					var feedkeys = ItemKeys(masskeys[iii],shortWordsHash,GAS.masskeysmixtype,GAS.maxNodigaddkeyNum,GASvalues['fixedkeys'],GAS.notReqfixedkeys,GASvalues['onekeys']);
					if (feedkeys) {
				        	try {
							addkeystypegen[GAS.addkeystype](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
						} catch (e) {
							ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch, check script code\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
						}

					}

				}
			}
		}


		//хотя бы одно объявление сформировать
		var checkadsnum=0
		for (var ii = 0; ii < GAS['adids'].length; ii++) {
			var GASADId = GAS['adids'][ii];

//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@

//			var adheaders = ItemHeaders(GASADvalues[GASADId]['header'],shortWordsHash,GASADvalues[GASADId]['paths'],GASADvalues[GASADId]['header2'],GAS[GASADId]['keyword'],GASADvalues[GASADId]['startdescription'],GASADvalues[GASADId]['beforeprice'],GASvalues['price'],GASADvalues[GASADId]['afterprice'],GASADvalues[GASADId]['description'],GASADvalues[GASADId]['afterdescription'],GAS[GASADId]['priceaddtype'],GAS['priceRound'],GAS[GASADId]['noPaths'],GAS[GASADId]['headerTo1Line'],GAS[GASADId]['afterdescrNeed'],GAS[GASADId]['requiredescr'],0);
			var adheaders = ItemHeaders(GASADvalues[GASADId]['header'],shortWordsHash,GASADvalues[GASADId]['paths'],GASADvalues[GASADId]['header2'],GAS['header3'],GAS[GASADId]['keyword'],GASADvalues[GASADId]['startdescription'],GASADvalues[GASADId]['beforeprice'],GASvalues['price'],GASADvalues[GASADId]['afterprice'],GASADvalues[GASADId]['description'],GASADvalues[GASADId]['afterdescription'],GAS[GASADId]['priceaddtype'],GAS['priceRound'],GAS[GASADId]['noPaths'],GAS[GASADId]['headerTo1Line'],GAS[GASADId]['afterdescrNeed'],GAS[GASADId]['requiredescr'],0);

			if (adheaders) {

				ads[GASADId] = {};
				ads[GASADId].Headlines = adheaders.Headlines;
				ads[GASADId].Descriptions = adheaders.Descriptions;
				ads[GASADId].Paths = adheaders.Paths;
				ads[GASADId].Params = adheaders.Params;

				if (ads[GASADId].Params[0]) {
					//если хотя бы одно объявление имеет параметр (цену)
					params = ads[GASADId].Params[0];
				}
				if (ads[GASADId].Params[1]) {
					params2 = ads[GASADId].Params[1];
				}

				checkadsnum++;

				if (!(GAS[GASADId]['FromGAS']['addkeystype']&&GAS[GASADId]['FromGAS']['maxNodigaddkeyNum']&&GAS[GASADId]['FromGAS']['keys']&&GAS[GASADId]['FromGAS']['fixedkeys']&&GAS[GASADId]['FromGAS']['masskeys']&&GAS[GASADId]['FromGAS']['onekeys']&&GAS[GASADId]['FromGAS']['keysmixtype']&&GAS[GASADId]['FromGAS']['masskeysmixtype']&&GAS[GASADId]['FromGAS']['notReqfixedkeys'])) {
					//для КС исключаем повторную обработку (FromGAS)

					if (typeof GASADvalues[GASADId]['keys'] == 'object') {
						for (var iii = 0; iii < GASADvalues[GASADId]['keys'].length; iii++) {
							if (GASADvalues[GASADId]['keys'][iii]) {
								keysnotemptyflg = 1;
								var feedkeys = ItemKeys(GASADvalues[GASADId]['keys'][iii],shortWordsHash,GAS[GASADId]['keysmixtype'],GAS[GASADId]['maxNodigaddkeyNum'],GASADvalues[GASADId]['fixedkeys'],GAS[GASADId]['notReqfixedkeys'],GASADvalues[GASADId]['onekeys']);
								if (feedkeys) {

							        	try {
										addkeystypegen[GAS[GASADId]['addkeystype']](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
									} catch (e) {
										ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch in Ad number " + GASADId + ", check script code\n";
										Logger.log(ScanCreateFeedsGlobalVars.errors);
									}


								}
							}

						}


					} else {
						if (GASADvalues[GASADId]['keys']) {
							keysnotemptyflg = 1;

							var feedkeys = ItemKeys(GASADvalues[GASADId]['keys'],shortWordsHash,GAS[GASADId]['keysmixtype'],GAS[GASADId]['maxNodigaddkeyNum'],GASADvalues[GASADId]['fixedkeys'],GAS[GASADId]['notReqfixedkeys'],GASADvalues[GASADId]['onekeys']);
							if (feedkeys) {

						        	try {
									addkeystypegen[GAS[GASADId]['addkeystype']](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
								} catch (e) {
									ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch in Ad number " + GASADId + ", check script code\n";
									Logger.log(ScanCreateFeedsGlobalVars.errors);
								}


							}
						}


					}
					if (GASADvalues[GASADId]['masskeys']) {
						var masskeys = GASADvalues[GASADId]['masskeys'].trim()
						masskeys = masskeys.split(/[\s\,]*\,[\s\,]*/);
						for (var iii = 0; iii < masskeys.length; iii++) {
							if (masskeys[iii]) {
								keysnotemptyflg = 1;
								var feedkeys = ItemKeys(masskeys[iii],shortWordsHash,GAS[GASADId]['masskeysmixtype'],GAS[GASADId]['maxNodigaddkeyNum'],GASADvalues[GASADId]['fixedkeys'],GAS[GASADId]['notReqfixedkeys'],GASADvalues[GASADId]['onekeys']);
								if (feedkeys) {
							        	try {
										addkeystypegen[GAS[GASADId]['addkeystype']](feedkeys,keys,dkeys,addkeys,GAS.keywordtypes);
									} catch (e) {
										ScanCreateFeedsGlobalVars.errors += "bad parameter addkeystype in GASearch in Ad number " + GASADId + ", check script code\n";
										Logger.log(ScanCreateFeedsGlobalVars.errors);
									}

								}

							}
						}
					}


				}

			} else {

				if ((!GASADvalues[GASADId]['header'])||(!(GASADvalues[GASADId]['startdescription'] + GASADvalues[GASADId]['description'] + GASADvalues[GASADId]['afterdescription']))) {
					ScanCreateFeedsGlobalVars.errors += "bad parameters, header or etc. in GASearch\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
				} else {
					//если есть заголовки и описание, то это не ошибка, например, очень длинное слово не даст сформировать заголовок
					//просто выходим, но не сейчас, ниже, если нет ни одного объявления
				}
			}

		}


		var keysCOLLECT = [];
		var keysCOLLECT2 = {};
		var keysFULL = [];
		Object.keys(keys['EXACT']).forEach(function(key) { 
			var key2 = '[' + key + ']';
			keysFULL.push(key2);
			keysCOLLECT.push(key);
			keysCOLLECT2[key2] = key;
		});
		Object.keys(keys['PHRASE']).forEach(function(key) { 
			var key2 = '"' + key + '"';
			keysFULL.push(key2);
			keysCOLLECT.push(key);
			keysCOLLECT2[key2] = key;
		});
		Object.keys(keys['BROAD']).forEach(function(key) { 
			var key2 = key.replace(/([^\s]+)/g, '+$1');
			keysFULL.push(key2);
			keysCOLLECT.push(key2);
			keysCOLLECT2[key2] = key;
		});


		var dkeysCOLLECT = [];
		var dkeysCOLLECT2 = {};
		var dkeysFULL = [];
		Object.keys(dkeys['EXACT']).forEach(function(key) { 
			var key2 = '[' + key + ']';
			dkeysFULL.push(key2);
			dkeysCOLLECT.push(key);
			dkeysCOLLECT2[key2] = key;
		});
		Object.keys(dkeys['PHRASE']).forEach(function(key) { 
			var key2 = '"' + key + '"';
			dkeysFULL.push(key2);
			dkeysCOLLECT.push(key);
			dkeysCOLLECT2[key2] = key;
		});
		Object.keys(dkeys['BROAD']).forEach(function(key) { 
			var key2 = key.replace(/([^\s]+)/g, '+$1');
			dkeysFULL.push(key2);
			dkeysCOLLECT.push(key2);
			dkeysCOLLECT2[key2] = key;
		});


		var addkeysCOLLECT = [];
		var addkeysCOLLECT2 = {};
		var addkeysFULL = [];
		Object.keys(addkeys['EXACT']).forEach(function(key) { 
			var key2 = '[' + key + ']';
			addkeysFULL.push(key2);
			addkeysCOLLECT.push(key);
			addkeysCOLLECT2[key2] = key;
		});
		Object.keys(addkeys['PHRASE']).forEach(function(key) { 
			var key2 = '"' + key + '"';
			addkeysFULL.push(key2);
			addkeysCOLLECT.push(key);
			addkeysCOLLECT2[key2] = key;
		});
		Object.keys(addkeys['BROAD']).forEach(function(key) { 
			var key2 = key.replace(/([^\s]+)/g, '+$1');
			addkeysFULL.push(key2);
			addkeysCOLLECT.push(key2);
			addkeysCOLLECT2[key2] = key;
		});

		var checkkeysnum = 1;
		if ((!keysCOLLECT.length)&&(!dkeysCOLLECT.length)&&(!addkeysCOLLECT.length)) {
			checkkeysnum = 0;
			//если нет ключей - выходим, но это не ошибка еще (например название товара состоит из одного слова)
			if (!keysnotemptyflg) {
				//если все значения для генерации ключей пустые - это точно ошибка
				ScanCreateFeedsGlobalVars.errors += "bad parameter keys in GASearch\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
			}
			//можно выходить, ниже выходим
		}


		if (ScanCreateFeedsGlobalVars.errors)
			return;


		//выходим, если нельзя создать хотя бы одно объявление или КС (нет данных для них)
		if ((!checkadsnum)||(!checkkeysnum))
			return;


		//формируем "слепки" для цифровой подписи (4 шт.)


		//var keysign = GAS.addkeystype + "\n" + GAS.removeLSVKeywords + "\n" + GAS.maxNodigaddkeyNum + "\n" + keysFULL.join("\n") + "\n" + dkeysFULL.join("\n") + "\n" + addkeysFULL.join("\n") + "\n";
		var keysign = keysFULL.join("\n") + "\n" + dkeysFULL.join("\n") + "\n" + addkeysFULL.join("\n") + "\n";
		var adsign = GASvalues['url'] + "\n" + GASvalues['mobileurl'] + "\n";
		for (var GASADId in ads) {
		//for (var ii = 0; ii < GAS['adids'].length; ii++) {
		//	var GASADId = GAS['adids'][ii];
		//	if (ads[GASADId]) {
				var tmpadsign = ads[GASADId].Headlines.join("\n");
				tmpadsign += ads[GASADId].Descriptions.join("\n");
				tmpadsign += ads[GASADId].Paths.join("\n");

				//убираем содержимое параметра из объявления
				//tmpadsign = tmpadsign.replace(/(\{param\d+\:)[^\}\{]*(\})/gm, '$1$2')
				tmpadsign = tmpadsign.replace(/(\{param(?:1|2)\:)[^\}\{]*(\})/gm, '$1$2')

				adsign += tmpadsign;
		//	}
		}

		var paramsign = params + "\n" + params2;


		var keysign = murmurhash3_32_gc(keysign);
		var adsign = murmurhash3_32_gc(adsign);
		var paramslen = params.length;
		var params2len = params2.length;
		var paramsign = murmurhash3_32_gc(paramsign);

		var NEWaddkeystype = GAS.addkeystype;

		var NEWmodifykeystype = GAS.modifykeystype;
		var NEWmodifykeysEnable = GAS.modifykeysEnable;
		var NEWremoveLSVKeywords = GAS.removeLSVKeywords;
		var NEWmaxNodigaddkeyNum = GAS.maxNodigaddkeyNum;


		//сколько параметров (0, 1 или 2)
		var paramsnum = 0;
		if (paramslen)
			paramsnum++;
		if (params2len)
			paramsnum++;


		var newgroup=0;

		if (OneFeedGASearch[URLID]) {
			//группа уже есть в поиске
			//сравниваем новые данные с текущими, добавляем что не совпадает

			//в названии группы зарезервировано место под второй параметр

			var agID = OneFeedGASearch[URLID][0];
			var AGpaused = OneFeedGASearch[URLID][1];
			var ADS = OneFeedGASearch[URLID][2];
			var MXLNPR = Number(OneFeedGASearch[URLID][3]);
			var MXLNPR2 = Number(OneFeedGASearch[URLID][4]);
			var PARAMS = OneFeedGASearch[URLID][5];
			var KEYS = OneFeedGASearch[URLID][6];

			var PARmaxNodigaddkeyNum = Number(OneFeedGASearch[URLID][7]);
			var PARaddkeystype = Number(OneFeedGASearch[URLID][8]);
			var PARremoveLSVKeywords = Number(OneFeedGASearch[URLID][9]);
			var PARmodifykeystype = Number(OneFeedGASearch[URLID][10]);
			var PARmodifykeysEnable = Number(OneFeedGASearch[URLID][11]);

			var POLICY = Number(OneFeedGASearch[URLID][12]);


			var newads=0;
			var newkeys=0;
			var newparams=0;

			if ((ADS != adsign)||(MXLNPR < paramslen)||(MXLNPR2 < params2len)) {
				//обновляем объявления (удаляем объявления и создаем заново)
				newads=1;
			}
			if ((KEYS != keysign)||(PARaddkeystype != GAS.addkeystype)||(PARmodifykeystype != GAS.modifykeystype)||(PARmodifykeysEnable != GAS.modifykeysEnable)||(PARremoveLSVKeywords != GAS.removeLSVKeywords)||(PARmaxNodigaddkeyNum != GAS.maxNodigaddkeyNum)) {
				//обновляем ключевые слова (удаляем группу и создаем заново, либо удаляем/останавливаем/добавляем КС согласно modifykeystype и modifykeysEnable)
				newkeys=1;
			}
			if ((MXLNPR >= paramslen)&&(MXLNPR2 >= params2len)&&(PARAMS != paramsign)) {
				//обновляем параметры КС (без объявлений)
				newparams=1;
			}
			

			if (newads||newkeys||newparams) {

				//изменено, в т.ч. полный снос старой группы и замена на новую
				resreturn = 1

				if (ScanCreateFeedsGlobalVars.GASearchHASH[feed_id][URLID]) {
					var ag = ScanCreateFeedsGlobalVars.GASearchHASH[feed_id][URLID];
				} else {

					//здесь очень важно .withCondition('CampaignStatus != REMOVED') иначе, если есть массив и в нем группы удаленной кампании, то будет проблема
					var agIter = AdWordsApp.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').withIds([agID]).get();
					if (agIter.hasNext()) {
						var ag = agIter.next();
					} else {
						var ag = null;
						newgroup=1;

						//тут всегда сначала пробуем создавать
						POLICY = 0;

					}

				}

				
				if (ag) {


					var setnewparams = 0;
					var setnewname = 0;

					//теперь оба параметра всегда работают в паре (addnewkeys и stopoldkeys)
					var addnewkeys = 0;
					var stopoldkeys = 0;

					if (newkeys&&GAS.modifykeystype) {

						//не удаляем группу, обновляем название группы
						setnewname = 1;
						newkeys = 0;

						//добавление новых КС
						addnewkeys = 1;

						//останавливаем все КС, которые не содержат новых КС
						stopoldkeys = 1;


					}



					if (newkeys) {

						removeAdGroupbuffer(agID);
						newgroup=1;

						//тут всегда сначала пробуем создавать
						POLICY = 0;


//нужно будет удалить все метки Урагана для этой группы, что бы не оставлять мусор или случайные срабатывания этих меток
//!!!!!!!!!!!!!!!!!!!!!!!!!!!


					} else if (newads) {


						setnewname = 1;


						//тут всегда сначала пробуем создавать
						POLICY = 0;


//REMOVED выдает ошибку
//						var adIterator = ag.ads().withCondition('Status != REMOVED').get();
  						var adIterator = ag.ads().withCondition('Status IN ["PAUSED","ENABLED"]').get();
						while (adIterator.hasNext()) {
							var ad = adIterator.next();
							ad.remove();
							ad.remove();
						}


						var operations = [];

						for (var GASADId in ads) {
						//for (var ii = 0; ii < GAS['adids'].length; ii++) {
						//	var GASADId = GAS['adids'][ii];
						//	if (ads[GASADId]) {


//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@


								var adOperation = ag.newAd().responsiveSearchAdBuilder()
									.withFinalUrl(GASvalues['url']);

								if (GASvalues['mobileurl'])
									adOperation = adOperation.withMobileFinalUrl(GASvalues['mobileurl']);

								adOperation = adOperation.addHeadline(ads[GASADId].Headlines[0], "HEADLINE_1");
								adOperation = adOperation.addHeadline(ads[GASADId].Headlines[1], "HEADLINE_2");
								adOperation = adOperation.addHeadline(ads[GASADId].Headlines[2], "HEADLINE_3");


								adOperation = adOperation.addDescription(ads[GASADId].Descriptions[0], "DESCRIPTION_1");
								adOperation = adOperation.addDescription(ads[GASADId].Descriptions[1], "DESCRIPTION_2");


								if (ads[GASADId].Paths[0])
									adOperation = adOperation.withPath1(ads[GASADId].Paths[0]);

								if (ads[GASADId].Paths[1])
									adOperation = adOperation.withPath2(ads[GASADId].Paths[1]);


						        	try {

									adOperation = adOperation.build();

									operations.push(adOperation);


								} catch (e) {
									ScanCreateFeedsGlobalVars.errors += 'Errors build Ad in AdGroup ID ' + agID + ": " + e.message + "\n"
									Logger.log(ScanCreateFeedsGlobalVars.errors);
								}




						//	}
						}


						var checkadsnum=0
						var checkpolicyerrornum=0
						for (var i = 0; i < operations.length; i++) {
							if (operations[i].isSuccessful()) {
								var newAd = operations[i].getResult();
								checkadsnum++
							} else {


								var err = operations[i].getErrors();

								//POLICY_ERROR : AdPolicyError.POLICY_ERROR : ad.description,POLICY_ERROR : AdPolicyError.POLICY_ERROR : ad.description

								if (/POLICY\_ERROR/.test(err)) {
									checkpolicyerrornum++
								}


//нельзя выходить при таких ошибках, это не ошибки для нас!
//								ScanCreateFeedsGlobalVars.errors += 'Errors create Ad in AdGroup ID ' + agID + ": " + err + "\n"
//								Logger.log(ScanCreateFeedsGlobalVars.errors);
								Logger.log('Errors create Ad in AdGroup ID ' + agID + ": " + err + "\nfor url: " + url + "\n");




							}
						}

						if (!checkadsnum) {
//какие-то правила не позволили создать объявление хотя бы одно
//выходим сразу и удаляем пустую группу (если не было везде ошибки POLICY_ERROR)
							if (checkpolicyerrornum&&(checkpolicyerrornum == operations.length))
								POLICY = 1;

							if (!POLICY) {
								//что-то не заладилось, сначала останавливаем, потом удалим
								ag.pause();
								removeAdGroupbuffer(agID);
								return;
							}
						}


						if (POLICY) {
							setnewparams = 0;
						} else if (newparams) {
							setnewparams = 1;
						}



					} else if (newparams) {
						setnewname = 1;
						setnewparams = 1;

						if (POLICY) {
							//была ошибка во всех объявлениях POLICY_ERROR Нарушены редакционные правила.
							//группа пустая, только название есть, но она нужна что бы опять не создавать такое же объявление на следующем проходе с той же ошибкой
							//изменяем название и выходим, проверяем, что группа остановлена

							setnewparams = 0;
						}


					}



					if (addnewkeys&&(!POLICY)) {

						//добавляем КС

						//хеш уже добавленных КС
						var fullkeywords = {};
						//хеш уже добавленных КС и их производных КС (это КС, для которых добавленное слово являлось первоисточником (самым первым источником) для добавления этой производной в оптимизаторе)
						var fullkeywordsHash = {};
						//создаем хеш существующих КС
						var keywordIterator = ag.keywords().withCondition('Status != REMOVED').get();
						while (keywordIterator.hasNext()) {
							var keyword = keywordIterator.next();
							var keywordId = keyword.getId();
							var CustomParameters = keyword.urls().getCustomParameters();
							var keytextFull = keyword.getText();
							var keytextDW = clearKeyWord(keytextFull);
							if (keytextDW) {
								keytextFull = keytextDW[0];
								fullkeywords[keytextFull] = keywordId;
								if (stopoldkeys) {
									//первый элемент - массив слов входящих в КС или массив слов входящих в КС-источник
									//третий элемент - оставлять ли активным слово или останавливать
									if (CustomParameters&&CustomParameters['sskeywrd1']) {
										//берем слово-источник для анализа, а не производную
										var keytextFull2 = CustomParameters['sskeywrd1'];
										//пробелы в параметрах не могут быть, поэтому было заменено на *, возвращаем пробел
										keytextFull2 = keytextFull2.replace(/\*/g, ' ');
										var keytextDW2 = clearKeyWord(keytextFull2);
										if (keytextDW2) {
											keytextDW = keytextDW2;
											keytextFull = keytextDW[0];
										}
									}
									//keytextFull - это КС-источник, либо если не смогли прочитать параметр sskeywrd1 - текущее КС
									if (!fullkeywordsHash[keytextFull]) {
										fullkeywordsHash[keytextFull] = [keytextDW[1].split(/\s+/), [], 0];
									}
									fullkeywordsHash[keytextFull][1].push(keyword);
								}

							}
						}


						//теперь добавляем слова, проверяя наличие уже существующих (иначе обнулится статистика КС, если добавить поверх существующих)








//взят кусок ниже и доработан сильно



//массив всех КС
			var allkeywords = [];

//формируем добавляемые КС


			var operations = [];
			var keywordsToCreate = [];
			var keywordsWithoutType = [];

			//только ключи, которые должны быть добавлены (сейчас или раньше)
			var keywordIds = [];
			//все ключи, в т.ч. производные (или просто включающие все добавленные ключи) от тех которые должны быть добавлены (что бы останавливать/удалять их тоже по removeLSVKeywords)
			var ALLkeywordIds = {};


			for (var ii = 0; ii < keysCOLLECT.length; ii++) {


					if (stopoldkeys) {
						var rowkey = keysCOLLECT2[keysFULL[ii]].split(/\s+/);
						//проверяем наличие keysCOLLECT2[keysFULL[ii]] в существующих КС (без учета соответствия и порядка следования слов)
						for (var ckey in fullkeywordsHash) {
							var resSravn = differ(fullkeywordsHash[ckey][0], rowkey);
							if (resSravn) {
								//не null и не false
								//одинаковые слова или новое слово входит в существующее КС (без учета соответствия и порядка следования слов)
								//существующее слово потом проверить, оно должно быть активным
								fullkeywordsHash[ckey][2] = 1;
								for (var i = 0; i < fullkeywordsHash[ckey][1].length; i++) {
									ALLkeywordIds[fullkeywordsHash[ckey][1][i].getId()] = 1;
								}
							}
						}

					}



					//проверка, что такое слово уже есть
					if (fullkeywords.hasOwnProperty(keysFULL[ii])) {
						keywordIds.push([agID,fullkeywords[keysFULL[ii]]]);
						ALLkeywordIds[fullkeywords[keysFULL[ii]]] = 1;
						continue;
					}


					if (keysCOLLECT[ii].length > 80) {
						//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
						continue;
					}


					var keywordOperation = ag.newKeywordBuilder()
						.withText(keysFULL[ii]);


					keywordOperation = keywordOperation.build();

					operations.push(keywordOperation);
					keywordsToCreate.push(keysFULL[ii]);
					keywordsWithoutType.push(keysCOLLECT[ii]);

			}


			var errkeysnums = []


//добавляем КС
			for (var i = 0; i < operations.length; i++) {
				if (operations[i].isSuccessful()) {
					var newKeyword = operations[i].getResult();
					allkeywords[allkeywords.length] = newKeyword;
					keywordIds.push([agID,newKeyword.getId()]);
					ALLkeywordIds[newKeyword.getId()] = 1;


				} else {

					var err = operations[i].getErrors();

					//[садовая пластмассовой]: CONCURRENT_MODIFICATION : DatabaseError.CONCURRENT_MODIFICATION : 

					if (/CONCURRENT_MODIFICATION/.test(err)) {
						//иногда возникает ошибка при добавлении слов
						errkeysnums.push(i);
					}


//нельзя выходить при таких ошибках, это не ошибки для нас!
//					ScanCreateFeedsGlobalVars.errors += 'Errors from Keyword ' + keywordsToCreate[i] + ": " + operations[i].getErrors() + "\n"
//					Logger.log(ScanCreateFeedsGlobalVars.errors);
					Logger.log('Errors from Keyword ' + keywordsToCreate[i] + ": " + operations[i].getErrors() + "\nfor url: " + url + "\n");
				}
			}



			if (errkeysnums.length) {
				//иногда возникает ошибка при повторном добавлении слов

				Utilities.sleep(1000);

				var operations2 = [];
				var keywordsToCreate2 = [];

				for (var i = 0; i < errkeysnums.length; i++) {
					if (keywordsWithoutType[i].length > 80) {
						//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
						continue;
					}

        
					var keywordOperation = ag.newKeywordBuilder()
						.withText(keywordsToCreate[i]);
					


					keywordOperation = keywordOperation.build();

					operations2.push(keywordOperation);
					keywordsToCreate2.push(keywordsToCreate[i]);
				}


				for (var i = 0; i < operations2.length; i++) {
					if (operations2[i].isSuccessful()) {
						var newKeyword = operations2[i].getResult();
						allkeywords[allkeywords.length] = newKeyword;
						keywordIds.push([agID,newKeyword.getId()]);
						ALLkeywordIds[newKeyword.getId()] = 1;
					} else {
//нельзя выходить при таких ошибках, это не ошибки для нас!
//						ScanCreateFeedsGlobalVars.errors += 'Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\n"
//						Logger.log(ScanCreateFeedsGlobalVars.errors);
						Logger.log('Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\nfor url: " + url + "\n");
					}
				}


			}



			var operations = [];
			var keywordsToCreate = [];
			var keywordsWithoutType = [];


			if (addkeysCOLLECT.length) {
				//значит это вариант с проверкой на "мало показов" и есть КС с 2-мя словами

				//есть ли слова без статуса "мало показов"
				var workkeywordsnum = ag.keywords()
					.withCondition("SystemServingStatus != 'RARELY_SERVED'")
					.withIds(keywordIds)
					.get().totalNumEntities();

				if (!workkeywordsnum) {
					//все слова имеют статус "мало показов"
					//либо вообще нет массива слов keysCOLLECT (например, название из двух слов)
					//добавляем addkeysCOLLECT


//формируем дополнительные добавляемые КС

					for (var ii = 0; ii < addkeysCOLLECT.length; ii++) {

						if (stopoldkeys) {
							var rowkey = addkeysCOLLECT2[addkeysFULL[ii]].split(/\s+/);
							//проверяем наличие addkeysCOLLECT2[addkeysFULL[ii]] в существующих КС (без учета соответствия и порядка следования слов)
							for (var ckey in fullkeywordsHash) {
								var resSravn = differ(fullkeywordsHash[ckey][0], rowkey);
								if (resSravn) {
									//не null и не false
									//одинаковые слова или новое слово входит в существующее КС (без учета соответствия и порядка следования слов)
									//существующее слово потом проверить, оно должно быть активным
									fullkeywordsHash[ckey][2] = 1;
									for (var i = 0; i < fullkeywordsHash[ckey][1].length; i++) {
										ALLkeywordIds[fullkeywordsHash[ckey][1][i].getId()] = 1;
									}
								}
							}
		
						}

						//проверка, что такое слово уже есть
						if (fullkeywords.hasOwnProperty(addkeysFULL[ii])) {
							keywordIds.push([agID,fullkeywords[addkeysFULL[ii]]]);
							ALLkeywordIds[fullkeywords[addkeysFULL[ii]]] = 1;
							continue;
						}


						if (addkeysCOLLECT[ii].length > 80) {
							//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
							continue;
						}


						var keywordOperation = ag.newKeywordBuilder()
							.withText(addkeysFULL[ii]);
					
						keywordOperation = keywordOperation.build();

						operations.push(keywordOperation);
						keywordsToCreate.push(addkeysFULL[ii]);
						keywordsWithoutType.push(addkeysCOLLECT[ii]);

					}



				}

			}





			if (dkeysCOLLECT.length) {
				//значит это вариант с проверкой на "мало показов" без цифровых ключей (сначала проверяем только 3 КС)


//формируем в конце отдельно цифровые добавляемые КС

				for (var ii = 0; ii < dkeysCOLLECT.length; ii++) {


						if (stopoldkeys) {
							var rowkey = dkeysCOLLECT2[dkeysFULL[ii]].split(/\s+/);
							//проверяем наличие dkeysCOLLECT2[dkeysFULL[ii]] в существующих КС (без учета соответствия и порядка следования слов)
							for (var ckey in fullkeywordsHash) {
								var resSravn = differ(fullkeywordsHash[ckey][0], rowkey);
								if (resSravn) {
									//не null и не false
									//одинаковые слова или новое слово входит в существующее КС (без учета соответствия и порядка следования слов)
									//существующее слово потом проверить, оно должно быть активным
									fullkeywordsHash[ckey][2] = 1;
									for (var i = 0; i < fullkeywordsHash[ckey][1].length; i++) {
										ALLkeywordIds[fullkeywordsHash[ckey][1][i].getId()] = 1;
									}
								}
							}
		
						}

						//проверка, что такое слово уже есть
						if (fullkeywords.hasOwnProperty(dkeysFULL[ii])) {
							keywordIds.push([agID,fullkeywords[dkeysFULL[ii]]]);
							ALLkeywordIds[fullkeywords[dkeysFULL[ii]]] = 1;
							continue;
						}



						if (dkeysCOLLECT[ii].length > 80) {
							//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
							continue;
						}

        
						var keywordOperation = ag.newKeywordBuilder()
							.withText(dkeysFULL[ii]);
					


						keywordOperation = keywordOperation.build();

						operations.push(keywordOperation);
						keywordsToCreate.push(dkeysFULL[ii]);
						keywordsWithoutType.push(dkeysCOLLECT[ii]);

				}


			}


			var errkeysnums = []

//добавляем дополнительные КС
			for (var i = 0; i < operations.length; i++) {
				if (operations[i].isSuccessful()) {
					var newKeyword = operations[i].getResult();
					allkeywords[allkeywords.length] = newKeyword;
					keywordIds.push([agID,newKeyword.getId()]);
					ALLkeywordIds[newKeyword.getId()] = 1;

				} else {

					var err = operations[i].getErrors();

					//[садовая пластмассовой]: CONCURRENT_MODIFICATION : DatabaseError.CONCURRENT_MODIFICATION : 

					if (/CONCURRENT_MODIFICATION/.test(err)) {
						//иногда возникает ошибка при добавлении слов
						errkeysnums.push(i);
					}


//нельзя выходить при таких ошибках, это не ошибки для нас!
//					ScanCreateFeedsGlobalVars.errors += 'Errors from Add Keyword ' + keywordsToCreate[i] + ": " + operations[i].getErrors() + "\n"
//					Logger.log(ScanCreateFeedsGlobalVars.errors);
					Logger.log('Errors from Add Keyword ' + keywordsToCreate[i] + ": " + err + "\nfor url: " + url + "\n");
				}
			}


			if (errkeysnums.length) {
				//иногда возникает ошибка при повторном добавлении слов

				Utilities.sleep(1000);

				var operations2 = [];
				var keywordsToCreate2 = [];

				for (var i = 0; i < errkeysnums.length; i++) {
					if (keywordsWithoutType[i].length > 80) {
						//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
						continue;
					}

        
					var keywordOperation = ag.newKeywordBuilder()
						.withText(keywordsToCreate[i]);
					


					keywordOperation = keywordOperation.build();

					operations2.push(keywordOperation);
					keywordsToCreate2.push(keywordsToCreate[i]);
				}


				for (var i = 0; i < operations2.length; i++) {
					if (operations2[i].isSuccessful()) {
						var newKeyword = operations2[i].getResult();
						allkeywords[allkeywords.length] = newKeyword;
						keywordIds.push([agID,newKeyword.getId()]);
						ALLkeywordIds[newKeyword.getId()] = 1;
					} else {
//нельзя выходить при таких ошибках, это не ошибки для нас!
//						ScanCreateFeedsGlobalVars.errors += 'Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\n"
//						Logger.log(ScanCreateFeedsGlobalVars.errors);
						Logger.log('Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\nfor url: " + url + "\n");
					}
				}


			}


			if (allkeywords.length&&(!newads)&&(!POLICY)) {
				//если не создавали новые объявления, то нужно параметры записать для новых слов (но мы запишем для всех, что бы не заморачиваться)
				//если же сейчас создавали новые объявления, то параметры записывать в новых КС не нужно, новые параметры есть в объявлениях, а старые КС уже имеют эти параметры, либо если не имеют, то параметры берутся из объявлений так как значит цены еще не менялись
				setnewparams = 1;
			}



			if (GAS['removeLSVKeywords']&&keywordIds.length) {


				if (stopoldkeys&&(PARmaxNodigaddkeyNum > GAS.maxNodigaddkeyNum)) {
					//если уменьшается maxNodigaddkeyNum, то нужно остановить/удалить все КС со статустом "мало показов", которые содержат добавляемые КС
						//то есть, старые длинные КС со статусом "мало показов" иначе будут восстановлены ниже в modifykeysEnable
					var keywordIds2 = [];
					for (var kId in ALLkeywordIds) {
						keywordIds2.push([agID,kId]);
					}
				} else {
					var keywordIds2 = keywordIds;
				}


				if (GAS['removeLSVKeywords'] == 1) {


					//удаляем все слова со статусом "мало показов"

					var lswkeywordsIterator = ag.keywords()
						.withCondition("SystemServingStatus = 'RARELY_SERVED'")
						.withCondition('Status != REMOVED')
						.withIds(keywordIds2)
						.get();

/*
потом опять появится, низзя туда-сюда
					if (lswkeywordsIterator.totalNumEntities() == allkeywords.length) {
						//все слова будут удалены, поэтому удаляем группу
						ag.pause();
						removeAdGroupbuffer(agID);
						return;
					}

*/



					var list = [];
					//на всякий случай проверяем Id ключа, что бы не повторить его в list
					var fids= {};
					while (lswkeywordsIterator.hasNext()) {
						var keyword = lswkeywordsIterator.next();

						//находим это КС или его производную, что бы остановить/удалить по параметру removeLSVKeywords

						var CustomParameters = keyword.urls().getCustomParameters();
						if (CustomParameters&&CustomParameters['sskeywrd1']) {
							//если слово сгенерировано другим словом в оптимизаторе, то пропускаем (ниже удалим если остановим/удалим если нужно)
							continue;
						}
						var keytextFull = keyword.getText();
						var keytextDW = clearKeyWord(keytextFull);
						if (keytextDW) {
							keytextFull = keytextDW[0];
							if (fullkeywords[keytextFull])
								delete fullkeywords[keytextFull];
							if (stopoldkeys) {
								if (fullkeywordsHash[keytextFull]) {
									//удаляем/останавливаем все сгенерированные им слова и его самого, хотя нужно ли всегда? - если есть сгенерированные слова то это все конверсионные слова
									//проверяем наличие fullkeywordsHash[keytextFull], так как его могли уже удалить на проверке предыдущего КС
									for (var i = 0; i < fullkeywordsHash[keytextFull][1].length; i++) {
										var tmpId = fullkeywordsHash[keytextFull][1][i].getId()+'='+fullkeywordsHash[keytextFull][1][i].getAdGroup().getId();
										if (!fids[tmpId]) {
//											removeKeywordbuffer(fullkeywordsHash[keytextFull][1][i].getId(),fullkeywordsHash[keytextFull][1][i].getAdGroup().getId())
											list.push(fullkeywordsHash[keytextFull][1][i]);
											fids[tmpId]=1;
										}
									}
									delete fullkeywordsHash[keytextFull];
								}
							}
						} else {
							//"неправильные слова" не трогаем, на всякий случай (хотя можно тоже удалять/останавливать)
							//хотя сюда заходить не должно вообще, так как мы генерируем только "правильные" слова
							continue;
						}
						var tmpId = keyword.getId()+'='+keyword.getAdGroup().getId();
						if (!fids[tmpId]) {
//							removeKeywordbuffer(keyword.getId(),keyword.getAdGroup().getId())
							list.push(keyword);
							fids[tmpId] = 1;
						}
					}
//переделано по совету гугла https://developers.google.com/google-ads/scripts/docs/best-practices
					for (var i = 0; i < list.length; i++) {
						list[i].remove();
						list[i].remove();
					}



				} else {
					//приостанавливаем все слова со статусом "мало показов"

					var lswkeywordsIterator = ag.keywords()
						.withCondition("SystemServingStatus = 'RARELY_SERVED'")
						.withCondition('Status != REMOVED')
						//надо все слова получить а не только активные и все пометить fullkeywordsHash[keytextFull][2] = 2 (иначе будут ниже при флаге modifykeystype постоянно восстанавливаться остановленные слова со статустом "мало показов")
						//.withCondition('Status = ENABLED')
						.withIds(keywordIds2)
						.get();


					var list = [];
					//на всякий случай проверяем Id ключа, что бы не повторить его в list
					var fids= {};
					while (lswkeywordsIterator.hasNext()) {
						var keyword = lswkeywordsIterator.next();

						//находим это КС или его производную, что бы остановить/удалить по параметру removeLSVKeywords

						var CustomParameters = keyword.urls().getCustomParameters();
						if (CustomParameters&&CustomParameters['sskeywrd1']) {
							//если слово сгенерировано другим словом в оптимизаторе, то пропускаем (ниже удалим если остановим/удалим если нужно)
							continue;
						}
						var keytextFull = keyword.getText();
						var keytextDW = clearKeyWord(keytextFull);
						if (keytextDW) {
							keytextFull = keytextDW[0];
							//не удаляем, так как КС остается
							//if (fullkeywords[keytextFull])
							//	delete fullkeywords[keytextFull];
							if (stopoldkeys) {
								if (fullkeywordsHash[keytextFull]) {
									//удаляем/останавливаем все сгенерированные им слова и его самого, хотя нужно ли всегда? - если есть сгенерированные слова то это все конверсионные слова
									//проверяем наличие fullkeywordsHash[keytextFull], так как его могли уже удалить на проверке предыдущего КС
									for (var i = 0; i < fullkeywordsHash[keytextFull][1].length; i++) {
										var tmpId = fullkeywordsHash[keytextFull][1][i].getId()+'='+fullkeywordsHash[keytextFull][1][i].getAdGroup().getId();
										if (!fids[tmpId]) {
//											pauseKeywordbuffer(fullkeywordsHash[keytextFull][1][i].getId(),fullkeywordsHash[keytextFull][1][i].getAdGroup().getId())
											list.push(fullkeywordsHash[keytextFull][1][i]);
											fids[tmpId]=1;
										}
									}
									//не удаляем элемент fullkeywordsHash[keytextFull], так как КС остается и ниже в modifykeystype может быть задано удаление слова
									//флаг - не восстанавливать активность КС после остановки здесь
									fullkeywordsHash[keytextFull][2] = 2;
								}
							}
						} else {
							//"неправильные слова" не трогаем, на всякий случай (хотя можно тоже удалять/останавливать)
							//хотя сюда заходить не должно вообще, так как мы генерируем только "правильные" слова
							continue;
						}
						var tmpId = keyword.getId()+'='+keyword.getAdGroup().getId();
						if (!fids[tmpId]) {
//							pauseKeywordbuffer(keyword.getId(),keyword.getAdGroup().getId())
							list.push(keyword);
							fids[tmpId] = 1;
						}
					}
//переделано по совету гугла https://developers.google.com/google-ads/scripts/docs/best-practices
					for (var i = 0; i < list.length; i++) {
						if (!list[i].isPaused())
							list[i].pause();
					}


				}

			}





			if (stopoldkeys&&GAS.modifykeystype) {
				for (var ckey in fullkeywordsHash) {
					if (!fullkeywordsHash[ckey][2]) {
						//отсутствующие в генерации КС должны быть остановлены или удалены
						if (GAS.modifykeystype > 2) {
							for (var i = 0; i < fullkeywordsHash[ckey][1].length; i++) {
								fullkeywordsHash[ckey][1][i].remove();
								fullkeywordsHash[ckey][1][i].remove();
							}
						} else {
							for (var i = 0; i < fullkeywordsHash[ckey][1].length; i++) {
								if (!fullkeywordsHash[ckey][1][i].isPaused())
									fullkeywordsHash[ckey][1][i].pause();
							}
						}
					} else if (GAS.modifykeysEnable) {
						if ((GAS.modifykeysEnable > 1)||(GAS.addkeystype != PARaddkeystype)||(GAS.modifykeystype&&(GAS.modifykeystype < 3)&&(KEYS != keysign))) {
							//все генерируемые КС должны быть активны
							for (var i = 0; i < fullkeywordsHash[ckey][1].length; i++) {
								if (fullkeywordsHash[ckey][2] != 2) {
									//если флаг 2, то это значит, что КС было остановлено выше по флагу removeLSVKeywords
									if (!fullkeywordsHash[ckey][1][i].isEnabled())
										fullkeywordsHash[ckey][1][i].enable();
								}
							}
						}
					}
				}
			}















					}


					if (setnewparams) {

						//удаляем параметры для всей группы, что бы не делать для каждого слова отдельно
						var adParamIterator = ag.adParams().get();
						while (adParamIterator.hasNext()) {
							var adParam = adParamIterator.next();
							adParam.remove();
							adParam.remove();
						}

					}


					if (setnewparams&&(!newads)) {

						//если сейчас создавали новые объявления, то параметры записывать в КС не нужно, новые параметры есть в объявлениях, нужно только удалить параметры из всех КС - параметры установлены в свежих объявлениях


						//указываем новые параметры для каждого ключа

						var allkeywords = [];
						var keywordIterator = ag.keywords().withCondition('Status != REMOVED').get();
						while (keywordIterator.hasNext()) {
							var keyword = keywordIterator.next();
							allkeywords[allkeywords.length] = keyword;
						}

						for (var i = 0; i < allkeywords.length; i++) {
							var keyword = allkeywords[i];
							if (paramslen) {
								keyword.setAdParam(1, params); //передаем первый параметр
							}
							if (params2len) {
								keyword.setAdParam(2, params2); // передаем второй параметр
							}
						}



						var chagnums = true;
						var chagnumsNum = 0;
						while (1) {
	        					try {
//почему то эта строка ниже вызывает абр, вынес отдельно
								chagnums = ag.adParams().get().totalNumEntities() < allkeywords.length
								break;
							} catch (e) {
								if (chagnumsNum > 2)
									break;
								chagnumsNum++
								Utilities.sleep(500);
							}
						}

						//модификация что бы 0 ошибок было и скорость снижает несильно
						if (chagnums) {

							Utilities.sleep(500);
							for (var i = 0; i < allkeywords.length; i++) {
								var keyword = allkeywords[i];
								var attnum = 0;
								while (keyword.adParams().get().totalNumEntities() != paramsnum) {
									if (paramslen) {
										keyword.setAdParam(1, params); //передаем первый параметр
									}
									if (params2len) {
										keyword.setAdParam(2, params2); // передаем второй параметр
									}
									if (attnum > 10) {
										Logger.log('Paused group and return: Errors add params in AdGroup ID/Name ' + agID + '/' + ag.getName() + ", keyword " + keyword.getText() + ' params: 1:' + params + '(' + paramslen + ') 2:' + params2 + '(' + params2len + ')' +  "\nfor url: " + url + "\n");
										//один раз сюда зашло, было много слов, нигде не исправило и закончилось по абру
										//поэтому останавливаем и выходим, в следующий раз повторно изменим эту группу
										//так как название не поменялось, то при следующем проходе группа обновится
										if (ag.isEnabled())
											ag.pause();
										delete OneFeedGASearch[URLID];
										return;
										//break;
									}
//									if (attnum > 1) {
//										//после двух попыток записи появляется задержка
//										Utilities.sleep(1000);
//									}
									attnum++;
									Utilities.sleep(500);
								}
							}
						}



					}


					if (setnewname) {
						var agName = ag.getName();
						//var newagName = agName.replace(/\s*st\:(\d+(?:\-\d+)?)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:end\s*/gm, ' ');
						var newagName = agName.replace(/\s*st\:(\d+(?:\-\d+)?)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:(\d+)\:end\s*/gm, ' ');
						newagName = newagName.trim();



						if (newads) {
							//изменили объявления, ставим новые paramslen params2len
							//в новых объявлениях по умолчанию уже указана новая цена (и 2-й пар-р) в параметрах
							//var newagNameST = 'st:' + URLID + ':' + adsign + ':' + paramslen + ':' + params2len + ':' + paramsign + ':' + keysign + ':' + POLICY + ':end';
							var newagNameST = 'st:' + URLID + ':' + adsign + ':' + paramslen + ':' + params2len + ':' + paramsign + ':' + keysign + ':' + NEWmaxNodigaddkeyNum + ':' + NEWaddkeystype + ':' + NEWremoveLSVKeywords + ':' + NEWmodifykeystype + ':' + NEWmodifykeysEnable + ':' + POLICY + ':end';
						} else {
							//это newparams без newads
							//изменили только параметры, ставим старые MXLNPR MXLNPR2
							//в старых объявлениях по умолчанию указана старая цена (и 2-й пар-р) в параметрах, но выдаст новые параметры
							//var newagNameST = 'st:' + URLID + ':' + adsign + ':' + MXLNPR + ':' + MXLNPR2 + ':' + paramsign + ':' + keysign + ':' + POLICY + ':end';
							var newagNameST = 'st:' + URLID + ':' + adsign + ':' + MXLNPR + ':' + MXLNPR2 + ':' + paramsign + ':' + keysign + ':' + NEWmaxNodigaddkeyNum + ':' + NEWaddkeystype + ':' + NEWremoveLSVKeywords + ':' + NEWmodifykeystype + ':' + NEWmodifykeysEnable + ':' + POLICY + ':end';
						}


						if (newagName) {
							//обязятельно сохраняем MAXBID в названии в случае дальнейших ошибок
							var re = new RegExp(/(MAXBID\:?\d+([\.\,]\d+)?)/);
							var vArr;
							if (((vArr = re.exec(newagName)) != null) && vArr[1]) {
								var newagNameST2 = newagNameST + ' ' + vArr[1];
							} else {
								var newagNameST2 = newagNameST;
							}
							newagName = newagNameST + ' ' + newagName;
						} else {
							newagName = newagNameST;
							var newagNameST2 = newagNameST;
						}
							
						ag.setName(newagName);
						var agName = ag.getName();
						if (newagName !== agName) {
							//длина названия превысила разрешенную (хотя может это ошибка повтора при переименовании), повторяем операцию


							//var campaign = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][CampaignNum][0];
							//была принципиальная ошибка, кампания не текушая, а кампания этой группы!
							var campaign = ag.getCampaign();

							//это может происходить, если по какой-то причине есть такая группа, а не из-за глюков гугла
							//проверяем наличие группы - может быть был уже остановленный дубликат новых значений
							var agIter = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').withCondition("AdGroupName = '" + newagName.replace(/\'/gm, '\\\'') + "'").get();
							if (agIter.hasNext()) {
								var ag2 = agIter.next();
								var agID2 = String(ag2.getId());


								if (POLICY) {

									if (ag2.isEnabled())
										ag2.pause();

									if (agID2 != agID) {
										//на всякий проверяем что это не эта группа
										//есть группа с POLICY_ERROR с этими параметрами, то есть полностью создана корректно
										//удаляем дубликат, который мы сейчас создали
										ag.pause();
										removeAdGroupbuffer(agID);
									}

									delete OneFeedGASearch[URLID];

									return;
								} else {
	
									if (ag2.isPaused())
										ag2.enable();

									if (agID2 != agID) {
										//на всякий проверяем что это не эта группа
										//есть нормальная группа с этими параметрами, то есть полностью создана корректно
										//удаляем дубликат, который мы сейчас создали
										ag.pause();
										removeAdGroupbuffer(agID);
									}

									delete OneFeedGASearch[URLID];

									//можно конечно переименовать уникально, удалить и создать заново, но зачем - группа создана корректно, имя ей дается в самом конце создания, значит все нормально
									//если сейчас выйти - так быстрее восстановим и счетчик будет верным
									return resreturn;
								}
							}


							ag.setName(newagName);

							var agName = ag.getName();

							if (newagName !== agName) {


								//наверное длинное название, теперь будет создавать укорченное название

								//проверяем наличие группы - может быть был уже остановленный дубликат новых значений
								var agIter = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').withCondition("AdGroupName = '" + newagNameST2.replace(/\'/gm, '\\\'') + "'").get();
								if (agIter.hasNext()) {
									var ag2 = agIter.next();
									var agID2 = String(ag2.getId());


									if (POLICY) {

										if (ag2.isEnabled())
											ag2.pause();

										if (agID2 != agID) {
											//на всякий проверяем что это не эта группа
											//есть группа с POLICY_ERROR с этими параметрами, то есть полностью создана корректно
											//удаляем дубликат, который мы сейчас создали
											ag.pause();
											removeAdGroupbuffer(agID);
										}

										delete OneFeedGASearch[URLID];

										return;
									} else {
	
										if (ag2.isPaused())
											ag2.enable();

										if (agID2 != agID) {
											//на всякий проверяем что это не эта группа
											//есть нормальная группа с этими параметрами, то есть полностью создана корректно
											//удаляем дубликат, который мы сейчас создали
											ag.pause();
											removeAdGroupbuffer(agID);
										}

										delete OneFeedGASearch[URLID];

										//можно конечно переименовать уникально, удалить и создать заново, но зачем - группа создана корректно, имя ей дается в самом конце создания, значит все нормально
										//если сейчас выйти - так быстрее восстановим и счетчик будет верным
										return resreturn;
									}
								}


								//длина названия превысила разрешенную (хотя может это ошибка повтора при переименовании), удаляем все лишнее
								//надо повторять, здесь тоже может вылезти ошибка случайная, а не переполнение длины названия
								var attnum = 0;
								while (1) {
									Utilities.sleep(1000);
									ag.setName(newagNameST2);
									var agName = ag.getName();
									if (newagNameST2 !== agName) {
										attnum++;
										if (attnum > 2) {
//нельзя выходить при таких ошибках, это не ошибки для нас!
//											ScanCreateFeedsGlobalVars.errors += 'Error of set new name for AdGroup: ' + newagNameST +  ", check correct name in script code\n"
//											Logger.log(ScanCreateFeedsGlobalVars.errors);
											Logger.log('Error of set new name for AdGroup: ' + newagNameST2 +  ", check correct name in script code\nfor url: " + url + "\n")

											//что-то не заладилось, сначала останавливаем, потом удалим
											ag.pause();
											removeAdGroupbuffer(agID);
											return;

										}
									} else {
										break;
									}
								}
							}
						}

						if (POLICY) {
							//название изменено, выходим, проверяем, что группа остановлена
							if (ag.isEnabled())
								ag.pause();
							delete OneFeedGASearch[URLID];
							return;
						}


					}


				}
			} else {

				if (POLICY) {
					//изменений не было, выходим, останавливаем если группа активна
					if (!AGpaused)
						pauseAdGroupbuffer(agID)
					delete OneFeedGASearch[URLID];
					return;
				}


				//проверено
				resreturn = 2
			}


			if ((!newgroup)&&AGpaused) {
				//всегда восстанавливаем видимость если группа неактивна
				//здесь группа существует, корректна, но неактивна (во всяком случае так было на момент старта (формирования массива OneFeedGASearch))
				//передаем сигнал на восстановление видимости группы и выходим
				enableAdGroupbuffer(agID);

			}

			//убираем обработанную группу, что бы в конце остановить/удалить оставшиеся необработанные
			//и еще дополнительно снижаем расход памяти, уже не нужен элемент
			delete OneFeedGASearch[URLID];

		} else {
			//группы еще нет в поиске, точно добавляем полностью все
			newgroup=1;

			//добавлено
			resreturn = 1
		}

		if (newgroup) {
			//полное создание новой группы


			//на всякий случай
			if (OneFeedGASearch[URLID])
				delete OneFeedGASearch[URLID];


			var campaign = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][CampaignNum][0];
			var startbid = ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][CampaignNum][2];


			//var PREVnewagNameST = 'st:' + URLID + ':' + adsign + ':' + paramslen + ':' + params2len + ':' + paramsign + ':' + keysign + ':';
			var PREVnewagNameST = 'st:' + URLID + ':' + adsign + ':' + paramslen + ':' + params2len + ':' + paramsign + ':' + keysign + ':' + NEWmaxNodigaddkeyNum + ':' + NEWaddkeystype + ':' + NEWremoveLSVKeywords + ':' + NEWmodifykeystype + ':' + NEWmodifykeysEnable + ':';


			//может быть ситуация абра - новая группа создана полностью (есть корректное имя), но из-за абра повторно проходим ссылки и сюда попали, тогда выходим как будто мы сейчас ее создали
			//при абре после запуска созданные кампании не попадут в базу, так как база формируется только при проходах на шаге 0, можно конечно формировать базу при каждом запуске, но предполагается большое количество групп и что займет больше времени (проверить каждую группу на проходе после абра (то есть частично, около 200 групп), или создавать каждый раз базу при большом общем колве, например 40 тысяч, наверное лучше всеже после абра подергать проверку каждой группы)
			//можно конечно при абре переформировать базу, но это потребует анализа текущей базы и пр. Короче так оптимально как сейчас
			if (ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.ABORT) {
				var agIter = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').withCondition("AdGroupName CONTAINS '" + PREVnewagNameST.replace(/\'/gm, '\\\'') + "'").get();
				while (agIter.hasNext()) {
					var ag = agIter.next();
					var agname = ag.getName();
					var agID = String(ag.getId());

					var match = agname.match(new RegExp(escapeRegExp(PREVnewagNameST) + '(\\d+)\\:end'));
					if (match&&match[1]) {
						var POLICY = Number(match[1]);
					} else {
						//не найден наш формат

						if (ag.isEnabled())
							ag.pause();

						removeAdGroupbuffer(agID);
						return;

					}

					if (POLICY) {
						if (ag.isEnabled())
							ag.pause();
						return;
					}


					if (ag.isPaused())
						ag.enable();



					//можно конечно переименовать уникально, удалить и создать заново, но зачем - группа создана корректно, имя ей дается в самом конце создания, значит все нормально
					//если сейчас выйти - так быстрее восстановим и счетчик будет верным
					return resreturn;
				}
			}


			//тут всегда сначала пробуем создавать
			var POLICY = 0;

			//теперь обязательно нужно указывать имя группы
			var adGroupBuilderDate = new Date();
			var adGroupBuilderDateTime = adGroupBuilderDate.toString() + ' ' + adGroupBuilderDate.getTime();

			var adGroupBuilder = campaign.newAdGroupBuilder();
			var adGroupOperation = adGroupBuilder
				.withName('Created new AdGroup datetime: ' + adGroupBuilderDateTime)
				.withCpc(startbid)
				.withStatus("ENABLED")
//				.withStatus("PAUSED")


	        	try {

				adGroupOperation = adGroupOperation.build();

				if (adGroupOperation.isSuccessful()) {
					var ag = adGroupOperation.getResult();
                	      	} else {

					var err = adGroupOperation.getErrors();

					//OPERATION_NOT_PERMITTED_FOR_REMOVED_ENTITY : OperationAccessDenied.OPERATION_NOT_PERMITTED_FOR_REMOVED_ENTITY : operations[0]

					if (/OPERATION_NOT_PERMITTED_FOR_REMOVED_ENTITY/.test(err)) {
//это ошибка только если удалена кампания во время выполнения скрипта
//выходим, потом создадим, к сожалению это возможно будет только при следующем скане
//хотя лучше все же оставить ошибку с полным выходом из скрипта до следующего запуска (оставил этот вариант)
						ScanCreateFeedsGlobalVars.errors += 'Errors create AdGroup for removed Campaign: ' + err + "\n"
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						//Logger.log('Errors create AdGroup: ' + err + "\nfor url: " + url + "\n");
					} else {

//нельзя выходить при таких ошибках, это не ошибки для нас!
//						ScanCreateFeedsGlobalVars.errors += 'Errors create AdGroup: ' + adGroupOperation.getErrors() + "\n"
//						Logger.log(ScanCreateFeedsGlobalVars.errors);
						Logger.log('Errors create AdGroup: ' + err + "\nfor url: " + url + "\n");
					}

					//выходим, потом создадим, к сожалению это возможно будет только при следующем скане
					return;

				}


			} catch (e) {
				ScanCreateFeedsGlobalVars.errors += 'Errors build AdGroup: ' + e.message + "\n"
				Logger.log(ScanCreateFeedsGlobalVars.errors);
				//Logger.log('Errors build AdGroup: ' + e.message + "\nfor url: " + url + "\n");
				return;
			}


			var agID = ag.getId();

			

//добавляем объявления



							var operations = [];

							for (var GASADId in ads) {
							//for (var ii = 0; ii < GAS['adids'].length; ii++) {
							//	var GASADId = GAS['adids'][ii];
							//	if (ads[GASADId]) {



//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@

									var adOperation = ag.newAd().responsiveSearchAdBuilder()
										.withFinalUrl(GASvalues['url']);

									if (GASvalues['mobileurl'])
										adOperation = adOperation.withMobileFinalUrl(GASvalues['mobileurl']);

									adOperation = adOperation.addHeadline(ads[GASADId].Headlines[0], "HEADLINE_1");
									adOperation = adOperation.addHeadline(ads[GASADId].Headlines[1], "HEADLINE_2");
									adOperation = adOperation.addHeadline(ads[GASADId].Headlines[2], "HEADLINE_3");


									adOperation = adOperation.addDescription(ads[GASADId].Descriptions[0], "DESCRIPTION_1");
									adOperation = adOperation.addDescription(ads[GASADId].Descriptions[1], "DESCRIPTION_2");


									if (ads[GASADId].Paths[0])
										adOperation = adOperation.withPath1(ads[GASADId].Paths[0]);

									if (ads[GASADId].Paths[1])
										adOperation = adOperation.withPath2(ads[GASADId].Paths[1]);



							        	try {
	
										adOperation = adOperation.build();
										operations.push(adOperation);


									} catch (e) {
										ScanCreateFeedsGlobalVars.errors += 'Errors build Ad in AdGroup ID ' + agID + ": " + e.message + "\n"
										Logger.log(ScanCreateFeedsGlobalVars.errors);
									}





							//	}
							}

							var checkadsnum=0
							var checkpolicyerrornum=0
							for (var i = 0; i < operations.length; i++) {
								if (operations[i].isSuccessful()) {
									var newAd = operations[i].getResult();
									checkadsnum++
								} else {

									var err = operations[i].getErrors();

									//POLICY_ERROR : AdPolicyError.POLICY_ERROR : ad.description,POLICY_ERROR : AdPolicyError.POLICY_ERROR : ad.description

									if (/POLICY\_ERROR/.test(err)) {
										checkpolicyerrornum++
									}


//нельзя выходить при таких ошибках, это не ошибки для нас!
//									ScanCreateFeedsGlobalVars.errors += 'Errors create Ad in AdGroup ID ' + agID + ": " + err + "\n"
//									Logger.log(ScanCreateFeedsGlobalVars.errors);
									Logger.log('Errors create Ad in AdGroup ID ' + agID + ": " + err + "\nfor url: " + url + "\n");
								}
							}

							if (!checkadsnum) {
//какие-то правила не позволили создать объявление хотя бы одно
//выходим сразу и удаляем пустую группу (если не было везде ошибки POLICY_ERROR)

								if (checkpolicyerrornum&&(checkpolicyerrornum == operations.length))
									POLICY = 1;

								if (!POLICY) {

									//что-то не заладилось, сначала останавливаем, потом удалим
									ag.pause();
									removeAdGroupbuffer(agID);
									return;
								}
							}


		if (!POLICY) {


//массив всех КС
			var allkeywords = [];

//формируем добавляемые КС


			var operations = [];
			var keywordsToCreate = [];
			var keywordsWithoutType = [];

			for (var ii = 0; ii < keysCOLLECT.length; ii++) {

					if (keysCOLLECT[ii].length > 80) {
						//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
						continue;
					}


					var keywordOperation = ag.newKeywordBuilder()
						.withText(keysFULL[ii]);


					keywordOperation = keywordOperation.build();

					operations.push(keywordOperation);
					keywordsToCreate.push(keysFULL[ii]);
					keywordsWithoutType.push(keysCOLLECT[ii]);

			}


			var errkeysnums = []


//добавляем КС и параметры КС
			for (var i = 0; i < operations.length; i++) {
				if (operations[i].isSuccessful()) {
					var newKeyword = operations[i].getResult();
					allkeywords[allkeywords.length] = newKeyword;

/*

если сразу добавлять то не всем словам добавяться параметры а так же возникают ошибки при добавлении параметров и изменении названия группы дальше
поэтому перенесено ниже отдельно

					if (paramslen) {
						newKeyword.setAdParam(1, params); //передаем первый параметр
					}
					if (params2len) {
						newKeyword.setAdParam(2, params2); // передаем второй параметр
					}

*/

				} else {

					var err = operations[i].getErrors();

					//[садовая пластмассовой]: CONCURRENT_MODIFICATION : DatabaseError.CONCURRENT_MODIFICATION : 

					if (/CONCURRENT_MODIFICATION/.test(err)) {
						//иногда возникает ошибка при добавлении слов
						errkeysnums.push(i);
					}


//нельзя выходить при таких ошибках, это не ошибки для нас!
//					ScanCreateFeedsGlobalVars.errors += 'Errors from Keyword ' + keywordsToCreate[i] + ": " + operations[i].getErrors() + "\n"
//					Logger.log(ScanCreateFeedsGlobalVars.errors);
					Logger.log('Errors from Keyword ' + keywordsToCreate[i] + ": " + operations[i].getErrors() + "\nfor url: " + url + "\n");
				}
			}



			if (errkeysnums.length) {
				//иногда возникает ошибка при повторном добавлении слов

				Utilities.sleep(1000);

				var operations2 = [];
				var keywordsToCreate2 = [];

				for (var i = 0; i < errkeysnums.length; i++) {
					if (keywordsWithoutType[i].length > 80) {
						//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
						continue;
					}

        
					var keywordOperation = ag.newKeywordBuilder()
						.withText(keywordsToCreate[i]);
					


					keywordOperation = keywordOperation.build();

					operations2.push(keywordOperation);
					keywordsToCreate2.push(keywordsToCreate[i]);
				}


				for (var i = 0; i < operations2.length; i++) {
					if (operations2[i].isSuccessful()) {
						var newKeyword = operations2[i].getResult();
						allkeywords[allkeywords.length] = newKeyword;
					} else {
//нельзя выходить при таких ошибках, это не ошибки для нас!
//						ScanCreateFeedsGlobalVars.errors += 'Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\n"
//						Logger.log(ScanCreateFeedsGlobalVars.errors);
						Logger.log('Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\nfor url: " + url + "\n");
					}
				}


			}



			var operations = [];
			var keywordsToCreate = [];
			var keywordsWithoutType = [];


			if (addkeysCOLLECT.length) {
				//значит это вариант с проверкой на "мало показов" и есть КС с 2-мя словами

				//есть ли слова без статуса "мало показов"
				var workkeywordsnum = ag.keywords()
					.withCondition("SystemServingStatus != 'RARELY_SERVED'")
					.get().totalNumEntities();

				if (!workkeywordsnum) {
					//все слова имеют статус "мало показов"
					//либо вообще нет массива слов keysCOLLECT (например, название из двух слов)
					//добавляем addkeysCOLLECT


//формируем дополнительные добавляемые КС

					for (var ii = 0; ii < addkeysCOLLECT.length; ii++) {

							if (addkeysCOLLECT[ii].length > 80) {
								//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
								continue;
							}


							var keywordOperation = ag.newKeywordBuilder()
								.withText(addkeysFULL[ii]);
					
							keywordOperation = keywordOperation.build();

							operations.push(keywordOperation);
							keywordsToCreate.push(addkeysFULL[ii]);
							keywordsWithoutType.push(addkeysCOLLECT[ii]);

					}



				}

			}





			if (dkeysCOLLECT.length) {
				//значит это вариант с проверкой на "мало показов" без цифровых ключей (сначала проверяем только 3 КС)


//формируем в конце отдельно цифровые добавляемые КС

				for (var ii = 0; ii < dkeysCOLLECT.length; ii++) {

						if (dkeysCOLLECT[ii].length > 80) {
							//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
							continue;
						}

        
						var keywordOperation = ag.newKeywordBuilder()
							.withText(dkeysFULL[ii]);
					


						keywordOperation = keywordOperation.build();

						operations.push(keywordOperation);
						keywordsToCreate.push(dkeysFULL[ii]);
						keywordsWithoutType.push(dkeysCOLLECT[ii]);

				}


			}


			var errkeysnums = []

//добавляем дополнительные КС и параметры КС
			for (var i = 0; i < operations.length; i++) {
				if (operations[i].isSuccessful()) {
					var newKeyword = operations[i].getResult();
					allkeywords[allkeywords.length] = newKeyword;

/*

если сразу добавлять то не всем словам добавяться параметры а так же возникают ошибки при добавлении параметров и изменении названия группы дальше
поэтому перенесено ниже отдельно


					if (paramslen) {
						newKeyword.setAdParam(1, params); //передаем первый параметр
					}
					if (params2len) {
						newKeyword.setAdParam(2, params2); // передаем второй параметр
					}

*/

				} else {

					var err = operations[i].getErrors();

					//[садовая пластмассовой]: CONCURRENT_MODIFICATION : DatabaseError.CONCURRENT_MODIFICATION : 

					if (/CONCURRENT_MODIFICATION/.test(err)) {
						//иногда возникает ошибка при добавлении слов
						errkeysnums.push(i);
					}


//нельзя выходить при таких ошибках, это не ошибки для нас!
//					ScanCreateFeedsGlobalVars.errors += 'Errors from Add Keyword ' + keywordsToCreate[i] + ": " + operations[i].getErrors() + "\n"
//					Logger.log(ScanCreateFeedsGlobalVars.errors);
					Logger.log('Errors from Add Keyword ' + keywordsToCreate[i] + ": " + err + "\nfor url: " + url + "\n");
				}
			}

			if (errkeysnums.length) {
				//иногда возникает ошибка при повторном добавлении слов

				Utilities.sleep(1000);

				var operations2 = [];
				var keywordsToCreate2 = [];

				for (var i = 0; i < errkeysnums.length; i++) {
					if (keywordsWithoutType[i].length > 80) {
						//В ключевом слове должно быть не больше 80 символов (включается все символы, в т.ч. + "), кроме символов []"
						continue;
					}

        
					var keywordOperation = ag.newKeywordBuilder()
						.withText(keywordsToCreate[i]);
					


					keywordOperation = keywordOperation.build();

					operations2.push(keywordOperation);
					keywordsToCreate2.push(keywordsToCreate[i]);
				}


				for (var i = 0; i < operations2.length; i++) {
					if (operations2[i].isSuccessful()) {
						var newKeyword = operations2[i].getResult();
						allkeywords[allkeywords.length] = newKeyword;
					} else {
//нельзя выходить при таких ошибках, это не ошибки для нас!
//						ScanCreateFeedsGlobalVars.errors += 'Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\n"
//						Logger.log(ScanCreateFeedsGlobalVars.errors);
						Logger.log('Errors from Keyword ' + keywordsToCreate2[i] + ": " + operations2[i].getErrors() + "\nfor url: " + url + "\n");
					}
				}


			}

			if (!allkeywords.length) {
				//что-то не заладилось, сначала останавливаем, потом удалим
				ag.pause();
				removeAdGroupbuffer(agID);
				return;
			}


			if (GAS['removeLSVKeywords']) {

				if (GAS['removeLSVKeywords'] == 1) {
					//удаляем все слова со статусом "мало показов"

					var lswkeywordsIterator = ag.keywords()
						.withCondition("SystemServingStatus = 'RARELY_SERVED'")
						.withCondition('Status != REMOVED')
						.get();


/*
потом опять появится, низзя туда-сюда
					if (lswkeywordsIterator.totalNumEntities() == allkeywords.length) {
						//все слова будут удалены, поэтому удаляем группу
						ag.pause();
						removeAdGroupbuffer(agID);
						return;
					}

*/


					var list = [];
					while (lswkeywordsIterator.hasNext()) {
						var keyword = lswkeywordsIterator.next();
//						removeKeywordbuffer(keyword.getId(),keyword.getAdGroup().getId())
						list.push(keyword);
					}
//переделано по совету гугла https://developers.google.com/google-ads/scripts/docs/best-practices
					for (var i = 0; i < list.length; i++) {
						list[i].remove();
						list[i].remove();
					}



				} else {
					//приостанавливаем все слова со статусом "мало показов"

					var lswkeywordsIterator = ag.keywords()
						.withCondition("SystemServingStatus = 'RARELY_SERVED'")
						.withCondition('Status = ENABLED')
						.get();



					var list = [];
					while (lswkeywordsIterator.hasNext()) {
						var keyword = lswkeywordsIterator.next();
//						pauseKeywordbuffer(keyword.getId(),keyword.getAdGroup().getId())
						list.push(keyword);
					}
					for (var i = 0; i < list.length; i++) {
						list[i].pause();
					}


				}

			}


/*

львиная доля ошибок возникает при начальной установке параметров здесь при создании кампании
и как избавиться так и не нашел, во всяком случае этот код надежно добавляет параметры (если просто присвоить параметры без контроля, то 10-20% не установяться)
ошибка не важная, но сильно раздражает
НО! оказалось очень просто
можно просто не добавлять сейчас, а потом, когда изменяться парамеры, 
но уже не везде, а там где нужно и поэтому ошибок будет меньше светится
Кроме того должно немного поднять скорость, так как нет проверок установки параметра
Здесь описано, что вроде так можно делать (не записывать сразу)
https://developers.google.com/adwords/api/docs/guides/ad-parameters?hl=ru


если вдруг нужно добавлять сразу - просто раскомментировать этот кусок и все


			//добавляем параметры КС
			//перенесено сюда отдельно, иначе если сразу применять, то не всем КС присваивается параметр
			//а также, возникают ошибки при добавлении параметров и изменении названия группы дальше
			if (paramsnum) {


				//иногда на этапе добавления параметров (ниже) возникает ошибка 'В этот объект вносятся изменения в рамках другой задачи. Повторите попытку позже.'
				//видимо еще не сформировались как-то полностью слова
				//повторный проход исправляет эту проблему
				//как предупредить - не нашел, задержка увеличит время выполнения, переключение здесь туда обратно ag.pause(); ag.enable(); ничего не дало
				//придется мирится с этой периодической ошибкой, и исправлять при возникновении




//много ошибок при добавлении в этом варианте (непонятно как выявлять рабочие слова)
//и как оказалось он медленее на 25% нижнего! и куча ошибок
//				for (var i = 0; i < allkeywords.length; i++) {
//					var keyword = allkeywords[i];
//					if (keyword.isEnabled() || keyword.isPaused()) {
//						//нужны существующие слова
//						if (paramslen) {
//							keyword.setAdParam(1, params); //передаем первый параметр
//						}
//						if (params2len) {
//							keyword.setAdParam(2, params2); // передаем второй параметр
//						}
//					}
//					
//				}




//оказался самый быстрый вариант (модифицировал, что бы был 0 ошибок при добавлении параметров)

				var allkeywords = [];
				var keywordIterator = ag.keywords().withCondition('Status != REMOVED').get();
				while (keywordIterator.hasNext()) {
					var keyword = keywordIterator.next();
					allkeywords[allkeywords.length] = keyword;
				}
//переделано по совету гугла https://developers.google.com/google-ads/scripts/docs/best-practices
//ничего не дало ошибки сыпятся
				for (var i = 0; i < allkeywords.length; i++) {
					var keyword = allkeywords[i];
					if (paramslen) {
						keyword.setAdParam(1, params); //передаем первый параметр
					}
					if (params2len) {
						keyword.setAdParam(2, params2); // передаем второй параметр
					}
				}



				var chagnums = true;
				var chagnumsNum = 0;
				while (1) {
	        			try {
//почему то эта строка ниже вызывает абр, вынес отдельно
						chagnums = ag.adParams().get().totalNumEntities() < allkeywords.length
						break;
					} catch (e) {
						if (chagnumsNum > 2)
							break;
						chagnumsNum++
						Utilities.sleep(500);
					}
				}


				//модификация что бы 0 ошибок было и скорость снижает несильно
				if (chagnums) {

					Utilities.sleep(500);
					for (var i = 0; i < allkeywords.length; i++) {
						var keyword = allkeywords[i];
						var attnum = 0;
						while (keyword.adParams().get().totalNumEntities() != paramsnum) {
							if (paramslen) {
								keyword.setAdParam(1, params); //передаем первый параметр
							}
							if (params2len) {
								keyword.setAdParam(2, params2); // передаем второй параметр
							}
							if (attnum > 10) {
								Logger.log('Paused group and return: Errors add params in AdGroup ID/Name ' + agID + '/' + ag.getName() + ", keyword " + keyword.getText() + ' params: 1:' + params + '(' + paramslen + ') 2:' + params2 + '(' + params2len + ')' +  "\nfor url: " + url + "\n");
								//один раз сюда зашло (но в аналогичном коде выше), было много слов, нигде не исправило и закончилось по абру
								//поэтому останавливаем и выходим, в следующий раз повторно создадим эту группу
								ag.pause();
								removeAdGroupbuffer(agID);
								return;
								//break;
							}
//							if (attnum > 1) {
//								//после двух попыток записи появляется задержка
//								Utilities.sleep(1000);
//							}
							attnum++;
							Utilities.sleep(500);
						}
					}
				}




			}



конец при раскомментировании

*/


                }


			//в самом конце устанавливаем название группы (иначе, в случае сбоя и отсутствия изменений в дальнейщем, сбойная невадидная группа не изменится)
			//а так, в случае сбоя группа с неправильным имененем удалится



			var newagNameST = PREVnewagNameST + POLICY + ':end';


			ag.setName(newagNameST);

			var agName = ag.getName();

			if (newagNameST !== agName) {


				//это может происходить, если по какой-то причине есть такая группа, а не из-за глюков гугла
				//проверяем наличие группы - очень даже могла появится после абра, а мы на предыдущем проходе, когда был флаг абра не все группы проверили, которые были добавлены
				var agIter = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').withCondition("AdGroupName = '" + newagNameST.replace(/\'/gm, '\\\'') + "'").get();
				if (agIter.hasNext()) {
					var ag2 = agIter.next();
					var agID2 = String(ag2.getId());


					if (!ScanCreateFeedsGlobalVars.ABORT) {

						//я уже писал, что возник непонятный абр при модификации групп с обновлением параметров и при этом появился измененный конфиг
						//потом при рестарте вылезало постоянно - такая группа уже есть (при чем в первой же группе сразу после создания списка на шаге 0 уже подключенных групп)
						//и потом постоянно в большинстве групп такое было, в т.ч. при каждом последующем запуске текущего скана
						//так и не понял как это произошло, но здесь совпал абр на последнем запуске перед ресканом (был изменен конфиг) и завершение скрипта по таймауту из-за редкой ошибки, которой раньше не наблюдал
						//эта редкая ошибка - невозможность обновить параметры КС, при чем для все КС группы
						//там тоже подкорректировал, что бы облегчить такие ситуации
						//где это было ищем по словам - было много слов, нигде не исправило и закончилось по абру
						//так же (возможно?, не знаю) не удалились tmp-файлы при рестарте после таймаута
						//также нашел и исправил проблему с дубликатами групп на шаге 0 при добавлении их в метку сбора существующих групп


						//был абр при каком-то предыдущем запуске скрипта
						//включаем режим абра для последующих групп
						Logger.log('Abort mode turn on. One of previos starts was aborted for scan ' + ScanCreateFeedsGlobalVars.SITE)
						ScanCreateFeedsGlobalVars.warnings += 'Abort mode turn on. One of previos starts was aborted for scan ' + ScanCreateFeedsGlobalVars.SITE + "\n";

						ScanCreateFeedsGlobalVars.ABORT = 1;
						scanned.errors.abnormal_exits = 1;
					}



					if (POLICY) {

						if (ag2.isEnabled())
							ag2.pause();


						if (agID2 != agID) {
							//на всякий проверяем что это не эта группа
							//есть группа с POLICY_ERROR с этими параметрами, то есть полностью создана корректно
							//удаляем дубликат, который мы сейчас создали
							ag.pause();
							removeAdGroupbuffer(agID);
						}

						return;
					} else {
	
						if (ag2.isPaused())
							ag2.enable();


						if (agID2 != agID) {
							//на всякий проверяем что это не эта группа
							//есть нормальная группа с этими параметрами, то есть полностью создана корректно
							//удаляем дубликат, который мы сейчас создали
							ag.pause();
							removeAdGroupbuffer(agID);
						}

						//можно конечно переименовать уникально, удалить и создать заново, но зачем - группа создана корректно, имя ей дается в самом конце создания, значит все нормально
						//если сейчас выйти - так быстрее восстановим и счетчик будет верным
						return resreturn;
					}
				}


				//надо повторять, здесь тоже может вылезти ошибка случайная, а не переполнение длины названия
				var attnum = 0;
				while (1) {
					ag.setName(newagNameST);
					var agName = ag.getName();
					if (newagNameST !== agName) {
						attnum++;
						if (attnum > 2) {
//нельзя выходить при таких ошибках, это не ошибки для нас!
//							ScanCreateFeedsGlobalVars.errors += 'Error of set new name for AdGroup: ' + newagNameST +  ", check correct name in script code\n"
//							Logger.log(ScanCreateFeedsGlobalVars.errors);
							Logger.log('Error of set new name for AdGroup: ' + newagNameST +  ", check correct name\nfor url: " + url + "\n")

							//что-то не заладилось, сначала останавливаем, потом удалим
							ag.pause();
							removeAdGroupbuffer(agID);
							return;
						}
					} else {
						break;
					}
					Utilities.sleep(1000);
				}
			}



			if (POLICY) {
				//название создано, выходим, проверяем, что группа остановлена
				if (ag.isEnabled())
					ag.pause();
				return;
			}



		}


	}
	

	return resreturn;


}


function clearKeyWord(KeyWord) {
	//чистим действующий ключ от лишнего (нет лишних проверок, так как это реальное КС из аккаунта)
	//выдаем очищенный ключ и ключ без плюсов и без []"

	//Ключевые слова не могут содержать следующие специальные символы: ! @ % , *
	if (/[\!\@\%\,\*]/.test(KeyWord)) {
		return;
	}


//минус-слова разрешены в КС, поэтому только удаляем их из КС, а не пропускаем все слово
//	KeyWord = KeyWord.replace(/((^\s*[[\"\[]]?)|(\s))\-[^\s\+\"\]]+/g, '$1');
	if (/((^\s*[[\"\[]]?)|(\s))\-[^\s\+\"\]]+/.test(KeyWord)) {
//если есть минус слово, то такое КС не может быть при добавлении, то есть не проходит слово
		return;
	}




//чистим возможные пробелы где их не должно быть
	KeyWord = KeyWord.replace(/\s\s+/g, ' ');
	KeyWord = KeyWord.replace(/^\s*([\"\[]?)\s*(.*?)\s*([\"\]]?)\s*$/, '$1$2$3');

//дальше полностью корректные КС вроде должны быть

//убираем плюсы у точного и фразового соотвествия (построитель может их туда засунуть при преобразовании слов)
	if (/^\s*[\"\[]/.test(KeyWord))
		KeyWord = KeyWord.replace(/((^\s*[[\"\[]]?)|(\s))[\+\-]+([^\s\+\-]+)/g, '$1$4');

	if (/^[\"\[]?\s*[\"\[]?$/.test(KeyWord)) {
		return;
	}

//обязательно делать так, есть те кто делает большие буквы в словах
	KeyWord = KeyWord.toLowerCase();

//убираем из слова все признаки соответствия []"+
	var StKeyWord = KeyWord;
	StKeyWord = StKeyWord.replace(/^\s*([\"\[]?)\s*(.*?)\s*([\"\]]?)\s*$/, '$2');
	StKeyWord = StKeyWord.replace(/((^\s*)|(\s))[\+]+([^\s\+]+)/g, '$1$4');

	return [KeyWord,StKeyWord];
}

function differ(a, b) {
//сравниваются массивы отдельных слов из двух КС
//если есть дубликаты в первом слове, то всегда выдаст ошибку
//если есть дубликаты во втором слове, то всегда выдаст, что не совпадают слова
	var alen = a.length;
	var arr = [];
	var hash = {};
	var samekey = 0;
	for (var i=0; i < alen; i++) {
		if (!hash[a[i]]) {
			var key = a[i];
			if (b.indexOf(key) === -1) {
				arr.push(key);
			} else {
				samekey++
			}
			hash[key] = 1;
		} else {
//дубликат в первом слове
			return false;
		}
	}
	if (samekey === b.length) {
		return arr;
	}
	return null;
}


function CreateFeed(checkedfields,feed_fields_file_types,OneFeedFilesOUT) {


//feed_fields_file_types - для каждого расширения файла фида перебираем в заданной конфигом последовательности все возможные поля field_name
//(для формирования позиций со значениями полей в файле)

//checkedfields - значения полей


//допустимые расширения файлов фидов (из readFeedConfig)
//var correctfeedExt = ['.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'];

//допустимые расширения файлов фидов и их обработчики отдельного поля и всей товарной позиции
	var correctfeedExtPositionFunctions = {
		'.html': function(feed_file_ext,feed_fields_file_types,checkedfields) {

				var position_OUT = '';

				for (var feed_field_name in feed_fields_file_types[feed_file_ext]) {
//feed_field_name - реальное имя поля, записываемое в файл фида (для мультиполей - это multifield_name, для обычных полей - это field_name)

					if ({}.toString.call(feed_fields_file_types[feed_file_ext][feed_field_name]) === '[object Array]') {
//значение feed_field_name - это массив field_name для мультиполя multifield_name

						for (var i = 0; i < feed_fields_file_types[feed_file_ext][feed_field_name].length; i++) {
//получаем field_name для каждого multifield_name = feed_fields_file_types[feed_file_ext][feed_field_name][i]

							var field_name = feed_fields_file_types[feed_file_ext][feed_field_name][i];

							var field_value = checkedfields[field_name]['field_value'];
							var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
							var checkedfields2 = null;
							if (checkedfields[field_name]['include_attributes']) {
								var input = field_value.split(/[\n]+/);
//								if (input.length) {
									checkedfields2 = {}
									for (var iii = 0; iii < input.length; iii += 2) {
										var field_name2 = input[iii];
										var field_value2 = input[iii+1];
/*
										if (htmlencode) {
											field_value2 = Encoder.XSSEncode(field_value2);
										} else {
											var tmp_field_value = Encoder.XSSEncode(field_value2);
											if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
												field_value2 = '<![CDATA[' + field_value2 + ']]>';
											}
										}
*/
//код выше закомментирован и добавлена строка ниже, что бы читалось нормально на html-странице
										field_value2 = Encoder.XSSEncode(field_value2);

										checkedfields2[field_name2] = field_value2;
									}
//								}
							}
							if (!checkedfields2) {
/*
								if (htmlencode) {
									field_value = Encoder.XSSEncode(field_value);
								} else {
									var tmp_field_value = Encoder.XSSEncode(field_value);
									if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
										field_value = '<![CDATA[' + field_value + ']]>';
									}
								}
*/
//код выше закомментирован и добавлена строка ниже, что бы читалось нормально на html-странице
								field_value = Encoder.XSSEncode(field_value);
							}
							if (checkedfields2) {
								//есть вложенные аттрибуты

								if (Object.keys(checkedfields2).length) {

									position_OUT += feed_field_name + "<br>\n";

									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
										//создаем ссылки на страницы и фото для всех вариантов их названий
										if ((feed_field_name2 == 'link')||(feed_field_name2 == 'mobile_link')) {
											position_OUT += '&nbsp;&nbsp;&nbsp;&nbsp;' + feed_field_name2 + ' ' + '<a href="' + field_value2 + '">' + field_value2 + "</a><br>\n";
										} else if ((feed_field_name2 == 'image_link')||(feed_field_name2 == 'additional_image_link ')) {
											position_OUT += '&nbsp;&nbsp;&nbsp;&nbsp;' + feed_field_name2 + ' ' + "<img src='" + field_value2 + "' height='70'><br>\n";
										} else {
											position_OUT += '&nbsp;&nbsp;&nbsp;&nbsp;' + feed_field_name2 + ' ' + '<b>' + field_value2 + "</b><br>\n";
										}
									}
			
								}

							} else {

								if (field_value) {

									//создаем ссылки на страницы и фото для всех вариантов их названий
									if ((feed_field_name == 'link')||(feed_field_name == 'mobile_link')) {
										position_OUT += feed_field_name + ' ' + '<a href="' + field_value + '">' + field_value + "</a><br>\n";
									} else if ((feed_field_name == 'image_link')||(feed_field_name == 'additional_image_link ')) {
										position_OUT += feed_field_name + ' ' + "<img src='" + field_value + "' height='70'><br>\n";
									} else {
										position_OUT += feed_field_name + ' ' + '<b>' + field_value + "</b><br>\n";
									}

								}

							}

						}



					} else {
//значение feed_field_name - равно 1, это обычное немультиполе field_name

//получаем field_name (не мультиполе) 
						var field_name = feed_field_name;

						var field_value = checkedfields[field_name]['field_value'];
						var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
						var checkedfields2 = null;
						if (checkedfields[field_name]['include_attributes']) {
							var input = field_value.split(/[\n]+/);
//							if (input.length) {
								checkedfields2 = {}
								for (var iii = 0; iii < input.length; iii += 2) {
									var field_name2 = input[iii];
									var field_value2 = input[iii+1];

/*
									if (htmlencode) {
										field_value2 = Encoder.XSSEncode(field_value2);
									} else {
										var tmp_field_value = Encoder.XSSEncode(field_value2);
										if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
											field_value2 = '<![CDATA[' + field_value2 + ']]>';
										}
									}
*/
//код выше закомментирован и добавлена строка ниже, что бы читалось нормально на html-странице
									field_value2 = Encoder.XSSEncode(field_value2);

									checkedfields2[field_name2] = field_value2;

								}
//							}
						}
						if (!checkedfields2) {
/*
							if (htmlencode) {
								field_value = Encoder.XSSEncode(field_value);
							} else {
								var tmp_field_value = Encoder.XSSEncode(field_value);
								if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
									field_value = '<![CDATA[' + field_value + ']]>';
								}
							}
*/
//код выше закомментирован и добавлена строка ниже, что бы читалось нормально на html-странице
							field_value = Encoder.XSSEncode(field_value);
						}
						if (checkedfields2) {
							//есть вложенные аттрибуты

							if (Object.keys(checkedfields2).length) {

									position_OUT += feed_field_name + "<br>\n";

									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
										//создаем ссылки на страницы и фото для всех вариантов их названий
										if ((feed_field_name2 == 'link')||(feed_field_name2 == 'mobile_link')) {
											position_OUT += '&nbsp;&nbsp;&nbsp;&nbsp;' + feed_field_name2 + ' ' + '<a href="' + field_value2 + '">' + field_value2 + "</a><br>\n";
										} else if ((feed_field_name2 == 'image_link')||(feed_field_name2 == 'additional_image_link ')) {
											position_OUT += '&nbsp;&nbsp;&nbsp;&nbsp;' + feed_field_name2 + ' ' + "<img src='" + field_value2 + "' height='70'><br>\n";
										} else {
											position_OUT += '&nbsp;&nbsp;&nbsp;&nbsp;' + feed_field_name2 + ' ' + '<b>' + field_value2 + "</b><br>\n";
										}
									}
			

							}

						} else {

							if (field_value) {

									//создаем ссылки на страницы и фото для всех вариантов их названий
									if ((feed_field_name == 'link')||(feed_field_name == 'mobile_link')) {
										position_OUT += feed_field_name + ' ' + '<a href="' + field_value + '">' + field_value + "</a><br>\n";
									} else if ((feed_field_name == 'image_link')||(feed_field_name == 'additional_image_link ')) {
										position_OUT += feed_field_name + ' ' + "<img src='" + field_value + "' height='70'><br>\n";
									} else {
										position_OUT += feed_field_name + ' ' + '<b>' + field_value + "</b><br>\n";
									}

							}

						}



					}
				}

				if (position_OUT) {
					position_OUT = "<hr>\n" + position_OUT + "\n";
				}

				return position_OUT;

		},
		'.ga.xml': function(feed_file_ext,feed_fields_file_types,checkedfields) {

//Спецификация RSS 2.0
//https://support.google.com/merchants/answer/160589

				var position_OUT = '';

				for (var feed_field_name in feed_fields_file_types[feed_file_ext]) {
//feed_field_name - реальное имя поля, записываемое в файл фида (для мультиполей - это multifield_name, для обычных полей - это field_name)

					if ({}.toString.call(feed_fields_file_types[feed_file_ext][feed_field_name]) === '[object Array]') {
//значение feed_field_name - это массив field_name для мультиполя multifield_name

						for (var i = 0; i < feed_fields_file_types[feed_file_ext][feed_field_name].length; i++) {
//получаем field_name для каждого multifield_name = feed_fields_file_types[feed_file_ext][feed_field_name][i]

							var field_name = feed_fields_file_types[feed_file_ext][feed_field_name][i];

							var field_value = checkedfields[field_name]['field_value'];
							var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
							var checkedfields2 = null;
							if (checkedfields[field_name]['include_attributes']) {
								var input = field_value.split(/[\n]+/);
//								if (input.length) {
									checkedfields2 = {}
									for (var iii = 0; iii < input.length; iii += 2) {
										var field_name2 = input[iii];
										var field_value2 = input[iii+1];

										if (htmlencode) {
											field_value2 = Encoder.XSSEncode(field_value2);
										} else {
											var tmp_field_value = Encoder.XSSEncode(field_value2);
											if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
												field_value2 = '<![CDATA[' + field_value2 + ']]>';
											}
										}
										checkedfields2[field_name2] = field_value2;
									}
//								}
							}
							if (!checkedfields2) {
								if (htmlencode) {
									field_value = Encoder.XSSEncode(field_value);
								} else {
									var tmp_field_value = Encoder.XSSEncode(field_value);
									if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
										field_value = '<![CDATA[' + field_value + ']]>';
									}
								}
							}
							if (checkedfields2) {
								//есть вложенные аттрибуты
								if (Object.keys(checkedfields2).length) {

									position_OUT += "\t\t\t<g:" + feed_field_name + ">\n";
									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
										position_OUT += "\t\t\t\t<g:" + feed_field_name2 + '>' + field_value2 + '</g:' + feed_field_name2 + ">\n";
									}
									position_OUT += "\t\t\t</g:" + feed_field_name + ">\n";


								}
							} else {
								if (field_value) {

									position_OUT += "\t\t\t<g:" + feed_field_name + '>' + field_value + '</g:' + feed_field_name + ">\n";

								}
							}


						}



					} else {
//значение feed_field_name - равно 1, это обычное немультиполе field_name

//получаем field_name (не мультиполе) 
						var field_name = feed_field_name;

						var field_value = checkedfields[field_name]['field_value'];
						var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
						var checkedfields2 = null;
						if (checkedfields[field_name]['include_attributes']) {
							var input = field_value.split(/[\n]+/);
//							if (input.length) {
								checkedfields2 = {}
								for (var iii = 0; iii < input.length; iii += 2) {
									var field_name2 = input[iii];
									var field_value2 = input[iii+1];

									if (htmlencode) {
										field_value2 = Encoder.XSSEncode(field_value2);
									} else {
										var tmp_field_value = Encoder.XSSEncode(field_value2);
										if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
											field_value2 = '<![CDATA[' + field_value2 + ']]>';
										}
									}
									checkedfields2[field_name2] = field_value2;

								}
//							}
						}
						if (!checkedfields2) {
							if (htmlencode) {
								field_value = Encoder.XSSEncode(field_value);
							} else {
								var tmp_field_value = Encoder.XSSEncode(field_value);
								if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
									field_value = '<![CDATA[' + field_value + ']]>';
								}
							}
						}
						if (checkedfields2) {
							//есть вложенные аттрибуты
							if (Object.keys(checkedfields2).length) {

									position_OUT += "\t\t\t<g:" + feed_field_name + ">\n";
									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
										position_OUT += "\t\t\t\t<g:" + feed_field_name2 + '>' + field_value2 + '</g:' + feed_field_name2 + ">\n";
									}
									position_OUT += "\t\t\t</g:" + feed_field_name + ">\n";

							}
						} else {
							if (field_value) {

									position_OUT += "\t\t\t<g:" + feed_field_name + '>' + field_value + '</g:' + feed_field_name + ">\n";
							}
						}



					}
				}

				if (position_OUT) {
					position_OUT = "\t\t<item>\n" + position_OUT + "\t\t</item>\n";
				}

				return position_OUT;

		},
		'.ga.txt': function(feed_file_ext,feed_fields_file_types,checkedfields) {

				var position_OUT = '';
				var position_NUM = 0;

				for (var feed_field_name in feed_fields_file_types[feed_file_ext]) {
//feed_field_name - реальное имя поля, записываемое в файл фида (для мультиполей - это multifield_name, для обычных полей - это field_name)

					var one_field_value = '';


					if ({}.toString.call(feed_fields_file_types[feed_file_ext][feed_field_name]) === '[object Array]') {
//значение feed_field_name - это массив field_name для мультиполя multifield_name

						for (var i = 0; i < feed_fields_file_types[feed_file_ext][feed_field_name].length; i++) {
//получаем field_name для каждого multifield_name = feed_fields_file_types[feed_file_ext][feed_field_name][i]

							var field_name = feed_fields_file_types[feed_file_ext][feed_field_name][i];

							var field_value = checkedfields[field_name]['field_value'];
							var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
							var checkedfields2 = null;
							if (checkedfields[field_name]['include_attributes']) {
								var input = field_value.split(/[\n]+/);
//								if (input.length) {
									checkedfields2 = {}
									for (var iii = 0; iii < input.length; iii += 2) {
										var field_name2 = input[iii];
										var field_value2 = input[iii+1];
/*
для csv не восстанавливаем сущности
										if (htmlencode) {
											field_value2 = Encoder.XSSEncode(field_value2);
										} else {
											var tmp_field_value = Encoder.XSSEncode(field_value2);
											if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
												field_value2 = '<![CDATA[' + field_value2 + ']]>';
											}
										}
*/
										checkedfields2[field_name2] = field_value2;
									}
//								}
							}
							if (!checkedfields2) {
/*
для csv не восстанавливаем сущности
								if (htmlencode) {
									field_value = Encoder.XSSEncode(field_value);
								} else {
									var tmp_field_value = Encoder.XSSEncode(field_value);
									if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
										field_value = '<![CDATA[' + field_value + ']]>';
									}
								}
*/
							}
							if (checkedfields2) {
								//есть вложенные аттрибуты
								if (Object.keys(checkedfields2).length) {

									var include_attr_field_value = '';

									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
										field_value2 = field_value2.replace(/\s*\,+\s*/igm, ' ');
//сохраняем последовательность в т.ч. пустых вложенных атрибутов (согласно примера google)
//										if (field_value2) {
											if (include_attr_field_value) {
												include_attr_field_value += ':' + field_value2
											} else {
												include_attr_field_value = field_value2;
											}
//										}
									}

									if (include_attr_field_value) {
										if (one_field_value) {
											one_field_value += ',' + include_attr_field_value;
										} else {
											one_field_value = include_attr_field_value;
										}
									}


								}
							} else {
								if (field_value) {

									field_value = field_value.replace(/\s*\,+\s*/igm, ' ');
									if (field_value) {
										if (one_field_value) {
											one_field_value += ',' + field_value;
										} else {
											one_field_value = field_value;
										}
									}


								}
							}


						}





					} else {
//значение feed_field_name - равно 1, это обычное немультиполе field_name

//получаем field_name (не мультиполе) 
						var field_name = feed_field_name;

						var field_value = checkedfields[field_name]['field_value'];
						var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
						var checkedfields2 = null;
						if (checkedfields[field_name]['include_attributes']) {
							var input = field_value.split(/[\n]+/);
//							if (input.length) {
								checkedfields2 = {}
								for (var iii = 0; iii < input.length; iii += 2) {
									var field_name2 = input[iii];
									var field_value2 = input[iii+1];
/*
для csv не восстанавливаем сущности
									if (htmlencode) {
										field_value2 = Encoder.XSSEncode(field_value2);
									} else {
										var tmp_field_value = Encoder.XSSEncode(field_value2);
										if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
											field_value2 = '<![CDATA[' + field_value2 + ']]>';
										}
									}
*/
									checkedfields2[field_name2] = field_value2;

								}
//							}
						}
						if (!checkedfields2) {
/*
для csv не восстанавливаем сущности
							if (htmlencode) {
								field_value = Encoder.XSSEncode(field_value);
							} else {
								var tmp_field_value = Encoder.XSSEncode(field_value);
								if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
									field_value = '<![CDATA[' + field_value + ']]>';
								}
							}
*/
						}
						if (checkedfields2) {
							//есть вложенные аттрибуты
							if (Object.keys(checkedfields2).length) {

									var include_attr_field_value = '';

									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
//для обычных полей не удаляем запятые
//										field_value2 = field_value2.replace(/\s*\,+\s*/igm, ' ');
//сохраняем последовательность в т.ч. пустых вложенных атрибутов (согласно примера google)
//										if (field_value2) {
											if (include_attr_field_value) {
												include_attr_field_value += ':' + field_value2
											} else {
												include_attr_field_value = field_value2;
											}
//										}
									}

									if (include_attr_field_value) {
										if (one_field_value) {
//сюда не зайдет, оставлено для единообразия с мультиполями
											one_field_value += ',' + include_attr_field_value;
										} else {
											one_field_value = include_attr_field_value;
										}
									}


							}
						} else {
							if (field_value) {

//для обычных полей не удаляем запятые
//									field_value = field_value.replace(/\s*\,+\s*/igm, ' ');
									if (field_value) {
										if (one_field_value) {
//сюда не зайдет, оставлено для единообразия с мультиполями
											one_field_value += ',' + field_value;
										} else {
											one_field_value = field_value;
										}
									}

							}
						}



					}

//пишем в т.ч. пустые поля
					if (position_NUM) {
						position_OUT += "\t" + one_field_value;
					} else {
						position_OUT = one_field_value;
					}
					position_NUM++;


				}

				return position_OUT + "\n";

		},
		'.ga.tsv': function(feed_file_ext,feed_fields_file_types,checkedfields) {
//полностью идентично .ga.txt (возможно потребуется для динамического ремаркетинга)

				var position_OUT = '';
				var position_NUM = 0;

				for (var feed_field_name in feed_fields_file_types[feed_file_ext]) {
//feed_field_name - реальное имя поля, записываемое в файл фида (для мультиполей - это multifield_name, для обычных полей - это field_name)

					var one_field_value = '';


					if ({}.toString.call(feed_fields_file_types[feed_file_ext][feed_field_name]) === '[object Array]') {
//значение feed_field_name - это массив field_name для мультиполя multifield_name

						for (var i = 0; i < feed_fields_file_types[feed_file_ext][feed_field_name].length; i++) {
//получаем field_name для каждого multifield_name = feed_fields_file_types[feed_file_ext][feed_field_name][i]

							var field_name = feed_fields_file_types[feed_file_ext][feed_field_name][i];

							var field_value = checkedfields[field_name]['field_value'];
							var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
							var checkedfields2 = null;
							if (checkedfields[field_name]['include_attributes']) {
								var input = field_value.split(/[\n]+/);
//								if (input.length) {
									checkedfields2 = {}
									for (var iii = 0; iii < input.length; iii += 2) {
										var field_name2 = input[iii];
										var field_value2 = input[iii+1];
/*
для csv не восстанавливаем сущности
										if (htmlencode) {
											field_value2 = Encoder.XSSEncode(field_value2);
										} else {
											var tmp_field_value = Encoder.XSSEncode(field_value2);
											if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
												field_value2 = '<![CDATA[' + field_value2 + ']]>';
											}
										}
*/
										checkedfields2[field_name2] = field_value2;
									}
//								}
							}
							if (!checkedfields2) {
/*
для csv не восстанавливаем сущности
								if (htmlencode) {
									field_value = Encoder.XSSEncode(field_value);
								} else {
									var tmp_field_value = Encoder.XSSEncode(field_value);
									if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
										field_value = '<![CDATA[' + field_value + ']]>';
									}
								}
*/
							}
							if (checkedfields2) {
								//есть вложенные аттрибуты
								if (Object.keys(checkedfields2).length) {

									var include_attr_field_value = '';

									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
										field_value2 = field_value2.replace(/\s*\,+\s*/igm, ' ');
//сохраняем последовательность в т.ч. пустых вложенных атрибутов (согласно примера google)
//										if (field_value2) {
											if (include_attr_field_value) {
												include_attr_field_value += ':' + field_value2
											} else {
												include_attr_field_value = field_value2;
											}
//										}
									}

									if (include_attr_field_value) {
										if (one_field_value) {
											one_field_value += ',' + include_attr_field_value;
										} else {
											one_field_value = include_attr_field_value;
										}
									}


								}
							} else {
								if (field_value) {

									field_value = field_value.replace(/\s*\,+\s*/igm, ' ');
									if (field_value) {
										if (one_field_value) {
											one_field_value += ',' + field_value;
										} else {
											one_field_value = field_value;
										}
									}


								}
							}


						}





					} else {
//значение feed_field_name - равно 1, это обычное немультиполе field_name

//получаем field_name (не мультиполе) 
						var field_name = feed_field_name;

						var field_value = checkedfields[field_name]['field_value'];
						var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
						var checkedfields2 = null;
						if (checkedfields[field_name]['include_attributes']) {
							var input = field_value.split(/[\n]+/);
//							if (input.length) {
								checkedfields2 = {}
								for (var iii = 0; iii < input.length; iii += 2) {
									var field_name2 = input[iii];
									var field_value2 = input[iii+1];
/*
для csv не восстанавливаем сущности
									if (htmlencode) {
										field_value2 = Encoder.XSSEncode(field_value2);
									} else {
										var tmp_field_value = Encoder.XSSEncode(field_value2);
										if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
											field_value2 = '<![CDATA[' + field_value2 + ']]>';
										}
									}
*/
									checkedfields2[field_name2] = field_value2;

								}
//							}
						}
						if (!checkedfields2) {
/*
для csv не восстанавливаем сущности
							if (htmlencode) {
								field_value = Encoder.XSSEncode(field_value);
							} else {
								var tmp_field_value = Encoder.XSSEncode(field_value);
								if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
									field_value = '<![CDATA[' + field_value + ']]>';
								}
							}
*/
						}
						if (checkedfields2) {
							//есть вложенные аттрибуты
							if (Object.keys(checkedfields2).length) {

									var include_attr_field_value = '';

									for (var feed_field_name2 in checkedfields2) {
										var field_value2 = checkedfields2[feed_field_name2];
//для обычных полей не удаляем запятые
//										field_value2 = field_value2.replace(/\s*\,+\s*/igm, ' ');
//сохраняем последовательность в т.ч. пустых вложенных атрибутов (согласно примера google)
//										if (field_value2) {
											if (include_attr_field_value) {
												include_attr_field_value += ':' + field_value2
											} else {
												include_attr_field_value = field_value2;
											}
//										}
									}

									if (include_attr_field_value) {
										if (one_field_value) {
//сюда не зайдет, оставлено для единообразия с мультиполями
											one_field_value += ',' + include_attr_field_value;
										} else {
											one_field_value = include_attr_field_value;
										}
									}


							}
						} else {
							if (field_value) {

//для обычных полей не удаляем запятые
//									field_value = field_value.replace(/\s*\,+\s*/igm, ' ');
									if (field_value) {
										if (one_field_value) {
//сюда не зайдет, оставлено для единообразия с мультиполями
											one_field_value += ',' + field_value;
										} else {
											one_field_value = field_value;
										}
									}

							}
						}



					}

//пишем в т.ч. пустые поля
					if (position_NUM) {
						position_OUT += "\t" + one_field_value;
					} else {
						position_OUT = one_field_value;
					}
					position_NUM++;


				}

				return position_OUT + "\n";

		}

	}

//пример для динамического ремаркетинга (старый вариант) разделитель - запятая для CSV, но может быть TSV (табуляция)
//https://webpromoexperts.com.ua/blog/dinamicheskij-remarketing/
//https://sotnik.biz.ua/articles/dinamicheskiy_remarketing_nastroyka_raznymi_sposobami/

//на потом
//описание фидов яндекса
//https://yandex.ru/support/direct/smart-banners/feeds.html
//подробнее yml
//https://yandex.ru/support/partnermarket/export/yml.html#about-yml
//описание csv - сделать расширение tsv (аналогично гугл, с табуляцией)
//https://yandex.ru/support/partnermarket/export/yml.html#text-csv
//		'.yml.xml': function(feed_file_ext,feed_fields_file_types,checkedfields) {
//		},
//		'.yrl.xml': function(feed_file_ext,feed_fields_file_types,checkedfields) {
//		},
//		'.ycar.xml': function(feed_file_ext,feed_fields_file_types,checkedfields) {
//		},
//		'.ya.tsv': function(feed_file_ext,feed_fields_file_types,checkedfields) {
//		}


/*
оставил начальную заготовку, если буду еще добавлять другие расширения
				var position_OUT = '';

				for (var feed_field_name in feed_fields_file_types[feed_file_ext]) {
//feed_field_name - реальное имя поля, записываемое в файл фида (для мультиполей - это multifield_name, для обычных полей - это field_name)

					if ({}.toString.call(feed_fields_file_types[feed_file_ext][feed_field_name]) === '[object Array]') {
//значение feed_field_name - это массив field_name для мультиполя multifield_name

						for (var i = 0; i < feed_fields_file_types[feed_file_ext][feed_field_name].length; i++) {
//получаем field_name для каждого multifield_name = feed_fields_file_types[feed_file_ext][feed_field_name][i]

							var field_name = feed_fields_file_types[feed_file_ext][feed_field_name][i];

							var field_value = checkedfields[field_name]['field_value'];
							var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
							var checkedfields2 = null;
							if (checkedfields[field_name]['include_attributes']) {
								var input = field_value.split(/[\n]+/);
//								if (input.length) {
									checkedfields2 = {}
									for (var iii = 0; iii < input.length; iii += 2) {
										var field_name2 = input[iii];
										var field_value2 = input[iii+1];

										if (htmlencode) {
											field_value2 = Encoder.XSSEncode(field_value2);
										} else {
											var tmp_field_value = Encoder.XSSEncode(field_value2);
											if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
												field_value2 = '<![CDATA[' + field_value2 + ']]>';
											}
										}
										checkedfields2[field_name2] = field_value2;
									}
//								}
							}
							if (!checkedfields2) {
								if (htmlencode) {
									field_value = Encoder.XSSEncode(field_value);
								} else {
									var tmp_field_value = Encoder.XSSEncode(field_value);
									if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
										field_value = '<![CDATA[' + field_value + ']]>';
									}
								}
							}
							if (checkedfields2) {
								//есть вложенные аттрибуты
								if (Object.keys(checkedfields2).length) {


								}
							} else {
								if (field_value) {


								}
							}


						}



					} else {
//значение feed_field_name - равно 1, это обычное немультиполе field_name

//получаем field_name (не мультиполе) 
						var field_name = feed_field_name;

						var field_value = checkedfields[field_name]['field_value'];
						var htmlencode = checkedfields[field_name]['field_config']['htmlencode'];
						var checkedfields2 = null;
						if (checkedfields[field_name]['include_attributes']) {
							var input = field_value.split(/[\n]+/);
//							if (input.length) {
								checkedfields2 = {}
								for (var iii = 0; iii < input.length; iii += 2) {
									var field_name2 = input[iii];
									var field_value2 = input[iii+1];

									if (htmlencode) {
										field_value2 = Encoder.XSSEncode(field_value2);
									} else {
										var tmp_field_value = Encoder.XSSEncode(field_value2);
										if (tmp_field_value !== field_value2) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
											field_value2 = '<![CDATA[' + field_value2 + ']]>';
										}
									}
									checkedfields2[field_name2] = field_value2;

								}
//							}
						}
						if (!checkedfields2) {
							if (htmlencode) {
								field_value = Encoder.XSSEncode(field_value);
							} else {
								var tmp_field_value = Encoder.XSSEncode(field_value);
								if (tmp_field_value !== field_value) {
//Что бы уменьшить код - не добавляем CDATA, если при восстановлении html-сущностей данные не изменяться - если в значении поля нет символов " & < > и др.
									field_value = '<![CDATA[' + field_value + ']]>';
								}
							}
						}
						if (checkedfields2) {
							//есть вложенные аттрибуты
							if (Object.keys(checkedfields2).length) {


							}
						} else {
							if (field_value) {


							}
						}



					}
				}

				return position_OUT;

*/



	var addtofeed = 0;

	for (var feed_file_ext in feed_fields_file_types) {
//feed_file_ext - это допустимые расширения файлов фидов - '.html', '.ga.xml', '.ga.txt', '.ga.tsv', '.yml.xml', '.yrl.xml', '.ycar.xml', '.ya.tsv'

        	try {
			if (!OneFeedFilesOUT.hasOwnProperty(feed_file_ext)) {
				OneFeedFilesOUT[feed_file_ext]='';
			}
			var OUT_ext = correctfeedExtPositionFunctions[feed_file_ext](feed_file_ext,feed_fields_file_types,checkedfields);
			if (OUT_ext) {
				OneFeedFilesOUT[feed_file_ext] += OUT_ext;
				addtofeed = 1;
			}

		} catch (e) {
			ScanCreateFeedsGlobalVars.errors += 'bad field_type: ' + feed_file_ext + " in correctfeedExtPositionFunctions, check script code\n";
			Logger.log(ScanCreateFeedsGlobalVars.errors);
			return 0;
		}


	}

	return addtofeed;

}


function ParceFeedFields(html,fullhtml,OneFeedConfig,OneSiteConfig,URLID,url,referrer_url,feedsfields) {
//находим все поля фида

	var checkedfields = {};
        var referrer_field_value = ''

	var search_exist = 1;
	//var search_flg = OneFeedConfig['GASearch']&&OneFeedConfig['GASearch']['Id'];
	var search_flg = OneFeedConfig['GASearch']&&(OneFeedConfig['GASearch']['Id'] || OneFeedConfig['GASearch']['GAShtml']);
//ниже условие надо добавить, долго объяснять почему, иначе - например есть два поля в фиде, оба имеют field_required = 4 и нет настройки поиска (GASearch) но есть генерации файлов фида, то при пустом одном и непустом втором запись будет создана, что неправильно
	if ((!search_flg)&&(!OneFeedConfig['all_fields_not_required']))
		search_exist = 0;

	var feedfiles_exist = 1;
	var feedfiles_flg = Object.keys(OneFeedConfig['feed_fields_file_types']).length;
//ниже условие надо добавить, долго объяснять почему, иначе - например есть два поля в фиде, оба имеют field_required = 5 и есть настройка поиска (GASearch) но нет генерации файлов фида, то при пустом одном и непустом втором запись будет создана, что неправильно
	if ((!feedfiles_flg)&&(!OneFeedConfig['all_fields_not_required']))
		feedfiles_exist = 0;

	for (var i in OneFeedConfig) {
//перебираем разрешенные сейчас поля фида сайта
		if (OneFeedConfig['fields'][i]) {
			var fieldId = i;
			var fieldHash = OneFeedConfig[fieldId];

			var field_name = fieldHash['field_name'];

			if (checkedfields[field_name]&&checkedfields[field_name]['field_value']) {
				//если поле имеет непустое значение, то пропускаем (дубликат поля - не ошибка)
				continue;
			}

			var field_type = fieldHash['field_type'];
			var field_required = fieldHash['field_required'];
			var field_value = '';

//флаг поля с вложенными атрибутами (полями и их значениями)
			var include_attributes = 0;

			if (fieldHash.hasOwnProperty('field_length')) {
				var field_length = fieldHash['field_length'];
				if ((typeof field_length !== 'string')&&(typeof field_length !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_length, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}
				if (!/^\d+$/.test(field_length)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_length, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}
				field_length = field_length * 1; //переводим в число
			} else {
				var field_length = 0;
			}

			if (field_type === 'html') {

				if (typeof fieldHash['parsing_type'] !== 'string') {
					ScanCreateFeedsGlobalVars.errors += 'bad parsing_type, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				var badf = 0;
				var fvsArr = 0;
				if (fieldHash['field_value_selector']) {
					if (typeof fieldHash['field_value_selector'] === 'string') {
					} else if (({}.toString.call(fieldHash['field_value_selector']) === '[object Array]')&&fieldHash['field_value_selector'].length) {
						fvsArr = 1;
						for (var ii = 0; ii < fieldHash['field_value_selector'].length; ii++) {
							if ((typeof fieldHash['field_value_selector'][ii] !== 'string') || (!fieldHash['field_value_selector'][ii])) {
								badf = 1;
							}
						}
					} else {
						badf = 1;
					}
				} else if (typeof fieldHash['field_value_selector'] !== 'string') {
					badf = 1;
				}


				if (badf) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				var htmlhtml = html;

				if (fvsArr) {
					for (var ii = 0; ii < fieldHash['field_value_selector'].length - 1; ii++) {
						var h = parseHtml(htmlhtml, fieldHash['field_value_selector'][ii], 'text');
						if (h['errors']) {
							ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
							return;
						} else {
							htmlhtml = h['result'];
						}
					}
					var field_value_selector = fieldHash['field_value_selector'][fieldHash['field_value_selector'].length - 1];
				} else {
					var field_value_selector = fieldHash['field_value_selector'];
				}


				if ((fieldHash['parsing_type'] == 'iso4217price')||(fieldHash['parsing_type'] == 'nativeprice')) {
					var h = parseHtml(htmlhtml, field_value_selector, 'text', fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;

					} else if (h['result']) {
						if (fieldHash['parsing_type'] == 'nativeprice') {
							//nativeprice
				
							var parsedcena = getPriceCurrencyFromStr(h['result']);
		
							if (parsedcena[0]&&parsedcena[0][0]&&parsedcena[1]&&parsedcena[1][0]) {

								if (parsedcena[1][1]) {
									field_value = parsedcena[0][0] + ' ' + parsedcena[1][1];
								} else {
									field_value = parsedcena[0][0] + ' ' + parsedcena[1][0];
								}
							
							}

						} else {

							//iso4217price

							var parsedcena = getPriceCurrencyFromStr(h['result']);

							if (parsedcena[0]&&parsedcena[0][1]&&parsedcena[1]&&parsedcena[1][0]) {

								field_value = parsedcena[0][1] + ' ' + parsedcena[1][0];
						
							}



						}
					}




				} else {
					var h = parseHtml(htmlhtml, field_value_selector, fieldHash['parsing_type'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);
					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else {
						field_value = h['result'];

						field_value = digitkeysproc(field_value,fieldHash['field_digitkeys']);
					}
				}



//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


				if ((fieldHash['parsing_type'] == 'iso4217price')||(fieldHash['parsing_type'] == 'nativeprice')) {
//					if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
					if (field_length) {
//системный параметр
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
						ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}
				} else if ((fieldHash['parsing_type'] == 'text')||(fieldHash['parsing_type'] === '')) {

					field_value = getMaxStr(field_value, field_length);

				} else {
//					if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
					if (field_length) {
//src href и др. атрибуты тега селектора
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
						ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}

				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


			} else if (field_type === 'fullhtml') {
			//копия предыдущего пункта, но для fullhtml

				if (typeof fieldHash['parsing_type'] !== 'string') {
					ScanCreateFeedsGlobalVars.errors += 'bad parsing_type, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				var badf = 0;
				var fvsArr = 0;
				if (fieldHash['field_value_selector']) {
					if (typeof fieldHash['field_value_selector'] === 'string') {
					} else if (({}.toString.call(fieldHash['field_value_selector']) === '[object Array]')&&fieldHash['field_value_selector'].length) {
						fvsArr = 1;
						for (var ii = 0; ii < fieldHash['field_value_selector'].length; ii++) {
							if ((typeof fieldHash['field_value_selector'][ii] !== 'string') || (!fieldHash['field_value_selector'][ii])) {
								badf = 1;
							}
						}
					} else {
						badf = 1;
					}
				} else if (typeof fieldHash['field_value_selector'] !== 'string') {
					badf = 1;
				}


				if (badf) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				var htmlhtml = fullhtml;

				if (fvsArr) {
					for (var ii = 0; ii < fieldHash['field_value_selector'].length - 1; ii++) {
						var h = parseHtml(htmlhtml, fieldHash['field_value_selector'][ii], 'text');
						if (h['errors']) {
							ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
							return;
						} else {
							htmlhtml = h['result'];
						}
					}
					var field_value_selector = fieldHash['field_value_selector'][fieldHash['field_value_selector'].length - 1];
				} else {
					var field_value_selector = fieldHash['field_value_selector'];
				}


				if ((fieldHash['parsing_type'] == 'iso4217price')||(fieldHash['parsing_type'] == 'nativeprice')) {
					var h = parseHtml(htmlhtml, field_value_selector, 'text', fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;

					} else if (h['result']) {
						if (fieldHash['parsing_type'] == 'nativeprice') {
							//nativeprice
				
							var parsedcena = getPriceCurrencyFromStr(h['result']);
		
							if (parsedcena[0]&&parsedcena[0][0]&&parsedcena[1]&&parsedcena[1][0]) {

								if (parsedcena[1][1]) {
									field_value = parsedcena[0][0] + ' ' + parsedcena[1][1];
								} else {
									field_value = parsedcena[0][0] + ' ' + parsedcena[1][0];
								}
							
							}

						} else {

							//iso4217price

							var parsedcena = getPriceCurrencyFromStr(h['result']);

							if (parsedcena[0]&&parsedcena[0][1]&&parsedcena[1]&&parsedcena[1][0]) {

								field_value = parsedcena[0][1] + ' ' + parsedcena[1][0];
						
							}



						}
					}




				} else {
					var h = parseHtml(htmlhtml, field_value_selector, fieldHash['parsing_type'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);
					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else {
						field_value = h['result'];

						field_value = digitkeysproc(field_value,fieldHash['field_digitkeys']);
					}
				}



//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


				if ((fieldHash['parsing_type'] == 'iso4217price')||(fieldHash['parsing_type'] == 'nativeprice')) {
//					if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
					if (field_length) {
//системный параметр
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
						ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}
				} else if ((fieldHash['parsing_type'] == 'text')||(fieldHash['parsing_type'] === '')) {

					field_value = getMaxStr(field_value, field_length);

				} else {
//					if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
					if (field_length) {
//src href и др. атрибуты тега селектора
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
						ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}

				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}



			} else if (({}.toString.call(field_type) === '[object Array]')&&(field_type.length == 2)) {


				if ((typeof field_type[0] !== 'string')||(!field_type[0])||(typeof field_type[1] !== 'string')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_type, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

//				var fields = field_type[0].split(/[\s\,]+/);
				var fields = field_type[0].split(/[\s\,]*\,[\s\,]*/);


//если отрицательное, то нельзя использовать в "хлебных крошках" и др. вариантах, требующих обязательного последовательного присутствия всех полей
				var NotEmptyFields = 0;
				var FoundEmptyField = 0;

//при конкатенации, если есть ограничение по длине, то ограничиваем по разделителю
				var MaxLengthFound = 0;

				var AddToValue = 1;

				var tmp_field_length = field_length;
				if (fieldHash['parsing_type']) {
//системный параметр (iso4217price или nativeprice)
//не обрезаем поле по field_length
					field_length = 0;
				}


				for (var ii = 0; ii < fields.length; ii++) {
					if (checkedfields[fields[ii]]&&checkedfields[fields[ii]]['field_value']) {
						if (FoundEmptyField) {
//обнаружено пустое или несуществующее поле в последовательности полей и потом опять непустое (как минимум один раз)
							NotEmptyFields = -1;
						} else {
							NotEmptyFields++;
						}
						if ((field_required === 3)&&((ii >= fields.length - 1)||(!(checkedfields[fields[ii+1]]&&checkedfields[fields[ii+1]]['field_value'])))) {
							//должно быть на один меньше элементов в обязательной полследовательной конкатенации
							AddToValue = 0;
						}
						if (AddToValue) {
							if (field_length) {
								if (!MaxLengthFound) {
									if (field_value) {
										var tmp_field_value = field_type[1] + checkedfields[fields[ii]]['field_value'];
									} else {
										var tmp_field_value = checkedfields[fields[ii]]['field_value'];
									}
									if (tmp_field_value.length > field_length) {
										MaxLengthFound = 1;
									} else {
										field_value += tmp_field_value;
									}
								}
							} else {
								if (field_value) {
									field_value += field_type[1] + checkedfields[fields[ii]]['field_value'];
								} else {
									field_value = checkedfields[fields[ii]]['field_value'];
								}
							}
						}
					} else {
						FoundEmptyField = 1;
					}
				}
				field_length = tmp_field_length;



				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else if (h['result']) {
						if (fieldHash['parsing_type']) {
							if (fieldHash['parsing_type'] === 'nativeprice') {
								//nativeprice
				
								var parsedcena = getPriceCurrencyFromStr(h['result']);
		
								if (parsedcena[0]&&parsedcena[0][0]&&parsedcena[1]&&parsedcena[1][0]) {

									if (parsedcena[1][1]) {
										field_value = parsedcena[0][0] + ' ' + parsedcena[1][1];
									} else {
										field_value = parsedcena[0][0] + ' ' + parsedcena[1][0];
									}
							
								}

							} else if (fieldHash['parsing_type'] === 'iso4217price') {

								//iso4217price

								var parsedcena = getPriceCurrencyFromStr(h['result']);

								if (parsedcena[0]&&parsedcena[0][1]&&parsedcena[1]&&parsedcena[1][0]) {

									field_value = parsedcena[0][1] + ' ' + parsedcena[1][0];
						
								}



							} else {
								ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						} else {
							field_value = h['result'];
							field_value = digitkeysproc(field_value,fieldHash['field_digitkeys']);
						}
					}

				}


//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}



				if (fieldHash['parsing_type']) {
//					if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
					if (field_length) {
//системный параметр (iso4217price или nativeprice)
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
						ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}
				}



//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					if (NotEmptyFields < 0) {
//обнаружено пустое или несуществующее поле в последовательности полей и потом опять непустое (как минимум один раз)
						return;
					}
				} else if (field_required === 3) {
					if (NotEmptyFields < 0) {
//обнаружено пустое или несуществующее поле в последовательности полей и потом опять непустое (как минимум один раз)
						return;
					}
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							}
						}
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}



			} else if (({}.toString.call(field_type) === '[object Array]')&&(field_type.length == 1)) {
//конкатенация в виде вложенных аттрибутов сделана из обычной конкатенации (код выше)

				include_attributes = 1;

				if ((typeof field_type[0] !== 'string')||(!field_type[0])) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_type, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

//				var fields = field_type[0].split(/[\s\,]+/);
				var fields = field_type[0].split(/[\s\,]*\,[\s\,]*/);


//если отрицательное, то нельзя использовать в "хлебных крошках" и др. вариантах, требующих обязательного последовательного присутствия всех полей
				var NotEmptyFields = 0;
				var FoundEmptyField = 0;


				var AddToValue = 1;


				for (var ii = 0; ii < fields.length; ii++) {
					if (checkedfields[fields[ii]]&&checkedfields[fields[ii]]['field_value']) {
						if (FoundEmptyField) {
//обнаружено пустое или несуществующее поле в последовательности полей и потом опять непустое (как минимум один раз)
							NotEmptyFields = -1;
						} else {
							NotEmptyFields++;
						}
						if ((field_required === 3)&&((ii >= fields.length - 1)||(!(checkedfields[fields[ii+1]]&&checkedfields[fields[ii+1]]['field_value'])))) {
							//должно быть на один меньше элементов в обязательной полследовательной конкатенации
							AddToValue = 0;
						}
						if (AddToValue) {
							if (field_value) {
								field_value += "\n" + fields[ii] + "\n" + checkedfields[fields[ii]]['field_value'];
							} else {
								field_value = fields[ii] + "\n" + checkedfields[fields[ii]]['field_value'];
							}
						}
					} else {
						FoundEmptyField = 1;
					}
				}


				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (fieldHash['parsing_type']) {
						//здесь не должно быть точно, во всех других полях может быть парсинг цены
						ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}


					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else {
						field_value = h['result'];
					}

				}


				if (field_length) {
//не должно присутствовать ограничения длины
					ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					if (NotEmptyFields < 0) {
//обнаружено пустое или несуществующее поле в последовательности полей и потом опять непустое (как минимум один раз)
						return;
					}
				} else if (field_required === 3) {
					if (NotEmptyFields < 0) {
//обнаружено пустое или несуществующее поле в последовательности полей и потом опять непустое (как минимум один раз)
						return;
					}
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							}
						}
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}




			} else if (field_type === 'fixed') {


				if (typeof fieldHash['field_value_selector'] !== 'string') {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				field_value = fieldHash['field_value_selector'];

				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else if (h['result']) {
						if (fieldHash['parsing_type']) {
							if (fieldHash['parsing_type'] === 'nativeprice') {
								//nativeprice
				
								var parsedcena = getPriceCurrencyFromStr(h['result']);
		
								if (parsedcena[0]&&parsedcena[0][0]&&parsedcena[1]&&parsedcena[1][0]) {

									if (parsedcena[1][1]) {
										field_value = parsedcena[0][0] + ' ' + parsedcena[1][1];
									} else {
										field_value = parsedcena[0][0] + ' ' + parsedcena[1][0];
									}
							
								}

							} else if (fieldHash['parsing_type'] === 'iso4217price') {

								//iso4217price

								var parsedcena = getPriceCurrencyFromStr(h['result']);

								if (parsedcena[0]&&parsedcena[0][1]&&parsedcena[1]&&parsedcena[1][0]) {

									field_value = parsedcena[0][1] + ' ' + parsedcena[1][0];
						
								}



							} else {
								ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						} else {
							field_value = h['result'];
							field_value = digitkeysproc(field_value,fieldHash['field_digitkeys']);
						}
					}


				}


//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


				if (fieldHash['parsing_type']) {
//					if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
					if (field_length) {
//системный параметр (iso4217price или nativeprice)
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
						ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}
				} else {
					field_value = getMaxStr(field_value, field_length);
				}

//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


			} else if (field_type === 'id') {

				field_value = URLID;

				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else {
						if (fieldHash['parsing_type']) {
							ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
							return;
						} else {
							field_value = h['result'];
						}
					}

				}


//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//				if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
				if (field_length) {
//системный параметр
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
					ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


			} else if (field_type === 'url') {

				field_value = url;

				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else {
						if (fieldHash['parsing_type']) {
							ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
							return;
						} else {
							field_value = h['result'];
						}
					}


				}


				if (field_value) {

//ниже обработка url подразумевает, что из ссылок удалены #...

					if (!OneFeedConfig['noDropShip']) {
						var parsed_url = parse_url(field_value);
						if (parsed_url["search"]) {
							field_value += '&';
						} else {
							field_value += '?';
						}
						field_value += 'sodship=y';

					}
					if (OneFeedConfig['utmDropShip']) {
						var parsed_url = parse_url(field_value);
						if (parsed_url["search"]) {
							field_value += '&';
						} else {
							field_value += '?';
						}
						field_value += OneFeedConfig['utmDropShip'] + OneFeedConfig['ext'];
					}
				}


//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//				if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
				if (field_length) {
//системный параметр
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
					ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}



			} else if (field_type === 'referrer_url') {

				field_value = referrer_url;

				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else {
						if (fieldHash['parsing_type']) {
							ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
							return;
						} else {
							field_value = h['result'];
						}
					}


				}


//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//				if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
				if (field_length) {
//системный параметр
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
					ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}



			} else if ((typeof field_type == 'string')&&(/^id.+$/.test(field_type))) {

				var f_name = field_type.replace(/^id(.+)$/, "$1");

				if (f_name&&checkedfields.hasOwnProperty(field_name)) {
					field_value = murmurhash3_32_gc(checkedfields[field_name], OneSiteConfig.seed);
				} else {

					ScanCreateFeedsGlobalVars.errors += 'bad field_type, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else {

						if (fieldHash['parsing_type']) {
							ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
							Logger.log(ScanCreateFeedsGlobalVars.errors);
							return;
						} else {
							field_value = h['result'];
						}

					}

				}


//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

//				if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
				if (field_length) {
//системный параметр
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
					ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}



			} else if (field_type === 'parentFeed') {


				if (!feedsfields) {
					//вся запись в родительском фиде отсутствует, выходим
					//либо нет родительского элемента, но это проверяется при старте
					return;
				}



				//дальше есть поля в записи, проверяем нужное поле

				if (!feedsfields.hasOwnProperty(fieldHash['field_value_selector'])) {
					//нет такого поля в родительском фиде
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector for field_name: ' + field_name + ", no found field in parent feed\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


				if (feedsfields[fieldHash['field_value_selector']]['include_attributes']) {
					//нельзя использовать поля вложенных атрибутов в родительских фидах
					ScanCreateFeedsGlobalVars.errors += 'bad field_name in field_value_selector, field: ' + field_name + ' in this feed, field_name ' + fieldHash['field_value_selector'] + ' in parent feed  have "include attributes" type, not use it in this feed.' + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return '';
				}

				field_value = feedsfields[fieldHash['field_value_selector']]['field_value'];

				if (field_value) {

					var h = parseHtmlFUN(field_value, fieldHash['field_value_selector'], fieldHash['field_replace'], fieldHash['field_Fun'], url, checkedfields, field_name);

					//обязательно обнуляем, иначе останеться текущее значение (дальше будет присвоено значение повторно)
					field_value = '';

					if (h['errors']) {
						ScanCreateFeedsGlobalVars.errors += 'errors ' + h['errors'] + ', field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					} else if (h['result']) {
						if (fieldHash['parsing_type']) {
							if (fieldHash['parsing_type'] === 'nativeprice') {
								//nativeprice
				
								var parsedcena = getPriceCurrencyFromStr(h['result']);
		
								if (parsedcena[0]&&parsedcena[0][0]&&parsedcena[1]&&parsedcena[1][0]) {

									if (parsedcena[1][1]) {
										field_value = parsedcena[0][0] + ' ' + parsedcena[1][1];
									} else {
										field_value = parsedcena[0][0] + ' ' + parsedcena[1][0];
									}
							
								}

							} else if (fieldHash['parsing_type'] === 'iso4217price') {

								//iso4217price

								var parsedcena = getPriceCurrencyFromStr(h['result']);

								if (parsedcena[0]&&parsedcena[0][1]&&parsedcena[1]&&parsedcena[1][0]) {

									field_value = parsedcena[0][1] + ' ' + parsedcena[1][0];
						
								}



							} else {
								ScanCreateFeedsGlobalVars.errors += 'bad parsing_type (need to remove parsing_type), field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						} else {
							field_value = h['result'];
							field_value = digitkeysproc(field_value,fieldHash['field_digitkeys']);
						}
					}


				}


//не должно быть табуляций и перевода строки в любых полях, кроме конкатенации аттрибутов (это делается программно, но есть ручные типы fixed и обычная конкатенация, надо проверять всегда обязательно для ручного ввода, для остальных - на всякий случай)
				if (/[\t\n\r]/.test(field_value)) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_value_selector value (must delete \t\n\r symbols), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

/*
получается теже требования к длине что и ниже, поэтому дубликат закомментирован

				if (fieldHash['parsing_type']) {
//					if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
					if (field_length) {
//системный параметр (iso4217price или nativeprice)
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
						ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
						Logger.log(ScanCreateFeedsGlobalVars.errors);
						return;
					}
				}
*/


//				if (field_length&&field_value&&(field_length < field_value.length)) {
//сразу убираем, иначе может вылезти потом в процессе выполнения, и заблокирует фид, так как никто такие ошибки постоянно не отслеживает
				if (field_length) {
//родительские поля любые, поэтому для этого типа полей не выполняем "умную" обрезку длины поля
//в принципе не должно устанавливаться ограничение на длину, но если оно есть и вышли за него, то выдаем ошибку
					ScanCreateFeedsGlobalVars.errors += 'bad field_length (need to remove field_length), field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


//в конце анализ field_required
				if ((typeof field_required !== 'string')&&(typeof field_required !== 'number')) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}

				if (field_required === -1) {
					if (field_value)
						return;
				} else if (field_required === 0) {
//записываем необязательное поле, в т.ч. пустое
				} else if (field_required === 4) {
					if ((!field_value)&&feedfiles_flg)
						feedfiles_exist = 0;
				} else if (field_required === 5) {
					if ((!field_value)&&search_flg)
						search_exist = 0;
				} else if (field_required === 1) {
					if (!field_value)
						return;
				} else if (field_required === 2) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (field_required === 3) {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				} else if (typeof field_required == 'string') {
					if (!fieldHash['field_Fun']) {
//если есть field_Fun, то она определяет значение необязательного зависимого поля
//						var recfields = field_required.split(/[\s\,]+/);
						var recfields = field_required.split(/[\s\,]*\,[\s\,]*/);
						var foundnotemptyfields = 0;
						for (var ii = 0; ii < recfields.length; ii++) {
							if (checkedfields[recfields[ii]]&&checkedfields[recfields[ii]]['field_value']) {
								foundnotemptyfields++;
							} else if (!checkedfields.hasOwnProperty(recfields[ii])) {
//отсутствует выше одно из полей, указанных в field_required
								ScanCreateFeedsGlobalVars.errors += 'bad field_required:'+ ' not exists field_name ' + recfields[ii] + ' in previos fields, field: ' + field_name + "\n";
								Logger.log(ScanCreateFeedsGlobalVars.errors);
								return;
							}
						}
//						if ((!fieldHash['field_Fun'])&&foundnotemptyfields) {
						if (foundnotemptyfields) {
							field_value = '';
						}
					}
				} else {
					ScanCreateFeedsGlobalVars.errors += 'bad field_required, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}


			} else {
				ScanCreateFeedsGlobalVars.errors += 'bad field_type, field: ' + field_name + "\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
				return;
			}


			if (fieldHash['keyword']) {
//				if (typeof fieldHash['keyword'] !== 'string') {
//					ScanCreateFeedsGlobalVars.errors += 'bad keyword, field: ' + field_name + "\n";
//					Logger.log(ScanCreateFeedsGlobalVars.errors);
//					return;
//				}
				field_value = KeyWordString(field_value, fieldHash['keyword']);
				if (field_value === null) {
					ScanCreateFeedsGlobalVars.errors += 'bad keyword, field: ' + field_name + "\n";
					Logger.log(ScanCreateFeedsGlobalVars.errors);
					return;
				}
			}


			//если оба флага "упали", то запись не заносится
			//могут "упасть" не все флаги
			if ((!search_exist)&&(!feedfiles_exist))
				return;


//			if (checkedfields[field_name]&&checkedfields[field_name]['field_value']) {
//				//если поле имеет непустое значение, то пропускаем (дубликат поля - не ошибка)
//				continue;
//			}


			if (fieldHash.hasOwnProperty('referrer_field')&&fieldHash['referrer_field']) {
                                referrer_field_value = field_value
			}

			checkedfields[field_name] = {field_value: field_value, field_id: fieldId, include_attributes: include_attributes, field_config: fieldHash}


		}
	}


	return { checkedfields: checkedfields, search_exist: search_exist, feedfiles_exist: feedfiles_exist, referrer_field_value: referrer_field_value};


}


function digitkeysproc(field_value,field_digitkeys) {

	if ((!field_value)||(!field_digitkeys))
		return field_value;


function replacer2(match, p1, offset, string) {

	//так как теперь еще заводим длинные слова с небольшим кол-вом цифр, то сначала проверяем кол-во цифр
	if (!(/\d.*\d.*\d/.test(p1))) {
		return match;
	}

	if (field_digitkeys == 4) {
//удаляем из текста все цифро-буквенные длинные слова
		return '';
	}

//заменяем пробелы только внутри строки, не по краям (что бы можно было потом возвратить с пробелами return key)
	var key = p1.replace(/([^\s])\s+(?=[^\s])/g, '$1');


	if (field_digitkeys != 2) {
//если только цифры и 6 цифр или больше, то удаляем вообще из текста (гугл может посчитать это номером телефона в объявлении)
		if (/^\s*\d\d\d\d\d\d+\s*$/.test(key)) {
			return '';
		}
	}

	if ((field_digitkeys != 1)&&(p1 != key)) {
		var key2 = key.trim();
//не стоит убирать пробелы во всех цифро-буквенных словах запроса, можно получить потом "слитые" слова

		if (key2) {
//в общем объединяем (в запросе), если у нас только цифры, иначе не объединяем (в запросе)
			if (/^\d+$/.test(key2))
				return key;
//так же объединяем (в запросе), если есть только по одному символу между пробелами
			if (/(^|\s)[^\s](\s|$)/.test(p1))
				return key;
		}
		

	}
	return match;
}

//за основу взят код из function ItemKeys(name,requiredkeys)
//удаляем пробелы в ЦС, которые без скобок
//нужно для заголовков типа "Тормозной диск BOSCH 0 986h 479 771" что бы ЦС не разбилось между заголовками как попало (для того что бы красиво было с динамической вставкой КС)
//либо удаляем полностью ЦС, в котором не меньше 6 цифр
//нужно для заголовков типа "Тормозной диск BOSCH 0 986 479 771" - так как гугл может посчитать его номером телефона в объявлении
//	field_value = field_value.replace(/((?:^|\s)(?:(?:(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)*)|(?:[a-zA-Z0-9\.\-\_\/]{7,}))(?=\s|$))/g, replacer2);
//теперь еще глюк гугла убран (можно сравнить с верхним) <- пример глюка ищем в ItemKeys по этой фразе
	field_value = field_value.replace(/((?:^|\s)(?:(?:(?=[^\s\(\)\d]*\d+)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)*)|(?:[a-zA-Z0-9\.\-\_\/]{7,}))(?=\s|$))/g, replacer2);

	//удаляем пустые скобки если остались после удаления ЦС
	field_value = field_value.replace(/\s*\(\s*\)/g, '');


	field_value = field_value.trim();


	return field_value;


}


function getMaxStr(string, maxLen) {
//получить строку не более maxLen
//0 - неограничено, иначе обрезается по точке, запятой или пробелу


	if (typeof string != 'string')
		return '';

//для undefined null '' или 0
	if (!maxLen)
		return string;

	if (!/^\d+$/.test(maxLen))
		return string;

	maxLen = maxLen * 1; //переводим в число всегда

//для '0' на входе
	if (!maxLen)
		return string;


	if (maxLen >= string.length)
		return string;


//сначала ищем по точке
//мах длина строки для точки
	var maxLenDot = maxLen - 1;
	if (maxLenDot <= 0)
		maxLenDot = 1;

	var newstr = string.match('^.{1,' + maxLenDot + '}[\\.\\!\\|](?=\\s|$)')
	if (newstr !== null) {
		return newstr[0];
	}


//ищем по запятой (не менее половины строки)
//мин длина строки для запятой
	var minLenComma = parseInt(maxLen/2);
	if (minLenComma <= 0)
		minLenComma = 1;


	var newstr = string.match('^.{' + minLenComma + ',' + maxLen + '}(?=\\s*\\,(?:\\s|$))')
	if (newstr !== null) {
		return newstr[0];
	}


//ищем по пробелу
	var newstr = string.match('^.{1,' + maxLen + '}(?=\\s|$)')
	if (newstr !== null) {
		return newstr[0];
	}

	return '';

}



function KeyWordString(string, keyword) {

//новая версия ( учитывает кавычки '"() и изменяет только буквенные слова в режимах Keyword и KeyWord)


	function replacerKeyWord(match, p1, p2, p3, p4, offset, string) {
		//p2 не undefined и p3 undefined  - признак что увеличивать одиночный символ, то есть это начало строки или один из .!|
		//p3 не undefined и p2 undefined - признак что не увеличивать одиночный символ
		//p4 - само слово
		if (typeof p2 == 'string') {
			//начало предложения
			//увеличиваем одиночный символ, как и любой другой
			var firstch = p4.toLowerCase().replace(/^([\"\'\(]*\s*[^\"\'\(\s]).*$/, '$1').toUpperCase();
			var fullchars = firstch + p4.toLowerCase().replace(/^[\"\'\(]*\s*[^\"\'\(\s](.*)$/, '$1');
		} else {
			//не увеличиваем одиночный символ без кавычек, а если слово или слово в кавычках или одиночный символ в кавычках то увеличиваем первый символ
			if (p4.length == 1) {
				//это одиночный символ без кавычек
				var fullchars = p4.toLowerCase();
			} else {
				//это слово или слово в кавычках или одиночный символ в кавычках, увеличиваем первый символ (с учетом символов кавычек)
				var firstch = p4.toLowerCase().replace(/^([\"\'\(]*\s*[^\"\'\(\s]).*$/, '$1').toUpperCase();
				var fullchars = firstch + p4.toLowerCase().replace(/^[\"\'\(]*\s*[^\"\'\(\s](.*)$/, '$1');
			}
		}
		return p1 + fullchars;
	}


	function replacerKeyword(match, p1, p2, p3, p4, offset, string) {
		if (typeof p2 == 'string') {
			var firstch = p4.toLowerCase().replace(/^([\"\'\(]*\s*[^\"\'\(\s]).*$/, '$1').toUpperCase();
			var fullchars = firstch + p4.toLowerCase().replace(/^[\"\'\(]*\s*[^\"\'\(\s](.*)$/, '$1');
		} else {
			var fullchars = p4.toLowerCase();
		}
		return p1 + fullchars;

	}


	if (keyword) {
		if (keyword == 'Keyword') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.replace(/(((?:^\s*)|(?:\.\s*)|(?:\!\s*)|(?:\|\s*))|([\,\s]+))([\"\'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:[\"\'\)\s\.\!\|\,])|(?:$)))/g, replacerKeyword);
		} else if (keyword == 'KeyWord') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.replace(/(((?:^\s*)|(?:\.\s*)|(?:\!\s*)|(?:\|\s*))|([\,\s]+))([\"\'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:[\"\'\)\s\.\!\|\,])|(?:$)))/g, replacerKeyWord);
		} else if (keyword == 'keyword') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.toLowerCase();
		} else if (keyword == 'KEYWORD') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.toUpperCase();
		} else {
			return null;
		}
		
	}

	return string;

}


function isValidResponseCodeCSV(resp,CSVConfig) {
	var skip_errors = CSVConfig.skip_errors;
	if (resp == 200) return true;
	if (skip_errors && skip_errors.length) {
		for (var v in skip_errors) {
			if (skip_errors[v] == resp) {
				return true;
			}
	        }
	}
	return false;
}



function isValidResponseCode(resp) {
	var skip_errors = ScanCreateFeedsGlobalVars.skip_errors;
	if (resp == 200) return true;
	if (skip_errors && skip_errors.length) {
		for (var v in skip_errors) {
			if (skip_errors[v] == resp) {
				return true;
			}
	        }
	}
	return false;
}





//https://www.strictly-software.com/htmlencode
//html-сущности кодировать - декодировать
//var encoded = Encoder.htmlEncode(document.getElementById('input'));
//var decoded = Encoder.htmlDecode(encoded);
//var containsEncoded = Encoder.hasEncoded(encoded);
//обнаружил маленькую доработку ????

Encoder = {

	// When encoding do we convert characters into html or numerical entities
	EncodeType : "entity",  // entity OR numerical

	isEmpty : function(val){
		if(val){
			return ((val===null) || val.length==0 || /^\s+$/.test(val));
		}else{
			return true;
		}
	},
	
	// arrays for conversion from HTML Entities to Numerical values
	arr1: ['&nbsp;','&iexcl;','&cent;','&pound;','&curren;','&yen;','&brvbar;','&sect;','&uml;','&copy;','&ordf;','&laquo;','&not;','&shy;','&reg;','&macr;','&deg;','&plusmn;','&sup2;','&sup3;','&acute;','&micro;','&para;','&middot;','&cedil;','&sup1;','&ordm;','&raquo;','&frac14;','&frac12;','&frac34;','&iquest;','&Agrave;','&Aacute;','&Acirc;','&Atilde;','&Auml;','&Aring;','&AElig;','&Ccedil;','&Egrave;','&Eacute;','&Ecirc;','&Euml;','&Igrave;','&Iacute;','&Icirc;','&Iuml;','&ETH;','&Ntilde;','&Ograve;','&Oacute;','&Ocirc;','&Otilde;','&Ouml;','&times;','&Oslash;','&Ugrave;','&Uacute;','&Ucirc;','&Uuml;','&Yacute;','&THORN;','&szlig;','&agrave;','&aacute;','&acirc;','&atilde;','&auml;','&aring;','&aelig;','&ccedil;','&egrave;','&eacute;','&ecirc;','&euml;','&igrave;','&iacute;','&icirc;','&iuml;','&eth;','&ntilde;','&ograve;','&oacute;','&ocirc;','&otilde;','&ouml;','&divide;','&oslash;','&ugrave;','&uacute;','&ucirc;','&uuml;','&yacute;','&thorn;','&yuml;','&quot;','&amp;','&lt;','&gt;','&OElig;','&oelig;','&Scaron;','&scaron;','&Yuml;','&circ;','&tilde;','&ensp;','&emsp;','&thinsp;','&zwnj;','&zwj;','&lrm;','&rlm;','&ndash;','&mdash;','&lsquo;','&rsquo;','&sbquo;','&ldquo;','&rdquo;','&bdquo;','&dagger;','&Dagger;','&permil;','&lsaquo;','&rsaquo;','&euro;','&fnof;','&Alpha;','&Beta;','&Gamma;','&Delta;','&Epsilon;','&Zeta;','&Eta;','&Theta;','&Iota;','&Kappa;','&Lambda;','&Mu;','&Nu;','&Xi;','&Omicron;','&Pi;','&Rho;','&Sigma;','&Tau;','&Upsilon;','&Phi;','&Chi;','&Psi;','&Omega;','&alpha;','&beta;','&gamma;','&delta;','&epsilon;','&zeta;','&eta;','&theta;','&iota;','&kappa;','&lambda;','&mu;','&nu;','&xi;','&omicron;','&pi;','&rho;','&sigmaf;','&sigma;','&tau;','&upsilon;','&phi;','&chi;','&psi;','&omega;','&thetasym;','&upsih;','&piv;','&bull;','&hellip;','&prime;','&Prime;','&oline;','&frasl;','&weierp;','&image;','&real;','&trade;','&alefsym;','&larr;','&uarr;','&rarr;','&darr;','&harr;','&crarr;','&lArr;','&uArr;','&rArr;','&dArr;','&hArr;','&forall;','&part;','&exist;','&empty;','&nabla;','&isin;','&notin;','&ni;','&prod;','&sum;','&minus;','&lowast;','&radic;','&prop;','&infin;','&ang;','&and;','&or;','&cap;','&cup;','&int;','&there4;','&sim;','&cong;','&asymp;','&ne;','&equiv;','&le;','&ge;','&sub;','&sup;','&nsub;','&sube;','&supe;','&oplus;','&otimes;','&perp;','&sdot;','&lceil;','&rceil;','&lfloor;','&rfloor;','&lang;','&rang;','&loz;','&spades;','&clubs;','&hearts;','&diams;'],
	arr2: ['&#160;','&#161;','&#162;','&#163;','&#164;','&#165;','&#166;','&#167;','&#168;','&#169;','&#170;','&#171;','&#172;','&#173;','&#174;','&#175;','&#176;','&#177;','&#178;','&#179;','&#180;','&#181;','&#182;','&#183;','&#184;','&#185;','&#186;','&#187;','&#188;','&#189;','&#190;','&#191;','&#192;','&#193;','&#194;','&#195;','&#196;','&#197;','&#198;','&#199;','&#200;','&#201;','&#202;','&#203;','&#204;','&#205;','&#206;','&#207;','&#208;','&#209;','&#210;','&#211;','&#212;','&#213;','&#214;','&#215;','&#216;','&#217;','&#218;','&#219;','&#220;','&#221;','&#222;','&#223;','&#224;','&#225;','&#226;','&#227;','&#228;','&#229;','&#230;','&#231;','&#232;','&#233;','&#234;','&#235;','&#236;','&#237;','&#238;','&#239;','&#240;','&#241;','&#242;','&#243;','&#244;','&#245;','&#246;','&#247;','&#248;','&#249;','&#250;','&#251;','&#252;','&#253;','&#254;','&#255;','&#34;','&#38;','&#60;','&#62;','&#338;','&#339;','&#352;','&#353;','&#376;','&#710;','&#732;','&#8194;','&#8195;','&#8201;','&#8204;','&#8205;','&#8206;','&#8207;','&#8211;','&#8212;','&#8216;','&#8217;','&#8218;','&#8220;','&#8221;','&#8222;','&#8224;','&#8225;','&#8240;','&#8249;','&#8250;','&#8364;','&#402;','&#913;','&#914;','&#915;','&#916;','&#917;','&#918;','&#919;','&#920;','&#921;','&#922;','&#923;','&#924;','&#925;','&#926;','&#927;','&#928;','&#929;','&#931;','&#932;','&#933;','&#934;','&#935;','&#936;','&#937;','&#945;','&#946;','&#947;','&#948;','&#949;','&#950;','&#951;','&#952;','&#953;','&#954;','&#955;','&#956;','&#957;','&#958;','&#959;','&#960;','&#961;','&#962;','&#963;','&#964;','&#965;','&#966;','&#967;','&#968;','&#969;','&#977;','&#978;','&#982;','&#8226;','&#8230;','&#8242;','&#8243;','&#8254;','&#8260;','&#8472;','&#8465;','&#8476;','&#8482;','&#8501;','&#8592;','&#8593;','&#8594;','&#8595;','&#8596;','&#8629;','&#8656;','&#8657;','&#8658;','&#8659;','&#8660;','&#8704;','&#8706;','&#8707;','&#8709;','&#8711;','&#8712;','&#8713;','&#8715;','&#8719;','&#8721;','&#8722;','&#8727;','&#8730;','&#8733;','&#8734;','&#8736;','&#8743;','&#8744;','&#8745;','&#8746;','&#8747;','&#8756;','&#8764;','&#8773;','&#8776;','&#8800;','&#8801;','&#8804;','&#8805;','&#8834;','&#8835;','&#8836;','&#8838;','&#8839;','&#8853;','&#8855;','&#8869;','&#8901;','&#8968;','&#8969;','&#8970;','&#8971;','&#9001;','&#9002;','&#9674;','&#9824;','&#9827;','&#9829;','&#9830;'],
		
	// Convert HTML entities into numerical entities
	HTML2Numerical : function(s){
		return this.swapArrayVals(s,this.arr1,this.arr2);
	},	

	// Convert Numerical entities into HTML entities
	NumericalToHTML : function(s){
		return this.swapArrayVals(s,this.arr2,this.arr1);
	},


	// Numerically encodes all unicode characters
	numEncode : function(s){ 
		if(this.isEmpty(s)) return ""; 

		var a = [],
			l = s.length; 
		
		for (var i=0;i<l;i++){ 
			var c = s.charAt(i); 
			if (c < " " || c > "~"){ 
				a.push("&#"); 
				a.push(c.charCodeAt()); //numeric value of code point 
				a.push(";"); 
			}else{ 
				a.push(c); 
			} 
		} 
		
		return a.join(""); 	
	}, 
	
	// HTML Decode numerical and HTML entities back to original values
	htmlDecode : function(s){

		var c,m,d = s;
		
		if(this.isEmpty(d)) return "";

		// convert HTML entites back to numerical entites first
		d = this.HTML2Numerical(d);
		
		// look for numerical entities &#34;
		arr=d.match(/&#[0-9]{1,5};/g);
		
		// if no matches found in string then skip
		if(arr!=null){
			for(var x=0;x<arr.length;x++){
				m = arr[x];
				c = m.substring(2,m.length-1); //get numeric part which is refernce to unicode character
				// if its a valid number we can decode
				if(c >= -32768 && c <= 65535){
					// decode every single match within string
					d = d.replace(m, String.fromCharCode(c));
				}else{
					d = d.replace(m, ""); //invalid so replace with nada
				}
			}			
		}

		return d;
	},		

	// encode an input string into either numerical or HTML entities
	htmlEncode : function(s,dbl){
			
		if(this.isEmpty(s)) return "";

		// do we allow double encoding? E.g will &amp; be turned into &amp;amp;
		dbl = dbl || false; //default to prevent double encoding
		
		// if allowing double encoding we do ampersands first
		if(dbl){
			if(this.EncodeType=="numerical"){
				s = s.replace(/&/g, "&#38;");
			}else{
				s = s.replace(/&/g, "&amp;");
			}
		}

		// convert the xss chars to numerical entities ' " < >
		s = this.XSSEncode(s,false);
		
		if(this.EncodeType=="numerical" || !dbl){
			// Now call function that will convert any HTML entities to numerical codes
			s = this.HTML2Numerical(s);
		}

		// Now encode all chars above 127 e.g unicode
		s = this.numEncode(s);

		// now we know anything that needs to be encoded has been converted to numerical entities we
		// can encode any ampersands & that are not part of encoded entities
		// to handle the fact that I need to do a negative check and handle multiple ampersands &&&
		// I am going to use a placeholder

		// if we don't want double encoded entities we ignore the & in existing entities
		if(!dbl){
			s = s.replace(/&#/g,"##AMPHASH##");
		
			if(this.EncodeType=="numerical"){
				s = s.replace(/&/g, "&#38;");
			}else{
				s = s.replace(/&/g, "&amp;");
			}

			s = s.replace(/##AMPHASH##/g,"&#");
		}
		
		// replace any malformed entities
		s = s.replace(/&#\d*([^\d;]|$)/g, "$1");

		if(!dbl){
			// safety check to correct any double encoded &amp;
			s = this.correctEncoding(s);
		}

		// now do we need to convert our numerical encoded string into entities
		if(this.EncodeType=="entity"){
			s = this.NumericalToHTML(s);
		}

		return s;					
	},

	// Encodes the basic 4 characters used to malform HTML in XSS hacks
	XSSEncode : function(s,en){
		if(!this.isEmpty(s)){
			en = en || true;
			// do we convert to numerical or html entity?
			if(en){
				s = s.replace(/\'/g,"&#39;"); //no HTML equivalent as &apos is not cross browser supported
				s = s.replace(/\"/g,"&quot;");
				s = s.replace(/</g,"&lt;");
				s = s.replace(/>/g,"&gt;");
			}else{
				s = s.replace(/\'/g,"&#39;"); //no HTML equivalent as &apos is not cross browser supported
				s = s.replace(/\"/g,"&#34;");
				s = s.replace(/</g,"&#60;");
				s = s.replace(/>/g,"&#62;");
			}
			return s;
		}else{
			return "";
		}
	},

	// returns true if a string contains html or numerical encoded entities
	hasEncoded : function(s){
		if(/&#[0-9]{1,5};/.test(s)){
			return true;
		}else if(/&[A-Z]{2,6};/i.test(s)){
			return true;
		}else{
			return false;
		}
/*
//????

		if(/&#[0-9]{1,5};/g.test(s)){
			return true;
		}else if(/&[A-Z]{2,6};/gi.test(s)){
			return true;
		}else{
			return false;
		}
*/
	},

	// will remove any unicode characters
	stripUnicode : function(s){
		return s.replace(/[^\x20-\x7E]/g,"");
		
	},

	// corrects any double encoded &amp; entities e.g &amp;amp;
	correctEncoding : function(s){
		return s.replace(/(&amp;)(amp;)+/,"$1");
	},


	// Function to loop through an array swaping each item with the value from another array e.g swap HTML entities with Numericals
	swapArrayVals : function(s,arr1,arr2){
		if(this.isEmpty(s)) return "";
		var re;
		if(arr1 && arr2){
			//ShowDebug("in swapArrayVals arr1.length = " + arr1.length + " arr2.length = " + arr2.length)
			// array lengths must match
			if(arr1.length == arr2.length){
				for(var x=0,i=arr1.length;x<i;x++){
					re = new RegExp(arr1[x], 'g');
					s = s.replace(re,arr2[x]); //swap arr1 item with matching item from arr2	
				}
			}
		}
		return s;
	},

	inArray : function( item, arr ) {
		for ( var i = 0, x = arr.length; i < x; i++ ){
			if ( arr[i] === item ){
				return i;
			}
		}
		return -1;
	}

}


// Skip URLs from the skip_parse array
// url - здесь все после домена и порта
//не проверяются ссылки href='#...' (проверены при скане)
//удалены из ссылок #...

function SkipParseURL(url,OneFeedConfig) {
	var skip_url = OneFeedConfig.skip_parse;
	var only_url = OneFeedConfig.only_parse;
	var parseUrlFun = OneFeedConfig.parseUrlFun;

	if ((skip_url && skip_url.length) || (only_url && only_url.length) || parseUrlFun) {


		var firsts = url.substr(0, 1);
		if (firsts != '/') {
			url = '/' + url;
		}


		if (skip_url && skip_url.length) {
			for (var v in skip_url) {
				if (skip_url[v] == '/') {
					if (url == '/') return true;
				} else {
					if (url.substr(0, skip_url[v].length) == skip_url[v]) return true; // Skip this URL
				}
			}
		}

		if (only_url && only_url.length) {
			var exist = 0;
			for (var v in only_url) {
				if (only_url[v] == '/') {
					if (url == '/') exist = 1;
				} else {
					if (url.substr(0, only_url[v].length) == only_url[v]) exist = 1; // Skip this URL
				}
			}
			if (!exist)
				return true;
		}

		if (parseUrlFun) {
	            try {
	                var noskip = parseUrlFun(url);
			if (!noskip)
				return true;
        	    } catch (e) {
				ScanCreateFeedsGlobalVars.errors += 'bad function parseUrlFun:' + e.message + "\n";
				Logger.log(ScanCreateFeedsGlobalVars.errors);
	            }
		}


	} else {
		//признак отсутствия настроек для скипа
		return '';
	}

	return false;
}


function floorN(x, n) {
	x = parseFloat(x);
	return parseFloat(x.toFixed(n));
}




/* @license
Papa Parse
v5.0.0-beta.0
https://github.com/mholt/PapaParse
License: MIT
*/

//https://ruseller.com/lessons.php?rub=32&id=2070
//https://github.com/mholt/PapaParse
//http://papaparse.com/
//https://www.papaparse.com/docs
//var results = Papa.parse(csvString)
//var results = Papa.parse(csvString,{})

(function(root, factory)
{
	/* globals define */
	if (typeof define === 'function' && define.amd)
	{
		// AMD. Register as an anonymous module.
		define([], factory);
	}
	else if (typeof module === 'object' && typeof exports !== 'undefined')
	{
		// Node. Does not work with strict CommonJS, but
		// only CommonJS-like environments that support module.exports,
		// like Node.
		module.exports = factory();
	}
	else
	{
		// Browser globals (root is window)
		root.Papa = factory();
	}
	// in strict mode we cannot access arguments.callee, so we need a named reference to
	// stringify the factory method for the blob worker
	// eslint-disable-next-line func-name
}(this, function moduleFactory()
{
	'use strict';

	var global = (function() {
		// alternative method, similar to `Function('return this')()`
		// but without using `eval` (which is disabled when
		// using Content Security Policy).

		if (typeof self !== 'undefined') { return self; }
		if (typeof window !== 'undefined') { return window; }
		if (typeof global !== 'undefined') { return global; }

		// When running tests none of the above have been defined
		return {};
	})();


	function getWorkerBlob() {
		var URL = global.URL || global.webkitURL || null;
		var code = moduleFactory.toString();
		return Papa.BLOB_URL || (Papa.BLOB_URL = URL.createObjectURL(new Blob(['(', code, ')();'], {type: 'text/javascript'})));
	}

	var IS_WORKER = !global.document && !!global.postMessage,
		IS_PAPA_WORKER = IS_WORKER && /blob:/i.test((global.location || {}).protocol);
	var workers = {}, workerIdCounter = 0;

	var Papa = {};

	Papa.parse = CsvToJson;
	Papa.unparse = JsonToCsv;

	Papa.RECORD_SEP = String.fromCharCode(30);
	Papa.UNIT_SEP = String.fromCharCode(31);
	Papa.BYTE_ORDER_MARK = '\ufeff';
	Papa.BAD_DELIMITERS = ['\r', '\n', '"', Papa.BYTE_ORDER_MARK];
	Papa.WORKERS_SUPPORTED = !IS_WORKER && !!global.Worker;
	Papa.NODE_STREAM_INPUT = 1;

	// Configurable chunk sizes for local and remote files, respectively
	Papa.LocalChunkSize = 1024 * 1024 * 10;	// 10 MB
	Papa.RemoteChunkSize = 1024 * 1024 * 5;	// 5 MB
	Papa.DefaultDelimiter = ',';			// Used if not specified and detection fails

	// Exposed for testing and development only
	Papa.Parser = Parser;
	Papa.ParserHandle = ParserHandle;
	Papa.NetworkStreamer = NetworkStreamer;
	Papa.FileStreamer = FileStreamer;
	Papa.StringStreamer = StringStreamer;
	Papa.ReadableStreamStreamer = ReadableStreamStreamer;
	if (typeof PAPA_BROWSER_CONTEXT === 'undefined') {
		Papa.DuplexStreamStreamer = DuplexStreamStreamer;
	}

	if (global.jQuery)
	{
		var $ = global.jQuery;
		$.fn.parse = function(options)
		{
			var config = options.config || {};
			var queue = [];

			this.each(function(idx)
			{
				var supported = $(this).prop('tagName').toUpperCase() === 'INPUT'
								&& $(this).attr('type').toLowerCase() === 'file'
								&& global.FileReader;

				if (!supported || !this.files || this.files.length === 0)
					return true;	// continue to next input element

				for (var i = 0; i < this.files.length; i++)
				{
					queue.push({
						file: this.files[i],
						inputElem: this,
						instanceConfig: $.extend({}, config)
					});
				}
			});

			parseNextFile();	// begin parsing
			return this;		// maintains chainability


			function parseNextFile()
			{
				if (queue.length === 0)
				{
					if (isFunction(options.complete))
						options.complete();
					return;
				}

				var f = queue[0];

				if (isFunction(options.before))
				{
					var returned = options.before(f.file, f.inputElem);

					if (typeof returned === 'object')
					{
						if (returned.action === 'abort')
						{
							error('AbortError', f.file, f.inputElem, returned.reason);
							return;	// Aborts all queued files immediately
						}
						else if (returned.action === 'skip')
						{
							fileComplete();	// parse the next file in the queue, if any
							return;
						}
						else if (typeof returned.config === 'object')
							f.instanceConfig = $.extend(f.instanceConfig, returned.config);
					}
					else if (returned === 'skip')
					{
						fileComplete();	// parse the next file in the queue, if any
						return;
					}
				}

				// Wrap up the user's complete callback, if any, so that ours also gets executed
				var userCompleteFunc = f.instanceConfig.complete;
				f.instanceConfig.complete = function(results)
				{
					if (isFunction(userCompleteFunc))
						userCompleteFunc(results, f.file, f.inputElem);
					fileComplete();
				};

				Papa.parse(f.file, f.instanceConfig);
			}

			function error(name, file, elem, reason)
			{
				if (isFunction(options.error))
					options.error({name: name}, file, elem, reason);
			}

			function fileComplete()
			{
				queue.splice(0, 1);
				parseNextFile();
			}
		};
	}


	if (IS_PAPA_WORKER)
	{
		global.onmessage = workerThreadReceivedMessage;
	}




	function CsvToJson(_input, _config)
	{
		_config = _config || {};
		var dynamicTyping = _config.dynamicTyping || false;
		if (isFunction(dynamicTyping)) {
			_config.dynamicTypingFunction = dynamicTyping;
			// Will be filled on first row call
			dynamicTyping = {};
		}
		_config.dynamicTyping = dynamicTyping;

		_config.transform = isFunction(_config.transform) ? _config.transform : false;

		if (_config.worker && Papa.WORKERS_SUPPORTED)
		{
			var w = newWorker();

			w.userStep = _config.step;
			w.userChunk = _config.chunk;
			w.userComplete = _config.complete;
			w.userError = _config.error;

			_config.step = isFunction(_config.step);
			_config.chunk = isFunction(_config.chunk);
			_config.complete = isFunction(_config.complete);
			_config.error = isFunction(_config.error);
			delete _config.worker;	// prevent infinite loop

			w.postMessage({
				input: _input,
				config: _config,
				workerId: w.id
			});

			return;
		}

		var streamer = null;
		if (_input === Papa.NODE_STREAM_INPUT && typeof PAPA_BROWSER_CONTEXT === 'undefined')
		{
			// create a node Duplex stream for use
			// with .pipe
			streamer = new DuplexStreamStreamer(_config);
			return streamer.getStream();
		}
		else if (typeof _input === 'string')
		{
			if (_config.download)
				streamer = new NetworkStreamer(_config);
			else
				streamer = new StringStreamer(_config);
		}
		else if (_input.readable === true && isFunction(_input.read) && isFunction(_input.on))
		{
			streamer = new ReadableStreamStreamer(_config);
		}
		else if ((global.File && _input instanceof File) || _input instanceof Object)	// ...Safari. (see issue #106)
			streamer = new FileStreamer(_config);

		return streamer.stream(_input);
	}






	function JsonToCsv(_input, _config)
	{
		// Default configuration

		/** whether to surround every datum with quotes */
		var _quotes = false;

		/** whether to write headers */
		var _writeHeader = true;

		/** delimiting character(s) */
		var _delimiter = ',';

		/** newline character(s) */
		var _newline = '\r\n';

		/** quote character */
		var _quoteChar = '"';

		/** escaped quote character, either "" or <config.escapeChar>" */
		var _escapedQuote = _quoteChar + _quoteChar;

		/** whether to skip empty lines */
		var _skipEmptyLines = false;

		/** the columns (keys) we expect when we unparse objects */
		var _columns = null;

		unpackConfig();

		var quoteCharRegex = new RegExp(escapeRegExp(_quoteChar), 'g');

		if (typeof _input === 'string')
			_input = JSON.parse(_input);

		if (Array.isArray(_input))
		{
			if (!_input.length || Array.isArray(_input[0]))
				return serialize(null, _input, _skipEmptyLines);
			else if (typeof _input[0] === 'object')
				return serialize(_columns || objectKeys(_input[0]), _input, _skipEmptyLines);
		}
		else if (typeof _input === 'object')
		{
			if (typeof _input.data === 'string')
				_input.data = JSON.parse(_input.data);

			if (Array.isArray(_input.data))
			{
				if (!_input.fields)
					_input.fields =  _input.meta && _input.meta.fields;

				if (!_input.fields)
					_input.fields =  Array.isArray(_input.data[0])
						? _input.fields
						: objectKeys(_input.data[0]);

				if (!(Array.isArray(_input.data[0])) && typeof _input.data[0] !== 'object')
					_input.data = [_input.data];	// handles input like [1,2,3] or ['asdf']
			}

			return serialize(_input.fields || [], _input.data || [], _skipEmptyLines);
		}

		// Default (any valid paths should return before this)
		throw new Error('Unable to serialize unrecognized input');


		function unpackConfig()
		{
			if (typeof _config !== 'object')
				return;

			if (typeof _config.delimiter === 'string'
                && !Papa.BAD_DELIMITERS.filter(function(value) { return _config.delimiter.indexOf(value) !== -1; }).length)
			{
				_delimiter = _config.delimiter;
			}

			if (typeof _config.quotes === 'boolean'
				|| Array.isArray(_config.quotes))
				_quotes = _config.quotes;

			if (typeof _config.skipEmptyLines === 'boolean'
				|| typeof _config.skipEmptyLines === 'string')
				_skipEmptyLines = _config.skipEmptyLines;

			if (typeof _config.newline === 'string')
				_newline = _config.newline;

			if (typeof _config.quoteChar === 'string')
				_quoteChar = _config.quoteChar;

			if (typeof _config.header === 'boolean')
				_writeHeader = _config.header;

			if (Array.isArray(_config.columns)) {

				if (_config.columns.length === 0) throw new Error('Option columns is empty');

				_columns = _config.columns;
			}

			if (_config.escapeChar !== undefined) {
				_escapedQuote = _config.escapeChar + _quoteChar;
			}
		}


		/** Turns an object's keys into an array */
		function objectKeys(obj)
		{
			if (typeof obj !== 'object')
				return [];
			var keys = [];
			for (var key in obj)
				keys.push(key);
			return keys;
		}

		/** The double for loop that iterates the data and writes out a CSV string including header row */
		function serialize(fields, data, skipEmptyLines)
		{
			var csv = '';

			if (typeof fields === 'string')
				fields = JSON.parse(fields);
			if (typeof data === 'string')
				data = JSON.parse(data);

			var hasHeader = Array.isArray(fields) && fields.length > 0;
			var dataKeyedByField = !(Array.isArray(data[0]));

			// If there a header row, write it first
			if (hasHeader && _writeHeader)
			{
				for (var i = 0; i < fields.length; i++)
				{
					if (i > 0)
						csv += _delimiter;
					csv += safe(fields[i], i);
				}
				if (data.length > 0)
					csv += _newline;
			}

			// Then write out the data
			for (var row = 0; row < data.length; row++)
			{
				var maxCol = hasHeader ? fields.length : data[row].length;

				var emptyLine = false;
				var nullLine = hasHeader ? Object.keys(data[row]).length === 0 : data[row].length === 0;
				if (skipEmptyLines && !hasHeader)
				{
					emptyLine = skipEmptyLines === 'greedy' ? data[row].join('').trim() === '' : data[row].length === 1 && data[row][0].length === 0;
				}
				if (skipEmptyLines === 'greedy' && hasHeader) {
					var line = [];
					for (var c = 0; c < maxCol; c++) {
						var cx = dataKeyedByField ? fields[c] : c;
						line.push(data[row][cx]);
					}
					emptyLine = line.join('').trim() === '';
				}
				if (!emptyLine)
				{
					for (var col = 0; col < maxCol; col++)
					{
						if (col > 0 && !nullLine)
							csv += _delimiter;
						var colIdx = hasHeader && dataKeyedByField ? fields[col] : col;
						csv += safe(data[row][colIdx], col);
					}
					if (row < data.length - 1 && (!skipEmptyLines || (maxCol > 0 && !nullLine)))
					{
						csv += _newline;
					}
				}
			}
			return csv;
		}

		/** Encloses a value around quotes if needed (makes a value safe for CSV insertion) */
		function safe(str, col)
		{
			if (typeof str === 'undefined' || str === null)
				return '';

			if (str.constructor === Date)
				return JSON.stringify(str).slice(1, 25);

			str = str.toString().replace(quoteCharRegex, _escapedQuote);

			var needsQuotes = (typeof _quotes === 'boolean' && _quotes)
							|| (Array.isArray(_quotes) && _quotes[col])
							|| hasAny(str, Papa.BAD_DELIMITERS)
							|| str.indexOf(_delimiter) > -1
							|| str.charAt(0) === ' '
							|| str.charAt(str.length - 1) === ' ';

			return needsQuotes ? _quoteChar + str + _quoteChar : str;
		}

		function hasAny(str, substrings)
		{
			for (var i = 0; i < substrings.length; i++)
				if (str.indexOf(substrings[i]) > -1)
					return true;
			return false;
		}
	}

	/** ChunkStreamer is the base prototype for various streamer implementations. */
	function ChunkStreamer(config)
	{
		this._handle = null;
		this._finished = false;
		this._completed = false;
		this._halted = false;
		this._input = null;
		this._baseIndex = 0;
		this._partialLine = '';
		this._rowCount = 0;
		this._start = 0;
		this._nextChunk = null;
		this.isFirstChunk = true;
		this._completeResults = {
			data: [],
			errors: [],
			meta: {}
		};
		replaceConfig.call(this, config);

		this.parseChunk = function(chunk, isFakeChunk)
		{
			// First chunk pre-processing
			if (this.isFirstChunk && isFunction(this._config.beforeFirstChunk))
			{
				var modifiedChunk = this._config.beforeFirstChunk(chunk);
				if (modifiedChunk !== undefined)
					chunk = modifiedChunk;
			}
			this.isFirstChunk = false;
			this._halted = false;

			// Rejoin the line we likely just split in two by chunking the file
			var aggregate = this._partialLine + chunk;
			this._partialLine = '';

			var results = this._handle.parse(aggregate, this._baseIndex, !this._finished);

			if (this._handle.paused() || this._handle.aborted()) {
				this._halted = true;
				return;
			}

			var lastIndex = results.meta.cursor;

			if (!this._finished)
			{
				this._partialLine = aggregate.substring(lastIndex - this._baseIndex);
				this._baseIndex = lastIndex;
			}

			if (results && results.data)
				this._rowCount += results.data.length;

			var finishedIncludingPreview = this._finished || (this._config.preview && this._rowCount >= this._config.preview);

			if (IS_PAPA_WORKER)
			{
				global.postMessage({
					results: results,
					workerId: Papa.WORKER_ID,
					finished: finishedIncludingPreview
				});
			}
			else if (isFunction(this._config.chunk) && !isFakeChunk)
			{
				this._config.chunk(results, this._handle);
				if (this._handle.paused() || this._handle.aborted()) {
					this._halted = true;
					return;
				}
				results = undefined;
				this._completeResults = undefined;
			}

			if (!this._config.step && !this._config.chunk) {
				this._completeResults.data = this._completeResults.data.concat(results.data);
				this._completeResults.errors = this._completeResults.errors.concat(results.errors);
				this._completeResults.meta = results.meta;
			}

			if (!this._completed && finishedIncludingPreview && isFunction(this._config.complete) && (!results || !results.meta.aborted)) {
				this._config.complete(this._completeResults, this._input);
				this._completed = true;
			}

			if (!finishedIncludingPreview && (!results || !results.meta.paused))
				this._nextChunk();

			return results;
		};

		this._sendError = function(error)
		{
			if (isFunction(this._config.error))
				this._config.error(error);
			else if (IS_PAPA_WORKER && this._config.error)
			{
				global.postMessage({
					workerId: Papa.WORKER_ID,
					error: error,
					finished: false
				});
			}
		};

		function replaceConfig(config)
		{
			// Deep-copy the config so we can edit it
			var configCopy = copy(config);
			configCopy.chunkSize = parseInt(configCopy.chunkSize);	// parseInt VERY important so we don't concatenate strings!
			if (!config.step && !config.chunk)
				configCopy.chunkSize = null;  // disable Range header if not streaming; bad values break IIS - see issue #196
			this._handle = new ParserHandle(configCopy);
			this._handle.streamer = this;
			this._config = configCopy;	// persist the copy to the caller
		}
	}


	function NetworkStreamer(config)
	{
		config = config || {};
		if (!config.chunkSize)
			config.chunkSize = Papa.RemoteChunkSize;
		ChunkStreamer.call(this, config);

		var xhr;

		if (IS_WORKER)
		{
			this._nextChunk = function()
			{
				this._readChunk();
				this._chunkLoaded();
			};
		}
		else
		{
			this._nextChunk = function()
			{
				this._readChunk();
			};
		}

		this.stream = function(url)
		{
			this._input = url;
			this._nextChunk();	// Starts streaming
		};

		this._readChunk = function()
		{
			if (this._finished)
			{
				this._chunkLoaded();
				return;
			}

			xhr = new XMLHttpRequest();

			if (this._config.withCredentials)
			{
				xhr.withCredentials = this._config.withCredentials;
			}

			if (!IS_WORKER)
			{
				xhr.onload = bindFunction(this._chunkLoaded, this);
				xhr.onerror = bindFunction(this._chunkError, this);
			}

			xhr.open('GET', this._input, !IS_WORKER);
			// Headers can only be set when once the request state is OPENED
			if (this._config.downloadRequestHeaders)
			{
				var headers = this._config.downloadRequestHeaders;

				for (var headerName in headers)
				{
					xhr.setRequestHeader(headerName, headers[headerName]);
				}
			}

			if (this._config.chunkSize)
			{
				var end = this._start + this._config.chunkSize - 1;	// minus one because byte range is inclusive
				xhr.setRequestHeader('Range', 'bytes=' + this._start + '-' + end);
			}

			try {
				xhr.send();
			}
			catch (err) {
				this._chunkError(err.message);
			}

			if (IS_WORKER && xhr.status === 0)
				this._chunkError();
			else
				this._start += this._config.chunkSize;
		};

		this._chunkLoaded = function()
		{
			if (xhr.readyState !== 4)
				return;

			if (xhr.status < 200 || xhr.status >= 400)
			{
				this._chunkError();
				return;
			}

			this._finished = !this._config.chunkSize || this._start > getFileSize(xhr);
			this.parseChunk(xhr.responseText);
		};

		this._chunkError = function(errorMessage)
		{
			var errorText = xhr.statusText || errorMessage;
			this._sendError(new Error(errorText));
		};

		function getFileSize(xhr)
		{
			var contentRange = xhr.getResponseHeader('Content-Range');
			if (contentRange === null) { // no content range, then finish!
				return -1;
			}
			return parseInt(contentRange.substr(contentRange.lastIndexOf('/') + 1));
		}
	}
	NetworkStreamer.prototype = Object.create(ChunkStreamer.prototype);
	NetworkStreamer.prototype.constructor = NetworkStreamer;


	function FileStreamer(config)
	{
		config = config || {};
		if (!config.chunkSize)
			config.chunkSize = Papa.LocalChunkSize;
		ChunkStreamer.call(this, config);

		var reader, slice;

		// FileReader is better than FileReaderSync (even in worker) - see http://stackoverflow.com/q/24708649/1048862
		// But Firefox is a pill, too - see issue #76: https://github.com/mholt/PapaParse/issues/76
		var usingAsyncReader = typeof FileReader !== 'undefined';	// Safari doesn't consider it a function - see issue #105

		this.stream = function(file)
		{
			this._input = file;
			slice = file.slice || file.webkitSlice || file.mozSlice;

			if (usingAsyncReader)
			{
				reader = new FileReader();		// Preferred method of reading files, even in workers
				reader.onload = bindFunction(this._chunkLoaded, this);
				reader.onerror = bindFunction(this._chunkError, this);
			}
			else
				reader = new FileReaderSync();	// Hack for running in a web worker in Firefox

			this._nextChunk();	// Starts streaming
		};

		this._nextChunk = function()
		{
			if (!this._finished && (!this._config.preview || this._rowCount < this._config.preview))
				this._readChunk();
		};

		this._readChunk = function()
		{
			var input = this._input;
			if (this._config.chunkSize)
			{
				var end = Math.min(this._start + this._config.chunkSize, this._input.size);
				input = slice.call(input, this._start, end);
			}
			var txt = reader.readAsText(input, this._config.encoding);
			if (!usingAsyncReader)
				this._chunkLoaded({ target: { result: txt } });	// mimic the async signature
		};

		this._chunkLoaded = function(event)
		{
			// Very important to increment start each time before handling results
			this._start += this._config.chunkSize;
			this._finished = !this._config.chunkSize || this._start >= this._input.size;
			this.parseChunk(event.target.result);
		};

		this._chunkError = function()
		{
			this._sendError(reader.error);
		};

	}
	FileStreamer.prototype = Object.create(ChunkStreamer.prototype);
	FileStreamer.prototype.constructor = FileStreamer;


	function StringStreamer(config)
	{
		config = config || {};
		ChunkStreamer.call(this, config);

		var remaining;
		this.stream = function(s)
		{
			remaining = s;
			return this._nextChunk();
		};
		this._nextChunk = function()
		{
			if (this._finished) return;
			var size = this._config.chunkSize;
			var chunk = size ? remaining.substr(0, size) : remaining;
			remaining = size ? remaining.substr(size) : '';
			this._finished = !remaining;
			return this.parseChunk(chunk);
		};
	}
	StringStreamer.prototype = Object.create(StringStreamer.prototype);
	StringStreamer.prototype.constructor = StringStreamer;


	function ReadableStreamStreamer(config)
	{
		config = config || {};

		ChunkStreamer.call(this, config);

		var queue = [];
		var parseOnData = true;
		var streamHasEnded = false;

		this.pause = function()
		{
			ChunkStreamer.prototype.pause.apply(this, arguments);
			this._input.pause();
		};

		this.resume = function()
		{
			ChunkStreamer.prototype.resume.apply(this, arguments);
			this._input.resume();
		};

		this.stream = function(stream)
		{
			this._input = stream;

			this._input.on('data', this._streamData);
			this._input.on('end', this._streamEnd);
			this._input.on('error', this._streamError);
		};

		this._checkIsFinished = function()
		{
			if (streamHasEnded && queue.length === 1) {
				this._finished = true;
			}
		};

		this._nextChunk = function()
		{
			this._checkIsFinished();
			if (queue.length)
			{
				this.parseChunk(queue.shift());
			}
			else
			{
				parseOnData = true;
			}
		};

		this._streamData = bindFunction(function(chunk)
		{
			try
			{
				queue.push(typeof chunk === 'string' ? chunk : chunk.toString(this._config.encoding));

				if (parseOnData)
				{
					parseOnData = false;
					this._checkIsFinished();
					this.parseChunk(queue.shift());
				}
			}
			catch (error)
			{
				this._streamError(error);
			}
		}, this);

		this._streamError = bindFunction(function(error)
		{
			this._streamCleanUp();
			this._sendError(error);
		}, this);

		this._streamEnd = bindFunction(function()
		{
			this._streamCleanUp();
			streamHasEnded = true;
			this._streamData('');
		}, this);

		this._streamCleanUp = bindFunction(function()
		{
			this._input.removeListener('data', this._streamData);
			this._input.removeListener('end', this._streamEnd);
			this._input.removeListener('error', this._streamError);
		}, this);
	}
	ReadableStreamStreamer.prototype = Object.create(ChunkStreamer.prototype);
	ReadableStreamStreamer.prototype.constructor = ReadableStreamStreamer;


	function DuplexStreamStreamer(_config) {
		var Duplex = require('stream').Duplex;
		var config = copy(_config);
		var parseOnWrite = true;
		var writeStreamHasFinished = false;
		var parseCallbackQueue = [];
		var stream = null;

		this._onCsvData = function(results)
		{
			var data = results.data;
			if (!stream.push(data) && !this._handle.paused()) {
				// the writeable consumer buffer has filled up
				// so we need to pause until more items
				// can be processed
				this._handle.pause();
			}
		};

		this._onCsvComplete = function()
		{
			// node will finish the read stream when
			// null is pushed
			stream.push(null);
		};

		config.step = bindFunction(this._onCsvData, this);
		config.complete = bindFunction(this._onCsvComplete, this);
		ChunkStreamer.call(this, config);

		this._nextChunk = function()
		{
			if (writeStreamHasFinished && parseCallbackQueue.length === 1) {
				this._finished = true;
			}
			if (parseCallbackQueue.length) {
				parseCallbackQueue.shift()();
			} else {
				parseOnWrite = true;
			}
		};

		this._addToParseQueue = function(chunk, callback)
		{
			// add to queue so that we can indicate
			// completion via callback
			// node will automatically pause the incoming stream
			// when too many items have been added without their
			// callback being invoked
			parseCallbackQueue.push(bindFunction(function() {
				this.parseChunk(typeof chunk === 'string' ? chunk : chunk.toString(config.encoding));
				if (isFunction(callback)) {
					return callback();
				}
			}, this));
			if (parseOnWrite) {
				parseOnWrite = false;
				this._nextChunk();
			}
		};

		this._onRead = function()
		{
			if (this._handle.paused()) {
				// the writeable consumer can handle more data
				// so resume the chunk parsing
				this._handle.resume();
			}
		};

		this._onWrite = function(chunk, encoding, callback)
		{
			this._addToParseQueue(chunk, callback);
		};

		this._onWriteComplete = function()
		{
			writeStreamHasFinished = true;
			// have to write empty string
			// so parser knows its done
			this._addToParseQueue('');
		};

		this.getStream = function()
		{
			return stream;
		};
		stream = new Duplex({
			readableObjectMode: true,
			decodeStrings: false,
			read: bindFunction(this._onRead, this),
			write: bindFunction(this._onWrite, this)
		});
		stream.once('finish', bindFunction(this._onWriteComplete, this));
	}
	if (typeof PAPA_BROWSER_CONTEXT === 'undefined') {
		DuplexStreamStreamer.prototype = Object.create(ChunkStreamer.prototype);
		DuplexStreamStreamer.prototype.constructor = DuplexStreamStreamer;
	}


	// Use one ParserHandle per entire CSV file or string
	function ParserHandle(_config)
	{
		// One goal is to minimize the use of regular expressions...
		var FLOAT = /^\s*-?(\d*\.?\d+|\d+\.?\d*)(e[-+]?\d+)?\s*$/i;
		var ISO_DATE = /(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/;
		var self = this;
		var _stepCounter = 0;	// Number of times step was called (number of rows parsed)
		var _rowCounter = 0;	// Number of rows that have been parsed so far
		var _input;				// The input being parsed
		var _parser;			// The core parser being used
		var _paused = false;	// Whether we are paused or not
		var _aborted = false;	// Whether the parser has aborted or not
		var _delimiterError;	// Temporary state between delimiter detection and processing results
		var _fields = [];		// Fields are from the header row of the input, if there is one
		var _results = {		// The last results returned from the parser
			data: [],
			errors: [],
			meta: {}
		};

		if (isFunction(_config.step))
		{
			var userStep = _config.step;
			_config.step = function(results)
			{
				_results = results;

				if (needsHeaderRow())
					processResults();
				else	// only call user's step function after header row
				{
					processResults();

					// It's possbile that this line was empty and there's no row here after all
					if (_results.data.length === 0)
						return;

					_stepCounter += results.data.length;
					if (_config.preview && _stepCounter > _config.preview)
						_parser.abort();
					else
						userStep(_results, self);
				}
			};
		}

		/**
		 * Parses input. Most users won't need, and shouldn't mess with, the baseIndex
		 * and ignoreLastRow parameters. They are used by streamers (wrapper functions)
		 * when an input comes in multiple chunks, like from a file.
		 */
		this.parse = function(input, baseIndex, ignoreLastRow)
		{
			var quoteChar = _config.quoteChar || '"';
			if (!_config.newline)
				_config.newline = guessLineEndings(input, quoteChar);

			_delimiterError = false;
			if (!_config.delimiter)
			{
				var delimGuess = guessDelimiter(input, _config.newline, _config.skipEmptyLines, _config.comments, _config.delimitersToGuess);
				if (delimGuess.successful)
					_config.delimiter = delimGuess.bestDelimiter;
				else
				{
					_delimiterError = true;	// add error after parsing (otherwise it would be overwritten)
					_config.delimiter = Papa.DefaultDelimiter;
				}
				_results.meta.delimiter = _config.delimiter;
			}
			else if(isFunction(_config.delimiter))
			{
				_config.delimiter = _config.delimiter(input);
				_results.meta.delimiter = _config.delimiter;
			}

			var parserConfig = copy(_config);
			if (_config.preview && _config.header)
				parserConfig.preview++;	// to compensate for header row

			_input = input;
			_parser = new Parser(parserConfig);
			_results = _parser.parse(_input, baseIndex, ignoreLastRow);
			processResults();
			return _paused ? { meta: { paused: true } } : (_results || { meta: { paused: false } });
		};

		this.paused = function()
		{
			return _paused;
		};

		this.pause = function()
		{
			_paused = true;
			_parser.abort();
			_input = _input.substr(_parser.getCharIndex());
		};

		this.resume = function()
		{
			if(self.streamer._halted) {
				_paused = false;
				self.streamer.parseChunk(_input, true);
			} else {
				// Bugfix: #636 In case the processing hasn't halted yet
				// wait for it to halt in order to resume
				setTimeout(this.resume, 3);
			}
		};

		this.aborted = function()
		{
			return _aborted;
		};

		this.abort = function()
		{
			_aborted = true;
			_parser.abort();
			_results.meta.aborted = true;
			if (isFunction(_config.complete))
				_config.complete(_results);
			_input = '';
		};

		function testEmptyLine(s) {
			return _config.skipEmptyLines === 'greedy' ? s.join('').trim() === '' : s.length === 1 && s[0].length === 0;
		}

		function processResults()
		{
			if (_results && _delimiterError)
			{
				addError('Delimiter', 'UndetectableDelimiter', 'Unable to auto-detect delimiting character; defaulted to \'' + Papa.DefaultDelimiter + '\'');
				_delimiterError = false;
			}

			if (_config.skipEmptyLines)
			{
				for (var i = 0; i < _results.data.length; i++)
					if (testEmptyLine(_results.data[i]))
						_results.data.splice(i--, 1);
			}

			if (needsHeaderRow())
				fillHeaderFields();

			return applyHeaderAndDynamicTypingAndTransformation();
		}

		function needsHeaderRow()
		{
			return _config.header && _fields.length === 0;
		}

		function fillHeaderFields()
		{
			if (!_results)
				return;

			function addHeder(header)
			{
				if (isFunction(_config.transformHeader))
					header = _config.transformHeader(header);

				_fields.push(header);
			}

			if (Array.isArray(_results.data[0]))
			{
				for (var i = 0; needsHeaderRow() && i < _results.data.length; i++)
					_results.data[i].forEach(addHeder);

				_results.data.splice(0, 1);
			}
			// if _results.data[0] is not an array, we are in a step where _results.data is the row.
			else
				_results.data.forEach(addHeder);
		}

		function shouldApplyDynamicTyping(field) {
			// Cache function values to avoid calling it for each row
			if (_config.dynamicTypingFunction && _config.dynamicTyping[field] === undefined) {
				_config.dynamicTyping[field] = _config.dynamicTypingFunction(field);
			}
			return (_config.dynamicTyping[field] || _config.dynamicTyping) === true;
		}

		function parseDynamic(field, value)
		{
			if (shouldApplyDynamicTyping(field))
			{
				if (value === 'true' || value === 'TRUE')
					return true;
				else if (value === 'false' || value === 'FALSE')
					return false;
				else if (FLOAT.test(value))
					return parseFloat(value);
				else if (ISO_DATE.test(value))
					return new Date(value);
				else
					return (value === '' ? null : value);
			}
			return value;
		}

		function applyHeaderAndDynamicTypingAndTransformation()
		{
			if (!_results || (!_config.header && !_config.dynamicTyping && !_config.transform))
				return _results;

			function processRow(rowSource, i)
			{
				var row = _config.header ? {} : [];

				var j;
				for (j = 0; j < rowSource.length; j++)
				{
					var field = j;
					var value = rowSource[j];

					if (_config.header)
						field = j >= _fields.length ? '__parsed_extra' : _fields[j];

					if (_config.transform)
						value = _config.transform(value,field);

					value = parseDynamic(field, value);

					if (field === '__parsed_extra')
					{
						row[field] = row[field] || [];
						row[field].push(value);
					}
					else
						row[field] = value;
				}


				if (_config.header)
				{
					if (j > _fields.length)
						addError('FieldMismatch', 'TooManyFields', 'Too many fields: expected ' + _fields.length + ' fields but parsed ' + j, _rowCounter + i);
					else if (j < _fields.length)
						addError('FieldMismatch', 'TooFewFields', 'Too few fields: expected ' + _fields.length + ' fields but parsed ' + j, _rowCounter + i);
				}

				return row;
			}

			var incrementBy = 1;
			if (!_results.data[0] || Array.isArray(_results.data[0]))
			{
				_results.data = _results.data.map(processRow);
				incrementBy = _results.data.length;
			}
			else
				_results.data = processRow(_results.data, 0);


			if (_config.header && _results.meta)
				_results.meta.fields = _fields;

			_rowCounter += incrementBy;
			return _results;
		}

		function guessDelimiter(input, newline, skipEmptyLines, comments, delimitersToGuess)
		{
			var bestDelim, bestDelta, fieldCountPrevRow;

			delimitersToGuess = delimitersToGuess || [',', '\t', '|', ';', Papa.RECORD_SEP, Papa.UNIT_SEP];

			for (var i = 0; i < delimitersToGuess.length; i++)
			{
				var delim = delimitersToGuess[i];
				var delta = 0, avgFieldCount = 0, emptyLinesCount = 0;
				fieldCountPrevRow = undefined;

				var preview = new Parser({
					comments: comments,
					delimiter: delim,
					newline: newline,
					preview: 10
				}).parse(input);

				for (var j = 0; j < preview.data.length; j++)
				{
					if (skipEmptyLines && testEmptyLine(preview.data[j]))
					{
						emptyLinesCount++;
						continue;
					}
					var fieldCount = preview.data[j].length;
					avgFieldCount += fieldCount;

					if (typeof fieldCountPrevRow === 'undefined')
					{
						fieldCountPrevRow = 0;
						continue;
					}
					else if (fieldCount > 1)
					{
						delta += Math.abs(fieldCount - fieldCountPrevRow);
						fieldCountPrevRow = fieldCount;
					}
				}

				if (preview.data.length > 0)
					avgFieldCount /= (preview.data.length - emptyLinesCount);

				if ((typeof bestDelta === 'undefined' || delta > bestDelta)
					&& avgFieldCount > 1.99)
				{
					bestDelta = delta;
					bestDelim = delim;
				}
			}

			_config.delimiter = bestDelim;

			return {
				successful: !!bestDelim,
				bestDelimiter: bestDelim
			};
		}

		function guessLineEndings(input, quoteChar)
		{
			input = input.substr(0, 1024 * 1024);	// max length 1 MB
			// Replace all the text inside quotes
			var re = new RegExp(escapeRegExp(quoteChar) + '([^]*?)' + escapeRegExp(quoteChar), 'gm');
			input = input.replace(re, '');

			var r = input.split('\r');

			var n = input.split('\n');

			var nAppearsFirst = (n.length > 1 && n[0].length < r[0].length);

			if (r.length === 1 || nAppearsFirst)
				return '\n';

			var numWithN = 0;
			for (var i = 0; i < r.length; i++)
			{
				if (r[i][0] === '\n')
					numWithN++;
			}

			return numWithN >= r.length / 2 ? '\r\n' : '\r';
		}

		function addError(type, code, msg, row)
		{
			_results.errors.push({
				type: type,
				code: code,
				message: msg,
				row: row
			});
		}
	}

	/** https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions */
	function escapeRegExp(string)
	{
		return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
	}

	/** The core parser implements speedy and correct CSV parsing */
	function Parser(config)
	{
		// Unpack the config object
		config = config || {};
		var delim = config.delimiter;
		var newline = config.newline;
		var comments = config.comments;
		var step = config.step;
		var preview = config.preview;
		var fastMode = config.fastMode;
		var quoteChar;
		/** Allows for no quoteChar by setting quoteChar to undefined in config */
		if (config.quoteChar === undefined) {
			quoteChar = '"';
		} else {
			quoteChar = config.quoteChar;
		}
		var escapeChar = quoteChar;
		if (config.escapeChar !== undefined) {
			escapeChar = config.escapeChar;
		}

		// Delimiter must be valid
		if (typeof delim !== 'string'
			|| Papa.BAD_DELIMITERS.indexOf(delim) > -1)
			delim = ',';

		// Comment character must be valid
		if (comments === delim)
			throw new Error('Comment character same as delimiter');
		else if (comments === true)
			comments = '#';
		else if (typeof comments !== 'string'
			|| Papa.BAD_DELIMITERS.indexOf(comments) > -1)
			comments = false;

		// Newline must be valid: \r, \n, or \r\n
		if (newline !== '\n' && newline !== '\r' && newline !== '\r\n')
			newline = '\n';

		// We're gonna need these at the Parser scope
		var cursor = 0;
		var aborted = false;

		this.parse = function(input, baseIndex, ignoreLastRow)
		{
			// For some reason, in Chrome, this speeds things up (!?)
			if (typeof input !== 'string')
				throw new Error('Input must be a string');

			// We don't need to compute some of these every time parse() is called,
			// but having them in a more local scope seems to perform better
			var inputLen = input.length,
				delimLen = delim.length,
				newlineLen = newline.length,
				commentsLen = comments.length;
			var stepIsFunction = isFunction(step);

			// Establish starting state
			cursor = 0;
			var data = [], errors = [], row = [], lastCursor = 0;

			if (!input)
				return returnable();

			if (fastMode || (fastMode !== false && input.indexOf(quoteChar) === -1))
			{
				var rows = input.split(newline);
				for (var i = 0; i < rows.length; i++)
				{
					row = rows[i];
					cursor += row.length;
					if (i !== rows.length - 1)
						cursor += newline.length;
					else if (ignoreLastRow)
						return returnable();
					if (comments && row.substr(0, commentsLen) === comments)
						continue;
					if (stepIsFunction)
					{
						data = [];
						pushRow(row.split(delim));
						doStep();
						if (aborted)
							return returnable();
					}
					else
						pushRow(row.split(delim));
					if (preview && i >= preview)
					{
						data = data.slice(0, preview);
						return returnable(true);
					}
				}
				return returnable();
			}

			var nextDelim = input.indexOf(delim, cursor);
			var nextNewline = input.indexOf(newline, cursor);
			var quoteCharRegex = new RegExp(escapeRegExp(escapeChar) + escapeRegExp(quoteChar), 'g');
			var quoteSearch;

			// Parser loop
			for (;;)
			{
				// Field has opening quote
				if (input[cursor] === quoteChar)
				{
					// Start our search for the closing quote where the cursor is
					quoteSearch = cursor;

					// Skip the opening quote
					cursor++;

					for (;;)
					{
						// Find closing quote
						quoteSearch = input.indexOf(quoteChar, quoteSearch + 1);

						//No other quotes are found - no other delimiters
						if (quoteSearch === -1)
						{
							if (!ignoreLastRow) {
								// No closing quote... what a pity
								errors.push({
									type: 'Quotes',
									code: 'MissingQuotes',
									message: 'Quoted field unterminated',
									row: data.length,	// row has yet to be inserted
									index: cursor
								});
							}
							return finish();
						}

						// Closing quote at EOF
						if (quoteSearch === inputLen - 1)
						{
							var value = input.substring(cursor, quoteSearch).replace(quoteCharRegex, quoteChar);
							return finish(value);
						}

						// If this quote is escaped, it's part of the data; skip it
						// If the quote character is the escape character, then check if the next character is the escape character
						if (quoteChar === escapeChar &&  input[quoteSearch + 1] === escapeChar)
						{
							quoteSearch++;
							continue;
						}

						// If the quote character is not the escape character, then check if the previous character was the escape character
						if (quoteChar !== escapeChar && quoteSearch !== 0 && input[quoteSearch - 1] === escapeChar)
						{
							continue;
						}

						// Check up to nextDelim or nextNewline, whichever is closest
						var checkUpTo = nextNewline === -1 ? nextDelim : Math.min(nextDelim, nextNewline);
						var spacesBetweenQuoteAndDelimiter = extraSpaces(checkUpTo);

						// Closing quote followed by delimiter or 'unnecessary spaces + delimiter'
						if (input[quoteSearch + 1 + spacesBetweenQuoteAndDelimiter] === delim)
						{
							row.push(input.substring(cursor, quoteSearch).replace(quoteCharRegex, quoteChar));
							cursor = quoteSearch + 1 + spacesBetweenQuoteAndDelimiter + delimLen;
							nextDelim = input.indexOf(delim, cursor);
							nextNewline = input.indexOf(newline, cursor);
							break;
						}

						var spacesBetweenQuoteAndNewLine = extraSpaces(nextNewline);

						// Closing quote followed by newline or 'unnecessary spaces + newLine'
						if (input.substr(quoteSearch + 1 + spacesBetweenQuoteAndNewLine, newlineLen) === newline)
						{
							row.push(input.substring(cursor, quoteSearch).replace(quoteCharRegex, quoteChar));
							saveRow(quoteSearch + 1 + spacesBetweenQuoteAndNewLine + newlineLen);
							nextDelim = input.indexOf(delim, cursor);	// because we may have skipped the nextDelim in the quoted field

							if (stepIsFunction)
							{
								doStep();
								if (aborted)
									return returnable();
							}

							if (preview && data.length >= preview)
								return returnable(true);

							break;
						}


						// Checks for valid closing quotes are complete (escaped quotes or quote followed by EOF/delimiter/newline) -- assume these quotes are part of an invalid text string
						errors.push({
							type: 'Quotes',
							code: 'InvalidQuotes',
							message: 'Trailing quote on quoted field is malformed',
							row: data.length,	// row has yet to be inserted
							index: cursor
						});

						quoteSearch++;
						continue;

					}

					continue;
				}

				// Comment found at start of new line
				if (comments && row.length === 0 && input.substr(cursor, commentsLen) === comments)
				{
					if (nextNewline === -1)	// Comment ends at EOF
						return returnable();
					cursor = nextNewline + newlineLen;
					nextNewline = input.indexOf(newline, cursor);
					nextDelim = input.indexOf(delim, cursor);
					continue;
				}

				// Next delimiter comes before next newline, so we've reached end of field
				if (nextDelim !== -1 && (nextDelim < nextNewline || nextNewline === -1))
				{
					row.push(input.substring(cursor, nextDelim));
					cursor = nextDelim + delimLen;
					nextDelim = input.indexOf(delim, cursor);
					continue;
				}

				// End of row
				if (nextNewline !== -1)
				{
					row.push(input.substring(cursor, nextNewline));
					saveRow(nextNewline + newlineLen);

					if (stepIsFunction)
					{
						doStep();
						if (aborted)
							return returnable();
					}

					if (preview && data.length >= preview)
						return returnable(true);

					continue;
				}

				break;
			}


			return finish();


			function pushRow(row)
			{
				data.push(row);
				lastCursor = cursor;
			}

			/**
             * checks if there are extra spaces after closing quote and given index without any text
             * if Yes, returns the number of spaces
             */
			function extraSpaces(index) {
				var spaceLength = 0;
				if (index !== -1) {
					var textBetweenClosingQuoteAndIndex = input.substring(quoteSearch + 1, index);
					if (textBetweenClosingQuoteAndIndex && textBetweenClosingQuoteAndIndex.trim() === '') {
						spaceLength = textBetweenClosingQuoteAndIndex.length;
					}
				}
				return spaceLength;
			}

			/**
			 * Appends the remaining input from cursor to the end into
			 * row, saves the row, calls step, and returns the results.
			 */
			function finish(value)
			{
				if (ignoreLastRow)
					return returnable();
				if (typeof value === 'undefined')
					value = input.substr(cursor);
				row.push(value);
				cursor = inputLen;	// important in case parsing is paused
				pushRow(row);
				if (stepIsFunction)
					doStep();
				return returnable();
			}

			/**
			 * Appends the current row to the results. It sets the cursor
			 * to newCursor and finds the nextNewline. The caller should
			 * take care to execute user's step function and check for
			 * preview and end parsing if necessary.
			 */
			function saveRow(newCursor)
			{
				cursor = newCursor;
				pushRow(row);
				row = [];
				nextNewline = input.indexOf(newline, cursor);
			}

			/** Returns an object with the results, errors, and meta. */
			function returnable(stopped, step)
			{
				var isStep = step || false;
				return {
					data: isStep ? data[0]  : data,
					errors: errors,
					meta: {
						delimiter: delim,
						linebreak: newline,
						aborted: aborted,
						truncated: !!stopped,
						cursor: lastCursor + (baseIndex || 0)
					}
				};
			}

			/** Executes the user's step function and resets data & errors. */
			function doStep()
			{
				step(returnable(undefined, true));
				data = [];
				errors = [];
			}
		};

		/** Sets the abort flag */
		this.abort = function()
		{
			aborted = true;
		};

		/** Gets the cursor position */
		this.getCharIndex = function()
		{
			return cursor;
		};
	}


	function newWorker()
	{
		if (!Papa.WORKERS_SUPPORTED)
			return false;

		var workerUrl = getWorkerBlob();
		var w = new global.Worker(workerUrl);
		w.onmessage = mainThreadReceivedMessage;
		w.id = workerIdCounter++;
		workers[w.id] = w;
		return w;
	}

	/** Callback when main thread receives a message */
	function mainThreadReceivedMessage(e)
	{
		var msg = e.data;
		var worker = workers[msg.workerId];
		var aborted = false;

		if (msg.error)
			worker.userError(msg.error, msg.file);
		else if (msg.results && msg.results.data)
		{
			var abort = function() {
				aborted = true;
				completeWorker(msg.workerId, { data: [], errors: [], meta: { aborted: true } });
			};

			var handle = {
				abort: abort,
				pause: notImplemented,
				resume: notImplemented
			};

			if (isFunction(worker.userStep))
			{
				for (var i = 0; i < msg.results.data.length; i++)
				{
					worker.userStep({
						data: msg.results.data[i],
						errors: msg.results.errors,
						meta: msg.results.meta
					}, handle);
					if (aborted)
						break;
				}
				delete msg.results;	// free memory ASAP
			}
			else if (isFunction(worker.userChunk))
			{
				worker.userChunk(msg.results, handle, msg.file);
				delete msg.results;
			}
		}

		if (msg.finished && !aborted)
			completeWorker(msg.workerId, msg.results);
	}

	function completeWorker(workerId, results) {
		var worker = workers[workerId];
		if (isFunction(worker.userComplete))
			worker.userComplete(results);
		worker.terminate();
		delete workers[workerId];
	}

	function notImplemented() {
		throw new Error('Not implemented.');
	}

	/** Callback when worker thread receives a message */
	function workerThreadReceivedMessage(e)
	{
		var msg = e.data;

		if (typeof Papa.WORKER_ID === 'undefined' && msg)
			Papa.WORKER_ID = msg.workerId;

		if (typeof msg.input === 'string')
		{
			global.postMessage({
				workerId: Papa.WORKER_ID,
				results: Papa.parse(msg.input, msg.config),
				finished: true
			});
		}
		else if ((global.File && msg.input instanceof File) || msg.input instanceof Object)	// thank you, Safari (see issue #106)
		{
			var results = Papa.parse(msg.input, msg.config);
			if (results)
				global.postMessage({
					workerId: Papa.WORKER_ID,
					results: results,
					finished: true
				});
		}
	}

	/** Makes a deep copy of an array or object (mostly) */
	function copy(obj)
	{
		if (typeof obj !== 'object' || obj === null)
			return obj;
		var cpy = Array.isArray(obj) ? [] : {};
		for (var key in obj)
			cpy[key] = copy(obj[key]);
		return cpy;
	}

	function bindFunction(f, self)
	{
		return function() { f.apply(self, arguments); };
	}

	function isFunction(func)
	{
		return typeof func === 'function';
	}

	return Papa;
}));


function parseHtml(html, field_value_selector, type, field_replace, field_Fun, url, fields, fieldName, clearhtml) {
//выполняет парсинг html для field_value_selector 

//clearhtml - это обязательно! (добавлено в отличие от php-парсера)

//field_value_selector - нескольких селекторов (через запятую), функция берет первый попавшийся, где обнаружено совпадение в коде html
//наиболее приближенный вариант к браузеру - пробелы-разделители с/без nth-child(1) или > :nth-child(1) или > tag:nth-child(1)
//функция крайне редко может неверно найти для пробелов-разделителей
//всегда найдет для > но это не браузерный вариант
//вариант > - это не любые дочерние элементы, а первый дочерний элемент то есть :nth-child(1) (в отличие от браузера)
//наиболее быстро работает: > для всех селекторов и/или nth-child(1) (не проверяет переход на следующий "чужой" тег)
//:nth-child(2) и больший номер ищет среди любых потомков любой вложенности, а не только прямых потомков как браузер
//поэтому :nth-child(>1) более часто может неверно найти заданное браузером
//как работает
// пробел nth-child - ищет начиная с любого элемента среди любой вложенности (если >1 то проверяет переход на следующий "чужой" тег)
// > nth-child - ищет начиная с первого элемента среди любой вложенности (если >1 то проверяет переход на следующий "чужой" тег)
// пробел tag - ищет начиная с любого элемента среди любой вложенности (наиболее браузерный подход, хотя теоретически может перескочить на "чужой" тег и получить потом отлуп за чужой тег, хотя возможно надо было сразу переходить в этот следующий "чужой" тег а регулярки поступили по другому)
// > tag[attr=value] - ищет совпадение только в первом элементе (хотя не браузерный подход, но срабатывает во многих случаях, так как зачастую совпадает первый следующий элемент с искомым)
// tag:nth-child(n) - ищет n-ный tag любой вложенности, специально в корне отличается от браузера  (если >1 то проверяет переход на следующий "чужой" тег)
//			браузер ищет n-ный элемент среди прямых потомков, и проверяет совпадает ли он с tag
//			мы не можем искать прямых протомков, поэтому считать всех крайне неудобно, если далеко
//			поэтому вернул старый вариант - ищем по заданным tagам, а не по любым элементам
// > nth-child(1) - ищет совпадение только в первом элементе (браузерный подход на 100%)

    //применяются селекторы потомков (только > и пробел)
    //поддерживаются селекторы элемента: тег, id, класс, nth-child, атрибуты с полной поддержкой (= *= ^= $= |= ~=)
    //селекторы и классы можно переставлять.
    //параметры nth-child - только числа, его можно использовать с тегами, id, классами, атрибутами
    //nth-child только одноуровневый, то есть нельзя подряд указать несколько :nth-child
    //другие элементы не поддерживаются.

    //типовое использование: поддержка селекторов, генерируемых мозиллой "CSS-селектор" "Путь к CSS"
    //и оперой "Copy Selector" (кроме прямых потомков, которые заменяются на потомков)

    //могут иногда не сработать на правильном селекторе (так как используются регулярки, не строится DOM-модель)

    //отдает html (зависит от type), обнаруженный длинный селектор, короткий последний селектор и регулярное выражение поиска
    //в зависимости от type выдает разный html
    //type = undefined отдает обрезанный html (включая последний селектор и до конца страницы)
    //	зачем - может быть ситуация, когда другие варианты из-за сложной верстки 
    //	обрезают текст и пр., тогда с помощью field_Fun мы можем почистить этот код
    //type = 'text' отдает текст селектора
    //type = 'src' отдает src селектора
    //type = 'href' отдает href селектора
    //type = 'любой атрибут' отдает 'любой атрибут' селектора
    //url, fields только передаются в field_Fun, добавлены для совместимости field_Fun с другими функциями
    //fieldName - информационная переменная для ошибок (в каком поле произошла ошибка)
    //field_replace - поиск и замена регулярного выражения или строки, чистит html-код после выполнения type
    //			три параметра в массиве: что ищем и замены, на что меняем, флаги поиска (флаги необязательны)
    //			['^\\<([^\\s\\<\\>\\/]+)([\\s\\<\\>\\/]).*$', function(match, p1, p2) {},'gim']
    //			['^\\<([^\\s\\<\\>\\/]+)[\\s\\<\\>\\/].*$','$1','gim']
    //field_Fun - чистит html-код после выполнения type и field_replace
    //			function(html, selector, url, fields) { return html; }


    //комментарий по верстке
    //у атрибутов должны быть кавычки '" или вообще отсутствовать
    //если кавычки есть то допускается в значении атрибута использовать вторые кавычки, например, class='aa"a.html'
    //	функция действует аналогично
    //если закрывающая кавычка отсутствует, но она есть где-то дальше в теге, то браузеры будут объединять невалидный код, например href='aaa.html id=23' объединит в общую ссылку aaa.html%20id=23
    //	функция действует аналогично
    //если закрывающая кавычка отсутствует, и она где-то дальше ВНЕ тега, то браузеры объединят весь невалидный код до закрывающей кавычки в общее значение атрибута
    //	функция не найдет этот атрибут (если в пределах тега нет закрывающей кавычки)
    //если нет кавычек, то не может быть пробелов в значении аттрибута, иначе следующие за пробелом значения будут выделены в отдельные атрибуты
    //	функция действует аналогично
    //если нет кавычки в качестве первого символа в значении, то возможны обе кавычки в значениях аттрибутов
    //	функция действует аналогично



//можно привязываться к одиночным тегам, например, br hr meta
//для одиночных тегов "потомки" - это все одиночные теги до первого неодиночного
//аналогично определяется text для последнего одиночного - до первого неодиночного тега
//то есть так можно, типа div > br > br, хотя эта возможность (вставлять их в середине составного селектора) бесполезна


//nth-child в браузере ведет себя по разному при верстке и при вычислении CSS-селектора
//например, в верстке чилдами не считаются одиночные теги:
//area base basefont br col frame hr img input isindex link meta param https://www.w3.org/TR/1999/REC-html401-19991224/index/elements.html
//http://monetavinternete.ru/sozdaem-sajt-s-nulya/osnovy-html/chto-takoe-html-tegi-i-atributy-validator-validator-w3c-struktura-i-pravila-napisaniya-tegov/
//а при вычислении селектора, мозилла спокойно отдает br как чилда: body > article:nth-child(6) > div:nth-child(2) > br:nth-child(1)
//соотвественно, это у нас работает так как при вычислении селектора
//но главное другое - такой код наверняка неверно сработает у нас, так как с '>' вычисляются только прямые потомки-теги, а не все потомки, как у нас
//поэтому nth-child из мозиллы стоит оставлять только в последнем элементе: body > article > div > span:nth-child(2)
//и поэтому всегда желательна привязка по классам id или другим атрибутам



//конечный результат выдает в selector['result'], но также можно увидеть в массиве промежуточные результаты
//если выше selector['result'] == false то ошибка в настройках или в программе
//сама ошибка в selector['errors']
//все остальное не ошибка, а selector['result'] == '' - результат не найден



    function parseOneLastSelector(field_value_selector) {
        //создаем регулярное выражение для нахождения последнего тега в строке и обрезания всего до него

        //сначала нужно определить самый последний селектор (что бы потом обрезать до него, включая его)
        //перебираем в этом split так же как в следующем split
        //определяем число селекторов tag, id, class
        var numlastag = 0;
        //определяем число разрешенных элементов строки селектора space, >, tag, id, class
        var numarray = 0;
        field_value_selector.split(/(\s*\>\s*)|(\s+)/).forEach(function(token) {

            if ((token == '') || (typeof token == 'undefined')) return;
            token = token.trim()
            if (token == '') {
                //space
                numarray++
            } else if (token == '>') {
                //>
                numarray++
            } else {
                //selector
                var s = parse(token);
                if ((s.tags && s.tags[0]) || (s.child && s.child[0]) || (s.ids && s.ids[0]) || (s.classes && s.classes[0]) || (s.attrs && s.attrs[0] && s.attrs[0][0])) {
                    numlastag++;
                    numarray++
                }
            }
        });


        //сразу выходим, если нет разрешенных тегов, это ошибка настройки
        if (!numlastag) return false;

        var string = '^.*?';

        var checknumlastag = 0;
        var checknumarray = 0;


        var lastselector = '';

        var selectorsnum = 0;

	var notcheckchild = 0;
	var directchilds = [];

        field_value_selector.split(/(\s*\>\s*)|(\s+)/).forEach(function(token) {

            //что бы не перебирать дальше пустые пробелы или > в конце строки, на всякий случай, если есть пробел
            if (checknumlastag > numlastag) return;

            //это не найденные элементы
            if ((token == '') || (typeof token == 'undefined')) return;
            token = token.trim()
            if (token == '') {
                //space
                //alert(token + '=space')
                checknumarray++

                if (checknumarray > 1) {
                    //не вставляем первый элемент (дублирует начало строки string)
                    string += '.*?';
                }

            } else if (token == '>') {
                //>
                //alert(token + '=>')
                checknumarray++

                if (checknumarray > 1) {
                    //не вставляем первый элемент (дублирует начало строки string)
//		    string += '[^\\<]*';
//что бы пропускало одинокие < (которые не относятся к тегам)
//		    string += '(?:(?!\\<[a-zA-Z]).)*';
		    //string += '(?:(?!\\<[a-zA-Z][^\\>\\<]*\\>).)*';
//это набор символов, среди которых нет какого-либо открывающего тега
		    string += '(?:(?!\\<[a-zA-Z][a-zA-Z0-9]*(?:[\\s\\/][^\\>]*)?\\>).)*';

			//для прямых потомков не надо поверять вхождение потомка в innerHTML родителя (он сразу идет за тегом родителя)
			notcheckchild = 1;


                }

            } else {
                //selector
                //alert(token + '=selector')
                var s = parse(token);

                if ((s.tags && s.tags[0]) || (s.child && s.child[0]) || (s.ids && s.ids[0]) || (s.classes && s.classes[0]) || (s.attrs && s.attrs[0] && s.attrs[0][0])) {
                    checknumlastag++;
                    checknumarray++
                } else {
			//неизвестный селектор, продолжаем
			return;
		}

                if (checknumlastag == numlastag) {
                    var lastag = 1;
                    lastselector = token;
                } else {
                    var lastag = 0;
                }


		//выделяем каждый проверяемый мини-селектор кавычками и считаем их
		selectorsnum++;
		if (lastag) {
                	var tagstring = '';
		} else {
	                var tagstring = '(';
		}


		if (notcheckchild) {
//заносим в список прямых потомков, которых не нужно проверять
//не нужно проверять, есть есть знак > и если нет nth-child или nth-child = 1
			if (!(s.child && (s.child[0] > 1)))
				directchilds[selectorsnum] = 1;
		}
		notcheckchild = 0;


                var child = 0;

                    //вне конкурса tag
                if (s.tags && s.tags[0]) {
                    //есть tag
                    if (s.child && s.child[0]) {
                        //у него есть nth-child
                        s.child[0] -= 0;
//последнему чилду в последнем селекторе надо открыть скобку, иначе все чилды попадут в выделение
	                var maxnumchild = s.child[0] - 1;
                        for (var k = 0; k < s.child[0]; k++) {
			    child = 1;
/*

//например div:nth-child(4) это не 4-й div-потомок, а просто 4-й потомок у которого должен быть div
//то есть считаются любые потомки, а не только div, поэтому тег здесь мы указываем только у последнего
//правда считаются прямые потомки, а не потомки потомков, но это мы не можем сделать
                            if (!k) {
				if ((lastag)&&(maxnumchild == k)) {
        	                        tagstring += '(\\<' + s.tags[0];
				} else if (maxnumchild == k) {
                        	        tagstring += '\\<' + s.tags[0];
				} else {
	                                tagstring += '\\<[a-zA-Z][a-zA-Z0-9]*';
				}
       	                    } else {
				if ((lastag)&&(maxnumchild == k)) {
                	                tagstring += '.*?(\\<' + s.tags[0];
				} else if (maxnumchild == k) {
	                                tagstring += '.*?\\<' + s.tags[0];
				} else {
	                                tagstring += '.*?\\<[a-zA-Z][a-zA-Z0-9]*';
				}
                            }

*/
//крайне неудобно считать потом всех вложенных потомков, если их много перед тегом
//поэтому вернул старый вариант - считаем потомков только с указанным тегом

                            if (!k) {
				if ((lastag)&&(maxnumchild == k)) {
	                                tagstring += '(\\<' + s.tags[0];
				} else {
	                                tagstring += '\\<' + s.tags[0];
				}
                            } else {
				if ((lastag)&&(maxnumchild == k)) {
	                                tagstring += '.*?(\\<' + s.tags[0];
				} else {
	                                tagstring += '.*?\\<' + s.tags[0];
				}
                            }


			    tagstring += '(?=[\\s\\>\\/])';
			    tagstring = addattr(s,tagstring);

                        }
                    } else {
                        tagstring += '\\<' + s.tags[0];
	                tagstring += '(?=[\\s\\>\\/])';
			tagstring = addattr(s,tagstring);
                    }



                } else if (s.child && s.child[0]) {

			//тег любой, есть чилды
                        //у него есть nth-child
                        s.child[0] -= 0;
//последнему чилду в последнем селекторе надо открыть скобку, иначе все чилды попадут в выделение
	                var maxnumchild = s.child[0] - 1;
                        for (var k = 0; k < s.child[0]; k++) {
			    child = 1;
                            if (!k) {
				if ((lastag)&&(maxnumchild == k)) {

	                                tagstring += '(\\<[a-zA-Z][a-zA-Z0-9]*';
				} else {
	                                tagstring += '\\<[a-zA-Z][a-zA-Z0-9]*';
				}
                            } else {
				if ((lastag)&&(maxnumchild == k)) {
	                                tagstring += '.*?(\\<[a-zA-Z][a-zA-Z0-9]*';
				} else {
	                                tagstring += '.*?\\<[a-zA-Z][a-zA-Z0-9]*';
				}
                            }
	                    tagstring += '(?=[\\s\\>\\/])';
			    tagstring = addattr(s,tagstring);

                        }


		} else {
			//тег любой
			tagstring += '\\<[a-zA-Z][a-zA-Z0-9]*';
                        tagstring += '(?=[\\s\\>\\/])';
			tagstring = addattr(s,tagstring);
		}



		//закрываем тег
		tagstring += '(?:[\\s\\/][^\\>]*)?\\>';


                if (lastag) {
		    if (child) {
//чидлу уже открыли скобку выше
//	                    string += tagstring + '.*)$';
//кроме основного, дополнительно закрываем кавычки по числу обнаруженных мини-селекторов - 1
	                    string += tagstring + '.*)' + Array(selectorsnum).join(')') + '$';
		    } else {
//	                    string += '(' + tagstring + '.*)$';
//кроме основного, дополнительно закрываем кавычки по числу обнаруженных мини-селекторов - 1
	                    string += '(' + tagstring + '.*)' + Array(selectorsnum).join(')') + '$';
		    }
                } else {
                    string += tagstring;
                }



            }


        });
//итого вложенных пар кавычек в regexp = число мини-селекторов (последний - это селектор, который мы ищем)
        return {
            'regexp': string,
            'selector': lastselector,
            'selectorsnum': selectorsnum,
	    'directchilds': directchilds,
            'fullselector': field_value_selector
        };
    }


    function addattr(s,tagstring) {
//добавляем атрибуты, id, классы
//выделено отдельно для корректного использования :nth-child

                //затем добавляем все остальные варианты

                if (s.ids && s.ids[0]) {
			//id

			//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)

			//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
			//tagstring += '(?=(?:[^\\<\\>]*)? id\\s*=\\s*(?:(?:' + s.ids[0] +  ')|(?:[\\\'\\"]' + s.ids[0] +  '[\\\'\\"]))[\\s\\>\\/])';

			//исправлено (отдельно отслеживаются кавычки '"")
			//tagstring += '(?=(?:[^\\<\\>]*)? id\\s*=\\s*(?:(?:' + s.ids[0] +  ')|(?:\\\'' + s.ids[0] +  '\\\')|(?:\\"' + s.ids[0] +  '\\"))[\\s\\>\\/])';

			//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
			tagstring += '(?=(?:[^\\<\\>]*)? id\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.ids[0] +  ')|(?:\\\'' + s.ids[0] +  '\\\')|(?:\\"' + s.ids[0] +  '\\"))[\\s\\>\\/])';

			//проверены ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
			//хотя к id это врядли относиться


                }

		if (s.classes && s.classes[0]) {
                    //классы
                    for (var j in s.classes) {

			//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)


			//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
			//tagstring += '(?=(?:[^\\<\\>]*)? class\\s*=\\s*(?:(?:' + s.classes[j] +  ')|(?:[\\\'\\"]\\s*(?:(?:[^\\\'\\"\\>\\<\\/\\=]* ' + s.classes[j] + ' [^\\\'\\"\\>\\<\\/\\=]*)|(?:' + s.classes[j] + ' [^\\\'\\"\\>\\<\\/\\=]*)|(?:[^\\\'\\"\\>\\<\\/\\=]* ' + s.classes[j] + ')|(?:' + s.classes[j] + '))\\s*[\\\'\\"]))[\\s\\>\\/])';

			//исправлено (отдельно отслеживаются кавычки '"")
			//tagstring += '(?=(?:[^\\<\\>]*)? class\\s*=\\s*(?:(?:' + s.classes[j] +  ')|(?:\\\'\\s*(?:(?:[^\\\'\\>\\<\\/\\=]* ' + s.classes[j] + ' [^\\\'\\>\\<\\/\\=]*)|(?:' + s.classes[j] + ' [^\\\'\\>\\<\\/\\=]*)|(?:[^\\\'\\>\\<\\/\\=]* ' + s.classes[j] + ')|(?:' + s.classes[j] + '))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<\\/\\=]* ' + s.classes[j] + ' [^\\"\\>\\<\\/\\=]*)|(?:' + s.classes[j] + ' [^\\"\\>\\<\\/\\=]*)|(?:[^\\"\\>\\<\\/\\=]* ' + s.classes[j] + ')|(?:' + s.classes[j] + '))\\s*\\"))[\\s\\>\\/])';

			//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
			//tagstring += '(?=(?:[^\\<\\>]*)? class\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.classes[j] +  ')|(?:\\\'\\s*(?:(?:[^\\\'\\>\\<\\/\\=]* ' + s.classes[j] + ' [^\\\'\\>\\<\\/\\=]*)|(?:' + s.classes[j] + ' [^\\\'\\>\\<\\/\\=]*)|(?:[^\\\'\\>\\<\\/\\=]* ' + s.classes[j] + ')|(?:' + s.classes[j] + '))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<\\/\\=]* ' + s.classes[j] + ' [^\\"\\>\\<\\/\\=]*)|(?:' + s.classes[j] + ' [^\\"\\>\\<\\/\\=]*)|(?:[^\\"\\>\\<\\/\\=]* ' + s.classes[j] + ')|(?:' + s.classes[j] + '))\\s*\\"))[\\s\\>\\/])';

			//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
			tagstring += '(?=(?:[^\\<\\>]*)? class\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.classes[j] +  ')|(?:\\\'\\s*(?:(?:[^\\\'\\>\\<]* ' + s.classes[j] + ' [^\\\'\\>\\<]*)|(?:' + s.classes[j] + ' [^\\\'\\>\\<]*)|(?:[^\\\'\\>\\<]* ' + s.classes[j] + ')|(?:' + s.classes[j] + '))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<]* ' + s.classes[j] + ' [^\\"\\>\\<]*)|(?:' + s.classes[j] + ' [^\\"\\>\\<]*)|(?:[^\\"\\>\\<]* ' + s.classes[j] + ')|(?:' + s.classes[j] + '))\\s*\\"))[\\s\\>\\/])';


                    }
                }


		if (s.attrs && s.attrs[0] && s.attrs[0][0]) {
                    //атрибуты
		    //https://webdevelopernotes.ru/2011/03/27/attribute-selectors-list/
                    var atrs = '';
                    for (var j in s.attrs) {
			if (s.attrs[j][1]) {
				if (s.attrs[j][2] == '*') {
					//*= Значение атрибута содержит указанный текст

					//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)


					//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:[^\\\'\\"\\s\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[^\\\'\\"\\s\\>\\<\\/\\=]*)|(?:[\\\'\\"][^\\\'\\"\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[^\\\'\\"\\>\\<\\/\\=]*[\\\'\\"]))[\\s\\>\\/])';
	
					//исправлено (отдельно отслеживаются кавычки '"")
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:[^\\\'\\"\\s\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[^\\\'\\"\\s\\>\\<\\/\\=]*)|(?:\\\'[^\\\'\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[^\\\'\\>\\<\\/\\=]*\\\')|(?:\\"[^\\"\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[^\\"\\>\\<\\/\\=]*\\"))[\\s\\>\\/])';

					//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])[^\\s\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[^\\s\\>\\<\\/\\=]*)|(?:\\\'[^\\\'\\>\\<\\/\\=]*' + s.attrs[j][1] + '[^\\\'\\>\\<\\/\\=]*\\\')|(?:\\"[^\\"\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[^\\"\\>\\<\\/\\=]*\\"))[\\s\\>\\/])';


					//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
					tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])[^\\s\\>\\<]*' + s.attrs[j][1] +  '[^\\s\\>\\<]*)|(?:\\\'[^\\\'\\>\\<]*' + s.attrs[j][1] + '[^\\\'\\>\\<]*\\\')|(?:\\"[^\\"\\>\\<]*' + s.attrs[j][1] +  '[^\\"\\>\\<]*\\"))[\\s\\>\\/])';


				} else if (s.attrs[j][2] == '^') {
					//^= Значение атрибута начинается с указанного текста

					//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)

					//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  '[^\\\'\\"\\s\\>\\<\\/\\=]*)|(?:[\\\'\\"]' + s.attrs[j][1] +  '[^\\\'\\"\\>\\<\\/\\=]*\s*[\\\'\\"]))[\\s\\>\\/])';

					//исправлено (отдельно отслеживаются кавычки '"")
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  '[^\\\'\\"\\s\\>\\<\\/\\=]*)|(?:\\\'' + s.attrs[j][1] +  '[^\\\'\\>\\<\\/\\=]*\s*\\\')|(?:\\"' + s.attrs[j][1] +  '[^\\"\\>\\<\\/\\=]*\s*\\"))[\\s\\>\\/])';

					//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.attrs[j][1] +  '[^\\s\\>\\<\\/\\=]*)|(?:\\\'' + s.attrs[j][1] +  '[^\\\'\\>\\<\\/\\=]*\s*\\\')|(?:\\"' + s.attrs[j][1] +  '[^\\"\\>\\<\\/\\=]*\s*\\"))[\\s\\>\\/])';

					//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
					tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.attrs[j][1] +  '[^\\s\\>\\<]*)|(?:\\\'' + s.attrs[j][1] +  '[^\\\'\\>\\<]*\s*\\\')|(?:\\"' + s.attrs[j][1] +  '[^\\"\\>\\<]*\s*\\"))[\\s\\>\\/])';

				} else if (s.attrs[j][2] == '$') {
					//$= Значение атрибута оканчивается указанным текстом

					//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)

					//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:[^\\\'\\"\\s\\>\\<\\/\\=]*' + s.attrs[j][1] +  ')|(?:[\\\'\\"]\s*[^\\\'\\"\\>\\<\\/\\=]*' + s.attrs[j][1] +  '[\\\'\\"]))[\\s\\>\\/])';

					//исправлено (отдельно отслеживаются кавычки '"")
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:[^\\\'\\"\\s\\>\\<\\/\\=]*' + s.attrs[j][1] +  ')|(?:\\\'\s*[^\\\'\\>\\<\\/\\=]*' + s.attrs[j][1] +  '\\\')|(?:\\"\s*[^\\"\\>\\<\\/\\=]*' + s.attrs[j][1] +  '\\"))[\\s\\>\\/])';

					//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])[^\\s\\>\\<\\/\\=]*' + s.attrs[j][1] +  ')|(?:\\\'\s*[^\\\'\\>\\<\\/\\=]*' + s.attrs[j][1] +  '\\\')|(?:\\"\s*[^\\"\\>\\<\\/\\=]*' + s.attrs[j][1] +  '\\"))[\\s\\>\\/])';


					//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
					tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])[^\\s\\>\\<]*' + s.attrs[j][1] +  ')|(?:\\\'\s*[^\\\'\\>\\<]*' + s.attrs[j][1] +  '\\\')|(?:\\"\s*[^\\"\\>\\<]*' + s.attrs[j][1] +  '\\"))[\\s\\>\\/])';



				} else if (s.attrs[j][2] == '|') {
					//|= Дефис в значении атрибута
					//Весь атрибут либо начинается с этой части и затем следует дефис, либо состоит только из этой части


					//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)

		
					//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  '(?:[\\-][^\\\'\\"\\s\\>\\<\\/\\=]*)?)|(?:[\\\'\\"]' + s.attrs[j][1] +  '(?:[\\-][^\\\'\\"\\>\\<\\/\\=]*)?[\\\'\\"]))[\\s\\>\\/])';


					//исправлено (отдельно отслеживаются кавычки '"")
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  '(?:[\\-][^\\\'\\"\\s\\>\\<\\/\\=]*)?)|(?:\\\'' + s.attrs[j][1] +  '(?:[\\-][^\\\'\\>\\<\\/\\=]*)?\\\')|(?:\\"' + s.attrs[j][1] +  '(?:[\\-][^\\"\\>\\<\\/\\=]*)?\\"))[\\s\\>\\/])';

					//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.attrs[j][1] +  '(?:[\\-][^\\s\\>\\<\\/\\=]*)?)|(?:\\\'' + s.attrs[j][1] +  '(?:[\\-][^\\\'\\>\\<\\/\\=]*)?\\\')|(?:\\"' + s.attrs[j][1] +  '(?:[\\-][^\\"\\>\\<\\/\\=]*)?\\"))[\\s\\>\\/])';


					//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
					tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.attrs[j][1] +  '(?:[\\-][^\\s\\>\\<]*)?)|(?:\\\'' + s.attrs[j][1] +  '(?:[\\-][^\\\'\\>\\<]*)?\\\')|(?:\\"' + s.attrs[j][1] +  '(?:[\\-][^\\"\\>\\<]*)?\\"))[\\s\\>\\/])';



				} else if (s.attrs[j][2] == '~') {
					//~= Одно из нескольких значений атрибута
					//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)

		
					//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  ')|(?:[\\\'\\"]\\s*(?:(?:[^\\\'\\"\\>\\<\\/\\=]* ' + s.attrs[j][1] + ' [^\\\'\\"\\>\\<\\/\\=]*)|(?:' + s.attrs[j][1] + ' [^\\\'\\"\\>\\<\\/\\=]*)|(?:[^\\\'\\"\\>\\<\\/\\=]* ' + s.attrs[j][1] + ')|(?:' + s.attrs[j][1] + '))\\s*[\\\'\\"]))[\\s\\>\\/])';


					//исправлено (отдельно отслеживаются кавычки '"")
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  ')|(?:\\\'\\s*(?:(?:[^\\\'\\>\\<\\/\\=]* ' + s.attrs[j][1] + ' [^\\\'\\>\\<\\/\\=]*)|(?:' + s.attrs[j][1] + ' [^\\\'\\>\\<\\/\\=]*)|(?:[^\\\'\\>\\<\\/\\=]* ' + s.attrs[j][1] + ')|(?:' + s.attrs[j][1] + '))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<\\/\\=]* ' + s.attrs[j][1] + ' [^\\"\\>\\<\\/\\=]*)|(?:' + s.attrs[j][1] + ' [^\\"\\>\\<\\/\\=]*)|(?:[^\\"\\>\\<\\/\\=]* ' + s.attrs[j][1] + ')|(?:' + s.attrs[j][1] + '))\\s*\\"))[\\s\\>\\/])';

					//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.attrs[j][1] +  ')|(?:\\\'\\s*(?:(?:[^\\\'\\>\\<\\/\\=]* ' + s.attrs[j][1] + ' [^\\\'\\>\\<\\/\\=]*)|(?:' + s.attrs[j][1] + ' [^\\\'\\>\\<\\/\\=]*)|(?:[^\\\'\\>\\<\\/\\=]* ' + s.attrs[j][1] + ')|(?:' + s.attrs[j][1] + '))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<\\/\\=]* ' + s.attrs[j][1] + ' [^\\"\\>\\<\\/\\=]*)|(?:' + s.attrs[j][1] + ' [^\\"\\>\\<\\/\\=]*)|(?:[^\\"\\>\\<\\/\\=]* ' + s.attrs[j][1] + ')|(?:' + s.attrs[j][1] + '))\\s*\\"))[\\s\\>\\/])';

					//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
					tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.attrs[j][1] +  ')|(?:\\\'\\s*(?:(?:[^\\\'\\>\\<]* ' + s.attrs[j][1] + ' [^\\\'\\>\\<]*)|(?:' + s.attrs[j][1] + ' [^\\\'\\>\\<]*)|(?:[^\\\'\\>\\<]* ' + s.attrs[j][1] + ')|(?:' + s.attrs[j][1] + '))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<]* ' + s.attrs[j][1] + ' [^\\"\\>\\<]*)|(?:' + s.attrs[j][1] + ' [^\\"\\>\\<]*)|(?:[^\\"\\>\\<]* ' + s.attrs[j][1] + ')|(?:' + s.attrs[j][1] + '))\\s*\\"))[\\s\\>\\/])';


				} else {
					//= Значение атрибута равно указанному тексту

					//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)


					//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  ')|(?:[\\\'\\"]' + s.attrs[j][1] +  '[\\\'\\"]))[\\s\\>\\/])';

					//исправлено (отдельно отслеживаются кавычки '"")
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:' + s.attrs[j][1] +  ')|(?:\\\'' + s.attrs[j][1] +  '\\\')|(?:\\"' + s.attrs[j][1] +  '\\"))[\\s\\>\\/])';

					//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
					tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])' + s.attrs[j][1] +  ')|(?:\\\'' + s.attrs[j][1] +  '\\\')|(?:\\"' + s.attrs[j][1] +  '\\"))[\\s\\>\\/])';

					//проверены ограничения на \\/ \\= (они могут быть в значениях атрибутов!, особенно src href)


				}
			} else {
				//= Значение атрибута отсутствует или любое

					//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)


					//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '(?:\\s*=\\s*(?:(?:[^\\\'\\"\\s\\>\\<\\/\\=]+)|(?:[\\\'\\"]\\s*[^\\\'\\"\\s\\>\\<\\/\\=]+[^\\\'\\"\\>\\<\\/\\=]*\\s*[\\\'\\"])))?[\\s\\>\\/])';

					//исправлено (отдельно отслеживаются кавычки '"")
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '(?:\\s*=\\s*(?:(?:[^\\\'\\"\\s\\>\\<\\/\\=]+)|(?:\\\'\\s*[^\\\'\\s\\>\\<\\/\\=]+[^\\\'\\>\\<\\/\\=]*\\s*\\\')|(?:\\"\\s*[^\\"\\s\\>\\<\\/\\=]+[^\\"\\>\\<\\/\\=]*\\s*\\")))?[\\s\\>\\/])';


					//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
					//tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '(?:\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])[^\\s\\>\\<\\/\\=]+)|(?:\\\'\\s*[^\\\'\\s\\>\\<\\/\\=]+[^\\\'\\>\\<\\/\\=]*\\s*\\\')|(?:\\"\\s*[^\\"\\s\\>\\<\\/\\=]+[^\\"\\>\\<\\/\\=]*\\s*\\")))?[\\s\\>\\/])';

					//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
					tagstring += '(?=(?:[^\\<\\>]*)? ' + s.attrs[j][0] + '(?:\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])[^\\s\\>\\<]+)|(?:\\\'\\s*[^\\\'\\s\\>\\<]+[^\\\'\\>\\<]*\\s*\\\')|(?:\\"\\s*[^\\"\\s\\>\\<]+[^\\"\\>\\<]*\\s*\\")))?[\\s\\>\\/])';



			}
        	    }
	
		}
		


	return tagstring;
    }




    //https://stackoverflow.com/questions/17888039/javascript-efficient-parsing-of-css-selector
    function parse(subselector) {
        var obj = {
            tags: [],
            classes: [],
            ids: [],
            child: [],
            attrs: []
        };


//доработал, иначе краш например на '[href="aaaa."]'
//        subselector.split(/(?=\.)|(?=#)|(?=\:)|(?=\[)/).forEach(function(token) {
        subselector.split(/(?=\.[^\[\]]+(?:$|\[))|(?=#[^\[\]]+(?:$|\[))|(?=\:[^\[\]]+(?:$|\[))|(?=\[)/).forEach(function(token) {
            switch (token[0]) {
                case '#':
                    obj.ids.push(token.slice(1));
                    break;
                case '.':
                    obj.classes.push(token.slice(1));
                    break;
                case ':':
                    obj.child.push(token.slice(11, -1));
                    break;
                case '[':
                    obj.attrs.push(token.slice(1, -1).split(/\s*=\s*/, 2));
		    var elnum = obj.attrs.length - 1;
		    if (obj.attrs[elnum].length == 2)
			//удаляем в значении атрибута кавычки '"
			obj.attrs[elnum][1] = obj.attrs[elnum][1].replace(/^[\'\"]*(.*?)[\'\"]*$/, "$1");
		    var match = obj.attrs[elnum][0].match(/^(.*)([\~\^\$\*\|])$/);
		    if (match&&match[2]) {
		            obj.attrs[elnum][0] = match[1];
			    //добавляем третий элемент в качестве признака ^= ~= $= *= |=
		            obj.attrs[elnum][2] = match[2];
		    }
                    break;
                default:
                    obj.tags.push(token);
                    break;
            }
        });
        return obj;
    }



//http://blog.stevenlevithan.com/archives/javascript-match-nested
//переделано под игнорирование регистра символов
//переделано под анализ незакрытых тегов (иначе удаляло часть кода вначале или при отсутсвии закрывающих полностью все)
//работает только results[0], остальные выдадут неверну инфу, иначе пришлось бы еще долго заморачиваться
//находит с заданного элемента и до его закрывающего элемента, с учетом вложенности


/*** matchRecursive
	accepts a string to search and a format (start and end tokens separated by "...").
	returns an array of matches, allowing nested instances of format.

	examples:
		matchRecursive("test",          "(...)")   -> []
		matchRecursive("(t(e)s)()t",    "(...)")   -> ["t(e)s", ""]
		matchRecursive("t<e>>st",       "<...>")   -> ["e"]
		matchRecursive("t<<e>st",       "<...>")   -> ["e"]
		matchRecursive("t<<e>>st",      "<...>")   -> ["<e>"]
		matchRecursive("<|t<e<|s|>t|>", "<|...|>") -> ["t<e<|s|>t"]
*/

var matchRecursive = function () {
	var	formatParts = /^([\S\s]+?)\.\.\.([\S\s]+)/,
		metaChar = /[-[\]{}()*+?.\\^$|,]/g,
		escape = function (str) {
			return str.replace(metaChar, "\\$&");
		};

	return function (str, format) {
		var p = formatParts.exec(format);
		if (!p) throw new Error("format must include start and end tokens separated by '...'");
		if (p[1] == p[2]) throw new Error("start and end format tokens cannot be identical");

		var	opener = p[1],
			closer = p[2],
			/* Use an optimized regex when opener and closer are one character each */
//			iterator = new RegExp(format.length == 5 ? "["+escape(opener+closer)+"]" : escape(opener)+"|"+escape(closer), "g"),
//игнорируем регистр
			iterator = new RegExp(format.length == 5 ? "["+escape(opener+closer)+"]" : escape(opener)+"|"+escape(closer), "ig"),
			results = [],
			openTokens, matchStartIndex, match;

		var foundfirst = 0, matchStartIndex2;

		do {
			openTokens = 0;
			while (match = iterator.exec(str)) {
//				if (match[0] == opener) {
//игнорируем регистр
				if (match[0].toLowerCase() == opener.toLowerCase()) {
					if (!openTokens)
						matchStartIndex = iterator.lastIndex;
					if (!foundfirst) {
//здесь реализован механизм сохранения с первого найденного тега, если нет части закрыващих тегов
//иначе сохранит только начиная с закрывающихся тегов
						matchStartIndex2 = iterator.lastIndex;
						foundfirst = 1;
					}
					openTokens++;
				} else if (openTokens) {
					openTokens--;
					if (!openTokens) {
//						results.push(str.slice(matchStartIndex, match.index));
//записываем с первого найденного (это важно для 0-го элемента, который мы используем, на остальных нам без разницы, хотя для них так неправильно)
//с остальными совпадениями даже не буду заморачиваться
						results.push(str.slice(matchStartIndex2, match.index));
//выходим полностью из всех циклов, что бы не тратить время на лишние итерации
						break;
					}
				}
			}

		} while (openTokens && (iterator.lastIndex = matchStartIndex));

		if (foundfirst&&(!results.length)) {
//если был обнаружен первый элемент, но нет выходных данных, значит нет ни одного закрывающего элемента
//надо весь массив занести до конца
			results.push(str.slice(matchStartIndex2));

		}

		return results;
	};
}();



    if (typeof field_value_selector == 'undefined') {
	field_value_selector = '';
    }

    if (typeof html != 'string') {
	if (fieldName) {
		var add = ', fieldName:' + fieldName;
	} else {
		var add = '';
	}
        return {
            'errors': 'Html is not string' + add,
            'result': false
        };
    }


    if (typeof field_value_selector != 'string') {
	if (fieldName) {
		var add = ', fieldName:' + fieldName;
	} else {
		var add = '';
	}
        return {
            'errors': 'parameter field_value_selector is not string' + add,
            'result': false
        };
    }



if (clearhtml) {
//это делать обязательно, но если еще не сделано, иначе лишняя трата времени
    html = html.replace(/\r/g, " "); // Remove newlines
    html = html.replace(/\n/g, " "); // Remove newlines
    html = html.replace(/\t/g, " "); // Remove tabs
    html = html.replace(/(\<\!\-\-.*?\-\-\>)/g, ""); // Remove commented text
    html = html.replace(/(\<script.*?\<\/script\>)/igm, '<s'+'cript></s'+'cript>');
    html = html.replace(/(\<noscript.*?\<\/noscript\>)/igm, '<nos'+'cript></nos'+'cript>');
    html = html.replace(/(\<link .*?\>)/igm, '<l'+'ink>');
    html = html.replace(/(\<style.*?\<\/style\>)/igm, '<s'+'tyle></s'+'tyle>');
}


    html = html.trim();
    if (html == '') {
//html пустой, не нашли там наши теги по определению, это не ошибка
        return {
            'errors': '',
            'html': '',
            'result': ''
        };
    }


    var htmllen = html.length;
    var selector = false;
    var error = '';

if (field_value_selector !== '') {
//если пусто то все значение html берется

    field_value_selector.split(/\s*\,\s*/).forEach(function(token) {

        var sel = parseOneLastSelector(token);

        if (!sel) {
		if (fieldName) {
		    error += 'Error in selector: ' + token + ' fieldName:' + fieldName + "\n";
		} else {
		    error += 'Error in selector: ' + token + "\n";
		}
	}
	if (error) {
		//если есть ошибка в селекторе, остальные просто проверяем на ошибки без дальнейшего парсинга
		 return;
	}

	//используем первый сработавший селектор
        if (selector) return;



        var re = new RegExp(sel['regexp'], "i");

	var match = null;
	try {
//Проблема в google scripts: ошибка
//Regular expression operation exceeded execution time limit.
//проверил на 2-х вариантах страниц - у меня ошибка возникает, когда нет совпадения, не найден селектор
		match = html.match(re);
	} catch (e) {}


	if (match&&match[sel['selectorsnum']]) {
//найден непустой последний мини-селектор
//теперь проверяем вхождение каждого следующего селектора в предыдущий (является потомком или нет)
//так как у нас reqexp вместо DOM (просто ищем следующий без анализа он потомок или нет)
//то надо проверить потомков после (хотя в большинстве случаем сработает и так, так как мы ищем ближайщий тег к предыдущему, но надо проверить)
//если нет закрывающих тегов, то может тоже "пропустить" дальше конца своего тега
//практически полностью повторяет функционал для поиска text

		//флаг, что найдены вхождения всех следующих мини-селекторов в предыдущие (то есть все следующие точно потомки)
		var foundnextchilds = 1;

		for (var i=1; i<sel['selectorsnum']; i++) {
//от первого до предпоследнего селектора проверяем их потомков

//у этого элемента прямой потомок, которого не нужно проверять (то есть у него нет nth-child либо он равен 1)
			if (sel['directchilds'][i+1])
				continue;

//найти внутреннее содержимое элемента (innerHTML)
//обязательно начинается с открывающего тега элемента и до конца страницы
//предусмотрено даже для одиночных элементов (до открывающего неодиночного элемента)
//	то есть весь код после одиночного элемента до открывающего тега
//основная задача функции - найти текст "внутри" элемента


			var re = '^\\<([a-zA-Z][a-zA-Z0-9]*)[\\s\\<\\>\\/].*$';
			var tag = match[i].replace(new RegExp(re, "i"), "$1");
			if (tag == match[i]) {
//не нашли тег, такого не может быть, ошибка регулярных выражений селектора
				if (fieldName) {
				    error += 'Error in selector reqexp for fieldName:' + fieldName + "\n";
				} else {
				    error += "Error in selector reqexp\n";
				}
				foundnextchilds = 0;
				break;
			}

			var text = matchRecursive(match[i],'<' + tag + '...</' + tag + '>')
			if (!text.length) {
//не нашли открывающий тег, такого здесь не может быть, ошибка функции matchRecursive
				if (fieldName) {
				    error += 'Error in function matchRecursive for fieldName:' + fieldName + "\n";
				} else {
				    error += "Error in function matchRecursive\n";
				}
				foundnextchilds = 0;
				break;
			}

			text = text[0];


			//здесь осталась закрывающая часть тега, надо убрать (но запомнить, что бы позже добавить)
			var re = '^([^\\>]*\\>)(.*?)$';
			var match2 = text.match(new RegExp(re, "i"));

			if (!(match2&&match2[1])) {
//такого не должно быть, нет закрывающего > в открывающем теге, ошибка
				if (fieldName) {
				    error += 'Error: not found end tag symbol ">" for fieldName:' + fieldName + "\n";
				} else {
				    error += "Error: not found end tag symbol ">"\n";
				}
				foundnextchilds = 0;
				break;
			}

			text = match2[2];

			//здесь это несколько бредово - анализировать "потомков" одиночных тегов, но оставил, ничего не меняет, все равно их надо обнаруживать
			//правильно было их отбрасывать здесь, если вставлены в середине, а не последний мини-селектор
			//зато теперь есть сомнительная "уникальная" возможность - промежуточные мини-селекторы могут быть одиночными тегами
			//	после которых могут идти только такие же одиночные теги
			//типа div > br > hr

			//если это одиночный тег, то выводим все до первого неодиночного тега или неодиночного закрывающего тега
			var re = new RegExp('^(?:area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$', "i");
			if (re.test(tag)) {
				var re = '^((?:(?:\\<area)|(?:\\<base)|(?:\\<basefont)|(?:\\<br)|(?:\\<col)|(?:\\<frame)|(?:\\<hr)|(?:\\<img)|(?:\\<input)|(?:\\<isindex)|(?:\\<link)|(?:\\<meta)|(?:\\<param)|(?:[^\\<]+))*).*?$';
				text = text.replace(new RegExp(re, "i"), "$1")
			}

			//нашли innerHTML (без самого оборачивающего тега)
			//теперь добавим обратно открывающий тег (закрывающий тег неважен), внутри тега должен быть потомок

			text = '<' + tag + match2[1] + text;


			//а теперь проверяем следующий найденный тег на предмет вхождения в этот (потомок или нет)
			//начало потомка должно входить в текущий тег

			//считаем элементы строки от 0, как в функциях строк обычно делается
			var endtagnum = htmllen - match[i].length + text.length;
			var startnexttagnum = htmllen - match[i+1].length;


			if (startnexttagnum > endtagnum) {
				foundnextchilds = 0;
				break;
			}


		}


		if (foundnextchilds) {
			selector = sel;
			//наш html - это html-код последнего мини-селектора
     		        selector['html'] = match[sel['selectorsnum']].trim();
		}


	}


/*
//так было, когда искали только один последний селектор
        var re = new RegExp(sel['regexp'], "i");
        if (re.test(html)) {
		var b = html.replace(re, "$1")
		selector = sel;
     	        selector['html'] = b.trim();
        }
*/


    });


} else {

	selector={};
	selector['fullselector'] = field_value_selector;

	selector['html'] = html;

}



    if (error) {
//ошибка в селекторах
        return {
            'errors': error,
            'result': false
        };
    }

    if (!selector) {
//селекторы не найдены на странице, не ошибка
        return {
            'errors': '',
            'html': '',
            'result': ''
        };
    }


    if (!selector['html']) {
//селектор найден, но пустое его содержимое, не ошибка
        selector['result'] = '';
        selector['errors'] = '';
	return selector;
    }



        if (type == 'text') {
            //если тип текст, то самый последний селектор должен иметь тег
            //здесь можеть быть некорректно обнаружено, если несколько этих тегов 
            //вложены в друг друга, или нет закрывающего тега - тогда используем type = undefined и field_Fun

//найти внутреннее содержимое элемента (innerHTML)
//обязательно начинается с открывающего тега элемента и до конца страницы
//предусмотрено даже для одиночных элементов (до открывающего неодиночного элемента)
//	то есть весь код после одиночного элемента до открывающего тега
//основная задача функции - найти текст "внутри" элемента


            var re = '^\\<([a-zA-Z][a-zA-Z0-9]*)[\\s\\<\\>\\/].*$';
            var tag = selector['html'].replace(new RegExp(re, "i"), "$1");
            if (tag == selector['html']) {
//не нашли тег, такого не может быть, ошибка регулярных выражений селектора
		if (fieldName) {
		    var error = 'Error in selector reqexp for fieldName:' + fieldName + "\n";
		} else {
		    var error = "Error in selector reqexp\n";
		}
		selector['result'] = false;
		selector['errors'] = error;
		return selector;
	    }

/*
            var re = '^[^\\>]*\\>(.*?)\\<\\/' + tag + '\\>.*$';

	    //попытка улучшить поиск закрывающего тега - находим последний тег, если есть вложенные
	    //это не работает, нужна рекурсия!
//            var re = '^[^\\>]*\\>((?:(?:\\<' + tag + '[\\s\\/]?[^\\>]*\\>.*?\\<\\/' + tag + '\\>)*(?!\\<\\/' + tag + '\\>).*?)*.*?)\\<\\/' + tag + '\\>.*$';
//            var re = '^[^\\>]*\\>((?:(?:\\<' + tag + '[\\s\\/]?[^\\>]*\\>.*?\\<\\/' + tag + '\\>)*(?!\\<\\/' + tag + '\\>).*?)*(?!\\<\\/' + tag + '\\>).*?)\\<\\/' + tag + '\\>.*$';

            var text = selector['html'].replace(new RegExp(re, "i"), "$1")

            if (text == selector['html']) {
//не нашли text, не ошибка
		selector['result'] = '';
		selector['errors'] = '';
		return selector;
	    }

*/

	    //улучшен поиск закрывающего тега - находим последний закрывающий тег, если есть вложенные

		var text = matchRecursive(selector['html'],'<' + tag + '...</' + tag + '>')
		if (!text.length) {
//не нашли открывающий тег, такого здесь не может быть, ошибка функции matchRecursive
			if (fieldName) {
			    var error = 'Error in function matchRecursive for fieldName:' + fieldName + "\n";
			} else {
			    var error = "Error in function matchRecursive\n";
			}
			selector['result'] = false;
			selector['errors'] = error;
			return selector;
		}

		text = text[0];
		//здесь осталась закрывающая часть тега, надо убрать
		var re = '^[^\\>]*\\>(.*?)$';
		text = text.replace(new RegExp(re, "i"), "$1")

            if (text == selector['html']) {
//такого не должно быть, нет закрывающего > в открывающем теге, ошибка
		if (fieldName) {
		    var error = 'Error: not found end tag symbol ">" for fieldName:' + fieldName + "\n";
		} else {
		    var error = "Error: not found end tag symbol ">"\n";
		}
		selector['result'] = false;
		selector['errors'] = error;
		return selector;
	    }



		//если это одиночный тег, то выводим все до первого неодиночного тега или неодиночного закрывающего тега
		var re = new RegExp('^(?:area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$', "i");
		if (re.test(tag)) {
			var re = '^((?:(?:\\<area)|(?:\\<base)|(?:\\<basefont)|(?:\\<br)|(?:\\<col)|(?:\\<frame)|(?:\\<hr)|(?:\\<img)|(?:\\<input)|(?:\\<isindex)|(?:\\<link)|(?:\\<meta)|(?:\\<param)|(?:[^\\<]+))*).*?$';
			text = text.replace(new RegExp(re, "i"), "$1")
		}


	    //не чистим от тегов внутри, это делаем уже в дальнейшей функции, если нужно


            selector[type] = text.trim();

	    if (selector[type] == '') {
//не нашли text, не ошибка
		selector['result'] = '';
		selector['errors'] = '';
		return selector;
	    }

//            selector['result'] = text;
            selector['result'] = selector[type];


        } else if (type) {

	    //если есть '" в начале и в конце значения атрибута, то могут быть пробелы в значении аттрибута
	    //если нет '" в начале и в конце, то пробелов не может быть в значении атрибута (это правила верстки)
            //символы '" могут теоретически попадаться в атрибуте - тогда используем type = undefined и field_Fun


	//при отсутствии в начале и в конце символа '" не может быть пробелов в атрибуте (то есть только одно значение возможно)

	//не учитываем ошибку верстки, как браузер (не может быть один символ '" только вначале или только в конце)
	//var re = '^\\<[^\\<\\>]+ ' + type + '(?:\\s*=\\s*(?:([^\\\'\\"\\s\\>\\<\\/\\=]+)|(?:[\\\'\\"]\\s*([^\\\'\\"\\s\\>\\<\\/\\=]+[^\\\'\\"\\>\\<\\/\\=]*)\\s*[\\\'\\"])))?[\\s\\>\\/].*$';
	//var attr = selector['html'].replace(new RegExp(re, "i"), "$1$2")

	//исправлено (отдельно отслеживаются кавычки '"")
	//var re = '^\\<[^\\<\\>]+ ' + type + '(?:\\s*=\\s*(?:([^\\\'\\"\\s\\>\\<\\/\\=]+)|(?:\\\'\\s*([^\\\'\\s\\>\\<\\/\\=]+[^\\\'\\>\\<\\/\\=]*)\\s*\\\')|(?:\\"\\s*([^\\"\\s\\>\\<\\/\\=]+[^\\"\\>\\<\\/\\=]*)\\s*\\")))?[\\s\\>\\/].*$';
	//var attr = selector['html'].replace(new RegExp(re, "i"), "$1$2$3")

	//исправлено (возможны обе кавычки в значениях аттрибутов) (?=[^\\s\\\'\\"])
	//var re = '^\\<[^\\<\\>]+ ' + type + '(?:\\s*=\\s*(?:(?=[^\\s\\\'\\"])([^\\s\\>\\<\\/\\=]+)|(?:\\\'\\s*([^\\\'\\s\\>\\<\\/\\=]+[^\\\'\\>\\<\\/\\=]*)\\s*\\\')|(?:\\"\\s*([^\\"\\s\\>\\<\\/\\=]+[^\\"\\>\\<\\/\\=]*)\\s*\\")))?[\\s\\>\\/].*$';
	//var attr = selector['html'].replace(new RegExp(re, "i"), "$1$2$3")

	//исправлен последний вариант (просто была логическая ошибка, сравнил с //= Значение атрибута отсутствует или любое)
	//var re = '^\\<[^\\<\\>]+ ' + type + '(?:\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])([^\\s\\>\\<\\/\\=]+))|(?:\\\'\\s*([^\\\'\\s\\>\\<\\/\\=]+[^\\\'\\>\\<\\/\\=]*)\\s*\\\')|(?:\\"\\s*([^\\"\\s\\>\\<\\/\\=]+[^\\"\\>\\<\\/\\=]*)\\s*\\")))?[\\s\\>\\/].*$';
	//var attr = selector['html'].replace(new RegExp(re, "i"), "$1$2$3")

	//убраны ограничения на \\/ \\= (может быть в значениях атрибутов!, особенно src href)
	var re = '^\\<[^\\<\\>]+ ' + type + '(?:\\s*=\\s*(?:(?:(?=[^\\s\\\'\\"])([^\\s\\>\\<]+))|(?:\\\'\\s*([^\\\'\\s\\>\\<]+[^\\\'\\>\\<]*)\\s*\\\')|(?:\\"\\s*([^\\"\\s\\>\\<]+[^\\"\\>\\<]*)\\s*\\")))?[\\s\\>\\/].*$';
	var attr = selector['html'].replace(new RegExp(re, "i"), "$1$2$3")



            if (attr == selector['html']) {
//не нашли атрибут, не ошибка
		selector['result'] = '';
		selector['errors'] = '';
		return selector;
	    }


            //selector[type] = attr.trim().toLowerCase();
            selector[type] = attr.trim();

	    if (selector[type] == '') {
//пустой атрибут, не ошибка
		selector['result'] = '';
		selector['errors'] = '';
		return selector;
	    }


//            selector['result'] = attr;
            selector['result'] = selector[type];


        } else {
            selector['result'] = selector['html'];
        }



	if (field_replace) {
		var errmes = '';
		if (typeof field_replace == 'object') {
			if (field_replace.length) {
				if ((typeof field_replace[0] == 'string') && ((typeof field_replace[1] == 'string')||(typeof field_replace[1] == 'function')) && ((typeof field_replace[2] == 'undefined')||(typeof field_replace[1] == 'string'))) {
			            try {
					if (field_replace[2]) {
						var re = new RegExp(field_replace[0], field_replace[2])
					} else {
						var re = new RegExp(field_replace[0])
					}
					if (re.test(selector['result'])) {
						selector['field_replace'] = selector['result'].replace(re, field_replace[1]);
				                selector['field_replace'] = selector['field_replace'].trim();
					} else {
						//не найдено регулярное выражение, не ошибка
						selector['field_replace'] = '';
						selector['result'] = '';
						selector['errors'] = '';
						return selector;
					}
			                selector['result'] = selector['field_replace'];
			            } catch (e) {
					errmes = 'bad parameter field_replace:' + e.message + ' , selector=' + selector['fullselector'];
			            }
				} else {
					errmes = 'bad parameter field_replace, selector=' + selector['fullselector'];
				}
			}
		} else {
			errmes = 'bad parameter field_replace, selector=' + selector['fullselector'];
		}
		if (errmes) {
			if (fieldName) {
				var add = ', fieldName:' + fieldName;
			} else {
				var add = '';
			}
			selector['result'] = false;
			selector['errors'] = errmes + add;
			return selector;
		}
	}


	if (field_Fun) {
		var errmes = '';
		if (typeof field_Fun == 'function') {
	            try {
	                selector['htmlClear'] = field_Fun(selector['result'], selector['fullselector'], url, fieldName, fields);
			if (typeof selector['htmlClear'] != 'string') {
				errmes = 'bad return from function field_Fun, selector=' + selector['fullselector'];
			} else {
	                	selector['htmlClear'] = selector['htmlClear'].trim();
		                selector['result'] = selector['htmlClear'];
			}
        	    } catch (e) {
				errmes = 'bad function field_Fun:' + e.message + ' , selector=' + selector['fullselector'];
	            }
		} else {
			errmes = 'parameter field_Fun is not function, selector=' + selector['fullselector'];
		}
		if (errmes) {
			if (fieldName) {
				var add = ', fieldName:' + fieldName;
			} else {
				var add = '';
			}
			selector['result'] = false;
			selector['errors'] = errmes + add;
			return selector;
		}
        }


    return selector;

}


function parseHtmlFUN(html, field_value_selector, field_replace, field_Fun, url, fields, fieldName) {
//функции очистки кода (если не используется parseHtml)

//field_value_selector - нескольких селекторов (через запятую)
//field_value_selector оставлено для совместимости с parseHtml

    //url, fields только передаются в field_Fun, добавлены для совместимости field_Fun с другими функциями
    //fieldName - информационная переменная для ошибок (в каком поле произошла ошибка)
    //field_replace - поиск и замена регулярного выражения или строки, чистит html-код
    //			три параметра в массиве: что ищем и замены, на что меняем, флаги поиска (флаги необязательны)
    //			['^\\<([^\\s\\<\\>\\/]+)([\\s\\<\\>\\/]).*$', function(match, p1, p2) {},'gim']
    //			['^\\<([^\\s\\<\\>\\/]+)[\\s\\<\\>\\/].*$','$1','gim']
    //field_Fun - чистит html-код после выполнения field_replace
    //			function(html, selector, url, fields) { return html; }


    if (typeof field_value_selector == 'undefined') {
	field_value_selector = '';
    }

    if (typeof html != 'string') {
	if (fieldName) {
		var add = ', fieldName:' + fieldName;
	} else {
		var add = '';
	}
        return {
            'errors': 'Html is not string' + add,
            'result': false
        };
    }


    if (typeof field_value_selector != 'string') {
	if (fieldName) {
		var add = ', fieldName:' + fieldName;
	} else {
		var add = '';
	}
        return {
            'errors': 'parameter field_value_selector is not string' + add,
            'result': false
        };
    }


	selector={};
	selector['fullselector'] = field_value_selector;

	selector['result'] = html;
	selector['html'] = html;



    if (!selector['html']) {
//селектор найден, но пустое его содержимое, не ошибка
        selector['result'] = '';
        selector['errors'] = '';
	return selector;
    }


	if (field_replace) {
		var errmes = '';
		if (typeof field_replace == 'object') {
			if (field_replace.length) {
				if ((typeof field_replace[0] == 'string') && ((typeof field_replace[1] == 'string')||(typeof field_replace[1] == 'function')) && ((typeof field_replace[2] == 'undefined')||(typeof field_replace[1] == 'string'))) {
			            try {
					if (field_replace[2]) {
						var re = new RegExp(field_replace[0], field_replace[2])
					} else {
						var re = new RegExp(field_replace[0])
					}
					if (re.test(selector['result'])) {
						selector['field_replace'] = selector['result'].replace(re, field_replace[1]);
				                selector['field_replace'] = selector['field_replace'].trim();
					} else {
						//не найдено регулярное выражение, не ошибка
						selector['field_replace'] = '';
						selector['result'] = '';
						selector['errors'] = '';
						return selector;
					}
			                selector['result'] = selector['field_replace'];
			            } catch (e) {
					errmes = 'bad parameter field_replace:' + e.message + ' , selector=' + selector['fullselector'];
			            }
				} else {
					errmes = 'bad parameter field_replace, selector=' + selector['fullselector'];
				}
			}
		} else {
			errmes = 'bad parameter field_replace, selector=' + selector['fullselector'];
		}
		if (errmes) {
			if (fieldName) {
				var add = ', fieldName:' + fieldName;
			} else {
				var add = '';
			}
			selector['result'] = false;
			selector['errors'] = errmes + add;
			return selector;
		}
	}


	if (field_Fun) {
		var errmes = '';
		if (typeof field_Fun == 'function') {
	            try {
	                selector['htmlClear'] = field_Fun(selector['result'], selector['fullselector'], url, fieldName, fields);
			if (typeof selector['htmlClear'] != 'string') {
				errmes = 'bad return from function field_Fun, selector=' + selector['fullselector'];
			} else {
	                	selector['htmlClear'] = selector['htmlClear'].trim();
		                selector['result'] = selector['htmlClear'];
			}
        	    } catch (e) {
				errmes = 'bad function field_Fun:' + e.message + ' , selector=' + selector['fullselector'];
	            }
		} else {
			errmes = 'parameter field_Fun is not function, selector=' + selector['fullselector'];
		}
		if (errmes) {
			if (fieldName) {
				var add = ', fieldName:' + fieldName;
			} else {
				var add = '';
			}
			selector['result'] = false;
			selector['errors'] = errmes + add;
			return selector;
		}
        }


    return selector;

}



//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@

//function ItemHeaders(name,shortWordsHash,paths,name2,keyword,startdescription,beforeprice,price,action,description,enddescription,pricetypeadd,priceRound,noPaths,headerTo1Line,needafterdescription,needdescription,notuseparams) {
function ItemHeaders(name,shortWordsHash,paths,name2,name3,keyword,startdescription,beforeprice,price,action,description,enddescription,pricetypeadd,priceRound,noPaths,headerTo1Line,needafterdescription,needdescription,notuseparams) {

//формируем массивы названия, описания и для видимой ссылки
//эти массивы формируются с учетом параметров price,description (если они есть)

//поддержифаются модификаторы объявлений, но обязательно с доп. инфокавычками справа {модификатор объявления}[max длина значения модификатора]
//кавычки удаляются в готовых объявлениях

//что стоит доделать - число дни.часы - параметр 2 в описании после полей beforeprice, price, afterprice
//добавить beforedayshours, dayshours, afterdayshours
//до конца акции ... 
//параметр можно будет использовать как дни.часы, дни или часы
//Таймер обратного отсчета до завершения распродажи
//https://developers.google.com/adwords/scripts/docs/solutions/sale-countdown?hl=ru

//alert(JSON.stringify(ItemHeaders(query,'KeyWord','','Есть в наличии','23 грн.','Лучшая цена, бесплатная доставка',"Описание балалайки: " + query)));
//alert(JSON.stringify(ItemHeaders(query,'KeyWord','','Есть в наличии','23 грн.','Лучшая цена, бесплатная доставка')));
//alert(JSON.stringify(ItemHeaders(query,'KeyWord','','| Есть в наличии','23 грн. ','| Лучшая цена, бесплатная доставка.', ' | ' + query + ' | ', '| Звоните сейчас!',1)));
//alert(JSON.stringify(ItemHeaders(query,'KeyWord','','','3453.00грн.','Лучшая цена, бесплатная доставка!',query, 'Звоните сейчас!')));


//цена (если есть) добавляется во второй заголовок (если поместится) и в описание перед action, description и enddescription
//action (если есть) добавляется первой (после цены) в описание, затем description
//beforeprice (если есть) добавляется до цены в описание, затем action и description
//enddescription (если есть) добавляется после description
//startdescription (если есть) добавляется в самом начале description, перед остальными параметрами

//priceRound - Начиная с какой цены отбрасывать дробную часть цены

//pricetypeadd
//0 - не добавляем цену в заголовки и описание
//1 - пытаемся добавить цену в заголовки и описание
//2 - пытаемся добавить цену в заголовки, если не получилось, то добавляем в описание (не добавляем beforeprice, если не добавляем цену в описание)
//3 - пытаемся добавить цену в только в заголовки (не добавляем beforeprice)
//4 - пытаемся добавить цену в только в описание


//после beforeprice точка не ставится, что бы можно было вставить типа "По цене от"

//алгоритм рассчитан только на 2 заголовка

//любые параметры чистятся от нежелательных символов


//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@

//	if ((!name)||(!name2)||(typeof name !== 'string')||(typeof name2 !== 'string'))
	if ((!name)||(!name2)||(!name3)||(typeof name !== 'string')||(typeof name2 !== 'string')||(typeof name3 !== 'string'))
		return;

	if (paths&&(typeof paths !== 'string'))
		return;


	if (needdescription&&(!description))
		return;

if (!pricetypeadd) {
//это важно (число а не undefined) для дальшейшего сравнения, иначе неверный результат
	pricetypeadd=0;
}



var changerArr = []
var changerFrom = {}
function replacerTO(match, p1, p2, p3, offset, string) {
//ищем массив параметров в формате {....}[max длина параметра], например {KeyWord:Наша Марка}[15]
//в каждом передаваемом параметре
//и готовим соотв хеш
//параметры должны отделяться пробелом или концом/началом строки
//name = name.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);
//формат замены :  [номер в массиве замены][\u00BF]+

	var num = Number(p3)
	//не меньше 3-х символов замены, не больше 100 замен
	if (num < 3) return match;

	if (notuseparams) {
		//убираем параметры для визуального восприятия
		var Change = p2.replace(/\{[^\{\:]+\:([^\}\{]*)\}/gm, '$1');
		//если осталась неизвестная замена без :
		Change = Change.replace(/\{[^\{]+\}/gm, '{ERROR!!!}');
	} else {

		//номер замены и его длина
		var next = String(changerArr.length);
		var nextlen = next.length;

		//для справки замена на всю длину пар-ра так
		//var Change = Array(p2.length + 1).join("\u00BF")
		//ниже с учетом длины номера замены
	

		var Change = next + Array(num + 1 - nextlen).join("\u00BF")

		changerArr[next] = p2;
		//этот хеш для возврата параметров назад
		changerFrom[Change] = p2;

	}


	return p1 + Change;

}

name = name.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);
name2 = name2.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);
startdescription = startdescription.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);
beforeprice = beforeprice.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);
action = action.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);
description = description.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);
enddescription = enddescription.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);







//	name = name.toLowerCase();

function replacer1(match, p1, p2, p3, offset, string) {
	if (/\d/.test(p2)) {
//если цифровые слова в скобках, то удаляем все в скобках
		return p1 + ' ' + p3;
	}
	if (/[^\s]\s+[^\s]/.test(p2)) {
//если несколько слов в скобках, то удаляем все в скобках
		return p1 + ' ' + p3;
	}
	return p1 + ' ' + p2 + ' ' + p3;
}



//удаляем из скобок текстовые слова, если их несколько и любые цифровые
	name = name.replace(/^([^\(]*)\(([^\)]*)\)(.*)$/, replacer1);

//чистим если остались скобки
	name = name.replace(/\(([^\)]*)\)/g, ' ');
	name = name.replace(/[\(\)]+/g, '');



//если есть запятые, точки или |, то разделяем по ним и выбираем слова (из первых двух) по наличию цифр или максимуму букв
	var qarr = name.split(/[\,\.\|](?![^\s\-\_\\\/\d]*[\-\_\\\/\d])/);
	if ((qarr.length > 1)&&qarr[0].length&&qarr[1].length&&((qarr[0].length + qarr[1].length) >= 10)) {
		var del = qarr[0].length/qarr[1].length;
		var koef = 10/13; // (koef должен быть < 1),  10 и 13 берем для базовой пропорции длины сравнения слов
		if ((del <= 1/koef)&&(del >= koef)) {
//если длина словосочетаний соизмерима, то ищем цифры в первую очередь
			if (/[\d]/.test(qarr[0])) {
				if (/[\d]/.test(qarr[1])) {
					if ((/^\s*[^\s\d]+\s[^\s]+/.test(qarr[0]))&&(/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(qarr[1]))) {
						//если везде цифры, то если первое слово с цифрами (во втором блоке), а в первом блоке первое слово без цифр, то берем первый блок
						name=qarr[0];
					} else if (qarr[0].length > qarr[1].length) {
						name=qarr[0];
					} else {
						name=qarr[1];
					}
				} else {
					name=qarr[0];
				}
			} else if (/[\d]/.test(qarr[1])) {
				name=qarr[1];
			} else {
				if (qarr[0].length > qarr[1].length) {
					name=qarr[0];
				} else {
					name=qarr[1];
				}
			}
		} else {
//иначе по длине выбираем
			if ((/[\d]/.test(qarr[0]))&&(/^\s*[^\s\d]+\s[^\s]+/.test(qarr[0]))&&(/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(qarr[1]))) {
				//если везде цифры, то если первое слово с цифрами (во втором блоке), а в первом блоке первое слово без цифр, то берем первый блок
				name=qarr[0];
			} else if (qarr[0].length > qarr[1].length) {
				name=qarr[0];
			} else {
				name=qarr[1];
			}
		}
	}


//требования для текстов
//https://support.google.com/adspolicy/answer/6021546?hl=ru
//https://support.google.com/google-ads/answer/1704389?hl=ru


	//заменяем специальные символы на пробел
	//name = name.replace(/[\!\|\>\*\<\^\=\~\`]+/g, ' ');
	//новый вариант
	name = name.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\(\)\%]+/g, ' ');

//убираем везде кавычки - иначе гугл отклоняет объявления (лучше убрать, так как видел что разрешено Магазин "ЖЖУК", но у меня отклонено было что-то типа "simplest")
	name = name.replace(/[\'\"]+/g, '');

//убираем одинокие + - точки запятые
	name = name.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//	name = name.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

//убираем дубликаты точки запятые ;
	//name = name.replace(/([\!\|\.\,\;\-\+])(?:\s*[\!\|\.\,\;\-\+]+)+/g, '$1');
	name = name.replace(/([\!\|\.\,\;])(?:\s*[\!\|\.\,\;]+)+/g, '$1');
	//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
	//name = name.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
	//name = name.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
	name = name.replace(/([\|])(?:\s*[\|]+)+/g, '$1');


//обязательно чистим пробелы
	name = name.replace(/\s+/g, ' ');
	name = name.trim();

	if (/^\s*$/.test(name)) {
		return;
	}


function keywordString(string, keyword) {

//новая версия ( учитывает кавычки '"() и изменяет только буквенные слова в режимах Keyword и KeyWord)


	function replacerKeyWord(match, p1, p2, p3, p4, offset, string) {
		//p2 не undefined и p3 undefined  - признак что увеличивать одиночный символ, то есть это начало строки или один из .!|
		//p3 не undefined и p2 undefined - признак что не увеличивать одиночный символ
		//p4 - само слово
		if (typeof p2 == 'string') {
			//начало предложения
			//увеличиваем одиночный символ, как и любой другой
			var firstch = p4.toLowerCase().replace(/^([\"\'\(]*\s*[^\"\'\(\s]).*$/, '$1').toUpperCase();
			var fullchars = firstch + p4.toLowerCase().replace(/^[\"\'\(]*\s*[^\"\'\(\s](.*)$/, '$1');
		} else {
			//не увеличиваем одиночный символ без кавычек, а если слово или слово в кавычках или одиночный символ в кавычках то увеличиваем первый символ
			if (p4.length == 1) {
				//это одиночный символ без кавычек
				var fullchars = p4.toLowerCase();
			} else {
				//это слово или слово в кавычках или одиночный символ в кавычках, увеличиваем первый символ (с учетом символов кавычек)
				var firstch = p4.toLowerCase().replace(/^([\"\'\(]*\s*[^\"\'\(\s]).*$/, '$1').toUpperCase();
				var fullchars = firstch + p4.toLowerCase().replace(/^[\"\'\(]*\s*[^\"\'\(\s](.*)$/, '$1');
			}
		}
		return p1 + fullchars;
	}


	function replacerKeyword(match, p1, p2, p3, p4, offset, string) {
		if (typeof p2 == 'string') {
			var firstch = p4.toLowerCase().replace(/^([\"\'\(]*\s*[^\"\'\(\s]).*$/, '$1').toUpperCase();
			var fullchars = firstch + p4.toLowerCase().replace(/^[\"\'\(]*\s*[^\"\'\(\s](.*)$/, '$1');
		} else {
			var fullchars = p4.toLowerCase();
		}
		return p1 + fullchars;

	}


	if (keyword) {
		if (keyword == 'Keyword') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.replace(/(((?:^\s*)|(?:\.\s*)|(?:\!\s*)|(?:\|\s*))|([\,\s]+))([\"\'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:[\"\'\)\s\.\!\|\,])|(?:$)))/g, replacerKeyword);
		} else if (keyword == 'KeyWord') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.replace(/(((?:^\s*)|(?:\.\s*)|(?:\!\s*)|(?:\|\s*))|([\,\s]+))([\"\'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:[\"\'\)\s\.\!\|\,])|(?:$)))/g, replacerKeyWord);
		} else if (keyword == 'keyword') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.toLowerCase();
		} else if (keyword == 'KEYWORD') {
			if (string) //для экономии времени вычислений на пустой строке
				string = string.toUpperCase();
		}
		
	}

	return string;

}


        //отодвинуть от знаков окончания предложений новые предложения (не задействуем знак \u00BF , который исп. в модификаторах)
//	name = name.replace(/(?![\_\d]+)([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
//	name = name.replace(/(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
	name = name.replace(/([\u00C0-\u1FFF\u2C00-\uD7FF\wa-z]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig, '$1 $2');

	//убрать знаки препинания в начале строки
	name = name.replace(/^[\s\.\,\!]+/, '');

	name = keywordString(name, keyword);



function replacerTO2(match, p1, p2, offset, string) {
//ищем в name число и слово, например 12 мм
//и добавляем в соотв массивы changerArr и changerFrom (из replacerTO)
//формат замены :  [номер в массиве замены][\u00BF]+

	var num = p2.length
	//не меньше 3-х символов замены, не больше 100 замен
	if (num < 3) return match;

	//номер замены и его длина
	var next = String(changerArr.length);
	var nextlen = next.length;

	//для справки замена на всю длину пар-ра так
	//var Change = Array(p2.length + 1).join("\u00BF")
	//ниже с учетом длины номера замены
	

	var Change = next + Array(num + 1 - nextlen).join("\u00BF")

	changerArr[next] = p2;
	//этот хеш для возврата параметров назад
	changerFrom[Change] = p2;


	return p1 + Change;

}

//не переносим в следующий заголовок по отдельности число и слово (например 12 мм), также не удаляем ниже короткое слово (задействуем знак \u00BF , который исп. в модификаторах)
name = name.replace(/(^|\s)([\d\.\,]*\d\s[\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=\s|$)/g, replacerTO2);



//https://support.google.com/google-ads/answer/1704389?hl=ru
//теперь создаем два Заголовка По 30 символов
//и два Пути По 15 символов в каждом
//Описание 1	90 символов

	var Headlines=[];
//максимальная длина поля
	var HeadlinesMax=30;
//сколько полей может быть
	var HeadlinesMaxNum=2;
	var HeadlinesN=0;
	var Descriptions=[];
//максимальная длина поля
	var DescriptionsMax=90;
//сколько полей может быть
	var DescriptionsMaxNum=2;
	var DescriptionsN=0;
	var Paths=[];
//максимальная длина поля
	var PathsMax=15;
//сколько полей может быть
	var PathsMaxNum=2;
	var PathsN=0;

if (headerTo1Line)
	HeadlinesMaxNum=1;

//создаем дубликат заголовков но без обратной замены слов, для проверки маленьких слов без цифр с учетом замен (модификаторов и replacerTO2)
	var HeadlinesTest=[];

//также выводим числовые параметры объявления для КС (в адвордс есть param1 и param2, соотв.номер в массиве идет с 0, отличается на 1, то есть, значение param1 = Params[0], значение param2 = Params[1])
//мы используем только param1 для цены
	var Params=[];

	var narr = name.split(/\s+/);
        for (var i = 0; i < narr.length; i++) {
		if (changerFrom[narr[i]]) {
			var changeword = changerFrom[narr[i]];
		} else {
			var changeword = narr[i];
		}
		if (!HeadlinesN) {
			if (narr[i].length <= HeadlinesMax) {
				Headlines[Headlines.length] = changeword;
				HeadlinesTest[HeadlinesTest.length] = narr[i];
				HeadlinesN = narr[i].length;
			} else {
				if (Headlines.length >= HeadlinesMaxNum)
					break;
//первое слово больше мах длины первого заголовка, выходим невозможно создать заголовки
				return;
			}
		} else {
			if (narr[i].length <= HeadlinesMax) {
				if ((narr[i].length + 1 + HeadlinesN) <= HeadlinesMax) {
					Headlines[Headlines.length - 1] += ' ' + changeword;
					HeadlinesTest[HeadlinesTest.length - 1] += ' ' + narr[i];
					HeadlinesN += narr[i].length + 1;
				} else {
					if (Headlines.length >= HeadlinesMaxNum)
						break;
					Headlines[Headlines.length] = changeword;
					HeadlinesTest[HeadlinesTest.length] = narr[i];
					HeadlinesN = narr[i].length;
				}
			} else {
				if (Headlines.length >= HeadlinesMaxNum)
					break;
//одно из следующих слов в запросе больше мах длины следующего заголовка, не выходим, обрезаем число заголовков
//				return;
				break;
			}
		}
	}


	if (Headlines.length) {
		////удаляем последнее маленькое слово без цифр, точки и пр. в последней строке, у которого меньше 4-х символов
		//Headlines[Headlines.length - 1] = Headlines[Headlines.length - 1].replace(/^(.*?)\s+[^\s\d\_\\\.]{1,3}\s*$/, '$1');

		var foundm = HeadlinesTest[HeadlinesTest.length - 1].match(/^(.*?)\s+([^\s\d\_\\\.\!\|]{1,3})\s*$/);
		if (foundm && foundm[1] && foundm[2]) {
			if (changerFrom[foundm[2]]) {
				var word = changerFrom[foundm[2]].toLowerCase();
			} else {
				var word = foundm[2].toLowerCase();
			}
			if (!shortWordsHash[word]) {
				//удаляем последнее маленькое слово без цифр, точки и пр. в последней строке, у которого меньше 4-х символов, если перед ним нет числа

				//если несколько букв и все большие, то не удаляем - (для KIA) например
				if (!((foundm[2] == foundm[2].toUpperCase())&&(foundm[2].length > 1))) {

					//если перед этим словом есть другое маленькое слово, то не удаляем - (для KIA) например
					var foundm2 = foundm[1].match(/^(.*?)\s+([^\s\d\_\\\.\!\|]{1,3})\s*$/);
					if (!(foundm2 && foundm2[1] && foundm2[2])) {

						//нужно в foundm[1] везде сделать замену обратно на слова
						var foundm1ch = '';
						var narr = foundm[1].split(/\s+/);
					        for (var i = 0; i < narr.length; i++) {
							if (changerFrom[narr[i]]) {
								var changeword = changerFrom[narr[i]];
							} else {
								var changeword = narr[i];
							}

							if (foundm1ch)
								foundm1ch += ' ';
							foundm1ch += changeword;


						}

						//теперь точно удаляем
						//Headlines[Headlines.length - 1] = foundm[1];
						Headlines[Headlines.length - 1] = foundm1ch;

					}
				}
			}
		}


		//убираем в конце каждого заголовка отдельные слова без цифр и букв (дальше будет разделитель или конец объявления для последнего) (не задействуем знак \u00BF , который исп. в модификаторах)

		Headlines[0] = Headlines[0].replace(/(?:^|(?:\s+))[^\s\d\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+\s*$/, '');
		if ((!Headlines[0])&&(Headlines.length == 1)) {
			//нет заголовков, выходим
			return;
		}
	        for (var i = 1; i < Headlines.length; i++) {
			Headlines[i] = Headlines[i].replace(/(?:^|(?:\s+))[^\s\d\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+\s*$/, '');
			if (!Headlines[i]) {
				//удаляем пустой заголовок
				Headlines.splice(i,1);
				i--;
			}
		}

	}



	if (noPaths) {
		var pathstmp = '';
	} else {


		if (paths) {

			//полностью повторяем обработку name (даже то что не нужно для путей, так на всякий случай)

			paths = paths.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g, replacerTO);


//удаляем из скобок текстовые слова, если их несколько и любые цифровые
			paths = paths.replace(/^([^\(]*)\(([^\)]*)\)(.*)$/, replacer1);

//чистим если остались скобки
			paths = paths.replace(/\(([^\)]*)\)/g, ' ');
			paths = paths.replace(/[\(\)]+/g, '');



//если есть запятые, точки или |, то разделяем по ним и выбираем слова (из первых двух) по наличию цифр или максимуму букв
	var qarr = paths.split(/[\,\.\|](?![^\s\-\_\\\/\d]*[\-\_\\\/\d])/);
	if ((qarr.length > 1)&&qarr[0].length&&qarr[1].length&&((qarr[0].length + qarr[1].length) >= 10)) {
		var del = qarr[0].length/qarr[1].length;
		var koef = 10/13; // (koef должен быть < 1),  10 и 13 берем для базовой пропорции длины сравнения слов
		if ((del <= 1/koef)&&(del >= koef)) {
//если длина словосочетаний соизмерима, то ищем цифры в первую очередь
			if (/[\d]/.test(qarr[0])) {
				if (/[\d]/.test(qarr[1])) {
					if ((/^\s*[^\s\d]+\s[^\s]+/.test(qarr[0]))&&(/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(qarr[1]))) {
						//если везде цифры, то если первое слово с цифрами (во втором блоке), а в первом блоке первое слово без цифр, то берем первый блок
						paths=qarr[0];
					} else if (qarr[0].length > qarr[1].length) {
						paths=qarr[0];
					} else {
						paths=qarr[1];
					}
				} else {
					paths=qarr[0];
				}
			} else if (/[\d]/.test(qarr[1])) {
				paths=qarr[1];
			} else {
				if (qarr[0].length > qarr[1].length) {
					paths=qarr[0];
				} else {
					paths=qarr[1];
				}
			}
		} else {
//иначе по длине выбираем
			if ((/[\d]/.test(qarr[0]))&&(/^\s*[^\s\d]+\s[^\s]+/.test(qarr[0]))&&(/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(qarr[1]))) {
				//если везде цифры, то если первое слово с цифрами (во втором блоке), а в первом блоке первое слово без цифр, то берем первый блок
				paths=qarr[0];
			} else if (qarr[0].length > qarr[1].length) {
				paths=qarr[0];
			} else {
				paths=qarr[1];
			}
		}
	}



			//заменяем специальные символы на пробел
			//paths = paths.replace(/[\!\|\>\*\<\^\=\~\`]+/g, ' ');
			//новый вариант
			paths = paths.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\(\)\%]+/g, ' ');

//убираем везде кавычки - иначе гугл отклоняет объявления (лучше убрать, так как видел что разрешено Магазин "ЖЖУК", но у меня отклонено было что-то типа "simplest")
			paths = paths.replace(/[\'\"]+/g, '');

//убираем одинокие + - точки запятые
			paths = paths.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//			paths = paths.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

//убираем дубликаты точки запятые ;
			//paths = paths.replace(/([\!\|\.\,\;\-\+])(?:\s*[\!\|\.\,\;\-\+]+)+/g, '$1');
			paths = paths.replace(/([\!\|\.\,\;])(?:\s*[\!\|\.\,\;]+)+/g, '$1');
			//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
			//paths = paths.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
			//paths = paths.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
			paths = paths.replace(/([\|])(?:\s*[\|]+)+/g, '$1');


//обязательно чистим пробелы
			paths = paths.replace(/\s+/g, ' ');
			paths = paths.trim();

			if (!/^\s*$/.test(paths)) {

//отодвинуть от знаков окончания предложений новые предложения (не задействуем знак \u00BF , который исп. в модификаторах)
//				paths = paths.replace(/(?![\_\d]+)([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
//				paths = paths.replace(/(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
				paths = paths.replace(/([\u00C0-\u1FFF\u2C00-\uD7FFa-z]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig, '$1 $2');

//убрать знаки препинания в начале строки
				paths = paths.replace(/^[\s\.\,\!]+/, '');

				paths = keywordString(paths, keyword);


//не переносим в следующий заголовок по отдельности число и слово (например 12 мм), также не удаляем ниже короткое слово (задействуем знак \u00BF , который исп. в модификаторах)
				paths = paths.replace(/(^|\s)([\d\.\,]*\d\s[\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=\s|$)/g, replacerTO2);

			}

			var pathstmp = paths;
		} else {
			var pathstmp = name;
		}

		//удаляем параметры замены (могут быть неожиданности, если оставить)
		//var pathstmp = pathstmp.replace(/(^|\s)(\d+\u00BF+)(\s|$)/g, ' ');
		//pathstmp = pathstmp.trim();


		//если единичный символ - все удалить, начиная с него для path
		pathstmp = pathstmp.replace(/^(.*?)\s+[^\s]\s+.*$/, '$1');

	}


	var narr = pathstmp.split(/\s+/);


	//флаг что последнее - маленькое нецифровое слово
	var lastmflg=0
        for (var i = 0; i < narr.length; i++) {

		if (changerFrom[narr[i]]) {
			var changeword = changerFrom[narr[i]];
		} else {
			var changeword = narr[i];
		}


		if (!PathsN) {
			if (narr[i].length <= PathsMax) {
				Paths[Paths.length] = changeword;
				PathsN = narr[i].length;
			} else {
				break;
			}
		} else {
			if (narr[i].length <= PathsMax) {
				if ((narr[i].length + 1 + PathsN) <= PathsMax) {
					Paths[Paths.length - 1] += '_' + changeword;
					PathsN += narr[i].length + 1;
				} else {
					if (Paths.length >= PathsMaxNum)
						break;
					Paths[Paths.length] = changeword;
					PathsN = narr[i].length;
				}
			} else {
				break;
			}
		}
		if (!PathsN) {
			//если это первый элемент массива путей, то еще не включаем анализ маленьких нецифровых слов
			lastmflg=0;
		//} else if (narr[i].length < 5) {
		} else if ((!shortWordsHash[changeword.toLowerCase()])&&(narr[i].length < 5)) {
			if (/[\d\/]/.test(changeword)) {
				lastmflg=0;
			} else {
				lastmflg=narr[i].length;
			}
		} else {
			lastmflg=0;
		}

	}


	if (lastmflg) {
//если последнее - маленькое нецифровое слово, то смотрим в каком варианте выдачи оно больше
//то есть если в предыдущем варианте закончилось например на "по", 
//то возможно, если здесь мы возьмем первые два слова, то последнее (второе если есть) слово будет большей длины чем при первом варианте расчета
//задача - по возможности не допустить окончания путей на предлогах
		var lastmflg2 = 0
	        for (var i = 0; i < PathsMaxNum; i++) {
			if (changerFrom[narr[i]]) {
				var changeword = changerFrom[narr[i]];
			} else {
				var changeword = narr[i];
			}
			if (changeword) {
				if (!i) {
				//если это первый элемент массива путей, то еще не включаем анализ маленьких нецифровых слов
					lastmflg2=0;
				} else if (narr[i].length > PathsMax) {
					break;
				//} else if (narr[i].length < 5) {
				} else if ((!shortWordsHash[changeword.toLowerCase()])&&(narr[i].length < 5)) {
					if (/[\d\/]/.test(changeword)) {
						lastmflg2=0;
					} else {
//прекращаем поиск на первом нецифровом маленьком слове (что бы можно было оставить предыдущее, иначе все сброситься, так как у нас всего 2 слова)
//						break;  //лучше вообще-то не оставлять (это надо было в первом варианте анализировать, но надо ломать голову, а это не столь принципиально), например "Сумка Для Обуви На 2 Пары Мягкая с Рисунком"
						lastmflg2=narr[i].length;
					}
				} else {
					lastmflg2=0;
				}
			}
		}
		if (lastmflg&&(lastmflg <= 3)&&lastmflg2&&(lastmflg2 <= 3)) {
			//если оба варианта дают нецифровые слова длиной 3, 2 или 1 то вообще не указываем пути
			Paths = [];
		} else if ((!lastmflg2)||(lastmflg2 > lastmflg)) {
			Paths = [];
		        for (var i = 0; i < PathsMaxNum; i++) {
				if (changerFrom[narr[i]]) {
					var changeword = changerFrom[narr[i]];
				} else {
					var changeword = narr[i];
				}
				if (changeword) {
					if (!i) {
					//если это первый элемент массива путей, то еще не включаем анализ маленьких нецифровых слов
						Paths[i] = changeword;
					} else if (narr[i].length > PathsMax) {
						break;
					//} else if (narr[i].length < 5) {
					} else if ((!shortWordsHash[changeword.toLowerCase()])&&(narr[i].length < 5)) {
						if (/[\d\/]/.test(changeword)) {
							Paths[i] = changeword;
						} else {
//прекращаем поиск на первом нецифровом маленьком слове (что бы можно было оставить предыдущее, иначе все сброситься, так как у нас всего 2 слова)
//							break;  //лучше вообще-то не оставлять (это надо было в первом варианте анализировать, но надо ломать голову, а это не столь принципиально), например "Сумка Для Обуви На 2 Пары Мягкая с Рисунком"
							Paths[i] = changeword;
						}
					} else {
						Paths[i] = changeword;
					}
				}
			}
		}
	}



	//добавлено - путь точно не может содержать символы :.,/\ (возможно и какие-то другие)
	//поэтому заменяем их на _ и убираем дубликаты _ если появятся при замене
        for (var i = 0; i < Paths.length; i++) {
		Paths[i] = Paths[i].replace(/[\:\.\,\/\\\_]+/g, '_');
	}



	var cena = '';
	var currency = '';


	if (price) {

		//на всякий случай чистим теги (можно убрать, так как должно заходить без тегов)
		price = price.replace(/\<[^\>]\>/g, '');

		//чистим пробелы внутри цены (числа)
		//price = price.replace(/(?<=[\d\.\,])\s+(?=[\d\.\,])/g, ''); //просмотр назад не работает в гугле
		function pricereplacer(match, offset, string) {
			match = match.replace(/\s+/g, '');
			return match;
		}
		price = price.replace(/[\d\.\,][\d\.\,\s]+[\d\.\,]/g, pricereplacer);


		//делаем пробел между числом и валютой
		//price = price.replace(/([\d\.\,]+)(?=[^\s\d\.\,])/, '$1 ');

		price = price.toLowerCase();

		//разбиваем прайс на число и валюту и символ \.\,\!\| в конце
		var match = price.match(/([\d\.\,]+)\s*([^\d\s]*(?:\s*[\.\,\!\|])?)/);
		if (match && match[1]) {
			cena = match[1];
			currency = match[2];

			if (typeof priceRound == 'number') {
				if (Number(cena.replace(/[\s\,]+/g, '')) >= priceRound) {
					cena = cena.replace(/\..*$/, '');
				}
			}


			price = cena;

			if (currency) {
				//удаляем специальные символы
				currency = currency.replace(/[\>\*\<\^\=\~\`]+/g, '');

				//убираем дубликаты точки запятые ;
				//currency = currency.replace(/([\!\.\,\;\-\+])(?:\s*[\!\.\,\;\-\+]+)+/g, '$1');
				currency = currency.replace(/([\!\.\,\;])(?:\s*[\!\.\,\;]+)+/g, '$1');
				//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
				//currency = currency.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
				//currency = currency.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
				currency = currency.replace(/([\|])(?:\s*[\|]+)+/g, '$1');

				currency = currency.replace(/\s+(?![\.\,\!\|])/g, '');


			}
			if (currency)
				price += ' ' + currency;


		} else {
			price = '';
		}


	}

	if (price) {
		price = price.replace(/\s+/g, ' ');
		price = price.trim();
	}


	var priceParam = '';

	if (!price) {
		beforeprice = '';
	} else {


		if (notuseparams) {
			//убираем параметр для визуального восприятия
			priceParam = String(cena);
		} else {
			priceParam = '{param1:' + cena + '}';
		}

//для заголовка формируем отдельные параметры priceHeader(price) priceParamHeader(priceParam)
		var priceParamHeader = priceParam;
		var priceHeader = cena;

		//для заголовка удаляем в конце [\,\!\|], для описания оставляем
		var currencyHeader = currency.replace(/\s*[\,\!\|]$/, '');
		if (currencyHeader) {
			priceHeader += ' ' + currencyHeader;
			priceParamHeader += ' ' + currencyHeader;
		}

		//для описания оставляем в конце [\,\!\|]
		if (currency)
			priceParam += ' ' + currency;


		var addpricetoHeader = 0;

		var addpricetoAny = 0;

		if ((!headerTo1Line)&&(pricetypeadd > 0)&&(pricetypeadd < 4)&&((Headlines.length == 1)||((priceHeader.length + 3 + Headlines[1].length) <= HeadlinesMax))) {
//добавляем во второй заголовок цену (длину учитывает только priceHeader а не priceParamHeader)
			if (!Headlines[1]) {
//				Headlines[1] = priceHeader;
				Headlines[1] = priceParamHeader;
				
			} else {
//				Headlines[1] += ' | ' + priceHeader;
				Headlines[1] += ' | ' + priceParamHeader;
			}

			addpricetoHeader = 1;
			addpricetoAny = 1;


		}


		if (!((pricetypeadd == 4)||(pricetypeadd == 1)||((pricetypeadd == 2)&&(!addpricetoHeader)))) {
			//варианты, когда не добавлять цену в описание

			priceParam = '';
			beforeprice = '';

			//так на всякий случай, хотя не требуется
			cena = '';
			currency = '';

		} else {
			addpricetoAny = 1;
		}


		if (addpricetoAny)
		//номер параметра соответсвует его номеру в массиве + 1
			Params[0]=cena;


	}





	if (description) {
		//заменяем специальные символы на пробел
		//description = description.replace(/[\>\*\<\^\=\~\`]+/g, ' ');
		//новый вариант
		description = description.replace(/[^\!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\%]+/g, ' ');


		//убираем одинокие + - точки запятые
		description = description.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
		//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//		description = description.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

		//убираем дубликаты точки запятые ;
		//description = description.replace(/([\!\.\,\;\-\+])(?:\s*[\!\.\,\;\-\+]+)+/g, '$1');
		description = description.replace(/([\!\.\,\;])(?:\s*[\!\.\,\;]+)+/g, '$1');
		//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
		//description = description.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
		//description = description.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
		description = description.replace(/([\|])(?:\s*[\|]+)+/g, '$1');
	}


	if (action) {
		//заменяем специальные символы на пробел
		//action = action.replace(/[\>\*\<\^\=\~\`]+/g, ' ');
		//новый вариант
		action = action.replace(/[^\!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\%]+/g, ' ');

		//убираем одинокие + - точки запятые
		action = action.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
		//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//		action = action.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

		//убираем дубликаты точки запятые ;
		//action = action.replace(/([\!\.\,\;\-\+])(?:\s*[\!\.\,\;\-\+]+)+/g, '$1');
		action = action.replace(/([\!\.\,\;])(?:\s*[\!\.\,\;]+)+/g, '$1');
		//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
		//action = action.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
		//action = action.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
		action = action.replace(/([\|])(?:\s*[\|]+)+/g, '$1');
	}

	if (beforeprice) {
		//заменяем специальные символы на пробел
		//beforeprice = beforeprice.replace(/[\>\*\<\^\=\~\`]+/g, ' ');
		//новый вариант
		beforeprice = beforeprice.replace(/[^\!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\%]+/g, ' ');

		//убираем одинокие + - точки запятые
		beforeprice = beforeprice.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
		//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//		beforeprice = beforeprice.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

		//убираем дубликаты точки запятые ;
		//beforeprice = beforeprice.replace(/([\!\.\,\;\-\+])(?:\s*[\!\.\,\;\-\+]+)+/g, '$1');
		beforeprice = beforeprice.replace(/([\!\.\,\;])(?:\s*[\!\.\,\;]+)+/g, '$1');
		//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
		//beforeprice = beforeprice.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
		//beforeprice = beforeprice.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
		beforeprice = beforeprice.replace(/([\|])(?:\s*[\|]+)+/g, '$1');
	}



	if (startdescription) {
		//заменяем специальные символы на пробел
		//startdescription = startdescription.replace(/[\>\*\<\^\=\~\`]+/g, ' ');
		//новый вариант
		startdescription = startdescription.replace(/[^\!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\%]+/g, ' ');

		//убираем одинокие + - точки запятые
		startdescription = startdescription.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
		//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//		startdescription = startdescription.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

		//убираем дубликаты точки запятые ;
		//startdescription = startdescription.replace(/([\!\.\,\;\-\+])(?:\s*[\!\.\,\;\-\+]+)+/g, '$1');
		startdescription = startdescription.replace(/([\!\.\,\;])(?:\s*[\!\.\,\;]+)+/g, '$1');
		//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
		//startdescription = startdescription.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
		//startdescription = startdescription.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
		startdescription = startdescription.replace(/([\|])(?:\s*[\|]+)+/g, '$1');
	}


	if (enddescription) {
		//заменяем специальные символы на пробел
		//enddescription = enddescription.replace(/[\>\*\<\^\=\~\`]+/g, ' ');
		//новый вариант
		enddescription = enddescription.replace(/[^\!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\%]+/g, ' ');

		//убираем одинокие + - точки запятые
		enddescription = enddescription.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
		//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//		enddescription = enddescription.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

		//убираем дубликаты точки запятые ;
		//enddescription = enddescription.replace(/([\!\.\,\;\-\+])(?:\s*[\!\.\,\;\-\+]+)+/g, '$1');
		enddescription = enddescription.replace(/([\!\.\,\;])(?:\s*[\!\.\,\;]+)+/g, '$1');
		//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
		//enddescription = enddescription.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
		//enddescription = enddescription.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
		enddescription = enddescription.replace(/([\|])(?:\s*[\|]+)+/g, '$1');
	}




	if (!description) {
		if (description === null)
			description = name;
	} else {
		description = description.replace(/\s+/g, ' ');
		description = description.trim();
		description = keywordString(description, keyword);
	}



//должен остаться один восклицательный знак, в name их удалили раньше
	if (startdescription&&(/[\!]/.test(startdescription))) {
		if (beforeprice)
			beforeprice = beforeprice.replace(/[\!]/g, '.');
		if (price)
			price = price.replace(/[\!]/g, '.');
		if (description)
			description = description.replace(/[\!]/g, '.');
		if (enddescription)
			enddescription = enddescription.replace(/[\!]/g, '.');
		if (action)
			action = action.replace(/[\!]/g, '.');
	} else if (beforeprice&&(/[\!]/.test(beforeprice))) {
		if (price)
			price = price.replace(/[\!]/g, '.');
		if (description)
			description = description.replace(/[\!]/g, '.');
		if (enddescription)
			enddescription = enddescription.replace(/[\!]/g, '.');
		if (action)
			action = action.replace(/[\!]/g, '.');
	} else if (price&&(/[\!]/.test(price))) {
		if (description)
			description = description.replace(/[\!]/g, '.');
		if (enddescription)
			enddescription = enddescription.replace(/[\!]/g, '.');
		if (action)
			action = action.replace(/[\!]/g, '.');
	} else if (action&&(/[\!]/.test(action))) {
		if (description)
			description = description.replace(/[\!]/g, '.');
		if (enddescription)
			enddescription = enddescription.replace(/[\!]/g, '.');
	} else if (description&&(/[\!]/.test(description))) {
		if (enddescription)
			enddescription = enddescription.replace(/[\!]/g, '.');
	}





	if (enddescription) {


		enddescription = enddescription.replace(/\s+/g, ' ');
		enddescription = enddescription.trim();
	}

	if (enddescription) {

//enddescription добавляется или не добавляется целиком ниже
		enddescription = keywordString(enddescription, keyword);
		if (description) {
/*
//так как enddescription добавляется сразу в массив, то другой алгоритм
			if (/[\.\,\|\!]\s*$/.test(description)) {
				enddescription = ' ' + enddescription;
			} else {
				enddescription = '. ' + enddescription;
			}
*/
			if (!(/[\.\,\|\!]\s*$/.test(description)))
				description += '.'
		}

	}



	if (action) {
		action = action.replace(/\s+/g, ' ');
		action = action.trim();
	}

	if (action) {

		action = keywordString(action, keyword);

		if (description) {
			if ((/[\.\,\|\!]\s*$/.test(action))||(/^\s*[\.\,\|\!]/.test(description))) {
				description = action + ' ' + description;
			} else {
				description = action + '. ' + description;
			}
		} else {
			if (/[\.\,\|\!]\s*$/.test(action)) {
				description = action;
			} else {
				description = action + '.';
			}
		}
	}


	if (price&&priceParam) {
		//можно добавлять цену в описание
		//заменяем прайс на вставку для последующей замены в description
		var priceChange = Array(price.length + 1).join('`')

//добавляем в описание цену (точнее вставку, которую потом заменим на цену, это если цена не помещается в описание)
		if (description) {
			if ((/[\.\,\|\!]\s*$/.test(price))||(/^\s*[\.\,\|\!]/.test(description))) {
				description = priceChange + ' ' + description;
			} else {
				description = priceChange + ', ' + description;
			}
		} else {
			description = priceChange;
		}
	}


	if (beforeprice) {
		beforeprice = beforeprice.replace(/\s+/g, ' ');
		beforeprice = beforeprice.trim();
	}

	if (beforeprice) {
		beforeprice = keywordString(beforeprice, keyword);
		if (description) {
//			if ((/[\.\,\|\!]\s*$/.test(beforeprice))||(/^\s*[\.\,\|\!]/.test(description))) {
				description = beforeprice + ' ' + description;
//			} else {
//				description = beforeprice + '. ' + description;
//			}
		} else {
//			if (/[\.\,\|\!]\s*$/.test(beforeprice)) {
				description = beforeprice;
//			} else {
//				description = beforeprice + '.';
//			}
		}
	}


	if (startdescription) {
		startdescription = startdescription.replace(/\s+/g, ' ');
		startdescription = startdescription.trim();
	}

	if (startdescription) {
		startdescription = keywordString(startdescription, keyword);
		if (description) {
			if ((/[\.\,\|\!]\s*$/.test(startdescription))||(/^\s*[\.\,\|\!]/.test(description))) {
				description = startdescription + ' ' + description;
			} else {
				description = startdescription + '. ' + description;
			}
		} else {
			if (/[\.\,\|\!]\s*$/.test(startdescription)) {
				description = startdescription;
			} else {
				description = startdescription + '.';
			}
		}
	}


//убираем везде кавычки - иначе гугл отклоняет объявления (лучше убрать, так как видел что разрешено Магазин "ЖЖУК", но у меня отклонено было что-то типа "simplest")
	description = description.replace(/[\'\"]+/g, '');

//прижимаем влево одинокие точки запятые ! во всем описании
	description = description.replace(/(?:(?:^\s*)|(?:\s+))([\.\,\!])(?:\s*[\.\,\!])*(?=(?:\s+)|(?:\s*$))/g, '$1');
//убираем дубликаты точки запятые ; во всем описании (enddescription сюда не попадает)
	//description = description.replace(/([\!\.\,\;\-\+])(?:\s*[\!\.\,\;\-\+]+)+/g, '$1');
	description = description.replace(/([\!\.\,\;])(?:\s*[\!\.\,\;]+)+/g, '$1');
	//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
	//description = description.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
	//description = description.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
	description = description.replace(/([\|])(?:\s*[\|]+)+/g, '$1');


        //отодвинуть от знаков окончания предложений новые предложения (не задействуем знак \u00BF , который исп. в модификаторах)
//	description = description.replace(/(?![\_\d]+)([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
//	description = description.replace(/(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
	description = description.replace(/([\u00C0-\u1FFF\u2C00-\uD7FFa-z]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig, '$1 $2');
	//убрать знаки препинания в начале строки
	description = description.replace(/^[\s\.\,\!]+/, '');
	//продублировать keyword на всем описании (по сути это сделано из-за строк выше), а другие keyword выше оставил из-за модификаторов объявлений
	description = keywordString(description, keyword);



	var narr = description.split(/\s+/);
	if (enddescription) {

//убираем везде кавычки - иначе гугл отклоняет объявления (лучше убрать, так как видел что разрешено Магазин "ЖЖУК", но у меня отклонено было что-то типа "simplest")
		enddescription = enddescription.replace(/[\'\"]+/g, '');

//убираем дубликаты точки запятые ; в enddescription
		//if (/[\!\.\,\;\-\+]\s*$/.test(description))
		//	enddescription = enddescription.replace(/^(?:\s*[\!\.\,\;\-\+]+\s*)+/, '');
		if (/[\!\.\,\;]\s*$/.test(description))
			enddescription = enddescription.replace(/^(?:\s*[\!\.\,\;]+\s*)+/, '');
		//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
		//if (/[\+]\s*$/.test(description))
		//	enddescription = enddescription.replace(/^(?:\s*[\+]+\s*)+/, '');
		//if (/[\-]\s*$/.test(description))
		//	enddescription = enddescription.replace(/^(?:\s*[\-]+\s*)+/, '');
		if (/[\|]\s*$/.test(description))
			enddescription = enddescription.replace(/^(?:\s*[\|]+\s*)+/, '');

//прижимаем влево одинокие точки запятые !
		enddescription = enddescription.replace(/(?:(?:^\s*)|(?:\s+))([\.\,\!])[\.\,\!]*(?=(?:\s+)|(?:\s*$))/g, '$1');

	        //отодвинуть от знаков окончания предложений новые предложения (не задействуем знак \u00BF , который исп. в модификаторах)
//		enddescription = enddescription.replace(/(?![\_\d]+)([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
//		enddescription = enddescription.replace(/(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
		enddescription = enddescription.replace(/([\u00C0-\u1FFF\u2C00-\uD7FFa-z]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig, '$1 $2');
		//убрать знаки препинания в начале строки
		enddescription = enddescription.replace(/^[\s\.\,\!]+/, '');


		enddescription = keywordString(enddescription, keyword);
		if (!needafterdescription)
			narr[narr.length] = enddescription;
	}

	var enddescriptionlength = enddescription.length
	if (needafterdescription) {
		//не может быть вставлено никогда
		if (enddescriptionlength > DescriptionsMax)
			return;
		if (enddescriptionlength) {
			enddescriptionlength += 3 //если задан needafterdescription, то добавляется пробел перед afterdescription и может быть добавлено ' |' (если нет точки в конце описания)
		} else {
			enddescriptionlength = 0 //если не задан afterdescription, то ничего не добавляем
						//нельзя добавлять точку, строка могла быть неудачно обрезана здесь или еще в парсере фида
		}
	}

        for (var i = 0; i < narr.length; i++) {
		if (changerFrom[narr[i]]) {
			var changeword = changerFrom[narr[i]];
		} else {
			var changeword = narr[i];
		}
		if (needafterdescription) {

			//контроль перехода на последний элемент 
			//обрезание массива, если попадается слишком длинное слово

			if (DescriptionsMaxNum < 2) {
				//только одна строка, постоянно контролируем размер с учетом enddescriptionlength
				if (!DescriptionsN) {
					if (narr[i].length + enddescriptionlength <= DescriptionsMax) {
						//создание новой строки описания объявления
						if (priceParam) {
							Descriptions[Descriptions.length] = changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length] = changeword;
						}
						DescriptionsN = narr[i].length;
					} else {
//завершаем, если первое слово не поместится вместе с enddescription
						break;
					}
				} else {

					if (narr[i].length + enddescriptionlength <= DescriptionsMax) {
						if ((narr[i].length + 1 + DescriptionsN + enddescriptionlength) <= DescriptionsMax) {
							if (priceParam) {
								Descriptions[Descriptions.length - 1] += ' ' + changeword.replace(/\`+/g, priceParam);
							} else {
								Descriptions[Descriptions.length - 1] += ' ' + changeword;
							}
							DescriptionsN += narr[i].length + 1;
						} else {
							//создание новой строки описания объявления, выходим
							break;
						}
					} else {
//завершаем, если следующее слово не поместится вместе с enddescription
						break;
					}

				}

			} else if (!Descriptions.length) {
				//еще нет элементов, но здесь и дальше везде строк больше одной
				//поэтому здесь нет еще контроля размера новой строки с учетом enddescriptionlength
				//так как нет еще элементов
				//его функция - создать первый элемент

				if (narr[i].length <= DescriptionsMax) {
					//создание новой строки описания объявления
					if (priceParam) {
						Descriptions[Descriptions.length] = changeword.replace(/\`+/g, priceParam);
					} else {
						Descriptions[Descriptions.length] = changeword;
					}
					DescriptionsN = narr[i].length;
				} else {
//обрезаем массив, если попалось слишком длинного слова
					break;
				}



			} else if (Descriptions.length == DescriptionsMaxNum - 1) {
				//предпоследний элемент, контроль размера новой строки с учетом enddescriptionlength
				if (narr[i].length <= DescriptionsMax) {
					if ((narr[i].length + 1 + DescriptionsN) <= DescriptionsMax) {
						if (priceParam) {
							Descriptions[Descriptions.length - 1] += ' ' + changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length - 1] += ' ' + changeword;
						}
						DescriptionsN += narr[i].length + 1;
					} else {
						//создание новой строки описания объявления
						//завершаем, если следующее слово не поместится вместе с enddescription
						if (narr[i].length + enddescriptionlength > DescriptionsMax) {
							break;
						}
						if (priceParam) {
							Descriptions[Descriptions.length] = changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length] = changeword;
						}
						DescriptionsN = narr[i].length;
					}
				} else {
//обрезаем массив, если попалось слишком длинного слова
					break;
				}


			} else if (Descriptions.length < DescriptionsMaxNum - 1) {

				//не предпоследний элемент и не последний
				if (narr[i].length <= DescriptionsMax) {
					if ((narr[i].length + 1 + DescriptionsN) <= DescriptionsMax) {
						if (priceParam) {
							Descriptions[Descriptions.length - 1] += ' ' + changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length - 1] += ' ' + changeword;
						}
						DescriptionsN += narr[i].length + 1;
					} else {
						//создание новой строки описания объявления
						if (priceParam) {
							Descriptions[Descriptions.length] = changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length] = changeword;
						}
						DescriptionsN = narr[i].length;
					}
				} else {
//обрезаем массив, если попалось слишком длинного слова
					break;
				}


			} else {
				//последний элемент, кроме случая массива из одной строки
				if (narr[i].length + enddescriptionlength <= DescriptionsMax) {
					if ((narr[i].length + 1 + DescriptionsN + enddescriptionlength) <= DescriptionsMax) {
						if (priceParam) {
							Descriptions[Descriptions.length - 1] += ' ' + changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length - 1] += ' ' + changeword;
						}
						DescriptionsN += narr[i].length + 1;
					} else {
						//создание новой строки описания объявления, выходим
						break;
					}
				} else {
//завершаем, если следующее слово не поместится вместе с enddescription
					break;
				}


			}


		} else {
			//обычная обработка

			if (!DescriptionsN) {
				if (narr[i].length <= DescriptionsMax) {
					//создание новой строки описания объявления
					if (priceParam) {
						Descriptions[Descriptions.length] = changeword.replace(/\`+/g, priceParam);
					} else {
						Descriptions[Descriptions.length] = changeword;
					}
					DescriptionsN = narr[i].length;
				} else {
					if (Descriptions.length >= DescriptionsMaxNum)
						break;
//первое слово больше мах длины первого описания, выходим невозможно создать описания
					return;
				}
			} else {
				if (narr[i].length <= DescriptionsMax) {
					if ((narr[i].length + 1 + DescriptionsN) <= DescriptionsMax) {
						if (priceParam) {
							Descriptions[Descriptions.length - 1] += ' ' + changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length - 1] += ' ' + changeword;
						}
						DescriptionsN += narr[i].length + 1;
					} else {
						//создание новой строки описания объявления
						if (Descriptions.length >= DescriptionsMaxNum)
							break;
						if (priceParam) {
							Descriptions[Descriptions.length] = changeword.replace(/\`+/g, priceParam);
						} else {
							Descriptions[Descriptions.length] = changeword;
						}
						DescriptionsN = narr[i].length;
					}
				} else {
					if (Descriptions.length >= DescriptionsMaxNum)
						break;
//одно из следующих слов в запросе больше мах длины следующего описания, не выходим, обрезаем число описаний
//					return;
					break;
				}
			}


		}

	}


function replacerShort1(match, p1, p2, offset, string) {
	//word - короткое слово, которое нужно удалить
	if (changerFrom[p2]) {
		var word = changerFrom[p2].toLowerCase();
	} else {
		var word = p2.toLowerCase();
	}
	if (shortWordsHash[word]) {
		//нельзя удалять, оно занесено в список реальных слов
		return match;
	} else {
		//можно удалять
		return p1;
	}
}
	if (Descriptions.length) {
		var elNumb = Descriptions.length - 1;
		//удаляем последнее маленькое слово без цифр, точки и пр. в последней строке, у которого меньше 4-х символов, если перед ним нет числа
		if (/^(.*?)\s+[^\s\d\_\\\.\!\|]{1,3}\s*$/.test(Descriptions[elNumb]))
			//Descriptions[elNumb] = Descriptions[elNumb].replace(/^(.*?)\s+[^\s\d\_\\\.\!\|]{1,3}\s*$/, '$1');
			Descriptions[elNumb] = Descriptions[elNumb].replace(/^(.*?)\s+([^\s\d\_\\\.\!\|]{1,3})\s*$/, replacerShort1);
		Descriptions[elNumb] = Descriptions[elNumb].replace(/[\s\:\,\/\\\_]+$/, '');
	}


	if (needafterdescription) {
		//добавляем enddescription

		if (changerFrom[enddescription]) {
			var changeword = changerFrom[enddescription];
		} else {
			var changeword = enddescription;
		}

		//строки описания объединяются единым потоком, поэтому визуально склеиваются,
		//но если есть следующая строка, то гугл автоматически ставит дополнительно точку в конце предыдущей (если там нет точки или !)
		if (DescriptionsN&&(DescriptionsN + enddescriptionlength <= DescriptionsMax)) {
			//вставляем в текущий элемент

			var elNumb = Descriptions.length - 1;


//двоеточие нельзя добавлять! гугл не пропустит, используем |

			if (enddescription) {

				if (!(/[\.\!\|]$/.test(Descriptions[elNumb]))) {

					//нет окончания предложения, значит обрезана строка
					//так как была точка обязательно вставлена выше (если есть enddescription)
					//если нет точки, может коряво отображаться строка неоконченного предложения, ищем точку где-нибудь

					var newstr = Descriptions[elNumb].match('^.+[\\.\\!\\|](?=\\s|$)')
					if (newstr !== null) {
						Descriptions[elNumb] = newstr[0];
					} else {
						Descriptions[elNumb] += ' |';
					}
				}


			}

			if (priceParam) {
				Descriptions[elNumb] += ' ' + changeword.replace(/\`+/g, priceParam);
			} else {
				Descriptions[elNumb] += ' ' + changeword;
			}
		} else {
			//создаем новый, гугл автоматом поставит точку в предыдущей строке (если там нет .!)
			if (priceParam) {
				Descriptions[Descriptions.length] = changeword.replace(/\`+/g, priceParam);
			} else {
				Descriptions[Descriptions.length] = changeword;
			}
		}
	}



	if (Headlines.length == 1) {
		//вставляем name2 в пустой 2-й заголовок (2-й заголовок обязателен)


		var HeadlinesN2=0;

/*

2-й заголовок практически не обрабатываем, убрал все лишнее

	        //отодвинуть от знаков окончания предложений новые предложения (не задействуем знак \u00BF , который исп. в модификаторах)
//		name2 = name2.replace(/(?![\_\d]+)([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
//		name2 = name2.replace(/(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w]\s*[\.\!\,])(?![\_\d])([\u00C0-\u1FFF\u2C00-\uD7FF\w])/g, '$1 $2');
		name2 = name2.replace(/([\u00C0-\u1FFF\u2C00-\uD7FFa-z]\s*[\.\!\,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig, '$1 $2');

*/
		//убрать знаки препинания в начале строки
		name2 = name2.replace(/^[\s\.\,\!]+/, '');


/*

		name2 = keywordString(name2, keyword);
*/


		//заменяем специальные символы на пробел
		//name2 = name2.replace(/[\!\|\>\*\<\^\=\~\`]+/g, ' ');
		//новый вариант
		name2 = name2.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\(\)\%]+/g, ' ');


/*

//убираем везде кавычки - иначе гугл отклоняет объявления (лучше убрать, так как видел что разрешено Магазин "ЖЖУК", но у меня отклонено было что-то типа "simplest")
		name2 = name2.replace(/[\'\"]+/g, '');
*/


//убираем одинокие + - точки запятые
		name2 = name2.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.\,]+(?=(?:\s)|(?:\s*$))/g, '');
//убираем одинокие + - точки запятые внутри текста - (так не стоит делать)
//		name2 = name2.replace(/(?:(?!^\s*)(?:\s))[\+\-\.\,]+(?=(?:\s)(?!\s*$))/g, '');

//убираем дубликаты точки запятые ;
		//name2 = name2.replace(/([\!\|\.\,\;\-\+])(?:\s*[\!\|\.\,\;\-\+]+)+/g, '$1');
		name2 = name2.replace(/([\!\|\.\,\;])(?:\s*[\!\|\.\,\;]+)+/g, '$1');
		//здесь нельзя, например антифириз G12++ (можно откорректировать в настройке задания, если нужно)
		//name2 = name2.replace(/([\+])(?:\s*[\+]+)+/g, '$1');
		//name2 = name2.replace(/([\-])(?:\s*[\-]+)+/g, '$1');
		name2 = name2.replace(/([\|])(?:\s*[\|]+)+/g, '$1');

//обязательно чистим пробелы
		name2 = name2.replace(/\s+/g, ' ');
		name2 = name2.trim();


		if (/^\s*$/.test(name2)) {
			return;
		}


/*
		name2 = keywordString(name2, keyword);

*/

		var Headline2 = ''

		var narr = name2.split(/\s+/);
        	for (var i = 0; i < narr.length; i++) {
			if (changerFrom[narr[i]]) {
				var changeword = changerFrom[narr[i]];
			} else {
				var changeword = narr[i];
			}
			if (!HeadlinesN2) {
				if (narr[i].length <= HeadlinesMax) {
					Headline2 = changeword;
					HeadlinesN2 = narr[i].length;
				} else {
					return;
				}
			} else {
				if (narr[i].length <= HeadlinesMax) {
					if ((narr[i].length + 1 + HeadlinesN2) <= HeadlinesMax) {
						Headline2 += ' ' + changeword;
						HeadlinesN2 += narr[i].length + 1;
					} else {
						break;
					}
				} else {
					break;
				}
			}
		}


		Headlines[1] = Headline2;


	}



//начальная переделка под адаптивные объявления
//!!!@@@@@@@@@@@@@@@

	if (Headlines.length == 2) {
		//вставляем без проверок заранее сформированную name3 в пустой 3-й заголовок (3-й заголовок обязателен)
		Headlines[2] = name3;
	}



	if (Descriptions.length == 1) {
//нужно разбить на 2 строки, 2-я обязательна


		var found = Descriptions[0].match(/^(.*)(\{[^\}\{]+\}[\s\.\!]*)$/);
		if (found && found[1] && found[2]) {
//проверяем на наличие в конце строки фигурных скобок {....}
			Descriptions[0] = found[1].trim()
			Descriptions[1] = found[2]
		} else {
//проверяем на наличие в середине строки символов .! (но не внутри фигурных скобок)
			var found = Descriptions[0].match(/^(.*[\.\!])(?![ ]+[^\}\{]+\})([ ]+[^\s].*)$/);
			if (found && found[1] && found[2]) {
				Descriptions[0] = found[1]
				Descriptions[1] = found[2].trim()
			} else {
//проверяем на наличие в середине строки символа , (но не внутри фигурных скобок)
//удаляем запятую, гугл поставит точку
				var found = Descriptions[0].match(/^(.*)[\,](?![ ]+[^\}\{]+\})([ ]+[^\s].*)$/);
				if (found && found[1] && found[2]) {
					Descriptions[0] = found[1].trim()
					Descriptions[1] = found[2].trim()
				} else {
//проверяем на наличие в середине строки слова из 3-х символов (но не внутри фигурных скобок)
					var found = Descriptions[0].match(/^(.*[^\s][^\s][^\s])(?![ ]+[^\}\{]+\})([ ]+[^\s].*)$/);
					if (found && found[1] && found[2]) {
						Descriptions[0] = found[1]
						Descriptions[1] = found[2].trim()
					} else {
						return
					}
				}
			}
		}

		if (/^\s*$/.test(Descriptions[0])) {
			return;
		}
		if (/^\s*$/.test(Descriptions[1])) {
			return;
		}

	}

	
//Окончательная проверка - заголовков не менее 3-х, описаний не менее 2-x

//if (Headlines.length < 2)
if (Headlines.length < 3)
	return

//if (!Descriptions.length)
if (Descriptions.length < 2)
	return


//alert(name)
//alert(JSON.stringify(Headlines));
//alert(JSON.stringify(Descriptions));
//alert(JSON.stringify(Paths));

return {Headlines: Headlines, Descriptions: Descriptions, Paths: Paths, Params:Params};



}





function ItemKeys(name,shortWordsHash,mixtype,maxNodigaddkeyNum,requiredkeys,notReqrequiredkeys,onekeys) {
	//чистим название товара, по аналогии с запросами getkey clearQuery
	//затем разбираем на массивы ключевых слов (по 2 и по 3 слова в КС, цифры и пр.)

//методом тыка доработал, надеюсь, правильную генерацию КС

//alert(JSON.stringify(ItemKeys(query,'kiass, Samsung')));
//alert(JSON.stringify(ItemKeys(query)));
//alert(JSON.stringify(ItemKeys(query,'kia, киа, hyundai,хендай')));


//requiredkeys - строка обязательных слов (через пробел и/или запятую), которые должны входить в КС (по одному значению)
//обязательны при отсутствии флага notReqrequiredkeys, иначе это просто дополнительные но необязательные слова во всех КС
//зачем это нужно:
//если продукт name относится ко всем этим маркам/словам
//если КС получатся слишком общие на основе названия name
//например name - это фильтр масляный, который мы продаем только для 'kia киа hyundai хендай', а в названии этого нет
//requiredkeys не добавляются к массиву цифровых КС


//'maxNodigaddkeyNum': 3, //большее из чисел кол-ва слов в КС (для не ЦБКС) в addkeystype (допускается от 3 и больше)
			//сколько будет добавлено слов в КС вместо 3-х и 2-х в addkeystype (по умолчанию 3, то есть 3 и 2)
			//то есть, если 4, то вместо 3-х и 2-х используется соответственно 4 и 3 в addkeystype
			// если 5, то вместо 3-х и 2-х используется соответственно 5 и 4 в addkeystype
			//и т.д.
			//используется если слишком много КС при малом бюджете и надо уменьшить кол-во активных, а потом после проведения оптимизации можно увеличивать кол-во КС, путем уменьшения addkeysnodigit, при этом остануться "длинные хвосты"


//возвращает undefined либо три массива
//первый массив КС - массив цифровых КС (может быть пустой)  записывать с фразовым соответствием
//второй массив КС - массив по 3 слова в КС (может быть пустой) записывать с широким соответствием с модификаторами
//третий массив КС - массив по 2 слова в КС (может быть пустой) записывать с широким соответствием с модификаторами
//все массивы КС не пересекаются, формируются в порядке следования (поэтому в первом массиве теоретически могут оказаться значения из второго или третьего)
//если пустые первые два массива КС или первые два массива КС выдадут все слова "мало показов", то добавляем третий массив КС (потом в алгоритме)
//если есть requiredkeys, то стоит добавлять КС из всех трех массивов всегда
//КС могут быть "перевернуты" (типа 'фильтр киа' и 'киа фильтр'), это сложно вычислять, оставляем так
//в КС могут дублироваться слова на разных языках, особенно с requiredkeys (типа 'фильтр киа kia'), это крайне сложно вычислять, оставляем так





function everyPermutation(args, fn) {
//множественные циклы без eval, с рекурсией
//http://qaru.site/questions/284220/variable-amount-of-nested-for-loops/1416629
//откорректировано

    if (!args.length)
	return;

    for (var j = 0; j < args.length; j++) {
	if ((args[j].min > args[j].max)||(args[j].min < 0)||(args[j].max < 0))
		return;
    }

    //var indices = args.map(a => a.min);
	//стрелочные функции не поддерживаются в AdsApp
	//https://developer.mozilla.org/ru/docs/Web/JavaScript/Reference/Functions/Arrow_functions
    var indices = args.map(function(a) {
	return a.min;
    });

    for (var j = args.length; j >= 0;) {
	//обязательно .slice() - копировать массив
        //fn.apply(null, indices.slice());
        fn.call(null, indices.slice());
        //fn(indices.slice());


        // go through indices from right to left setting them to 0
        for (j = args.length; j--;) {
            // until we find the last index not at max which we increment
            if (indices[j] < args[j].max) {
                ++indices[j];
                break;
            }
            indices[j] = args[j].min;
        }
    }
}

/*

everyPermutation([
    {min:4, max:7},
    {min:5, max:7},
//    {min:5, max:7},
//], function(a,b,c,d) {
//    console.log(a + ',' + b + ',' + c + ',' + d);
], function(arr) {
	//так как низзя что бы генерировалась куча перекрестных КС, ограничиваем только со следующего элемента (что бы не было перекрестных повторений)
    for (var j = 1; j < arr.length; j++) {
	if (arr[j] <= arr[j-1])
		return;
    }
    console.log(arr.join(','));
});

*/




	if ((!name)||(typeof name !== 'string'))
		return;

	if ((typeof maxNodigaddkeyNum !== 'number')||(maxNodigaddkeyNum < 3))
		return;

	if (requiredkeys&&(typeof requiredkeys === 'string')) {
		requiredkeys = requiredkeys.trim();
		requiredkeys = requiredkeys.split(/[\s\,]+[\+]*/);
		if (requiredkeys.length) {
			var requiredkeysHash={};
			var	metaChar = /[-[\]{}()*+?.\\^$|,]/g,
				escape = function (str) {
					return str.replace(metaChar, "\\$&");
				};
			var requiredkeysReqExp = [];
		        for (var i = 0; i < requiredkeys.length; i++) {
				var rk = requiredkeys[i].toLowerCase();
				if (!requiredkeysHash[rk]) {
					requiredkeys[i] = rk;
					requiredkeysReqExp[i] = new RegExp("(?:^|\\s)" + escape(requiredkeys[i]) + "(?:\\s|$)", "i");
					requiredkeysHash[rk] = 1;
				} else {
//дубликаты в т.ч. с большими буквами удаляем
					requiredkeys.splice(i,1);
					i--;
				}
			}
		} else {
			requiredkeys = null;
		}
	} else {
		requiredkeys = null;
	}



	var query = name;


	query = query.toLowerCase();



//если есть запятые или |, то разделяем по ним и выбираем слова (из первых двух) по наличию цифр или максимуму букв
	var qarr = query.split(/[\,\|](?![^\s\-\_\\\/\d]*[\-\_\\\/\d])/);
	if ((qarr.length > 1)&&qarr[0].length&&qarr[1].length&&((qarr[0].length + qarr[1].length) >= 10)) {
		var del = qarr[0].length/qarr[1].length;
		var koef = 10/13; // (koef должен быть < 1),  10 и 13 берем для базовой пропорции длины сравнения слов
		if ((del <= 1/koef)&&(del >= koef)) {
//если длина словосочетаний соизмерима, то ищем цифры в первую очередь
			if (/[\d]/.test(qarr[0])) {
				if (/[\d]/.test(qarr[1])) {
					if (qarr[0].length > qarr[1].length) {
						query=qarr[0];
					} else {
						query=qarr[1];
					}
				} else {
					query=qarr[0];
				}
			} else if (/[\d]/.test(qarr[1])) {
				query=qarr[1];
			} else {
				if (qarr[0].length > qarr[1].length) {
					query=qarr[0];
				} else {
					query=qarr[1];
				}
			}
		} else {
//иначе по длине выбираем
			if (qarr[0].length > qarr[1].length) {
				query=qarr[0];
			} else {
				query=qarr[1];
			}
		}
	}



//минус-слова разрешены в КС, поэтому удаляем их из КС
	query = query.replace(/((^\s*)|(\s))\-[^\s\+]+/g, '');


/*

Ниже расширил круг специсмволов (иначе будут проблемы с другими символами, которые гугл не перечислил, но выдает на них ошибку)

	//Ключевые слова не могут содержать следующие специальные символы: ! @ % , *
	//https://support.google.com/google-ads/answer/7476658?hl=ru
	// , ! @ % ^ * () = {} ; ~ ` <> ? \ |
	//поэтому удаляем эти символы, заменяем на пробелы
	if (/[\!\@\%\,\*]/.test(query)) {
		//заменяем специальные символы обязательно на пробел
//		query = query.replace(/[\!\@\%\,\*]+/g, ' ');
		//заменяем специальные символы обязательно на пробел (кроме круглых скобок)
		//круглые скобки анализируем позже и удаляем
		query = query.replace(/[\!\@\%\*\^\=\{\}\;\~\`\<\>\?\\\|]+/g, ' ');
//заменяем запятую на точку (точка вроде игнорируется)
		query = query.replace(/[\,]+/g, '.');
		if (/[^\s\[\]\"\-\+]/.test(query)) {} else {
			//если нет буквенно-цифровых символов, то выходим
			return;
		}

	}

*/

//какие символы считаем спецсимволами (KEYWORD_HAS_INVALID_CHARS):
	//  /[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\']/
	if (/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+./:\-\[\]\'\(\)]/.test(query)) {
		//заменяем специальные символы обязательно на пробел (кроме круглых скобок и запятой)
		//круглые скобки анализируем позже и удаляем
		query = query.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]\'\(\)]+/g, ' ');
//заменяем запятую на точку (точка вроде игнорируется)
		query = query.replace(/[\,]+/g, '.');
		if (/[^\s\[\]\"\-\+]/.test(query)) {} else {
			//если нет буквенно-цифровых символов, то выходим
			return;
		}
	}



	//так неверно, будем удалять из запроса или КС например знаки "минус" : +бактерицидный +облучатель +обн-150
	//	query = query.replace(/[\"\[\]\-\+]+/g, '');

	query = query.replace(/[\"\[\]]+/g, '');
	query = query.replace(/((^\s*)|(\s))[\+\-]+([^\s\+\-]+)/g, '$1$4');
//убираем одинокие + -
	query = query.replace(/((^\s*)|(\s))[\+\-]+((\s)|(\s*$))/g, ' ');
	query = query.replace(/^\s*(.*?)\s*$/, '$1');


//убираем одинокие точки
	query = query.replace(/\s+\.(?=\s)/g, '');


	if (/^\s*$/.test(query)) {
		return;
	}

//	return query;


//вроде начально очистили, теперь ищем и разбиваем на КС

//массив цифровых и по 3 слова в КС
	var keys = [];

//массив по 3 слова в КС
	var keys3 = [];

//массив по два слова в КС (если пустой первый массив или первый массив выдаст все слова "мало показов", то его добавляем потом)
	var keys2 = [];

//массив по одному слову
	var keys1 = [];

	if (onekeys&&(typeof onekeys === 'string')) {
		onekeys = onekeys.trim();
		onekeys = onekeys.split(/[\s\,]+[\+]*/);
		if (onekeys.length) {
			var onekeysHash={};
		        for (var i = 0; i < onekeys.length; i++) {
				var rk = onekeys[i].toLowerCase();
				if (!onekeysHash[rk]) {
					onekeysHash[rk] = 1;
				}
			}
                        onekeys = Object.keys(onekeysHash)
		} else {
			onekeys = [];
		}
	        for (var ii = 0; ii < onekeys.length; ii++) {
			keys1[keys1.length] = onekeys[ii];
		}
//обработка keys1 завершена, дальше нигде не используется и не обрабатывается onekeys и keys1
	}


	var afterskobki = '';

function replacer1(match, p1, p2, p3, offset, string) {

//чистим если остались скобки
	p3 = p3.replace(/\(([^\)]*)\)/g, ' ');
//чистим если остались одиночные скобки
	p3 = p3.replace(/[\(\)]+/g, '');
//все слова после первых скобок (но не в последующих скобках), удаляем и резервируем для обнаружения ЦС
	afterskobki = p3;
	p3 = '';

//теоретически здесь тоже могут остаться скобки (при некорректном наполнении КС)
	p2 = p2.replace(/\(([^\)]*)\)/g, ' ');
	p2 = p2.replace(/[\(\)]+/g, '');


//	if (/\d.*\d.*\d.*\d.*\d/.test(p2)) {
	if ((/\d.*\d.*\d.*\d.*\d/.test(p2))||(/(?=[^\s]*\d[^\s]*\d[^\s]*\d)[a-zA-Z0-9\.\-\_\/]{7,}/.test(p2))) {
//много цифр (5 и более), либо длинное английское слово (7 и более знаков, у которых не менее 3-х цифр)
		var key = p2.trim();

		if (!(/^\d+([xх]\d+)+$/i.test(key)))
			keys[keys.length] = key;

		var key2 = key.replace(/\s+/g, '');
		if (key != key2) {
//если между буквенно-цифровыми символами есть пробелы, то добавляем еще КС без пробелов
			if (key2.length&&(key2.length <= 80)&&(!(/^\d+([xх]\d+)+$/i.test(key2))))
				keys[keys.length] = key2;
		}
//удаляем слово из запроса
		return p1 + ' ' + p3;
	} else if (/\d.*\d/.test(p2)) {
//заменяем скобки на символ ` слева, что бы на следующем шаге не объединило цифры в скобках с другими цифрами, которые без скобок
//например Кровельный саморез по дереву окрашенный 4.8х19 ( 8017 ) 350 штук в упаковке
		var key2 = p2.replace(/\s+/g, '');
		if (key2.length >=5) {
			if (key2.length&&(key2.length <= 80)&&(!(/^\d+([xх]\d+)+$/i.test(key2))))
				keys[keys.length] = key2;
		}
//если несколько слов в скобках, то лучше их объединить, что бы потом не выдало их как отдельные КС, что неверно
		return p1 + ' `' + key2 + ' ' + p3;
//		return p1 + ' .' + key2 + ' ' + p3;
//		return ' .' + p1.trim() + ' ';
	} else {
		var key2 = p2.replace(/\s+/g, '');
//если несколько слов в скобках, то лучше их объединить, что бы потом не выдало их как отдельные КС, что неверно
		return p1 + ' ' + key2 + ' ' + p3;
//		return ' ' + p1.trim() + ' ';
	}

}

//удаляем скобки внутри скобок (могут появится, так как теперь мы могли вручную добавить скобки для выделения ключей)
	query = query.replace(/(\([^\(\)]*)\([^\(\)]*\)([^\(\)]*\))/g, '$1$2');

//находим цифры внутри первых скобок (black) или (SM3253452)
//если много цифр (5 и более), либо длинное английское слово (7 и более знаков, у которых не менее 3-х цифр),
//то добавляем в кс и удаляем, иначе просто убираем скобки
//все слова после первых скобок (но не в последующих скобках), удаляем и резервируем для обнаружения ЦС
//	query = query.replace(/\(([^\)]*)\)/g, replacer1);
	query = query.replace(/^([^\(]*)\(([^\)]*)\)(.*)$/, replacer1);

//чистим если остались скобки
//	query = query.replace(/\(([^\)]*)\)/g, ' ');
//чистим если остались одиночные скобки
	query = query.replace(/[\(\)]+/g, '');





function replacer2(match, p1, offset, string) {

	//так как теперь еще заводим длинные слова с небольшим кол-вом цифр, то сначала проверяем кол-во цифр
	if (!(/\d.*\d.*\d/.test(p1))) {
		return match;
	}

	var key2 = p1.trim();
	if (!(/^\d+([xх]\d+)+$/i.test(key2)))
//в конце разрешена точка, убираем если есть
//		keys[keys.length] = p1.trim().replace(/\.$/, '');
//		keys[keys.length] = p1.trim();
		keys[keys.length] = key2;


//заменяем пробелы только внутри строки, не по краям (что бы можно было потом возвратить с пробелами return key)
	var key = p1.replace(/([^\s])\s+(?=[^\s])/g, '$1');
	if (p1 != key) {
//если между буквенно-цифровыми символами есть пробелы, то добавляем еще КС без пробелов (объединяем в одно слово)
//		keys[keys.length] = key.trim();
//в конце разрешена точка, убираем если есть
//		var key2 = key.trim().replace(/\.$/, '');
		var key2 = key.trim();
		if (key2.length&&(key2.length <= 80)&&(!(/^\d+([xх]\d+)+$/i.test(key2))))
			keys[keys.length] = key2;
//не стоит убирать пробелы в цифро-буквенных словах запроса, можно получить потом "слитные" ключи с неизвестными параметрами
//хотя с другой стороны, мы получим мало пересечений слов будет что-то типа МАСЛЯНЫЙ ФИЛЬТР BOSCH 0 (то есть любые запросы), вместо МАСЛЯНЫЙ ФИЛЬТР BOSCH 0451103349
//так что опять раскомментировал (у нас есть "неслитные" цифровые ключи в keys[keys.length] = p1.trim();)

//в общем объединяем (в запросе), если у нас только цифры, иначе не объединяем (в запросе)
		if (/^\d+$/.test(key2))
			return key;
//так же объединяем (в запросе), если есть только по одному символу между пробелами
		if (/(^|\s)[^\s](\s|$)/.test(p1))
			return key;
		

		

	}
	return match;
}



//находим разные варианты, где много цифр (5 и более), добавляем в кс
//	query = query.replace(/((?:^|\s)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)*)/g, replacer2);
//	query = query.replace(/((?:^|\s)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)*(?:\s|\.|$))/g, replacer2);
//	query = query.replace(/((?:^|\s)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)(?:[^\+\-\.\s\d]*\d+[^\+\-\.\s\d]*\s*)*(?:\s|\.\s|$))/g, replacer2);

//это рабочий вариант (с точкой слева)
//	query = query.replace(/((?:^|\s)(?:[^\+\-\.\/\s\d]*\d+[^\+\-\.\/\s\d]*\s*)(?:[^\+\-\.\/\s\d]*\d+[^\+\-\.\/\s\d]*\s*)(?:[^\+\-\.\/\s\d]*\d+[^\+\-\.\/\s\d]*\s*)(?:[^\+\-\.\/\s\d]*\d+[^\+\-\.\/\s\d]*\s*)(?:[^\+\-\.\/\s\d]*\d+[^\+\-\.\/\s\d]*\s*)(?:[^\+\-\.\/\s\d]*\d+[^\+\-\.\/\s\d]*\s*)*(?:\s|\.\s|$))/g, replacer2);


//	query = query.replace(/((?:^|\s)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)*(?:\s|$))/g, replacer2);
//добавлено, проверяем теперь еще длинные английские слова (7 и более знаков, у которых не менее 3-х цифр)
//	query = query.replace(/((?:^|\s)(?:(?:(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)*)|(?:[a-zA-Z0-9\.\-\_\/]{7,}))(?:\s|$))/g, replacer2);

//исправлено, что бы пробелом не заканчивалось выражение, а только проверялось наличие пробела в конце (иначе, например, если сначала не ЦС и затем два ЦС подряд, то второе ЦС не будет обнаружено)
//	query = query.replace(/((?:^|\s)(?:(?:(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)(?:[^\`\/\s\d]*\d+[^\`\/\s\d]*\s*)*)|(?:[a-zA-Z0-9\.\-\_\/]{7,}))(?=\s|$))/g, replacer2);

//доработано
//	query = query.replace(/((?:^|\s)(?:(?:(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)*)|(?:[a-zA-Z0-9\.\-\_\/]{7,}))(?=\s|$))/g, replacer2);
/*
верхнее опять доработано из-за глюка гугла, пример:
var querytest = 'фильтр воздух во внутренном пространстве mann-filter cuk 2019'
//Работает        
var found = querytest.match(/((?:^|\s)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)*(?=\s|$))/)
//Не работает                
var found = querytest.match(/((?:^|\s)(?:(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)*)(?=\s|$))/)
//а вот так заработало
var found = querytest.match(/((?:^|\s)(?:(?=[^\`\s\d]*\d+)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)*)(?=\s|$))/)
//сильно слило бюджет у клиента на запросах с 2019 (это год) (то есть появилось фразовое "2019" и точное слова [2019])
Logger.log(found)
*/

//теперь еще глюк гугла убран (можно сравнить с верхним)
	query = query.replace(/((?:^|\s)(?:(?:(?=[^\`\s\d]*\d+)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)*)|(?:[a-zA-Z0-9\.\-\_\/]{7,}))(?=\s|$))/g, replacer2);

//ищем цс в резервном тексте после первых скобок (полностью повторяет предыдущее рег. выражение)
	afterskobki.replace(/((?:^|\s)(?:(?:(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)(?:[^\`\s\d]*\d+[^\`\s\d]*\s*)*)|(?:[a-zA-Z0-9\.\-\_\/]{7,}))(?=\s|$))/g, replacer2);



//дальше начинается обработка нецифровых слов


//чистим лишние точки слева от слов, если появились за один шаг до этого
//	query = query.replace(/(\s)\./g, '$1');
//чистим символы ` слева от слов, если появились за один шаг до этого
	query = query.replace(/[\`]+/g, '');


//убираем везде отдельные слова без цифр и букв
	query = query.replace(/(?:^|(?:\s+))[^\s\d\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+(?=\s|$)/g, '');


//предварительно нужно убрать пробелы в начале и в конце, если есть
	query = query.trim();

//сколько больших слов являются стартовыми для генерации КС (всегда 2)
//два варианта для одного стартового вместо двух:
//1. второе слово меньше 4-х букв
//2. mixtype > 0
	var startkeysNum = 2;

	if (mixtype) {
		startkeysNum = 1;
	}


//проверяем второе слово на длину 4 символа (так как перые два слова используются как базовые для старта генерации КС)
//зачем - например "Сумка Для Обуви На 2 Пары Мягкая с Рисунком",
//то будет удалено Для и первые два слова будут Сумка и Обуви, слова начиная с Обуви дадут нецелевой трафик точно, например, "Обуви Мягкая Рисунком"
//то есть если второе слово Для то после его удаления третье слово нельзя делать стартовым для генерации
//так же всегда использовать вторым словом в КС следующее длинное слово (это контролируется ниже), то есть должны присутсвовать всегда в примере 2 слова Сумка и Обуви
	var shortsecondkey = 0;
//	if (/^[^\s]+\s+[^\s\d\-\_\/\\]{1,3}(\s+|$)/.test(query)) {
//нужно проверять конкретно наличие только букв, а не слова без цифр и пр.
	if (/^[^\s]+\s+[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]{1,3}(\s+|$)/.test(query)) {
		shortsecondkey = 1;
		startkeysNum = 1;
	}


//убираем внутри строки слова без цифр и пр., у которых меньше 4-х символов
//	query = query.replace(/\s+[^\s\d\-\_\/\\]{1,3}(?=\s+)/g, '');
//правильно так:
//убираем внутри строки слова только с буквами, у которых меньше 4-х символов
//	query = query.replace(/\s+[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]{1,3}(?=\s+)/g, '');
//новый вариант:
function replacerShort1(match, p1, offset, string) {
	//word - короткое слово, которое нужно удалить
	var word = p1.toLowerCase();
	if (shortWordsHash[word]) {
		//нельзя удалять, оно занесено в список реальных слов
		return match;
	} else {
		//можно удалять
		return '';
	}
}
	query = query.replace(/\s+([\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]{1,3})(?=\s+)/g, replacerShort1);




//обязательно чистим пробелы
	query = query.replace(/\s+/g, ' ');
	query = query.trim();


//alert(query)

	if (!query) {
		//обязательно учесть, что теперь может не остаться слов после добавления ЦС
		if (keys.length||keys2.length||keys3.length||keys1.length) {
			return [keys,keys3,keys2,keys1];
		} else {
			return;
		}
	}


//с цифрами разобрались, теперь разбиваем по 2-3 слова в КС
//с первым и вторым словом из запроса генерируем по три слова КС (если после добавления КС будут все слова со статусом "мало показов", то сделать по 2 слова)
	var keysarr = query.split(/\s+/);


	var SecondKeysArrMaxNum = keysarr.length;
//если второе слово было коротким, то всегда вторым словом в КС должно быть только следующее длинное слово
	if (shortsecondkey) {
//сколько вторых слов может быть (только одно, отсчет начинается со второго по счету), то есть значение равно 2
		SecondKeysArrMaxNum = 2;
		SecondKeysArrMaxNum = (keysarr.length >= SecondKeysArrMaxNum) ? SecondKeysArrMaxNum : keysarr.length;
	}


	//количество стартовых слов в КС (обычно 2 (первое и второе), но есть исключение (только 1 - читаем выше про startkeysNum))
	var maxStartElements = ((startkeysNum >= keysarr.length) ? keysarr.length : startkeysNum);


	//теперь везде используется не 3 и 2 слова, а maxNodigaddkeyNum и maxNodigaddkeyNum-1 слов

	//идея ниже в том что вместо одного 3-го слова, нам нужно добавить в keys3 все неповторяющиеся слова от 3-го до maxNodigaddkeyNum включительно

	//предварительный массив массивов номеров слов из keysarr для 3-х слов (он уточнится при вызове everyPermutation)
	//массив массивов номеров элементов для перебора 3-х слов с учетом maxNodigaddkeyNum (это все слова от 3-го и дальше, их перебор)
	//все переборы делаются в одном массиве keysarr и каждый следующий цикл начинается со значения предыдущего +1
	var NumsforWords3 = [];
	if ((mixtype == 2)||(mixtype == 4)) {
		//max не может быть больше чем min
		NumsforWords3.push({min: 0, max: (maxStartElements - 1 > 0 ? 0 : maxStartElements - 1)});
		NumsforWords3.push({min: 1, max: (SecondKeysArrMaxNum - 1 > 1 ? 1 : SecondKeysArrMaxNum - 1)});
	        for (var i = 2; i < maxNodigaddkeyNum; i++) {
			//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
			NumsforWords3.push({min: i, max: (keysarr.length - 1 > i ? i : keysarr.length - 1)});
			//можно и так, потом очистится при вызове everyPermutation
			//NumsforWords3.push({min: 2, max: (keysarr.length - 1 > i ? i : keysarr.length - 1)});
		}
	} else if (mixtype == 3) {
		//max не может быть больше чем min для первых двух слов
		NumsforWords3.push({min: 0, max: (maxStartElements - 1 > 0 ? 0 : maxStartElements - 1)});
		NumsforWords3.push({min: 1, max: (SecondKeysArrMaxNum - 1 > 1 ? 1 : SecondKeysArrMaxNum - 1)});
	        for (var i = 2; i < maxNodigaddkeyNum; i++) {
			//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
			NumsforWords3.push({min: i, max: keysarr.length - 1});
			//можно и так, потом очистится при вызове everyPermutation
			//NumsforWords3.push({min: 2, max: keysarr.length - 1});
		}
	} else {
		NumsforWords3.push({min: 0, max: maxStartElements - 1});
		NumsforWords3.push({min: 1, max: SecondKeysArrMaxNum - 1});
	        for (var i = 2; i < maxNodigaddkeyNum; i++) {
			//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
			NumsforWords3.push({min: i, max: keysarr.length - 1});
			//можно и так, потом очистится при вызове everyPermutation
			//NumsforWords3.push({min: 2, max: keysarr.length - 1});
		}
	}


//учитываем requiredkeys (но всего должно быть по 3 слова, не больше и не меньше)
//с учетом requiredkeys может появится 4 слова, поэтому надо следиить за количеством
//сначала по 3 с первым словом, потом по 3 со вторым словом

	everyPermutation(NumsforWords3, function(arr) {
//вызов рекурсивного перебора по любому количеству циклов
//каждый следующий цикл начинается с индекса предыдущего +1, иначе будут дубликаты и пр. каша
		//console.log(arr.join(','));

		//копируем все слова в другой массив
	        var keysarr2 = keysarr.slice();

		var key = ''
		var keysd = {}
		for (var j = 0; j < arr.length; j++) {
			//одновременно делаем проверку, что номер следующего элемента больше предыдущего
			if (j&&(arr[j] <= arr[j-1]))
				return;

			//делаем пометку, что слово задействовано в КС
			keysarr2[arr[j]] = '';

			//одновременно делаем проверку на дубликаты внутри КС (могут быть в передаваемом поле)
			if (keysd[keysarr[arr[j]]]) {
				return;
			} else {
				keysd[keysarr[arr[j]]] = 1;
			}
			if (key) {
				key += ' ' + keysarr[arr[j]];
			} else {
				key = keysarr[arr[j]];
			}
		}

		//не все слова задействованы в КС, не добавляем КС
		if ((mixtype == 4)&&(keysarr2.join('') !== ''))
			return;

		//на всякий случай проверяем, хотя не должно быть пусто
		if (key) {
			if ((keys.indexOf(key) == -1)&&(keys2.indexOf(key) == -1)&&(keys3.indexOf(key) == -1))  {
				if (key.length&&(key.length <= 80)) {
					if (requiredkeys) {
						var addkey = 0;
					        for (var ii = 0; ii < requiredkeys.length; ii++) {
							if (requiredkeysReqExp[ii].test(key)) {
//только 3 символа можно, поэтому разрешено записывать, если совпадают. Если не совпадают, то это будет 4 - низзя
//то есть мы можем записать здесь только если одно из слов совпадает с одним из слов requiredkeys, иначе не пишем
								keys3[keys3.length] = key;
								addkey = 1;
							}
						}
						if (notReqrequiredkeys&&(!addkey)) {
							keys3[keys3.length] = key;
						}
					} else {
						keys3[keys3.length] = key;
					}
				}
			}
		}
	});



	//идея ниже в том что вместо одного 2-го слова, нам нужно добавить в keys2 все неповторяющиеся слова от 2-го до maxNodigaddkeyNum-1 включительно

	//предварительный массив массивов номеров слов из keysarr для 2-х слов (он уточнится при вызове everyPermutation)
	//массив массивов номеров элементов для перебора 2-х слов с учетом maxNodigaddkeyNum (это все слова от 2-го и дальше, их перебор)
	var NumsforWords2 = [];
	if ((mixtype == 2)||(mixtype == 4)) {
		//max не может быть больше чем min
		NumsforWords2.push({min: 0, max: (maxStartElements - 1 > 0 ? 0 : maxStartElements - 1)});
		NumsforWords2.push({min: 1, max: (SecondKeysArrMaxNum - 1 > 1 ? 1 : SecondKeysArrMaxNum - 1)});
        	for (var i = 2; i < maxNodigaddkeyNum - 1; i++) {
			//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
			NumsforWords2.push({min: i, max: (keysarr.length - 1 > i ? i : keysarr.length - 1)});
			//можно и так, потом очистится при вызове everyPermutation
			//NumsforWords2.push({min: 2, max: (keysarr.length - 1 > i ? i : keysarr.length - 1)});
		}
	} else if (mixtype == 3) {
		//max не может быть больше чем min для первых двух слов
		NumsforWords2.push({min: 0, max: (maxStartElements - 1 > 0 ? 0 : maxStartElements - 1)});
		NumsforWords2.push({min: 1, max: (SecondKeysArrMaxNum - 1 > 1 ? 1 : SecondKeysArrMaxNum - 1)});
        	for (var i = 2; i < maxNodigaddkeyNum - 1; i++) {
			//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
			NumsforWords2.push({min: i, max: keysarr.length - 1});
			//можно и так, потом очистится при вызове everyPermutation
			//NumsforWords2.push({min: 2, max: keysarr.length - 1});
		}
	} else {
		NumsforWords2.push({min: 0, max: maxStartElements - 1});
		NumsforWords2.push({min: 1, max: SecondKeysArrMaxNum - 1});
        	for (var i = 2; i < maxNodigaddkeyNum - 1; i++) {
			//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
			NumsforWords2.push({min: i, max: keysarr.length - 1});
			//можно и так, потом очистится при вызове everyPermutation
			//NumsforWords2.push({min: 2, max: keysarr.length - 1});
		}
	}


//учитываем requiredkeys (но всего должно быть по 2 слова, не больше и не меньше)
//с учетом requiredkeys может появится 3 слова, поэтому надо следиить за количеством и добавлять в соотв. массив
//теперь по 2 с первым словом, потом по 2 со вторым словом

	everyPermutation(NumsforWords2, function(arr) {
//вызов рекурсивного перебора по любому количеству циклов
//каждый следующий цикл начинается с индекса предыдущего +1, иначе будут дубликаты и пр. каша
		//console.log(arr.join(','));

		//копируем все слова в другой массив
	        var keysarr2 = keysarr.slice();

		var key = ''
		var keysd = {}
		for (var j = 0; j < arr.length; j++) {
			//одновременно делаем проверку, что номер следующего элемента больше предыдущего
			if (j&&(arr[j] <= arr[j-1]))
				return;

			//делаем пометку, что слово задействовано в КС
			keysarr2[arr[j]] = '';

			//одновременно делаем проверку на дубликаты внутри КС (могут быть в передаваемом поле)
			if (keysd[keysarr[arr[j]]]) {
				return;
			} else {
				keysd[keysarr[arr[j]]] = 1;
			}
			if (key) {
				key += ' ' + keysarr[arr[j]];
			} else {
				key = keysarr[arr[j]];
			}
		}

		//не все слова задействованы в КС, не добавляем КС
		if ((mixtype == 4)&&(keysarr2.join('') !== ''))
			return;

		//на всякий случай проверяем, хотя не должно быть пусто
		if (key) {
			if ((keys.indexOf(key) == -1)&&(keys2.indexOf(key) == -1)&&(keys3.indexOf(key) == -1))  {
				if (key.length&&(key.length <= 80)) {
					if (requiredkeys) {
						var addkey = 0;
					        for (var ii = 0; ii < requiredkeys.length; ii++) {
							if (requiredkeysReqExp[ii].test(key)) {
//только 2 символа можно, поэтому разрешено записывать, если совпадают. Если не совпадают, то это будет 3
								keys2[keys2.length] = key;
								addkey = 1;
							} else {
								var key2 = key + ' ' +  requiredkeys[ii];
								if ((keys.indexOf(key2) == -1)&&(keys2.indexOf(key2) == -1)&&(keys3.indexOf(key2) == -1))  {
//здесь пишем в 3-х буквенный массив
									if (key2.length&&(key2.length <= 80)) {
										keys3[keys3.length] = key2;
									}
								}
							}
						}
						if (notReqrequiredkeys&&(!addkey)) {
							keys2[keys2.length] = key;
						}
					} else {
						keys2[keys2.length] = key;
					}
				}
			}


		}
	});




//если есть requiredkeys, то проходим и по одному слову, так как добавляем и будет 2
	if (requiredkeys) {

		//идея ниже в том что вместо одного 1-го слова + слово из requiredkeys, нам нужно добавить в keys2 все неповторяющиеся слова от 1-го до maxNodigaddkeyNum-2 включительно

		//предварительный массив массивов номеров слов из keysarr для 1-го слова (он уточнится при вызове everyPermutation)
		//массив массивов номеров элементов для перебора по 1-му слову с учетом maxNodigaddkeyNum (это все слова от 1-го и дальше, их перебор)
		var NumsforWords1 = [];
		if ((mixtype == 2)||(mixtype == 4)) {
			//max не может быть больше чем min
			NumsforWords1.push({min: 0, max: (maxStartElements - 1 > 0 ? 0 : maxStartElements - 1)});
			if (maxNodigaddkeyNum >= 4) {
				NumsforWords1.push({min: 1, max: (SecondKeysArrMaxNum - 1 > 1 ? 1 : SecondKeysArrMaxNum - 1)});
			        for (var i = 2; i < maxNodigaddkeyNum - 2; i++) {
					//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
					NumsforWords1.push({min: i, max: (keysarr.length - 1 > i ? i : keysarr.length - 1)});
					//можно и так, потом очистится при вызове everyPermutation
					//NumsforWords1.push({min: 0, max: (keysarr.length - 1 > i ? i : keysarr.length - 1)});
				}
			}
		} else if (mixtype == 3) {
			//max не может быть больше чем min для первых двух слов
			NumsforWords1.push({min: 0, max: (maxStartElements - 1 > 0 ? 0 : maxStartElements - 1)});
			if (maxNodigaddkeyNum >= 4) {
				NumsforWords1.push({min: 1, max: (SecondKeysArrMaxNum - 1 > 1 ? 1 : SecondKeysArrMaxNum - 1)});
			        for (var i = 2; i < maxNodigaddkeyNum - 2; i++) {
					//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
					NumsforWords1.push({min: i, max: keysarr.length - 1});
					//можно и так, потом очистится при вызове everyPermutation
					//NumsforWords1.push({min: 0, max: keysarr.length - 1});
				}
			}
		} else {
			NumsforWords1.push({min: 0, max: maxStartElements - 1});
			if (maxNodigaddkeyNum >= 4) {
				NumsforWords1.push({min: 1, max: SecondKeysArrMaxNum - 1});
			        for (var i = 2; i < maxNodigaddkeyNum - 2; i++) {
					//третий и выше массивы начинаются со 2-го элемента (3-е слово), каждый следующий увеличиваем на 1
					NumsforWords1.push({min: i, max: keysarr.length - 1});
					//можно и так, потом очистится при вызове everyPermutation
					//NumsforWords1.push({min: 0, max: keysarr.length - 1});
				}
			}
		}


		everyPermutation(NumsforWords1, function(arr) {
//вызов рекурсивного перебора по любому количеству циклов
//каждый следующий цикл начинается с индекса предыдущего +1, иначе будут дубликаты и пр. каша
			//console.log(arr.join(','));

			//копируем все слова в другой массив
		        var keysarr2 = keysarr.slice();

			var key = ''
			var keysd = {}
			for (var j = 0; j < arr.length; j++) {
				//одновременно делаем проверку, что номер следующего элемента больше предыдущего
				if (j&&(arr[j] <= arr[j-1]))
					return;

				//делаем пометку, что слово задействовано в КС
				keysarr2[arr[j]] = '';

				//одновременно делаем проверку на дубликаты внутри КС (могут быть в передаваемом поле)
				if (keysd[keysarr[arr[j]]]) {
					return;
				} else {
					keysd[keysarr[arr[j]]] = 1;
				}
				if (key) {
					key += ' ' + keysarr[arr[j]];
				} else {
					key = keysarr[arr[j]];
				}
			}

			//не все слова задействованы в КС, не добавляем КС
			if ((mixtype == 4)&&(keysarr2.join('') !== ''))
				return;

			//на всякий случай проверяем, хотя не должно быть пусто
			if (key) {
			        for (var ii = 0; ii < requiredkeys.length; ii++) {
					if (!requiredkeysReqExp[ii].test(key)) {
//здесь пишем в 2-х буквенный массив
						var key2 = key + ' ' +  requiredkeys[ii];
						if ((keys.indexOf(key2) == -1)&&(keys2.indexOf(key2) == -1)&&(keys3.indexOf(key2) == -1))  {
							if (key.length&&(key.length <= 80)) {
								keys2[keys2.length] = key2;
							}
						}
					}
				}
			}
		});


	}


	if (keys.length||keys2.length||keys3.length||keys1.length) {
		return [keys,keys3,keys2,keys1];
	} else {
		return;
	}




}


function checkSaveFile(file, FileData, BinaryFlg) {
//проверка записанного (созданного или перезаписанного) файла
//для функций setContent createFile makeCopy moveTo
//часто пишет "пусто" вместо данных - это главная проверка


//файлы не могут быть больше 10 мгб для setContent, который используется для восстановления файла
	if (FileData.length >= 10*1000*1000) {
		var newfile = DriveApp.getFileById(file.getId());
	   	try {
//пришлось делать try
//здесь появилась необъяснимая ошибка Access denied: DriveApp
//при чем возникает не на всех файлах, в общем непонятно
//found not correct saved text file data in checkSaveFile for files/sonoscape.in.ua.sonoscapeinua.feed.main_ru.html, Error: Access denied: DriveApp.
			if (BinaryFlg) {
				FileLength = newfile.getBlob().getBytes().length;
			} else {
				FileLength = newfile.getBlob().getDataAsString().length;
			}
		} catch (e) {
			var fn = '';
			var parents = newfile.getParents();
			if (parents.hasNext()) {
				fn = parents.next().getName() + '/';
			}
			if (BinaryFlg) {
				var filetype = 'binary';
			} else {
				var filetype = 'text';
			}
			throw new Error("found not correct saved " + filetype + " file data in checkSaveFile for " + fn + newfile.getName() + ', Error: ' + e.message);
		}
		if (FileLength != FileData.length) {
			var fn = '';
			var parents = newfile.getParents();
			if (parents.hasNext()) {
				fn = parents.next().getName() + '/';
			}
			if (BinaryFlg) {
				var filetype = 'binary';
			} else {
				var filetype = 'text';
			}
			throw new Error("found not correct saved " + filetype + " file data in checkSaveFile for " + fn + newfile.getName() + ', correct Data Size: ' + FileData.length + ', not correct fileSize: ' + FileLength);

		}
		return file;
	}

	var i = 0;
	while (1) {
		//перечитать файл
		var newfile = DriveApp.getFileById(file.getId());
	   	try {
//пришлось делать try
//здесь появилась необъяснимая ошибка Access denied: DriveApp
//при чем возникает не на всех файлах, в общем непонятно
//found not correct saved text file data in checkSaveFile for files/sonoscape.in.ua.sonoscapeinua.feed.main_ru.html, Error: Access denied: DriveApp.
			if (BinaryFlg) {
				FileLength = newfile.getBlob().getBytes().length;
			} else {
				FileLength = newfile.getBlob().getDataAsString().length;
			}
		} catch (e) {
			var fn = '';
			var parents = newfile.getParents();
			if (parents.hasNext()) {
				fn = parents.next().getName() + '/';
			}
			if (BinaryFlg) {
				var filetype = 'binary';
			} else {
				var filetype = 'text';
			}
			throw new Error("found not correct saved " + filetype + " file data in checkSaveFile for " + fn + newfile.getName() + ', Error: ' + e.message);
		}
		if (FileLength != FileData.length) {
			newfile.setContent(FileData);
		} else {
			break;
		}
		i++;
		if (i > 10) {
			var fn = '';
			var parents = newfile.getParents();
			if (parents.hasNext()) {
				fn = parents.next().getName() + '/';
			}
			if (BinaryFlg) {
				var filetype = 'binary';
			} else {
				var filetype = 'text';
			}
			throw new Error("found not correct saved " + filetype + " file data in checkSaveFile for " + fn + newfile.getName() + ', correct Data Size: ' + FileData.length + ', not correct fileSize: ' + FileLength);
		}
	}

	return newfile;

}


//https://stackoverflow.com/questions/29532321/google-apps-script-permissions-on-created-file-in-shared-folder
//setTrashed (удалять в корзину может только собственник файла)
//иначе setTrashed выдает ошибку "Access denied: DriveApp"

function deleteOrRemoveFile(file, nosleep) {
//новое изменение гугла - removeFile теперь выкидывает видимый файл в папку root, поэтому надо его менять на moveTo
//поэтому removeFile уже почти не актуально

//проблема что через removeFile файл удаляется не сразу а через время, пробуем отправку в корзину
//оказалось setTrashed дает ошибку "Access denied: DriveApp" на файлах, которым скрипт не owner
//мы не можем определить собственника в AdsApp, поэтому используем try
//removeFile всегда работает нормально, но дольше в 2 раза, поэтому для removeFile потом чистим "бесхозные" файлы другим скриптом
//removeFile может не удалить файл, если удаляем несколько файлов сразу (насчет setTrashed не проверено) - возможно требуется задержка перед удалением
	try {
	    // If I own the file, trash it.
	    file.setTrashed(true);
	} catch (e) {
		// If I don't own the file, remove it.
		var oldRemove = 0;
		if ((typeof GLtrashedfolder != 'undefined')&&GLtrashedfolder) {
			try {
				file.moveTo(GLtrashedfolder);
			} catch (e) {
				//пытаемся хот куда-то запихнуть удаляемый файл (в папку root)
				oldRemove = 1;
			}
		} else {
			//если некуда скидывать (не определена GLtrashedfolder), то скидываем в root
			oldRemove = 1;
		}
		if (oldRemove) {
			var parents = file.getParents();
			while (parents.hasNext()) {
				// Remove the file from the current folder.
				parents.next().removeFile(file);
			}
		}
	}
//может поможет "от неудаления файлов", если файлов несколько
//проверено - немного помогает но не сильно, возможно нужна больше задержка (лучше задержку делать после всех удалений)
	if (!nosleep)
		Utilities.sleep(300);
	
}



function JSONparsestringifyStopInit() {

	if (this.JSON) {
		if (this.JSON.oldstringify&&this.JSON.stringify) {
			this.JSON.stringify = this.JSON.oldstringify
			//this.JSON.oldstringify = undefined
			delete this.JSON.oldstringify;
		}
		if (this.JSON.oldparse&&this.JSON.parse) {
			this.JSON.parse = this.JSON.oldparse
			//this.JSON.oldparse = undefined
			delete this.JSON.oldparse;
		}
	}


}

function JSONparsestringifyInit() {


	if ((!this.JSON)||({}.toString.call(this.JSON) != '[object JSON]'))
		this.JSON = {};


	(function (root) {
    "use strict";


    var rx_escapable = /[\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;

     var meta = {    // table of character substitutions
            "\b": "\\b",
            "\t": "\\t",
            "\n": "\\n",
            "\f": "\\f",
            "\r": "\\r",
            "\"": "\\\"",
            "\\": "\\\\"
        };


    function quote(string) {



// If the string contains no control characters, no quote characters, and no
// backslash characters, then we can safely slap some quotes around it.
// Otherwise we must also replace the offending characters with safe escape
// sequences.

        return rx_escapable.test(string)
            ? "\"" + string.replace(rx_escapable, function (a) {
                var c = meta[a];
                return typeof c === "string"
                    ? c
                    : "\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4);
            }) + "\""
            : "\"" + string + "\"";
    }


	root.JSON.oldstringify = root.JSON.stringify


	root.JSON.stringify = function (obj) {

		var t = typeof (obj);

		if (t != "object" || !obj) {
			//undefined null bullean number string


			switch (t) {

				case "string":
			            return quote(obj);

			        case "number":

// JSON numbers must be finite. Encode non-finite numbers as null.

			            return (isFinite(obj))
			                ? String(obj)
			                : "null";

			        case "boolean":
			        case "undefined":
				default:

					//object == null

			            return String(obj);

			}


		}
		else {

			// recurse array or object
			var n, v, json = [], arr = (obj && obj.constructor == Array);


			for (n in obj) {
				v = obj[n]; t = {}.toString.call(v);


				switch (t) {
					case '[object String]':
						v = quote(v);
						break;

					case '[object Number]':

				            v = (isFinite(v))
				                ? String(v)
				                : "null";
						break;

				        case '[object Date]':
						v = 'new Date("'+v.toString()+'")';
						break;

					case '[object RegExp]':
				        case '[object Function]':
						v = v.toString();
						break;
				        case '[object Array]':
				        case '[object Object]':
						v = JSON.stringify(v);
						break;
					default:
						//[object Boolean] [object Null] [object Undefined] unknown
						v = String(v);

				}

				json.push((arr ? "" : '"' + n + '":') + v);

			}

			return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}");
		}



	}


	root.JSON.oldparse = root.JSON.parse


	root.JSON.parse = function (value) {

		return eval('(' + value + ')')

	}



	}(this));

}



/*

предыдущий вариант, который давал ошибки на строках и вообще не все там было, оставил для истории

1.размещаем в самом верху
JSON.stringify = stringifyJSON;
JSON.parse = parseJSON;

2.помещаем где-то сами функции stringifyJSON и parseJSON
3.все



function stringifyJSON (obj) {
//полное безопасное преобразование всех элементов
	var t = typeof (obj);
	if (t != "object" || obj === null) {

		// simple data type
		if (t == "string") obj = '"'+obj+'"';
		return String(obj);

	}
	else {

		// recurse array or object
		var n, v, json = [], arr = (obj && obj.constructor == Array);


		for (n in obj) {
			v = obj[n]; t = typeof(v);
			var tt = {}.toString.call(v);

			if (t == "string") v = '"'+v+'"';
			else if (tt == '[object RegExp]')
				v = v.toString();
			else if (tt == '[object Date]')
				v = 'new Date("'+v.toJSON()+'")';
			else if (t == 'function')
				v = v.toString();
			else if (t == "object" && v !== null) {
				v = stringifyJSON(v);
			}

			json.push((arr ? "" : '"' + n + '":') + String(v));
		}

		return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}");
	}
};

function parseJSON(data) {
	return eval('(' + data + ')')
}


*/









Контейнер SSMFD 1

устранена проблема невидимости кода при запуске по eval
раньше требовалось так:
сначала надо загрузить вместо скрипта запуска полный скрипт и пустить его на тестовое выполнение
иначе гугл не увидит и не даст разрешения на почту и пр. (соответственно не будет отправлятся почта и пр.)



!!!!!!!!!!!!!!!!!!
слишком большой код и запутанный, поэтому 
сначала https://beautifier.io/
потом https://closure-compiler.appspot.com/home

ЛУЧШЕ ТАК
открываем пять окон https://closure-compiler.appspot.com/home
и запускаем скрипт - где-то выполнится без ошибок


можно использовать что-то другое для чистки и кодирования, хотя опасно может наковырять
https://dotmaui.com/jsminify/
https://www.cleancss.com/javascript-minify/
https://html-cleaner.com/js/
http://toolset.pkstate.com/removeComments/index.html



var SCRIPT_ID = 1;
var SCRIPT_ID_NAME = 'SSMFD';
var SCRIPT_USED = 'MAX';
//var testing_ID = 1 для тестовых
//var testingJob = '276-251-2831 demodomain.com'; //для тестовых в режиме просмотра (необязательно)
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('q 1h(){o;1i.9();1j.9();i.X();i.1k();i.1l();i.1m();i.1n();i.1o();i.1p();i.1q();i.1r();i.1s();i.1t();i.1u();i.9();i.1v();i.1w();7.1x();7.1y();7.1z();7.N();7.Y();7.1A();7.1B();7.1C();7.1D();7.1E();7.1F();7.O();7.1G();7.9();7.1H();7.1I();7.1J();7.1K();7.1L();7.1M();7.P();7.1N();7.1O();r.1P();r.1Q();r.1R();r.1S();r.1T();r.1U();r.9();r.1V();r.1W();p.1X();p.Z();p.1Y();p.1Z();p.20();p.21();p.22();p.23();p.9();p.24();p.25();F.26();F.27();F.28();F.9();29.9();3.2a();3.2b();3.2c();3.2d();3.2e();3.2f();3.2g();3.2h();3.2i();3.10();3.2j();3.2k();3.2l();3.2m();3.11();3.2n();3.2o();3.2p();3.2q();3.2r();3.A();3.2s();3.2t();3.2u();3.2v();3.9();3.2w();4.2x();4.2y();4.2z();4.2A();4.2B();4.2C();4.2D();4.2E();4.2F();4.10();4.2G();4.11();4.2H();4.X();4.2I();4.2J();4.2K();4.2L();4.2M();4.2N();4.2O();4.9();4.2P();4.2Q();4.2R();w.2S();w.2T();w.2U();w.2V();w.9();w.2W();6.2X();6.2Y();6.2Z();6.30();6.31();6.32();6.33();6.34();6.35();6.36();6.37();6.38();6.39();6.12();6.3a();6.3b();6.3c();6.3d();6.3e();6.3f();6.3g();6.9();6.3h();j.3i();j.3j();j.3k();j.3l();j.3m();j.3n();j.3o();j.3p();j.3q();j.3r();j.3s();j.3t();j.9();j.3u()};t 13="3v/3w/3x/"+3y,Q=["3z 3A: G."],R=H(14,[13],Q);8(R){t 15=H(q(b){o b.3B().3C()},[R],Q);3D(15)}q 14(b){t a=b.16("/");o(b=17(b))?(a=b.N(a[a.x-1]),a.I()?a.J():u):u}q 17(b){t a=G.P();8(b&&(b=b.16("/"),b.x)){t c=b[0];a=a.O(c);a=a.I()?a.J():u;8(!a)8(a=G.P().N(c),a.I()){a=a.J();a=a.3E();8(!a)o u;a=G.Y(a);8(!a)o u}S o u;B(t e T b)8(0!=e){8(e==b.x-1)3F;c=b[e];a=a.O(c);8(a.I())a=a.J();S o u}}o a}q H(b,a,c,e,g,f,k,h){q m(d){o c.3G(q(n){o-1!=d.9().3H(n)})}8(c&&("K"!==y c||"[K 18]"!=={}.9.19(c)))v"C L s D a U 1a V B M s A";8(!c.x)v"C L s D a U 1a V B M s A";e=z.W(e||3I);f=z.W(f||1);g=z.W(g||5);8(h&&"q"!==y h)v"8 C D a 3J 3K 3L 3M a q";8(!b||"q"!==y b)v"C L s D a q B M s A";8(!a||"K"===y a&&"[K 18]"==={}.9.19(a))3N{t l=b.3O(b,a);o h?h(l):l}3P(d){k&&p.Z("3Q "+f+":"+d);8(m(d)){8(f+1>g)v b=b.1b,d.E="1c"==y b&&b.x?d.E+" (T "+b+" 1d 1e 1f "+f+" 1g)":d.E+" (1d 1e 1f "+f+" 1g)",d;6.12(z.3R(z.3S(2,f)*e*(z.3T()+1)));o H(b,a,c,e,g,f+1,k)}b=b.1b;"1c"==y b&&b.x&&(d.E=d.E+" (T "+b+")");v d;}S v"C L s D a U 3U V B M s A";};',62,243,'|||ScriptyApp|SpreadsheetApp||Utilities|Drive|if|toString|||||||||Charts|XmlService|||||return|Logger|function|Jdbc|to|var|null|throw|UrlFetchApp|length|typeof|Math|execute|for|you|specify|message|MailApp|DriveApp|rateLimitExpBackoff|hasNext|next|object|need|rateLimitBackoff|getFilesByName|getFoldersByName|getRootFolder|backoffErrors|sFile|else|in|correct|array|abs|newTextStyle|getFolderById|log|flush|create|sleep|scrloc|getFile0000|sText|split|getFolder0000|Array|call|Errors|name|string|tried|backing|off|times|OuRauthFunc|AdWordsApp|MccApp|newColumnChart|newAreaChart|newPieChart|newCategoryFilter|newStringFilter|newBarChart|newLineChart|newNumberRangeFilter|newScatterChart|newTableChart|newDashboardPanel|newDataTable|newDataViewDefinition|getStorageUsed|getTrashedFolders|searchFolders|continueFileIterator|getTrashedFiles|getFiles|createFile|removeFile|getStorageLimit|searchFiles|getFilesByType|createFolder|removeFolder|addFolder|getFolders|getFileById|addFile|continueFolderIterator|getConnection|parseDate|newTime|newTimestamp|parseTimestamp|newDate|getCloudSqlConnection|parseTime|finest|fine|getLog|finer|severe|clear|warning|config|info|sendEmail|getRemainingDailyQuota|createMessage|MimeType|container|logMethodCall|isConfigured|secret|getErrors|getCachedByName|setHeader|createInMemory|createNow|getCached|get|getAccount|createFileUpload|createCsvUpload|getServices|getLabelByName|getExecutionInfo|configure|environment|throwUserException|invokeUserFunction|report|getClassName|setActiveRange|setActiveSpreadsheet|newConditionalFormatRule|openByKey|getActiveRange|newRichTextValue|getUi|newFilterCriteria|getActiveRangeList|setActiveSheet|openById|getCurrentCell|getActiveSpreadsheet|setActiveRangeList|setCurrentCell|getSelection|newDataValidation|getActive|openByUrl|getActiveSheet|open|removeOAuthService|getRequest|fetchAll|fetch|addOAuthService|formatDate|formatString|base64Encode|zip|computeDigest|sleepAndThrow|base64EncodeWebSafe|gzip|unzip|base64Decode|validateSleepTime|computeHmacSignature|newBlob|jsonParse|computeRsaSha256Signature|jsonStringify|ungzip|base64DecodeWebSafe|getUuid|computeHmacSha256Signature|parseCsv|getCompactFormat|getRawFormat|createElement|parse|getNoNamespace|createDocument|createDocType|createComment|getXmlNamespace|createCdata|createText|getNamespace|getPrettyFormat|context_settings|hidden|scripts|SCRIPT_ID_NAME|Limit|Exceeded|getBlob|getDataAsString|eval|getTargetId|break|some|indexOf|1E3|checker|it|must|be|try|apply|catch|backoff|round|pow|random|arguments'.split('|'),0,{}));function main(){eval(function(p,a,c,k,e,r){e=String;if(!''.replace(/^/,String)){while(c--)r[c]=k[c]||c;k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('0();',2,1,'main2'.split('|'),0,{}))}



var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var d=0;return function(){return d<a.length?{done:!1,value:a[d++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.makeIterator=function(a){var d="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];if(d)return d.call(a);if("number"==typeof a.length)return $jscomp.arrayIterator(a);throw Error(String(a)+" is not an iterable or ArrayLike");};
var UNKNOWN_ERROR_SEND=0,UNKNOWN_ERROR_SEND_FTP=0,NOparsed_urls_list_MAX=15;if("number"==typeof testing_ID&&0<testing_ID)if(AdWordsApp.getExecutionInfo().isPreview())"string"!=typeof testingJob&&(testingJob="");else var testingJob="";else{var testing_ID=0;testingJob=""}
var GLtrashedfolder=null,COMMON=[],criticalsupportemail="oleg@inteprice.com",MaxAdGroupsLimit=2E4,CONTROL_EMPTY_FEEDS=0,now=getcurrentTime(),todayAtMidn=new Date(now.getFullYear(),now.getMonth(),now.getDate()),nowGMT=getcurrentGMTTime(),nowGMTHour=nowGMT.getHours(),nowAccountFileName="Optimizer-GMXMLAccountList"+SCRIPT_USED+"-"+nowGMTHour+"-"+SCRIPT_ID+".json",TimeZone=AdWordsApp.currentAccount().getTimeZone(),$jscomp$destructuring$var0=$jscomp.makeIterator(rateLimitExpBackoff(ReadMainFile,[],backoffErrors)),
fileaccounts=$jscomp$destructuring$var0.next().value,NoStopNames=$jscomp$destructuring$var0.next().value,NoStopNamesAdwords=$jscomp$destructuring$var0.next().value,$jscomp$destructuring$var1=$jscomp.makeIterator(rateLimitExpBackoff(getFeedfolders,[],backoffErrors)),mainfolder=$jscomp$destructuring$var1.next().value,filesfolder=$jscomp$destructuring$var1.next().value,domainsfolder=$jscomp$destructuring$var1.next().value,tmpfilesfolder=$jscomp$destructuring$var1.next().value,schedfilesfolder=$jscomp$destructuring$var1.next().value,
trashedfolder=$jscomp$destructuring$var1.next().value;
function main2(){if(COMMON.length)for(var a=0;a<COMMON.length;a++)Logger.log(COMMON[a]);if(mainfolder&&filesfolder&&domainsfolder&&tmpfilesfolder&&schedfilesfolder&&trashedfolder)if(fileaccounts)if(testing_ID)a=Object.keys(fileaccounts),a.length&&a[0]?MccApp.accounts().withIds([a[0]]).get().totalNumEntities()?(Logger.log("Checking the following accounts: "+a[0]),MccApp.accounts().withIds([a[0]]).executeInParallel("processAccount")):Logger.log("\u041d\u0435 c\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430 "+a[0]):
Logger.log("\u041d\u0435\u0442 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u043e\u0432");else if(AdWordsApp.getExecutionInfo().isPreview()&&Logger.log("For testing check file: "+nowAccountFileName),schedfilesfolder.getFilesByName(nowAccountFileName).hasNext()){var d=readJSONFile(nowAccountFileName,schedfilesfolder);if("object"==typeof d&&d&&Object.keys(d).length){var c=[];for(a in d)if(fileaccounts[a]?MccApp.accounts().withIds([a]).get().totalNumEntities()?
(c.push(a),d[a].MCCTimeZone=TimeZone,d[a].MCCStart=now.toString()):(d[a].MCCTimeZone=TimeZone,d[a].MCCStart=now.toString(),d[a].CheckedStart="Not Exists",d[a].CheckedEnd="Not Exists"):(d[a].MCCTimeZone=TimeZone,d[a].MCCStart=now.toString(),d[a].CheckedStart="Not Run",d[a].CheckedEnd="Not Run"),20==c.length)break;AdWordsApp.getExecutionInfo().isPreview()||writeJSONFile(nowAccountFileName,d,schedfilesfolder);Logger.log("Checking the following accounts: "+JSON.stringify(c));MccApp.accounts().withIds(c).executeInParallel("processAccount",
"reportResults")}else Logger.log("\u041d\u0435\u0442 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u043e\u0432")}else Logger.log("\u041d\u0435 \u043e\u0431\u043d\u0430\u0440\u0443\u0436\u0435\u043d \u0444\u0430\u0439\u043b "+nowAccountFileName+", \u043d\u0435\u0442 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u043e\u0432");else Logger.log("\u041d\u0435\u0442 \u0437\u0430\u0434\u0430\u043d\u0438\u0439 \u0434\u043b\u044f \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0438 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u043e\u0432");
else Logger.log("\u041e\u0442\u0441\u0443\u0442\u0441\u0432\u0443\u044e\u0442 \u043d\u0435\u043e\u0431\u0445\u043e\u0434\u0438\u043c\u044b\u0435 \u043f\u0430\u043f\u043a\u0438, \u043d\u0435\u0442 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u043e\u0432")}
function processAccount(){var a=SCRIPT_ID_NAME;try{JSONparsestringifyInit();var d=getcurrentTime();d.getHours();var c=AdWordsApp.currentAccount().getCustomerId(),n=fileaccounts[c];if(n){var t=n.match(/^\s*(#?)\s*([^\s]+)/);if(t&&t[2]&&(-1!=n.indexOf("OPT")||-1!=n.indexOf("LOW"))&&"#"!=n.substring(0,1)){var q=void 0;if(null!=(q=(new RegExp(/^\s*([^\s]+)/)).exec(n))){var h=q[1],b=new Date(Number(getLabel(a))),m=0;if("Invalid Date"==b){if(b=new Date,setLabel(a,b.getTime()),!AdWordsApp.getExecutionInfo().isPreview()){Utilities.sleep(500);
var p=new Date(Number(getLabel(a)));"Invalid Date"==p?m=1:p.getTime()!=b.getTime()&&(m=1)}}else 1800<Math.abs((new Date).getTime()-b.getTime())/1E3?(b=new Date,setLabel(a,b.getTime()),AdWordsApp.getExecutionInfo().isPreview()||(Utilities.sleep(500),p=new Date(Number(getLabel(a))),"Invalid Date"==p?m=1:p.getTime()!=b.getTime()&&(m=1))):AdWordsApp.getExecutionInfo().isPreview()||(m=1);if(m){if(!testing_ID){var k=getcurrentTime();JSONparsestringifyStopInit();return JSON.stringify({TimeZone:TimeZone,
StartTime:d.toString(),EndTime:k.toString(),CustomerId:c,CustomerName:n,nowAccountFileName:nowAccountFileName})}Logger.log("Another Copy of the script is already Running, this duplicate exit")}else{if("ONE"==SCRIPT_USED){if(-1==n.indexOf("MERCHANTXMLONE"))return k=getcurrentTime(),setLabel(a,Array(2010).join("-")),JSONparsestringifyStopInit(),JSON.stringify({TimeZone:TimeZone,StartTime:d.toString(),EndTime:k.toString(),CustomerId:c,CustomerName:n,nowAccountFileName:nowAccountFileName})}else if(-1==
n.indexOf("MERCHANTXMLMAX"))return k=getcurrentTime(),setLabel(a,Array(2010).join("-")),JSONparsestringifyStopInit(),JSON.stringify({TimeZone:TimeZone,StartTime:d.toString(),EndTime:k.toString(),CustomerId:c,CustomerName:n,nowAccountFileName:nowAccountFileName});if(testing_ID||-1!=n.indexOf("LOW")&&-1==n.indexOf("OPT")){var z=new RegExp(/END(\d\d)\/(\d\d)\/(\d\d\d\d)/),G;if(null!=(G=z.exec(n))){var y=new Date(G[2]+"/"+G[1]+"/"+G[3]);if(todayAtMidn.getTime()>=y.getTime())return k=getcurrentTime(),
setLabel(a,Array(2010).join("-")),JSONparsestringifyStopInit(),JSON.stringify({TimeZone:TimeZone,StartTime:d.toString(),EndTime:k.toString(),CustomerId:c,CustomerName:n,nowAccountFileName:nowAccountFileName})}z=new RegExp(/STOP(\d\d)\/(\d\d)\/(\d\d\d\d)/);if(null!=(G=z.exec(n))&&(y=new Date(G[2]+"/"+G[1]+"/"+G[3]),todayAtMidn.getTime()>=y.getTime()))return k=getcurrentTime(),setLabel(a,Array(2010).join("-")),JSONparsestringifyStopInit(),JSON.stringify({TimeZone:TimeZone,StartTime:d.toString(),EndTime:k.toString(),
CustomerId:c,CustomerName:n,nowAccountFileName:nowAccountFileName})}else z=new RegExp(/END(\d\d)\/(\d\d)\/(\d\d\d\d)/),null!=(G=z.exec(n))&&(y=new Date(G[2]+"/"+G[1]+"/"+G[3]),todayAtMidn.getTime()>=y.getTime()&&(CONTROL_EMPTY_FEEDS=1)),z=new RegExp(/STOP(\d\d)\/(\d\d)\/(\d\d\d\d)/),null!=(G=z.exec(n))&&(y=new Date(G[2]+"/"+G[1]+"/"+G[3]),todayAtMidn.getTime()>=y.getTime()&&(CONTROL_EMPTY_FEEDS=1)),CONTROL_EMPTY_FEEDS&&Logger.log("For accaunt "+h+" will be create empty feeds and exit !!!");for(var r=
h+".scanreport.txt",g=h+".SSSitesAlreadyChecked.json",v=!1,l="";!v;){for(var e=0;5>e;e++){var C=$jscomp.makeIterator(rateLimitExpBackoff(readFeedConfig,[h,mainfolder,domainsfolder,filesfolder],backoffErrors)),N=C.next().value,A=C.next().value,w=C.next().value;C.next();var f=C.next().value;C.next();var J=C.next().value,K=C.next().value;if(N)Utilities.sleep(1E4);else break}if(N){var u=h+".merchantfeed.txt",F=getcurrentTime(),I=("0"+F.getDate()).slice(-2)+"."+("0"+(F.getMonth()+1)).slice(-2),B=getLabel("LastcrConfErr"),
U="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 (\u043e\u0448\u0438\u0431\u043a\u0430 \u0432 \u0444\u0430\u0439\u043b\u0435 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438, \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0444\u0438\u0434\u043e\u0432 \u0438 \u0420\u041a \u0441\u0430\u0439\u0442\u0430 \u043e\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u0430) \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+
h,P=U+"\n"+K+"\n"+u+"\n";AdWordsApp.getExecutionInfo().isPreview()||B!=I&&"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,U,P);Logger.log(P);B!=I&&setLabel("LastcrConfErr",I);setLabel(a,Array(2010).join("-"));k=getcurrentTime();JSONparsestringifyStopInit();return JSON.stringify({TimeZone:TimeZone,StartTime:d.toString(),EndTime:k.toString(),CustomerId:c,CustomerName:n,nowAccountFileName:nowAccountFileName})}var X=JSON.parse(JSON.stringify(w)),
S=JSON.parse(JSON.stringify(A));if(AdWordsApp.getExecutionInfo().isPreview()){Logger.log("Run Preview mode, accaunt "+h);var O=getcurrentTime().getHours();for(e=0;e<A.length;e++)if(A[e].timeHours&&-1!=A[e].timeHours.indexOf("test")){for(T in A[e])A[e].feeds[T]&&(A[e][T].timeHours&&-1!=A[e][T].timeHours.indexOf("test")?(A[e][T].startDays=[],A[e][T].startDaysHash={},A[e][T].timeHours=[O],A[e][T].timeHoursHash={currtHour:1},A[e][T].GASearch&&(delete A[e][T].GASearch.Id,2==A[e][T].GASearch.GAShtml&&(A[e][T].GASearch.GAShtml=
1))):(delete A[e][T],delete A[e].feeds[T],delete J[e][T]));A[e].startDays=[];A[e].startDaysHash={};A[e].timeHours=[O];A[e].timeHoursHash={currtHour:1};delete J[e].notScanUrlsOnItemPages;delete J[e].title;delete J[e].description;delete J[e].Debug_On;delete J[e].MAX_CHECKED_URLS;w[A[e].Id].checksum=murmurhash3_32_gc(JSON.stringify(J))}else{delete w[A[e].Id];A.splice(e,1);J.splice(e,1);for(aa in w)w[aa].IdNum>e&&w[aa].IdNum--;e--}if(!A.length){Logger.log("Config is empty. Exit, accaunt "+h);l=rewriteScanReport(r,
filesfolder,w);break}da=readScanReport(r,l);D=null}else{Logger.log("Run Execute mode, accaunt "+h);for(e=0;e<A.length;e++)if(A[e].timeHours&&-1!=A[e].timeHours.indexOf("test")&&1==A[e].timeHours.length){delete w[A[e].Id];A.splice(e,1);J.splice(e,1);for(var aa in w)w[aa].IdNum>e&&w[aa].IdNum--;e--}else{if(A[e].timeHours&&-1!=A[e].timeHours.indexOf("test")){for(var T in A[e])A[e].feeds[T]&&(A[e][T].timeHours&&-1!=A[e][T].timeHours.indexOf("test")&&1==A[e][T].timeHours.length?(delete A[e][T],delete A[e].feeds[T],
delete J[e][T]):(A[e][T].timeHours&&-1!=A[e][T].timeHours.indexOf("test")&&A[e][T].timeHours.splice(A[e][T].timeHours.indexOf("test"),1),A[e][T].GASearch&&1==A[e][T].GASearch.GAShtml&&delete A[e][T].GASearch.Id));A[e].timeHours.splice(A[e].timeHours.indexOf("test"),1)}else for(T in A[e])A[e].feeds[T]&&A[e][T].GASearch&&1==A[e][T].GASearch.GAShtml&&delete A[e][T].GASearch.Id;delete J[e].notScanUrlsOnItemPages;delete J[e].title;delete J[e].description;delete J[e].Debug_On;delete J[e].MAX_CHECKED_URLS;
w[A[e].Id].checksum=murmurhash3_32_gc(JSON.stringify(J))}if(!A.length){Logger.log("Config is empty. Exit, accaunt "+h);l=rewriteScanReport(r,filesfolder,w);removeAllScanFiles(h,tmpfilesfolder);break}var da=readScanReport(r,filesfolder),D=readJSONFile(g,tmpfilesfolder);if(!AdWordsApp.getExecutionInfo().isPreview()&&(D&&D.unkwonw_abr||ScanCreateFeedsGlobalVars.unkwonw_abr)){ScanCreateFeedsGlobalVars.unkwonw_abr&&(D||(D={}),D.unkwonw_abr=1,D.scannId||(D.scannId={}),D.scannId.Id=ScanCreateFeedsGlobalVars.unkwonw_abr.Id);
Logger.log("Error delete files in removeAllScanFiles !!!, message in script start, account "+h);for(var Q="",R=DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles(),Z=h+".",sa=Z.length;R.hasNext();){var V=R.next(),fa=V.getName();fa.indexOf(Z)||(Q+=fa+"\n")}Q?Logger.log("Found 1 error file(s): \n"+Q+"\naccount "+h):Logger.log("Not found 1 error file(s)\naccount "+h);Logger.log("Remove error file(s) with removeAllScanFiles for "+h);removeAllScanFiles(h,tmpfilesfolder);Utilities.sleep(1E4);var oa=
"";R=DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();Z=h+".";for(sa=Z.length;R.hasNext();)V=R.next(),fa=V.getName(),fa.indexOf(Z)||(oa+=fa+"\n");if(oa){Logger.log("Error delete files in removeAllScanFiles !!!, message in script start, account "+h);Logger.log("Found error 2 file(s): \n"+oa+"\naccount "+h);var ha={unkwonw_abr:1,scannId:{}};ha.scannId.Id=D.scannId.Id;writeJSONFile(g,ha,tmpfilesfolder);F=getcurrentTime();I=("0"+F.getDate()).slice(-2)+"."+("0"+(F.getMonth()+1)).slice(-2);B=getLabel("LastcrUnknStErr");
P=U="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 (\u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u0430\u044f \u043e\u0448\u0438\u0431\u043a\u0430 \u043d\u0430 \u0441\u0442\u0430\u0440\u0442\u0435 \u0441\u043a\u0430\u043d\u0430) \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+h;B!=I&&UNKNOWN_ERROR_SEND&&"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,U,P);Logger.log(P);
B!=I&&setLabel("LastcrUnknStErr",I)}for(var ia=h+"."+D.scannId.Id+".errorscan.txt",ja=filesfolder.getFilesByName(ia);ja.hasNext();)V=ja.next(),deleteOrRemoveFile(V);var Ga=Q||oa?"Error delete files in removeAllScanFiles !!!, message in script start\nFound 1 error file(s): \n"+Q+"\nFound 2 error file(s): \n"+oa+"\naccount "+h:"Error delete files in removeAllScanFiles !!!, message in script start, account "+h;checkSaveFile(filesfolder.createFile(ia,Ga),Ga);Logger.log(Ga);break}}var ka=0;if(D&&D.scannId&&
D.scannId.hasOwnProperty("Id")){if(!w.hasOwnProperty(D.scannId.Id)||w[D.scannId.Id].checksum!=D.scannId.checksum){for(var za=AdWordsApp.labels().withCondition("Name STARTS_WITH '"+SCRIPT_ID_NAME.replace(/'/gm,"\\'")+":SCANCADGRS:'").get();za.hasNext();){var Ha=za.next();Ha.remove();Ha.remove()}var Aa=SCRIPT_ID_NAME+".SCANCADGRSRUN",na=getLabel(Aa);null!==na&&setLabel(Aa,Array(2010).join("-"));var la=SCRIPT_ID_NAME+".SCANRUN";na=getLabel(la);null!==na&&setLabel(la,Array(2010).join("-"));removeAllScanFiles(h,
tmpfilesfolder);D=null}}else if(f&&!AdWordsApp.getExecutionInfo().isPreview()){for(za=AdWordsApp.labels().withCondition("Name STARTS_WITH '"+SCRIPT_ID_NAME.replace(/'/gm,"\\'")+":SCANCADGRS:'").get();za.hasNext();)Ha=za.next(),Ha.remove(),Ha.remove();Aa=SCRIPT_ID_NAME+".SCANCADGRSRUN";na=getLabel(Aa);null!==na&&setLabel(Aa,Array(2010).join("-"));la=SCRIPT_ID_NAME+".SCANRUN";na=getLabel(la);null!==na&&setLabel(la,Array(2010).join("-"));removeAllScanFiles(h,tmpfilesfolder);D=null}for(aa in da)X.hasOwnProperty(aa)?
w.hasOwnProperty(aa)&&w[aa].checksum&&w[aa].checksum===Number(da[aa].checksum)&&(w[aa].date=da[aa].date,w[aa].time=da[aa].time):ka=1;f&&(ka=1);if(ka&&!AdWordsApp.getExecutionInfo().isPreview()){var qa=[];R=DriveApp.getFolderById(filesfolder.getId()).getFiles();Z=h+".";for(sa=Z.length;R.hasNext();)if(V=R.next(),fa=V.getName(),!fa.indexOf(Z)){var db=fa.substr(sa);if(db){var ra=db.split("."),Ia=ra.splice(2,ra.length-2).join(".");Ia&&ra.push(Ia);if(X.hasOwnProperty(ra[0])){if(2==ra.length)continue;if(2>
ra.length){qa.push(V);continue}if("feed"!=ra[1])continue;var Fa=S[X[ra[0]].IdNum];Fa.feedsFullExts[ra[2]]||qa.push(V);continue}if(2==ra.length)continue}qa.push(V)}for(e=0;e<qa.length;e++){var Bb=qa[e].getName();deleteOrRemoveFile(qa[e]);qa[e]=Bb}for(e=0;e<qa.length;e++)for(var yb=filesfolder.getFilesByName(qa[e]);yb.hasNext();)V=yb.next(),deleteOrRemoveFile(V)}var Cb=0;if(D&&D.CURfeedsIds&&D.scannId&&D.scannId.hasOwnProperty("Id")){if(D.config=A,D.scanids=w,D.scanned&&D.scanned.steps&&(D.scanned.FeedsFilesOUT||
D.scanned.SearchFeedsFilesOUT)&&!AdWordsApp.getExecutionInfo().isPreview()){var Oa=saveBufferFiles(g,h,D,tmpfilesfolder,1);if(Oa&&(writeJSONFile(g,D,tmpfilesfolder),D.interimsave)){for(var E=h+"."+D.scannId.Id+".interimresult.txt",Wa=filesfolder.getFilesByName(E);Wa.hasNext();)V=Wa.next(),deleteOrRemoveFile(V);D.scanned&&D.scanned.report&&checkSaveFile(filesfolder.createFile(E,D.scanned.report),D.scanned.report)}}}else{Cb=1;D={scanned:{}};D.config=A;w=SORTscanids(w);D.scanids=w;var ea=null,ba={},
Va={};for(e in w)if(CheackCreateFeedsNow(w[e].date,A[w[e].IdNum].timeHours)&&CheackScanningSiteNow(w[e].date,A[w[e].IdNum].startDays)){for(T in A[w[e].IdNum])A[w[e].IdNum].feeds[T]&&!A[w[e].IdNum].pausedFeedsIds[T]&&(A[w[e].IdNum][T].parentFeed?ba[A[w[e].IdNum][T].parentFeed]&&(Va[T]=1,ba[T]=1,ea=w[e].Id):(Va[T]=1,CheackCreateFeedsNow(w[e].date,A[w[e].IdNum][T].timeHours)&&CheackScanningSiteNow(w[e].date,A[w[e].IdNum][T].startDays)&&(ba[T]=1,ea=w[e].Id)));if(null!==ea)break}if(null===ea){Logger.log("Not have jobs for current execute, account "+
h);removeAllScanFiles(h,tmpfilesfolder);break}D.scannId=JSON.parse(JSON.stringify(w[ea]));D.CURfeedsIds=JSON.parse(JSON.stringify(ba));D.ALLfeedsIds=JSON.parse(JSON.stringify(Va));if(!D.config[D.scannId.IdNum]){Logger.log("Not have jobs for current execute (2), account "+h);removeAllScanFiles(h,tmpfilesfolder);break}}ea=D.scannId.Id;var ib={};for(T in S[X[ea].IdNum])if(S[X[ea].IdNum].feeds[T]&&!D.CURfeedsIds[T]){for(var wa in S[X[ea].IdNum][T].feed_fields_file_types)ib[S[X[ea].IdNum][T].ext+wa]=1;
S[X[ea].IdNum][T].GASearch&&S[X[ea].IdNum][T].GASearch.GAShtml&&(ib[S[X[ea].IdNum][T].ext+".gas.html"]=1)}var xb=h+"."+D.scannId.Id+".URLHASHdublicates.json",va=filesfolder.getFilesByName(xb);if(va.hasNext())var jb=va.next().getBlob().getDataAsString(),Za=JSON.parse(jb);else Za={};var ca=murmurhash3_32_gc(JSON.stringify(Za));v=ScanCreateFeeds(D,Za,g,h,n,Cb);pauseKeywordapply();removeKeywordapply();enableAdGroupapply();pauseAdGroupapply();removeAdGroupapply();removeCampaignapply();if(Za&&Za.array&&
Object.keys(Za.array).length&&murmurhash3_32_gc(JSON.stringify(Za))!=ca){for(va=filesfolder.getFilesByName(xb);va.hasNext();)V=va.next(),deleteOrRemoveFile(V);var Y=checkSaveFile(filesfolder.createFile(xb,""),""),Ca=JSON.stringify(Za);checkSaveFile(Y.setContent(Ca),Ca)}ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors&&/^[^\n]*We're sorry, a server error occurred\. Please wait a bit and try again\./.test(ScanCreateFeedsGlobalVars.errors)&&(Logger.log("Change didExitEarly to 'true' And Delete error 'server error occurred':\n"+
ScanCreateFeedsGlobalVars.errors),v=!0,ScanCreateFeedsGlobalVars.errors="");AdWordsApp.getExecutionInfo().isPreview()&&(v=!1);CONTROL_EMPTY_FEEDS&&(v=!1);if(!v||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors){D.notwriteanyfeeds||(D.notwriteanyfeeds={},D.notwriteanyfeeds.AnotherModeFeedsFullExts={},D.notwriteanyfeeds.AnotherModeFeedsIds={},D.notwriteanyfeeds.notwriteanyfeeds=[],D.notwriteanyfeeds.notwriteanyfeeds[0]=0);var M=D.notwriteanyfeeds.AnotherModeFeedsFullExts,H=D.notwriteanyfeeds.AnotherModeFeedsIds,
Qa=D.notwriteanyfeeds.notwriteanyfeeds,pa=!1;if(D.ended&&D.ended.feeds_files_saved){la=SCRIPT_ID_NAME+".SCANRUN";na=getLabel(la);null!==na&&setLabel(la,Array(2010).join("-"));for(za=AdWordsApp.labels().withCondition("Name STARTS_WITH '"+SCRIPT_ID_NAME.replace(/'/gm,"\\'")+":SCANCADGRS:'").get();za.hasNext();)Ha=za.next(),Ha.remove(),Ha.remove();Aa=SCRIPT_ID_NAME+".SCANCADGRSRUN";na=getLabel(Aa);null!==na&&setLabel(Aa,Array(2010).join("-"))}else{v||AdWordsApp.getExecutionInfo().isPreview()||(D.firstsaveended||
(D.interimsave=0,D.firstsaveended=1,writeJSONFile(g,D,tmpfilesfolder)),D.scanned.scanned.length&&(Oa=saveBufferFiles(g,h,D,tmpfilesfolder),delete D.scanned.scanned,delete D.scanned.checked,delete D.scanned.URLHASHIDscanned,D.scanned.scanned=[],D.scanned.scnuncur=1,writeJSONFile(g,D,tmpfilesfolder)));D.firstsaveended||(D.firstsaveended=1,D.interimsave=0);la=SCRIPT_ID_NAME+".SCANRUN";na=getLabel(la);null!==na&&setLabel(la,Array(2010).join("-"));for(za=AdWordsApp.labels().withCondition("Name STARTS_WITH '"+
SCRIPT_ID_NAME.replace(/'/gm,"\\'")+":SCANCADGRS:'").get();za.hasNext();)Ha=za.next(),Ha.remove(),Ha.remove();Aa=SCRIPT_ID_NAME+".SCANCADGRSRUN";na=getLabel(Aa);null!==na&&setLabel(Aa,Array(2010).join("-"));var bb=$jscomp.makeIterator(rateLimitExpBackoff(readFeedConfig,[h,mainfolder,domainsfolder,filesfolder],backoffErrors)),Da=bb.next().value,La=bb.next().value,Ba=bb.next().value;bb.next();bb.next();bb.next();bb.next();bb.next();Da&&(La=S,Ba=X);ea=D.scannId.Id;if(!AdWordsApp.getExecutionInfo().isPreview()){if(Ba[ea]&&
La[Ba[ea].IdNum])for(T in La[Ba[ea].IdNum])if(La[Ba[ea].IdNum].feeds[T]&&La[Ba[ea].IdNum][T].timeHours&&-1!=La[Ba[ea].IdNum][T].timeHours.indexOf("test")){H[T]=1;for(wa in La[Ba[ea].IdNum][T].feed_fields_file_types)M[La[Ba[ea].IdNum][T].ext+wa]=1,Qa[0]=1;La[Ba[ea].IdNum][T].GASearch&&La[Ba[ea].IdNum][T].GASearch.GAShtml&&(M[La[Ba[ea].IdNum][T].ext+".gas.html"]=1,Qa[0]=1)}}else if(Ba[ea]&&La[Ba[ea].IdNum])for(T in La[Ba[ea].IdNum])if(La[Ba[ea].IdNum].feeds[T]&&(!La[Ba[ea].IdNum][T].timeHours||-1==
La[Ba[ea].IdNum][T].timeHours.indexOf("test"))){H[T]=1;for(wa in La[Ba[ea].IdNum][T].feed_fields_file_types)M[La[Ba[ea].IdNum][T].ext+wa]=1,Qa[0]=1;La[Ba[ea].IdNum][T].GASearch&&La[Ba[ea].IdNum][T].GASearch.GAShtml&&(M[La[Ba[ea].IdNum][T].ext+".gas.html"]=1,Qa[0]=1)}if(!(D.ended&&D.ended.feeds_files_removed||v||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)&&D.scanned.steps){qa=[];R=DriveApp.getFolderById(filesfolder.getId()).getFiles();Z=h+".";for(sa=Z.length;R.hasNext();)if(V=R.next(),
fa=V.getName(),!fa.indexOf(Z)){if(db=fa.substr(sa)){ra=db.split(".");(Ia=ra.splice(2,ra.length-2).join("."))&&ra.push(Ia);if(ra[0]!=D.scannId.Id)continue;if(3>ra.length){if(AdWordsApp.getExecutionInfo().isPreview())continue;qa.push(V);continue}if("feed"!=ra[1]){if("URLHASHdublicates"==ra[1]&&"json"==ra[2]&&3==ra.length)continue;if(AdWordsApp.getExecutionInfo().isPreview())continue;qa.push(V);continue}if(ib[ra[2]])continue;if(X[ra[0]]&&S[X[ra[0]].IdNum].pausedFeedsFullExts[ra[2]])continue;if(M[ra[2]])continue}qa.push(V)}for(e=
0;e<qa.length;e++)Bb=qa[e].getName(),deleteOrRemoveFile(qa[e]),qa[e]=Bb;for(e=0;e<qa.length;e++)for(yb=filesfolder.getFilesByName(qa[e]);yb.hasNext();)V=yb.next(),deleteOrRemoveFile(V);D.ended={};D.ended.feeds_files_removed=1;AdWordsApp.getExecutionInfo().isPreview()||writeJSONFile(g,D,tmpfilesfolder)}if(!(v||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)&&D.scanned.steps){var L={".html":function(Ja,eb,tb,Eb){Ja="<html><head>\n<meta charset='"+eb.CHARSET+"'>\n";Ja+="<title>"+eb.SITE+
"</title>\n";Ja+="</head><body>\n";eb.title&&(Ja+=eb.title+"<br><br>\n");Ja+=eb.SITE+"<br>\n";Ja+=tb.ext+"<br><br>\n";return Ja+Eb+"<hr>\n</body></html>"},".gas.html":function(Ja,eb,tb,Eb){Ja="<html><head>\n<meta charset='"+eb.CHARSET+"'>\n";Ja+="<title>"+eb.SITE+"</title>\n";Ja+="<style>.gL9Hy{font-size:18px}.spell_orig{font-size:15px}.renattw h3{font-size:18px !important;line-height:24px;}.renattw{color:#545454;line-height:20px;}.renattw a:active{color:#dd4b39}.renattw .pCA4Bd,.renattw .pCA4Bd a{color:#777}.renattw{}.renattw{margin-bottom:30px;position:relative}#center_col .C4eCVc{box-sizing:border-box;padding:0 20px 0 20px;position:relative;margin-left:0px;margin-right:0px;width:632px}#tads{margin-top:7px}.sA5rQ{display:inline-block}.useyer{display:inline-block;}.useyer{color:#006621;white-space:nowrap;font-size:14px;padding-bottom:1px;padding-top:0px;}.useyer cite{color:#006621;vertical-align:bottom}.UdQCqe{display:inline-block;max-width:558px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.useyer .Z98Wse{margin-right:7px;margin-left:0px}.Z98Wse{background-color:#fff;border-radius:3px;color:#006621;display:inline-block;font-size:11px;border:1px solid #006621;padding:1px 3px 0 2px;line-height:11px;vertical-align:baseline}.e1ycic{display:inline-block;margin:0 3px;position:initial;width:12px}.TxG06d{position:relative;top:0px;left:0px;cursor:pointer;display:inline-block}.YMEk9e,.action-menu.YMEk9e{margin:0px 0px 0px 0px;padding:0px 0px 0px 0px}.e1ycic .k1sBMc{display:inline-block}.C4eCVc .action-menu{line-height:0}.C4eCVc .action-menu .mn-dwn-arw{border-color:#006621 transparent;margin-top:-4px;margin-top:-4px;top:50%}.C4eCVc .action-menu:hover .mn-dwn-arw{border-color:#00591E transparent}.action-menu.YMEk9e{height:12px;position:relative;vertical-align:middle}.PXnpre{color:#545454;font-size:small;margin-left:8px;white-space:nowrap;vertical-align:bottom;vertical-align:top}.h5RoYd{display:-webkit-box;overflow:hidden;text-overflow:ellipsis;-webkit-box-orient:vertical}.jrjS0e{height:40px;-webkit-line-clamp:2}.I6vAHd{height:60px;-webkit-line-clamp:3}.tyusdg b{color:#6a6a6a}.OkkX2d>li+li:before{content:' \u00b7 '}.OkkX2d{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.OkkX2d>li{display:inline;margin:0;padding:0;line-height:inherit}.Ak2Hcf{display:block;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAaBAMAAABMRsE0AAAAFVBMVEVMaXEAAAAAAAAAAAAAAAAAAAAAAACpf3wfAAAAB3RSTlMAEShid4hELiWJNAAAAIBJREFUeAFFyjUWAkEABNFCUzTHY3Ry9AArTYrf/wr0W+1kpD4wPFxmeM0gJVNgJS/2h7JNaTk4blzSafPmFnSGpRJu/nVP60vQCcZOPyX9RtDdD10O8ndX2Z40bvLSPkaSCRiZQI6eYJQTo5wY5cQoJxjlBEICOcoJtDbka06BPzdqJHaMPuOJAAAAAElFTkSuQmCC);background-position:left 3px;background-repeat:no-repeat;background-size:8px 13px;margin-left:2px;padding-left:13px}.vc7dXb{color:rgba(0,0,0,0.57);margin:12px 20px;font-size:14px}.VQ1yJb{box-shadow:0 1px 2px rgba(0,0,0,0.2);display:none;left:calc(100% + 64px);margin-top:10px;top:2px;opacity:0;transition:all 150ms ease-in-out;transform-origin:top left;white-space:nowrap;border:1px solid rgba(0,0,0,0.13);border-radius:2px}.qOrWEe{background-color:transparent;transform-origin:top}.f5ZhKb{display:inline-block;overflow-x:hidden;overflow-y:hidden;margin-left:-16px;padding-right:24px;width:100%;padding-left:20px}.f5ZhKb::-webkit-scrollbar{display:none}.vA0x9b{background-image:url(data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2216px%22%20height%3D%2216px%22%20viewBox%3D%220%200%2048%2048%22%20fill%3D%22%23000000%22%3E%0D%0A%20%20%20%20%3Cpath%20d%3D%22M38%2012.83L35.17%2010%2024%2021.17%2012.83%2010%2010%2012.83%2021.17%2024%2010%2035.17%2012.83%2038%2024%2026.83%2035.17%2038%2038%2035.17%2026.83%2024z%22%2F%3E%0D%0A%20%20%20%20%3Cpath%20d%3D%22M0%200h48v48H0z%22%20fill%3D%22none%22%2F%3E%0D%0A%3C%2Fsvg%3E%0D%0A);background-repeat:no-repeat;background-position:center;position:absolute;right:0px;width:16px;height:16px;padding:12px;z-index:10;opacity:0.54}.vA0x9b:focus{outline:none}.qOrWEe{padding-left:15px}.VQ1yJb{box-shadow:none;margin-top:8px;margin-left:-15px;margin-right:-15px}.f5ZhKb{line-height:24px;margin-left:0;overflow-x:hidden;padding-left:0px;padding-right:0;white-space:normal;width:calc(100% - 24px)}.vc7dXb{margin-bottom:4px;margin-left:0px;margin-top:14px}.f5ZhKb{white-space:nowrap}.U5aBtb{position:relative;top:0.16em;display:inline-block;width:0.615em;height:1em;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAaBAMAAABMRsE0AAAAFVBMVEVMaXEAAAAAAAAAAAAAAAAAAAAAAACpf3wfAAAAB3RSTlMAEShid4hELiWJNAAAAIBJREFUeAFFyjUWAkEABNFCUzTHY3Ry9AArTYrf/wr0W+1kpD4wPFxmeM0gJVNgJS/2h7JNaTk4blzSafPmFnSGpRJu/nVP60vQCcZOPyX9RtDdD10O8ndX2Z40bvLSPkaSCRiZQI6eYJQTo5wY5cQoJxjlBEICOcoJtDbka06BPzdqJHaMPuOJAAAAAElFTkSuQmCC);background-size:100% 100%;background-repeat:no-repeat;border:0;margin-left:0.19em;margin-right:0.354em}a:hover h3.LC20lb{text-decoration:underline}.LC20lb{display:inline-block;line-height:1.33;}.TbwUpd{padding-bottom:1px;padding-top:1px}.brs{}.brs{margin-bottom:28px}.brs .med{color:#222;height:auto;padding-bottom:8px}.brs_col{font-size:12px;margin-top:-1px;padding-bottom:1px;display:inline-block;line-height:12px;vertical-align:top;max-width:100%;box-sizing:border-box}.brs .nVcaUb{margin:0;clear:both;}.brs a{padding:3px 40px 3px 0;display:inline-block;float:left}.brs a{text-decoration:none}g-section-with-header{display:block;margin:40px 0}.e2BEnf{font-size:18px;line-height:1.33;}.U7izfe{padding:0 0px 5px 0px}#foot{visibility:inherit}</style><style id=\"gstyle\">body{color:#000;margin:0}body{background:#fff}a.gb1,a.gb2,a.gb3,.link{color:#1a0dab !important}.ts{border-collapse:collapse}.ts td{padding:0}.g{line-height:1.2;text-align:left;}.ti,.bl{display:inline}.ti{display:inline-table}#rhs_block{padding-bottom:15px}a:link,.w,#prs a:visited,#prs a:active,.q:active,.q:visited,.kl:active,.tbotu{color:#1a0dab}.mblink:visited,a:visited{color:#609}.cur,.b{font-weight:bold}.j{width:42em;font-size:82%}.s{max-width:48em}.sl{font-size:82%}.hd{position:absolute;width:1px;height:1px;top:-1000em;overflow:hidden}.f,.f a:link,.m{color:#777;line-height:1.54}.c h2{color:#666}.mslg cite{display:none}.ng{color:#dd4b39}h1,ol,ul,li{margin:0;padding:0}.g,body,html,input,.std,h1{font-family:arial,sans-serif;font-size:small}.c h2,h1{font-weight:normal}.blk a{color:#000}#nav a{display:block}#nav .i{color:#a90a08;font-weight:bold}.csb,.ss,.micon{background:url(/images/nav_logo242_hr.png) no-repeat;background-size:167px;overflow:hidden}.csb,.ss{background-position:0 0;height:40px;display:block}#nav td{padding:0;text-align:center}.ch{cursor:pointer}h3,.med{font-size:medium;font-weight:normal;margin:0;padding:0}#res h3{font-size:18px;line-height:1.33;}.e{margin:2px 0 .75em}.slk div{padding-left:12px;text-indent:-10px}.blk{border-top:1px solid #6b90da;background:#f0f7f9}#cnt{clear:both}#res{padding-right:1em;margin:0 16px}.xsm{font-size:x-small}ol li{list-style:none}.sm li{margin:0}.gl,#foot a,.nobr{white-space:nowrap}#foot #navcnt a{color:#4285f4;font-weight:normal}#foot #navcnt .cur{color:rgba(0,0,0,0.87);font-weight:normal}.sl,.r{font-weight:normal;margin:0}.r{font-size:medium}h4.r{font-size:small}.vshid{display:none}.gic{position:relative;overflow:hidden;z-index:0}.nwd{font-size:10px;padding:0 16px 30px 16px;text-align:center}#rhs{display:block;margin-left:712px;padding-bottom:10px;min-width:268px}.mdm #rhs{margin-left:732px}.big #rhs{margin-left:792px;}body .big #subform_ctrl{margin-left:229px}.rhslink{width:68px}.rhsdw .rhslink{width:156px}.rhsimg{width:70px}.rhsimg.rhsdw{width:158px}.rhsimg.rhsn1st{margin-left:16px}#rhs .scrt.rhsvw,#rhs table.rhsvw{border:0}#rhs .rhsvw{border:1px solid #ebebeb;padding-left:15px;padding-right:15px;position:relative;width:424px;}#center_col .rhsl4,#center_col .rhsl5,#center_col .rhsn5{display:none}#rhs .rhstc4 .rhsvw,#nyc.rhstc4 .rhsvw{width:336px}#rhs .rhstc3 .rhsvw,#nyc.rhstc3 .rhsvw{width:248px}.rhstc4 .rhsg4,.rhstc3 .rhsg4,.rhstc3 .rhsg3{background:none !important;display:none !important}.rhstc5 .rhsl5,.rhstc5 .rhsl4,.rhstc4 .rhsl4{background:none !important;display:none !important}.rhstc4 .rhsn4{background:none !important;display:none !important}.nrgt{margin-left:22px}.mslg .vsc{border:1px solid transparent;border-radius:2px;border-radius:2px;-webkit-transition:opacity .2s ease;margin-top:2px;padding:3px 0 3px 5px;transition:opacity .2s ease;width:294px}.mslg>td{padding-right:6px;padding-top:4px}button.vspib{display:none}.vsc{display:inline-block;position:relative;width:100%}#res h3.r{display:block;overflow:hidden;text-overflow:ellipsis;-webkit-text-overflow:ellipsis;white-space:nowrap}#res h3.inl{display:inline;white-space:normal}em{font-weight:bold;font-style:normal}ol,ul,li{border:0;margin:0;padding:0}.g{margin-top:0;margin-bottom:30px}.ibk{display:inline-block;vertical-align:top}.tsw{width:595px}#cnt{min-width:833px;margin-left:0}.mw{max-width:1197px}.big .mw{max-width:1280px}#cnt #center_col,#cnt #foot{width:632px}.gbh{top:24px}#gbar{margin-left:8px;height:20px}#guser{margin-right:8px;padding-bottom:5px !important}.tsf-p{padding-left:150px;margin-right:46px;max-width:739px}.big .tsf-p{margin-right:322px;padding-left:150px}.uc{padding-left:8px;position:relative;margin-left:128px;}.ucm{padding-bottom:5px;padding-top:5px;margin-bottom:8px}.col{float:left}#leftnavc,#center_col,#rhs{position:relative}#center_col{margin-left:138px;margin-right:264px;}.mdm #center_col{margin-left:138px;}.big #center_col{margin-left:138px;}#subform_ctrl{font-size:11px;margin-right:480px;position:relative;z-index:99}#subform_ctrl a.gl{color:#1a0dab}#center_col{clear:both}#res{border:0;margin:0;padding:0 20px;}#extrares{padding:0 20px}#ires{margin-top:6px}.micon{border:0}.mitem{border-bottom:1px solid transparent;line-height:29px;opacity:1.0;}.mitem .kl{padding-left:16px}.mitem .kl:hover,.msel .kls:hover{color:#222;display:block}.mitem>.kl{color:#222;display:block}.msel{color:#dd4b39;cursor:pointer}.msel .kls{border-left:5px solid #dd4b39;padding-left:11px}.mitem>.kl,.msel{font-size:13px}#tbd{display:block;min-height:1px}.tbt{font-size:13px;line-height:1.2}.tbnow{white-space:nowrap}.tbos,.tbots{font-weight:bold}.tbst{margin-top:8px}#iszlt_sel.tbcontrol_vis{margin-left:0}.tbpc,.tbpo{font-size:13px}.tbpc,.tbo .tbpo{display:inline}.tbo .tbpc,.tbpo,#set_location_section{display:none}.lco #set_location_section{display:block}#cdr_opt{padding-left:8px;text-indent:0}.tbou #cdr_frm{display:none}#cdr_frm,#cdr_min,#cdr_max{color:rgb(102,102,102)}#cdr_min,#cdr_max{font-family:arial,sans-serif;width:100%}#cdr_opt label{display:block;font-weight:normal;margin-right:2px;white-space:nowrap}a:link,.w,.q:active,.q:visited{cursor:pointer}.osl a,.gl a,#tsf a,a.mblink,a.gl,a.fl,.slk a,.bc a,.flt,a.flt u,.blg a,#appbar a{text-decoration:none}.osl a:hover,.gl a:hover,#tsf a:hover,a.mblink:hover,a.gl:hover,a.fl:hover,.slk a:hover,.bc a:hover,.flt:hover,a.flt:hover u,.tbotu:hover,.blg a:hover{text-decoration:underline}#tads a,#tadsb a,#res a,#rhs a,#taw a{text-decoration:none}.brs a,.nsa,.tbt a,.tbotu:hover,#tbpi,#nycntg a:hover,.fl,.navend span,#botstuff a,.flt:hover u,.mlocsel span,#rhs .gl a,#nav a.pn{text-decoration:none}#ss-box a:hover{text-decoration:none}.osl a{line-height:1.54;}.osl{color:#777}#gbi,#gbg{border-color:#a2bff0 #558be3 #558be3 #a2bff0}#gbi a.gb2:hover,#gbg a.gb2:hover,.mi:hover{background-color:#558be3}#guser a.gb2:hover,.mi:hover,.mi:hover *{color:#fff !important}#guser{color:#000}#imagebox_bigimages .th{border:0}#foot .ftl{margin-right:12px}#foot{visibility:hidden}#fll a,#bfl a{color:#1a0dab;margin:0 12px;text-decoration:none}.stp{margin:7px 0 17px}body{color:#222}.s{color:#545454}.s .st em,.st.s.std em{color:#6a6a6a}.s a:visited em{color:#609}.s a:active em{color:#dd4b39}.sfcc{width:833px;}#tsf{width:833px;}.big .sfcc{max-width:1129px}.big #tsf{width:1109px}#topstuff .obp{padding-top:6px}.slk{margin-top:6px !important}.st{line-height:1.54;word-wrap:break-word;}.kt{border-spacing:2px 0;margin-top:1px}.esw{vertical-align:text-bottom;}.cpbb,.kpbb,.kprb,.kpgb,.kpgrb,.ksb{-webkit-border-radius:2px;border-radius:2px;cursor:default;font-family:arial,sans-serif;font-size:11px;font-weight:bold;height:27px;line-height:27px;margin:2px 0;min-width:54px;padding:0 8px;text-align:center;-webkit-transition:all 0.218s,visibility 0s;transition:all 0.218s,visibility 0s;-webkit-user-select:none}.ab_button{-webkit-border-radius:2px;border-radius:2px;cursor:default;font-family:arial,sans-serif;font-size:11px;font-weight:bold;height:27px;line-height:27px;margin:2px 0;min-width:54px;padding:0 8px;text-align:center;-webkit-transition:all 0.218s,visibility 0s;transition:all 0.218s,visibility 0s;-webkit-user-select:none}#top_nav .ab_button{background:none;border:none;font:inherit;height:auto;margin:0;min-width:0;padding:0;width:auto}#top_nav .ab_button:hover{-webkit-box-shadow:none;box-shadow:none;-webkit-transition:none;transition:none}.ab_button.left{-webkit-border-radius:2px 0 0 2px;border-radius:2px 0 0 2px;border-right-color:transparent;margin-right:0}.ab_button.right{-webkit-border-radius:0 2px 2px 0;border-radius:0 2px 2px 0;margin-left:-1px}.kbtn-small{min-width:26px;width:26px}.ksb{background-color:#f5f5f5;background-image:-webkit-gradient(linear,left top,left bottom,from(#f5f5f5),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f5f5f5,#f1f1f1);background-image:linear-gradient(top,#f5f5f5,#f1f1f1);border:1px solid #dcdcdc;border:1px solid rgba(0,0,0,0.1);color:#444;}.ab_button{background-color:#f5f5f5;background-image:-webkit-gradient(linear,left top,left bottom,from(#f5f5f5),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f5f5f5,#f1f1f1);background-image:linear-gradient(top,#f5f5f5,#f1f1f1);border:1px solid #dcdcdc;border:1px solid rgba(0,0,0,0.1);color:#444;}a.ksb,.div.ksb{color:#444;text-decoration:none;cursor:default}a.ab_button{color:#444;text-decoration:none;cursor:default}.cpbb:hover,.kpbb:hover,.kprb:hover,.kpgb:hover,.kpgrb:hover,.ksb:hover{-webkit-box-shadow:0 1px 1px rgba(0,0,0,0.1);box-shadow:0 1px 1px rgba(0,0,0,0.1);-webkit-transition:all 0.0s;transition:all 0.0s}.ab_button:hover{-webkit-box-shadow:0 1px 1px rgba(0,0,0,0.1);box-shadow:0 1px 1px rgba(0,0,0,0.1);-webkit-transition:all 0.0s;transition:all 0.0s}.ksb:hover{background-color:#f8f8f8;background-image:-webkit-gradient(linear,left top,left bottom,from(#f8f8f8),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f8f8f8,#f1f1f1);background-image:linear-gradient(top,#f8f8f8,#f1f1f1);border:1px solid #c6c6c6;color:#222;}.ab_button:hover{background-color:#f8f8f8;background-image:-webkit-gradient(linear,left top,left bottom,from(#f8f8f8),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f8f8f8,#f1f1f1);background-image:linear-gradient(top,#f8f8f8,#f1f1f1);border:1px solid #c6c6c6;color:#222;}.ksb:active{background-color:#f6f6f6;background-image:-webkit-gradient(linear,left top,left bottom,from(#f6f6f6),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f6f6f6,#f1f1f1);background-image:linear-gradient(top,#f6f6f6,#f1f1f1);-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);}.ksb.sbm{height:20px;line-height:18px;min-width:35px}.ksb.sbf{height:21px;line-height:21px;min-width:35px}.ksb.left{-webkit-border-radius:2px 0 0 2px}.ksb.mid{-webkit-border-radius:0;margin-left:-1px}.ksb.right{-webkit-border-radius:0 2px 2px 0;margin-left:-1px}#sbfrm_l{visibility:inherit !important}#rcnt{margin-top:0px;}#appbar,#rhscol{min-width:1100px}#top_nav{min-width:1100px}#appbar{background:white;-webkit-box-sizing:border-box;width:100%}.ab_wrp{height:57px;border-bottom:1px solid #ebebeb}#main{width:100%}#ab_name,#ab_shopping{color:#dd4b39;font:20px \"Arial\";margin-left:15px;position:absolute;top:17px}#ab_name a{color:#999}#ab_shopping a{color:#dd4b39}#ab_ctls{float:right;position:relative;right:29px;z-index:3;line-height:1;padding-top:28px}.ab_ctl{display:inline-block;position:relative;margin-left:16px;}.ab_ctl.action-menu{margin-top:1px;vertical-align:middle}#hdtbSum .ab_ctl{vertical-align:baseline}a.ab_button,a.ab_button:visited{display:inline-block;color:#444;margin-top:1px}a.ab_button:hover{color:#222}#appbar a.ab_button:active,a.ab_button.selected,a.ab_button.selected:hover{color:#333}.ab_button:focus{outline:none}.ab_button.selected:focus{border-color:#ccc}.ab_button:hover>span.ab_icon{opacity:0.9}.ab_dropdown{background:#fff;border:1px solid #dcdcdc;border:1px solid rgba(0,0,0,0.2);font-size:13px;padding:6px 0;position:absolute;right:0;top:32px;white-space:nowrap;z-index:3;-webkit-transition:opacity 0.218s;transition:opacity 0.218s;-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);box-shadow:0 2px 4px rgba(0,0,0,0.2)}.ab_dropdown:focus,.ab_dropdownitem:focus,.ab_dropdownitem a:focus{outline:none}.ab_dropdownitem{margin:0;padding:0;-webkit-user-select:none}.ab_dropdownitem.selected{background-color:#eee}.ab_dropdownitem.checked{background-image:url(//ssl.gstatic.com/ui/v1/menu/checkmark.png);background-position:left center;background-repeat:no-repeat}.ab_dropdownitem.disabled{cursor:default;border:1px solid #f3f3f3;border:1px solid rgba(0,0,0,0.05);pointer-events:none}a.ab_dropdownitem.disabled{color:#b8b8b8}.ab_dropdownitem.active{-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}.ab_dropdownlnk,.ab_dropdownlnkinfo{display:block;padding:8px 20px 8px 16px}a.ab_dropdownlnk,a.ab_dropdownlnk:visited,a.ab_dropdownlnk:hover,#appbar a.ab_dropdownlnk:active{color:#333}a.ab_dropdownlnkinfo,a.ab_dropdownlnkinfo:visited,a.ab_dropdownlnkinfo:hover,#appbar a.ab_dropdownlnkinfo:active{color:#15c}.ab_dropdownchecklist{padding-left:30px}.ab_dropdownrule{border-top:1px solid #ebebeb;margin-bottom:10px;margin-top:9px}#top_nav{-webkit-user-select:none}.ksb.mini{margin-top:0px}.ab_tnav_wrp{height:33px}#hdtb-msb>.hdtb-mitem:first-child,.ab_tnav_wrp,#cnt #center_col,.mw #center_col{margin-left:150px}.mw #rhs{margin-left:820px}.mw #nyc{margin-left:651px}.klnav.klleft{margin-left:14px !important}.tbt{margin-left:8px;margin-bottom:28px}#tbpi.pt.pi{margin-top:-20px}#tbpi.pi{margin-top:0}.tbo #tbpi.pt,.tbo #tbpi{margin-top:-20px}#tbpi.pt{margin-top:8px}#tbpi{margin-top:0}#tbrt{margin-top:-20px}.tbos,.tbots,.tbotu{color:#dd4b39}.tbou>a.q,#tbpi,#tbtro,.tbt label,#set_location_section a{color:#222}.th{border:1px solid #ebebeb}#resultStats{line-height:33px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}#resultStats{padding-left:16px;padding-top:0;padding-bottom:0;padding-right:8px}#subform_ctrl{margin-left:149px}.big #subform_ctrl{padding-right:2px;margin-left:229px}.mdm .mitem .kl{padding-left:28px}.big .mitem .kl{padding-left:44px}.mdm .msel .kls{padding-left:23px}.big .msel .kls{padding-left:39px}.obsmo .dp0,.dp1{display:none}.obsmo .dp1{display:inline}#obsmtc a,.rscontainer a{text-decoration:none}#obsmtc a:hover .ul,.rscontainer a:hover .ul{text-decoration:underline}.authorship_attr{white-space:nowrap}.currency input[type=text]{background-color:white;border:1px solid #d9d9d9;border-top:1px solid #c0c0c0;box-sizing:border-box;color:#333;display:inline-block;height:29px;line-height:27px;padding-left:8px;vertical-align:top;-webkit-border-radius:1px;-webkit-box-sizing:border-box}.currency input[type=text]:hover{border:1px solid #b9b9b9;border-top:1px solid #a0a0a0;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1)}.currency input[type=text]:focus{border:1px solid #4d90fe;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);outline:none;-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3)}body.vasq #hdtbSum{height:58px}body.vasq #hdtb-msb .hdtb-mitem.hdtb-msel{height:15px;line-height:15px;padding:28px 16px 12px}#hdtb-msb .hdtb-mitem.hdtb-imb{height:15px;line-height:15px;padding-top:28px}body.vasq .ab_tnav_wrp{height:43px}body.vasq #topabar.vasqHeight{margin-top:-44px !important}body.vasq #resultStats{line-height:43px}body.vasq .hdtb-mn-o,body.vasq .hdtb-mn-c{top:38px}.ellip{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}</style><style>@-webkit-keyframes qs-timer {0%{}}</style><style>.y,.yp,.yf,.yi,.yl,.ye{}.z1asCe{display:inline-block;fill:currentColor;height:24px;line-height:24px;position:relative;width:24px}.z1asCe svg{display:block;height:100%;width:100%}.iUh30{font-size:14px;padding-top:1px;line-height:1.43;}.hJND5c,.slp{display:block;}.f,.f a:link{color:#777}.a,cite,cite a:link,cite a:visited,.cite,.cite:link,#nygTcd>i,.bc a:link{color:#006621;font-style:normal}a.fl:link,.fl a,.flt,a.flt,.gl a:link,a.mblink,.mblink b{color:#1a0dab}.r a.fl{font-size:14px}#resultStats{color:#777}.osl{margin-top:0px}#ires .hJND5c{height:18px;line-height:16px}#rcnt a:hover,.brs a:hover,#nycp a:hover,#nav a.pn:hover{text-decoration:underline}#rcnt .ab_dropdownitem a:hover,#rcnt [role=button]:hover,#rcnt .kno-fb-ctx>a:hover,#nycp a.ab_button:hover,#rcnt a.kpbb:hover,#rcnt a.a-no-hover-decoration:hover,.brs a.a-no-hover-decoration:hover,#nycp a.a-no-hover-decoration:hover,#nav a.pn.a-no-hover-decoration:hover{text-decoration:none}.dPAwzb,.dPAwzb a{font-size:12px;line-height:1.33;}#lb{z-index:1001;position:absolute;top:-1000px}.rc{position:relative;}a:hover h3{text-decoration:underline}.r{font-size:small}.r{line-height:1.54}.gl:visited{color:#666}.rc .s{line-height:1.54;}.srg .g:last-of-type{margin-bottom:28px}.khgTR{border-bottom:1px solid #ebebeb;display:block;line-height:22px;margin:0px -16px 9px -16px;padding:0 16px 11px 16px}.khgTR .f.hJND5c{margin-top:0px}.khgTR.QEhTP{border-bottom:none;margin-bottom:0;padding-bottom:0}.khgTR.lWEpfd{border-bottom:none;margin-bottom:0;padding-bottom:0}.uZfOAb{clear:both;padding-top:6px}.jtDWfd{margin-left:-10px;margin-right:-10px}.gpeho{margin-left:-10px;margin-right:-10px;padding:12px 0 5px}.tTfzVd{padding-top:9px}.pb0Ufd{border-radius:4px;border:1px solid rgba(0,0,0,0.12);font-size:14px;line-height:16px;margin-left:10px;padding:7px 8px;display:inline-block;text-align:center}.pb0Ufd:last-child{margin-right:24px}#hdtb{color:#666;font-size:13px;border-bottom:1px solid #ebebeb;margin-top:-21px;outline-width:0;outline:none;position:relative;z-index:102}#hdtb.hdtba{border-bottom:none}.hdtb-mitem a,#hdtb-more-mn a{padding:0 16px;color:#777;text-decoration:none;display:block}.hdtb-mitem a{margin:0 8px;padding:0 8px}.hdtbItm label:hover,.hdtbItm a:hover,#hdtb-more-mn a:hover,#hdtb .hdtb-mitem a:hover,.hdtb-mn-hd:hover,#hdtb-more:hover,#hdtb-tls:hover{color:#222}#hdtb.notl a,#hdtb.notl div,#hdtb.notl li{outline-width:0;outline:none}#hdtb .hdtb-mitem a:active,#hdtb-more:active,.hdtb-mn-hd:active{color:#1A73E8}.hdtb-dd-mn a,.hdtb-dd-mn a:visited,.hdtb-dd-mn a:active{color:inherit;display:block;text-decoration:none}.hdtb-mitem a.hdtb-dd-b{padding-bottom:8px;padding-top:8px}#hdtb-more-mn a:hover,.hdtbItm.hdtbSel:hover,.hdtbItm a:hover,#cdrlnk:hover{background-color:#f1f1f1}.hdtbItm.hdtbSel,#hdtb .hdtbItm a,#hdtb-more-mn a,#cdrlnk{color:#777;text-decoration:none;padding:6px 44px 6px 30px;line-height:17px;display:block}.hdtb-mitem a{display:inline-block}#hdtb-more-mn a{display:block;padding:6px 16px;margin:0}#hdtb-more-mn{min-width:120px}#hdtbMenus{background-color:transparent;top:0;width:100%;height:22px;position:absolute;transition:top 220ms ease-in-out;-webkit-transition:top 220ms ease-in-out;}.hdtb-td-h{display:none}#hdtbMenus.hdtb-td-o{top:58px;padding-top:3px;padding-bottom:7px;top:0}body.vasq #hdtbMenus.hdtb-td-o{top:68px}#hdtb.hdtba #hdtbMenus{top:21px}body.vasq #hdtb.hdtba #hdtbMenus.hdtb-td-o{top:58px}#hdtb.hdtba #hdtbMenus{background-color:#fafafa;border-bottom:1px solid #ebebeb;padding:7px 0px}#botabar{-webkit-transition:margin-top 220ms ease-in-out;transition:margin-top 220ms ease-in-out}#hdtbMenus.hdtb-td-c{}#hdtbSum{background:#fff;height:58px;padding:0;position:relative;z-index:102}.hdtb-mn-o,.hdtb-mn-c{background:#fff;border:1px solid #d6d6d6;box-shadow:0 2px 4px rgba(0,0,0,.16);box-shadow:0 2px 4px rgba(0,0,0,.16);color:#333;position:absolute;z-index:103;line-height:17px;padding-top:5px;padding-bottom:5px;top:36px}.hdtb-mn-c{display:none}#hdtb-msb{float:left;position:relative;white-space:nowrap;align-items:baseline;display:flex;-ms-flex-pack:justify;justify-content:space-between;min-width:782px}#hdtb-msb-vis{display:inline}#hdtb-msb .hdtb-mitem{display:inline-block}#hdtb-more-mn .hdtb-mitem{display:block}#hdtb-msb .hdtb-mitem:first-child.hdtb-imb{margin-left:150px}#hdtb-msb .hdtb-mitem:first-child.hdtb-msel{margin-left:154px}#hdtb-msb .hdtb-mitem.hdtb-msel{border-bottom:3px solid #1A73E8;color:#1A73E8;font-weight:bold;}#hdtb.hdtba #hdtb-msb .hdtb-mitem.hdtb-msel{border-bottom:none}#hdtb-msb .hdtb-mitem.hdtb-msel:hover{cursor:pointer}#hdtb-msb .hdtb-mitem.hdtb-msel:active{background:none}#hdtb .hdtb-mitem a{color:#777}#hdtb-msb #hdtb-more,#hdtb-msb #hdtb-tls{color:#777}#hdtb-tls{text-decoration:none}#hdtb-more{display:inline-block;padding:0 16px;position:relative;-webkit-tap-highlight-color:rgba(255,255,255,0)}#hdtb-more:hover{cursor:pointer}.hdtb-mitem .micon,#hdtbMenus .lnsep{display:none}.hdtb-mitem .mcolor{display:inline-block;width:40px;height:10px;margin-left:-13px;margin-right:-13px}#hdtb-msb .hdtb-mitem.hdtb-imb.mlinesep{width:0px;margin-left:8px;margin-right:8px;padding:0px;border-left:1px solid rgba(0,0,0,.12)}.mn-hd-txt{display:inline-block;padding-right:6px;white-space:nowrap}.mn-dwn-arw{border-color:#777 transparent;border-style:solid;border-width:5px 4px 0 4px;width:0;height:0;margin-left:-2px;top:50%;margin-top:-2px;position:absolute}.hdtb-mn-hd:hover .mn-dwn-arw,#hdtb-more:hover .mn-dwn-arw{border-color:#222 transparent}.hdtb-mn-hd:active .mn-dwn-arw,#hdtb-more:active .mn-dwn-arw{border-color:#1A73E8 transparent}.hdtb-tl{border:1px solid transparent;display:inline-block;text-align:center;border-radius:2px;line-height:19px;cursor:pointer;margin-left:-1px;padding:4px 19px}#hdtb-msb .hdtb-tl-sel,#hdtb-msb .hdtb-tl-sel:hover{background:-webkit-linear-gradient(top,#eee,#e0e0e0);-webkit-box-shadow:inset 0 1px 2px 0 rgba(0,0,0,0.1);border:1px solid #d7d7d7;box-shadow:inset 0 1px 2px 0 rgba(0,0,0,0.1);}#hdtb #hdtb-tls:active{color:#000}.mn-hd-txt>.simg_thmb{display:none}.tmlo #hdtbSum,.tmlo #hdtbMenus,.tmhi #hdtbSum,.tmhi #hdtbMenus{padding-left:0}.mn-hd-txt .mn-col{width:14px;height:14px;border:1px solid #ccc;display:inline-block;margin-top:7px}#isz_lt.hdtbSel{padding-right:0;padding-left:30px}#hdtb-tls:hover{-webkit-box-shadow:0 1px 1px rgba(0,0,0,0.1);box-shadow:0 1px 1px rgba(0,0,0,0.1);-webkit-transition:all 0.0s;transition:all 0.0s}#hdtb-tls:hover{background-color:#f8f8f8;background-image:-webkit-gradient(linear,left top,left bottom,from(#f8f8f8),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f8f8f8,#f1f1f1);background-image:linear-gradient(top,#f8f8f8,#f1f1f1);border:1px solid #c6c6c6;color:#222;}#hdtb-tls:active{background-color:#f6f6f6;background-image:-webkit-gradient(linear,left top,left bottom,from(#f6f6f6),to(#f1f1f1));background-image:-webkit-linear-gradient(top,#f6f6f6,#f1f1f1);background-image:linear-gradient(top,#f6f6f6,#f1f1f1);-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);}.action-menu,.action-menu-item,.action-menu-panel,.selected{}.GHDvEf,.GHDvEf:hover,.GHDvEf.selected,.GHDvEf.selected:hover{background-color:white;background-image:none;border:0;border-radius:0;box-shadow:0 0 0 0;cursor:pointer;filter:none;height:12px;min-width:0;padding:0;transition:none;-webkit-user-select:none;width:13px}.action-menu .mn-dwn-arw{border-color:#006621 transparent;margin-top:-4px;margin-left:3px;left:0;}.action-menu:hover .mn-dwn-arw{border-color:#00591E transparent}.action-menu{display:inline;margin:0 3px;position:relative;-webkit-user-select:none}.action-menu-panel{left:0;padding:0;right:auto;top:12px;visibility:hidden}.action-menu-item{cursor:pointer;-webkit-user-select:none}.action-menu-item:hover{background-color:#eee}.action-menu-item a.fl{color:#333;display:block;padding:7px 18px;text-decoration:none;outline:0}.qB8Uve{display:block;line-height:20px;position:relative;white-space:nowrap}.lP8Inb{padding-right:0;white-space:normal}.J6AsYb{left:0;position:absolute;top:0}.mJ9kob{display:inline-block}.sbuwl{color:#222;overflow:hidden;text-overflow:ellipsis}.P1usbc{display:table;margin:5px 0;line-height:1.54;color:#777;}.G1Rrjc{display:table-cell;padding-left:15px;vertical-align:baseline}.i4vd5e{display:table-cell}.VNLkW{display:table-row;vertical-align:top}.h7mcFf{color:#999}.TXwUJf{color:#777}.PcHvNb{position:absolute}.N3nEGc{background-color:#fff;float:left;overflow:hidden;margin-top:4px;position:relative}.wEQKyf.N3nEGc{float:right;margin:7px 0 5px 12px}.Ixi80c{margin-top:0px}.i0PvJb{background-color:#000}.S59Brf{background:#F2F2F2}.mWTy7c{border-top-left-radius:2px;bottom:0;font-size:11px;font-weight:bold;padding:1px 3px;position:absolute;right:0;text-align:right;text-decoration:none;background-color:rgba(0,0,0,.7);color:#fff}.bc{}.TbwUpd a.fl{font-size:14px}.TbwUpd.rLwn0d{overflow:hidden;text-overflow:ellipsis}.TbwUpd{display:inline-block}.TbwUpd{line-height:1.54}.H89pHb{margin-right:6px}.st sup{line-height:0.9}.mOd06 em{font-weight:bold !important}.GXZmWe{background-color:rgba(0,0,0,0.07);border-width:0;color:rgba(0,0,0,0.07);height:1px}.GXZmWe{margin:28px -8px 28px -8px}.z69Mae{border-width:0;height:1px;margin:0 -8px 5px -8px}.tqS43.GXZmWe{margin-top:34px}.hdtbU{top:-500px;white-space:nowrap}.hdtbU .hdtbItm,.hdtbU li{list-style:none outside none}#hdtb form{display:inline}.hdtbSel,.hdtbSel span.q{color:#000;cursor:default;padding-right:15px;text-decoration:none}#cdr_opt{background-image:none;background:#fff;padding:0 !important}.cdr_sep{border-top:1px solid #ebebeb;height:0;margin:5px 0;width:100%}#cdrlnk{cursor:pointer}.hdtbItm{background:#fff}.hdtbSel,.hdtbSel #cdrlnk{background-image:url(//ssl.gstatic.com/ui/v1/menu/checkmark2.png);background-position:left center;background-repeat:no-repeat}.vk_h{}.vk_c a{text-decoration:none}.vk_gn{color:#3d9400 !important}.vk_rd{color:#dd4b39 !important}.vk_dgy{color:#545454 !important}.vk_gy{color:#878787 !important}.vk_lgy{color:#bababa !important}.vk_blgy{border-color:#bababa}.vk_bk{color:#212121 !important}.vk_fl a{color:#878787}.vk_fl a:hover{color:#1a0dab}.dDoNo{font-weight:lighter !important;margin-bottom:5px}.dDoNo{font-size:xx-large !important}.dDoNo.vk_long{font-size:20px !important}.vk_h{font-weight:lighter !important}.vk_h{font-size:x-large !important}.vk_sh,.vk_hs,.vk_med{font-weight:lighter !important}.vk_sh{font-size:medium !important}.Uekwlc{font-weight:lighter !important}.Uekwlc{font-size:13px}.p13zmc{font-weight:lighter !important}.vk_cdns{font-size:13px !important}.cYvRhe{font-weight:bold !important}.vk_c,.vk_cxp,#rhs .fIcnad{border:1px solid #dfe1e5;border-radius:8px;box-shadow:none;box-shadow:none}#rhs .fIcnad{border:none;margin-left:2px}.vk_c,.vk_cxp{background-color:#fff;position:relative}.vkc_np{margin-left:-16px;margin-right:-16px}.WIDPrb,.ts .WIDPrb{padding-left:16px}.iiFzhd,.ts .iiFzhd{padding-right:16px}.vk_pt,.ts .vk_pt{padding-top:20px}.QiLuMc{padding-bottom:20px}.vk_c,.vk_cxp{margin-left:-8px;margin-right:-35px}.vk_c,.vk_cxp{margin-left:-20px;margin-right:-20px}.vk_c,.vk_cxp,.vk_ic{padding:20px 16px 24px 16px}.vk_c .vk_c,.vk_c .vk_cxp{border-radius:0;box-shadow:none;background-color:transparent;border:0;box-shadow:none;margin:0;padding:0;position:static}.vk_cxp{padding-top:30px;padding-bottom:34px}.vk_c_cxp{margin-top:10px;margin-bottom:10px}.vk_gbb{border-bottom:1px solid #eee}.vk_gbr{border-right:1px solid #eee}.vk_gbt{border-top:1px solid #eee}.vk_cf{margin:0 -16px 0 -16px;padding:16px 16px 16px 16px}.vk_cf a,.vk_cf a:link,a.vk_cf,a.vk_cf:link{color:#878787}.vk_cf a:hover,a.vk_cf:hover{color:#1a0dab}.vk_slic{display:inline-block;margin-top:-3px;margin-right:16px;position:relative;height:24px;width:24px;vertical-align:middle}.vk_sli,.vk_slih{border:none;position:absolute;top:0;left:0;height:24px;width:24px}a:hover .vk_sli,.vk_slih{display:none}a:hover .vk_slih,.vk_sli{display:inline-block}.vk_spc{height:16px;width:100%}.vk_ra{transform:rotate(90deg)}.vk_arc{border-top:1px solid #ebebeb;cursor:pointer;height:0px;margin-bottom:-19px;overflow:hidden;padding:20px 0;text-align:center}.vk_ard{top:-11px}.vk_aru{bottom:-6px}.vk_ard,.vk_aru{background-color:#e5e5e5;margin-left:auto;margin-right:auto;position:relative}.vk_ard,.vk_aru{height:6px;width:64px}.vk_ard:after,.vk_ard:before,.vk_aru:after,.vk_aru:before{content:' ';height:0;left:0;position:absolute;width:0}.vk_ard:after,.vk_ard:before,.vk_aru:after,.vk_aru:before{border-left:32px solid rgba(229,229,229,0);border-right:32px solid rgba(229,229,229,0)}.vk_ard:before{border-top:16px solid #e5e5e5;top:6px}.vk_aru:before{border-bottom:16px solid #e5e5e5;bottom:6px}.vk_ard:after{top:0}.vk_ard:after{border-top:16px solid #fff}.vk_aru:after{bottom:0}.vk_aru:after{border-bottom:16px solid #fff}.vk_bk.vk_ard,.vk_bk.vk_aru{background-color:#212121}.vk_bk.vk_ard:before{border-top-color:#212121}.vk_bk.vk_aru:before{border-bottom-color:#212121}.di8g3{font-size:11px !important;padding:6px 8px}#center_col .di8g3{margin:0 -35px 0 -8px;padding:6px 20px 0}#rhs .di8g3{margin-left:2px;padding-bottom:5px;padding-top:5px}.di8g3,.di8g3 a{color:#878787 !important;text-decoration:none}.di8g3 a:hover{text-decoration:underline}.hntNk.vk_c{padding-top:24px;padding-bottom:20px}.hntNk .dDoNo{margin-bottom:0;word-wrap:break-word}.hntNk .vk_gy{margin-bottom:5px}.pVFdhc{background-color:#ebebeb;height:1px}.vk_tbl{border-collapse:collapse}.vk_tbl td{padding:0}.xpdclps,.xpdxpnd{overflow:hidden}.xpdclps,.xpdxpnd{-webkit-transition:max-height 0.3s}.xpdxpnd,.xpdopen .xpdclps,.xpdopen .xpdxpnd.xpdnoxpnd{max-height:0}.xpdopen .xpdxpnd{max-height:none}.xpdopen .xpdbox .xpdxpnd,.xpdopen .xpdbox.xpdopen .xpdclps{max-height:0}.xpdopen .xpdbox.xpdopen .xpdxpnd,.xpdopen .xpdbox .xpdclps{max-height:none}.xpdclose .k5nfEc,.xpdopen .f9jNFb{display:none}.kno-ecr-pt{}.kno-ecr-pt{color:rgba(0,0,0,.87);line-height:1.2;margin-bottom:-3px;overflow:hidden;font-family:arial,sans-serif-light,sans-serif;display:inline;font-size:30px;font-weight:normal;position:relative;transform-origin:left top;transform-origin:left top;word-wrap:break-word}.GqKvT .kno-ecr-pt{color:#fff}.shop__a{text-decoration:none}.shop__a{color:#1a0dab}.shop__a:active{color:#1a0dab}.shop__clear{clear:both}.shop__secondary,.shop__secondary:link,.shop__secondary:visited{color:#666}a.shop__secondary,.shop__a.shop__secondary{text-decoration:none}.shop__a:hover{cursor:pointer;text-decoration:underline}a.shop__secondary:hover,.shop__a.shop__secondary:hover{text-decoration:underline}.bNg8Rb{clip:rect(1px,1px,1px,1px);height:1px;margin:0;overflow:hidden;padding:0;position:absolute;white-space:nowrap;width:1px;z-index:-1000}</style><style>.wrap div {width: 600px;}.brs_col i{margin-right:7px;margin-left:0px}.brs_col i{background-color:#fff;border-radius:3px;color:#545454;display:inline-block;font-size:11px;border:1px solid #545454;padding:1px 3px 0 2px;line-height:11px;vertical-align:baseline}</style></head><body>\n<div id='435267332345'><br><b>Loading data... Please wait !</b><br><br><br></div>\n";
eb.title&&(Ja+=eb.title+"<br><br>\n");Ja+=eb.SITE+"<br>\n";Ja+=tb.ext+"<br><br>\n";Ja=Ja+"<div class='wrap'>\n<script>\n var arrayGAShtml = "+(JSON.stringify(tb.GAShtmlForfeed)+"\n");return Ja+" var arrayGA = []\n"+Eb+"var nums=0;\nfor (var i=0; i < arrayGA.length; i++) {\nif (!arrayGA[i]) continue;\nfor (var ii=0; ii < arrayGA[i].length; ii++) {\ndocument.write('<hr><div><ol>')\nfor (var GASAId in arrayGA[i][ii].data) {\ndocument.write('<li class=\"renattw\"><div><a href=\"' + arrayGA[i][ii].url + '\"><h3 class=\"sA5rQ\">' + arrayGA[i][ii].data[GASAId].Headlines + '&lrm;</h3><br><div class=\"useyer\"><span class=\"Z98Wse\">')\ndocument.write(arrayGAShtml[0] + '</span><cite class=\"UdQCqe\" style=\"max-width:453px\">' + arrayGAShtml[3] + arrayGA[i][ii].data[GASAId].Paths + '</cite>&lrm;</div></a></div><div>' + arrayGA[i][ii].data[GASAId].Descriptions + arrayGAShtml[2] + '</div></li>')\n}\ndocument.write('</ol></div><div class=\"brs\" data-hveid=\"CAcQAA\"><div class=\"U7izfe\"><h3 class=\"dPAwzb\">' + arrayGAShtml[1] + '</h3></div><div class=\"brs_col\">' + arrayGA[i][ii].keywrds + '</div></div>')\nnums++\nconsole.log('write ' + nums + ' Item')\n}\n}\ndocument.write('<hr>')\ndocument.write('<br><br>Writed ' + nums + ' Items<br><br>')\nvar div = document.getElementById('435267332345');div.style.visibility = 'hidden';div.style.display = 'none';\n\x3c/script>\n</div>\n</body></html>"},
".ga.xml":function(Ja,eb,tb,Eb){Ja='<?xml version="1.0"?>\n<rss xmlns:g="http://base.google.com/ns/1.0" version="2.0">\n\t<channel>\n';eb.title&&(Ja+="\t\t<title>"+eb.title+"</title>\n");Ja+="\t\t<link>"+eb.SITE+"</link>\n";eb.description&&(Ja+="\t\t<description>"+eb.description+"</description>\n");return Ja+Eb+"\t</channel>\n</rss>\n"},".ga.txt":function(Ja,eb,tb,Eb){eb=tb.feed_fields_file_types;tb=0;var Ib="",Jb;for(Jb in eb[Ja])Ib=tb?Ib+("\t"+Jb):Jb,tb++;return Ib+"\n"+Eb},".ga.tsv":function(Ja,
eb,tb,Eb){eb=tb.feed_fields_file_types;tb=0;var Ib="",Jb;for(Jb in eb[Ja])Ib=tb?Ib+("\t"+Jb):Jb,tb++;return Ib+"\n"+Eb}};if(!AdWordsApp.getExecutionInfo().isPreview()){Utilities.sleep(1E4);var Ra={};R=DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();Z=h+".";for(sa=Z.length;R.hasNext();)V=R.next(),fa=V.getName(),fa.indexOf(Z)||Ra[fa]||(Ra[fa]=V)}Fa=D.config[D.scannId.IdNum];if(!D.hasOwnProperty("AllScanEmptyError")){var kb=D.AllScanEmptyError=0,fb=0;for(e in D.CURfeedsIds){var W=Fa[e];1!=
W.No_Critical_Errors&&fb++;D.scanned.parced_urls[e]||1!=W.No_Critical_Errors&&kb++}fb&&kb==fb&&(D.AllScanEmptyError=1)}for(var xa in Fa)if(Fa.feeds[xa]&&D.CURfeedsIds[xa]&&!H[xa]&&!Fa.pausedFeedsIds[xa]){W=Fa[xa];var Ma=D.scanned.FeedsFilesOUT&&D.scanned.FeedsFilesOUT[xa]?JSON.parse(JSON.stringify(D.scanned.FeedsFilesOUT[xa])):{};if(1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError)for(wa in W.feed_fields_file_types)Ma.hasOwnProperty(wa)||(Ma[wa]="");for(wa in Ma){var Sa=
h+"."+W.feedId+wa;if(AdWordsApp.getExecutionInfo().isPreview()){if(ya="",Ma[wa]||1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError){try{ya=L[wa](wa,Fa,W,Ma[wa]);for(Xa=filesfolder.getFilesByName(Sa);Xa.hasNext();)V=Xa.next(),deleteOrRemoveFile(V);checkSaveFile(filesfolder.createFile(Sa,ya),ya);D.scanned.FeedsFilesExistNames[Sa]=1}catch(Ja){ScanCreateFeedsGlobalVars.errors+="bad field_type: "+wa+" in correctfeedExtFunctions, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}ya=
""}}else{for(var ya="",$a=1;$a<=D.scanned.steps;$a++){var ta=h+"."+W.feedId+"."+$a+wa;Ra[ta]&&(ya+=Ra[ta].getBlob().getDataAsString())}if(ya||1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError){try{ya=L[wa](wa,Fa,W,ya);for(var Xa=filesfolder.getFilesByName(Sa);Xa.hasNext();)V=Xa.next(),deleteOrRemoveFile(V);checkSaveFile(filesfolder.createFile(Sa,ya),ya);D.scanned.FeedsFilesExistNames[Sa]=1}catch(Ja){ScanCreateFeedsGlobalVars.errors+="bad field_type: "+wa+" in correctfeedExtFunctions, check script code\n",
Logger.log(ScanCreateFeedsGlobalVars.errors)}ya=""}}}var ma=0;1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError?W.GASearch&&W.GASearch.GAShtml&&(ma=1):D.scanned.SearchFeedsFilesOUT&&D.scanned.SearchFeedsFilesOUT[xa]&&(ma=1);if(ma)if(wa=".gas.html",Sa=h+"."+W.feedId+wa,AdWordsApp.getExecutionInfo().isPreview()){ya="";try{var hb=0;if(D.scanned.SearchFeedsFilesOUT&&D.scanned.SearchFeedsFilesOUT[xa])ya=L[wa](wa,Fa,W,"arrayGA[0]="+JSON.stringify(D.scanned.SearchFeedsFilesOUT[xa])+
"\n"),hb=1;else if(1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError)ya=L[wa](wa,Fa,W,""),hb=1;if(hb){for(Xa=filesfolder.getFilesByName(Sa);Xa.hasNext();)V=Xa.next(),deleteOrRemoveFile(V);checkSaveFile(filesfolder.createFile(Sa,ya),ya);D.scanned.FeedsFilesExistNames[Sa]=1}}catch(Ja){ScanCreateFeedsGlobalVars.errors+="bad field_type: "+wa+" in correctfeedExtFunctions, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}ya=""}else{ya="";for($a=1;$a<=D.scanned.steps;$a++)ta=
h+"."+W.feedId+"."+$a+wa,Ra[ta]&&(ya+="arrayGA["+($a-1)+"]="+Ra[ta].getBlob().getDataAsString()+"\n");if(ya||1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError){try{ya=L[wa](wa,Fa,W,ya);for(Xa=filesfolder.getFilesByName(Sa);Xa.hasNext();)V=Xa.next(),deleteOrRemoveFile(V);checkSaveFile(filesfolder.createFile(Sa,ya),ya);D.scanned.FeedsFilesExistNames[Sa]=1}catch(Ja){ScanCreateFeedsGlobalVars.errors+="bad field_type: "+wa+" in correctfeedExtFunctions, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}ya=
""}}}}}var Na="",Ta=0,rb=0,zb=0;if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors){if(!AdWordsApp.getExecutionInfo().isPreview()){ia=h+"."+D.scannId.Id+".errorscan.txt";for(ja=filesfolder.getFilesByName(ia);ja.hasNext();)V=ja.next(),deleteOrRemoveFile(V);checkSaveFile(filesfolder.createFile(ia,ScanCreateFeedsGlobalVars.errors),ScanCreateFeedsGlobalVars.errors)}zb=1}else if(D.scanned.steps)for(xa in D.ended&&D.ended.feeds_files_saved||(D.ended||(D.ended={}),D.ended.feeds_files_saved=1,
D.ended.feeds_ftp={}),Fa=D.config[D.scannId.IdNum],Fa)if(Fa.feeds[xa]&&D.CURfeedsIds[xa]&&!H[xa]&&!Fa.pausedFeedsIds[xa]&&(W=Fa[xa],W.hasOwnProperty("ftp"))){Ma=D.scanned.FeedsFilesOUT&&D.scanned.FeedsFilesOUT[xa]?JSON.parse(JSON.stringify(D.scanned.FeedsFilesOUT[xa])):{};if(1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError)for(wa in W.feed_fields_file_types)Ma.hasOwnProperty(wa)||(Ma[wa]="");var ab=[],lb="";for(wa in Ma)if(ta=h+"."+W.feedId+wa,D.scanned.FeedsFilesExistNames[ta]){var Pa=
filesfolder.getFilesByName(ta);Pa.hasNext()?ab[ab.length]=Pa.next():lb+=ta+"\n"}ma=0;1==W.Write_emptyFeed_File||2==W.Write_emptyFeed_File&&!D.AllScanEmptyError?W.GASearch&&W.GASearch.GAShtml&&(ma=1):D.scanned.SearchFeedsFilesOUT&&D.scanned.SearchFeedsFilesOUT[xa]&&(ma=1);ma&&(ta=h+"."+W.feedId+".gas.html",D.scanned.FeedsFilesExistNames[ta]&&(Pa=filesfolder.getFilesByName(ta),Pa.hasNext()?ab[ab.length]=Pa.next():lb+=ta+"\n"));if(ab.length||lb){rb=1;var Ea=h+"."+W.feedId+".zip";D.ended.feeds_ftp[Ea]?
D.ended.feeds_ftp[Ea].sendattempt++:(D.ended.feeds_ftp[Ea]={},D.ended.feeds_ftp[Ea].sendattempt=1,D.ended.feeds_ftp[Ea].sendres=!1);if(3>D.ended.feeds_ftp[Ea].sendattempt&&!1===D.ended.feeds_ftp[Ea].sendres){AdWordsApp.getExecutionInfo().isPreview()||writeJSONFile(g,D,tmpfilesfolder);if(lb){Utilities.sleep(1E4);ab=[];lb="";for(wa in Ma)ta=h+"."+W.feedId+wa,D.scanned.FeedsFilesExistNames[ta]&&(Pa=filesfolder.getFilesByName(ta),Pa.hasNext()?ab[ab.length]=Pa.next():lb+=ta+"\n");ma=0;1==W.Write_emptyFeed_File||
2==W.Write_emptyFeed_File&&!D.AllScanEmptyError?W.GASearch&&W.GASearch.GAShtml&&(ma=1):D.scanned.SearchFeedsFilesOUT&&D.scanned.SearchFeedsFilesOUT[xa]&&(ma=1);ma&&(ta=h+"."+W.feedId+".gas.html",D.scanned.FeedsFilesExistNames[ta]&&(Pa=filesfolder.getFilesByName(ta),Pa.hasNext()?ab[ab.length]=Pa.next():lb+=ta+"\n"))}if(lb){var Ya=!1,cb=[],Db=[],pb=[];for(e=0;e<ab.length;e++){var gb=ab[e].getName();Db[e]=gb;var wb=gb.match(/((?:\.(?:ga|yml|yrl|ycar|ya))?\.(?:[\w]+))$/i);if(wb&&wb[1]){var qb=wb[1].toLowerCase();
if(-1!=W.ftp.files_types.indexOf(qb)){var mb=cb.length;cb[cb.length]=ab[e].getBlob().getDataAsString().length;pb[mb]=gb}}}var Ua=h+" ftp error for "+Ea+", filesArr.length="+ab.length+", filesArr="+JSON.stringify(ab)+", names="+JSON.stringify(Db)+", names2="+JSON.stringify(pb)+", blobs="+JSON.stringify(cb)+"\n\nNo exist Files:\n"+lb;F=getcurrentTime();I=("0"+F.getDate()).slice(-2)+"."+("0"+(F.getMonth()+1)).slice(-2);B=getLabel("LastcrUnknFtpErr");U="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 (\u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u0430\u044f \u043e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0444\u0442\u043f-\u043e\u0442\u043f\u0440\u0430\u0432\u043a\u0435) \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+
h;P=U+"\n"+Ua;B!=I&&UNKNOWN_ERROR_SEND_FTP&&"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,U,P);Logger.log(P);B!=I&&setLabel("LastcrUnknFtpErr",I)}else Ya=sendftp(ab,W.ftp,Ea,h);D.ended.feeds_ftp[Ea].sendres=Ya;!1===Ya&&(pa=!0);!0!==Ya&&(Ta=1)}else 3==D.ended.feeds_ftp[Ea].sendattempt&&!1===D.ended.feeds_ftp[Ea].sendres&&(Ta=1);"string"==typeof D.ended.feeds_ftp[Ea].sendres?Na+=W.feedId+" "+D.ended.feeds_ftp[Ea].sendres+"\n":!1===D.ended.feeds_ftp[Ea].sendres&&
(Na+=W.feedId+" Script Timeout\n")}}if(!zb)if(Na&&Ta){if(!AdWordsApp.getExecutionInfo().isPreview()){ia=h+"."+D.scannId.Id+".ftperrors.txt";for(ja=filesfolder.getFilesByName(ia);ja.hasNext();)V=ja.next(),deleteOrRemoveFile(V);checkSaveFile(filesfolder.createFile(ia,Na),Na)}Logger.log("\nFTP errors: \n"+Na+"\n for "+h)}else if(!Na&&(rb&&Logger.log("\nAll FTP jobs ended without errors for "+h+"\n\n"),!AdWordsApp.getExecutionInfo().isPreview()))for(ia=h+"."+D.scannId.Id+".ftperrors.txt",ja=filesfolder.getFilesByName(ia);ja.hasNext();)V=
ja.next(),deleteOrRemoveFile(V);if(!v&&!pa)if(AdWordsApp.getExecutionInfo().isPreview())Qa[0]&&(nb="Some feeds may be not write: you delete 'test' in parameter timeHours in config for this feeds (before exit preview script)\n",Logger.log(nb));else{E=h+"."+D.scannId.Id+".scanresult.txt";for(Wa=filesfolder.getFilesByName(E);Wa.hasNext();)V=Wa.next(),deleteOrRemoveFile(V);if(Qa[0]){var nb="Some feeds may be not write: you change for this feeds config parameter timeHours to 'test' (before exit execute script)\n";
D.scanned.report+=nb;Logger.log(nb)}D.scanned&&D.scanned.report&&(Ca=D.scanned.report+"Current Scan Status: ended.\n",checkSaveFile(filesfolder.createFile(E,Ca),Ca),Logger.log("Current Scan Status: ended."))}if(!pa||zb){removeAllScanFiles(h,tmpfilesfolder);if(!AdWordsApp.getExecutionInfo().isPreview()){var Kb="";R=DriveApp.getFolderById(tmpfilesfolder.getId()).getFiles();Z=h+".";for(sa=Z.length;R.hasNext();)V=R.next(),fa=V.getName(),fa.indexOf(Z)||(Kb+=fa+"\n");Kb&&(Logger.log("Error delete files in removeAllScanFiles !!!, message in script end, account "+
h),Logger.log("Found error file(s): \n"+Kb+"\naccount "+h),ha={unkwonw_abr:1,scannId:{}},ha.scannId.Id=D.scannId.Id,ScanCreateFeedsGlobalVars.unkwonw_abr={},ScanCreateFeedsGlobalVars.unkwonw_abr.Id=D.scannId.Id,writeJSONFile(g,ha,tmpfilesfolder),F=getcurrentTime(),I=("0"+F.getDate()).slice(-2)+"."+("0"+(F.getMonth()+1)).slice(-2),B=getLabel("LastcrUnknEndErr"),P=U="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 (\u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u0430\u044f \u043e\u0448\u0438\u0431\u043a\u0430 \u0432 \u043a\u043e\u043d\u0446\u0435 \u0441\u043a\u0430\u043d\u0430) \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+
h,B!=I&&UNKNOWN_ERROR_SEND&&"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,U,P),Logger.log(P),B!=I&&setLabel("LastcrUnknEndErr",I))}var Hb=getcurrentTime();w[D.scannId.Id].time=Hb.getTime();w[D.scannId.Id].date=Hb.toString().replace(/\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}:?\d{2})?)\b\)?/g,"");l=rewriteScanReport(r,filesfolder,w);var ub=$jscomp.makeIterator(rateLimitExpBackoff(readFeedConfig,
[h,mainfolder,domainsfolder,filesfolder,1],backoffErrors)),ob=ub.next().value;ub.next();ub.next();ub.next();ub.next();var sb=ub.next().value;ub.next();var Nb=ub.next().value;if(!ob){var Lb=h+".merchantfeed_old.txt",Fb=h+".merchantfeed_new.txt";u=h+".merchantfeed.txt";Logger.log("Good new config file: "+Fb+". Rename it to file "+u);if(!AdWordsApp.getExecutionInfo().isPreview()){for(var Gb=sb.getFilesByName(Lb);Gb.hasNext();){var Mb=Gb.next();deleteOrRemoveFile(Mb)}var Ab=sb.getFilesByName(Fb);if(Ab.hasNext()){var vb=
Ab.next();if(jb=vb.getBlob().getDataAsString()){var ua=sb.getFilesByName(u);if(ua.hasNext())for(V=ua.next(),checkSaveFile(V.makeCopy(Lb),V.getBlob().getDataAsString()),checkSaveFile(V.setContent(jb),jb),Logger.log("OwerWrited config file: "+u);ua.hasNext();)V=ua.next(),deleteOrRemoveFile(V);else checkSaveFile(sb.createFile(u,jb,"text/plain"),jb),Logger.log("Writed new config file: "+u)}else for(Logger.log("No writed new config file: "+u+". Remove empty file "+Fb),Gb=sb.getFilesByName(Lb);Gb.hasNext();)Mb=
Gb.next(),deleteOrRemoveFile(Mb);for(deleteOrRemoveFile(vb);Ab.hasNext();)vb=Ab.next(),deleteOrRemoveFile(vb)}}}else if(1==ob){Fb=h+".merchantfeed_new.txt";u=h+".merchantfeed_newbad.txt";Logger.log("Errors in new config file: "+Fb+". Rename it to file "+u);if(!AdWordsApp.getExecutionInfo().isPreview()&&(Ab=sb.getFilesByName(Fb),Ab.hasNext())){vb=Ab.next();if(jb=vb.getBlob().getDataAsString())if(ua=sb.getFilesByName(u),ua.hasNext())for(V=ua.next(),Ca="/*\n"+Nb+"\n*/\n"+jb,checkSaveFile(V.setContent(Ca),
Ca),Logger.log("OwerWrited bad config file: "+u);ua.hasNext();)V=ua.next(),deleteOrRemoveFile(V);else Ca="/*\n"+Nb+"\n*/\n"+jb,checkSaveFile(sb.createFile(u,Ca,"text/plain"),Ca),Logger.log("Writed bad config file: "+u);else Logger.log("No writed bad config file: "+u+". Remove empty file "+Fb);for(deleteOrRemoveFile(vb);Ab.hasNext();)vb=Ab.next(),deleteOrRemoveFile(vb)}F=getcurrentTime();I=("0"+F.getDate()).slice(-2)+"."+("0"+(F.getMonth()+1)).slice(-2);B=getLabel("LastcrNewConfErr");U="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 (\u043e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0438 \u0432 \u043d\u043e\u0432\u043e\u043c \u0444\u0430\u0439\u043b\u0435 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438, \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0435 \u043d\u0430\u0441\u0442\u0440\u043e\u0435\u043a \u043d\u0435 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u043e) \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+
h;P=U+"\n"+Nb+"\n"+u+"\n";AdWordsApp.getExecutionInfo().isPreview()||"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,U,P);Logger.log(P);B!=I&&setLabel("LastcrNewConfErr",I)}if(!(CONTROL_EMPTY_FEEDS||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)&&D.scanned&&D.scanned.steps){F=getcurrentTime();I=("0"+F.getDate()).slice(-2)+"."+("0"+(F.getMonth()+1)).slice(-2);B=getLabel("LastcrFErr");var Ka=P="",Rb=0,Sb=0,Tb=0,Ub=0,Pb="";fb=kb=0;
Fa=D.config[D.scannId.IdNum];for(e in D.CURfeedsIds)(W=Fa[e],1!=W.No_Critical_Errors&&fb++,D.scanned.parced_urls[e])?1!=W.No_Critical_Errors&&2!=W.No_Critical_Errors&&(W.GASearch&&W.GASearch.Id&&(Sb++,D.scanned.GASearch_urls[e]||(Rb++,3!=W.No_Critical_Errors&&5!=W.No_Critical_Errors&&(P+="Not exist items in GASearch for feedId: "+e+", site Id:"+Fa.Id+"\n"))),Object.keys(W.feed_fields_file_types).length||W.GASearch&&W.GASearch.GAShtml)&&(Ub++,D.scanned.addfeed_urls[e]||(Tb++,3!=W.No_Critical_Errors&&
4!=W.No_Critical_Errors&&(P+="Not exist items for feedId: "+e+", site Id:"+Fa.Id+"\n"))):1!=W.No_Critical_Errors&&(kb++,2==W.No_Critical_Errors?Pb+="Not exist parsed items for feedId: "+e+", site Id:"+Fa.Id+"\n":Ka+="Not exist parsed items for feedId: "+e+", site Id:"+Fa.Id+"\n");fb&&kb==fb&&(Ka+=Pb);var Ob=Object.keys(D.CURfeedsIds);Ob.length||Logger.log("Not found feeds for site Id:"+Fa+", Client "+h);Ka&&(U="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 (\u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u044b \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u044b) \u043f\u0440\u0438 \u043f\u0430\u0440\u0441\u0438\u043d\u0433\u0435 \u0441\u0430\u0439\u0442\u043e\u0432 \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+
h,Ka=U+"\n"+Ka+"\nChecked feedsNum: "+Ob.length+"\nChecked feeds: "+Ob.join(","),AdWordsApp.getExecutionInfo().isPreview()||B!=I&&"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,U,Ka),Logger.log(Ka));P&&(U="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043e\u0448\u0438\u0431\u043a\u0438 (\u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d\u044b \u0442\u043e\u0432\u0430\u0440\u044b) \u043f\u0440\u0438 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u0438 \u0444\u0438\u0434\u043e\u0432/\u043a\u0430\u043c\u043f\u0430\u043d\u0438\u0439 \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+
h,P=U+"\n"+P+"\nChecked feedsNum: "+Ob.length+"\nChecked feeds: "+Ob.join(","),AdWordsApp.getExecutionInfo().isPreview()||B!=I&&"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,U,P),Logger.log(P));(Ka||P)&&B!=I&&setLabel("LastcrFErr",I)}}if(pa&&!zb)break}else{AdWordsApp.getExecutionInfo().isPreview()||(D.interimsave||(D.interimsave=1),writeJSONFile(g,D,tmpfilesfolder),Oa=saveBufferFiles(g,h,D,tmpfilesfolder),writeJSONFile(g,D,tmpfilesfolder));
la=SCRIPT_ID_NAME+".SCANRUN";na=getLabel(la);null!==na&&setLabel(la,Array(2010).join("-"));if(D.scanned.steps)for(za=AdWordsApp.labels().withCondition("Name STARTS_WITH '"+SCRIPT_ID_NAME.replace(/'/gm,"\\'")+":SCANCADGRS:'").get();za.hasNext();)Ha=za.next(),Ha.remove(),Ha.remove();Aa=SCRIPT_ID_NAME+".SCANCADGRSRUN";na=getLabel(Aa);null!==na&&setLabel(Aa,Array(2010).join("-"));if(!AdWordsApp.getExecutionInfo().isPreview()){E=h+"."+D.scannId.Id+".interimresult.txt";for(Wa=filesfolder.getFilesByName(E);Wa.hasNext();)V=
Wa.next(),deleteOrRemoveFile(V);D.scanned&&D.scanned.report&&checkSaveFile(filesfolder.createFile(E,D.scanned.report),D.scanned.report)}}}setLabel(a,Array(2010).join("-"));k=getcurrentTime();JSONparsestringifyStopInit();return JSON.stringify({TimeZone:TimeZone,StartTime:d.toString(),EndTime:k.toString(),CustomerId:c,CustomerName:n,nowAccountFileName:nowAccountFileName})}}}}}catch(Ja){var Qb=Ja&&Ja.message&&Ja.stack?Ja.name+": "+Ja.message+" "+Ja.stack.toString():Ja.toString();Logger.log("\n\nERROR: "+
Qb+"\n\n");setLabel(a,Array(2010).join("-"));return JSON.stringify({nowAccountFileName:nowAccountFileName,EndError:Qb})}}function md5(a){return Utilities.computeDigest(Utilities.DigestAlgorithm.MD5,a).reduce(function(d,c){c=(0>c?c+256:c).toString(16);return d+(1==c.length?"0":"")+c},"")}
function saveBufferFiles(a,d,c,n,t){var q=0,h=0,b=c.config[c.scannId.IdNum];if(c.scanned.FeedsFilesOUT)for(var m in c.scanned.FeedsFilesOUT){var p=b[m],k=c.scanned.FeedsFilesOUT[m]?c.scanned.FeedsFilesOUT[m]:{};for(r in k){var z=d+"."+p.feedId+"."+c.scanned.steps+r;if(!t)for(var G=n.getFilesByName(z);G.hasNext();){var y=G.next();deleteOrRemoveFile(y)}if(k[r]){if(t)for(G=n.getFilesByName(z);G.hasNext();)y=G.next(),deleteOrRemoveFile(y);q=k[r];checkSaveFile(n.createFile(z,q),q);k[r]="";q=1;h++;30*parseInt(h/
30)==h&&writeJSONFile(a,c,n)}}}if(c.scanned.SearchFeedsFilesOUT)for(m in c.scanned.SearchFeedsFilesOUT)if(p=b[m],c.scanned.SearchFeedsFilesOUT[m]){var r=".gas.html";z=d+"."+p.feedId+"."+c.scanned.steps+r;if(!t)for(G=n.getFilesByName(z);G.hasNext();)y=G.next(),deleteOrRemoveFile(y);if(c.scanned.SearchFeedsFilesOUT[m].length){if(t)for(G=n.getFilesByName(z);G.hasNext();)y=G.next(),deleteOrRemoveFile(y);p=checkSaveFile(n.createFile(z,""),"");k=JSON.stringify(c.scanned.SearchFeedsFilesOUT[m]);checkSaveFile(p.setContent(k),
k);c.scanned.SearchFeedsFilesOUT[m]=[];q=1;h++;30*parseInt(h/30)==h&&writeJSONFile(a,c,n)}}return q}function removeAllScanFiles(a,d){if(!AdWordsApp.getExecutionInfo().isPreview()){for(var c=[],n=DriveApp.getFolderById(d.getId()).getFiles(),t=a+".";n.hasNext();){var q=n.next();q.getName().indexOf(t)||c.push(q)}for(n=0;n<c.length;n++)q=c[n].getName(),deleteOrRemoveFile(c[n]),c[n]=q;for(n=0;n<c.length;n++)for(t=d.getFilesByName(c[n]);t.hasNext();)q=t.next(),deleteOrRemoveFile(q)}}
function reportResults(a){for(var d=getcurrentTime(),c="",n=0;n<a.length;n++){var t=a[n],q=t.getCustomerId()+"",h=t.getStatus();if("ERROR"==h){var b=nowAccountFileName;h=readJSONFile(b,schedfilesfolder);h&&h[q]&&h[q].MCCStart||(h=nowGMTHour-1,0>h&&(h=23),b="Optimizer-GMXMLAccountList-"+h+"-"+SCRIPT_ID+".json",h=readJSONFile(b,schedfilesfolder));h&&h[q]&&!h[q].EndError&&(Logger.log(q+" scriptID: "+SCRIPT_ID+" Error: \u043e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0438 \u0441\u043a\u0440\u0438\u043f\u0442\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0430: "+
t.getError()),Logger.log("\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430 "+q+" \u043f\u0440\u0435\u043a\u0440\u0430\u0449\u0435\u043d\u0430"),c=c+"\n\n"+q+" scriptID: "+SCRIPT_ID+" Error: \u043e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0438 \u0441\u043a\u0440\u0438\u043f\u0442\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0430: "+t.getError()+
"\n\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430 "+q+" \u043f\u0440\u0435\u043a\u0440\u0430\u0449\u0435\u043d\u0430",h[q].EndError=t.getError(),AdWordsApp.getExecutionInfo().isPreview()||writeJSONFile(b,h,schedfilesfolder))}else"OK"==h?t.getReturnValue()&&"undefined"!=t.getReturnValue()&&(t=JSON.parse(t.getReturnValue()),h=readJSONFile(t.nowAccountFileName,schedfilesfolder),t.EndError?h&&h[q]&&!h[q].EndError&&
(Logger.log(q+" scriptID: "+SCRIPT_ID+" Error: \u043e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0438 \u0441\u043a\u0440\u0438\u043f\u0442\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0430: "+t.EndError),Logger.log("\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430 "+q+" \u043f\u0440\u0435\u043a\u0440\u0430\u0449\u0435\u043d\u0430"),c=c+"\n\n"+q+" scriptID: "+
SCRIPT_ID+" Error: \u043e\u0448\u0438\u0431\u043a\u0430 \u043f\u0440\u0438 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0438 \u0441\u043a\u0440\u0438\u043f\u0442\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0430: "+t.EndError+"\n\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430 "+q+" \u043f\u0440\u0435\u043a\u0440\u0430\u0449\u0435\u043d\u0430",h[q].EndError=t.EndError,AdWordsApp.getExecutionInfo().isPreview()||
writeJSONFile(t.nowAccountFileName,h,schedfilesfolder)):h&&h[q]&&!h[q].CheckedEnd&&(h[q].TimeZone=t.TimeZone,h[q].CheckedStart=t.StartTime,h[q].CheckedEnd=t.EndTime,AdWordsApp.getExecutionInfo().isPreview()||testing_ID||writeJSONFile(t.nowAccountFileName,h,schedfilesfolder))):(Logger.log(q+" scriptID: "+SCRIPT_ID+" Error: \u043f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u0442\u0430\u0439\u043c\u0430\u0443\u0442 (30 \u043c\u0438\u043d\u0443\u0442) \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0441\u043a\u0440\u0438\u043f\u0442\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0430"),
Logger.log("\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430 "+q+" \u043f\u0440\u0435\u043a\u0440\u0430\u0449\u0435\u043d\u0430"),c=c+"\n\n"+q+" scriptID: "+SCRIPT_ID+" Error: \u043f\u0440\u0435\u0432\u044b\u0448\u0435\u043d \u0442\u0430\u0439\u043c\u0430\u0443\u0442 (30 \u043c\u0438\u043d\u0443\u0442) \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0441\u043a\u0440\u0438\u043f\u0442\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0430\n\u041e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430 "+
q+" \u043f\u0440\u0435\u043a\u0440\u0430\u0449\u0435\u043d\u0430")}c?(Logger.log("\u041f\u0440\u0438 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0438 \u0441\u043a\u0440\u0438\u043f\u0442\u043e\u0432 \u0432\u043e\u0437\u043d\u0438\u043a\u043b\u0438 \u043e\u0448\u0438\u0431\u043a\u0438 !!! (\u0438\u0449\u0438\u0442\u0435 \u0432 \u043e\u0442\u0447\u0435\u0442\u0435 \u0441\u043b\u043e\u0432\u043e Error)"),AdWordsApp.getExecutionInfo().isPreview()||"undefined"!=typeof supportemail&&supportemail&&
MailApp.sendEmail(supportemail,"\u0412 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0430\u0445 Adwords \u0432\u043e\u0437\u043d\u0438\u043a\u043b\u0438 \u043e\u0448\u0438\u0431\u043a\u0438, scriptID: "+SCRIPT_ID,c+"\n\n"+d)):Logger.log("\u0421\u043a\u0440\u0438\u043f\u0442 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d \u0431\u0435\u0437 \u043e\u0448\u0438\u0431\u043e\u043a")}
function readScanReport(a,d){var c=[];if("string"==typeof d)d&&(c=d.split(/[\r\n]+/));else{var n=d.getFilesByName(a);n.hasNext()&&(c=n.next().getBlob().getDataAsString(),c=c.split(/[\r\n]+/))}n={};for(var t=0;t<c.length;t++)if(c[t]){var q=$jscomp,h=q.makeIterator;var b=(b=c[t].match(/^\s*([^\s]+)\s+([^\s]+)\s+([^\s]+)\s+([^\s].*)$/))?[b[1],b[2],b[3],b[4]]:[void 0,void 0,void 0,void 0];var m=h.call(q,b);q=m.next().value;h=m.next().value;b=m.next().value;m=m.next().value;var p=new Date(m);"Invalid Date"!=
p?p=p.getTime():(Logger.log(a+" have Invalid Date: new Date("+m+")"),p=0);n[q]={Id:q,checksum:h,priorityLev:b,date:m,time:p}}return n}
function SORTscanids(a){var d=0,c=0,n;for(n in a)a[n].time||(a[n].time=0),d<a[n].time&&(d=a[n].time),a[n].IdNum||(a[n].IdNum=0),c<a[n].IdNum&&(c=a[n].IdNum);d=String(d);c=String(c);var t=Array(d.length+1).join("0"),q=Array(c.length+1).join("0");for(n in a)a[n].time2=1*(String(a[n].priorityLev)+(t+a[n].time).slice(-d.length)+(q+a[n].IdNum).slice(-c.length));d=[];for(n in a)d.push(a[n]);d.sort(function(b,m){return b.time2-m.time2});a={};for(var h in d)a[d[h].Id]=d[h];return a}
function readFeedConfig(a,d,c,n,t){if(t)var q=a+".merchantfeed_new.txt",h="";else q=a+".merchantfeed.txt",h=a+".feedsmap.txt";var b=readConfFile(q,d),m="/"+q,p="/"+q,k=d;b[0]||1!=b[1]||(b=readConfFile(q,c),m="\n/callhunter/domains/"+q,p+="\n/callhunter/domains/"+q,k=c);var z=JSON.parse(JSON.stringify(b[0])),G=0,y={},r=!1,g="",v="";if(t&&!b[0]&&1==b[1])return[2,b[0],y,r,G,k,z,g];var l="",e=0;b[1]?(g=b[2]+"\n"+p,e=1):g="Read Config File Ok\n"+m;e||!b[1]&&b[0]&&"object"==typeof b[0]&&b[0].length||(g+=
"\nConfig is empty",e=1);e||"[object Array]"==={}.toString.call(b[0])||(g+="\nConfig is not Array (first level)",e=1);var C=".html .ga.xml .ga.txt .ga.tsv .yml.xml .yrl.xml .ycar.xml .ya.tsv".split(" "),N={},A={},w={};if(!e)for(var f in b[0]){if("[object Object]"!=={}.toString.call(b[0][f])){g+="\nConfig Array element number "+f+" is not Hash";e=1;break}b[0][f].soft_shutdown&&(CONTROL_EMPTY_FEEDS=1);if(!b[0][f].SITE||"string"!=typeof b[0][f].SITE){g+="\nConfig Array element number "+f+" is not have parameter SITE";
e=1;break}if(/\s/.test(b[0][f].SITE)){g+="\nConfig Array element number "+f+" have space in parameter SITE";e=1;break}var J=parse_url(b[0][f].SITE);if(!J.hostname||!J.protocol){g+="\nConfig Array element number "+f+" is not have correct parameter SITE";e=1;break}N.hasOwnProperty(J.hostname)?(g+="\nConfig Array element number "+f+" have dublicate hostname in parameter SITE",e=1):N[J.hostname]=b[0][f].SITE;var K=b[0][f].seed;K?isInteger(K)?K=parseInt(K):(g+="\nConfig Array element number "+f+" have incorrect parameter seed",
e=1):K=void 0;b[0][f].seed=K;var u={},F=0;if(b[0][f].hasOwnProperty("timeHours"))b[0][f].timeHours?"string"!=typeof b[0][f].timeHours?(F=1,I=[]):I="test"===b[0][f].timeHours?["test"]:b[0][f].timeHours.split(/[\s,]+/):I=["0"];else var I=["0"];F&&(g+="\nConfig Array element number "+f+" have incorrect parameter timeHours",e=1);for(var B=0;B<I.length;B++)if(isInteger(I[B])){if(I[B]=parseInt(I[B]),u[I[B]]=1,0>I[B]||23<I[B])g+="\nConfig Array element number "+f+" have incorrect parameter timeHours "+I[B],
e=1}else"test"==I[B]&&1==I.length?u[I[B]]=1:(g+="\nConfig Array element number "+f+" have incorrect parameter timeHours "+I[B],e=1);b[0][f].timeHours=[];b[0][f].timeHoursHash={};CONTROL_EMPTY_FEEDS&&(I=["0"],I[0]=parseInt(I[0]),u={},u[I[0]]=1,b[0][f].timeHours=[],b[0][f].timeHoursHash={});var U={},P=0;if(b[0][f].hasOwnProperty("startDays"))b[0][f].startDays?"string"!=typeof b[0][f].startDays?(P=1,X=[]):X=b[0][f].startDays.split(/[\s,]+/):X=[];else var X=[];P&&(g+="\nConfig Array element number "+
f+" have incorrect parameter startDays",e=1);for(B=0;B<X.length;B++)if(isInteger(X[B])){if(X[B]=parseInt(X[B]),U[X[B]]=1,1>X[B]||31<X[B])g+="\nConfig Array element number "+f+" have incorrect parameter startDays "+X[B],e=1}else g+="\nConfig Array element number "+f+" have incorrect parameter startDays",e=1;b[0][f].startDays="";b[0][f].startDaysHash="";CONTROL_EMPTY_FEEDS&&(X=[],b[0][f].startDays="",b[0][f].startDaysHash="");if(b[0][f].repeaterUrl&&"string"!=typeof b[0][f].repeaterUrl)g+="\nConfig Array element number "+
f+" have incorrect parameter repeaterUrl",e=1;else if(b[0][f].repeaterUrl){/\/$/.test(b[0][f].repeaterUrl)||(b[0][f].repeaterUrl+="/");b[0][f].repeaterUrl+="srvrepeat.php";var S=parse_url(b[0][f].repeaterUrl);S&&S.host&&S.protocol&&S.pathname&&!S.search&&!S.hash?b[0][f].repeaterUrl+="?url=":(g+="\nConfig Array element number "+f+" have incorrect parameter repeaterUrl",e=1)}CONTROL_EMPTY_FEEDS&&b[0][f].repeaterUrl&&delete b[0][f].repeaterUrl;b[0][f].hasOwnProperty("utmDropShip")&&"string"!=typeof b[0][f].utmDropShip&&
(g+="\nConfig Array element number "+f+" have incorrect parameter utmDropShip",e=1);b[0][f].hasOwnProperty("title")&&"string"!=typeof b[0][f].title&&(g+="\nConfig Array element number "+f+" have incorrect parameter title",e=1);b[0][f].hasOwnProperty("description")&&"string"!=typeof b[0][f].description&&(g+="\nConfig Array element number "+f+" have incorrect parameter description",e=1);b[0][f].hasOwnProperty("CHARSET")&&"string"==typeof b[0][f].CHARSET||(g+="\nConfig Array element number "+f+" have incorrect parameter CHARSET",
e=1);b[0][f].hasOwnProperty("scanFun")&&"function"!=typeof b[0][f].scanFun&&(g+="\nConfig Array element number "+f+" have incorrect parameter scanFun",e=1);b[0][f].hasOwnProperty("startInitFun")&&"function"!=typeof b[0][f].startInitFun&&(g+="\nConfig Array element number "+f+" have incorrect parameter startInitFun",e=1);b[0][f].hasOwnProperty("endInitFun")&&"function"!=typeof b[0][f].endInitFun&&(g+="\nConfig Array element number "+f+" have incorrect parameter endInitFun",e=1);b[0][f].hasOwnProperty("firstNewPages")&&
("number"!=typeof b[0][f].firstNewPages||0>b[0][f].firstNewPages)&&(g+="\nConfig Array element number "+f+" have incorrect parameter firstNewPages",e=1);b[0][f].hasOwnProperty("reverseNewUrls")&&("number"!=typeof b[0][f].reverseNewUrls||0>b[0][f].reverseNewUrls)&&(g+="\nConfig Array element number "+f+" have incorrect parameter reverseNewUrls",e=1);b[0][f].hasOwnProperty("Debug_On")&&("number"!=typeof b[0][f].Debug_On||0>b[0][f].Debug_On)&&(g+="\nConfig Array element number "+f+" have incorrect parameter Debug_On",
e=1);b[0][f].hasOwnProperty("No_Critical_Errors")&&("number"!=typeof b[0][f].No_Critical_Errors||0>b[0][f].No_Critical_Errors||5<b[0][f].No_Critical_Errors)&&(g+="\nConfig Array element number "+f+" have incorrect parameter No_Critical_Errors",e=1);b[0][f].hasOwnProperty("Write_emptyFeed_File")&&("number"!=typeof b[0][f].Write_emptyFeed_File||0>b[0][f].Write_emptyFeed_File||2<b[0][f].Write_emptyFeed_File)&&(g+="\nConfig Array element number "+f+" have incorrect parameter Write_emptyFeed_File",e=1);
CONTROL_EMPTY_FEEDS&&(b[0][f].Write_emptyFeed_File=1);if(b[0][f].hasOwnProperty("CSVSITE"))if("[object Array]"!=={}.toString.call(b[0][f].CSVSITE))g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE",e=1;else{b[0][f].CSVConfig={};var O=b[0][f].CSVSITE;"number"!==typeof O[0]||0>O[0]||1<O[0]?(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE[0] (parseUrls)",e=1):b[0][f].CSVConfig.parseUrls=O[0];O[1]&&"[object Array]"==={}.toString.call(O[1])?b[0][f].CSVConfig.skip_errors=
O[1]:(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE[1] (skip_errors)",e=1);"number"!==typeof O[2]||0>O[2]?(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE[2] (MAX_TRIES)",e=1):b[0][f].CSVConfig.MAX_TRIES=O[2];"number"!==typeof O[3]||0>O[3]?(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE[3] (REQUEST_DELAY)",e=1):b[0][f].CSVConfig.REQUEST_DELAY=O[3];"string"!==typeof O[4]?(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE[4] (repeaterUrl)",
e=1):O[4]&&(/\/$/.test(O[4])||(O[4]+="/"),O[4]+="srvrepeat.php",(S=parse_url(O[4]))&&S.host&&S.protocol&&S.pathname&&!S.search&&!S.hash?(O[4]+="?url=",b[0][f].CSVConfig.repeaterUrl=O[4]):(g+="\nConfig Array element number "+f+" is not have correct parameter CSVSITE[4] (repeaterUrl)",e=1));if(6>O.length)g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE[5] (Url Array)",e=1;else for(b[0][f].CSVConfig.CSVurls=[],B=5;B<O.length;B++)if("[object Array]"!=={}.toString.call(O[B])||7!=
O[B].length)g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"] (Urls Array)",e=1;else{var aa=b[0][f].CSVConfig.CSVurls.length;b[0][f].CSVConfig.CSVurls[aa]={};var T=b[0][f].CSVConfig.CSVurls[aa],da={};if("string"===typeof O[B][0]&&O[B][0]){T.url=O[B][0];/\s/.test(T.url)&&(g+="\nConfig Array element number "+f+" have space in parameter CSVSITE["+B+"][0] (CSVUrl in Url Array)",e=1);var D=parse_url(T.url);D.hostname&&D.protocol||(g+="\nConfig Array element number "+f+" is not have correct parameter CSVSITE["+
B+"][0] (CSVUrl in Url Array)",e=1);da[T.url]?v+="\nConfig Array element number "+f+" have dublicate URL in parameter CSVSITE["+B+"][0] (CSVUrl in Url Array)":da[T.url]=1}else g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][0] (CSVUrl in Url Array)",e=1;"string"===typeof O[B][1]&&O[B][1]?T.CHARSET=O[B][1]:(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][1] (CHARSET in Url Array)",e=1);var Q=0;if("[object Object]"!=={}.toString.call(O[B][6]))g+=
"\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][6] (csvParserConfig in Url Array)",e=1;else{if(O[B][6].hasOwnProperty("xml"))if(Q=1,"[object Array]"!=={}.toString.call(O[B][6].xml))g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][6] (xml in csvParserConfig in Url Array)",e=1;else if(O[B][6].xml.length)for(var R=0;R<O[B][6].xml.length;R++)"string"==typeof O[B][6].xml[R]&&O[B][6].xml[R]||(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+
B+"][6].xml["+R+"] (in xml in csvParserConfig in Url Array)",e=1);else g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][6] (xml in csvParserConfig in Url Array)",e=1;T.csvParserConfig=O[B][6]}if("[object Array]"!=={}.toString.call(O[B][2])||2<O[B][2].length)g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][2] (url_column_replace in Url Array)",e=1;else{T.url_column_replace=O[B][2];if(Q)if("[object Array]"!=={}.toString.call(O[B][2][0]))g+=
"\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][2][0] (url_column_replace in Url Array)",e=1;else if(O[B][2][0].length)for(R=0;R<O[B][2][0].length;R++)"string"==typeof O[B][2][0][R]&&O[B][2][0][R]||(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][2][0]["+R+"] (url_column_replace in Url Array)",e=1);else g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][2][0] (url_column_replace in Url Array)",e=1;else if("number"!==
typeof O[B][2][0]||0>O[B][2][0])g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][2][0] (url_column_replace in Url Array)",e=1;"undefined"==typeof O[B][2][1]?O[B][2].length=1:"function"!==typeof O[B][2][1]&&(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][2][1] (url_column_replace in Url Array)",e=1)}if("[object Array]"!=={}.toString.call(O[B][3])||2<O[B][3].length||1==O[B][3].length)g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+
B+"][3] (onlySeparator in Url Array)",e=1;else if(T.onlySeparator=O[B][3],O[B][3].length){if(Q)if("[object Array]"!=={}.toString.call(O[B][3][0]))g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][3][0] (onlySeparator in Url Array)",e=1;else if(O[B][3][0].length)for(R=0;R<O[B][3][0].length;R++)"string"==typeof O[B][3][0][R]&&O[B][3][0][R]||(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][3][0]["+R+"] (onlySeparator in Url Array)",e=1);else g+=
"\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][3][0] (onlySeparator in Url Array)",e=1;else if("number"!==typeof O[B][3][0]||0>O[B][3][0])g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][3][0] (onlySeparator in Url Array)",e=1;if("[object Array]"==={}.toString.call(O[B][3][1])&&O[B][3][1].length){var Z=0;for(R=0;R<O[B][3][1].length;R++)if(O[B][3][1][R]){var sa={}.toString.call(O[B][3][1][R]);if("[object String]"!=sa&&"[object RegExp]"!=
sa){Z=1;break}}else{Z=1;break}Z&&(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][3][1] (onlySeparator in Url Array)",e=1)}else g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][3][1] (onlySeparator in Url Array)",e=1}if("[object Array]"!=={}.toString.call(O[B][4])||2<O[B][4].length||1==O[B][4].length)g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][4] (skipSeparator in Url Array)",e=1;else if(T.skipSeparator=
O[B][4],O[B][4].length){if(Q)if("[object Array]"!=={}.toString.call(O[B][4][0]))g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][4][0] (skipSeparator in Url Array)",e=1;else if(O[B][4][0].length)for(R=0;R<O[B][4][0].length;R++)"string"==typeof O[B][4][0][R]&&O[B][4][0][R]||(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][4][0]["+R+"] (skipSeparator in Url Array)",e=1);else g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+
B+"][4][0] (skipSeparator in Url Array)",e=1;else if("number"!==typeof O[B][4][0]||0>O[B][4][0])g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][4][0] (skipSeparator in Url Array)",e=1;if("[object Array]"==={}.toString.call(O[B][4][1])&&O[B][4][1].length){for(R=Z=0;R<O[B][4][1].length;R++)if(O[B][4][1][R]){if(sa={}.toString.call(O[B][4][1][R]),"[object String]"!=sa&&"[object RegExp]"!=sa){Z=1;break}}else{Z=1;break}Z&&(g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+
B+"][4][1] (skipSeparator in Url Array)",e=1)}else g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][4][1] (skipSeparator in Url Array)",e=1}if("[object Array]"!=={}.toString.call(O[B][5])||2<O[B][5].length)g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][5] (StartEndLines in Url Array)",e=1;else if(T.StartEndLines=O[B][5],!O[B][5].length)T.StartEndLines=[0,0];else if("number"!==typeof O[B][5][0]||0>O[B][5][0])g+="\nConfig Array element number "+
f+" have incorrect parameter CSVSITE["+B+"][5][0] (StartEndLines in Url Array)",e=1;else if(1==O[B][5].length)T.StartEndLines=[O[B][5][0],0];else if("number"!==typeof O[B][5][1]||0>O[B][5][1]||O[B][5][0]>O[B][5][1])g+="\nConfig Array element number "+f+" have incorrect parameter CSVSITE["+B+"][5][0] (StartEndLines in Url Array)",e=1}}CONTROL_EMPTY_FEEDS&&(b[0][f].hasOwnProperty("CSVSITE")&&delete b[0][f].CSVSITE,b[0][f].hasOwnProperty("CSVConfig")&&delete b[0][f].CSVConfig);if(b[0][f].hasOwnProperty("addscanUrls"))if("[object Array]"!==
{}.toString.call(b[0][f].addscanUrls))g+="\nConfig Array element number "+f+" have incorrect parameter addscanUrls",e=1;else if(b[0][f].addscanUrls.length){var V=b[0][f].hasOwnProperty("valid_scheme")&&"[object Array]"!=={}.toString.call(b[0][f].valid_scheme)?null:b[0][f].valid_scheme;for(B=0;B<b[0][f].addscanUrls.length;B++)if("string"==typeof b[0][f].addscanUrls[B]&&b[0][f].addscanUrls[B]){var fa=parse_url(b[0][f].addscanUrls[B]);if(!fa||fa.hostname&&fa.hostname!==J.hostname)g+="\nConfig Array element number "+
f+" have incorrect parameter addscanUrls["+B+"]",e=1;else if(fa&&fa.protocol&&V){var oa=fa.protocol;if(V&&V.length&&oa){var ha=0,ia;for(ia in V)V[ia]==oa&&(ha=1);ha||(g+="\nConfig Array element number "+f+" have incorrect parameter addscanUrls["+B+"]",e=1)}}}else g+="\nConfig Array element number "+f+" have incorrect parameter addscanUrls["+B+"]",e=1}else g+="\nConfig Array element number "+f+" have incorrect parameter addscanUrls",e=1;CONTROL_EMPTY_FEEDS&&b[0][f].hasOwnProperty("addscanUrls")&&delete b[0][f].addscanUrls;
if(b[0][f].hasOwnProperty("scanSelectors"))if("[object Array]"!=={}.toString.call(b[0][f].scanSelectors))g+="\nConfig Array element number "+f+" have incorrect parameter scanSelectors",e=1;else if(b[0][f].scanSelectors.length)for(B=0;B<b[0][f].scanSelectors.length;B++)"string"==typeof b[0][f].scanSelectors[B]&&b[0][f].scanSelectors[B]||(g+="\nConfig Array element number "+f+" have incorrect parameter scanSelectors["+B+"]",e=1);else g+="\nConfig Array element number "+f+" have incorrect parameter scanSelectors",
e=1;if(b[0][f].hasOwnProperty("onlyORskipSeparators"))if("[object Array]"=={}.toString.call(b[0][f].onlyORskipSeparators))if(b[0][f].onlyORskipSeparators.length)for(var ja=0;ja<b[0][f].onlyORskipSeparators.length;ja++)if(3==b[0][f].onlyORskipSeparators[ja].length||4==b[0][f].onlyORskipSeparators[ja].length){var Ga={}.toString.call(b[0][f].onlyORskipSeparators[ja][0]),ka={}.toString.call(b[0][f].onlyORskipSeparators[ja][1]),za={}.toString.call(b[0][f].onlyORskipSeparators[ja][2]),Ha=typeof b[0][f].onlyORskipSeparators[ja][3];
if("[object Array]"==Ga&&"[object Array]"==ka&&"[object Array]"==za&&("function"==Ha||"undefined"==Ha)&&b[0][f].onlyORskipSeparators[ja][0].length&&3>b[0][f].onlyORskipSeparators[ja][0].length&&b[0][f].onlyORskipSeparators[ja][0][0]){for(B=Z=0;B<b[0][f].onlyORskipSeparators[ja][0].length;B++){var Aa=b[0][f].onlyORskipSeparators[ja][0][B];if(Aa){if("[object String]"!={}.toString.call(Aa)&&"[object RegExp]"!={}.toString.call(Aa)){Z=1;break}}else{Z=1;break}}for(B=0;B<b[0][f].onlyORskipSeparators[ja][1].length;B++)if(Aa=
b[0][f].onlyORskipSeparators[ja][1][B]){if("[object String]"!={}.toString.call(Aa)&&"[object RegExp]"!={}.toString.call(Aa)){Z=1;break}}else{Z=1;break}for(B=0;B<b[0][f].onlyORskipSeparators[ja][2].length;B++)if(Aa){if(Aa=b[0][f].onlyORskipSeparators[ja][2][B],"[object String]"!={}.toString.call(Aa)&&"[object RegExp]"!={}.toString.call(Aa)){Z=1;break}}else{Z=1;break}if("function"==Ha)try{b[0][f].onlyORskipSeparators[ja][3]("   ")}catch(pb){Z=1}Z?(g+="\nConfig Array element number "+f+" have incorrect parameter onlyORskipSeparators",
e=1):b[0][f].onlyORskipSeparators[ja][1].length||b[0][f].onlyORskipSeparators[ja][2].length||b[0][f].onlyORskipSeparators[ja][3]||(b[0][f].onlyORskipSeparators[ja].length=1)}else g+="\nConfig Array element number "+f+" have incorrect parameter onlyORskipSeparators",e=1}else g+="\nConfig Array element number "+f+" have incorrect parameter onlyORskipSeparators",e=1;else g+="\nConfig Array element number "+f+" have incorrect parameter onlyORskipSeparators",e=1;else g+="\nConfig Array element number "+
f+" have incorrect parameter onlyORskipSeparators",e=1;b[0][f].hasOwnProperty("noSeparatorsNotScanUrls")&&(b[0][f].hasOwnProperty("onlyORskipSeparators")?"number"==typeof b[0][f].noSeparatorsNotScanUrls&&0<=b[0][f].noSeparatorsNotScanUrls||(g+="\nConfig Array element number "+f+" have incorrect parameter noSeparatorsNotScanUrls",e=1):(g+="\nConfig Array element number "+f+" have parameter noSeparatorsNotScanUrls without parameter onlyORskipSeparators",e=1));b[0][f].hasOwnProperty("valid_scheme")&&
"[object Array]"!=={}.toString.call(b[0][f].valid_scheme)&&(g+="\nConfig Array element number "+f+" have incorrect parameter valid_scheme",e=1);if(b[0][f].hasOwnProperty("skip_query")&&"[object Array]"!=={}.toString.call(b[0][f].skip_query))g+="\nConfig Array element number "+f+" have incorrect parameter skip_query",e=1;else{var na=b[0][f].skip_query;if(na&&na.length)for(ia in na){var la=parse_url(na[ia]);"object"!=typeof la?(g+="\nConfig Array element number "+f+" have incorrect parameter skip_query",
e=1):la.hash||la.protocol||la.hostname||la.port?(g+="\nConfig Array element number "+f+" have incorrect parameter skip_query "+la,e=1):"/"!=la.pathname.substr(0,1)&&(g+="\nConfig Array element number "+f+" have incorrect parameter skip_query "+la,e=1)}}if(b[0][f].hasOwnProperty("only_query")&&"[object Array]"!=={}.toString.call(b[0][f].only_query))g+="\nConfig Array element number "+f+" have incorrect parameter only_query",e=1;else{var qa=b[0][f].only_query;if(qa&&qa.length)for(ia in qa)la=parse_url(qa[ia]),
"object"!=typeof la?(g+="\nConfig Array element number "+f+" have incorrect parameter only_query",e=1):la.hash||la.protocol||la.hostname||la.port?(g+="\nConfig Array element number "+f+" have incorrect parameter only_query "+la,e=1):"/"!=la.pathname.substr(0,1)&&(g+="\nConfig Array element number "+f+" have incorrect parameter only_query "+la,e=1)}b[0][f].hasOwnProperty("skip_errors")&&"[object Array]"!=={}.toString.call(b[0][f].skip_errors)&&(g+="\nConfig Array element number "+f+" have incorrect parameter skip_errors",
e=1);b[0][f].hasOwnProperty("repeat_errors")&&"[object Array]"!=={}.toString.call(b[0][f].repeat_errors)&&(g+="\nConfig Array element number "+f+" have incorrect parameter repeat_errors",e=1);b[0][f].shortWordsHash={};if(b[0][f].hasOwnProperty("shortWords"))if("[object Array]"!=={}.toString.call(b[0][f].shortWords))g+="\nConfig Array element number "+f+" have incorrect parameter shortWords",e=1;else{var db=0;for(B=0;B<b[0][f].shortWords.length;B++)b[0][f].shortWords[B]&&"string"==typeof b[0][f].shortWords[B]?
b[0][f].shortWordsHash[b[0][f].shortWords[B].toLowerCase()]=1:db=1;db&&(g+="\nConfig Array element number "+f+" have incorrect parameter shortWords",e=1)}b[0][f].hasOwnProperty("REQUEST_DELAY")&&("number"!=typeof b[0][f].REQUEST_DELAY||0>=b[0][f].REQUEST_DELAY)&&(g+="\nConfig Array element number "+f+" have incorrect parameter REQUEST_DELAY",e=1);b[0][f].hasOwnProperty("MAX_TRIES")&&("number"!=typeof b[0][f].MAX_TRIES||0>=b[0][f].MAX_TRIES)&&(g+="\nConfig Array element number "+f+" have incorrect parameter MAX_TRIES",
e=1);b[0][f].hasOwnProperty("MAX_CHECKED_URLS")&&("number"!=typeof b[0][f].MAX_CHECKED_URLS||0>b[0][f].MAX_CHECKED_URLS)&&(g+="\nConfig Array element number "+f+" have incorrect parameter MAX_CHECKED_URLS",e=1);CONTROL_EMPTY_FEEDS&&(b[0][f].MAX_CHECKED_URLS=1);var ra=1;if(!b[0][f].hasOwnProperty("Id")||"string"==typeof b[0][f].Id){ra=0;var Ia=b[0][f].Id;(Ia="string"==typeof Ia&&Ia?Ia.toLowerCase():"")?isInteger(Ia)&&(Ia="id"+Ia):Ia=J.hostname;Ia=Ia.replace(/\.+/igm,"");b[0][f].Id=Ia;/\s/.test(Ia)&&
(g+="\nConfig Array element number "+f+" have space in parameter Id",e=1)}b[0][f].Id=idndomain(b[0][f].Id);b[0][f].Id=b[0][f].Id.replace(/[^a-z0-9_\-\.]+/igm,"");if(b[0][f].hasOwnProperty("priorityLev"))"number"!=typeof b[0][f].priorityLev?(Fa=0,g+="\nConfig Array element number "+f+" have incorrect parameter priorityLev",e=1):isInteger(b[0][f].priorityLev)?Fa=b[0][f].priorityLev:(Fa=0,g+="\nConfig Array element number "+f+" have incorrect parameter priorityLev",e=1);else var Fa=0;b[0][f].priorityLev=
Fa;var Bb=0,yb={},Cb={},Oa=0,E;for(E in b[0][f]){var Wa=function(pb,gb,wb){var qb=0,mb="";if("[object Array]"==={}.toString.call(gb)&&0<gb.length)if(mb="array3","string"==typeof gb[0])if(4>gb.length)for(var Ua=0;Ua<gb.length;Ua++)"string"!=typeof gb[Ua]&&(wb+="\nbad parameter: "+pb+" in GASearch",qb=1);else wb+="\nbad parameter: "+pb+" in GASearch",qb=1;else if("keys"!=pb||"[object Array]"!=={}.toString.call(gb[0])&&"function"!==typeof gb[0])wb+="\nbad parameter: "+pb+" in GASearch",qb=1;else for(mb=
[],Ua=0;Ua<gb.length;Ua++)if("[object Array]"==={}.toString.call(gb[Ua])&&0<gb[Ua].length&&4>gb[Ua].length){mb[Ua]="array3";for(var nb=0;nb<gb[Ua].length;nb++)"string"!=typeof gb[Ua][nb]&&(wb+="\nbad parameter: "+pb+" in GASearch",qb=1)}else"function"===typeof gb[Ua]?mb[Ua]="function":(mb[Ua]="",wb+="\nbad parameter: "+pb+" in GASearch",qb=1);else"function"===typeof gb?mb="function":(wb+="\nbad parameter: "+pb+" in GASearch",qb=1);return[qb,wb,mb]};if("string"==typeof E&&/^id\d+$/.test(E)){if("[object Object]"!==
{}.toString.call(b[0][f][E])){g+="\nFeed number "+E+" in Config Array element number "+f+" is not Hash";e=1;break}b[0][f].feeds||(b[0][f].feeds={});b[0][f].feeds[E]=1;var ea=b[0][f][E].ext;(ea="string"==typeof ea&&ea?ea.toLowerCase():"")||(ea=E);ea=ea.replace(/\.+/igm,"");/\s/.test(ea)&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have space in ext "+ea,e=1);ea=idndomain(ea);ea=ea.replace(/[^a-z0-9_\-\.]+/igm,"");b[0][f][E].ext=ea;yb.hasOwnProperty(ea)?(g+="\nFeed number "+E+" in Config Array element number "+
f+" have dublicate ext "+ea,e=1):yb[ea]=1;b[0][f][E].feedId=b[0][f].Id+".feed."+ea;Cb.hasOwnProperty(b[0][f][E].feedId)?(g+="\nFeed number "+E+" in Config Array element number "+f+" have dublicated feedId  "+b[0][f][E].feedId,e=1):Cb[b[0][f][E].feedId]=J.hostname;if(b[0][f][E].ftp&&b[0][f][E].ftp.zipfilename){var ba=b[0][f][E].ftp.zipfilename;A.hasOwnProperty(ba)?(g+="\nFeed number "+E+" in Config Array element number "+f+" have dublicate zipfilename "+ba,e=1):A[ba]=1}b[0][f][E].hasOwnProperty("keyword")&&
"string"!==typeof b[0][f][E].keyword&&(g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct parameter keyword",e=1);if(b[0][f][E].hasOwnProperty("childAddByRank"))if(!b[0][f][E].hasOwnProperty("parentFeed"))g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter childAddByRank (without parentFeed)",e=1;else if("number"!=typeof b[0][f][E].childAddByRank||0>b[0][f][E].childAddByRank)g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter childAddByRank",
e=1;if(b[0][f][E].hasOwnProperty("parentFeed")){var Va=0;"string"!=typeof b[0][f][E].parentFeed?Va=1:b[0][f][E].parentFeed?b[0][f][E].parentFeed==E?Va=1:b[0][f].feeds[b[0][f][E].parentFeed]||(Va=1):Va=1;if(Va)g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter parentFeed",e=1,delete b[0][f][E].parentFeed;else{var ib=b[0][f][b[0][f][E].parentFeed];ib.childrenFeeds||(ib.childrenFeeds=[]);ib.childrenFeeds[ib.childrenFeeds.length]=E;b[0][f][E].childAddByRank||b[0][f][b[0][f][E].parentFeed]&&
(b[0][f][b[0][f][E].parentFeed].ExistNotUsechildAddByRank=1)}}var wa={},xb=0;if(b[0][f][E].parentFeed){var va=JSON.parse(JSON.stringify(b[0][f][b[0][f][E].parentFeed].timeHours));b[0][f][E].hasOwnProperty("timeHours")&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have parameter timeHours in children feed, remove it",e=1)}else b[0][f][E].hasOwnProperty("timeHours")?b[0][f][E].timeHours?"string"!=typeof b[0][f][E].timeHours?(va=[],xb=1):va="test"===b[0][f][E].timeHours?["test"]:b[0][f][E].timeHours.split(/[\s,]+/):
va=["0"]:va=JSON.parse(JSON.stringify(I));xb&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter timeHours",e=1);for(B=0;B<va.length;B++)if(isInteger(va[B])){if(va[B]=parseInt(va[B]),wa[va[B]]=1,0>va[B]||23<va[B])g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter timeHours "+va[B],e=1}else"test"==va[B]&&1==va.length?wa[va[B]]=1:(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter timeHours",e=
1);b[0][f][E].timeHours=JSON.parse(JSON.stringify(va));b[0][f][E].timeHoursHash=JSON.parse(JSON.stringify(wa));CONTROL_EMPTY_FEEDS&&(wa={},va=["0"],va[0]=parseInt(va[0]),wa[va[0]]=1,b[0][f][E].timeHours=JSON.parse(JSON.stringify(va)),b[0][f][E].timeHoursHash=JSON.parse(JSON.stringify(wa)));for(B=0;B<va.length;B++)b[0][f].timeHoursHash[va[B]]||(b[0][f].timeHoursHash[va[B]]=1,b[0][f].timeHours[b[0][f].timeHours.length]=va[B]);if(b[0][f][E].timeHours&&-1!=b[0][f][E].timeHours.indexOf("test")&&1==b[0][f][E].timeHours.length)b[0][f][E].hasOwnProperty("all_fields_not_required")||
(b[0][f][E].all_fields_not_required=b[0][f].all_fields_not_required);else{var jb=0;b[0][f][E].hasOwnProperty("all_fields_not_required")||(b[0][f][E].all_fields_not_required=b[0][f].all_fields_not_required,jb=1);b[0][f][E].all_fields_not_required?jb?Bb||(Bb=1,g+="\nConfig Array element number "+f+" have parameter all_fields_not_required without 'test' in timeHours, remove it or add  'test' in timeHours",e=1):(g+="\nFeed number "+E+" in Config Array element number "+f+" have parameter all_fields_not_required without 'test' in timeHours, remove it or add  'test' in timeHours",
e=1):b[0][f][E].all_fields_not_required=0}var Za={},ca=0;if(b[0][f][E].parentFeed){var Y=JSON.parse(JSON.stringify(b[0][f][b[0][f][E].parentFeed].startDays));b[0][f][E].hasOwnProperty("startDays")&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have parameter startDays in children feed, remove it",e=1)}else b[0][f][E].hasOwnProperty("startDays")?b[0][f][E].startDays?"string"!=typeof b[0][f][E].startDays?(Y=[],ca=1):Y=b[0][f][E].startDays.split(/[\s,]+/):Y=[]:Y=JSON.parse(JSON.stringify(X));
ca&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter startDays",e=1);for(B=0;B<Y.length;B++)if(isInteger(Y[B])){if(Y[B]=parseInt(Y[B]),Za[Y[B]]=1,1>Y[B]||31<Y[B])g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter startDays "+Y[B],e=1}else g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter startDays",e=1;b[0][f][E].startDays=JSON.parse(JSON.stringify(Y));b[0][f][E].startDaysHash=JSON.parse(JSON.stringify(Za));
CONTROL_EMPTY_FEEDS&&(Za={},Y=[],b[0][f][E].startDays=JSON.parse(JSON.stringify(Y)),b[0][f][E].startDaysHash=JSON.parse(JSON.stringify(Za)));if(!Y.length)b[0][f].startDays=[],b[0][f].startDaysHash={};else if(!b[0][f].startDays)b[0][f].startDays=JSON.parse(JSON.stringify(Y)),b[0][f].startDaysHash=JSON.parse(JSON.stringify(Za));else if(b[0][f].startDays.length)for(B=0;B<Y.length;B++)b[0][f].startDaysHash[Y[B]]||(b[0][f].startDaysHash[Y[B]]=1,b[0][f].startDays[b[0][f].startDays.length]=Y[B]);b[0][f][E].hasOwnProperty("noDropShip")||
b[0][f].hasOwnProperty("noDropShip")&&(b[0][f][E].noDropShip=b[0][f].noDropShip);b[0][f][E].hasOwnProperty("utmDropShip")?"string"!=typeof b[0][f][E].utmDropShip&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter utmDropShip",e=1):b[0][f].hasOwnProperty("utmDropShip")&&(b[0][f][E].utmDropShip=b[0][f].utmDropShip);if(b[0][f][E].hasOwnProperty("file_type")){var Ca=b[0][f][E].file_type;if("[object Array]"!=={}.toString.call(Ca))g+="\nFeed number "+E+" in Config Array element number "+
f+" have incorrect parameter file_type",e=1;else for(B=0;B<Ca.length;B++)if("string"!=typeof Ca[B]||-1==C.indexOf(Ca[B]))g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter file_type",e=1}if(b[0][f][E].hasOwnProperty("ftp")){var M=b[0][f][E].ftp;M.login&&M.password&&M.host&&M.files_types&&M.files_types.length||(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter ftp",e=1)}if(b[0][f][E].hasOwnProperty("skip_parse")&&"[object Array]"!==
{}.toString.call(b[0][f][E].skip_parse))g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter skip_parse",e=1;else if((na=b[0][f].skip_parse)&&na.length)for(ia in na)la=parse_url(na[ia]),"string"!=typeof la?(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter skip_parse",e=1):la.hash||la.protocol||la.hostname||la.port?(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter skip_parse "+la,e=1):"/"!=la.pathname.substr(0,
1)&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter skip_parse "+la,e=1);if(b[0][f][E].hasOwnProperty("only_parse")&&"[object Array]"!=={}.toString.call(b[0][f][E].only_parse))g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter only_parse",e=1;else if((qa=b[0][f].only_parse)&&qa.length)for(ia in qa)la=parse_url(qa[ia]),"string"!=typeof la?(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter only_parse",
e=1):la.hash||la.protocol||la.hostname||la.port?(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter only_parse "+la,e=1):"/"!=la.pathname.substr(0,1)&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter only_parse "+la,e=1);b[0][f][E].hasOwnProperty("parseUrlFun")&&"function"!=typeof b[0][f][E].parseUrlFun&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter parseUrlFun",e=1);b[0][f][E].hasOwnProperty("checkFieldsFun")&&
"function"!=typeof b[0][f][E].checkFieldsFun&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter checkFieldsFun",e=1);b[0][f][E].hasOwnProperty("MAX_ADD_URLS")&&("number"!=typeof b[0][f][E].MAX_ADD_URLS||0>b[0][f][E].MAX_ADD_URLS)&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter MAX_ADD_URLS",e=1);if(!b[0][f][E].hasOwnProperty("No_Critical_Errors"))b[0][f].hasOwnProperty("No_Critical_Errors")&&(b[0][f][E].No_Critical_Errors=
b[0][f].No_Critical_Errors);else if("number"!=typeof b[0][f][E].No_Critical_Errors||0>b[0][f][E].No_Critical_Errors||5<b[0][f][E].No_Critical_Errors)g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter No_Critical_Errors",e=1;if(!b[0][f][E].hasOwnProperty("Write_emptyFeed_File"))b[0][f].hasOwnProperty("Write_emptyFeed_File")&&(b[0][f][E].Write_emptyFeed_File=b[0][f].Write_emptyFeed_File);else if("number"!=typeof b[0][f][E].Write_emptyFeed_File||0>b[0][f][E].Write_emptyFeed_File||
2<b[0][f][E].Write_emptyFeed_File)g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter Write_emptyFeed_File",e=1;CONTROL_EMPTY_FEEDS&&(b[0][f][E].Write_emptyFeed_File=1);b[0][f][E].hasOwnProperty("SKIP_FIRST_URLS")&&("number"!=typeof b[0][f][E].SKIP_FIRST_URLS||0>b[0][f][E].SKIP_FIRST_URLS)&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter SKIP_FIRST_URLS",e=1);var H=b[0][f][E].GASearch;if(H&&"[object Object]"!=={}.toString.call(H))g+=
"\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter 'GASearch'",e=1;else if(H){if(H.hasOwnProperty("Id"))if("string"!=typeof H.Id)g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter 'Id' in 'GASearch'",e=1;else{(H.Idmanual=H.Id)||(H.Id=b[0][f][E].feedId);H.Id=H.Id.replace(/[^!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'\(\)" ]+/g,"");100<H.Id.length&&(g+="\nFeed number "+E+" in Config Array element number "+f+" very long (> 100 chars) parameter 'Id' in 'GASearch' "+
H.Id,e=1);w.hasOwnProperty(H.Id)?(g+="\nFeed number "+E+" in Config Array element number "+f+" have dublicate parameter 'Id' in 'GASearch' "+H.Id,e=1):w[H.Id]=1;if(!H.hasOwnProperty("Budget")||"number"!==typeof H.Budget||0>=H.Budget)g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect parameter 'Budget' in 'GASearch' "+H.Id,e=1;H.hasOwnProperty("keyword")&&"string"!==typeof H.keyword&&(g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'keyword' in 'GASearch' ",
e=1);!H.hasOwnProperty("removeOutOfStockItem")||"[object Array]"==={}.toString.call(H.removeOutOfStockItem)&&3==H.removeOutOfStockItem.length||(g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'removeOutOfStockItem' in 'GASearch' ",e=1);CONTROL_EMPTY_FEEDS&&"[object Array]"==={}.toString.call(H.removeOutOfStockItem)&&2==H.removeOutOfStockItem[0]&&(H.removeOutOfStockItem[0]=1);H.hasOwnProperty("removeNotFoundItem")&&"number"!=typeof H.removeNotFoundItem&&(g+="\nFeed number "+
E+" in Config Array element number "+f+" not have correct 'removeNotFoundItem' in 'GASearch' ",e=1);if(H.hasOwnProperty("removeLSVKeywords")){if("number"!=typeof H.removeLSVKeywords||!/^\d+$/.test(String(H.removeLSVKeywords))||0>H.removeLSVKeywords||2<H.removeLSVKeywords)g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'removeLSVKeywords' in 'GASearch' ",e=1}else H.removeLSVKeywords=0;H.hasOwnProperty("powerControl")&&"number"!=typeof H.powerControl&&(g+="\nFeed number "+
E+" in Config Array element number "+f+" not have correct 'powerControl' in 'GASearch' ",e=1);if(!H.hasOwnProperty("addkeystype")||"number"!=typeof H.addkeystype||!/^\d+$/.test(String(H.addkeystype))||0>H.addkeystype||8<H.addkeystype)g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'addkeystype' in 'GASearch' ",e=1;if(!H.hasOwnProperty("maxNodigaddkeyNum")||"number"!=typeof H.maxNodigaddkeyNum||!/^\d+$/.test(String(H.maxNodigaddkeyNum))||3>H.maxNodigaddkeyNum)g+="\nFeed number "+
E+" in Config Array element number "+f+" not have correct 'maxNodigaddkeyNum' in 'GASearch' ",e=1;if(!H.hasOwnProperty("keywordtypes")||"number"!=typeof H.keywordtypes||!/^\d+$/.test(String(H.keywordtypes))||0>H.keywordtypes||6<H.keywordtypes)g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'keywordtypes' in 'GASearch' ",e=1;if(!H.hasOwnProperty("modifykeystype")||"number"!=typeof H.modifykeystype||!/^\d+$/.test(String(H.modifykeystype))||0>H.modifykeystype||3<H.modifykeystype)g+=
"\nFeed number "+E+" in Config Array element number "+f+" not have correct 'modifykeystype' in 'GASearch' ",e=1;if(!H.hasOwnProperty("modifykeysEnable")||"number"!=typeof H.modifykeysEnable||!/^\d+$/.test(String(H.modifykeysEnable))||0>H.modifykeysEnable||2<H.modifykeysEnable)g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'modifykeysEnable' in 'GASearch' ",e=1;if(!H.priceRound||"number"!=typeof H.priceRound||0>H.priceRound)g+="\nFeed number "+E+" in Config Array element number "+
f+" not have correct 'priceRound' in 'GASearch' ",e=1;if(!H.hasOwnProperty("startbid")||"number"!=typeof H.startbid||0>=H.startbid)g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'startbid' in 'GASearch' ",e=1;H.hasOwnProperty("header2")||(H.header2=[J.hostname]);var Qa=J.hostname;Qa=Qa.substring(0,30);H.header3="{KeyWord:"+Qa+"}";H.hasOwnProperty("keysmixtype")&&("number"!=typeof H.keysmixtype||0>H.keysmixtype||4<H.keysmixtype)?(g+="\nFeed number "+E+" in Config Array element number "+
f+" not have correct 'keysmixtype' in 'GASearch' ",e=1):H.keysmixtype||(H.keysmixtype=0);H.hasOwnProperty("masskeysmixtype")&&("number"!=typeof H.masskeysmixtype||0>H.masskeysmixtype||4<H.masskeysmixtype)?(g+="\nFeed number "+E+" in Config Array element number "+f+" not have correct 'masskeysmixtype' in 'GASearch' ",e=1):H.masskeysmixtype||(H.masskeysmixtype=0);H.hasOwnProperty("notReqfixedkeys")&&("number"!=typeof H.notReqfixedkeys||0>H.notReqfixedkeys||4<H.notReqfixedkeys)?(g+="\nFeed number "+
E+" in Config Array element number "+f+" not have correct 'notReqfixedkeys' in 'GASearch' ",e=1):H.notReqfixedkeys||(H.notReqfixedkeys=0);var pa="url mobileurl keys fixedkeys masskeys onekeys header paths header2 price description afterdescription".split(" ");H.GASparams=[];for(B=0;B<pa.length;B++)if(H.hasOwnProperty(pa[B])){var bb=$jscomp.makeIterator(Wa(pa[B],H[pa[B]],g)),Da=bb.next().value;g=bb.next().value;var La=bb.next().value;Da&&(g+=", Feed number "+E+" in Config Array element number "+f,
e=1);H.GASparams[H.GASparams.length]=[pa[B],La]}else H.GASparams[H.GASparams.length]=[pa[B],""];H.url||(g+="\nFeed number "+E+" in Config Array element number "+f+" not have 'url' in 'GASearch' "+H.Id,e=1);H.GAShtmlAd?"string"!=typeof H.GAShtmlAd&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect 'GAShtmlAd' in 'GASearch' "+H.Id,e=1):H.GAShtmlAd="Ad";H.GAShtmlComment?"string"!=typeof H.GAShtmlComment&&(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect 'GAShtmlComment' in 'GASearch' "+
H.Id,e=1):H.GAShtmlComment="Examples of keywords. Will be filtered when added to a campaign";H.GAShtmlExt?"string"!=typeof H.GAShtmlExt?(g+="\nFeed number "+E+" in Config Array element number "+f+" have incorrect 'GAShtmlExt' in 'GASearch' "+H.Id,e=1):/^\s+$/.test(H.GAShtmlExt)?H.GAShtmlExt="":/^\s/.test(H.GAShtmlExt)||(H.GAShtmlExt=" "+H.GAShtmlExt):H.GAShtmlExt="";H.adids=[];var Ba=0,L;for(L in H)if("string"==typeof L&&/^id\d+$/.test(L)){if("[object Object]"!=={}.toString.call(H[L])){g+="\nAd number "+
L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not Hash";e=1;break}H[L].hasOwnProperty("priceaddtype")||(H[L].priceaddtype=0);var Ra="header paths header2 keys fixedkeys masskeys onekeys startdescription description beforeprice afterprice afterdescription".split(" ");H[L].GASADparams=[];for(B=0;B<Ra.length;B++)if(H[L].hasOwnProperty(Ra[B])){var kb=$jscomp.makeIterator(Wa(Ra[B],H[L][Ra[B]],g));Da=kb.next().value;g=kb.next().value;La=kb.next().value;Da&&(g+=", Ad number "+
L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f,e=1);H[L].GASADparams[H[L].GASADparams.length]=[Ra[B],La]}else H[L].GASADparams[H[L].GASADparams.length]=[Ra[B],""];H[L].FromGAS={};H[L].hasOwnProperty("header")||(H.hasOwnProperty("header")&&(H[L].header=H.header),H[L].FromGAS.header=1);H[L].hasOwnProperty("paths")||(H.hasOwnProperty("paths")&&(H[L].paths=H.paths),H[L].FromGAS.paths=1);H[L].hasOwnProperty("header2")||(H.hasOwnProperty("header2")&&(H[L].header2=H.header2),H[L].FromGAS.header2=
1);H[L].hasOwnProperty("addkeystype")||(H.hasOwnProperty("addkeystype")&&(H[L].addkeystype=H.addkeystype),H[L].FromGAS.addkeystype=1);H[L].hasOwnProperty("maxNodigaddkeyNum")||(H.hasOwnProperty("maxNodigaddkeyNum")&&(H[L].maxNodigaddkeyNum=H.maxNodigaddkeyNum),H[L].FromGAS.maxNodigaddkeyNum=1);H[L].hasOwnProperty("keys")||(H.hasOwnProperty("keys")&&(H[L].keys=H.keys),H[L].FromGAS.keys=1);H[L].hasOwnProperty("fixedkeys")||(H.hasOwnProperty("fixedkeys")&&(H[L].fixedkeys=H.fixedkeys),H[L].FromGAS.fixedkeys=
1);H[L].hasOwnProperty("masskeys")||(H.hasOwnProperty("masskeys")&&(H[L].masskeys=H.masskeys),H[L].FromGAS.masskeys=1);H[L].hasOwnProperty("onekeys")||(H.hasOwnProperty("onekeys")&&(H[L].onekeys=H.onekeys),H[L].FromGAS.onekeys=1);H[L].hasOwnProperty("description")||(H.hasOwnProperty("description")&&(H[L].description=H.description),H[L].FromGAS.description=1);H[L].hasOwnProperty("afterdescription")||(H.hasOwnProperty("afterdescription")&&(H[L].afterdescription=H.afterdescription),H[L].FromGAS.afterdescription=
1);H[L].hasOwnProperty("noPaths")||(H.hasOwnProperty("noPaths")&&(H[L].noPaths=H.noPaths),H[L].FromGAS.noPaths=1);H[L].hasOwnProperty("afterdescrNeed")||(H.hasOwnProperty("afterdescrNeed")&&(H[L].afterdescrNeed=H.afterdescrNeed),H[L].FromGAS.afterdescrNeed=1);H[L].hasOwnProperty("keysmixtype")||(H.hasOwnProperty("keysmixtype")&&(H[L].keysmixtype=H.keysmixtype),H[L].FromGAS.keysmixtype=1);H[L].hasOwnProperty("masskeysmixtype")||(H.hasOwnProperty("masskeysmixtype")&&(H[L].masskeysmixtype=H.masskeysmixtype),
H[L].FromGAS.masskeysmixtype=1);H[L].hasOwnProperty("notReqfixedkeys")||(H.hasOwnProperty("notReqfixedkeys")&&(H[L].notReqfixedkeys=H.notReqfixedkeys),H[L].FromGAS.notReqfixedkeys=1);H[L].hasOwnProperty("requiredescr")||(H.hasOwnProperty("requiredescr")&&(H[L].requiredescr=H.requiredescr),H[L].FromGAS.requiredescr=1);H[L].hasOwnProperty("keyword")||(H.hasOwnProperty("keyword")&&(H[L].keyword=H.keyword),H[L].FromGAS.keyword=1);H[L].header||(g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+
f+" is not have parameter header",e=1);H[L].keys||H[L].masskeys||H[L].onekeys||(g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have parameter keys",e=1);H[L].hasOwnProperty("priceaddtype")&&"number"==typeof H[L].priceaddtype||(g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have correct parameter priceaddtype",e=1);H[L].hasOwnProperty("headerTo1Line")&&"number"!=typeof H[L].headerTo1Line&&(g+=
"\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have correct parameter headerTo1Line",e=1);if(!H[L].hasOwnProperty("addkeystype")||"number"!=typeof H[L].addkeystype||!/^\d+$/.test(String(H[L].addkeystype))||0>H[L].addkeystype||8<H[L].addkeystype)g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have correct parameter addkeystype",e=1;if(!H[L].hasOwnProperty("maxNodigaddkeyNum")||"number"!=typeof H[L].maxNodigaddkeyNum||
!/^\d+$/.test(String(H[L].maxNodigaddkeyNum))||3>H[L].maxNodigaddkeyNum)g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have correct parameter maxNodigaddkeyNum",e=1;H[L].hasOwnProperty("keysmixtype")&&!H[L].FromGAS.keysmixtype&&("number"!=typeof H[L].keysmixtype||0>H[L].keysmixtype||4<H[L].keysmixtype)?(g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have correct parameter keysmixtype",e=1):
H[L].keysmixtype||(H[L].keysmixtype=0);H[L].hasOwnProperty("masskeysmixtype")&&!H[L].FromGAS.masskeysmixtype&&("number"!=typeof H[L].masskeysmixtype||0>H[L].masskeysmixtype||4<H[L].masskeysmixtype)?(g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have correct parameter masskeysmixtype",e=1):H[L].masskeysmixtype||(H[L].masskeysmixtype=0);H[L].hasOwnProperty("notReqfixedkeys")&&!H[L].FromGAS.notReqfixedkeys&&("number"!=typeof H[L].notReqfixedkeys||
0>H[L].notReqfixedkeys||4<H[L].notReqfixedkeys)?(g+="\nAd number "+L+" in 'GASearch' in Feed number "+E+" in Config Array element number "+f+" is not have correct parameter notReqfixedkeys",e=1):H[L].notReqfixedkeys||(H[L].notReqfixedkeys=0);H.adids[H.adids.length]=L;Ba++}Ba||(g+="\nFeed number "+E+" in Config Array element number "+f+" not have ads in 'GASearch' "+H.Id,e=1)}if(H.hasOwnProperty("GAShtml")){if("number"!=typeof H.GAShtml||2<H.GAShtml||0>H.GAShtml)g+="\nFeed number "+E+" in Config Array element number "+
f+" have incorrect parameter 'GAShtml' in 'GASearch'",e=1;b[0][f][E].GAShtmlForfeed=[H.GAShtmlAd,H.GAShtmlComment,H.GAShtmlExt,J.hostname+"/"]}H.Id||H.hasOwnProperty("GAShtml")&&delete H.GAShtml}b[0][f][E].all_fields_not_required&&b[0][f][E].hasOwnProperty("GASearch")&&(delete b[0][f][E].GASearch,b[0][f][E].GAShtmlForfeed&&delete b[0][f][E].GAShtmlForfeed);var fb={},W=b[0][f][E].onefieldvisible=0;for(L in b[0][f][E])if("string"==typeof L&&/^id\d+$/.test(L)){if("[object Object]"!=={}.toString.call(b[0][f][E][L])){g+=
"\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" is not Hash";e=1;break}b[0][f][E].fields||(b[0][f][E].fields={});b[0][f][E].fields[L]=1;b[0][f][E][L].hasOwnProperty("field_name")?"string"!=typeof b[0][f][E][L].field_name?(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter field_name",e=1):b[0][f][E][L].hasOwnProperty("multifield_name")&&("string"==typeof b[0][f][E][L].multifield_name&&b[0][f][E][L].multifield_name?
b[0][f][E][L].multifield_name.length>b[0][f][E][L].field_name.length?(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter multifield_name",e=1):b[0][f][E][L].field_name.slice(0,b[0][f][E][L].multifield_name.length)!==b[0][f][E][L].multifield_name&&(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter multifield_name",e=1):(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+
f+" have incorrect parameter multifield_name",e=1)):(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" is not have field_name",e=1);b[0][f][E][L].hasOwnProperty("field_visible")?"number"!=typeof b[0][f][E][L].field_visible&&(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter field_visible",e=1):b[0][f][E][L].field_visible=0;if(b[0][f][E][L].field_visible)if(b[0][f][E].onefieldvisible=1,b[0][f][E][L].hasOwnProperty("file_type"))if(Ca=
b[0][f][E][L].file_type,"[object Array]"!=={}.toString.call(Ca))g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter file_type",e=1;else for(B=0;B<Ca.length;B++){if("string"!=typeof Ca[B]||-1==C.indexOf(Ca[B]))g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter file_type",e=1}else b[0][f][E].hasOwnProperty("file_type")&&(b[0][f][E][L].file_type=b[0][f][E].file_type);else b[0][f][E][L].file_type=
[];b[0][f][E][L].multifield_name&&"string"==typeof b[0][f][E][L].multifield_name?fb.hasOwnProperty(b[0][f][E][L].multifield_name)?fb[b[0][f][E][L].multifield_name]!==JSON.stringify(b[0][f][E][L].field_visible)+"\t"+JSON.stringify(b[0][f][E][L].file_type)&&(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter field_visible or file_type (not equal to another same multifield_name)",e=1):fb[b[0][f][E][L].multifield_name]=JSON.stringify(b[0][f][E][L].field_visible)+
"\t"+JSON.stringify(b[0][f][E][L].file_type):b[0][f][E][L].field_name&&"string"==typeof b[0][f][E][L].field_name&&(fb.hasOwnProperty(b[0][f][E][L].field_name)?fb[b[0][f][E][L].field_name]!==JSON.stringify(b[0][f][E][L].field_visible)+"\t"+JSON.stringify(b[0][f][E][L].file_type)&&(g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter field_visible or file_type (not equal to another same field_name)",e=1):fb[b[0][f][E][L].field_name]=JSON.stringify(b[0][f][E][L].field_visible)+
"\t"+JSON.stringify(b[0][f][E][L].file_type));b[0][f][E].feed_fields_file_types||(b[0][f][E].feed_fields_file_types={});"[object Array]"==={}.toString.call(b[0][f][E][L].file_type)?(Ca=JSON.parse(JSON.stringify(b[0][f][E][L].file_type)),Ca[Ca.length]="CheckAlwaysExistNoext"):Ca=["CheckAlwaysExistNoext"];var xa=b[0][f][E][L].field_name,Ma=b[0][f][E][L].multifield_name,Sa=b[0][f][E].feed_fields_file_types;if("string"==typeof xa&&("string"==typeof Ma||"undefined"==typeof Ma))for(B=0;B<Ca.length;B++)if("string"==
typeof Ca[B]){Sa[Ca[B]]||(Sa[Ca[B]]={});var ya=Sa[Ca[B]];if(Ma){if(ya.hasOwnProperty(Ma)){if("[object Array]"!={}.toString.call(ya[Ma])){g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+f+" have incorrect parameter multifield_name (equal to param field_name form another feed field)";e=1;break}}else ya[Ma]=[];-1==ya[Ma].indexOf(xa)&&(ya[Ma][ya[Ma].length]=xa)}else{if(ya.hasOwnProperty(xa)&&"number"!=typeof ya[xa]){g+="\nField number "+L+" in Feed number "+E+" in Config Array element number "+
f+" have incorrect parameter field_name (equal to param multifield_name form another feed field)";e=1;break}ya[xa]=1}}!b[0][f][E][L].hasOwnProperty("htmlencode")&&b[0][f][E].hasOwnProperty("htmlencode")&&(b[0][f][E][L].htmlencode=b[0][f][E].htmlencode);b[0][f][E].all_fields_not_required&&(b[0][f][E][L].field_required=0);W++}b[0][f][E].feed_fields_file_types?delete b[0][f][E].feed_fields_file_types.CheckAlwaysExistNoext:b[0][f][E].feed_fields_file_types={};Oa++;W||(g+="\nFeed number "+E+" in Config Array element number "+
f+" is not have fields",e=1)}}b[0][f].timeHours.length||(b[0][f].timeHours=JSON.parse(JSON.stringify(I)),b[0][f].timeHoursHash=JSON.parse(JSON.stringify(u)));b[0][f].startDays||(b[0][f].startDays=JSON.parse(JSON.stringify(X)),b[0][f].startDaysHash=JSON.parse(JSON.stringify(U)));if(Oa)for(E in b[0][f].feeds)b[0][f][E].GASearch&&b[0][f][E].GASearch.GAShtml&&(b[0][f][E].onefieldvisible=1),b[0][f][E].GASearch&&b[0][f][E].GASearch.Id||Object.keys(b[0][f][E].feed_fields_file_types).length||b[0][f][E].GASearch&&
b[0][f][E].GASearch.GAShtml||b[0][f][E].childrenFeeds&&b[0][f][E].childrenFeeds.length||(g=b[0][f][E].onefieldvisible?g+("\nFeed number "+E+" in Config Array element number "+f+" is not have jobs (create feed and/or create search company and/or have children feeds) "):g+("\nFeed number "+E+" in Config Array element number "+f+" is not have jobs (create feed with VISIBLE fields and/or create search company and/or have children feeds) "),e=1);else g+="\nConfig Array element number "+f+" is not have feeds",
e=1;b[0][f].feedsFullExts={};for(E in b[0][f].feeds){for(var $a in b[0][f][E].feed_fields_file_types)b[0][f].feedsFullExts[b[0][f][E].ext+$a]=1;b[0][f][E].GASearch&&b[0][f][E].GASearch.GAShtml&&(b[0][f].feedsFullExts[b[0][f][E].ext+".gas.html"]=1)}b[0][f].pausedFeedsIds={};b[0][f].pausedFeedsFullExts={};if(b[0][f].hasOwnProperty("pausedFeeds"))if("string"!=typeof b[0][f].pausedFeeds)g+="\nConfig Array element number "+f+" have incorrect parameter pausedFeeds",e=1;else{var ta=b[0][f].pausedFeeds.split(/[\s,]+/),
Xa=b[0][f].pausedFeedsIds;for(B=0;B<ta.length;B++){var ma=ta[B];if(b[0][f].feeds[ma])if(Xa[ma])g+="\nConfig Array element number "+f+" have dublicate in parameter pausedFeeds: "+ma,e=1;else{Xa[ma]=1;for($a in b[0][f][ma].feed_fields_file_types)b[0][f].pausedFeedsFullExts[b[0][f][ma].ext+$a]=1;b[0][f][ma].GASearch&&b[0][f][ma].GASearch.GAShtml&&(b[0][f].pausedFeedsFullExts[b[0][f][ma].ext+".gas.html"]=1);if(b[0][f][ma].childrenFeeds&&b[0][f][ma].childrenFeeds.length){var hb=b[0][f][ma].childrenFeeds;
for(R=0;R<hb.length;R++){var Na=hb[R];b[0][f][Na]&&-1==ta.indexOf(Na)&&(g+="\nConfig Array element number "+f+" not have paused children feed "+Na+" in parameter pausedFeeds for paused parent feed "+ma,e=1)}}}else g+="\nConfig Array element number "+f+" have incorrect parameter pausedFeeds. Not found feed: "+ma,e=1}}CONTROL_EMPTY_FEEDS&&(b[0][f].pausedFeedsIds={},b[0][f].pausedFeedsFullExts={});if(b[0][f].Id&&"string"==typeof b[0][f].Id)if(y.hasOwnProperty(b[0][f].Id))g+="\nConfig Array element number "+
f+" have dublicate parameter Id for site",e=1;else try{y[b[0][f].Id]=CONTROL_EMPTY_FEEDS?{Id:b[0][f].Id,IdNum:f,timeHours:b[0][f].timeHours,startDays:b[0][f].startDays,priorityLev:b[0][f].priorityLev,checksum:murmurhash3_32_gc(JSON.stringify(z[f])+"ag246dsfgsdgw34653456346")}:{Id:b[0][f].Id,IdNum:f,timeHours:b[0][f].timeHours,startDays:b[0][f].startDays,priorityLev:b[0][f].priorityLev,checksum:murmurhash3_32_gc(JSON.stringify(z[f]))}}catch(pb){g+="\nConfig Array element number "+f+" have bad structure for JSON.stringify: "+
pb.message,e=1}else g=ra?g+("\nConfig Array element number "+f+" have incorrect parameter Id for site"):g+("\nConfig Array element number "+f+" have incorrect parameter Id for site (not empty Id for dublicate hostname)"),e=1;for(E in b[0][f].feeds){var Ta=0;if(b[0][f][E].timeHours&&-1!=b[0][f][E].timeHours.indexOf("test"))Ta=1;else var rb="Hours: "+b[0][f][E].timeHours.join(","),zb=b[0][f][E].startDays.length?"Days: "+b[0][f][E].startDays.join(","):"Every day";for($a in b[0][f][E].feed_fields_file_types)l=
Ta?l+(b[0][f].Id+" "+E+" (test only) https://cdn.sale-storm.com/wd/files/"+a+"."+b[0][f][E].feedId+$a+"\n"):l+(b[0][f].Id+" "+E+" "+zb+" "+rb+" https://cdn.sale-storm.com/wd/files/"+a+"."+b[0][f][E].feedId+$a+"\n");b[0][f][E].GASearch&&b[0][f][E].GASearch.GAShtml&&(l=Ta?l+(b[0][f].Id+" "+E+" (test only) https://cdn.sale-storm.com/wd/files/"+a+"."+b[0][f][E].feedId+".gas.html\n"):l+(b[0][f].Id+" "+E+" "+zb+" "+rb+" https://cdn.sale-storm.com/wd/files/"+a+"."+b[0][f][E].feedId+".gas.html\n"))}l+="https://cdn.sale-storm.com/wd/files/"+
a+".excluded_goods.txt\n";l+="https://cdn.sale-storm.com/wd/files/"+a+".excluded_pages_conotall.txt\n"}if(!e)try{r=CONTROL_EMPTY_FEEDS?murmurhash3_32_gc(JSON.stringify(z)+"sdgsh2345fhdfhdfhhdfh5555"):murmurhash3_32_gc(JSON.stringify(z)),g+="\nOk. Config checksum: "+r}catch(pb){g+="\nConfig have bad structure for JSON.stringify: "+pb.message,e=1}e&&(g+="\nConfig is not working . Exit");v&&(g=e?"Warning, dublicate csv-lists:"+v+"\n\nERRORS:\n"+g:"Warning, dublicate csv-lists:"+v+"\n\n"+g);if(t)return Logger.log("Checked new configuration:\n"+
g),[e,b[0],y,r,G,k,z,g];if(!AdWordsApp.getExecutionInfo().isPreview()){for(var ab=a+".confreport.txt",lb="",Pa=n.getFilesByName(ab),Ea=0;Pa.hasNext();)lb=Pa.next().getBlob().getDataAsString(),Ea++;if(lb!=g||1<Ea){for(var Ya=n.getFilesByName(ab);Ya.hasNext();){var cb=Ya.next();deleteOrRemoveFile(cb)}checkSaveFile(n.createFile(ab,g),g);G=1}}if(!e&&h){lb="";Pa=k.getFilesByName(h);for(Ea=0;Pa.hasNext();)lb=Pa.next().getBlob().getDataAsString(),Ea++;if(lb!=l||1<Ea){for(Ya=k.getFilesByName(h);Ya.hasNext();)cb=
Ya.next(),deleteOrRemoveFile(cb);checkSaveFile(k.createFile(h,l),l)}}var Db=a+".errorconf.txt";lb="";Pa=n.getFilesByName(Db);for(Ea=0;Pa.hasNext();)lb=Pa.next().getBlob().getDataAsString(),Ea++;if(e){if(lb!=g||1<Ea){for(Ya=n.getFilesByName(Db);Ya.hasNext();)cb=Ya.next(),deleteOrRemoveFile(cb);checkSaveFile(n.createFile(Db,g),g)}}else if(Ea)for(Ya=n.getFilesByName(Db);Ya.hasNext();)cb=Ya.next(),deleteOrRemoveFile(cb);Logger.log(g);return[e,b[0],y,r,G,k,z,g]}
function rewriteScanReport(a,d,c){var n="";for(t in c)c[t].date&&(n+=t+" "+c[t].checksum+" "+c[t].priorityLev+" "+c[t].date+"\n");if(AdWordsApp.getExecutionInfo().isPreview())return n?Logger.log("Preview, Rewrite "+a+" :\n"+n):Logger.log("Preview, Delete "+a),n;n?Logger.log("Rewrite "+a+" :\n"+n):Logger.log("Delete "+a);for(c=d.getFilesByName(a);c.hasNext();){var t=c.next();deleteOrRemoveFile(t)}n&&checkSaveFile(d.createFile(a,n),n);return n}
function CheackCreateFeedsNow(a,d){if(!d.length)return 0;a=new Date(a);if("Invalid Date"==a)return 1;a=new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours());for(var c=getcurrentTime(),n=c.getHours(),t=-1,q=-1,h=0;h<d.length;h++){if(23<d[h])d[h]=23;else if(0>d[h])return 0;if(d[h]==n){q=t=-1;break}d[h]>t&&d[h]<n&&(t=d[h]);d[h]>q&&d[h]>n&&(q=d[h])}c=0<=t?new Date(c.getFullYear(),c.getMonth(),c.getDate(),t):0<=q?new Date(c.getFullYear(),c.getMonth(),c.getDate()-1,q):new Date(c.getFullYear(),
c.getMonth(),c.getDate(),n);return"Invalid Date"==c?0:c.getTime()<=a.getTime()?0:1}
function CheackScanningSiteNow(a,d){if(!d.length)return 1;a=new Date(a);if("Invalid Date"==a)return 1;a=new Date(a.getFullYear(),a.getMonth(),a.getDate());for(var c=getcurrentTime(),n=c.getDate(),t=0,q=0,h=0;h<d.length;h++){if(31<d[h])d[h]=31;else if(1>d[h])return 0;if(28<d[h]){var b=new Date(c.getFullYear(),c.getMonth()+1,0);b=b.getDate();if((b<d[h]?b:d[h])==(b<n?b:n)){q=t=0;break}}else if(d[h]==n){q=t=0;break}d[h]>t&&d[h]<n&&(t=d[h]);d[h]>q&&d[h]>n&&(q=d[h])}0<t?(28<t&&(b=new Date(c.getFullYear(),
c.getMonth()+1,0),b=b.getDate(),b<t&&(t=b)),c=new Date(c.getFullYear(),c.getMonth(),t)):0<q?(28<q&&(b=new Date(c.getFullYear(),c.getMonth(),0),n=b.getDate(),n<q&&(q=n)),c=new Date(c.getFullYear(),c.getMonth()-1,q)):c=new Date(c.getFullYear(),c.getMonth(),n);return"Invalid Date"==c?0:c.getTime()<=a.getTime()?0:1}
function sendftp(a,d,c,n){if(shouldExitEarly())return!1;if(!(d&&d.login&&d.password&&d.host&&d.files_types&&d.files_types.length))return"Error: not found ftp parameters";if("object"!=typeof a||!a.length)return"Error: not found files to send";var t=d.directory?d.directory:"",q=d.passive_mode?d.passive_mode:"",h=d.ssl_mode?d.ssl_mode:"";d&&"string"==typeof d.zipfilename&&d.zipfilename&&(c=d.zipfilename);for(var b=[],m=0;m<a.length;m++){var p=a[m].getName().match(/((?:\.(?:ga|yml|yrl|ycar|ya))?\.(?:[\w]+))$/i);
if(p&&p[1]){var k=p[1].toLowerCase();-1!=d.files_types.indexOf(k)&&(b[b.length]=a[m].getBlob())}}if(!b.length)return"Error: in files_types not found files to send";d&&d.createzip&&c&&b.length&&(m=Utilities.zip(b,c),b=[],b[b.length]=m);a=0;c="";k={method:"post",muteHttpExceptions:!0,followRedirects:!0,headers:{"Content-Type":"application/octet-stream",Referer:"http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"}};for(m=0;m<b.length;m++){var z=b[m].getName(),G=b[m].getBytes(),y=n?n+"."+(new Date).getTime():
(new Date).getTime()+"",r=0;for(c="";5>r;){r++;var g=0;do{var v=G.slice(g,Math.min(g+1024E4,G.length));k.payload=v;a&&Utilities.sleep(a);c="";try{var l=g?UrlFetchApp.fetch("http://inteprice.com/gasrvconn/?fileName="+z+"&tmp="+y,k):UrlFetchApp.fetch("http://inteprice.com/gasrvconn/?fileName="+z+"&tmp="+y+"&start=1",k)}catch(C){(c=C.message)||(c="Unknown fetch error")}if(c){if(-1!=c.indexOf("Service invoked too many times in a short time"))g=1E3,(p=c.match(/Try Utilities\.sleep\((\d+)\)/))&&p[1]&&1*
p[1]&&(g=1*p[1]),a=g>a?g:2*a;else{if(-1!=c.indexOf("Service invoked too many times"))return Logger.log("Ftp Service error: "+c+"\n"+n),!1;if(-1!=c.indexOf("Timeout:"))return Logger.log("Ftp Service error: "+c+"\n"+n),c}break}p=l.getResponseCode();var e=l.getContentText();e=e.replace(/\r/g," ");e=e.replace(/\n/g," ");e=e.replace(/\t/g," ");e=e.replace(/(<!\-\-76639386656585\-\->.*)$/,"");v=v.length;if(200!==p){g=1E3;a=g>a?g:2*a;c=p+" "+e;if(shouldExitEarly())return!1;break}else if(v&&e)return p+" "+
e;if(shouldExitEarly())return!1;g+=v}while(g<G.length);if(!c){delete k.payload;try{l=UrlFetchApp.fetch("http://inteprice.com/gasrvconn/?fileName="+z+"&tmp="+y+"&log="+d.login+"&pass="+d.password+"&host="+d.host+"&dir="+t+"&pm="+q+"&ssl="+h+"&end=1",k)}catch(C){(c=C.message)||(c="Unknown fetch error")}if(c)if(-1!=c.indexOf("Service invoked too many times in a short time"))g=1E3,(p=c.match(/Try Utilities\.sleep\((\d+)\)/))&&p[1]&&1*p[1]&&(g=1*p[1]),a=g>a?g:2*a;else{if(-1!=c.indexOf("Service invoked too many times"))return Logger.log("Ftp Service error: "+
c+"\n"+n),!1;if(-1!=c.indexOf("Timeout:"))return Logger.log("Ftp Service error: "+c+"\n"+n),c}else if(p=l.getResponseCode(),e=l.getContentText(),e=e.replace(/\r/g," "),e=e.replace(/\n/g," "),e=e.replace(/\t/g," "),e=e.replace(/(<!\-\-76639386656585\-\->.*)$/,""),200!==p){if(g=1E3,a=g>a?g:2*a,c=p+" "+e,shouldExitEarly())return!1}else{if(e)return p+" "+e;break}}}if(c)return c}return c?c:!0}
function getFeedfolders(){for(var a=null,d=null,c=null,n=null,t=null,q=null,h=null,b=DriveApp.getRootFolder().getFolders();b.hasNext();){var m=b.next(),p=m.getName();"context_settings"==p?a||(a=m):"trashed"==p?d||(d=m):"tmpfiles"==p?n||(n=m):"schedfiles"==p&&(t||(t=m))}for(b=DriveApp.getRootFolder().getFiles();b.hasNext();)if(m=b.next(),m.getName(),m=m.getTargetId())if(m=DriveApp.getFolderById(m))p=m.getName(),"context_settings"==p?a||(a=m):"trashed"==p?d||(d=m):"tmpfiles"==p?n||(n=m):"schedfiles"==
p&&(t||(t=m));if(!a)return Logger.log('Not found folder "context_settings" !!!, exit'),"";if(!d)return Logger.log('Not found folder "trashed" !!!, exit'),"";if(!n)return Logger.log('Not found folder "tmpfiles" !!!, exit'),"";if(!t)return Logger.log('Not found folder "schedfiles" !!!, exit'),"";"undefined"!=typeof GLtrashedfolder&&(GLtrashedfolder=d);for(b=a.getFolders();b.hasNext();)if(m=b.next(),p=m.getName(),"files"==p){c=m;break}if(!c)return Logger.log('Not found folder "context_settings/files" !!!, exit'),
"";for(b=a.getFolders();b.hasNext()&&(m=b.next(),p=m.getName(),!c||!q);)c||"files"!=p?q||"callhunter"!=p||(q=m):c=m;if(!c)return Logger.log('Not found folder "context_settings/files" !!!, exit'),"";if(!q)return Logger.log('Not found folder "context_settings/callhunter" !!!, exit'),"";for(q=q.getFolders();q.hasNext();)if(m=q.next(),p=m.getName(),"domains"==p){h=m;break}return h?[a,c,h,n,t,d]:(Logger.log('Not found folder "context_settings/callhunter/domains" !!!, exit'),"")}
function getLabel(a){if("string"!=typeof a)return null;a=a.replace(/\s+$/,"");for(var d=AdWordsApp.labels().withCondition("Name = '"+a.replace(/'/gm,"\\'")+"'").get(),c=0;d.hasNext();){c=d.next();d=c.getDescription();if("string"!=typeof d)c=1;else return d;break}if(c)for(d=AdWordsApp.labels().withCondition("Name = '"+a.replace(/'/gm,"\\'")+"'").get();d.hasNext();)c=d.next(),c.remove(),c.remove();return null}
function setLabel(a,d){if("string"!=typeof a)return 0;a=a.replace(/\s+$/,"");if(80<a.length)return 0;for(var c=AdWordsApp.labels().withCondition("Name = '"+a.replace(/'/gm,"\\'")+"'").get();c.hasNext();){var n=c.next();n.remove();n.remove()}"string"!=typeof d&&(d=d.toString());if("string"!=typeof d||200<d.length)return 0;AdWordsApp.createLabel(a,d,"#C0C0C0");return 1}
function readConfFile(a,d){try{var c=d.getFilesByName(a);if(!c.hasNext())return[null,1,"File: "+a+" not found"];var n=c.next().getBlob().getDataAsString();return n?[eval("("+n+")"),0]:[null,2,"File: "+a+" is empty"]}catch(t){return[null,3,"Could not read file: "+a+" Error: "+t.message]}}function isInteger(a){"number"==typeof a&&(a=String(a));return"string"!=typeof a?!1:/^\d+$/.test(a)?!0:!1}
function getPriceCurrencyFromStr(a){if(a){a=a.replace(/<[^>]*>/g,"");var d=a.replace(/[\d\.,][\d\.,\s]+[\d\.,]/g,function(t,q,h){return t=t.replace(/\s+/g,"")}).match(/((?:[\d]|(?:[\.,][\d]))[\d\.,]*)/);if(d&&d[1]){d=d[1];1==(d.match(/,/g)||[]).length&&/,\d\d?$/.test(d)&&(d=d.replace(/^(?!\.)(.*),/,"$1."));var c=d.replace(/,/g,"");x=Number(c);c=x!==x?null:x?d:null}else c=d=null;var n=[{pattern:/((?:EUR)|\u20ac)/i,currency:"EUR"},{pattern:/((?:USD)|(?:\u0423\.\u0415\.)|\$)/i,currency:"USD"},{pattern:/((?:UAH)|(?:\u0413\u0420\u041d\.?)|(?:\u20b4))/i,
currency:"UAH"},{pattern:/((?:RUR)|(?:RUB)|(?:\u0420\.)|(?:\u0420\u0423\u0411\.?))/i,currency:"RUB"},{pattern:/((?:\u0422\u0413)|(?:KZT)|(?:\u20b8)|(?:\u0422\u04a2\u0413)|(?:TENGE)|(?:\u0422\u0415\u041d\u0413\u0415))/i,currency:"KZT"},{pattern:/((?:[A-Z][A-Z][A-Z]))/,currency:"MAYBE"}].map(function(t){return{currency:t.currency,index:a.search(t.pattern),match:a.match(t.pattern)}}).filter(function(t){return-1<t.index}).sort(function(t,q){return t.index-q.index});return[[d,c],n.length?["MAYBE"==n[0].currency?
n[0].match[1]:n[0].currency,n[0].match[1]]:null]}}
function murmurhash3_32_gc(a,d){a+="";var c;var n=a.length&3;var t=a.length-n;var q=d;for(c=0;c<t;){var h=a.charCodeAt(c)&255|(a.charCodeAt(++c)&255)<<8|(a.charCodeAt(++c)&255)<<16|(a.charCodeAt(++c)&255)<<24;++c;h=3432918353*(h&65535)+((3432918353*(h>>>16)&65535)<<16)&4294967295;h=h<<15|h>>>17;h=461845907*(h&65535)+((461845907*(h>>>16)&65535)<<16)&4294967295;q^=h;q=q<<13|q>>>19;q=5*(q&65535)+((5*(q>>>16)&65535)<<16)&4294967295;q=(q&65535)+27492+(((q>>>16)+58964&65535)<<16)}h=0;switch(n){case 3:h^=
(a.charCodeAt(c+2)&255)<<16;case 2:h^=(a.charCodeAt(c+1)&255)<<8;case 1:h^=a.charCodeAt(c)&255,h=3432918353*(h&65535)+((3432918353*(h>>>16)&65535)<<16)&4294967295,h=h<<15|h>>>17,q^=461845907*(h&65535)+((461845907*(h>>>16)&65535)<<16)&4294967295}q^=a.length;q^=q>>>16;q=2246822507*(q&65535)+((2246822507*(q>>>16)&65535)<<16)&4294967295;q^=q>>>13;q=3266489909*(q&65535)+((3266489909*(q>>>16)&65535)<<16)&4294967295;return(q^q>>>16)>>>0}
function getcurrentTime(){var a=new Date(Utilities.formatDate(new Date,AdWordsApp.currentAccount().getTimeZone(),"MMM dd,yyyy HH:mm:ss"));return new Date(a.getTime())}
function getNewDate(a,d,c){var n=/\s*\(?\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{2}:?\d{2})?)\b\)?/g;d&&("string"==typeof d?(d=d.toLowerCase(),"currentime"==d?(d=0,a=null):d="yesterday"==d?-1:"today"==d?0:"tomorrow"==d?1:0):"number"!=typeof d&&(d=0));if(void 0===a||null===a)a="string"==typeof c?new Date(Utilities.formatDate(new Date,c,"MMM dd,yyyy HH:mm:ss")):new Date(Utilities.formatDate(new Date,AdWordsApp.currentAccount().getTimeZone(),
"MMM dd,yyyy HH:mm:ss"));else if(c&&"string"==typeof c){var t=new Date,q=Utilities.formatDate(t,AdWordsApp.currentAccount().getTimeZone(),"Z").match(/^([+-]?)(\d\d)(:?(\d\d))?$/);c=Utilities.formatDate(t,c,"Z").match(/^([+-]?)(\d\d)(:?(\d\d))?$/);5==q.length?(t=60*q[2]+1*(q[4]?q[4]:0),t=""+q[1]+t):t=0;5==c.length?(q=60*c[2]+1*(c[4]?c[4]:0),q=""+c[1]+q):q=0;q=t-q;a=String(a).replace(n,"");a=new Date(a);a.setTime(a.getTime()+6E4*q)}else a=String(a).replace(n,""),a=new Date(a);if("Invalid Date"==a)return!1;
d&&a.setDate(a.getDate()+d);return a}function removeRootFile(a,d){if(!AdWordsApp.getExecutionInfo().isPreview()){d||(d=DriveApp.getRootFolder());for(var c=d.getFilesByName(a);c.hasNext();){var n=c.next();deleteOrRemoveFile(n)}}}function writeJSONFile(a,d,c){a=getFile(a,c);d=JSON.stringify(d);checkSaveFile(a.setContent(d),d)}function readJSONFile(a,d){var c=getFile(a,d).getBlob().getDataAsString();return c?JSON.parse(c):null}
function getFile(a,d){var c=3,n=[];for(d||(d=DriveApp.getRootFolder());0<c;)try{var t=d.getFilesByName(a);if(t.hasNext())return t.next();Logger.log("Could not find file: "+a+" on Google Drive. Creating new file.");return checkSaveFile(d.createFile(a,""),"")}catch(q){n.push(q),c--,Utilities.sleep(1E3)}if(0===c)throw Error(n.join(". "));}
function ReadMainFile(){for(var a=null,d=null,c=DriveApp.getRootFolder().getFolders();c.hasNext();){var n=c.next(),t=n.getName();"context_settings"==t&&(a||(a=n))}for(c=DriveApp.getRootFolder().getFiles();c.hasNext();)if(n=c.next(),n.getName(),n=n.getTargetId())if(n=DriveApp.getFolderById(n))t=n.getName(),"context_settings"==t&&(a||(a=n));if(!a)return COMMON[COMMON.length]='Not found folder "context_settings" !!!, exit',Logger.log('Not found folder "context_settings" !!!, exit'),"";for(a=a.getFolders();a.hasNext();)if(n=
a.next(),t=n.getName(),"hidden"==t){d=n;break}if(!d)return COMMON[COMMON.length]='Not found folder "context_settings/hidden" !!!, exit',Logger.log('Not found folder "context_settings/hidden" !!!, exit'),"";for(a=d.getFolders();a.hasNext();)if(n=a.next(),t=n.getName(),"history"==t){historyfolder=n;break}if(!historyfolder)return COMMON[COMMON.length]='Not found folder "context_settings/hidden/history" !!!, exit',Logger.log('Not found folder "context_settings/hidden/history" !!!, exit'),"";if(testing_ID){var q=
n="";t={};a={};c={};var h={},b=0,m={},p=0;if(testingJob){d=d.getFilesByName("testing.txt");if(d.hasNext())for(d=d.next(),k=d.getBlob().getDataAsString(),k=k.replace(/[\r]+/g,""),z=k.split("\n"),d=0;d<z.length;d++)if((k=z[d].match(/^\s*([\d]+)\s+([\d\-]+)\s+(([^\s#][^\s]*)[\s\S]*)$/))&&k[1]&&k[2]&&k[3]&&k[4]&&(t[k[4]]?(b=1,COMMON[COMMON.length]="Dublicate TestNames in test jobs file "+k[4]+", exit. Not working all testing scripts, check test jobs file",Logger.log("Dublicate TestNames in test jobs file "+
k[4]+", exit. Not working all testing scripts, check test jobs file")):(t[k[4]]=1,a[k[4]]=k[2],c[k[2]]=k[4],h[k[2]]=1),m[k[1]]?(p=1,COMMON[COMMON.length]="Dublicate TestScript Ids in test jobs file "+k[1]+", exit. Not working all testing scripts, check test jobs file",Logger.log("Dublicate TestScript Ids in test jobs file "+k[1]+", exit. Not working all testing scripts, check test jobs file")):m[k[1]]=1,b||p))return"";(k=testingJob.match(/^\s*([\d\-]+)\s+(([^\s#][^\s]*)[\s\S]*)$/))&&k[1]&&k[2]&&k[3]&&
(n=k[1],q=k[3])}else if(d=d.getFilesByName("testing.txt"),d.hasNext()){d=d.next();var k=d.getBlob().getDataAsString();k=k.replace(/[\r]+/g,"");var z=k.split("\n");for(d=0;d<z.length;d++)if((k=z[d].match(/^\s*([\d]+)\s+([\d\-]+)\s+(([^\s#][^\s]*)[\s\S]*)$/))&&k[1]&&k[2]&&k[3]&&k[4]){t[k[4]]?(b=1,COMMON[COMMON.length]="Dublicate TestNames in test jobs file "+k[4]+", exit. Not working all testing scripts, check test jobs file",Logger.log("Dublicate TestNames in test jobs file "+k[4]+", exit. Not working all testing scripts, check test jobs file")):
(t[k[4]]=1,a[k[4]]=k[2],c[k[2]]=k[4],h[k[2]]=1);m[k[1]]?(p=1,COMMON[COMMON.length]="Dublicate TestScript Ids in test jobs file "+k[1]+", exit. Not working all testing scripts, check test jobs file",Logger.log("Dublicate TestScript Ids in test jobs file "+k[1]+", exit. Not working all testing scripts, check test jobs file")):m[k[1]]=1;if(b||p)return"";k[1]===String(testing_ID)&&(n=k[2],testingJob=k[2]+" "+k[3],q=k[4])}}if(!n||!q)return AdWordsApp.getExecutionInfo().isPreview()?(COMMON[COMMON.length]=
"Empty or incorrect job (not found it in file testing.txt or in var testingJob), exit",Logger.log("Empty or incorrect job (not found it in file testing.txt or in var testingJob), exit")):(COMMON[COMMON.length]="Empty or incorrect job (not found it in test jobs file), exit",Logger.log("Empty or incorrect job (not found it in test jobs file), exit")),"";testingJob="ONE"==SCRIPT_USED?testingJob+" LOW MERCHANTXMLONE":testingJob+" LOW MERCHANTXMLMAX";q=0;d=historyfolder.getFilesByName("payments.last.txt");
for(n=null;d.hasNext();){d=d.next();k=d.getBlob().getDataAsString();k=k.replace(/[\r]+/g,"");b=/^\s*START[\s\S]*\nEND\s*/;if(b.test(k))n=k.split("\n");else if(Logger.log('Empty file or read error for "context_settings/hidden/history/payments.last.txt !!!, wait 30 sec'),Utilities.sleep(3E4),k=d.getBlob().getDataAsString(),k=k.replace(/[\r]+/g,""),b.test(k))n=k.split("\n");else{COMMON[COMMON.length]='Empty file or read error for "context_settings/hidden/history/payments.last.txt !!!, exit';Logger.log('Empty file or read error for "context_settings/hidden/history/payments.last.txt !!!, exit');
q=1;break}break}if(!q){q=getcurrentTime();q=new Date(q.getFullYear(),q.getMonth(),q.getDate());z=0;var G={};for(d=n.length-1;0<=d;d--)if(b=/^\s*\/\//,!b.test(n[d])&&(k=n[d].match(/^\s*([\d\-]+)\s+(([^\s#][^\s]*)[\s\S]*)$/))&&k[1]&&k[2]&&k[3]&&(b=k[1],m=k[2],k=k[3],!G[b])){G[b]=1;var y=0;p=new RegExp(/END(\d\d)\/(\d\d)\/(\d\d\d\d)/);null!=(p=p.exec(m))&&(p=new Date(p[2]+"/"+p[1]+"/"+p[3]),q.getTime()>=p.getTime()&&(y=1));y||(p=new RegExp(/STOP(\d\d)\/(\d\d)\/(\d\d\d\d)/),null!=(p=p.exec(m))&&(p=new Date(p[2]+
"/"+p[1]+"/"+p[3]),q.getTime()>=p.getTime()&&(y=1)));h[b]&&k!=c[b]?y?(COMMON[COMMON.length]="TestCustomerId from test jobs file "+b+" exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file",Logger.log("TestCustomerId from test jobs file "+b+" exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file"),z=1):-1==m.indexOf("MERCHANTXML")?(COMMON[COMMON.length]="TestCustomerId from test jobs file "+
b+" exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now",Logger.log("TestCustomerId from test jobs file "+b+" exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now")):(COMMON[COMMON.length]="TestCustomerId from test jobs file "+b+" exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file",Logger.log("TestCustomerId from test jobs file "+b+" exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file"),
z=1):t[k]&&b!=a[k]?y?(COMMON[COMMON.length]="TestCustomerName from test jobs file "+k+" exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file",Logger.log("TestCustomerName from test jobs file "+k+" exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file"),z=1):-1==m.indexOf("MERCHANTXML")?(COMMON[COMMON.length]="TestCustomerName from test jobs file "+k+" exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now",
Logger.log("TestCustomerName from test jobs file "+k+" exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now")):(COMMON[COMMON.length]="TestCustomerName from test jobs file "+k+" exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file",Logger.log("TestCustomerName from test jobs file "+k+" exist in payments base with MERCHANTXMLMAX/ONE !!!, exit. Not working all testing scripts, check test jobs file"),z=1):t[k]&&
b==a[k]&&(y?(COMMON[COMMON.length]="TestCustomer from test jobs file "+b+" "+k+" exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file",Logger.log("TestCustomer from test jobs file "+b+" "+k+" exist in payments base with expired END/STOP date !!!, exit. Not working all testing scripts, check test jobs file"),z=1):(COMMON[COMMON.length]="TestCustomer from test jobs file "+b+" "+k+" exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now",
Logger.log("TestCustomer from test jobs file "+b+" "+k+" exist in payments base without MERCHANTXMLMAX/ONE, this is only inform comment now")))}if(z)return""}n=[testingJob]}else for(d=historyfolder.getFilesByName("payments.last.txt"),n=null;d.hasNext();){d=d.next();k=d.getBlob().getDataAsString();k=k.replace(/[\r]+/g,"");b=/^\s*START[\s\S]*\nEND\s*/;if(b.test(k))n=k.split("\n");else if(Logger.log('Empty file or read error for "context_settings/hidden/history/payments.last.txt !!!, wait 30 sec'),Utilities.sleep(3E4),
k=d.getBlob().getDataAsString(),k=k.replace(/[\r]+/g,""),b.test(k))n=k.split("\n");else return COMMON[COMMON.length]='Empty file or read error for "context_settings/hidden/history/payments.last.txt !!!, exit',Logger.log('Empty file or read error for "context_settings/hidden/history/payments.last.txt !!!, exit'),"";break}if(n){t={};a={};c={};h={};z={};G={};for(d=0;d<n.length;d++)if(b=/^\s*\/\//,!b.test(n[d]))if((k=n[d].match(/^\s*([\d\-]+)\s+(([^\s#][^\s]*)[\s\S]*)$/))&&k[1]&&k[2]&&k[3])if(b=k[1],
m=k[2],k=k[3],y=1,q=getcurrentTime(),q=new Date(q.getFullYear(),q.getMonth(),q.getDate()),p=new RegExp(/START(\d\d)\/(\d\d)\/(\d\d\d\d)/),null!=(p=p.exec(m))&&(p=new Date(p[2]+"/"+p[1]+"/"+p[3]),y=p.getTime()),y>q.getTime())a[k]=1,c[k]=1;else{if(h[k])if(y<=q.getTime()&&y>z[k])z[k]=y;else continue;else h[k]=1,z[k]=y;t[b]=m;G[k]=b}else(k=n[d].match(/^\s*(([^\s#][^\s]*)\s[\s\S]*CALL[\s\S]*)$/))&&k[1]&&k[2]&&(m=k[1],k=k[2],y=1,q=getcurrentTime(),q=new Date(q.getFullYear(),q.getMonth(),q.getDate()),p=
new RegExp(/START(\d\d)\/(\d\d)\/(\d\d\d\d)/),null!=(p=p.exec(m))&&(p=new Date(p[2]+"/"+p[1]+"/"+p[3]),y=p.getTime()),y>q.getTime()?a[k]=1:h[k]?y<=q.getTime()&&y>z[k]&&(z[k]=y,G.hasOwnProperty(k)&&(delete t[G[k]],delete G[k])):(h[k]=1,z[k]=y));return[t,a,c]}COMMON[COMMON.length]='Not found file "context_settings/hidden/history/payments.last.txt !!!, exit';Logger.log('Not found file "context_settings/hidden/history/payments.last.txt !!!, exit');return""}
function getcurrentGMTTime(){return new Date(Utilities.formatDate(new Date,"GMT","EEE, dd MMM yyyy HH:mm:ss"))}var ScanCreateFeedsGlobalVars={errors:"",warnings:"",messages:"",stopscan:0,init:{}};
function ScanCreateFeeds(a,d,c,n,t,q){var h=!1;ScanCreateFeedsGlobalVars={errors:"",warnings:"",messages:"",stopscan:0,SITES_CHECKED_FILE_NAME:c,NOparsed_urls_list:"",init:{}};c=a.config[a.scannId.IdNum];if(AdWordsApp.getExecutionInfo().isPreview()||c.Debug_On)ScanCreateFeedsGlobalVars.debug=c.Debug_On?c.Debug_On:1;ScanCreateFeedsGlobalVars.CustomerName=t;ScanCreateFeedsGlobalVars.SITE=c.SITE;ScanCreateFeedsGlobalVars.CHARSET=c.CHARSET;ScanCreateFeedsGlobalVars.seed=c.seed;c.hasOwnProperty("skip_query")&&
(ScanCreateFeedsGlobalVars.skip_query=c.skip_query);c.hasOwnProperty("only_query")&&(ScanCreateFeedsGlobalVars.only_query=c.only_query);c.hasOwnProperty("scanFun")&&(ScanCreateFeedsGlobalVars.scanFun=c.scanFun);c.hasOwnProperty("skip_errors")&&(ScanCreateFeedsGlobalVars.skip_errors=c.skip_errors);c.hasOwnProperty("repeat_errors")&&(ScanCreateFeedsGlobalVars.repeat_errors=c.repeat_errors);c.hasOwnProperty("valid_scheme")&&(ScanCreateFeedsGlobalVars.valid_scheme=c.valid_scheme);c.hasOwnProperty("REQUEST_DELAY")&&
(ScanCreateFeedsGlobalVars.REQUEST_DELAY=c.REQUEST_DELAY);c.hasOwnProperty("IGNORE_EMPTY_CONTENT_TYPE")&&(ScanCreateFeedsGlobalVars.IGNORE_EMPTY_CONTENT_TYPE=c.IGNORE_EMPTY_CONTENT_TYPE);c.hasOwnProperty("MAX_TRIES")&&(ScanCreateFeedsGlobalVars.MAX_TRIES=c.MAX_TRIES);c.hasOwnProperty("MAX_CHECKED_URLS")&&(ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS=c.MAX_CHECKED_URLS);c.no_urlsearchtoLowerCase&&(ScanCreateFeedsGlobalVars.no_urlsearchtoLowerCase=1);ScanCreateFeedsGlobalVars.init={};ScanCreateFeedsGlobalVars.init.feedsAlreadyChecked=
a;ScanCreateFeedsGlobalVars.init.foundURLHASHdublicates=d;ScanCreateFeedsGlobalVars.init.IDName=n;preparestartFeed();if(CONTROL_EMPTY_FEEDS)return startFeed(a,d,n),h;if(!ScanCreateFeedsGlobalVars.errors&&c.hasOwnProperty("startInitFun"))try{c.startInitFun(q),ScanCreateFeedsGlobalVars.stopscan&&(Logger.log("All feeds added MAX_ADD_URLS num urls, stop Scan and exit"),h=!1)}catch(m){ScanCreateFeedsGlobalVars.errors+="bad function startInitFun:"+m.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}if(ScanCreateFeedsGlobalVars.errors||
ScanCreateFeedsGlobalVars.stopscan)startFeed(a,d,n);else if(h=startFeed(a,d,n),!ScanCreateFeedsGlobalVars.errors&&c.hasOwnProperty("endInitFun"))try{var b=ScanCreateFeedsGlobalVars.stopscan?1:0;c.endInitFun(!h);!b&&ScanCreateFeedsGlobalVars.stopscan&&(Logger.log("All feeds added MAX_ADD_URLS num urls, stop Scan and exit"),h=!1)}catch(m){ScanCreateFeedsGlobalVars.errors+="bad function endInitFun:"+m.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}return h}
function GetQuotedUrl(a){var d=a.substring(0,1);if('"'!=d&&"'"!=d)return a;for(var c="",n=a.length,t=1;t<n;t++){var q=a.substr(t,1);if(q==d)break;c+=q}return c}function GetHREFValue(a){var d=a.split("href=");if(d[0]==a)return"";a=d[1].split(">")[0].split(" ")[0];d=a.substring(0,1);if('"'==d||"'"==d)a=GetQuotedUrl(a);return a}
function ValidateCSVURL(a,d){var c=parse_url(a);if(!1===c)return!1;var n=c.protocol,t=c.host;if(!t||!n)return!1;var q;if(t&&(q=t.match(/([^a-zA-Z0-9\-\.])/))&&q[1]){t=idndomain(t);var h=c.protocol?c.protocol+"://":"",b=c.port?":"+c.port:"",m=c.query?c.query:"";a=h+t+b+m;c=parse_url(a);if(!1===c)return!1}m=parse_url(d);if(!m)return!1;var p=m.host;if(p&&(q=p.match(/([^a-zA-Z0-9\-\.])/))&&q[1]&&(p=idndomain(p),h=m.protocol?m.protocol+"://":"",b=m.port?":"+m.port:"",m=m.query?m.query:"",d=h+p+b+m,m=parse_url(d),
!1===m))return!1;q=m.protocol;if(!p){if("/"==m.pathname.substr(0,1)?d=n+"://"+t+d:(c=c.pathname,"/"==substr(c,-1)?d=n+"://"+t+c+d:(m=dirnameFun(c),"/"!=substr(m,-1)&&(m+="/"),d=n+"://"+t+m+d)),m=parse_url(d),!1===m)return!1}else if(!q&&(d=n+"://"+d,m=parse_url(d),!1===m))return!1;n=urlEncoding(d);n!==d?(d=n,m=parse_url(d)):d=n;if(p&&"/"!=m.pathname.substr(0,1)&&(m=parse_url(d),d=(m.protocol?m.protocol+"://":"")+m.hostname+m.port+"/"+m.pathname+m.search,m=parse_url(d),!1===m))return!1;p=0;for(n=RegExp("(?!\\/\\.\\.\\/)\\/[^\\/]+\\/\\.\\.\\/");;)if(c=
m.pathname.replace(n,"/"),c!==m.pathname)p=1,m.pathname=c;else break;n=RegExp("\\/\\.(?=\\/)","g");c=m.pathname.replace(n,"");c!==m.pathname&&(p=1,m.pathname=c);p&&(d=(m.protocol?m.protocol+"://":"")+m.hostname+m.port+m.pathname+m.search);return d}
function ValidateURL(a,d,c){var n=ScanCreateFeedsGlobalVars.SITE_SCHEME,t=ScanCreateFeedsGlobalVars.SITE_HOST,q=ScanCreateFeedsGlobalVars.valid_scheme,h=parse_url(d);if(!h)return!1;var b;if(h.pathname&&(b=h.pathname.match(/(\.[^\/\.]+)$/))&&b[1]){var m={".wml":1,".txt":1,".java":1,".fcgi":1,".pdf":1,".xls":1,".js":1,".swf":1,".zip":1,".bin":1,".dms":1,".exe":1,".class":1,".so":1,".dll":1,".mid":1,".midi":1,".kar":1,".wav":1,".gif":1,".jpeg":1,".jpg":1,".jpe":1,".wbmp":1,".css":1,".rtf":1,".gz":1,
".doc":1,".tar":1,".png":1,".rar":1};if(m[b[1]]&&m[b[1].toLowerCase()])return!1}if((m=h.host)&&(b=m.match(/([^a-zA-Z0-9\-\.])/))&&b[1]&&(m=idndomain(m),d=(h.protocol?h.protocol+"://":"")+m+(h.port?":"+h.port:"")+(h.query?h.query:""),h=parse_url(d),!1===h)||m!=t&&m)return!1;b=h.protocol;if(q&&q.length){if(b){var p=0,k;for(k in q)q[k]==b&&(p=1);if(!p)return!1}}else if(b!=n&&b)return!1;if(h.hash){if(d===h.hash)return!1;d=(h.protocol?h.protocol+"://":"")+h.hostname+h.port+h.pathname+h.search;h=parse_url(d);
if(!1===h)return!1}if(!m){if("/"==h.pathname.substr(0,1))d=n+"://"+t+d;else{h=parse_url(a);if(!1===h)return!1;(a=h.pathname)&&"/"==a.substr(-1)?d=n+"://"+t+a+d:((h=dirnameFun(a))&&"/"==h.substr(-1)||(h+="/"),d=n+"://"+t+h+d)}h=parse_url(d);if(!1===h)return!1}else if(!b&&(d=n+"://"+d,h=parse_url(d),!1===h))return!1;n=urlEncoding(d);n!==d?(d=n,h=parse_url(d)):d=n;if(m&&"/"!=h.pathname.substr(0,1)&&(h=parse_url(d),d=(h.protocol?h.protocol+"://":"")+h.hostname+h.port+"/"+h.pathname+h.search,h=parse_url(d),
!1===h))return!1;n=0;for(t=RegExp("(?!\\/\\.\\.\\/)\\/[^\\/]+\\/\\.\\.\\/");;)if(a=h.pathname.replace(t,"/"),a!==h.pathname)n=1,h.pathname=a;else break;t=RegExp("\\/\\.(?=\\/)","g");a=h.pathname.replace(t,"");a!==h.pathname&&(n=1,h.pathname=a);n&&(d=(h.protocol?h.protocol+"://":"")+h.hostname+h.port+h.pathname+h.search);return!c&&SkipURL(h.pathname+h.search)?!1:d}
function idndomain(a,d){function c(r,g,v){r/=v?700:2;r+=~~(r/g);for(g=0;455<r;g+=36)r=~~(r/35);return g+~~(36*r/(r+38))}function n(r,g){for(var v=1114112,l=0,e=r.length;l<e;++l){var C=r[l];C>=g&&C<v&&(v=C)}if(1114112<=v)throw Error("Next smallest code point not found.");return v}function t(r){if(48<=r&&57>=r)return r-22;if(65<=r&&90>=r)return r-65;if(97<=r&&122>=r)return r-97;throw Error("Illegal digit #"+r);}function q(r,g){for(var v=[],l=36,e=g;;l+=36){var C=l<=r+1?1:l>=r+26?26:l-r;if(e<C){v.push(e+
(26>e?97:22));break}else{var N=v,A=C+(e-C)%(36-C);N.push.call(N,A+(26>A?97:22));e=~~((e-C)/(36-C))}}return v}function h(r){if("string"!=typeof r)return r;r=r.split("").map(function(K){return K.charCodeAt(0)});for(var g=[],v=[],l=0,e=r.length;l<e;++l){var C=r[l];128>C?g.push(C):v.push(C)}var N,A;(N=A=g.length)&&g.push(45);var w=128,f=72,J=0;for(e=r.length;A<e;++w,++J)for(l=n(v,w),J+=(l-w)*(A+1),w=l,l=0;l<e;++l)if(C=r[l],C<w){if(++J==m)throw Error("Delta overflow.");}else C==w&&(g=g.concat(q(f,J)),
f=c(J,A+1,N==A),J=0,A++);return String.fromCharCode.apply(String,g)}function b(r){if("string"!=typeof r)return r;var g=1+r.lastIndexOf("-");r=r.split("").map(function(u){return u.charCodeAt(0)});for(var v=r.slice(0,g?g-1:0),l=128,e=72,C=0,N=r.length;g<N;++C){for(var A=C,w=36,f=1;;w+=36){var J=t(r[g++]);C+=J*f;var K=w<=e+1?1:w>=e+26?26:w-e;if(J<K)break;f*=36-K}w=1+v.length;e=c(C-A,w,0==A);l+=~~(C/w);C%=w;v.splice(C,0,l)}return String.fromCharCode.apply(String,v)}if("string"!=typeof a||""==a)return a;
a=a.toLowerCase();var m=Math.pow(2,53);a=a.split(".");if(d)for(var p=0,k=a.length;p<k;++p){if(""!=a[p]&&"xn--"==a[p].substring(0,4)){var z=a[p].substring(4),G=b(z);G!=z&&(a[p]=G)}}else for(p=0,k=a.length;p<k;++p){G=h(a[p]);var y=G.length;z=G.substring(y-1,y);"-"==z&&G.substring(0,y-1)==a[p]||""==G||(a[p]="xn--"+G)}return a=a.join(".")}
function urlEncode(a,d){function c(m){m=m.toString(16).toUpperCase();2>m.length&&(m=0+m);return"%"+m}if(!a)return"";a+="";var n="beforequest"==d?/[ \r\n!*"'();@$,\[\]<>{}|`^\\\u0080-\uffff]/:"beforequest2"==d?/[ \r\n!*"'();@&=?+$,\[\]<>{}|`^\\\u0080-\uffff]/:d?/[ \r\n!*";:@&=+$,\/?%#\[\]<>{}|`^\\\u0080-\uffff]/:/[ \r\n!*"';@&=+$?%#\[\]<>{}|`^\\\u0080-\uffff]/,t=a.length,q,h=a.split(""),b;for(q=0;q<t;q++)if(b=h[q].match(n))b=b[0].charCodeAt(0),128>b?h[q]=c(b):2048>b?h[q]=c(192+(b>>6))+c(128+(b&63)):
65536>b?h[q]=c(224+(b>>12))+c(128+(b>>6&63))+c(128+(b&63)):2097152>b&&(h[q]=c(240+(b>>18))+c(128+(b>>12&63))+c(128+(b>>6&63))+c(128+(b&63)));return h.join("")}function urlDecode(a){return a?a.replace(/%[a-fA-F0-9]{2}/ig,function(d){return String.fromCharCode(parseInt(d.replace("%",""),16))}):""}
function parseHtmlEnteties(a){a=a.replace(/&amp;#/mg,"&#").replace(/&quot;/mg,'"').replace(/&quote;/mg,'"').replace(/&amp;/mg,"&").replace(/&lt;/mg,"<").replace(/&gt;/mg,">");return a.replace(/&#([0-9]{1,3});/gi,function(d,c){var n=parseInt(c,10);return String.fromCharCode(n)})}function dirnameFun(a){"/"!=a[0]&&(a="/"+a);return a.replace(/\\/g,"/").replace(/\/[^/]*\/?$/,"")}
function parse_url(a){a=a.trim();if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.no_urlsearchtoLowerCase){var d=a.match(/^([^?]*)(\?.*)?$/);a=(d&&void 0!==d[1]?d[1].toLowerCase():"")+(d&&void 0!==d[2]?d[2]:"")}else a=a.toLowerCase();(d=a.match(/^((((https?):)?\/\/)((([^:\/?&#]+[\.][^:\/?&#]+)|(\[[^\/?&#]+\]))?(?::([0-9]+))?(?!\.)))?(([\/\.\w\-][^?&#]*)?(\?[^#]*)?(#.*)?)?$/))&&(d[2]||d[5])&&d[11]&&"/"!=d[11].substr(0,1)&&"."!=d[11].substr(0,1)&&(d=null);full_protocol=d&&void 0!==d[2]?d[2]:
"";var c={};c.href=a;c.protocol=d&&void 0!==d[4]?d[4]:"";c.host=d&&void 0!==d[5]?d[5]:"";c.hostname=d&&void 0!==d[6]?d[6]:"";c.port=d&&void 0!==d[9]?d[9]:"";c.query=d&&void 0!==d[10]?d[10]:"";c.pathname=d&&void 0!==d[11]?d[11]:"";c.search=d&&void 0!==d[12]?d[12]:"";c.hash=d&&void 0!==d[13]?d[13]:"";return full_protocol+c.host+c.pathname+c.search+c.hash!==a?!1:c}function escapeRegExp(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}
function urlEncoding(a){Encoder.hasEncoded(a)&&(a=Encoder.htmlDecode(a));ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.no_urlsearchtoLowerCase?(a=a.match(/^([^?]*)(\?.*)?$/),a=(a&&void 0!==a[1]?a[1].toLowerCase():"")+(a&&void 0!==a[2]?a[2]:"")):a=a.toLowerCase();return a=urlEncode(a,"beforequest")}Object.extend=function(a,d){Object.keys(d).forEach(function(c){a[c]=d[c]});return a};function HashisEmpty(a){return 0===Object.keys(a).length}function ABORTHashisEmpty(a){return!a[""]}
function CreatePauseCampaign(a,d,c,n,t){if(AdWordsApp.getExecutionInfo().isPreview())return null;var q="Campaign;Budget;Bid Strategy type;Networks;Campaign type;Campaign status".split(";");a=a+"."+d+".";n&&(a+=" "+n);try{var h=AdWordsApp.bulkUploads().newCsvUpload(q,{moneyInMicros:!1});h.append({Campaign:a,Budget:c,"Bid Strategy type":"Manual CPC","Campaign type":"Search","Campaign status":"Paused",Networks:"Google search"});h.forCampaignManagement();h.apply();Utilities.sleep(5E3)}catch(b){ScanCreateFeedsGlobalVars.warnings+=
'Search Campaign with name "'+a+" not created: Exception: "+b.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.warnings)}n=AdWordsApp.campaigns().withCondition("CampaignName = '"+a.replace(/'/gm,"\\'")+"'").withCondition("CampaignStatus = PAUSED").withCondition("CampaignTrialType IN ['BASE']").get();if(n.hasNext())return n.next();n=getcurrentTime();n=("0"+n.getDate()).slice(-2)+"."+("0"+(n.getMonth()+1)).slice(-2);q=getLabel("LastcrUnknCaErr");t="\u041a\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043aa\u044f \u043e\u0448\u0438\u0431\u043a\u0430 (\u043d\u0443\u0436\u043d\u043e \u0441\u043e\u0437\u0434\u0430\u0442\u044c \u0432\u0440\u0443\u0447\u043d\u0443\u044e \u043e\u0434\u043d\u0443 \u0438\u043b\u0438 \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043a\u0430\u043c\u043f\u0430\u043d\u0438\u0439 - \u0441\u043c. \u043b\u043e\u0433) \u0432 \u0430\u043a\u043a\u0430\u0443\u043d\u0442\u0435 Adwords "+
t;q!=n&&"undefined"!=typeof criticalsupportemail&&criticalsupportemail&&MailApp.sendEmail(criticalsupportemail,t,t);q!=n&&(Logger.log(t),setLabel("LastcrUnknCaErr",n));Logger.log('Search Campaign with name "'+a+'" and with Budget '+c+" is not created in account, please create manually, exit");return null}
function CreatePauseCampaignOld(a,d,c,n){if(AdWordsApp.getExecutionInfo().isPreview())return null;var t=AdWordsApp.bulkUploads().newCsvUpload("Campaign;Budget;Campaign type;Campaign subtype;Bid Strategy type;Campaign state".split(";"),{moneyInMicros:!1});a=a+"."+d+".";n&&(a+=" "+n);t.append({Campaign:a,Budget:c,"Campaign type":"Search Only","Campaign subtype":"All features","Bid Strategy type":"cpc","Campaign state":"paused"});t.forCampaignManagement();t.apply();Utilities.sleep(5E3);n=AdWordsApp.campaigns().withCondition("CampaignName = '"+
a.replace(/'/gm,"\\'")+"'").withCondition("CampaignStatus = PAUSED").withCondition("CampaignTrialType IN ['BASE']").get();if(n.hasNext())return n.next();Logger.log("Search Campaign with name "+a+" and with Budget "+c+" is not created in account, please create manually, exit");return null}function awDateToDate(a){return new Date(a.year,floorN(a.month,0)-1,a.day,0,0,0)}function DateToawDate(a){return{year:a.getFullYear(),month:floorN(a.getMonth(),0)+1,day:a.getDate()}}
function SetCampaignadSchedules(a){if(!a.targeting().adSchedules().get().hasNext()){var d=Array(7);d[0]="SUNDAY";d[1]="MONDAY";d[2]="TUESDAY";d[3]="WEDNESDAY";d[4]="THURSDAY";d[5]="FRIDAY";d[6]="SATURDAY";for(var c=0;c<d.length;c++)for(var n=0;6>n;n++)a.addAdSchedule({dayOfWeek:d[c],startHour:4*n,startMinute:0,endHour:4*n+4,endMinute:0,bidModifier:1})}}
function CopyCampaignSettings(a,d){for(var c="",n=a.targeting(),t=d.targeting(),q=t.adSchedules().get();q.hasNext();){var h=q.next();h.remove();h.remove()}for(q=n.adSchedules().get();q.hasNext();)h=q.next(),d.addAdSchedule(h);for(q=t.targetedLocations().get();q.hasNext();)h=q.next(),h.remove(),h.remove();for(q=n.targetedLocations().get();q.hasNext();)h=q.next(),d.addLocation(h);for(q=t.excludedLocations().get();q.hasNext();)h=q.next(),h.remove(),h.remove();for(q=n.excludedLocations().get();q.hasNext();)h=
q.next(),d.excludeLocation(h);for(q=t.targetedProximities().get();q.hasNext();)h=q.next(),h.remove(),h.remove();for(q=n.targetedProximities().get();q.hasNext();)h=q.next(),d.addProximity(h);h=n.platforms().get();for(var b={};h.hasNext();){var m=h.next();q=m.getBidModifier();var p=m.getName();b[p]=q}for(h=t.platforms().get();h.hasNext();)m=h.next(),p=m.getName(),b.hasOwnProperty(p)?m.setBidModifier(b[p]):m.setBidModifier(0);d.setAdRotationType(a.getAdRotationType());q=a.getBudget().getAmount();d.getBudget().getAmount()!=
q&&d.getBudget().setAmount(q);if(q=a.bidding().getStrategy())d.bidding().setStrategy(q);else if(q=a.bidding().getStrategyType())try{d.bidding().setStrategy(q)}catch(k){d.bidding().setStrategy("MANUAL_CPC")}else d.bidding().setStrategy("MANUAL_CPC");q=a.getEndDate();h=d.getEndDate();JSON.stringify(q)!=JSON.stringify(h)&&(null===q?d.setEndDate("20371230"):(h=getcurrentTime(),h=new Date(h.getFullYear(),h.getMonth(),h.getDate()),awDateToDate(q).getTime()<h.getTime()?d.setEndDate(DateToawDate(h)):d.setEndDate(q)));
h=d.extensions();q=a.extensions();for(b=h.callouts().get();b.hasNext();)m=b.next(),d.removeCallout(m);for(b=q.callouts().get();b.hasNext();)m=b.next(),d.addCallout(m);for(b=h.phoneNumbers().get();b.hasNext();)m=b.next(),d.removePhoneNumber(m);for(b=q.phoneNumbers().get();b.hasNext();)m=b.next(),d.addPhoneNumber(m);for(b=h.mobileApps().get();b.hasNext();)m=b.next(),d.removeMobileApp(m);for(b=q.mobileApps().get();b.hasNext();)m=b.next(),d.addMobileApp(m);for(b=h.sitelinks().get();b.hasNext();)m=b.next(),
d.removeSitelink(m);for(b=q.sitelinks().get();b.hasNext();)m=b.next(),d.addSitelink(m);for(h=h.snippets().get();h.hasNext();)b=h.next(),d.removeSnippet(b);for(h=q.snippets().get();h.hasNext();)b=h.next(),d.addSnippet(b);for(q=d.negativeKeywordLists().get();q.hasNext();)h=q.next(),d.removeNegativeKeywordList(h);for(q=a.negativeKeywordLists().get();q.hasNext();)h=q.next(),d.addNegativeKeywordList(h);for(q=d.excludedPlacementLists().get();q.hasNext();)h=q.next(),d.removeExcludedPlacementList(h);for(q=
a.excludedPlacementLists().get();q.hasNext();)h=q.next(),d.addExcludedPlacementList(h);for(h=t.audiences().get();h.hasNext();)b=h.next(),m=b.getAudienceType(),"USER_INTEREST"!=m&&(b.remove(),b.remove());for(h=t.excludedAudiences().get();h.hasNext();)b=h.next(),b.remove(),b.remove();q=n.getTargetingSetting("USER_INTEREST_AND_LIST");t.setTargetingSetting("USER_INTEREST_AND_LIST",q);for(h=n.audiences().get();h.hasNext();)b=h.next(),p=b.getAudienceId(),q=b.bidding().getBidModifier(),m=b.getAudienceType(),
"USER_INTEREST"!=m&&(q=t.newUserListBuilder().withAudienceId(p).withBidModifier(q).build(),q.isSuccessful()?q.getResult():c+=q.getErrors()+"\n");for(h=n.excludedAudiences().get();h.hasNext();)b=h.next(),p=b.getAudienceId(),q=t.newUserListBuilder().withAudienceId(p).exclude(),q.isSuccessful()?q.getResult():c+=q.getErrors()+"\n";return c}
function preparestartFeed(){var a=ScanCreateFeedsGlobalVars.SITE,d=parse_url(a);if(!1===d)return ScanCreateFeedsGlobalVars.errors+="Not good parameter SITE.\n",Logger.log(ScanCreateFeedsGlobalVars.errors),!1;var c=d.host,n;if(c&&(n=c.match(/([^a-zA-Z0-9\-\.])/))&&n[1]&&(c=idndomain(c),a=(d.protocol?d.protocol+"://":"")+c+(d.port?":"+d.port:"")+(d.query?d.query:""),d=parse_url(a),!1===d))return ScanCreateFeedsGlobalVars.errors+="Not good parameter SITE.\n",Logger.log(ScanCreateFeedsGlobalVars.errors),
!1;n=urlEncoding(a);n!==a?(a=n,d=parse_url(a)):a=n;if(c&&"/"!=d.pathname.substr(0,1)&&(d=parse_url(a),a=(d.protocol?d.protocol+"://":"")+d.hostname+d.port+"/"+d.pathname+d.search,d=parse_url(a),!1===d))return ScanCreateFeedsGlobalVars.errors+="Not good parameter SITE.\n",Logger.log(ScanCreateFeedsGlobalVars.errors),!1;ScanCreateFeedsGlobalVars.SITE_SCHEME=d.protocol;c=ScanCreateFeedsGlobalVars.SITE_SCHEME;ScanCreateFeedsGlobalVars.SITE_HOST=d.host;ScanCreateFeedsGlobalVars.url=a;if(!c)return ScanCreateFeedsGlobalVars.errors+=
"Not good parameter SITE (protocol not exist).\n",Logger.log(ScanCreateFeedsGlobalVars.errors),!1;if((d=ScanCreateFeedsGlobalVars.valid_scheme)&&d.length&&c){a=0;for(var t in d)d[t]==c&&(a=1);a||(ScanCreateFeedsGlobalVars.errors+="Not good parameter SITE (it protocol not exist in parameter valid_scheme).\n",Logger.log(ScanCreateFeedsGlobalVars.errors))}return!1}
function startFeed(a,d,c){var n=!1,t=ScanCreateFeedsGlobalVars.url;d.array&&d.seed===ScanCreateFeedsGlobalVars.seed&&d.host===ScanCreateFeedsGlobalVars.host||(d.seed=ScanCreateFeedsGlobalVars.seed,d.host=ScanCreateFeedsGlobalVars.SITE_HOST,d.array={});if(!a.scanned.scanned){a.scanned.scanned=[];a.scanned.checked=[];a.scanned.URLHASHIDscanned={};a.scanned.errors={};a.scanned.errors.response={};a.scanned.errors.unknown=0;a.scanned.errors.unknownCSV=0;a.scanned.errors.abnormal_exits=0;a.scanned.errors.quick_exits=
0;a.scanned.errors.emptyCType=0;a.scanned.errors.notHtml=0;a.scanned.scnuncur=0;a.scanned.FeedsFilesOUT={};a.scanned.SearchFeedsFilesOUT={};a.scanned.parced_urls={};a.scanned.GASearch_urls={};a.scanned.addfeed_urls={};a.scanned.GASearch_modifyurls={};a.scanned.NOparced_urls={};a.scanned.dublicates_urls=0;a.scanned.GASearch={};a.scanned.GASearchForEachCompany={};a.scanned.GASearchCurrentCompany={};for(var q in a.CURfeedsIds)a.scanned.parced_urls[q]=0,a.scanned.GASearch_urls[q]=0,a.scanned.addfeed_urls[q]=
0,a.scanned.GASearch_modifyurls[q]=0,a.scanned.NOparced_urls[q]=0,a.scanned.FeedsFilesOUT[q]={},a.scanned.SearchFeedsFilesOUT[q]="",a.scanned.GASearch[q]={},a.scanned.GASearchForEachCompany[q]=[],a.scanned.GASearchCurrentCompany[q]=0;a.scanned.checked_urls=0;a.scanned.FeedsFilesExistNames={}}var h=a.scanned;h.steps||(h.steps=0);if(ScanCreateFeedsGlobalVars.stopscan||ScanCreateFeedsGlobalVars.errors)return n;ScanCreateFeedsGlobalVars.GASearchHASH={};for(q in a.CURfeedsIds)ScanCreateFeedsGlobalVars.GASearchHASH[q]=
{};ScanCreateFeedsGlobalVars.GASearchCampaigns={};ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum={};for(q in a.CURfeedsIds)ScanCreateFeedsGlobalVars.GASearchCampaigns[q]=[],ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[q]=0;var b=0;if(!h.scnuncur||h.scnuncur<=h.scanned.length){b=1;var m=a.config[a.scannId.IdNum];if(m.repeaterUrl){var p={contentType:"text/html",muteHttpExceptions:!0,followRedirects:!1,headers:{Referer:"http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"}};p=UrlFetchApp.fetch(m.repeaterUrl,
p);var k=p.getResponseCode();if(200!=k||p.getContentText())return ScanCreateFeedsGlobalVars.errors+="Not found repeater from parameter repeaterUrl\n",Logger.log(ScanCreateFeedsGlobalVars.errors),n}var z="";m=a.config[a.scannId.IdNum];for(var G in m)if(m.feeds[G]&&a.CURfeedsIds[G]){var y,r=m[G];if((r=r.GASearch)&&r.Id){for(k=AdWordsApp.campaigns().withCondition("CampaignName CONTAINS '"+r.Id.replace(/'/gm,"\\'")+".'").withCondition("CampaignStatus != REMOVED").withCondition("CampaignTrialType IN ['BASE']").get();k.hasNext();){p=
k.next();var g=p.getId(),v=p.getName(),l=v.match(new RegExp("(?:^|\\s)"+escapeRegExp(r.Id)+"\\.(\\d+)\\."));if(l&&l[1]){var e=Number(l[1]);l=p.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get().totalNumEntities();ScanCreateFeedsGlobalVars.GASearchCampaigns[G][e]?(removeCampaignbuffer(g),Logger.log("Campaign ("+e+") with GASearch Id "+r.Id+" have duplicate company name in account. Removed\n")):(-1!=ScanCreateFeedsGlobalVars.CustomerName.indexOf("NOBIDM")?
g=r.startbid:(v=v.replace(/(MCLSET1?:\d*:\d+),/gm,"$1."),g=null!==(y=(new RegExp(/MCLSET1?:\d*:(\d+(\.\d+)?)/)).exec(v))&&y[1]?floorN(y[1],2):r.startbid),ScanCreateFeedsGlobalVars.GASearchCampaigns[G][e]=[p,l,g],e||SetCampaignadSchedules(p))}else Logger.log("Campaign have Name: "+v+" similar with GASearch Id: ' + GAS['Id'] + '. Better change this name\n")}AdWordsApp.getExecutionInfo().isPreview()&&ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length&&!ScanCreateFeedsGlobalVars.GASearchCampaigns[G][0]&&
(l=r.Id+".0.MCLSET1:2:"+r.startbid,ScanCreateFeedsGlobalVars.errors+="Not found main company (.0.) for GASearch Id "+r.Id+",  create main company '"+l+"' and repeat test.\n",Logger.log(ScanCreateFeedsGlobalVars.errors));if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)for(k=0;k<ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length;k++)ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]&&ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0].isEnabled()&&ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0].pause();
else{l=p=null;for(k=ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length-1;0<=k;k--)ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]?(ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][1]<MaxAdGroupsLimit&&(p=k),ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[G]++):l=k;k=null;null===p?(k=null===l?ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length:l,h.GASearchCurrentCompany[G]=k):null!==l&&0===l?(k=l,h.GASearchCurrentCompany[G]=k):(l=0,h.GASearchCurrentCompany[G]===p?l=1:ScanCreateFeedsGlobalVars.GASearchCampaigns[G]&&
ScanCreateFeedsGlobalVars.GASearchCampaigns[G][h.GASearchCurrentCompany[G]]&&ScanCreateFeedsGlobalVars.GASearchCampaigns[G][h.GASearchCurrentCompany[G]][1]<MaxAdGroupsLimit&&(l=1),l||(h.GASearchCurrentCompany[G]=p));null!==k&&(p=CreatePauseCampaign(r.Id,k,r.Budget,"MCLSET1:2:"+r.startbid,c),p||(z+="Campaign with GASearch Id "+r.Id+" maybe creating now in account, exit\n",Logger.log(z)),p&&(l=p.getName(),Logger.log("Campaign "+l+" with GASearch Id "+r.Id+" is now created in account, continue"),l=p.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get().totalNumEntities(),
ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]=[p,l,r.startbid],ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[G]++,k?((l=CopyCampaignSettings(ScanCreateFeedsGlobalVars.GASearchCampaigns[G][0][0],p))&&Logger.log("Campaign ("+k+") with GASearch Id "+r.Id+" have errors when copy audiences:\n"+l),ScanCreateFeedsGlobalVars.GASearchCampaigns[G][0][0].isEnabled()&&p.enable()):SetCampaignadSchedules(p)));if(ScanCreateFeedsGlobalVars.GASearchCampaigns[G][0])if(ScanCreateFeedsGlobalVars.GASearchCampaigns[G][0][0].isEnabled())for(k=
1;k<ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length;k++)ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]&&ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0].isPaused()&&((l=CopyCampaignSettings(ScanCreateFeedsGlobalVars.GASearchCampaigns[G][0][0],ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0]))&&Logger.log("Campaign ("+k+") with GASearch Id "+r.Id+" have errors when copy audiences:\n"+l),ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0].enable());else for(k=1;k<ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length;k++)ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]&&
ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0].isEnabled()&&ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0].pause()}}}if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)return n;if(z)return b=ScanCreateFeedsGlobalVars.SITE+"\n",b+="CREATE SEARCH CAMPAIGNS: "+z+"\n\n",h.report=b,Logger.log(b),!0;if(!h.steps){m=SCRIPT_ID_NAME+".SCANCADGRSRUN";e=getLabel(m);null!==e?(Logger.log("Previos start was aborted for attach adgroups bases "+ScanCreateFeedsGlobalVars.SITE),z=1,h.errors.abnormal_exits=
1):(z=0,setLabel(m,"analytics data"));l=0;m=a.config[a.scannId.IdNum];for(G in m)if(m.feeds[G]&&a.CURfeedsIds[G]&&(y=h.GASearch[G],g=h.GASearchForEachCompany[G],r=m[G],r.GASearch&&r.GASearch.Id)){for(k=0;k<ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length;k++)if(ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]){p=ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0];v=SCRIPT_ID_NAME+":SCANCADGRS:"+md5(r.GASearch.Id)+"."+k+".";e=getLabel(v);if(null===e)g[k]={},setLabel(v,"analytics data");else if(g[k]||
(g[k]={}),!AdWordsApp.getExecutionInfo().isPreview()){var C=Object.keys(g[k]).length;if(z){var N=AdWordsApp.getExecutionInfo().isPreview()?p.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get().totalNumEntities():p.adGroups().withCondition("LabelNames CONTAINS_ANY ['"+v.replace(/'/gm,"\\'")+"']").withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get().totalNumEntities();C!=N&&(setLabel(v,Array(2010).join("-")),setLabel(v,
"analytics data"),g[k]={})}else if(!C)continue}e=AdWordsApp.getExecutionInfo().isPreview()?p.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get():p.adGroups().withCondition("LabelNames CONTAINS_NONE ['"+v.replace(/'/gm,"\\'")+"']").withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get();for(C=[];e.hasNext();)C.push(e.next());for(var A=N=e=0;A<C.length;A++){var w=C[A],f=String(w.getId()),J=w.getName(),K=w.isPaused(),
u=J.match(/st:(\d+(?:\-\d+)?):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):end/);if(u&&u[1]&&u[2]&&u[3]&&u[4]&&u[5]){var F=u[1],I=u[2],B=u[3],U=u[4],P=u[5],X=u[6],S=u[7],O=u[8],aa=u[9],T=u[10],da=u[11];u=u[12];y[F]||g[k][F]?g[k][F]&&g[k][F][0]!=f||!g[k][F]&&y[F]&&y[F][0]!=f?(l=1,Logger.log("Exit when check groups in search campaign "+r.GASearch.Id+"."+k+"., for "+F+" dublicate adroup "+J),e++,removeAdGroupbuffer(f)):!g[k][F]&&y[F]&&y[F][0]==f&&(ScanCreateFeedsGlobalVars.GASearchHASH[G][F]=
w,g[k][F]=y[F]):(ScanCreateFeedsGlobalVars.GASearchHASH[G][F]=w,g[k][F]=[f,K,I,B,U,P,X,S,O,aa,T,da,u],AdWordsApp.getExecutionInfo().isPreview()||w.applyLabel(v))}else l=1,Logger.log("Exit when check groups in search campaign "+r.GASearch.Id+"."+k+"., incorrect adroup "+J),e++,removeAdGroupbuffer(f);N++;if(50<N){if(shouldExitEarly())return Logger.log("Exit when check search campaigns"),h.report="Exit when check search campaigns\n",n=!0;N=0}}AdWordsApp.getExecutionInfo().isPreview()||(C=Object.keys(g[k]).length,
N=p.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get().totalNumEntities(),C!=N-e&&(ScanCreateFeedsGlobalVars.errors+="Exit when check search campaign "+r.GASearch.Id+"."+k+"., adroups num "+(N-e)+" is not equal dbase elements num "+C+" in it, error\n",Logger.log("Exit when check search campaign "+r.GASearch.Id+"."+k+"., adroups num "+(N-e)+" is not equal dbase elements num "+C+" in it, error")));y=Object.extend(y,g[k]);g[k]={}}if(shouldExitEarly())return Logger.log("Exit when check search campaigns"),
h.report="Exit when check search campaigns\n",n=!0}if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)return n;if(l)return h.report="Exit existdublicatesgroups\n",!0}m=SCRIPT_ID_NAME+".SCANRUN";e=getLabel(m);null!==e?(Logger.log("Previos start was aborted for scan "+ScanCreateFeedsGlobalVars.SITE),ScanCreateFeedsGlobalVars.warnings+="Previos start was aborted for scan "+ScanCreateFeedsGlobalVars.SITE+"\n",ScanCreateFeedsGlobalVars.ABORT=1,h.errors.abnormal_exits=1):(ScanCreateFeedsGlobalVars.ABORT=
0,setLabel(m,"analytics data"))}y=r=0;m=a.config[a.scannId.IdNum];z=m.CSVConfig&&!m.CSVConfig.parseUrls||m.notScanUrlsOnAnyPages?1:0;if(CONTROL_EMPTY_FEEDS)ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors||(Logger.log("Create all feeds empty, no Scan and exit for accaunt "+c),h.steps++),n=!1,y=1;else if(!h.scnuncur){if(m.CSVConfig){l=m.CSVConfig;if(l.repeaterUrl&&(p={contentType:"text/html",muteHttpExceptions:!0,followRedirects:!1,headers:{Referer:"http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"}},
p=UrlFetchApp.fetch(l.repeaterUrl,p),k=p.getResponseCode(),200!=k||p.getContentText()))return ScanCreateFeedsGlobalVars.errors+="Not found repeater from parameter repeaterUrl in CSVSITE\n",Logger.log(ScanCreateFeedsGlobalVars.errors),n;l.parseUrls&&!h.scanned[h.scnuncur]&&(h.scanned[h.scnuncur]=t,h.checked[h.scnuncur]=0);a.hasOwnProperty("CSVlisturlnum")||(a.CSVlisturlnum=0,a.CSVsiteurlnum=0,a.CSVsiteurlLastelem=null);for(q=a.CSVlisturlnum;q<l.CSVurls.length;q++){if(shouldExitEarly10()){Logger.log("Exit when get csv-list");
ScanCreateFeedsGlobalVars.warnings+="Exit when get csv-list\n";n=!0;break}n=l.CSVurls[q].csvParserConfig.xml?XMLScan(l,q,m,a,z):CSVScan(l,q,m,a,z);if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors){n=!1;y=1;break}if(n)break;else a.CSVlisturlnum=q+1,a.CSVsiteurlnum=0,a.CSVsiteurlLastelem=null}}else h.scanned[h.scnuncur]||(h.scanned[h.scnuncur]=t,h.checked[h.scnuncur]=0);if(!y&&!n){if(h.scanned[h.scnuncur]&&!h.checked[h.scnuncur]){OneAddtoScan(m,a,z);r++;if(1==r){h.steps++;var D=h.checked_urls}n=
Scan(h.scanned[h.scnuncur],h.scnuncur,m,a,d,z,c);1==r&&D==h.checked_urls&&(h.steps--,r=0)}n||h.scnuncur++;ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&h.checked_urls>=ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&(Logger.log("Current Scan checked MAX_CHECKED_URLS num urls, stop Scan and exit"),n=!1,y=1);ScanCreateFeedsGlobalVars.stopscan&&(Logger.log("All feeds added MAX_ADD_URLS num urls, stop Scan and exit"),n=!1,y=1)}}if(!(y||n||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)){for(;h.scnuncur<=
h.scanned.length;){if(h.scanned[h.scnuncur]&&!h.checked[h.scnuncur]){r++;1==r&&(h.steps++,D=h.checked_urls);n=Scan(h.scanned[h.scnuncur],h.scnuncur,m,a,d,z,c);1==r&&D==h.checked_urls&&(h.steps--,r=0);if(n)break;if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors)break}n||h.scnuncur++;if(ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&h.checked_urls>=ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS)break;if(ScanCreateFeedsGlobalVars.stopscan)break}ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&h.checked_urls>=
ScanCreateFeedsGlobalVars.MAX_CHECKED_URLS&&(Logger.log("Current Scan checked MAX_CHECKED_URLS num urls, stop Scan and exit"),n=!1);ScanCreateFeedsGlobalVars.stopscan&&(Logger.log("All feeds added MAX_ADD_URLS num urls, stop Scan and exit"),n=!1)}if(b)if(!(n||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors))for(G in m=a.config[a.scannId.IdNum],m){if(m.feeds[G]&&a.CURfeedsIds[G]&&(y=h.GASearch[G],r=m[G],r.GASearch&&r.GASearch.Id)){d=0;for(F in y)if(r.GASearch.removeNotFoundItem?removeAdGroupbuffer(y[F][0]):
y[F][1]||pauseAdGroupbuffer(y[F][0]),delete y[F],d++,100<d&&(d=0,shouldExitEarly())){ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly\n";n=!0;break}if(n)break;else if(r.GASearch.powerControl)for(k=0;k<ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length;k++)ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]&&(p=ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0],p.isPaused()&&p.enable());if(shouldExitEarly()){ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly\n";n=!0;break}}}else if(ScanCreateFeedsGlobalVars&&
ScanCreateFeedsGlobalVars.errors)for(G in m=a.config[a.scannId.IdNum],m)if(m.feeds[G]&&a.CURfeedsIds[G]&&(r=m[G],r.GASearch&&r.GASearch.Id)){if(2==r.GASearch.powerControl)for(k=0;k<ScanCreateFeedsGlobalVars.GASearchCampaigns[G].length;k++)ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k]&&(p=ScanCreateFeedsGlobalVars.GASearchCampaigns[G][k][0],p.isEnabled()&&p.pause());if(shouldExitEarly())break}m=a.config[a.scannId.IdNum];b&&(a.GASearchAllCampaignsNum=JSON.parse(JSON.stringify(ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum)));
b=ScanCreateFeedsGlobalVars.SITE+"\n";b+="Scanned step: "+h.steps+"\n";ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors&&(b+="EXECUTE ERRORS: "+ScanCreateFeedsGlobalVars.errors+"\n\n");ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.warnings&&(b+="EXECUTE WARNINGS: "+ScanCreateFeedsGlobalVars.warnings+"\n\n");ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.messages&&(b+="EXECUTE MESSAGES: "+ScanCreateFeedsGlobalVars.messages+"\n\n");b+="Request to scanned "+h.scanned.length+" URLS\n";
b+="Scanned "+h.checked_urls+" URLS\n\n";for(q in a.CURfeedsIds)m[q].GASearch&&m[q].GASearch.GAShtmlExt&&(m[q].GASearch.Id||m[q].GASearch.GAShtml)&&(b+="For GASearch "+q+" don't forget! add Campaigns Extensions:"+m[q].GASearch.GAShtmlExt+"\n\n"),a.GASearchAllCampaignsNum[q]||h.GASearch_modifyurls[q]||h.GASearch_urls[q]?(b+="Campaigns in GASearch "+q+" "+a.GASearchAllCampaignsNum[q]+" Num\n",b+="Add / Modify urls in GASearch "+q+" "+h.GASearch_modifyurls[q]+" URLS\n",b+="All urls in GASearch "+q+" "+
h.GASearch_urls[q]+" URLS\n"):b+="Campaigns in GASearch "+q+" "+a.GASearchAllCampaignsNum[q]+" Num\n",b+="All urls in feed "+q+" "+h.addfeed_urls[q]+" URLS\n",b=m[q].SKIP_FIRST_URLS?b+("Found parsed item urls for "+q+" "+h.parced_urls[q]+" URLS, but first "+m[q].SKIP_FIRST_URLS+" items skipped\n"):b+("Found parsed item urls for "+q+" "+h.parced_urls[q]+" URLS\n"),b=h.NOparced_urls[q]?b+("Not found parsed item urls for "+q+" "+h.NOparced_urls[q]+" URLS (see in log details)\n"):b+("Not found parsed item urls for "+
q+" "+h.NOparced_urls[q]+" URLS\n"),b+="\n";b+="Unknown errors: "+h.errors.unknown+"\n";h.errors.unknownCSV&&(b+="Unknown CSV errors: "+h.errors.unknownCSV+"\n");b+="Empty Content-Type errors: "+h.errors.emptyCType+"\n";b+="No html page errors: "+h.errors.notHtml+"\n";a=0;for(var Q in h.errors.response)b+="Responce errors ("+Q+"): "+h.errors.response[Q]+"\n",a=1;a||(b+="Responce errors: 0\n");b=h.errors.abnormal_exits?b+"Abnormal exits: YES\n":b+"Abnormal exits: no\n";b+="Add dublicates urls: "+h.dublicates_urls+
"\n";h.errors.quick_exits&&(b+="Quick exits num: "+h.errors.quick_exits+"\n");ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.debug&&(b+="Debug_On: yes\n");b+="Last execute time: "+floorN((1800-AdWordsApp.getExecutionInfo().getRemainingTime())/60,2)+"\n";b+="\n";!n||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.errors?Logger.log(b+"Current Scan Status: ended. Prepare to exit.\n"):(b=AdWordsApp.getExecutionInfo().isPreview()?b+"Current Scan Status: continue, but stopped in Preview.\nFeeds saved without waiting for completion.\n":
b+"Current Scan Status: continue.\n",b+="\n",Logger.log(b));h.report=b;ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.NOparsed_urls_list&&(NOparsed_urls_list_MAX?(h=0,a=ScanCreateFeedsGlobalVars.NOparsed_urls_list.split("\n"),Q=a.length,Q>NOparsed_urls_list_MAX&&(a.length=NOparsed_urls_list_MAX,h=1),a=a.join("\n"),h?Logger.log("ALL NOPARSED (NO ADD) URLS: "+Q+"\nFIRST "+NOparsed_urls_list_MAX+" NOPARSED (NO ADD) URLS: \n"+a):Logger.log("ALL NOPARSED (NO ADD) URLS: \n"+a)):Logger.log("ALL NOPARSED (NO ADD) URLS: \n"+
ScanCreateFeedsGlobalVars.NOparsed_urls_list));return n}function removeCampaignbuffer(a){ScanCreateFeedsGlobalVars&&(ScanCreateFeedsGlobalVars.removeCampaignupload||(ScanCreateFeedsGlobalVars.removeCampaignupload=AdsApp.bulkUploads().newCsvUpload(["Campaign ID","Campaign state"],{moneyInMicros:!1})),ScanCreateFeedsGlobalVars.removeCampaignupload.append({"Campaign ID":a,"Campaign state":"removed"}))}
function removeCampaignapply(){AdWordsApp.getExecutionInfo().isPreview()||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.removeCampaignupload&&ScanCreateFeedsGlobalVars.removeCampaignupload.apply()}
function enableAdGroupbuffer(a){ScanCreateFeedsGlobalVars&&(ScanCreateFeedsGlobalVars.enableAdGroupupload||(ScanCreateFeedsGlobalVars.enableAdGroupupload=AdsApp.bulkUploads().newCsvUpload(["Ad group ID","Ad group state"],{moneyInMicros:!1})),ScanCreateFeedsGlobalVars.enableAdGroupupload.append({"Ad group ID":a,"Ad group state":"enabled"}))}
function enableAdGroupapply(){AdWordsApp.getExecutionInfo().isPreview()||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.enableAdGroupupload&&ScanCreateFeedsGlobalVars.enableAdGroupupload.apply()}
function removeAdGroupbuffer(a){ScanCreateFeedsGlobalVars&&(ScanCreateFeedsGlobalVars.removeAdGroupupload||(ScanCreateFeedsGlobalVars.removeAdGroupupload=AdsApp.bulkUploads().newCsvUpload(["Ad group ID","Ad group state"],{moneyInMicros:!1})),ScanCreateFeedsGlobalVars.removeAdGroupupload.append({"Ad group ID":a,"Ad group state":"removed"}))}
function removeAdGroupapply(){AdWordsApp.getExecutionInfo().isPreview()||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.removeAdGroupupload&&ScanCreateFeedsGlobalVars.removeAdGroupupload.apply()}
function pauseAdGroupbuffer(a){ScanCreateFeedsGlobalVars&&(ScanCreateFeedsGlobalVars.pauseAdGroupupload||(ScanCreateFeedsGlobalVars.pauseAdGroupupload=AdsApp.bulkUploads().newCsvUpload(["Ad group ID","Ad group state"],{moneyInMicros:!1})),ScanCreateFeedsGlobalVars.pauseAdGroupupload.append({"Ad group ID":a,"Ad group state":"paused"}))}
function pauseAdGroupapply(){AdWordsApp.getExecutionInfo().isPreview()||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.pauseAdGroupupload&&ScanCreateFeedsGlobalVars.pauseAdGroupupload.apply()}
function removeKeywordbuffer(a,d){ScanCreateFeedsGlobalVars&&(ScanCreateFeedsGlobalVars.removeKeywordupload||(ScanCreateFeedsGlobalVars.removeKeywordupload=AdsApp.bulkUploads().newCsvUpload(["Keyword ID","Ad group ID","Ad group state"],{moneyInMicros:!1})),ScanCreateFeedsGlobalVars.removeKeywordupload.append({"Ad group ID":d,"Keyword ID":a,"Keyword state":"removed"}))}
function removeKeywordapply(){AdWordsApp.getExecutionInfo().isPreview()||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.removeKeywordupload&&ScanCreateFeedsGlobalVars.removeKeywordupload.apply()}
function pauseKeywordbuffer(a,d){ScanCreateFeedsGlobalVars&&(ScanCreateFeedsGlobalVars.pauseKeywordupload||(ScanCreateFeedsGlobalVars.pauseKeywordupload=AdsApp.bulkUploads().newCsvUpload(["Keyword ID","Ad group ID","Ad group state"],{moneyInMicros:!1})),ScanCreateFeedsGlobalVars.pauseKeywordupload.append({"Ad group ID":d,"Keyword ID":a,"Keyword state":"paused"}))}
function pauseKeywordapply(){AdWordsApp.getExecutionInfo().isPreview()||ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.pauseKeywordupload&&ScanCreateFeedsGlobalVars.pauseKeywordupload.apply()}function CheckSearchDisplay(a){a=["select AdvertisingChannelType from CAMPAIGN_PERFORMANCE_REPORT","where CampaignId IN ["+a+"]","during TODAY"].join(" ");for(a=AdWordsApp.report(a,{includeZeroImpressions:!0}).rows();a.hasNext();)return a.next().AdvertisingChannelType;return""}
function shouldExitEarly10(){return 600>AdWordsApp.getExecutionInfo().getRemainingTime()}function shouldExitEarly(){return AdWordsApp.getExecutionInfo().isPreview()?600>AdWordsApp.getExecutionInfo().getRemainingTime():80>AdWordsApp.getExecutionInfo().getRemainingTime()}function EXTREMEshouldExitEarly(){return 20>AdWordsApp.getExecutionInfo().getRemainingTime()}
function SkipURL(a){var d=ScanCreateFeedsGlobalVars.skip_query,c=ScanCreateFeedsGlobalVars.only_query,n=ScanCreateFeedsGlobalVars.scanFun;if(d&&d.length||c&&c.length||n){"/"!=a.substr(0,1)&&(a="/"+a);if(d&&d.length)for(var t in d)if("/"==d[t]){if("/"==a)return!0}else if(a.substr(0,d[t].length)==d[t])return!0;if(c&&c.length){d=0;for(t in c)"/"==c[t]?"/"==a&&(d=1):a.substr(0,c[t].length)==c[t]&&(d=1);if(!d)return!0}if(n)try{if(!n(a))return!0}catch(q){ScanCreateFeedsGlobalVars.errors+="bad function scanFun:"+
q.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}return!1}
function Scan(a,d,c,n,t,q,h){var b=ScanCreateFeedsGlobalVars.repeat_errors,m=ScanCreateFeedsGlobalVars.CHARSET,p=ScanCreateFeedsGlobalVars.IGNORE_EMPTY_CONTENT_TYPE,k=n.scanned,z=!1;if(0>d||0<k.checked[d])return z;ScanCreateFeedsGlobalVars.debug&&Logger.log("Scan "+a);k.checked_urls++;var G=c.repeaterUrl?{contentType:"text/html",muteHttpExceptions:!0,followRedirects:!1,headers:{Referer:"http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"}}:{contentType:"text/html",muteHttpExceptions:!0,followRedirects:!1},
y=ScanCreateFeedsGlobalVars.MAX_TRIES;y||(y=5);for(var r=0,g=0,v="",l=0;g<y&&!r;){l=0;g++;if(shouldExitEarly())return ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly 1\n",k.checked_urls--,z=!0;v="";try{var e=c.repeaterUrl?UrlFetchApp.fetch(c.repeaterUrl+urlEncode(a,"beforequest2"),G):UrlFetchApp.fetch(a,G);r=e.getResponseCode()}catch(Xa){(v=Xa.message)||(v=" ")}if(v)if(-1!=v.indexOf("Service invoked too many times in a short time")){var C=1E3,N=v.match(/Try Utilities\.sleep\((\d+)\)/);N&&
N[1]&&(C=1*N[1]);Utilities.sleep(C)}else{if(-1!=v.indexOf("Service invoked too many times"))return ScanCreateFeedsGlobalVars.debug?Logger.log("Service error: "+v):Logger.log("Scan "+a+"\nService error: "+v),ScanCreateFeedsGlobalVars.warnings+="Exit "+v+"\n",k.checked_urls--,k.checked[d]&&(k.checked[d]=0),z=!0}else if(!isValidResponseCode(r)){var A=e.getHeaders();if(A.Location){if(g<y&&b&&b.length){for(var w in b)if(b[w]==r){l=1;r=0;ScanCreateFeedsGlobalVars.REQUEST_DELAY&&Utilities.sleep(ScanCreateFeedsGlobalVars.REQUEST_DELAY);
break}if(l)continue}var f=A.Location;f=ValidateURL(a,f);if(0==f)return ScanCreateFeedsGlobalVars.debug&&Logger.log("Redirect to not valid url for scan: "+A.Location+"\n"),k.errors.unknown++,z;if(0<=k.scanned.indexOf(f))return k.errors.unknown++,z;if(g<y)k.checked[d]=1,a=f,d=k.scanned.length,k.scanned[d]=f,k.checked[d]=0,ScanCreateFeedsGlobalVars.debug&&Logger.log("Redirect to url: "+A.Location+" responceCode: "+r+"\n"),k.checked_urls++,r=0;else break}else{if(g<y){if(b&&b.length){for(w in b)if(b[w]==
r){l=1;r=0;ScanCreateFeedsGlobalVars.REQUEST_DELAY&&Utilities.sleep(ScanCreateFeedsGlobalVars.REQUEST_DELAY);break}if(l)continue}}else if(b&&b.length)for(w in b)b[w]==r&&(l=1);break}}}if(v){if(-1!=v.indexOf("Service invoked too many times in a short time"))return ScanCreateFeedsGlobalVars.debug&&Logger.log("Service error: "+v),ScanCreateFeedsGlobalVars.warnings+="Exit "+v+"\n",k.checked_urls--,k.checked[d]&&(k.checked[d]=0),!0;ScanCreateFeedsGlobalVars.debug?Logger.log("Unknown error: "+v):Logger.log("Scan "+
a+"\nUnknown error: "+v);k.errors.unknown++;k.checked[d]=1;return z}k.checked[d]=1;if(isValidResponseCode(r)){B=0;var J=null;A=e.getHeaders();A["Content-Type"]&&(J=A["Content-Type"].split(";"));var K=J&&J[0]?J[0].toLowerCase().trim():"";if("text/html"!=K&&(""!=K||!p))return""==K?k.errors.emptyCType++:k.errors.notHtml++,z;var u=e.getContentText(m);if("UTF-8"==m){var F="";(A=e.getHeaders())&&A["Content-Type"]&&(N=A["Content-Type"].match(/charset\s*=\s*["']?([^\\"'>\/\s]+)/))&&N[1]&&(F=N[1]);if(!F){var I=
RegExp("\\<meta[^\\>]+charset\\s*\\=\\s*[\\'\\\"]?\\s*([^\\/\\\"\\'\\> ]+)","i").exec(u);I&&(F=I[1])}F&&(F=F.toUpperCase(),m!=F&&(u=e.getContentText(F)))}ScanCreateFeedsGlobalVars.debug&&(3<ScanCreateFeedsGlobalVars.debug?Logger.log("Valid responceCode: "+r+"\nresponce (JSON.stringify):\n"+JSON.stringify(u)):1<ScanCreateFeedsGlobalVars.debug&&Logger.log("Valid responceCode: "+r+", responce length: "+u.length))}else{ScanCreateFeedsGlobalVars.debug&&Logger.log("Not valid responce: "+r);var B=1;k.errors.response[r+
""]?k.errors.response[r+""]++:k.errors.response[r+""]=1}var U=parse_url(a);U.protocol&&(ScanCreateFeedsGlobalVars.SITE_SCHEME=U.protocol);var P=0,X=U.pathname+U.search,S=murmurhash3_32_gc(X,c.seed);if(k.URLHASHIDscanned.hasOwnProperty(S)||t.array.hasOwnProperty(S)){if(t.array.hasOwnProperty(S))var O=t.array[S].indexOf(X);else{t.array[S]=[];if(k.URLHASHIDscanned.hasOwnProperty(S))for(D=0;D<k.URLHASHIDscanned[S].length;D++){var aa=parse_url(k.scanned[k.URLHASHIDscanned[S][D]]),T=aa.pathname+aa.search;
O=t.array[S].indexOf(T);-1==O&&(t.array[S][t.array[S].length]=T,k.dublicates_urls++,Logger.log("Add previos dublicate url "+T+" in HASH "+S+" for url "+X))}O=t.array[S].indexOf(X)}-1==O?(t.array[S][t.array[S].length]=X,da=S+"-"+t.array[S].length,k.dublicates_urls++,Logger.log("Add dublicate url "+X+" in HASH "+S)):da=O?S+"-"+O:S+"";k.URLHASHIDscanned.hasOwnProperty(S)?-1==k.URLHASHIDscanned[S].indexOf(d)?k.URLHASHIDscanned[S][k.URLHASHIDscanned[S].length]=d:da=!1:(k.URLHASHIDscanned[S]=[d],P=1)}else{var da=
S+"";k.URLHASHIDscanned[S]=[d];P=1}if(B){if(!1!==da&&l)for(var D in c)if(c.feeds[D]&&n.CURfeedsIds[D]){var Q=c[D];if(Q.GASearch&&Q.GASearch.Id){var R=k.GASearch[D];R[da]&&delete R[da]}}return z}Encoder.hasEncoded(u)&&(u=Encoder.htmlDecode(u));u=u.replace(/\r/g," ");u=u.replace(/\n/g," ");var Z=u=u.replace(/\t/g," ");u=u.replace(/(<!\-\-.*?\-\->)/g,"");u=u.replace(/(<script.*?<\/script>)/igm,"<script>\x3c/script>");u=u.replace(/(<noscript.*?<\/noscript>)/igm,"<noscript></noscript>");u=u.replace(/(<link .*?>)/igm,
"<link>");u=u.replace(/(<style.*?<\/style>)/igm,"<style></style>");if(!1!==da){if(shouldExitEarly())return ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly 2\n",k.checked_urls--,k.checked[d]&&(k.checked[d]=0),P&&delete k.URLHASHIDscanned[S],!0;ScanCreateFeedsGlobalVars.stopscan=1;var sa=0,V=0,fa={},oa={},ha="";for(D in c)if(c.feeds[D]&&n.CURfeedsIds[D]){if(EXTREMEshouldExitEarly()){var ia=c.SITE+"\n";ia+="Abnormal quick exit for url: "+a+"\n\n";Logger.log(ia);ScanCreateFeedsGlobalVars.warnings+=
"Exit EXTREMEshouldExitEarly 1\n";k.checked_urls--;k.checked[d]&&(k.checked[d]=0);P&&delete k.URLHASHIDscanned[S];k.errors.quick_exits++;return z=!0}fa[D]=null;oa[D]=0;Q=c[D];var ja=k.FeedsFilesOUT[D];R=k.GASearch[D];Q.childrenFeeds&&Q.parentFeed&&Q.childAddByRank&&oa[Q.parentFeed]&&(fa[D]=1);if(Q.GASearch&&Q.GASearch.Id)if(Q.MAX_ADD_URLS&&k.GASearch_urls[D]>=Q.MAX_ADD_URLS)if(Q.childrenFeeds){for(var Ga=1,ka=0;ka<Q.childrenFeeds.length;ka++){var za=Q.childrenFeeds[ka],Ha=c[za];if(Ha.GASearch&&Ha.GASearch.Id){if(!(Ha.MAX_ADD_URLS&&
k.GASearch_urls[za]>=Ha.MAX_ADD_URLS)){Ga=0;break}}else if(!(Ha.MAX_ADD_URLS&&k.addfeed_urls[za]>=Ha.MAX_ADD_URLS)){Ga=0;break}}if(Ga)continue;else ScanCreateFeedsGlobalVars.stopscan=0}else continue;else ScanCreateFeedsGlobalVars.stopscan=0;else if(Q.MAX_ADD_URLS&&k.addfeed_urls[D]>=Q.MAX_ADD_URLS)if(Q.childrenFeeds){Ga=1;for(ka=0;ka<Q.childrenFeeds.length;ka++)if(za=Q.childrenFeeds[ka],Ha=c[za],Ha.GASearch&&Ha.GASearch.Id){if(!(Ha.MAX_ADD_URLS&&k.GASearch_urls[za]>=Ha.MAX_ADD_URLS)){Ga=0;break}}else if(!(Ha.MAX_ADD_URLS&&
k.addfeed_urls[za]>=Ha.MAX_ADD_URLS)){Ga=0;break}if(Ga)continue;else ScanCreateFeedsGlobalVars.stopscan=0}else continue;else ScanCreateFeedsGlobalVars.stopscan=0;if(!Q.childrenFeeds){if(Q.parentFeed&&Q.childAddByRank&&oa[Q.parentFeed])continue}else if(!Q.ExistNotUsechildAddByRank&&Q.parentFeed&&Q.childAddByRank&&oa[Q.parentFeed])continue;var Aa=SkipParseURL(U.pathname+U.search,Q);if(!Aa){!1===Aa&&(V=1);var na=ParceFeedFields(u,Z,Q,c,da,a,fa[Q.parentFeed]);if(na&&na.checkedfields&&Object.keys(na.checkedfields).length){var la=
Q.checkFieldsFun;if(la)try{if(!la(na.checkedfields,a,D))continue}catch(Xa){ScanCreateFeedsGlobalVars.errors+="bad function checkFieldsFun:"+Xa.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}if(!ScanCreateFeedsGlobalVars.errors){sa=1;fa[D]=na.checkedfields;if(Q.childrenFeeds){if(Q.GASearch&&Q.GASearch.Id){if(Q.MAX_ADD_URLS&&k.GASearch_urls[D]>=Q.MAX_ADD_URLS)continue}else if(Q.MAX_ADD_URLS&&k.addfeed_urls[D]>=Q.MAX_ADD_URLS)continue;if(Q.parentFeed&&Q.childAddByRank&&oa[Q.parentFeed])continue;
k.parced_urls[D]++;if(Q.SKIP_FIRST_URLS&&k.parced_urls[D]<=Q.SKIP_FIRST_URLS)continue;Q.parentFeed&&Q.childAddByRank&&(oa[Q.parentFeed]||(oa[Q.parentFeed]=1));oa[D]=1}else{k.parced_urls[D]++;if(Q.SKIP_FIRST_URLS&&k.parced_urls[D]<=Q.SKIP_FIRST_URLS)continue;Q.parentFeed&&Q.childAddByRank&&(oa[Q.parentFeed]=1)}ScanCreateFeedsGlobalVars.debug&&Logger.log("Found parsed item url, all found parsed: "+k.parced_urls[D]);var qa=0;na.feedfiles_exist&&CreateFeed(na.checkedfields,Q.feed_fields_file_types,ja)&&
(qa=1,k.addfeed_urls[D]++,ScanCreateFeedsGlobalVars.debug&&Logger.log("Add url to feed, all found parsed: "+k.parced_urls[D]));na.search_exist&&Q.GASearch&&Q.GASearch.GAShtml&&CreateFeedSearch(na.checkedfields,c.shortWordsHash,Q.GASearch,k.SearchFeedsFilesOUT,D)&&!qa&&(k.addfeed_urls[D]++,ScanCreateFeedsGlobalVars.debug&&Logger.log("Add url to feed, all found parsed: "+k.parced_urls[D]));if(na.search_exist&&Q.GASearch&&Q.GASearch.Id){var db=CreateSearch(na.checkedfields,c.shortWordsHash,R,Q,da,D,
a,k.GASearchCurrentCompany[D]);if(db)if(k.GASearch_urls[D]++,1==db){if(k.GASearch_modifyurls[D]++,ScanCreateFeedsGlobalVars.debug&&Logger.log("Add/Modify url in GASearch, all found parsed: "+k.GASearch_urls[D]),ScanCreateFeedsGlobalVars.GASearchCampaigns[D][k.GASearchCurrentCompany[D]][1]++,ScanCreateFeedsGlobalVars.GASearchCampaigns[D][k.GASearchCurrentCompany[D]][1]>=MaxAdGroupsLimit){var ra=null,Ia=null;for(ka=ScanCreateFeedsGlobalVars.GASearchCampaigns[D].length;0<=ka;ka--)ScanCreateFeedsGlobalVars.GASearchCampaigns[D][ka]?
ScanCreateFeedsGlobalVars.GASearchCampaigns[D][ka][1]<MaxAdGroupsLimit&&(ra=ka):Ia=ka;if(null!==ra)k.GASearchCurrentCompany[D]=ra;else{null===Ia&&(Ia=ScanCreateFeedsGlobalVars.GASearchCampaigns[D].length);k.GASearchCurrentCompany[D]=Ia;var Fa=CreatePauseCampaign(Q.GASearch.Id,Ia,Q.GASearch.Budget,"MCLSET1:2:"+Q.GASearch.startbid,h);Fa||(ha+="Campaign with GASearch Id "+Q.GASearch.Id+" maybe creating now in account, exit\n",Logger.log(ha));if(Fa){var Bb=Fa.getName();Logger.log("Campaign "+Bb+" with GASearch Id "+
Q.GASearch.Id+" is now created in account, continue");var yb=Fa.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get().totalNumEntities();ScanCreateFeedsGlobalVars.GASearchCampaigns[D][Ia]=[Fa,yb,Q.GASearch.startbid];ScanCreateFeedsGlobalVars.GASearchAllCampaignsNum[D]++;if(Ia){var Cb=CopyCampaignSettings(ScanCreateFeedsGlobalVars.GASearchCampaigns[D][0][0],Fa);Cb&&Logger.log("Campaign ("+Ia+") with GASearch Id "+Q.GASearch.Id+" have errors when copy audiences:\n"+
Cb);ScanCreateFeedsGlobalVars.GASearchCampaigns[D][0][0].isEnabled()&&Fa.enable()}}}}}else ScanCreateFeedsGlobalVars.debug&&Logger.log("Check url in GASearch, all found parsed: "+k.GASearch_urls[D])}}}else!1===Aa&&(k.NOparced_urls[D]++,ScanCreateFeedsGlobalVars.debug&&Logger.log("Not found parsed item! all found NOparsed: "+k.NOparced_urls[D]),ScanCreateFeedsGlobalVars.NOparsed_urls_list+=D+" "+a+"\n")}}if(ScanCreateFeedsGlobalVars.errors){var Oa="Errors found for url: "+a+"\n";ScanCreateFeedsGlobalVars.errors+=
Oa;Logger.log(Oa)}if(ha)return ia=c.SITE+"\n",ia+="CREATE SEARCH CAMPAIGNS: "+ha+"\n\n",ScanCreateFeedsGlobalVars.warnings+="Exit warnstart 1\n",ScanCreateFeedsGlobalVars.warnings+=ia,Logger.log(ia),!0;if(ScanCreateFeedsGlobalVars.stopscan||1<k.checked_urls&&c.notScanUrlsOnItemPages&&(sa||V))return z}if(q)return z;var E=0,Wa=0,ea=0,ba=0,Va=0,ib=[];if(c.scanSelectors){var wa="";for(ka=0;ka<c.scanSelectors.length;ka++){var xb=parseHtml(u,c.scanSelectors[ka],"text");if(xb.errors)ScanCreateFeedsGlobalVars.errors+=
"errors "+xb.errors+", in parameter scanSelectors: "+c.scanSelectors[ka]+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors);else{var va=xb.result;if(va&&(Va++,ib.push(c.scanSelectors[ka]),c.onlyORskipSeparators)){for(var jb="",Za=0,ca=0;ca<c.onlyORskipSeparators.length;ca++){var Y=va.split(c.onlyORskipSeparators[ca][0][0]);if(Y[0]!=va){if(c.onlyORskipSeparators[ca][0][1]){for(var Ca=0,M=1;M<Y.length;M++)if(Y[M]){var H=Y[M].split(c.onlyORskipSeparators[ca][0][1]);if(H[0]==Y[M]){Ca=1;break}else Y[M]=
H[0]}else{Ca=1;break}if(Ca){ScanCreateFeedsGlobalVars.debug&&Logger.log("Not found end separator '"+c.onlyORskipSeparators[ca][0][1].toString()+"' after start separator '"+c.onlyORskipSeparators[ca][0][0].toString()+"' in onlyORskipSeparators for url "+a);continue}}Za++;if(c.onlyORskipSeparators[ca][1]){var Qa=c.onlyORskipSeparators[ca][1].length?c.onlyORskipSeparators[ca][1]:null,pa=c.onlyORskipSeparators[ca][2].length?c.onlyORskipSeparators[ca][2]:null,bb="function"==typeof c.onlyORskipSeparators[ca][3]?
c.onlyORskipSeparators[ca][3]:null,Da="";for(M=1;M<Y.length;M++)if(Y[M]){ba++;var La=0;if(Qa){for(var Ba=0,L=0;L<Qa.length;L++){var Ra=Qa[L],kb=Y[M].split(Ra);if(kb[0]!=Y[M]){Ba=1;break}}if(Ba)ea++,La=1;else{Wa++;continue}}var fb=0;if(pa){for(L=Ba=0;L<pa.length;L++)if(Ra=pa[L],kb=Y[M].split(Ra),kb[0]!=Y[M]){Ba=1;break}if(Ba){Wa++;La&&ea--;continue}else La||ea++,fb=1}if(bb)try{if(bb(Y[M]))La||fb||ea++;else{Wa++;continue}}catch(Xa){ScanCreateFeedsGlobalVars.errors+="error "+Xa.message+", in function of onlyORskipSeparators element: "+
ca+" with parameter: "+Y[M]+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);continue}Da+=Y[M]}}else for(Da="",M=1;M<Y.length;M++)Y[M]&&(ba++,Da+=Y[M]);jb+=Da}}Za?(va=jb,E+=Za):c.noSeparatorsNotScanUrls&&(va="")}wa+=va}}u=wa}else if(u&&c.onlyORskipSeparators){va=u;jb="";for(ca=Za=0;ca<c.onlyORskipSeparators.length;ca++)if(Y=va.split(c.onlyORskipSeparators[ca][0][0]),Y[0]!=va){if(c.onlyORskipSeparators[ca][0][1]){Ca=0;for(M=1;M<Y.length;M++)if(Y[M])if(H=Y[M].split(c.onlyORskipSeparators[ca][0][1]),
H[0]==Y[M]){Ca=1;break}else Y[M]=H[0];else{Ca=1;break}if(Ca){ScanCreateFeedsGlobalVars.debug&&Logger.log("Not found end separator '"+c.onlyORskipSeparators[ca][0][1].toString()+"' after start separator '"+c.onlyORskipSeparators[ca][0][0].toString()+"' in onlyORskipSeparators for url "+a);continue}}Za++;if(c.onlyORskipSeparators[ca][1])for(Qa=c.onlyORskipSeparators[ca][1].length?c.onlyORskipSeparators[ca][1]:null,pa=c.onlyORskipSeparators[ca][2].length?c.onlyORskipSeparators[ca][2]:null,bb="function"==
typeof c.onlyORskipSeparators[ca][3]?c.onlyORskipSeparators[ca][3]:null,Da="",M=1;M<Y.length;M++){if(Y[M]){ba++;La=0;if(Qa){for(L=Ba=0;L<Qa.length;L++)if(Ra=Qa[L],kb=Y[M].split(Ra),kb[0]!=Y[M]){Ba=1;break}if(Ba)ea++,La=1;else{Wa++;continue}}fb=0;if(pa){for(L=Ba=0;L<pa.length;L++)if(Ra=pa[L],kb=Y[M].split(Ra),kb[0]!=Y[M]){Ba=1;break}if(Ba){Wa++;La&&ea--;continue}else La||ea++,fb=1}if(bb)try{if(bb(Y[M]))La||fb||ea++;else{Wa++;continue}}catch(Xa){ScanCreateFeedsGlobalVars.errors+="error "+Xa.message+
", in function of onlyORskipSeparators element: "+ca+" with parameter: "+Y[M]+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);continue}Da+=Y[M]}}else for(Da="",M=1;M<Y.length;M++)Y[M]&&(ba++,Da+=Y[M]);jb+=Da}Za?(va=jb,E+=Za):c.noSeparatorsNotScanUrls&&(va="");u=va}if(ScanCreateFeedsGlobalVars.debug){var W="";if(c.scanSelectors){W+="found scanSelectors: "+Va;if(Va&&2<ScanCreateFeedsGlobalVars.debug)for(W+=" : ",ka=0;ka<ib.length;ka++)W=ka?W+(",'"+ib[ka]+"'"):W+("'"+ib[ka]+"'");W+="\n"}c.onlyORskipSeparators&&
(W=c.scanSelectors?W+("found All onlyORskipSeparators elements: "+E+" for found scanSelectors: "+Va+", All Item's Separators: "+ba+", good Separators: "+ea+", skip Separators: "+Wa+"\n"):W+("found onlyORskipSeparators elements: "+E+", All Item's Separators: "+ba+", good Separators: "+ea+", skip Separators: "+Wa+"\n"));W&&Logger.log(W)}var xa=u.indexOf("<a ");if(-1==xa)return z;u=u.substring(xa);var Ma=u.split("<a "),Sa=0,ya=[],$a=c.firstNewPages?k.scnuncur+1:k.scanned.length,ta=c.reverseNewUrls?0:
1;for(D=0;D<Ma.length;D++)if(f=Ma[D],f=f.trim())if(f=GetHREFValue(f))!(f=ValidateURL(a,f))||0<=k.scanned.indexOf(f)||(k.scanned.splice($a,0,f),k.checked.splice($a,0,0),ta&&$a++,Sa++,ya.push(f));if(ScanCreateFeedsGlobalVars.debug){W="found new urls: "+Sa;if(2<ScanCreateFeedsGlobalVars.debug)for(ka=0;ka<ya.length;ka++)W+="\n"+ya[ka];Logger.log(W)}return z}
function OneAddtoScan(a,d,c){if(a.hasOwnProperty("addscanUrls"))if("[object Array]"!=={}.toString.call(a.addscanUrls))Logger.log("NOT CORRECT param addscanUrls"),ScanCreateFeedsGlobalVars.warnings+="NOT CORRECT param addscanUrls\n";else if(!a.addscanUrls.length)Logger.log("NOT CORRECT param addscanUrls"),ScanCreateFeedsGlobalVars.warnings+="NOT CORRECT param addscanUrls\n";else if(!c){c=ScanCreateFeedsGlobalVars.SITE_SCHEME+"://"+ScanCreateFeedsGlobalVars.SITE_HOST;d=d.scanned;var n=0,t=0,q=a.firstNewPages?
d.scnuncur+1:d.scanned.length,h=a.reverseNewUrls?0:1;a=a.addscanUrls;for(var b=0;b<a.length;b++){var m=a[b];"string"==typeof m&&m&&(m=ValidateURL(c,m,1))&&(t++,0<=d.scanned.indexOf(m)||(d.scanned.splice(q,0,m),d.checked.splice(q,0,0),h&&q++,n++))}ScanCreateFeedsGlobalVars.debug?t!=a.length?(Logger.log("NOT ALL urls in addscanUrls add to scan urls: "+t+" from:"+a.length),ScanCreateFeedsGlobalVars.warnings+="NOT ALL urls in addscanUrls add to scan urls: "+t+" from:"+a.length+"\n"):t&&(n==t?Logger.log("all urls in addscanUrls add to scan urls: "+
t):(Logger.log("all urls in addscanUrls add to scan urls: "+t+", but real add urls:"+n),ScanCreateFeedsGlobalVars.warnings+="all urls in addscanUrls add to scan urls: "+t+", but real add urls:"+n+"\n")):t!=a.length&&(Logger.log("NOT ALL urls in addscanUrls add to scan urls: "+t+" from:"+a.length),ScanCreateFeedsGlobalVars.warnings+="NOT ALL urls in addscanUrls add to scan urls: "+t+" from:"+a.length+"\n")}}
function CSVScan(a,d,c,n,t){var q=ScanCreateFeedsGlobalVars.repeat_errors,h=a.CSVurls[d].CHARSET;c=a.CSVurls[d].url;var b=n.scanned,m=!1;Logger.log("Get CSV "+c);var p=a.repeaterUrl?{contentType:"text/plain",muteHttpExceptions:!0,followRedirects:!1,headers:{Referer:"http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"}}:{contentType:"text/plain",muteHttpExceptions:!0,followRedirects:!1},k=a.MAX_TRIES;k||(k=5);for(var z=0,G=0,y="",r;G<k&&!z;){r=0;G++;if(shouldExitEarly10())return ScanCreateFeedsGlobalVars.warnings+=
"Exit shouldExitEarly 11\n",m=!0;y="";try{var g=a.repeaterUrl?UrlFetchApp.fetch(a.repeaterUrl+urlEncode(c,"beforequest2"),p):UrlFetchApp.fetch(c,p);z=g.getResponseCode()}catch(K){(y=K.message)||(y=" ")}if(y)if(-1!=y.indexOf("Service invoked too many times in a short time")){r=1E3;var v=y.match(/Try Utilities\.sleep\((\d+)\)/);v&&v[1]&&(r=1*v[1]);Utilities.sleep(r)}else{if(-1!=y.indexOf("Service invoked too many times"))return ScanCreateFeedsGlobalVars.debug?Logger.log("Service error: "+y):Logger.log("Get CSV "+
c+"\nService error: "+y),ScanCreateFeedsGlobalVars.warnings+="Exit "+y+"\n",m=!0}else if(!isValidResponseCodeCSV(z,a))if(v=g.getHeaders(),v.Location){if(G<k&&q&&q.length){for(var l in q)if(q[l]==z){r=1;z=0;a.REQUEST_DELAY&&Utilities.sleep(a.REQUEST_DELAY);break}if(r)continue}var e=v.Location;e=ValidateCSVURL(c,e);if(0==e)return ScanCreateFeedsGlobalVars.errors+="Get CSV "+c+", redirect to not valid url: "+v.Location+"\n",Logger.log("CSV redirect to not valid url: "+v.Location+"\n"),b.errors.unknownCSV++,
m;if(G<k)c=e,ScanCreateFeedsGlobalVars.debug&&Logger.log("CSV redirect to url: "+v.Location+" responceCode: "+z+"\n"),z=0;else break}else{if(G<k){if(q&&q.length){for(l in q)if(q[l]==z){r=1;z=0;a.REQUEST_DELAY&&Utilities.sleep(a.REQUEST_DELAY);break}if(r)continue}}else if(q&&q.length)for(l in q);break}}if(y){if(-1!=y.indexOf("Service invoked too many times in a short time"))return ScanCreateFeedsGlobalVars.debug&&Logger.log("Service error: "+y),ScanCreateFeedsGlobalVars.warnings+="Exit "+y+"\n",!0;
ScanCreateFeedsGlobalVars.errors+="Get CSV "+c+", Unknown error: "+y+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);b.errors.unknownCSV++;return m}if(!isValidResponseCodeCSV(z,a))return ScanCreateFeedsGlobalVars.errors+="Get CSV "+c+", not valid responce for CSV-list: "+z+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors),b.errors.response[z+""]?b.errors.response[z+""]++:b.errors.response[z+""]=1,m;l=g.getContentText(h);"UTF-8"==h&&(q="",(v=g.getHeaders())&&v["Content-Type"]&&(v=v["Content-Type"].match(/charset\s*=\s*["']?([^\\"'>\/\s]+)/))&&
v[1]&&(q=v[1]),q||(p=RegExp("\\<meta[^\\>]+charset\\s*\\=\\s*[\\'\\\"]?\\s*([^\\/\\\"\\'\\> ]+)","i").exec(l))&&(q=p[1]),q&&(q=q.toUpperCase(),h!=q&&(l=g.getContentText(q))));ScanCreateFeedsGlobalVars.debug&&1<ScanCreateFeedsGlobalVars.debug&&Logger.log("Valid responceCode for CSV-list: "+z+", responce length: "+l.length);if(!l.length)return ScanCreateFeedsGlobalVars.warnings+="CSV file empty: "+c+"\n",Logger.log("CSV file empty: "+c),m;v=g.getHeaders();"string"==typeof v["Content-Length"]&&/^\d+$/.test(v["Content-Length"])&&
Number(v["Content-Length"])>l.length&&(Logger.log("CSV file maybe truncated: "+c+", expected length:"+v["Content-Length"]+", real length:"+l.length),ScanCreateFeedsGlobalVars.warnings+="CSV file maybe truncated: "+c+", expected length:"+v["Content-Length"]+", real length:"+l.length+"\n");if(shouldExitEarly10())return ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly 12\n",!0;a.CSVurls[d].csvParserConfig.skipEmptyLines="greedy";a.CSVurls[d].StartEndLines[0]&&a.CSVurls[d].StartEndLines[1]&&
(a.CSVurls[d].csvParserConfig.preview=a.CSVurls[d].StartEndLines[1]);g=Papa.parse(l,a.CSVurls[d].csvParserConfig);h=0;p=g.data.length;if(1<p)g.data[p-1].length<g.data[p-2].length&&(ScanCreateFeedsGlobalVars.warnings+="Delete bad last element in CSV Array: "+c+"\n",Logger.log("Delete bad last element in CSV Array: "+c),p--,g.data.length=p,h=1);else if(!p)return ScanCreateFeedsGlobalVars.warnings+="CSV Array empty: "+c+"\n",Logger.log("CSV file empty: "+c),m;ScanCreateFeedsGlobalVars.messages+="CSV data.length = "+
g.data.length+"\n";if(ScanCreateFeedsGlobalVars.debug){h&&Logger.log("deleted last element in csv array");Logger.log("csv data.length = "+g.data.length);Logger.log("csv data first = "+g.data[0]);Logger.log("csv data last = "+g.data[g.data.length-1]);Logger.log("csv meta = "+JSON.stringify(g.meta));Logger.log("csv errors = "+JSON.stringify(g.errors));h="Columns in first csv element:\n";for(z=0;z<g.data[0].length;z++)h+="Column["+z+"]=`"+g.data[0][z]+"`\n";Logger.log(h);if(1<p){h="Columns in second csv element:\n";
for(z=0;z<g.data[1].length;z++)h+="Column["+z+"]=`"+g.data[1][z]+"`\n";Logger.log(h)}if(2<p){h="Columns in last csv element:\n";for(z=0;z<g.data[p-1].length;z++)h+="Column["+z+"]=`"+g.data[p-1][z]+"`\n";Logger.log(h)}}if(n.CSVsiteurlnum&&n.CSVsiteurlLastelem&&(h=0,g.data[n.CSVsiteurlLastelem[0]]?JSON.stringify(g.data[n.CSVsiteurlLastelem[0]])!=JSON.stringify(n.CSVsiteurlLastelem[1])&&(h=1):h=1,h))return b.scanned=[],b.checked=[],n.CSVlisturlnum=0,n.CSVsiteurlnum=0,n.CSVsiteurlLastelem=null,ScanCreateFeedsGlobalVars.warnings+=
"Exit, reload all csv-lists. Was changed csv-list"+c+"\n",!0;if(a.CSVurls[d].StartEndLines[0]&&a.CSVurls[d].StartEndLines[1]&&p>a.CSVurls[d].StartEndLines[1]&&(p=a.CSVurls[d].StartEndLines[1],g.data.length=p,ScanCreateFeedsGlobalVars.messages+="Truncate csv data.length, new CSV data.length = "+g.data.length+"\n",ScanCreateFeedsGlobalVars.debug)){Logger.log("Truncate csv data.length in parameter StartEndLines");Logger.log("new csv data.length = "+g.data.length);Logger.log("csv data first = "+g.data[0]);
Logger.log("csv data last = "+g.data[g.data.length-1]);h="Columns in last csv element:\n";for(z=0;z<g.data[p-1].length;z++)h+="Column["+z+"]=`"+g.data[p-1][z]+"`\n";Logger.log(h)}(l=a.CSVurls[d].StartEndLines[0])?(l--,h=g.data.length-1):(l=0,h=g.data.length-1,a.CSVurls[d].StartEndLines[1]&&h>a.CSVurls[d].StartEndLines[1]-1&&(h=a.CSVurls[d].StartEndLines[1]-1));t||h++;n.CSVsiteurlnum>l?z=n.CSVsiteurlnum:(z=l,n.CSVsiteurlnum=l);t="";1<a.CSVurls[d].url_column_replace.length?(t=a.CSVurls[d].url_column_replace[1],
Logger.log("Url check column "+a.CSVurls[d].url_column_replace[0]+", example in first csv element : `"+g.data[0][a.CSVurls[d].url_column_replace[0]]+"`, CSVRow-Array: `"+JSON.stringify(g.data[0])+"`, ExecFun: `"+t.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<p&&Logger.log("Url check column "+a.CSVurls[d].url_column_replace[0]+", example in second csv element : `"+g.data[1][a.CSVurls[d].url_column_replace[0]]+"`, CSVRow-Array: `"+JSON.stringify(g.data[1])+"`, ExecFun: `"+t.toString()+"`"),2<
p&&Logger.log("Url check column "+a.CSVurls[d].url_column_replace[0]+", example in last csv element: `"+g.data[p-1][a.CSVurls[d].url_column_replace[0]]+"`, CSVRow-Array: `"+JSON.stringify(g.data[p-1])+"`, ExecFun: `"+t.toString()+"`"))):(Logger.log("Url check column "+a.CSVurls[d].url_column_replace[0]+", example in first csv element : `"+g.data[0][a.CSVurls[d].url_column_replace[0]]+"`, ExecFun: `"+t.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<p&&Logger.log("Url check column "+a.CSVurls[d].url_column_replace[0]+
", example in second csv element : `"+g.data[1][a.CSVurls[d].url_column_replace[0]]+"`, ExecFun: `"+t.toString()+"`"),2<p&&Logger.log("Url check column "+a.CSVurls[d].url_column_replace[0]+", example in last csv element: `"+g.data[p-1][a.CSVurls[d].url_column_replace[0]]+"`, ExecFun: `"+t.toString()+"`")));l=null;a.CSVurls[d].onlySeparator.length&&(l=a.CSVurls[d].onlySeparator[1],Logger.log("onlySeparator check column "+a.CSVurls[d].onlySeparator[0]+", example in first csv element : `"+g.data[0][a.CSVurls[d].onlySeparator[0]]+
"`, Separator: `"+l.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<p&&Logger.log("onlySeparator check column "+a.CSVurls[d].onlySeparator[0]+", example in second csv element : `"+g.data[1][a.CSVurls[d].onlySeparator[0]]+"`, Separator: `"+l.toString()+"`"),2<p&&Logger.log("onlySeparator check column "+a.CSVurls[d].onlySeparator[0]+", example in last csv element : `"+g.data[p-1][a.CSVurls[d].onlySeparator[0]]+"`, Separator: `"+l.toString()+"`")));q=null;a.CSVurls[d].skipSeparator.length&&(q=a.CSVurls[d].skipSeparator[1],
Logger.log("skipSeparator check column "+a.CSVurls[d].skipSeparator[0]+", example in first csv element : `"+g.data[0][a.CSVurls[d].skipSeparator[0]]+"`, Separator: `"+q.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<p&&Logger.log("skipSeparator check column "+a.CSVurls[d].skipSeparator[0]+", example in second csv element : `"+g.data[1][a.CSVurls[d].skipSeparator[0]]+"`, Separator: `"+q.toString()+"`"),2<p&&Logger.log("skipSeparator check column "+a.CSVurls[d].skipSeparator[0]+", example in last csv element : `"+
g.data[p-1][a.CSVurls[d].skipSeparator[0]]+"`, Separator: `"+q.toString()+"`")));for(var C=r=v=y=G=k=p=0;z<g.data.length;z++){k++;if(500<k&&(k=0,shouldExitEarly()))return ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly CSV create dbase\n",n.CSVsiteurlnum=z,n.CSVsiteurlLastelem=[z,JSON.parse(JSON.stringify(g.data[z]))],m=!0;if(l)try{for(var N=0,A=0;A<l.length;A++){var w=l[A],f=g.data[z][a.CSVurls[d].onlySeparator[0]].split(w);if(f[0]!==g.data[z][a.CSVurls[d].onlySeparator[0]]){N=1;break}}if(!N)continue}catch(K){ScanCreateFeedsGlobalVars.debug&&
10>G&&(G++,Logger.log("Error "+K.message+" in dataNum: "+z+" in onlySeparator, check column "+a.CSVurls[d].onlySeparator[0]+", CSVRow-Array: `"+JSON.stringify(g.data[z])+"`, Separator: `"+l.toString()+"`"));b.errors.unknownCSV++;continue}if(q)try{for(A=N=0;A<q.length;A++)if(w=q[A],f=g.data[z][a.CSVurls[d].skipSeparator[0]].split(w),f[0]!==g.data[z][a.CSVurls[d].skipSeparator[0]]){N=1;break}if(N)continue}catch(K){ScanCreateFeedsGlobalVars.debug&&10>y&&(y++,Logger.log("Error "+K.message+"  in dataNum: "+
z+" in skipSeparator, check column "+a.CSVurls[d].skipSeparator[0]+", CSVRow-Array: `"+JSON.stringify(g.data[z])+"`, Separator: `"+q.toString()+"`"));b.errors.unknownCSV++;continue}if(t)try{e=t(a.CSVurls[d].url_column_replace[0],g.data[z]);if(!e)continue;if("string"!=typeof e){ScanCreateFeedsGlobalVars.debug&&10>v&&(v++,Logger.log("Bad return from ExecFun in dataNum: "+z+", function parameters: ("+a.CSVurls[d].url_column_replace[0]+","+JSON.stringify(g.data[z])+")"));b.errors.unknownCSV++;continue}e=
e.trim();if(!e)continue}catch(K){ScanCreateFeedsGlobalVars.debug&&10>r&&(r++,Logger.log("Error "+K.message+" in dataNum: "+z+" in ExecFun, function parameters: ("+a.CSVurls[d].url_column_replace[0]+","+JSON.stringify(g.data[z])+")"));b.errors.unknownCSV++;continue}else if(e=g.data[z][a.CSVurls[d].url_column_replace[0]]){if(e=e.trim(),!e){ScanCreateFeedsGlobalVars.debug&&10>C&&(C++,Logger.log("Empty url in dataNum: "+z+" check column "+a.CSVurls[d].url_column_replace[0]+", CSVRow-Array: `"+JSON.stringify(g.data[z])+
"`"));b.errors.unknownCSV++;continue}}else{ScanCreateFeedsGlobalVars.debug&&10>C&&(C++,Logger.log("Empty url in dataNum: "+z+" check column "+a.CSVurls[d].url_column_replace[0]+", CSVRow-Array: `"+JSON.stringify(g.data[z])+"`"));b.errors.unknownCSV++;continue}if((e=ValidateURL(c,e))&&!(0<=b.scanned.indexOf(e))){var J=b.scanned.length;b.scanned[J]=e;b.checked[J]=0;p++;if(J>=h)break}}ScanCreateFeedsGlobalVars.debug&&Logger.log("found new urls: "+p);return m}
function XMLfindArray(a,d,c){c||(c=0);if("object"===typeof a&&"[object Array]"==={}.toString.call(d)&&"number"===typeof c){var n={}.toString.call(a[d[c]]);if("[object Array]"==n||"[object Object]"==n)if(d.length<=c+1){if("[object Array]"===n)return a[d[c]]}else return"[object Array]"==n&&"number"!==typeof d[c+1]?void 0:XMLfindArray(a[d[c]],d,c+1)}}
function XMLobjectValue(a,d,c){c||(c=0);if("object"!==typeof a||"[object Array]"!=={}.toString.call(d)||"number"!==typeof c)return"";var n={}.toString.call(a[d[c]]);if("[object Array]"==n||"[object Object]"==n){if(d.length<=c+1)return a[d[c]];if("[object Array]"!==n)return XMLobjectValue(a[d[c]],d,c+1);if(d.length<=c+3){if(d.length<=c+1)return"";for(n=0;n<a[d[c]].length&&"string"===typeof a[d[c]][n][d[c+1]];)return XMLobjectValue(a[d[c]][n],d,c+1)}else for(n=0;n<a[d[c]].length&&"string"===typeof a[d[c]][n][d[c+
1]];n++)if(a[d[c]][n][d[c+1]]===d[c+2])return XMLobjectValue(a[d[c]][n],d,c+3);return""}return"[object String]"==n?a[d[c]]:""}
function XMLScan(a,d,c,n,t){function q(F){var I={};F=XmlService.parse(F).getRootElement();I[F.getName()]=h(F);return I}function h(F){var I={};F.getAttributes().forEach(function(B){I[B.getName()]=B.getValue()});F.getChildren().forEach(function(B){var U=B.getName();B=h(B);I[U]?(I[U]instanceof Array||(I[U]=[I[U]]),I[U].push(B)):I[U]=B});F.getText()&&(I.Text=F.getText());return I}var b=ScanCreateFeedsGlobalVars.repeat_errors,m=a.CSVurls[d].CHARSET;c=a.CSVurls[d].url;var p=n.scanned,k=!1;Logger.log("Get XML "+
c);var z=a.repeaterUrl?{contentType:"text/plain",muteHttpExceptions:!0,followRedirects:!1,headers:{Referer:"http://cdn.pt.forgeofempires.com/swf/Main.swf?2345474885"}}:{contentType:"text/plain",muteHttpExceptions:!0,followRedirects:!1},G=a.MAX_TRIES;G||(G=5);for(var y=0,r=0,g="",v=0;r<G&&!y;){v=0;r++;if(shouldExitEarly10())return ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly 11\n",k=!0;g="";try{var l=a.repeaterUrl?UrlFetchApp.fetch(a.repeaterUrl+urlEncode(c,"beforequest2"),z):UrlFetchApp.fetch(c,
z);y=l.getResponseCode()}catch(F){(g=F.message)||(g=" ")}if(g)if(-1!=g.indexOf("Service invoked too many times in a short time")){v=1E3;var e=g.match(/Try Utilities\.sleep\((\d+)\)/);e&&e[1]&&(v=1*e[1]);Utilities.sleep(v)}else{if(-1!=g.indexOf("Service invoked too many times"))return ScanCreateFeedsGlobalVars.debug?Logger.log("Service error: "+g):Logger.log("Get XML "+c+"\nService error: "+g),ScanCreateFeedsGlobalVars.warnings+="Exit "+g+"\n",k=!0}else if(!isValidResponseCodeCSV(y,a))if(e=l.getHeaders(),
e.Location){if(r<G&&b&&b.length){for(var C in b)if(b[C]==y){v=1;y=0;a.REQUEST_DELAY&&Utilities.sleep(a.REQUEST_DELAY);break}if(v)continue}var N=e.Location;N=ValidateCSVURL(c,N);if(0==N)return ScanCreateFeedsGlobalVars.errors+="Get XML "+c+", redirect to not valid url: "+e.Location+"\n",Logger.log("XML redirect to not valid url: "+e.Location+"\n"),p.errors.unknownCSV++,k;if(r<G)c=N,ScanCreateFeedsGlobalVars.debug&&Logger.log("XML redirect to url: "+e.Location+" responceCode: "+y+"\n"),y=0;else break}else{if(r<
G){if(b&&b.length){for(C in b)if(b[C]==y){v=1;y=0;a.REQUEST_DELAY&&Utilities.sleep(a.REQUEST_DELAY);break}if(v)continue}}else if(b&&b.length)for(C in b)b[C]==y&&(v=1);break}}if(g){if(-1!=g.indexOf("Service invoked too many times in a short time"))return ScanCreateFeedsGlobalVars.debug&&Logger.log("Service error: "+g),ScanCreateFeedsGlobalVars.warnings+="Exit "+g+"\n",!0;ScanCreateFeedsGlobalVars.errors+="Get XML "+c+", Unknown error: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);p.errors.unknownCSV++;
return k}if(!isValidResponseCodeCSV(y,a))return ScanCreateFeedsGlobalVars.errors+="Get XML "+c+", not valid responce for XML-list: "+y+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors),p.errors.response[y+""]?p.errors.response[y+""]++:p.errors.response[y+""]=1,k;C=l.getContentText(m);"UTF-8"==m&&(b="",(e=l.getHeaders())&&e["Content-Type"]&&(e=e["Content-Type"].match(/charset\s*=\s*["']?([^\\"'>\/\s]+)/))&&e[1]&&(b=e[1]),b||(z=RegExp("\\<meta[^\\>]+charset\\s*\\=\\s*[\\'\\\"]?\\s*([^\\/\\\"\\'\\> ]+)",
"i").exec(C))&&(b=z[1]),b&&(b=b.toUpperCase(),m!=b&&(C=l.getContentText(b))));ScanCreateFeedsGlobalVars.debug&&1<ScanCreateFeedsGlobalVars.debug&&Logger.log("Valid responceCode for XML-list: "+y+", responce length: "+C.length);if(!C.length)return ScanCreateFeedsGlobalVars.warnings+="XML file empty: "+c+"\n",Logger.log("XML file empty: "+c),k;e=l.getHeaders();"string"==typeof e["Content-Length"]&&/^\d+$/.test(e["Content-Length"])&&Number(e["Content-Length"])>C.length&&(Logger.log("XML file maybe truncated: "+
c+", expected length:"+e["Content-Length"]+", real length:"+C.length),ScanCreateFeedsGlobalVars.warnings+="XML file maybe truncated: "+c+", expected length:"+e["Content-Length"]+", real length:"+C.length+"\n");if(shouldExitEarly10())return ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly 12\n",!0;try{var A=q(C)}catch(F){return ScanCreateFeedsGlobalVars.errors+="XML structure error: "+F.name+": "+F.message+"\n",Logger.log("XML structure error: "+F.name+": "+F.message+"\n"),k}A=XMLfindArray(A,
a.CSVurls[d].csvParserConfig.xml);if("[object Array]"!=={}.toString.call(A))return ScanCreateFeedsGlobalVars.errors+="XML config error (not found array "+a.CSVurls[d].csvParserConfig.xml+")\n",Logger.log("XML config error (not found array "+a.CSVurls[d].csvParserConfig.xml+")\n"),k;l=0;b=A.length;if(1<b)A[b-1].length<A[b-2].length&&(ScanCreateFeedsGlobalVars.warnings+="Delete bad last element in XML Array: "+c+"\n",Logger.log("Delete bad last element in XML Array: "+c),b--,A.length=b,l=1);else if(!b)return ScanCreateFeedsGlobalVars.warnings+=
"XML Array empty: "+c+"\n",Logger.log("XML file empty: "+c),k;ScanCreateFeedsGlobalVars.messages+="XML data.length = "+A.length+"\n";ScanCreateFeedsGlobalVars.debug&&(l&&Logger.log("deleted last element in xml array"),Logger.log("xml data.length = "+A.length),l="first xml element:\n"+JSON.stringify(A[0]),Logger.log(l),1<b&&(l="second xml element:\n"+JSON.stringify(A[1]),Logger.log(l)),2<b&&(l="last xml element:\n"+JSON.stringify(A[b-1]),Logger.log(l)));if(n.CSVsiteurlnum&&n.CSVsiteurlLastelem&&(l=
0,A[n.CSVsiteurlLastelem[0]]?JSON.stringify(A[n.CSVsiteurlLastelem[0]])!=JSON.stringify(n.CSVsiteurlLastelem[1])&&(l=1):l=1,l))return p.scanned=[],p.checked=[],n.CSVlisturlnum=0,n.CSVsiteurlnum=0,n.CSVsiteurlLastelem=null,ScanCreateFeedsGlobalVars.warnings+="Exit, reload all xml-lists. Was changed xml-list"+c+"\n",!0;a.CSVurls[d].StartEndLines[0]&&a.CSVurls[d].StartEndLines[1]&&b>a.CSVurls[d].StartEndLines[1]&&(b=a.CSVurls[d].StartEndLines[1],A.length=b,ScanCreateFeedsGlobalVars.messages+="Truncate xml data.length, new XML data.length = "+
A.length+"\n",ScanCreateFeedsGlobalVars.debug&&(Logger.log("Truncate xml data.length in parameter StartEndLines"),Logger.log("new xml data.length = "+A.length),Logger.log("xml data first = "+A[0]),Logger.log("xml data last = "+A[A.length-1]),l="last xml element:\n"+JSON.stringify(A[b-1]),Logger.log(l)));(m=a.CSVurls[d].StartEndLines[0])?(m--,l=A.length-1):(m=0,l=A.length-1,a.CSVurls[d].StartEndLines[1]&&l>a.CSVurls[d].StartEndLines[1]-1&&(l=a.CSVurls[d].StartEndLines[1]-1));t||l++;n.CSVsiteurlnum>
m?C=n.CSVsiteurlnum:(C=m,n.CSVsiteurlnum=m);t="";1<a.CSVurls[d].url_column_replace.length?(t=a.CSVurls[d].url_column_replace[1],Logger.log("Url find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+", example in first xml element : `"+XMLobjectValue(A[0],a.CSVurls[d].url_column_replace[0])+"`, XMLRow-Array: `"+JSON.stringify(A[0])+"`, ExecFun: `"+t.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<b&&Logger.log("Url find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+", example in second xml element : `"+
XMLobjectValue(A[1],a.CSVurls[d].url_column_replace[0])+"`, XMLRow-Array: `"+JSON.stringify(A[1])+"`, ExecFun: `"+t.toString()+"`"),2<b&&Logger.log("Url find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+", example in last xml element: `"+XMLobjectValue(A[b-1],a.CSVurls[d].url_column_replace[0])+"`, XMLRow-Array: `"+JSON.stringify(A[b-1])+"`, ExecFun: `"+t.toString()+"`"))):(Logger.log("Url find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+", example in first xml element : `"+
XMLobjectValue(A[0],a.CSVurls[d].url_column_replace[0])+"`, ExecFun: `"+t.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<b&&Logger.log("Url find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+", example in second xml element : `"+XMLobjectValue(A[1],a.CSVurls[d].url_column_replace[0])+"`, ExecFun: `"+t.toString()+"`"),2<b&&Logger.log("Url find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+", example in last xml element: `"+XMLobjectValue(A[b-1],a.CSVurls[d].url_column_replace[0])+
"`, ExecFun: `"+t.toString()+"`")));m=null;a.CSVurls[d].onlySeparator.length&&(m=a.CSVurls[d].onlySeparator[1],Logger.log("onlySeparator find array "+JSON.stringify(a.CSVurls[d].onlySeparator[0])+", example in first xml element : `"+XMLobjectValue(A[0],a.CSVurls[d].onlySeparator[0])+"`, Separator: `"+m.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<b&&Logger.log("onlySeparator find array "+JSON.stringify(a.CSVurls[d].onlySeparator[0])+", example in second xml element : `"+XMLobjectValue(A[1],
a.CSVurls[d].onlySeparator[0])+"`, Separator: `"+m.toString()+"`"),2<b&&Logger.log("onlySeparator find array "+JSON.stringify(a.CSVurls[d].onlySeparator[0])+", example in last xml element : `"+XMLobjectValue(A[b-1],a.CSVurls[d].onlySeparator[0])+"`, Separator: `"+m.toString()+"`")));y=null;a.CSVurls[d].skipSeparator.length&&(y=a.CSVurls[d].skipSeparator[1],Logger.log("skipSeparator find array "+JSON.stringify(a.CSVurls[d].skipSeparator[0])+", example in first xml element : `"+XMLobjectValue(A[0],
a.CSVurls[d].skipSeparator[0])+"`, Separator: `"+y.toString()+"`"),ScanCreateFeedsGlobalVars.debug&&(1<b&&Logger.log("skipSeparator find array "+JSON.stringify(a.CSVurls[d].skipSeparator[0])+", example in second xml element : `"+XMLobjectValue(A[1],a.CSVurls[d].skipSeparator[0])+"`, Separator: `"+y.toString()+"`"),2<b&&Logger.log("skipSeparator find array "+JSON.stringify(a.CSVurls[d].skipSeparator[0])+", example in last xml element : `"+XMLobjectValue(A[b-1],a.CSVurls[d].skipSeparator[0])+"`, Separator: `"+
y.toString()+"`")));for(v=e=g=r=G=z=b=0;C<A.length;C++){z++;if(500<z&&(z=0,shouldExitEarly()))return ScanCreateFeedsGlobalVars.warnings+="Exit shouldExitEarly XML create dbase\n",n.CSVsiteurlnum=C,n.CSVsiteurlLastelem=[C,JSON.parse(JSON.stringify(A[C]))],k=!0;if(m)try{for(var w=0,f=0;f<m.length;f++){var J=m[f],K=XMLobjectValue(A[C],a.CSVurls[d].onlySeparator[0]).split(J);if(K[0]!==XMLobjectValue(A[C],a.CSVurls[d].onlySeparator[0])){w=1;break}}if(!w)continue}catch(F){ScanCreateFeedsGlobalVars.debug&&
10>G&&(G++,Logger.log("Error "+F.message+" in dataNum: "+C+" in onlySeparator, find array "+JSON.stringify(a.CSVurls[d].onlySeparator[0])+", XMLRow-Array: `"+JSON.stringify(A[C])+"`, Separator: `"+m.toString()+"`"));p.errors.unknownCSV++;continue}if(y)try{for(f=w=0;f<y.length;f++)if(J=y[f],K=XMLobjectValue(A[C],a.CSVurls[d].skipSeparator[0]).split(J),K[0]!==XMLobjectValue(A[C],a.CSVurls[d].skipSeparator[0])){w=1;break}if(w)continue}catch(F){ScanCreateFeedsGlobalVars.debug&&10>r&&(r++,Logger.log("Error "+
F.message+"  in dataNum: "+C+" in skipSeparator, find array "+JSON.stringify(a.CSVurls[d].skipSeparator[0])+", XMLRow-Array: `"+JSON.stringify(A[C])+"`, Separator: `"+y.toString()+"`"));p.errors.unknownCSV++;continue}if(t)try{N=t(a.CSVurls[d].url_column_replace[0],A[C]);if(!N)continue;if("string"!=typeof N){ScanCreateFeedsGlobalVars.debug&&10>g&&(g++,Logger.log("Bad return from ExecFun in dataNum: "+C+", function parameters: ("+a.CSVurls[d].url_column_replace[0]+","+JSON.stringify(A[C])+")"));p.errors.unknownCSV++;
continue}N=N.trim();if(!N)continue}catch(F){ScanCreateFeedsGlobalVars.debug&&10>e&&(e++,Logger.log("Error "+F.message+" in dataNum: "+C+" in ExecFun, function parameters: ("+a.CSVurls[d].url_column_replace[0]+","+JSON.stringify(A[C])+")"));p.errors.unknownCSV++;continue}else if(N=XMLobjectValue(A[C],a.CSVurls[d].url_column_replace[0])){if(N=N.trim(),!N){ScanCreateFeedsGlobalVars.debug&&10>v&&(v++,Logger.log("Empty url in dataNum: "+C+" find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+
", XMLRow-Array: `"+JSON.stringify(A[C])+"`"));p.errors.unknownCSV++;continue}}else{ScanCreateFeedsGlobalVars.debug&&10>v&&(v++,Logger.log("Empty url in dataNum: "+C+" find array "+JSON.stringify(a.CSVurls[d].url_column_replace[0])+",  XMLRow-Array: `"+JSON.stringify(A[C])+"`"));p.errors.unknownCSV++;continue}if((N=ValidateURL(c,N))&&!(0<=p.scanned.indexOf(N))){var u=p.scanned.length;p.scanned[u]=N;p.checked[u]=0;b++;if(u>=l)break}}ScanCreateFeedsGlobalVars.debug&&Logger.log("found new urls: "+b);
return k}
function CreateFeedSearch(a,d,c,n,t){function q(u,F,I,B){u={url:u.url,data:{}};for(var U in I)u.data[U]={},u.data[U].Headlines=I[U].Headlines[0]+" | "+I[U].Headlines[1],u.data[U].Descriptions=I[U].Descriptions[0],I[U].Descriptions[1]&&(u.data[U].Descriptions+=" "+I[U].Descriptions[1]),F&&!/[\.!,]\s*$/.test(u.data[U].Descriptions)&&(u.data[U].Descriptions+="."),I[U].Paths[0]?(u.data[U].Paths=I[U].Paths[0],I[U].Paths[1]&&(u.data[U].Paths+="/"+I[U].Paths[1])):u.data[U].Paths="";F="";for(I=0;I<B.length;I++)F+=
"<i>"+B[I]+"</i>";u.keywrds=F;return u}var h=0;if(c&&c.GAShtml){for(var b={},m=0;m<c.GASparams.length;m++){var p=c.GASparams[m][0],k=c.GASparams[m][1];if("keys"==p&&"object"==typeof k){b[p]=[];for(var z=0;z<k.length;z++)b[p][z]=parvalue(k[z],p,c[p][z],a)}else b[p]=parvalue(k,p,c[p],a)}p={};for(m=0;m<c.adids.length;m++)for(k=c.adids[m],p[k]={},z=0;z<c[k].GASADparams.length;z++){var G=c[k].GASADparams[z][0],y=c[k].GASADparams[z][1];if(c[k].FromGAS[G])p[k][G]=b[G];else if("keys"==G&&"object"==typeof y)for(p[k][G]=
[],z=0;z<y.length;z++)p[k][G][z]=parvalue(y[z],G,c[k][G][z],a);else p[k][G]=parvalue(y,G,c[k][G],a)}if(ScanCreateFeedsGlobalVars.errors)return;G=0;var r={EXACT:{},BROAD:{},PHRASE:{}},g={EXACT:{},BROAD:{},PHRASE:{}},v={EXACT:{},BROAD:{},PHRASE:{}};a={};if(b.keys)if("object"==typeof b.keys)for(m=0;m<b.keys.length;m++){if(b.keys[m]){G=1;var l=ItemKeys(b.keys[m],d,c.keysmixtype,c.maxNodigaddkeyNum,b.fixedkeys,c.notReqfixedkeys,b.onekeys);if(l)try{addkeystypegen[c.addkeystype](l,r,g,v,c.keywordtypes)}catch(u){ScanCreateFeedsGlobalVars.errors+=
"bad parameter addkeystype in GASearch, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}}else if(G=1,l=ItemKeys(b.keys,d,c.keysmixtype,c.maxNodigaddkeyNum,b.fixedkeys,c.notReqfixedkeys,b.onekeys))try{addkeystypegen[c.addkeystype](l,r,g,v,c.keywordtypes)}catch(u){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}if(b.masskeys){var e=b.masskeys.trim();e=e.split(/[\s,]*,[\s,]*/);for(z=0;z<e.length;z++)if(e[z]&&
(G=1,l=ItemKeys(e[z],d,c.masskeysmixtype,c.maxNodigaddkeyNum,b.fixedkeys,c.notReqfixedkeys,b.onekeys)))try{addkeystypegen[c.addkeystype](l,r,g,v,c.keywordtypes)}catch(u){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}for(m=y=0;m<c.adids.length;m++)if(k=c.adids[m],z=ItemHeaders(p[k].header,d,p[k].paths,p[k].header2,c.header3,c[k].keyword,p[k].startdescription,p[k].beforeprice,b.price,p[k].afterprice,p[k].description,
p[k].afterdescription,c[k].priceaddtype,c.priceRound,c[k].noPaths,c[k].headerTo1Line,c[k].afterdescrNeed,c[k].requiredescr,1)){if(a[k]={},a[k].Headlines=z.Headlines,a[k].Descriptions=z.Descriptions,a[k].Paths=z.Paths,a[k].Params=z.Params,y++,!(c[k].FromGAS.addkeystype&&c[k].FromGAS.maxNodigaddkeyNum&&c[k].FromGAS.keys&&c[k].FromGAS.fixedkeys&&c[k].FromGAS.masskeys&&c[k].FromGAS.onekeys&&c[k].FromGAS.keysmixtype&&c[k].FromGAS.masskeysmixtype&&c[k].FromGAS.notReqfixedkeys)){if("object"==typeof p[k].keys)for(z=
0;z<p[k].keys.length;z++){if(p[k].keys[z]&&(G=1,l=ItemKeys(p[k].keys[z],d,c[k].keysmixtype,c[k].maxNodigaddkeyNum,p[k].fixedkeys,c[k].notReqfixedkeys,p[k].onekeys)))try{addkeystypegen[c[k].addkeystype](l,r,g,v,c.keywordtypes)}catch(u){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch in Ad number "+k+", check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}else if(p[k].keys&&(G=1,l=ItemKeys(p[k].keys,d,c[k].keysmixtype,c[k].maxNodigaddkeyNum,p[k].fixedkeys,c[k].notReqfixedkeys,
p[k].onekeys)))try{addkeystypegen[c[k].addkeystype](l,r,g,v,c.keywordtypes)}catch(u){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch in Ad number "+k+", check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}if(p[k].masskeys)for(e=p[k].masskeys.trim(),e=e.split(/[\s,]*,[\s,]*/),z=0;z<e.length;z++)if(e[z]&&(G=1,l=ItemKeys(e[z],d,c[k].masskeysmixtype,c[k].maxNodigaddkeyNum,p[k].fixedkeys,c[k].notReqfixedkeys,p[k].onekeys)))try{addkeystypegen[c[k].addkeystype](l,r,
g,v,c.keywordtypes)}catch(u){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch in Ad number "+k+", check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}}else p[k].header&&p[k].startdescription+p[k].description+p[k].afterdescription||(ScanCreateFeedsGlobalVars.errors+="bad parameters, header or etc. in GASearch\n",Logger.log(ScanCreateFeedsGlobalVars.errors));var C=[],N=[];Object.keys(r.EXACT).forEach(function(u){N.push("["+u+"]");C.push(u)});Object.keys(r.PHRASE).forEach(function(u){N.push('"'+
u+'"');C.push(u)});Object.keys(r.BROAD).forEach(function(u){u=u.replace(/([^\s]+)/g,"+$1");N.push(u);C.push(u)});var A=[],w=[];Object.keys(g.EXACT).forEach(function(u){w.push("["+u+"]");A.push(u)});Object.keys(g.PHRASE).forEach(function(u){w.push('"'+u+'"');A.push(u)});Object.keys(g.BROAD).forEach(function(u){u=u.replace(/([^\s]+)/g,"+$1");w.push(u);A.push(u)});var f=[],J=[];Object.keys(v.EXACT).forEach(function(u){J.push("["+u+"]");f.push(u)});Object.keys(v.PHRASE).forEach(function(u){J.push('"'+
u+'"');f.push(u)});Object.keys(v.BROAD).forEach(function(u){u=u.replace(/([^\s]+)/g,"+$1");J.push(u);f.push(u)});m=1;C.length||A.length||f.length||(m=0,G||(ScanCreateFeedsGlobalVars.errors+="bad parameter keys in GASearch\n",Logger.log(ScanCreateFeedsGlobalVars.errors)));if(ScanCreateFeedsGlobalVars.errors||!y||!m)return;d=[];for(m=0;m<C.length;m++)80<C[m].length||d.push(N[m]);if(f.length)for(m=0;m<f.length;m++)80<f[m].length||d.push(J[m]);if(A.length)for(m=0;m<A.length;m++)80<A[m].length||d.push(w[m]);
if(!d.length)return;try{n[t]||(n[t]=[]);var K=q(b,c.GAShtmlExt,a,d);K&&(n[t][n[t].length]=K,h=1)}catch(u){return ScanCreateFeedsGlobalVars.errors+="bad field_type: .gas.html in correctfeedsearchExtPositionFunction, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors),0}}return h}
function parvalue(a,d,c,n){var t={array3:function(q,h,b){for(var m="",p=0;p<h.length;p++)if(h[p])if(1==p)for(var k=h[p].split(/[\s,]*,[\s,]*/),z=0;z<k.length;z++){if(b[k[z]]&&b[k[z]].include_attributes)return ScanCreateFeedsGlobalVars.errors+="bad parameter: "+q+" in GASearch, field_name "+k[z]+' have "include attributes" type, not use it in GASearch.\n',Logger.log(ScanCreateFeedsGlobalVars.errors),"";if(b[k[z]]&&b[k[z]].field_value)m=m?m+(" "+b[k[z]].field_value):m+b[k[z]].field_value;else if(!b.hasOwnProperty(k[z]))return ScanCreateFeedsGlobalVars.errors+=
"bad parameter: "+q+" in GASearch, not exists field_name "+k[z]+" in feed fields.\n",Logger.log(ScanCreateFeedsGlobalVars.errors),""}else m=m?m+(" "+h[p]):m+h[p];return m},"function":function(q,h,b){try{var m=h(b);return"string"!=typeof m?(ScanCreateFeedsGlobalVars.errors+="bad function result (no string type), parameter: "+q+" in GASearch\n",Logger.log(ScanCreateFeedsGlobalVars.errors),""):/\n/.test(m)?(ScanCreateFeedsGlobalVars.errors+="bad parameter (function): "+q+' in GASearch, some field have "include attributes" type or Newline symbol, not use it in GASearch function.\n',
Logger.log(ScanCreateFeedsGlobalVars.errors),""):m=m.trim()}catch(p){return ScanCreateFeedsGlobalVars.errors+="bad function, parameter: "+q+" in GASearch\n",Logger.log(ScanCreateFeedsGlobalVars.errors),""}},"":function(q,h,b){return""}};try{return t[a](d,c,n)}catch(q){return ScanCreateFeedsGlobalVars.errors+="bad parameter: "+d+", parameterType: "+a+" in GASearch\n",Logger.log(ScanCreateFeedsGlobalVars.errors),""}}
var keywordtypesgen={0:function(a,d,c){d.EXACT[a]=1;d.BROAD[a]=1},1:function(a,d,c){d.EXACT[a]=1},2:function(a,d,c){d.BROAD[a]=1},3:function(a,d,c){d.EXACT[a]=1;d.PHRASE[a]=1},4:function(a,d,c){d.PHRASE[a]=1},5:function(a,d,c){c?(d.EXACT[a]=1,d.PHRASE[a]=1):(d.EXACT[a]=1,d.BROAD[a]=1)},6:function(a,d,c){c?d.PHRASE[a]=1:d.BROAD[a]=1}},addkeystypegen={0:function(a,d,c,n,t){for(var q=0;q<a[0].length;q++)keywordtypesgen[t](a[0][q],c,4<t);for(q=0;q<a[1].length;q++)keywordtypesgen[t](a[1][q],d);for(q=0;q<
a[2].length;q++)keywordtypesgen[t](a[2][q],n);for(q=0;q<a[3].length;q++)keywordtypesgen[t](a[3][q],d)},1:function(a,d,c,n,t){for(c=0;c<a[0].length;c++)keywordtypesgen[t](a[0][c],d,4<t);for(c=0;c<a[1].length;c++)keywordtypesgen[t](a[1][c],d);for(c=0;c<a[2].length;c++)keywordtypesgen[t](a[2][c],n);for(c=0;c<a[3].length;c++)keywordtypesgen[t](a[3][c],d)},2:function(a,d,c,n,t){for(c=0;c<a[1].length;c++)keywordtypesgen[t](a[1][c],d);for(c=0;c<a[2].length;c++)keywordtypesgen[t](a[2][c],n);for(c=0;c<a[3].length;c++)keywordtypesgen[t](a[3][c],
d)},3:function(a,d,c,n,t){for(c=0;c<a[0].length;c++)keywordtypesgen[t](a[0][c],d,4<t);for(c=0;c<a[1].length;c++)keywordtypesgen[t](a[1][c],d);for(c=0;c<a[3].length;c++)keywordtypesgen[t](a[3][c],d)},4:function(a,d,c,n,t){for(c=0;c<a[0].length;c++)keywordtypesgen[t](a[0][c],d,4<t);for(c=0;c<a[3].length;c++)keywordtypesgen[t](a[3][c],d)},5:function(a,d,c,n,t){for(c=0;c<a[1].length;c++)keywordtypesgen[t](a[1][c],d);for(c=0;c<a[3].length;c++)keywordtypesgen[t](a[3][c],d)},6:function(a,d,c,n,t){for(c=
0;c<a[0].length;c++)keywordtypesgen[t](a[0][c],d,4<t);for(c=0;c<a[1].length;c++)keywordtypesgen[t](a[1][c],d);for(c=0;c<a[2].length;c++)keywordtypesgen[t](a[2][c],d);for(c=0;c<a[3].length;c++)keywordtypesgen[t](a[3][c],d)},7:function(a,d,c,n,t){for(c=0;c<a[1].length;c++)keywordtypesgen[t](a[1][c],d);for(c=0;c<a[2].length;c++)keywordtypesgen[t](a[2][c],d);for(c=0;c<a[3].length;c++)keywordtypesgen[t](a[3][c],d)},8:function(a,d,c,n,t){for(c=0;c<a[2].length;c++)keywordtypesgen[t](a[2][c],d);for(c=0;c<
a[3].length;c++)keywordtypesgen[t](a[3][c],d)}};
function CreateSearch(a,d,c,n,t,q,h,b){var m=n.GASearch;if(m&&m.Id){if(m.hasOwnProperty("removeOutOfStockItem")){if(!a.hasOwnProperty(m.removeOutOfStockItem[1])){ScanCreateFeedsGlobalVars.errors+="bad parameter: removeOutOfStockItem in GASearch, not exists field_name "+m.removeOutOfStockItem[1]+" in feed fields.\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(a[m.removeOutOfStockItem[1]].field_value==m.removeOutOfStockItem[2]){if(c[t]){var p=c[t][0],k=c[t][1];if(2==m.removeOutOfStockItem[0])removeAdGroupbuffer(p);
else if(m.removeOutOfStockItem[0])k||pauseAdGroupbuffer(p);else if(k)var z=2;else pauseAdGroupbuffer(p),z=1;delete c[t]}return z}}for(var G={},y=0;y<m.GASparams.length;y++){var r=m.GASparams[y][0],g=m.GASparams[y][1];if("keys"==r&&"object"==typeof g){G[r]=[];for(var v=0;v<g.length;v++)G[r][v]=parvalue(g[v],r,m[r][v],a)}else G[r]=parvalue(g,r,m[r],a)}var l={};for(y=0;y<m.adids.length;y++){var e=m.adids[y];l[e]={};for(v=0;v<m[e].GASADparams.length;v++){var C=m[e].GASADparams[v][0],N=m[e].GASADparams[v][1];
if(m[e].FromGAS[C])l[e][C]=G[C];else if("keys"==C&&"object"==typeof N)for(l[e][C]=[],v=0;v<N.length;v++)l[e][C][v]=parvalue(N[v],C,m[e][C][v],a);else l[e][C]=parvalue(N,C,m[e][C],a)}}if(ScanCreateFeedsGlobalVars.errors)return;var A=0,w={EXACT:{},BROAD:{},PHRASE:{}},f={EXACT:{},BROAD:{},PHRASE:{}},J={EXACT:{},BROAD:{},PHRASE:{}},K={},u="",F="";if(G.keys)if("object"==typeof G.keys)for(y=0;y<G.keys.length;y++){if(G.keys[y]){A=1;var I=ItemKeys(G.keys[y],d,m.keysmixtype,m.maxNodigaddkeyNum,G.fixedkeys,
m.notReqfixedkeys,G.onekeys);if(I)try{addkeystypegen[m.addkeystype](I,w,f,J,m.keywordtypes)}catch(ua){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}}else if(A=1,I=ItemKeys(G.keys,d,m.keysmixtype,m.maxNodigaddkeyNum,G.fixedkeys,m.notReqfixedkeys,G.onekeys))try{addkeystypegen[m.addkeystype](I,w,f,J,m.keywordtypes)}catch(ua){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch, check script code\n",
Logger.log(ScanCreateFeedsGlobalVars.errors)}if(G.masskeys){var B=G.masskeys.trim();B=B.split(/[\s,]*,[\s,]*/);for(v=0;v<B.length;v++)if(B[v]&&(A=1,I=ItemKeys(B[v],d,m.masskeysmixtype,m.maxNodigaddkeyNum,G.fixedkeys,m.notReqfixedkeys,G.onekeys)))try{addkeystypegen[m.addkeystype](I,w,f,J,m.keywordtypes)}catch(ua){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}var U=0;for(y=0;y<m.adids.length;y++){e=m.adids[y];
var P=ItemHeaders(l[e].header,d,l[e].paths,l[e].header2,m.header3,m[e].keyword,l[e].startdescription,l[e].beforeprice,G.price,l[e].afterprice,l[e].description,l[e].afterdescription,m[e].priceaddtype,m.priceRound,m[e].noPaths,m[e].headerTo1Line,m[e].afterdescrNeed,m[e].requiredescr,0);if(P){if(K[e]={},K[e].Headlines=P.Headlines,K[e].Descriptions=P.Descriptions,K[e].Paths=P.Paths,K[e].Params=P.Params,K[e].Params[0]&&(u=K[e].Params[0]),K[e].Params[1]&&(F=K[e].Params[1]),U++,!(m[e].FromGAS.addkeystype&&
m[e].FromGAS.maxNodigaddkeyNum&&m[e].FromGAS.keys&&m[e].FromGAS.fixedkeys&&m[e].FromGAS.masskeys&&m[e].FromGAS.onekeys&&m[e].FromGAS.keysmixtype&&m[e].FromGAS.masskeysmixtype&&m[e].FromGAS.notReqfixedkeys)){if("object"==typeof l[e].keys)for(v=0;v<l[e].keys.length;v++){if(l[e].keys[v]&&(A=1,I=ItemKeys(l[e].keys[v],d,m[e].keysmixtype,m[e].maxNodigaddkeyNum,l[e].fixedkeys,m[e].notReqfixedkeys,l[e].onekeys)))try{addkeystypegen[m[e].addkeystype](I,w,f,J,m.keywordtypes)}catch(ua){ScanCreateFeedsGlobalVars.errors+=
"bad parameter addkeystype in GASearch in Ad number "+e+", check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}else if(l[e].keys&&(A=1,I=ItemKeys(l[e].keys,d,m[e].keysmixtype,m[e].maxNodigaddkeyNum,l[e].fixedkeys,m[e].notReqfixedkeys,l[e].onekeys)))try{addkeystypegen[m[e].addkeystype](I,w,f,J,m.keywordtypes)}catch(ua){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch in Ad number "+e+", check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}if(l[e].masskeys)for(B=
l[e].masskeys.trim(),B=B.split(/[\s,]*,[\s,]*/),v=0;v<B.length;v++)if(B[v]&&(A=1,I=ItemKeys(B[v],d,m[e].masskeysmixtype,m[e].maxNodigaddkeyNum,l[e].fixedkeys,m[e].notReqfixedkeys,l[e].onekeys)))try{addkeystypegen[m[e].addkeystype](I,w,f,J,m.keywordtypes)}catch(ua){ScanCreateFeedsGlobalVars.errors+="bad parameter addkeystype in GASearch in Ad number "+e+", check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}}else l[e].header&&l[e].startdescription+l[e].description+l[e].afterdescription||
(ScanCreateFeedsGlobalVars.errors+="bad parameters, header or etc. in GASearch\n",Logger.log(ScanCreateFeedsGlobalVars.errors))}var X=[],S={},O=[];Object.keys(w.EXACT).forEach(function(ua){var Ka="["+ua+"]";O.push(Ka);X.push(ua);S[Ka]=ua});Object.keys(w.PHRASE).forEach(function(ua){var Ka='"'+ua+'"';O.push(Ka);X.push(ua);S[Ka]=ua});Object.keys(w.BROAD).forEach(function(ua){var Ka=ua.replace(/([^\s]+)/g,"+$1");O.push(Ka);X.push(Ka);S[Ka]=ua});var aa=[],T={},da=[];Object.keys(f.EXACT).forEach(function(ua){var Ka=
"["+ua+"]";da.push(Ka);aa.push(ua);T[Ka]=ua});Object.keys(f.PHRASE).forEach(function(ua){var Ka='"'+ua+'"';da.push(Ka);aa.push(ua);T[Ka]=ua});Object.keys(f.BROAD).forEach(function(ua){var Ka=ua.replace(/([^\s]+)/g,"+$1");da.push(Ka);aa.push(Ka);T[Ka]=ua});var D=[],Q={},R=[];Object.keys(J.EXACT).forEach(function(ua){var Ka="["+ua+"]";R.push(Ka);D.push(ua);Q[Ka]=ua});Object.keys(J.PHRASE).forEach(function(ua){var Ka='"'+ua+'"';R.push(Ka);D.push(ua);Q[Ka]=ua});Object.keys(J.BROAD).forEach(function(ua){var Ka=
ua.replace(/([^\s]+)/g,"+$1");R.push(Ka);D.push(Ka);Q[Ka]=ua});var Z=1;X.length||aa.length||D.length||(Z=0,A||(ScanCreateFeedsGlobalVars.errors+="bad parameter keys in GASearch\n",Logger.log(ScanCreateFeedsGlobalVars.errors)));if(ScanCreateFeedsGlobalVars.errors||!U||!Z)return;var sa=O.join("\n")+"\n"+da.join("\n")+"\n"+R.join("\n")+"\n",V=G.url+"\n"+G.mobileurl+"\n";for(e in K){var fa=K[e].Headlines.join("\n");fa+=K[e].Descriptions.join("\n");fa+=K[e].Paths.join("\n");fa=fa.replace(/(\{param(?:1|2):)[^\}\{]*(\})/gm,
"$1$2");V+=fa}var oa=u+"\n"+F;sa=murmurhash3_32_gc(sa);V=murmurhash3_32_gc(V);var ha=u.length,ia=F.length;oa=murmurhash3_32_gc(oa);var ja=m.addkeystype,Ga=m.modifykeystype,ka=m.modifykeysEnable,za=m.removeLSVKeywords,Ha=m.maxNodigaddkeyNum,Aa=0;ha&&Aa++;ia&&Aa++;var na=0;if(c[t]){p=c[t][0];k=c[t][1];var la=Number(c[t][3]),qa=Number(c[t][4]),db=c[t][5],ra=c[t][6],Ia=Number(c[t][7]),Fa=Number(c[t][8]),Bb=Number(c[t][9]),yb=Number(c[t][10]),Cb=Number(c[t][11]),Oa=Number(c[t][12]),E=0,Wa=0,ea=0;if(c[t][2]!=
V||la<ha||qa<ia)E=1;if(ra!=sa||Fa!=m.addkeystype||yb!=m.modifykeystype||Cb!=m.modifykeysEnable||Bb!=m.removeLSVKeywords||Ia!=m.maxNodigaddkeyNum)Wa=1;la>=ha&&qa>=ia&&db!=oa&&(ea=1);if(E||Wa||ea){z=1;if(ScanCreateFeedsGlobalVars.GASearchHASH[q][t])var ba=ScanCreateFeedsGlobalVars.GASearchHASH[q][t];else{var Va=AdWordsApp.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").withIds([p]).get();Va.hasNext()?ba=Va.next():(ba=null,na=1,Oa=0)}if(ba){var ib=0,wa=
0,xb=0,va=0;Wa&&m.modifykeystype&&(wa=1,Wa=0,va=xb=1);if(Wa)removeAdGroupbuffer(p),na=1,Oa=0;else if(E){wa=1;Oa=0;for(var jb=ba.ads().withCondition('Status IN ["PAUSED","ENABLED"]').get();jb.hasNext();){var Za=jb.next();Za.remove();Za.remove()}var ca=[];for(e in K){var Y=ba.newAd().responsiveSearchAdBuilder().withFinalUrl(G.url);G.mobileurl&&(Y=Y.withMobileFinalUrl(G.mobileurl));Y=Y.addHeadline(K[e].Headlines[0],"HEADLINE_1");Y=Y.addHeadline(K[e].Headlines[1],"HEADLINE_2");Y=Y.addHeadline(K[e].Headlines[2],
"HEADLINE_3");Y=Y.addDescription(K[e].Descriptions[0],"DESCRIPTION_1");Y=Y.addDescription(K[e].Descriptions[1],"DESCRIPTION_2");K[e].Paths[0]&&(Y=Y.withPath1(K[e].Paths[0]));K[e].Paths[1]&&(Y=Y.withPath2(K[e].Paths[1]));try{Y=Y.build(),ca.push(Y)}catch(ua){ScanCreateFeedsGlobalVars.errors+="Errors build Ad in AdGroup ID "+p+": "+ua.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}for(var Ca=U=0,M=0;M<ca.length;M++)if(ca[M].isSuccessful())ca[M].getResult(),U++;else{var H=ca[M].getErrors();
/POLICY_ERROR/.test(H)&&Ca++;Logger.log("Errors create Ad in AdGroup ID "+p+": "+H+"\nfor url: "+h+"\n")}if(!U&&(Ca&&Ca==ca.length&&(Oa=1),!Oa)){ba.pause();removeAdGroupbuffer(p);return}Oa?ib=0:ea&&(ib=1)}else ea&&(ib=wa=1,Oa&&(ib=0));if(xb&&!Oa){for(var Qa={},pa={},bb=ba.keywords().withCondition("Status != REMOVED").get();bb.hasNext();){var Da=bb.next(),La=Da.getId(),Ba=Da.urls().getCustomParameters(),L=Da.getText(),Ra=clearKeyWord(L);if(Ra&&(L=Ra[0],Qa[L]=La,va)){if(Ba&&Ba.sskeywrd1){var kb=Ba.sskeywrd1;
kb=kb.replace(/\*/g," ");var fb=clearKeyWord(kb);fb&&(Ra=fb,L=Ra[0])}pa[L]||(pa[L]=[Ra[1].split(/\s+/),[],0]);pa[L][1].push(Da)}}var W=[];ca=[];var xa=[],Ma=[],Sa=[],ya={};for(y=0;y<X.length;y++){if(va){var $a=S[O[y]].split(/\s+/),ta;for(ta in pa){var Xa=differ(pa[ta][0],$a);if(Xa)for(pa[ta][2]=1,M=0;M<pa[ta][1].length;M++)ya[pa[ta][1][M].getId()]=1}}if(Qa.hasOwnProperty(O[y]))Sa.push([p,Qa[O[y]]]),ya[Qa[O[y]]]=1;else if(!(80<X[y].length)){var ma=ba.newKeywordBuilder().withText(O[y]);ma=ma.build();
ca.push(ma);xa.push(O[y]);Ma.push(X[y])}}var hb=[];for(M=0;M<ca.length;M++)if(ca[M].isSuccessful()){var Na=ca[M].getResult();W[W.length]=Na;Sa.push([p,Na.getId()]);ya[Na.getId()]=1}else H=ca[M].getErrors(),/CONCURRENT_MODIFICATION/.test(H)&&hb.push(M),Logger.log("Errors from Keyword "+xa[M]+": "+ca[M].getErrors()+"\nfor url: "+h+"\n");if(hb.length){Utilities.sleep(1E3);var Ta=[],rb=[];for(M=0;M<hb.length;M++)80<Ma[M].length||(ma=ba.newKeywordBuilder().withText(xa[M]),ma=ma.build(),Ta.push(ma),rb.push(xa[M]));
for(M=0;M<Ta.length;M++)Ta[M].isSuccessful()?(Na=Ta[M].getResult(),W[W.length]=Na,Sa.push([p,Na.getId()]),ya[Na.getId()]=1):Logger.log("Errors from Keyword "+rb[M]+": "+Ta[M].getErrors()+"\nfor url: "+h+"\n")}ca=[];xa=[];Ma=[];if(D.length){var zb=ba.keywords().withCondition("SystemServingStatus != 'RARELY_SERVED'").withIds(Sa).get().totalNumEntities();if(!zb)for(y=0;y<D.length;y++){if(va)for(ta in $a=Q[R[y]].split(/\s+/),pa)if(Xa=differ(pa[ta][0],$a))for(pa[ta][2]=1,M=0;M<pa[ta][1].length;M++)ya[pa[ta][1][M].getId()]=
1;Qa.hasOwnProperty(R[y])?(Sa.push([p,Qa[R[y]]]),ya[Qa[R[y]]]=1):80<D[y].length||(ma=ba.newKeywordBuilder().withText(R[y]),ma=ma.build(),ca.push(ma),xa.push(R[y]),Ma.push(D[y]))}}if(aa.length)for(y=0;y<aa.length;y++){if(va)for(ta in $a=T[da[y]].split(/\s+/),pa)if(Xa=differ(pa[ta][0],$a))for(pa[ta][2]=1,M=0;M<pa[ta][1].length;M++)ya[pa[ta][1][M].getId()]=1;Qa.hasOwnProperty(da[y])?(Sa.push([p,Qa[da[y]]]),ya[Qa[da[y]]]=1):80<aa[y].length||(ma=ba.newKeywordBuilder().withText(da[y]),ma=ma.build(),ca.push(ma),
xa.push(da[y]),Ma.push(aa[y]))}hb=[];for(M=0;M<ca.length;M++)ca[M].isSuccessful()?(Na=ca[M].getResult(),W[W.length]=Na,Sa.push([p,Na.getId()]),ya[Na.getId()]=1):(H=ca[M].getErrors(),/CONCURRENT_MODIFICATION/.test(H)&&hb.push(M),Logger.log("Errors from Add Keyword "+xa[M]+": "+H+"\nfor url: "+h+"\n"));if(hb.length){Utilities.sleep(1E3);Ta=[];rb=[];for(M=0;M<hb.length;M++)80<Ma[M].length||(ma=ba.newKeywordBuilder().withText(xa[M]),ma=ma.build(),Ta.push(ma),rb.push(xa[M]));for(M=0;M<Ta.length;M++)Ta[M].isSuccessful()?
(Na=Ta[M].getResult(),W[W.length]=Na,Sa.push([p,Na.getId()]),ya[Na.getId()]=1):Logger.log("Errors from Keyword "+rb[M]+": "+Ta[M].getErrors()+"\nfor url: "+h+"\n")}!W.length||E||Oa||(ib=1);if(m.removeLSVKeywords&&Sa.length){if(va&&Ia>m.maxNodigaddkeyNum){var ab=[],lb;for(lb in ya)ab.push([p,lb])}else ab=Sa;if(1==m.removeLSVKeywords){for(var Pa=ba.keywords().withCondition("SystemServingStatus = 'RARELY_SERVED'").withCondition("Status != REMOVED").withIds(ab).get(),Ea=[],Ya={};Pa.hasNext();)if(Da=Pa.next(),
Ba=Da.urls().getCustomParameters(),!Ba||!Ba.sskeywrd1)if(L=Da.getText(),Ra=clearKeyWord(L)){L=Ra[0];Qa[L]&&delete Qa[L];if(va&&pa[L]){for(M=0;M<pa[L][1].length;M++){var cb=pa[L][1][M].getId()+"="+pa[L][1][M].getAdGroup().getId();Ya[cb]||(Ea.push(pa[L][1][M]),Ya[cb]=1)}delete pa[L]}cb=Da.getId()+"="+Da.getAdGroup().getId();Ya[cb]||(Ea.push(Da),Ya[cb]=1)}for(M=0;M<Ea.length;M++)Ea[M].remove(),Ea[M].remove()}else{Pa=ba.keywords().withCondition("SystemServingStatus = 'RARELY_SERVED'").withCondition("Status != REMOVED").withIds(ab).get();
Ea=[];for(Ya={};Pa.hasNext();)if(Da=Pa.next(),Ba=Da.urls().getCustomParameters(),!Ba||!Ba.sskeywrd1)if(L=Da.getText(),Ra=clearKeyWord(L)){L=Ra[0];if(va&&pa[L]){for(M=0;M<pa[L][1].length;M++)cb=pa[L][1][M].getId()+"="+pa[L][1][M].getAdGroup().getId(),Ya[cb]||(Ea.push(pa[L][1][M]),Ya[cb]=1);pa[L][2]=2}cb=Da.getId()+"="+Da.getAdGroup().getId();Ya[cb]||(Ea.push(Da),Ya[cb]=1)}for(M=0;M<Ea.length;M++)Ea[M].isPaused()||Ea[M].pause()}}if(va&&m.modifykeystype)for(ta in pa)if(!pa[ta][2])if(2<m.modifykeystype)for(M=
0;M<pa[ta][1].length;M++)pa[ta][1][M].remove(),pa[ta][1][M].remove();else for(M=0;M<pa[ta][1].length;M++)pa[ta][1][M].isPaused()||pa[ta][1][M].pause();else if(m.modifykeysEnable&&(1<m.modifykeysEnable||m.addkeystype!=Fa||m.modifykeystype&&3>m.modifykeystype&&ra!=sa))for(M=0;M<pa[ta][1].length;M++)2!=pa[ta][2]&&(pa[ta][1][M].isEnabled()||pa[ta][1][M].enable())}if(ib)for(var Db=ba.adParams().get();Db.hasNext();){var pb=Db.next();pb.remove();pb.remove()}if(ib&&!E){W=[];for(bb=ba.keywords().withCondition("Status != REMOVED").get();bb.hasNext();)Da=
bb.next(),W[W.length]=Da;for(M=0;M<W.length;M++)Da=W[M],ha&&Da.setAdParam(1,u),ia&&Da.setAdParam(2,F);for(var gb=!0,wb=0;;)try{gb=ba.adParams().get().totalNumEntities()<W.length;break}catch(ua){if(2<wb)break;wb++;Utilities.sleep(500)}if(gb)for(Utilities.sleep(500),M=0;M<W.length;M++){Da=W[M];for(var qb=0;Da.adParams().get().totalNumEntities()!=Aa;){ha&&Da.setAdParam(1,u);ia&&Da.setAdParam(2,F);if(10<qb){Logger.log("Paused group and return: Errors add params in AdGroup ID/Name "+p+"/"+ba.getName()+
", keyword "+Da.getText()+" params: 1:"+u+"("+ha+") 2:"+F+"("+ia+")\nfor url: "+h+"\n");ba.isEnabled()&&ba.pause();delete c[t];return}qb++;Utilities.sleep(500)}}}if(wa){var mb=ba.getName(),Ua=mb.replace(/\s*st:(\d+(?:\-\d+)?):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):(\d+):end\s*/gm," ");Ua=Ua.trim();var nb=E?"st:"+t+":"+V+":"+ha+":"+ia+":"+oa+":"+sa+":"+Ha+":"+ja+":"+za+":"+Ga+":"+ka+":"+Oa+":end":"st:"+t+":"+V+":"+la+":"+qa+":"+oa+":"+sa+":"+Ha+":"+ja+":"+za+":"+Ga+":"+ka+":"+
Oa+":end";if(Ua){var Kb,Hb=null!=(Kb=(new RegExp(/(MAXBID:?\d+([\.,]\d+)?)/)).exec(Ua))&&Kb[1]?nb+" "+Kb[1]:nb;Ua=nb+" "+Ua}else Hb=Ua=nb;ba.setName(Ua);mb=ba.getName();if(Ua!==mb){var ub=ba.getCampaign();Va=ub.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").withCondition("AdGroupName = '"+Ua.replace(/'/gm,"\\'")+"'").get();if(Va.hasNext()){var ob=Va.next(),sb=String(ob.getId());if(Oa){ob.isEnabled()&&ob.pause();sb!=p&&(ba.pause(),removeAdGroupbuffer(p));
delete c[t];return}ob.isPaused()&&ob.enable();sb!=p&&(ba.pause(),removeAdGroupbuffer(p));delete c[t];return z}ba.setName(Ua);mb=ba.getName();if(Ua!==mb){Va=ub.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").withCondition("AdGroupName = '"+Hb.replace(/'/gm,"\\'")+"'").get();if(Va.hasNext()){ob=Va.next();sb=String(ob.getId());if(Oa){ob.isEnabled()&&ob.pause();sb!=p&&(ba.pause(),removeAdGroupbuffer(p));delete c[t];return}ob.isPaused()&&ob.enable();sb!=
p&&(ba.pause(),removeAdGroupbuffer(p));delete c[t];return z}for(qb=0;;)if(Utilities.sleep(1E3),ba.setName(Hb),mb=ba.getName(),Hb!==mb){if(qb++,2<qb){Logger.log("Error of set new name for AdGroup: "+Hb+", check correct name in script code\nfor url: "+h+"\n");ba.pause();removeAdGroupbuffer(p);return}}else break}}if(Oa){ba.isEnabled()&&ba.pause();delete c[t];return}}}}else{if(Oa){k||pauseAdGroupbuffer(p);delete c[t];return}z=2}!na&&k&&enableAdGroupbuffer(p);delete c[t]}else z=na=1;if(na){c[t]&&delete c[t];
ub=ScanCreateFeedsGlobalVars.GASearchCampaigns[q][b][0];var Nb=ScanCreateFeedsGlobalVars.GASearchCampaigns[q][b][2],Lb="st:"+t+":"+V+":"+ha+":"+ia+":"+oa+":"+sa+":"+Ha+":"+ja+":"+za+":"+Ga+":"+ka+":";if(ScanCreateFeedsGlobalVars&&ScanCreateFeedsGlobalVars.ABORT)for(Va=ub.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").withCondition("AdGroupName CONTAINS '"+Lb.replace(/'/gm,"\\'")+"'").get();Va.hasNext();){ba=Va.next();var Fb=ba.getName();p=String(ba.getId());
var Gb=Fb.match(new RegExp(escapeRegExp(Lb)+"(\\d+)\\:end"));if(Gb&&Gb[1])Oa=Number(Gb[1]);else{ba.isEnabled()&&ba.pause();removeAdGroupbuffer(p);return}if(Oa){ba.isEnabled()&&ba.pause();return}ba.isPaused()&&ba.enable();return z}Oa=0;var Mb=new Date,Ab=Mb.toString()+" "+Mb.getTime(),vb=ub.newAdGroupBuilder().withName("Created new AdGroup datetime: "+Ab).withCpc(Nb).withStatus("ENABLED");try{if(vb=vb.build(),vb.isSuccessful())ba=vb.getResult();else{H=vb.getErrors();/OPERATION_NOT_PERMITTED_FOR_REMOVED_ENTITY/.test(H)?
(ScanCreateFeedsGlobalVars.errors+="Errors create AdGroup for removed Campaign: "+H+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)):Logger.log("Errors create AdGroup: "+H+"\nfor url: "+h+"\n");return}}catch(ua){ScanCreateFeedsGlobalVars.errors+="Errors build AdGroup: "+ua.message+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}p=ba.getId();ca=[];for(e in K){Y=ba.newAd().responsiveSearchAdBuilder().withFinalUrl(G.url);G.mobileurl&&(Y=Y.withMobileFinalUrl(G.mobileurl));Y=Y.addHeadline(K[e].Headlines[0],
"HEADLINE_1");Y=Y.addHeadline(K[e].Headlines[1],"HEADLINE_2");Y=Y.addHeadline(K[e].Headlines[2],"HEADLINE_3");Y=Y.addDescription(K[e].Descriptions[0],"DESCRIPTION_1");Y=Y.addDescription(K[e].Descriptions[1],"DESCRIPTION_2");K[e].Paths[0]&&(Y=Y.withPath1(K[e].Paths[0]));K[e].Paths[1]&&(Y=Y.withPath2(K[e].Paths[1]));try{Y=Y.build(),ca.push(Y)}catch(ua){ScanCreateFeedsGlobalVars.errors+="Errors build Ad in AdGroup ID "+p+": "+ua.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}for(M=Ca=U=0;M<
ca.length;M++)ca[M].isSuccessful()?(ca[M].getResult(),U++):(H=ca[M].getErrors(),/POLICY_ERROR/.test(H)&&Ca++,Logger.log("Errors create Ad in AdGroup ID "+p+": "+H+"\nfor url: "+h+"\n"));if(!U&&(Ca&&Ca==ca.length&&(Oa=1),!Oa)){ba.pause();removeAdGroupbuffer(p);return}if(!Oa){W=[];ca=[];xa=[];Ma=[];for(y=0;y<X.length;y++)80<X[y].length||(ma=ba.newKeywordBuilder().withText(O[y]),ma=ma.build(),ca.push(ma),xa.push(O[y]),Ma.push(X[y]));hb=[];for(M=0;M<ca.length;M++)ca[M].isSuccessful()?(Na=ca[M].getResult(),
W[W.length]=Na):(H=ca[M].getErrors(),/CONCURRENT_MODIFICATION/.test(H)&&hb.push(M),Logger.log("Errors from Keyword "+xa[M]+": "+ca[M].getErrors()+"\nfor url: "+h+"\n"));if(hb.length){Utilities.sleep(1E3);Ta=[];rb=[];for(M=0;M<hb.length;M++)80<Ma[M].length||(ma=ba.newKeywordBuilder().withText(xa[M]),ma=ma.build(),Ta.push(ma),rb.push(xa[M]));for(M=0;M<Ta.length;M++)Ta[M].isSuccessful()?(Na=Ta[M].getResult(),W[W.length]=Na):Logger.log("Errors from Keyword "+rb[M]+": "+Ta[M].getErrors()+"\nfor url: "+
h+"\n")}ca=[];xa=[];Ma=[];if(D.length&&(zb=ba.keywords().withCondition("SystemServingStatus != 'RARELY_SERVED'").get().totalNumEntities(),!zb))for(y=0;y<D.length;y++)80<D[y].length||(ma=ba.newKeywordBuilder().withText(R[y]),ma=ma.build(),ca.push(ma),xa.push(R[y]),Ma.push(D[y]));if(aa.length)for(y=0;y<aa.length;y++)80<aa[y].length||(ma=ba.newKeywordBuilder().withText(da[y]),ma=ma.build(),ca.push(ma),xa.push(da[y]),Ma.push(aa[y]));hb=[];for(M=0;M<ca.length;M++)ca[M].isSuccessful()?(Na=ca[M].getResult(),
W[W.length]=Na):(H=ca[M].getErrors(),/CONCURRENT_MODIFICATION/.test(H)&&hb.push(M),Logger.log("Errors from Add Keyword "+xa[M]+": "+H+"\nfor url: "+h+"\n"));if(hb.length){Utilities.sleep(1E3);Ta=[];rb=[];for(M=0;M<hb.length;M++)80<Ma[M].length||(ma=ba.newKeywordBuilder().withText(xa[M]),ma=ma.build(),Ta.push(ma),rb.push(xa[M]));for(M=0;M<Ta.length;M++)Ta[M].isSuccessful()?(Na=Ta[M].getResult(),W[W.length]=Na):Logger.log("Errors from Keyword "+rb[M]+": "+Ta[M].getErrors()+"\nfor url: "+h+"\n")}if(!W.length){ba.pause();
removeAdGroupbuffer(p);return}if(m.removeLSVKeywords)if(1==m.removeLSVKeywords){Pa=ba.keywords().withCondition("SystemServingStatus = 'RARELY_SERVED'").withCondition("Status != REMOVED").get();for(Ea=[];Pa.hasNext();)Da=Pa.next(),Ea.push(Da);for(M=0;M<Ea.length;M++)Ea[M].remove(),Ea[M].remove()}else{Pa=ba.keywords().withCondition("SystemServingStatus = 'RARELY_SERVED'").withCondition("Status = ENABLED").get();for(Ea=[];Pa.hasNext();)Da=Pa.next(),Ea.push(Da);for(M=0;M<Ea.length;M++)Ea[M].pause()}}nb=
Lb+Oa+":end";ba.setName(nb);mb=ba.getName();if(nb!==mb){Va=ub.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").withCondition("AdGroupName = '"+nb.replace(/'/gm,"\\'")+"'").get();if(Va.hasNext()){ob=Va.next();sb=String(ob.getId());ScanCreateFeedsGlobalVars.ABORT||(Logger.log("Abort mode turn on. One of previos starts was aborted for scan "+ScanCreateFeedsGlobalVars.SITE),ScanCreateFeedsGlobalVars.warnings+="Abort mode turn on. One of previos starts was aborted for scan "+
ScanCreateFeedsGlobalVars.SITE+"\n",ScanCreateFeedsGlobalVars.ABORT=1,scanned.errors.abnormal_exits=1);if(Oa){ob.isEnabled()&&ob.pause();sb!=p&&(ba.pause(),removeAdGroupbuffer(p));return}ob.isPaused()&&ob.enable();sb!=p&&(ba.pause(),removeAdGroupbuffer(p));return z}for(qb=0;;){ba.setName(nb);mb=ba.getName();if(nb!==mb){if(qb++,2<qb){Logger.log("Error of set new name for AdGroup: "+nb+", check correct name\nfor url: "+h+"\n");ba.pause();removeAdGroupbuffer(p);return}}else break;Utilities.sleep(1E3)}}if(Oa){ba.isEnabled()&&
ba.pause();return}}}return z}function clearKeyWord(a){if(!/[!@%,\*]/.test(a)&&!/((^\s*[["\[]]?)|(\s))\-[^\s\+"\]]+/.test(a)&&(a=a.replace(/\s\s+/g," "),a=a.replace(/^\s*(["\[]?)\s*(.*?)\s*(["\]]?)\s*$/,"$1$2$3"),/^\s*["\[]/.test(a)&&(a=a.replace(/((^\s*[["\[]]?)|(\s))[\+\-]+([^\s\+\-]+)/g,"$1$4")),!/^["\[]?\s*["\[]?$/.test(a))){a=a.toLowerCase();var d=a.replace(/^\s*(["\[]?)\s*(.*?)\s*(["\]]?)\s*$/,"$2");d=d.replace(/((^\s*)|(\s))[\+]+([^\s\+]+)/g,"$1$4");return[a,d]}}
function differ(a,d){for(var c=a.length,n=[],t={},q=0,h=0;h<c;h++){if(t[a[h]])return!1;var b=a[h];-1===d.indexOf(b)?n.push(b):q++;t[b]=1}return q===d.length?n:null}
function CreateFeed(a,d,c){var n={".html":function(b,m,p){var k="",z;for(z in m[b])if("[object Array]"==={}.toString.call(m[b][z]))for(var G=0;G<m[b][z].length;G++){var y=m[b][z][G],r=p[y].field_value,g=null;if(p[y].include_attributes){y=r.split(/[\n]+/);g={};for(var v=0;v<y.length;v+=2){var l=y[v],e=y[v+1];e=Encoder.XSSEncode(e);g[l]=e}}g||(r=Encoder.XSSEncode(r));if(g){if(Object.keys(g).length){k+=z+"<br>\n";for(var C in g)e=g[C],k="link"==C||"mobile_link"==C?k+("&nbsp;&nbsp;&nbsp;&nbsp;"+C+' <a href="'+
e+'">'+e+"</a><br>\n"):"image_link"==C||"additional_image_link "==C?k+("&nbsp;&nbsp;&nbsp;&nbsp;"+C+" <img src='"+e+"' height='70'><br>\n"):k+("&nbsp;&nbsp;&nbsp;&nbsp;"+C+" <b>"+e+"</b><br>\n")}}else r&&(k="link"==z||"mobile_link"==z?k+(z+' <a href="'+r+'">'+r+"</a><br>\n"):"image_link"==z||"additional_image_link "==z?k+(z+" <img src='"+r+"' height='70'><br>\n"):k+(z+" <b>"+r+"</b><br>\n"))}else{y=z;r=p[y].field_value;g=null;if(p[y].include_attributes)for(y=r.split(/[\n]+/),g={},v=0;v<y.length;v+=
2)l=y[v],e=y[v+1],e=Encoder.XSSEncode(e),g[l]=e;g||(r=Encoder.XSSEncode(r));if(g){if(Object.keys(g).length)for(C in k+=z+"<br>\n",g)e=g[C],k="link"==C||"mobile_link"==C?k+("&nbsp;&nbsp;&nbsp;&nbsp;"+C+' <a href="'+e+'">'+e+"</a><br>\n"):"image_link"==C||"additional_image_link "==C?k+("&nbsp;&nbsp;&nbsp;&nbsp;"+C+" <img src='"+e+"' height='70'><br>\n"):k+("&nbsp;&nbsp;&nbsp;&nbsp;"+C+" <b>"+e+"</b><br>\n")}else r&&(k="link"==z||"mobile_link"==z?k+(z+' <a href="'+r+'">'+r+"</a><br>\n"):"image_link"==
z||"additional_image_link "==z?k+(z+" <img src='"+r+"' height='70'><br>\n"):k+(z+" <b>"+r+"</b><br>\n"))}k&&(k="<hr>\n"+k+"\n");return k},".ga.xml":function(b,m,p){var k="",z;for(z in m[b])if("[object Array]"==={}.toString.call(m[b][z]))for(var G=0;G<m[b][z].length;G++){var y=m[b][z][G],r=p[y].field_value,g=p[y].field_config.htmlencode,v=null;if(p[y].include_attributes){y=r.split(/[\n]+/);v={};for(var l=0;l<y.length;l+=2){var e=y[l],C=y[l+1];if(g)C=Encoder.XSSEncode(C);else{var N=Encoder.XSSEncode(C);
N!==C&&(C="<![CDATA["+C+"]]\x3e")}v[e]=C}}v||(g?r=Encoder.XSSEncode(r):(N=Encoder.XSSEncode(r),N!==r&&(r="<![CDATA["+r+"]]\x3e")));if(v){if(Object.keys(v).length){k+="\t\t\t<g:"+z+">\n";for(var A in v)C=v[A],k+="\t\t\t\t<g:"+A+">"+C+"</g:"+A+">\n";k+="\t\t\t</g:"+z+">\n"}}else r&&(k+="\t\t\t<g:"+z+">"+r+"</g:"+z+">\n")}else{y=z;r=p[y].field_value;g=p[y].field_config.htmlencode;v=null;if(p[y].include_attributes)for(y=r.split(/[\n]+/),v={},l=0;l<y.length;l+=2)e=y[l],C=y[l+1],g?C=Encoder.XSSEncode(C):
(N=Encoder.XSSEncode(C),N!==C&&(C="<![CDATA["+C+"]]\x3e")),v[e]=C;v||(g?r=Encoder.XSSEncode(r):(N=Encoder.XSSEncode(r),N!==r&&(r="<![CDATA["+r+"]]\x3e")));if(v){if(Object.keys(v).length){k+="\t\t\t<g:"+z+">\n";for(A in v)C=v[A],k+="\t\t\t\t<g:"+A+">"+C+"</g:"+A+">\n";k+="\t\t\t</g:"+z+">\n"}}else r&&(k+="\t\t\t<g:"+z+">"+r+"</g:"+z+">\n")}k&&(k="\t\t<item>\n"+k+"\t\t</item>\n");return k},".ga.txt":function(b,m,p){var k="",z=0,G;for(G in m[b]){var y="";if("[object Array]"==={}.toString.call(m[b][G]))for(var r=
0;r<m[b][G].length;r++){var g=m[b][G][r],v=p[g].field_value,l=null;if(p[g].include_attributes){var e=v.split(/[\n]+/);l={};for(var C=0;C<e.length;C+=2){var N=e[C];g=e[C+1];l[N]=g}}if(l){if(Object.keys(l).length){v="";for(var A in l)g=l[A],g=g.replace(/\s*,+\s*/igm," "),v=v?v+(":"+g):g;v&&(y=y?y+(","+v):v)}}else v&&(v=v.replace(/\s*,+\s*/igm," "))&&(y=y?y+(","+v):v)}else{g=G;v=p[g].field_value;l=null;if(p[g].include_attributes)for(e=v.split(/[\n]+/),l={},C=0;C<e.length;C+=2)N=e[C],g=e[C+1],l[N]=g;
if(l){if(Object.keys(l).length){v="";for(A in l)g=l[A],v=v?v+(":"+g):g;v&&(y=y?y+(","+v):v)}}else v&&v&&(y=y?y+(","+v):v)}k=z?k+("\t"+y):y;z++}return k+"\n"},".ga.tsv":function(b,m,p){var k="",z=0,G;for(G in m[b]){var y="";if("[object Array]"==={}.toString.call(m[b][G]))for(var r=0;r<m[b][G].length;r++){var g=m[b][G][r],v=p[g].field_value,l=null;if(p[g].include_attributes){var e=v.split(/[\n]+/);l={};for(var C=0;C<e.length;C+=2){var N=e[C];g=e[C+1];l[N]=g}}if(l){if(Object.keys(l).length){v="";for(var A in l)g=
l[A],g=g.replace(/\s*,+\s*/igm," "),v=v?v+(":"+g):g;v&&(y=y?y+(","+v):v)}}else v&&(v=v.replace(/\s*,+\s*/igm," "))&&(y=y?y+(","+v):v)}else{g=G;v=p[g].field_value;l=null;if(p[g].include_attributes)for(e=v.split(/[\n]+/),l={},C=0;C<e.length;C+=2)N=e[C],g=e[C+1],l[N]=g;if(l){if(Object.keys(l).length){v="";for(A in l)g=l[A],v=v?v+(":"+g):g;v&&(y=y?y+(","+v):v)}}else v&&v&&(y=y?y+(","+v):v)}k=z?k+("\t"+y):y;z++}return k+"\n"}},t=0,q;for(q in d)try{c.hasOwnProperty(q)||(c[q]="");var h=n[q](q,d,a);h&&(c[q]+=
h,t=1)}catch(b){return ScanCreateFeedsGlobalVars.errors+="bad field_type: "+q+" in correctfeedExtPositionFunctions, check script code\n",Logger.log(ScanCreateFeedsGlobalVars.errors),0}return t}
function ParceFeedFields(a,d,c,n,t,q,h){var b={},m=1,p=c.GASearch&&(c.GASearch.Id||c.GASearch.GAShtml);p||c.all_fields_not_required||(m=0);var k=1,z=Object.keys(c.feed_fields_file_types).length;z||c.all_fields_not_required||(k=0);for(var G in c)if(c.fields[G]){var y=G,r=c[y],g=r.field_name;if(!b[g]||!b[g].field_value){var v=r.field_type,l=r.field_required,e="",C=0;if(r.hasOwnProperty("field_length")){var N=r.field_length;if("string"!==typeof N&&"number"!==typeof N){ScanCreateFeedsGlobalVars.errors+=
"bad field_length, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(!/^\d+$/.test(N)){ScanCreateFeedsGlobalVars.errors+="bad field_length, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N*=1}else N=0;if("html"===v){if("string"!==typeof r.parsing_type){ScanCreateFeedsGlobalVars.errors+="bad parsing_type, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}var A=v=0;if(r.field_value_selector){if("string"!==typeof r.field_value_selector)if("[object Array]"===
{}.toString.call(r.field_value_selector)&&r.field_value_selector.length){A=1;for(var w=0;w<r.field_value_selector.length;w++)"string"===typeof r.field_value_selector[w]&&r.field_value_selector[w]||(v=1)}else v=1}else"string"!==typeof r.field_value_selector&&(v=1);if(v){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}v=a;if(A){for(w=0;w<r.field_value_selector.length-1;w++){v=parseHtml(v,r.field_value_selector[w],"text");
if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}v=v.result}w=r.field_value_selector[r.field_value_selector.length-1]}else w=r.field_value_selector;if("iso4217price"==r.parsing_type||"nativeprice"==r.parsing_type){v=parseHtml(v,w,"text",r.field_replace,r.field_Fun,q,b,g);if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}v.result&&
("nativeprice"==r.parsing_type?(w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][0]&&w[1]&&w[1][0]&&(e=w[1][1]?w[0][0]+" "+w[1][1]:w[0][0]+" "+w[1][0])):(w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][1]&&w[1]&&w[1][0]&&(e=w[0][1]+" "+w[1][0])))}else{v=parseHtml(v,w,r.parsing_type,r.field_replace,r.field_Fun,q,b,g);if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}e=v.result;e=digitkeysproc(e,r.field_digitkeys)}if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+=
"bad field_value_selector value (must delete \t\n\r symbols), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("iso4217price"==r.parsing_type||"nativeprice"==r.parsing_type){if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}else if("text"==r.parsing_type||""===r.parsing_type)e=getMaxStr(e,N);else if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+
g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else{if(2===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(3===l){ScanCreateFeedsGlobalVars.errors+=
"bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)if(b[l[w]]&&b[l[w]].field_value)N++;else if(!b.hasOwnProperty(l[w])){ScanCreateFeedsGlobalVars.errors+="bad field_required: not exists field_name "+l[w]+" in previos fields, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+
g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}}else if("fullhtml"===v){if("string"!==typeof r.parsing_type){ScanCreateFeedsGlobalVars.errors+="bad parsing_type, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}A=v=0;if(r.field_value_selector){if("string"!==typeof r.field_value_selector)if("[object Array]"==={}.toString.call(r.field_value_selector)&&r.field_value_selector.length)for(A=1,w=0;w<r.field_value_selector.length;w++)"string"===typeof r.field_value_selector[w]&&
r.field_value_selector[w]||(v=1);else v=1}else"string"!==typeof r.field_value_selector&&(v=1);if(v){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}v=d;if(A){for(w=0;w<r.field_value_selector.length-1;w++){v=parseHtml(v,r.field_value_selector[w],"text");if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}v=v.result}w=r.field_value_selector[r.field_value_selector.length-
1]}else w=r.field_value_selector;if("iso4217price"==r.parsing_type||"nativeprice"==r.parsing_type){v=parseHtml(v,w,"text",r.field_replace,r.field_Fun,q,b,g);if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}v.result&&("nativeprice"==r.parsing_type?(w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][0]&&w[1]&&w[1][0]&&(e=w[1][1]?w[0][0]+" "+w[1][1]:w[0][0]+" "+w[1][0])):(w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][1]&&
w[1]&&w[1][0]&&(e=w[0][1]+" "+w[1][0])))}else{v=parseHtml(v,w,r.parsing_type,r.field_replace,r.field_Fun,q,b,g);if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}e=v.result;e=digitkeysproc(e,r.field_digitkeys)}if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector value (must delete \t\n\r symbols), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("iso4217price"==
r.parsing_type||"nativeprice"==r.parsing_type){if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}else if("text"==r.parsing_type||""===r.parsing_type)e=getMaxStr(e,N);else if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+=
"bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else{if(2===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(3===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"==typeof l){if(!r.field_Fun){l=
l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)if(b[l[w]]&&b[l[w]].field_value)N++;else if(!b.hasOwnProperty(l[w])){ScanCreateFeedsGlobalVars.errors+="bad field_required: not exists field_name "+l[w]+" in previos fields, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}}else if("[object Array]"==={}.toString.call(v)&&2==v.length){if("string"!==
typeof v[0]||!v[0]||"string"!==typeof v[1]){ScanCreateFeedsGlobalVars.errors+="bad field_type, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}var f=v[0].split(/[\s,]*,[\s,]*/),J=A=0,K=0,u=1,F=N;r.parsing_type&&(N=0);for(w=0;w<f.length;w++)if(b[f[w]]&&b[f[w]].field_value){if(J?A=-1:A++,3!==l||!(w>=f.length-1)&&b[f[w+1]]&&b[f[w+1]].field_value||(u=0),u)if(N){if(!K){var I=e?v[1]+b[f[w]].field_value:b[f[w]].field_value;I.length>N?K=1:e+=I}}else e=e?e+(v[1]+b[f[w]].field_value):b[f[w]].field_value}else J=
1;N=F;if(e){v=parseHtmlFUN(e,r.field_value_selector,r.field_replace,r.field_Fun,q,b,g);e="";if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(v.result)if(r.parsing_type)if("nativeprice"===r.parsing_type)w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][0]&&w[1]&&w[1][0]&&(e=w[1][1]?w[0][0]+" "+w[1][1]:w[0][0]+" "+w[1][0]);else if("iso4217price"===r.parsing_type)w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][1]&&
w[1]&&w[1][0]&&(e=w[0][1]+" "+w[1][0]);else{ScanCreateFeedsGlobalVars.errors+="bad parsing_type (need to remove parsing_type), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}else e=v.result,e=digitkeysproc(e,r.field_digitkeys)}if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector value (must delete \t\n\r symbols), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(r.parsing_type&&N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+
g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else if(2===l){if(0>A)return}else if(3===l){if(0>A)return}else if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)b[l[w]]&&
b[l[w]].field_value&&N++;N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}else if("[object Array]"==={}.toString.call(v)&&1==v.length){C=1;if("string"!==typeof v[0]||!v[0]){ScanCreateFeedsGlobalVars.errors+="bad field_type, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}f=v[0].split(/[\s,]*,[\s,]*/);J=A=0;u=1;for(w=0;w<f.length;w++)b[f[w]]&&b[f[w]].field_value?(J?A=-1:A++,3!==l||!(w>=f.length-
1)&&b[f[w+1]]&&b[f[w+1]].field_value||(u=0),u&&(e=e?e+("\n"+f[w]+"\n"+b[f[w]].field_value):f[w]+"\n"+b[f[w]].field_value)):J=1;if(e){v=parseHtmlFUN(e,r.field_value_selector,r.field_replace,r.field_Fun,q,b,g);if(r.parsing_type){ScanCreateFeedsGlobalVars.errors+="bad parsing_type (need to remove parsing_type), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);
return}e=v.result}if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else if(2===l){if(0>A)return}else if(3===l){if(0>
A)return}else if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)b[l[w]]&&b[l[w]].field_value&&N++;N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}else if("fixed"===v){if("string"!==typeof r.field_value_selector){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(e=r.field_value_selector){v=
parseHtmlFUN(e,r.field_value_selector,r.field_replace,r.field_Fun,q,b,g);e="";if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(v.result)if(r.parsing_type)if("nativeprice"===r.parsing_type)w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][0]&&w[1]&&w[1][0]&&(e=w[1][1]?w[0][0]+" "+w[1][1]:w[0][0]+" "+w[1][0]);else if("iso4217price"===r.parsing_type)w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][1]&&w[1]&&w[1][0]&&
(e=w[0][1]+" "+w[1][0]);else{ScanCreateFeedsGlobalVars.errors+="bad parsing_type (need to remove parsing_type), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}else e=v.result,e=digitkeysproc(e,r.field_digitkeys)}if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector value (must delete \t\n\r symbols), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(r.parsing_type){if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+
g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}else e=getMaxStr(e,N);if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else{if(2===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(3===
l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)if(b[l[w]]&&b[l[w]].field_value)N++;else if(!b.hasOwnProperty(l[w])){ScanCreateFeedsGlobalVars.errors+="bad field_required: not exists field_name "+l[w]+" in previos fields, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+=
"bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}}else if("id"===v){if(e=t){v=parseHtmlFUN(e,r.field_value_selector,r.field_replace,r.field_Fun,q,b,g);if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(r.parsing_type){ScanCreateFeedsGlobalVars.errors+="bad parsing_type (need to remove parsing_type), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}e=
v.result}if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector value (must delete \t\n\r symbols), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);
return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else{if(2===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(3===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)if(b[l[w]]&&b[l[w]].field_value)N++;
else if(!b.hasOwnProperty(l[w])){ScanCreateFeedsGlobalVars.errors+="bad field_required: not exists field_name "+l[w]+" in previos fields, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}}else if("url"===v){if(e=q){v=parseHtmlFUN(e,r.field_value_selector,r.field_replace,r.field_Fun,q,b,g);if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+
v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(r.parsing_type){ScanCreateFeedsGlobalVars.errors+="bad parsing_type (need to remove parsing_type), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}e=v.result}e&&(c.noDropShip||(w=parse_url(e),e=w.search?e+"&":e+"?",e+="sodship=y"),c.utmDropShip&&(w=parse_url(e),e=w.search?e+"&":e+"?",e+=c.utmDropShip+c.ext));if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector value (must delete \t\n\r symbols), field: "+
g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else{if(2===
l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(3===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)if(b[l[w]]&&b[l[w]].field_value)N++;else if(!b.hasOwnProperty(l[w])){ScanCreateFeedsGlobalVars.errors+="bad field_required: not exists field_name "+l[w]+
" in previos fields, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}}else if("string"==typeof v&&/^id.+$/.test(v)){if(v.replace(/^id(.+)$/,"$1")&&b.hasOwnProperty(g))e=murmurhash3_32_gc(b[g],n.seed);else{ScanCreateFeedsGlobalVars.errors+="bad field_type, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(e){v=parseHtmlFUN(e,
r.field_value_selector,r.field_replace,r.field_Fun,q,b,g);if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(r.parsing_type){ScanCreateFeedsGlobalVars.errors+="bad parsing_type (need to remove parsing_type), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}e=v.result}if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector value (must delete \t\n\r symbols), field: "+
g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else{if(2===
l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(3===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)if(b[l[w]]&&b[l[w]].field_value)N++;else if(!b.hasOwnProperty(l[w])){ScanCreateFeedsGlobalVars.errors+="bad field_required: not exists field_name "+l[w]+
" in previos fields, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}}else if("parentFeed"===v){if(!h)return;if(!h.hasOwnProperty(r.field_value_selector)){ScanCreateFeedsGlobalVars.errors+="bad field_value_selector for field_name: "+g+", no found field in parent feed\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(h[r.field_value_selector].include_attributes)return ScanCreateFeedsGlobalVars.errors+=
"bad field_name in field_value_selector, field: "+g+" in this feed, field_name "+r.field_value_selector+' in parent feed  have "include attributes" type, not use it in this feed.\n',Logger.log(ScanCreateFeedsGlobalVars.errors),"";if(e=h[r.field_value_selector].field_value){v=parseHtmlFUN(e,r.field_value_selector,r.field_replace,r.field_Fun,q,b,g);e="";if(v.errors){ScanCreateFeedsGlobalVars.errors+="errors "+v.errors+", field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(v.result)if(r.parsing_type)if("nativeprice"===
r.parsing_type)w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][0]&&w[1]&&w[1][0]&&(e=w[1][1]?w[0][0]+" "+w[1][1]:w[0][0]+" "+w[1][0]);else if("iso4217price"===r.parsing_type)w=getPriceCurrencyFromStr(v.result),w[0]&&w[0][1]&&w[1]&&w[1][0]&&(e=w[0][1]+" "+w[1][0]);else{ScanCreateFeedsGlobalVars.errors+="bad parsing_type (need to remove parsing_type), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}else e=v.result,e=digitkeysproc(e,r.field_digitkeys)}if(/[\t\n\r]/.test(e)){ScanCreateFeedsGlobalVars.errors+=
"bad field_value_selector value (must delete \t\n\r symbols), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(N){ScanCreateFeedsGlobalVars.errors+="bad field_length (need to remove field_length), field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"!==typeof l&&"number"!==typeof l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(-1===l){if(e)return}else if(0!==l)if(4===l)!e&&
z&&(k=0);else if(5===l)!e&&p&&(m=0);else if(1===l){if(!e)return}else{if(2===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(3===l){ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if("string"==typeof l){if(!r.field_Fun){l=l.split(/[\s,]*,[\s,]*/);for(w=N=0;w<l.length;w++)if(b[l[w]]&&b[l[w]].field_value)N++;else if(!b.hasOwnProperty(l[w])){ScanCreateFeedsGlobalVars.errors+=
"bad field_required: not exists field_name "+l[w]+" in previos fields, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}N&&(e="")}}else{ScanCreateFeedsGlobalVars.errors+="bad field_required, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}}}else{ScanCreateFeedsGlobalVars.errors+="bad field_type, field: "+g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(r.keyword&&(e=KeyWordString(e,r.keyword),null===e)){ScanCreateFeedsGlobalVars.errors+="bad keyword, field: "+
g+"\n";Logger.log(ScanCreateFeedsGlobalVars.errors);return}if(!m&&!k)return;b[g]={field_value:e,field_id:y,include_attributes:C,field_config:r}}}return{checkedfields:b,search_exist:m,feedfiles_exist:k}}
function digitkeysproc(a,d){if(!a||!d)return a;a=a.replace(/((?:^|\s)(?:(?:(?=[^\s\(\)\d]*\d+)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)(?:[^\s\(\)\d]*\d+[^\s\(\)\d]*\s*)*)|(?:[a-zA-Z0-9\.\-_\/]{7,}))(?=\s|$))/g,function(c,n,t,q){if(!/\d.*\d.*\d/.test(n))return c;if(4==d)return"";t=n.replace(/([^\s])\s+(?=[^\s])/g,"$1");return 2!=d&&/^\s*\d\d\d\d\d\d+\s*$/.test(t)?"":1!=
d&&n!=t&&(q=t.trim())&&(/^\d+$/.test(q)||/(^|\s)[^\s](\s|$)/.test(n))?t:c});a=a.replace(/\s*\(\s*\)/g,"");return a=a.trim()}function getMaxStr(a,d){if("string"!=typeof a)return"";if(!d||!/^\d+$/.test(d))return a;d*=1;if(!d||d>=a.length)return a;var c=d-1;0>=c&&(c=1);c=a.match("^.{1,"+c+"}[\\.\\!\\|](?=\\s|$)");if(null!==c)return c[0];c=parseInt(d/2);0>=c&&(c=1);c=a.match("^.{"+c+","+d+"}(?=\\s*\\,(?:\\s|$))");if(null!==c)return c[0];c=a.match("^.{1,"+d+"}(?=\\s|$)");return null!==c?c[0]:""}
function KeyWordString(a,d){function c(t,q,h,b,m,p,k){"string"==typeof h?(t=m.toLowerCase().replace(/^(["'\(]*\s*[^"'\(\s]).*$/,"$1").toUpperCase(),m=t+m.toLowerCase().replace(/^["'\(]*\s*[^"'\(\s](.*)$/,"$1")):1==m.length?m=m.toLowerCase():(t=m.toLowerCase().replace(/^(["'\(]*\s*[^"'\(\s]).*$/,"$1").toUpperCase(),m=t+m.toLowerCase().replace(/^["'\(]*\s*[^"'\(\s](.*)$/,"$1"));return q+m}function n(t,q,h,b,m,p,k){t="string"==typeof h?m.toLowerCase().replace(/^(["'\(]*\s*[^"'\(\s]).*$/,"$1").toUpperCase()+
m.toLowerCase().replace(/^["'\(]*\s*[^"'\(\s](.*)$/,"$1"):m.toLowerCase();return q+t}if(d)if("Keyword"==d)a&&(a=a.replace(/(((?:^\s*)|(?:\.\s*)|(?:!\s*)|(?:\|\s*))|([,\s]+))(["'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:["'\)\s\.!\|,])|(?:$)))/g,n));else if("KeyWord"==d)a&&(a=a.replace(/(((?:^\s*)|(?:\.\s*)|(?:!\s*)|(?:\|\s*))|([,\s]+))(["'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:["'\)\s\.!\|,])|(?:$)))/g,c));else if("keyword"==d)a&&(a=a.toLowerCase());else if("KEYWORD"==d)a&&
(a=a.toUpperCase());else return null;return a}function isValidResponseCodeCSV(a,d){var c=d.skip_errors;if(200==a)return!0;if(c&&c.length)for(var n in c)if(c[n]==a)return!0;return!1}function isValidResponseCode(a){var d=ScanCreateFeedsGlobalVars.skip_errors;if(200==a)return!0;if(d&&d.length)for(var c in d)if(d[c]==a)return!0;return!1}
Encoder={EncodeType:"entity",isEmpty:function(a){return a?null===a||0==a.length||/^\s+$/.test(a):!0},arr1:"&nbsp; &iexcl; &cent; &pound; &curren; &yen; &brvbar; &sect; &uml; &copy; &ordf; &laquo; &not; &shy; &reg; &macr; &deg; &plusmn; &sup2; &sup3; &acute; &micro; &para; &middot; &cedil; &sup1; &ordm; &raquo; &frac14; &frac12; &frac34; &iquest; &Agrave; &Aacute; &Acirc; &Atilde; &Auml; &Aring; &AElig; &Ccedil; &Egrave; &Eacute; &Ecirc; &Euml; &Igrave; &Iacute; &Icirc; &Iuml; &ETH; &Ntilde; &Ograve; &Oacute; &Ocirc; &Otilde; &Ouml; &times; &Oslash; &Ugrave; &Uacute; &Ucirc; &Uuml; &Yacute; &THORN; &szlig; &agrave; &aacute; &acirc; &atilde; &auml; &aring; &aelig; &ccedil; &egrave; &eacute; &ecirc; &euml; &igrave; &iacute; &icirc; &iuml; &eth; &ntilde; &ograve; &oacute; &ocirc; &otilde; &ouml; &divide; &oslash; &ugrave; &uacute; &ucirc; &uuml; &yacute; &thorn; &yuml; &quot; &amp; &lt; &gt; &OElig; &oelig; &Scaron; &scaron; &Yuml; &circ; &tilde; &ensp; &emsp; &thinsp; &zwnj; &zwj; &lrm; &rlm; &ndash; &mdash; &lsquo; &rsquo; &sbquo; &ldquo; &rdquo; &bdquo; &dagger; &Dagger; &permil; &lsaquo; &rsaquo; &euro; &fnof; &Alpha; &Beta; &Gamma; &Delta; &Epsilon; &Zeta; &Eta; &Theta; &Iota; &Kappa; &Lambda; &Mu; &Nu; &Xi; &Omicron; &Pi; &Rho; &Sigma; &Tau; &Upsilon; &Phi; &Chi; &Psi; &Omega; &alpha; &beta; &gamma; &delta; &epsilon; &zeta; &eta; &theta; &iota; &kappa; &lambda; &mu; &nu; &xi; &omicron; &pi; &rho; &sigmaf; &sigma; &tau; &upsilon; &phi; &chi; &psi; &omega; &thetasym; &upsih; &piv; &bull; &hellip; &prime; &Prime; &oline; &frasl; &weierp; &image; &real; &trade; &alefsym; &larr; &uarr; &rarr; &darr; &harr; &crarr; &lArr; &uArr; &rArr; &dArr; &hArr; &forall; &part; &exist; &empty; &nabla; &isin; &notin; &ni; &prod; &sum; &minus; &lowast; &radic; &prop; &infin; &ang; &and; &or; &cap; &cup; &int; &there4; &sim; &cong; &asymp; &ne; &equiv; &le; &ge; &sub; &sup; &nsub; &sube; &supe; &oplus; &otimes; &perp; &sdot; &lceil; &rceil; &lfloor; &rfloor; &lang; &rang; &loz; &spades; &clubs; &hearts; &diams;".split(" "),arr2:"&#160; &#161; &#162; &#163; &#164; &#165; &#166; &#167; &#168; &#169; &#170; &#171; &#172; &#173; &#174; &#175; &#176; &#177; &#178; &#179; &#180; &#181; &#182; &#183; &#184; &#185; &#186; &#187; &#188; &#189; &#190; &#191; &#192; &#193; &#194; &#195; &#196; &#197; &#198; &#199; &#200; &#201; &#202; &#203; &#204; &#205; &#206; &#207; &#208; &#209; &#210; &#211; &#212; &#213; &#214; &#215; &#216; &#217; &#218; &#219; &#220; &#221; &#222; &#223; &#224; &#225; &#226; &#227; &#228; &#229; &#230; &#231; &#232; &#233; &#234; &#235; &#236; &#237; &#238; &#239; &#240; &#241; &#242; &#243; &#244; &#245; &#246; &#247; &#248; &#249; &#250; &#251; &#252; &#253; &#254; &#255; &#34; &#38; &#60; &#62; &#338; &#339; &#352; &#353; &#376; &#710; &#732; &#8194; &#8195; &#8201; &#8204; &#8205; &#8206; &#8207; &#8211; &#8212; &#8216; &#8217; &#8218; &#8220; &#8221; &#8222; &#8224; &#8225; &#8240; &#8249; &#8250; &#8364; &#402; &#913; &#914; &#915; &#916; &#917; &#918; &#919; &#920; &#921; &#922; &#923; &#924; &#925; &#926; &#927; &#928; &#929; &#931; &#932; &#933; &#934; &#935; &#936; &#937; &#945; &#946; &#947; &#948; &#949; &#950; &#951; &#952; &#953; &#954; &#955; &#956; &#957; &#958; &#959; &#960; &#961; &#962; &#963; &#964; &#965; &#966; &#967; &#968; &#969; &#977; &#978; &#982; &#8226; &#8230; &#8242; &#8243; &#8254; &#8260; &#8472; &#8465; &#8476; &#8482; &#8501; &#8592; &#8593; &#8594; &#8595; &#8596; &#8629; &#8656; &#8657; &#8658; &#8659; &#8660; &#8704; &#8706; &#8707; &#8709; &#8711; &#8712; &#8713; &#8715; &#8719; &#8721; &#8722; &#8727; &#8730; &#8733; &#8734; &#8736; &#8743; &#8744; &#8745; &#8746; &#8747; &#8756; &#8764; &#8773; &#8776; &#8800; &#8801; &#8804; &#8805; &#8834; &#8835; &#8836; &#8838; &#8839; &#8853; &#8855; &#8869; &#8901; &#8968; &#8969; &#8970; &#8971; &#9001; &#9002; &#9674; &#9824; &#9827; &#9829; &#9830;".split(" "),
HTML2Numerical:function(a){return this.swapArrayVals(a,this.arr1,this.arr2)},NumericalToHTML:function(a){return this.swapArrayVals(a,this.arr2,this.arr1)},numEncode:function(a){if(this.isEmpty(a))return"";for(var d=[],c=a.length,n=0;n<c;n++){var t=a.charAt(n);" ">t||"~"<t?(d.push("&#"),d.push(t.charCodeAt()),d.push(";")):d.push(t)}return d.join("")},htmlDecode:function(a){var d=a;if(this.isEmpty(d))return"";d=this.HTML2Numerical(d);arr=d.match(/&#[0-9]{1,5};/g);if(null!=arr)for(var c=0;c<arr.length;c++){var n=
arr[c];a=n.substring(2,n.length-1);d=-32768<=a&&65535>=a?d.replace(n,String.fromCharCode(a)):d.replace(n,"")}return d},htmlEncode:function(a,d){if(this.isEmpty(a))return"";(d=d||!1)&&(a="numerical"==this.EncodeType?a.replace(/&/g,"&#38;"):a.replace(/&/g,"&amp;"));a=this.XSSEncode(a,!1);"numerical"!=this.EncodeType&&d||(a=this.HTML2Numerical(a));a=this.numEncode(a);d||(a=a.replace(/&#/g,"##AMPHASH##"),a="numerical"==this.EncodeType?a.replace(/&/g,"&#38;"):a.replace(/&/g,"&amp;"),a=a.replace(/##AMPHASH##/g,
"&#"));a=a.replace(/&#\d*([^\d;]|$)/g,"$1");d||(a=this.correctEncoding(a));"entity"==this.EncodeType&&(a=this.NumericalToHTML(a));return a},XSSEncode:function(a,d){if(this.isEmpty(a))return"";a=a.replace(/'/g,"&#39;");a=a.replace(/"/g,"&quot;");a=a.replace(/</g,"&lt;");return a=a.replace(/>/g,"&gt;")},hasEncoded:function(a){return/&#[0-9]{1,5};/.test(a)?!0:/&[A-Z]{2,6};/i.test(a)?!0:!1},stripUnicode:function(a){return a.replace(/[^\x20-\x7E]/g,"")},correctEncoding:function(a){return a.replace(/(&amp;)(amp;)+/,
"$1")},swapArrayVals:function(a,d,c){if(this.isEmpty(a))return"";if(d&&c&&d.length==c.length)for(var n=0,t=d.length;n<t;n++){var q=new RegExp(d[n],"g");a=a.replace(q,c[n])}return a},inArray:function(a,d){for(var c=0,n=d.length;c<n;c++)if(d[c]===a)return c;return-1}};
function SkipParseURL(a,d){var c=d.skip_parse,n=d.only_parse,t=d.parseUrlFun;if(c&&c.length||n&&n.length||t){"/"!=a.substr(0,1)&&(a="/"+a);if(c&&c.length)for(var q in c)if("/"==c[q]){if("/"==a)return!0}else if(a.substr(0,c[q].length)==c[q])return!0;if(n&&n.length){c=0;for(q in n)"/"==n[q]?"/"==a&&(c=1):a.substr(0,n[q].length)==n[q]&&(c=1);if(!c)return!0}if(t)try{if(!t(a))return!0}catch(h){ScanCreateFeedsGlobalVars.errors+="bad function parseUrlFun:"+h.message+"\n",Logger.log(ScanCreateFeedsGlobalVars.errors)}}else return"";
return!1}function floorN(a,d){a=parseFloat(a);return parseFloat(a.toFixed(d))}
(function(a,d){"function"===typeof define&&define.amd?define([],d):"object"===typeof module&&"undefined"!==typeof exports?module.exports=d():a.Papa=d()})(this,function moduleFactory(){function d(J){this._handle=null;this._halted=this._completed=this._finished=!1;this._input=null;this._baseIndex=0;this._partialLine="";this._start=this._rowCount=0;this._nextChunk=null;this.isFirstChunk=!0;this._completeResults={data:[],errors:[],meta:{}};(function(K){var u=r(K);u.chunkSize=parseInt(u.chunkSize);K.step||
K.chunk||(u.chunkSize=null);this._handle=new b(u);this._handle.streamer=this;this._config=u}).call(this,J);this.parseChunk=function(K,u){if(this.isFirstChunk&&v(this._config.beforeFirstChunk)){var F=this._config.beforeFirstChunk(K);void 0!==F&&(K=F)}this._halted=this.isFirstChunk=!1;var I=this._partialLine+K;this._partialLine="";F=this._handle.parse(I,this._baseIndex,!this._finished);if(this._handle.paused()||this._handle.aborted())this._halted=!0;else{var B=F.meta.cursor;this._finished||(this._partialLine=
I.substring(B-this._baseIndex),this._baseIndex=B);F&&F.data&&(this._rowCount+=F.data.length);I=this._finished||this._config.preview&&this._rowCount>=this._config.preview;if(C)l.postMessage({results:F,workerId:w.WORKER_ID,finished:I});else if(v(this._config.chunk)&&!u){this._config.chunk(F,this._handle);if(this._handle.paused()||this._handle.aborted()){this._halted=!0;return}this._completeResults=F=void 0}this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(F.data),
this._completeResults.errors=this._completeResults.errors.concat(F.errors),this._completeResults.meta=F.meta);this._completed||!I||!v(this._config.complete)||F&&F.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0);I||F&&F.meta.paused||this._nextChunk();return F}};this._sendError=function(K){v(this._config.error)?this._config.error(K):C&&this._config.error&&l.postMessage({workerId:w.WORKER_ID,error:K,finished:!1})}}function c(J){J=J||{};J.chunkSize||(J.chunkSize=
w.RemoteChunkSize);d.call(this,J);var K;this._nextChunk=e?function(){this._readChunk();this._chunkLoaded()}:function(){this._readChunk()};this.stream=function(u){this._input=u;this._nextChunk()};this._readChunk=function(){if(this._finished)this._chunkLoaded();else{K=new XMLHttpRequest;this._config.withCredentials&&(K.withCredentials=this._config.withCredentials);e||(K.onload=g(this._chunkLoaded,this),K.onerror=g(this._chunkError,this));K.open("GET",this._input,!e);if(this._config.downloadRequestHeaders){var u=
this._config.downloadRequestHeaders,F;for(F in u)K.setRequestHeader(F,u[F])}this._config.chunkSize&&K.setRequestHeader("Range","bytes="+this._start+"-"+(this._start+this._config.chunkSize-1));try{K.send()}catch(I){this._chunkError(I.message)}e&&0===K.status?this._chunkError():this._start+=this._config.chunkSize}};this._chunkLoaded=function(){if(4===K.readyState)if(200>K.status||400<=K.status)this._chunkError();else{var u;if(!(u=!this._config.chunkSize)){u=this._start;var F=K.getResponseHeader("Content-Range");
F=null===F?-1:parseInt(F.substr(F.lastIndexOf("/")+1));u=u>F}this._finished=u;this.parseChunk(K.responseText)}};this._chunkError=function(u){this._sendError(Error(K.statusText||u))}}function n(J){J=J||{};J.chunkSize||(J.chunkSize=w.LocalChunkSize);d.call(this,J);var K,u,F="undefined"!==typeof FileReader;this.stream=function(I){this._input=I;u=I.slice||I.webkitSlice||I.mozSlice;F?(K=new FileReader,K.onload=g(this._chunkLoaded,this),K.onerror=g(this._chunkError,this)):K=new FileReaderSync;this._nextChunk()};
this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()};this._readChunk=function(){var I=this._input;this._config.chunkSize&&(I=u.call(I,this._start,Math.min(this._start+this._config.chunkSize,this._input.size)));I=K.readAsText(I,this._config.encoding);F||this._chunkLoaded({target:{result:I}})};this._chunkLoaded=function(I){this._start+=this._config.chunkSize;this._finished=!this._config.chunkSize||this._start>=this._input.size;this.parseChunk(I.target.result)};
this._chunkError=function(){this._sendError(K.error)}}function t(J){J=J||{};d.call(this,J);var K;this.stream=function(u){K=u;return this._nextChunk()};this._nextChunk=function(){if(!this._finished){var u=this._config.chunkSize,F=u?K.substr(0,u):K;K=u?K.substr(u):"";this._finished=!K;return this.parseChunk(F)}}}function q(J){J=J||{};d.call(this,J);var K=[],u=!0,F=!1;this.pause=function(){d.prototype.pause.apply(this,arguments);this._input.pause()};this.resume=function(){d.prototype.resume.apply(this,
arguments);this._input.resume()};this.stream=function(I){this._input=I;this._input.on("data",this._streamData);this._input.on("end",this._streamEnd);this._input.on("error",this._streamError)};this._checkIsFinished=function(){F&&1===K.length&&(this._finished=!0)};this._nextChunk=function(){this._checkIsFinished();K.length?this.parseChunk(K.shift()):u=!0};this._streamData=g(function(I){try{K.push("string"===typeof I?I:I.toString(this._config.encoding)),u&&(u=!1,this._checkIsFinished(),this.parseChunk(K.shift()))}catch(B){this._streamError(B)}},
this);this._streamError=g(function(I){this._streamCleanUp();this._sendError(I)},this);this._streamEnd=g(function(){this._streamCleanUp();F=!0;this._streamData("")},this);this._streamCleanUp=g(function(){this._input.removeListener("data",this._streamData);this._input.removeListener("end",this._streamEnd);this._input.removeListener("error",this._streamError)},this)}function h(J){var K=require("stream").Duplex,u=r(J),F=!0,I=!1,B=[],U=null;this._onCsvData=function(P){U.push(P.data)||this._handle.paused()||
this._handle.pause()};this._onCsvComplete=function(){U.push(null)};u.step=g(this._onCsvData,this);u.complete=g(this._onCsvComplete,this);d.call(this,u);this._nextChunk=function(){I&&1===B.length&&(this._finished=!0);B.length?B.shift()():F=!0};this._addToParseQueue=function(P,X){B.push(g(function(){this.parseChunk("string"===typeof P?P:P.toString(u.encoding));if(v(X))return X()},this));F&&(F=!1,this._nextChunk())};this._onRead=function(){this._handle.paused()&&this._handle.resume()};this._onWrite=
function(P,X,S){this._addToParseQueue(P,S)};this._onWriteComplete=function(){I=!0;this._addToParseQueue("")};this.getStream=function(){return U};U=new K({readableObjectMode:!0,decodeStrings:!1,read:g(this._onRead,this),write:g(this._onWrite,this)});U.once("finish",g(this._onWriteComplete,this))}function b(J){function K(V){return"greedy"===J.skipEmptyLines?""===V.join("").trim():1===V.length&&0===V[0].length}function u(){Z&&Q&&(B("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+
w.DefaultDelimiter+"'"),Q=!1);if(J.skipEmptyLines)for(var V=0;V<Z.data.length;V++)K(Z.data[V])&&Z.data.splice(V--,1);J.header&&0===R.length&&F();return I()}function F(){function V(oa){v(J.transformHeader)&&(oa=J.transformHeader(oa));R.push(oa)}if(Z)if(Array.isArray(Z.data[0])){for(var fa=0;J.header&&0===R.length&&fa<Z.data.length;fa++)Z.data[fa].forEach(V);Z.data.splice(0,1)}else Z.data.forEach(V)}function I(){function V(oa,ha){var ia=J.header?{}:[],ja;for(ja=0;ja<oa.length;ja++){var Ga=ja,ka=oa[ja];
J.header&&(Ga=ja>=R.length?"__parsed_extra":R[ja]);J.transform&&(ka=J.transform(ka,Ga));var za=Ga;J.dynamicTypingFunction&&void 0===J.dynamicTyping[za]&&(J.dynamicTyping[za]=J.dynamicTypingFunction(za));ka=!0===(J.dynamicTyping[za]||J.dynamicTyping)?"true"===ka||"TRUE"===ka?!0:"false"===ka||"FALSE"===ka?!1:U.test(ka)?parseFloat(ka):P.test(ka)?new Date(ka):""===ka?null:ka:ka;"__parsed_extra"===Ga?(ia[Ga]=ia[Ga]||[],ia[Ga].push(ka)):ia[Ga]=ka}J.header&&(ja>R.length?B("FieldMismatch","TooManyFields",
"Too many fields: expected "+R.length+" fields but parsed "+ja,O+ha):ja<R.length&&B("FieldMismatch","TooFewFields","Too few fields: expected "+R.length+" fields but parsed "+ja,O+ha));return ia}if(!Z||!J.header&&!J.dynamicTyping&&!J.transform)return Z;var fa=1;!Z.data[0]||Array.isArray(Z.data[0])?(Z.data=Z.data.map(V),fa=Z.data.length):Z.data=V(Z.data,0);J.header&&Z.meta&&(Z.meta.fields=R);O+=fa;return Z}function B(V,fa,oa,ha){Z.errors.push({type:V,code:fa,message:oa,row:ha})}var U=/^\s*-?(\d*\.?\d+|\d+\.?\d*)(e[-+]?\d+)?\s*$/i,
P=/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/,X=this,S=0,O=0,aa,T,da=!1,D=!1,Q,R=[],Z={data:[],errors:[],meta:{}};if(v(J.step)){var sa=J.step;J.step=function(V){Z=V;J.header&&0===R.length?u():(u(),0!==Z.data.length&&(S+=V.data.length,J.preview&&S>J.preview?T.abort():sa(Z,X)))}}this.parse=function(V,fa,oa){var ha=J.quoteChar||'"';if(!J.newline){var ia=
V.substr(0,1048576);ha=new RegExp(m(ha)+"([^]*?)"+m(ha),"gm");ia=ia.replace(ha,"");ha=ia.split("\r");ia=ia.split("\n");ia=1<ia.length&&ia[0].length<ha[0].length;if(1===ha.length||ia)ha="\n";else{for(var ja=ia=0;ja<ha.length;ja++)"\n"===ha[ja][0]&&ia++;ha=ia>=ha.length/2?"\r\n":"\r"}J.newline=ha}Q=!1;if(J.delimiter)v(J.delimiter)&&(J.delimiter=J.delimiter(V),Z.meta.delimiter=J.delimiter);else{ha=J.newline;ia=J.skipEmptyLines;ja=J.comments;var Ga=J.delimitersToGuess;Ga=Ga||[",","\t","|",";",w.RECORD_SEP,
w.UNIT_SEP];for(var ka=0;ka<Ga.length;ka++){var za=Ga[ka],Ha=0,Aa=0,na=0;var la=void 0;for(var qa=(new p({comments:ja,delimiter:za,newline:ha,preview:10})).parse(V),db=0;db<qa.data.length;db++)if(ia&&K(qa.data[db]))na++;else{var ra=qa.data[db].length;Aa+=ra;"undefined"===typeof la?la=0:1<ra&&(Ha+=Math.abs(ra-la),la=ra)}0<qa.data.length&&(Aa/=qa.data.length-na);if(("undefined"===typeof Ia||Ha>Ia)&&1.99<Aa){var Ia=Ha;var Fa=za}}(Ia=J.delimiter=Fa)?J.delimiter=Ia:(Q=!0,J.delimiter=w.DefaultDelimiter);
Z.meta.delimiter=J.delimiter}Fa=r(J);J.preview&&J.header&&Fa.preview++;aa=V;T=new p(Fa);Z=T.parse(aa,fa,oa);u();return da?{meta:{paused:!0}}:Z||{meta:{paused:!1}}};this.paused=function(){return da};this.pause=function(){da=!0;T.abort();aa=aa.substr(T.getCharIndex())};this.resume=function(){X.streamer._halted?(da=!1,X.streamer.parseChunk(aa,!0)):setTimeout(this.resume,3)};this.aborted=function(){return D};this.abort=function(){D=!0;T.abort();Z.meta.aborted=!0;v(J.complete)&&J.complete(Z);aa=""}}function m(J){return J.replace(/[.*+?^${}()|[\]\\]/g,
"\\$&")}function p(J){J=J||{};var K=J.delimiter,u=J.newline,F=J.comments,I=J.step,B=J.preview,U=J.fastMode,P,X=P=void 0===J.quoteChar?'"':J.quoteChar;void 0!==J.escapeChar&&(X=J.escapeChar);if("string"!==typeof K||-1<w.BAD_DELIMITERS.indexOf(K))K=",";if(F===K)throw Error("Comment character same as delimiter");if(!0===F)F="#";else if("string"!==typeof F||-1<w.BAD_DELIMITERS.indexOf(F))F=!1;"\n"!==u&&"\r"!==u&&"\r\n"!==u&&(u="\n");var S=0,O=!1;this.parse=function(aa,T,da){function D(ra){Ga.push(ra);
Ha=S}function Q(ra){var Ia=0;-1!==ra&&(ra=aa.substring(qa+1,ra))&&""===ra.trim()&&(Ia=ra.length);return Ia}function R(ra){if(da)return sa();"undefined"===typeof ra&&(ra=aa.substr(S));za.push(ra);S=fa;D(za);ja&&V();return sa()}function Z(ra){S=ra;D(za);za=[];na=aa.indexOf(u,S)}function sa(ra,Ia){return{data:Ia?Ga[0]:Ga,errors:ka,meta:{delimiter:K,linebreak:u,aborted:O,truncated:!!ra,cursor:Ha+(T||0)}}}function V(){I(sa(void 0,!0));Ga=[];ka=[]}if("string"!==typeof aa)throw Error("Input must be a string");
var fa=aa.length,oa=K.length,ha=u.length,ia=F.length,ja=v(I);S=0;var Ga=[],ka=[],za=[],Ha=0;if(!aa)return sa();if(U||!1!==U&&-1===aa.indexOf(P)){oa=aa.split(u);for(ha=0;ha<oa.length;ha++){za=oa[ha];S+=za.length;if(ha!==oa.length-1)S+=u.length;else if(da)break;if(!F||za.substr(0,ia)!==F){if(ja){if(Ga=[],D(za.split(K)),V(),O)break}else D(za.split(K));if(B&&ha>=B)return Ga=Ga.slice(0,B),sa(!0)}}return sa()}for(var Aa=aa.indexOf(K,S),na=aa.indexOf(u,S),la=new RegExp(m(X)+m(P),"g"),qa;;)if(aa[S]===P)for(qa=
S,S++;;){qa=aa.indexOf(P,qa+1);if(-1===qa)return da||ka.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:Ga.length,index:S}),R();if(qa===fa-1)return ia=aa.substring(S,qa).replace(la,P),R(ia);if(P===X&&aa[qa+1]===X)qa++;else if(P===X||0===qa||aa[qa-1]!==X){var db=Q(-1===na?Aa:Math.min(Aa,na));if(aa[qa+1+db]===K){za.push(aa.substring(S,qa).replace(la,P));S=qa+1+db+oa;Aa=aa.indexOf(K,S);na=aa.indexOf(u,S);break}db=Q(na);if(aa.substr(qa+1+db,ha)===u){za.push(aa.substring(S,
qa).replace(la,P));Z(qa+1+db+ha);Aa=aa.indexOf(K,S);if(ja&&(V(),O))return sa();if(B&&Ga.length>=B)return sa(!0);break}ka.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:Ga.length,index:S});qa++}}else if(F&&0===za.length&&aa.substr(S,ia)===F){if(-1===na)return sa();S=na+ha;na=aa.indexOf(u,S);Aa=aa.indexOf(K,S)}else if(-1!==Aa&&(Aa<na||-1===na))za.push(aa.substring(S,Aa)),S=Aa+oa,Aa=aa.indexOf(K,S);else if(-1!==na){za.push(aa.substring(S,na));Z(na+
ha);if(ja&&(V(),O))return sa();if(B&&Ga.length>=B)return sa(!0)}else break;return R()};this.abort=function(){O=!0};this.getCharIndex=function(){return S}}function k(J){var K=J.data;J=N[K.workerId];var u=!1;if(K.error)J.userError(K.error,K.file);else if(K.results&&K.results.data){var F={abort:function(){u=!0;z(K.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:G,resume:G};if(v(J.userStep)){for(var I=0;I<K.results.data.length&&(J.userStep({data:K.results.data[I],errors:K.results.errors,meta:K.results.meta},
F),!u);I++);delete K.results}else v(J.userChunk)&&(J.userChunk(K.results,F,K.file),delete K.results)}K.finished&&!u&&z(K.workerId,K.results)}function z(J,K){var u=N[J];v(u.userComplete)&&u.userComplete(K);u.terminate();delete N[J]}function G(){throw Error("Not implemented.");}function y(J){J=J.data;"undefined"===typeof w.WORKER_ID&&J&&(w.WORKER_ID=J.workerId);"string"===typeof J.input?l.postMessage({workerId:w.WORKER_ID,results:w.parse(J.input,J.config),finished:!0}):(l.File&&J.input instanceof File||
J.input instanceof Object)&&(J=w.parse(J.input,J.config))&&l.postMessage({workerId:w.WORKER_ID,results:J,finished:!0})}function r(J){if("object"!==typeof J||null===J)return J;var K=Array.isArray(J)?[]:{},u;for(u in J)K[u]=r(J[u]);return K}function g(J,K){return function(){J.apply(K,arguments)}}function v(J){return"function"===typeof J}var l="undefined"!==typeof self?self:"undefined"!==typeof window?window:"undefined"!==typeof l?l:{},e=!l.document&&!!l.postMessage,C=e&&/blob:/i.test((l.location||{}).protocol),
N={},A=0,w={parse:function(J,K){K=K||{};var u=K.dynamicTyping||!1;v(u)&&(K.dynamicTypingFunction=u,u={});K.dynamicTyping=u;K.transform=v(K.transform)?K.transform:!1;if(K.worker&&w.WORKERS_SUPPORTED){if(w.WORKERS_SUPPORTED){u=l.URL||l.webkitURL||null;var F=moduleFactory.toString();u=w.BLOB_URL||(w.BLOB_URL=u.createObjectURL(new Blob(["(",F,")();"],{type:"text/javascript"})));u=new l.Worker(u);u.onmessage=k;u.id=A++;N[u.id]=u}else u=!1;u.userStep=K.step;u.userChunk=K.chunk;u.userComplete=K.complete;
u.userError=K.error;K.step=v(K.step);K.chunk=v(K.chunk);K.complete=v(K.complete);K.error=v(K.error);delete K.worker;u.postMessage({input:J,config:K,workerId:u.id})}else{u=null;if(J===w.NODE_STREAM_INPUT&&"undefined"===typeof PAPA_BROWSER_CONTEXT)return u=new h(K),u.getStream();if("string"===typeof J)u=K.download?new c(K):new t(K);else if(!0===J.readable&&v(J.read)&&v(J.on))u=new q(K);else if(l.File&&J instanceof File||J instanceof Object)u=new n(K);return u.stream(J)}},unparse:function(J,K){function u(D){if("object"!==
typeof D)return[];var Q=[],R;for(R in D)Q.push(R);return Q}function F(D,Q,R){var Z="";"string"===typeof D&&(D=JSON.parse(D));"string"===typeof Q&&(Q=JSON.parse(Q));var sa=Array.isArray(D)&&0<D.length,V=!Array.isArray(Q[0]);if(sa&&U){for(var fa=0;fa<D.length;fa++)0<fa&&(Z+=P),Z+=I(D[fa],fa);0<Q.length&&(Z+=X)}for(fa=0;fa<Q.length;fa++){var oa=sa?D.length:Q[fa].length,ha=!1,ia=sa?0===Object.keys(Q[fa]).length:0===Q[fa].length;R&&!sa&&(ha="greedy"===R?""===Q[fa].join("").trim():1===Q[fa].length&&0===
Q[fa][0].length);if("greedy"===R&&sa){ha=[];for(var ja=0;ja<oa;ja++)ha.push(Q[fa][V?D[ja]:ja]);ha=""===ha.join("").trim()}if(!ha){for(ha=0;ha<oa;ha++)0<ha&&!ia&&(Z+=P),Z+=I(Q[fa][sa&&V?D[ha]:ha],ha);fa<Q.length-1&&(!R||0<oa&&!ia)&&(Z+=X)}}return Z}function I(D,Q){if("undefined"===typeof D||null===D)return"";if(D.constructor===Date)return JSON.stringify(D).slice(1,25);D=D.toString().replace(da,O);var R;if(!(R="boolean"===typeof B&&B||Array.isArray(B)&&B[Q]))a:{R=D;for(var Z=w.BAD_DELIMITERS,sa=0;sa<
Z.length;sa++)if(-1<R.indexOf(Z[sa])){R=!0;break a}R=!1}return R||-1<D.indexOf(P)||" "===D.charAt(0)||" "===D.charAt(D.length-1)?S+D+S:D}var B=!1,U=!0,P=",",X="\r\n",S='"',O=S+S,aa=!1,T=null;(function(){if("object"===typeof K){"string"!==typeof K.delimiter||w.BAD_DELIMITERS.filter(function(D){return-1!==K.delimiter.indexOf(D)}).length||(P=K.delimiter);if("boolean"===typeof K.quotes||Array.isArray(K.quotes))B=K.quotes;if("boolean"===typeof K.skipEmptyLines||"string"===typeof K.skipEmptyLines)aa=K.skipEmptyLines;
"string"===typeof K.newline&&(X=K.newline);"string"===typeof K.quoteChar&&(S=K.quoteChar);"boolean"===typeof K.header&&(U=K.header);if(Array.isArray(K.columns)){if(0===K.columns.length)throw Error("Option columns is empty");T=K.columns}void 0!==K.escapeChar&&(O=K.escapeChar+S)}})();var da=new RegExp(m(S),"g");"string"===typeof J&&(J=JSON.parse(J));if(Array.isArray(J)){if(!J.length||Array.isArray(J[0]))return F(null,J,aa);if("object"===typeof J[0])return F(T||u(J[0]),J,aa)}else if("object"===typeof J)return"string"===
typeof J.data&&(J.data=JSON.parse(J.data)),Array.isArray(J.data)&&(J.fields||(J.fields=J.meta&&J.meta.fields),J.fields||(J.fields=Array.isArray(J.data[0])?J.fields:u(J.data[0])),Array.isArray(J.data[0])||"object"===typeof J.data[0]||(J.data=[J.data])),F(J.fields||[],J.data||[],aa);throw Error("Unable to serialize unrecognized input");}};w.RECORD_SEP=String.fromCharCode(30);w.UNIT_SEP=String.fromCharCode(31);w.BYTE_ORDER_MARK="\ufeff";w.BAD_DELIMITERS=["\r","\n",'"',w.BYTE_ORDER_MARK];w.WORKERS_SUPPORTED=
!e&&!!l.Worker;w.NODE_STREAM_INPUT=1;w.LocalChunkSize=10485760;w.RemoteChunkSize=5242880;w.DefaultDelimiter=",";w.Parser=p;w.ParserHandle=b;w.NetworkStreamer=c;w.FileStreamer=n;w.StringStreamer=t;w.ReadableStreamStreamer=q;"undefined"===typeof PAPA_BROWSER_CONTEXT&&(w.DuplexStreamStreamer=h);if(l.jQuery){var f=l.jQuery;f.fn.parse=function(J){function K(){if(0===B.length)v(J.complete)&&J.complete();else{var U=B[0];if(v(J.before)){var P=J.before(U.file,U.inputElem);if("object"===typeof P){if("abort"===
P.action){u("AbortError",U.file,U.inputElem,P.reason);return}if("skip"===P.action){F();return}"object"===typeof P.config&&(U.instanceConfig=f.extend(U.instanceConfig,P.config))}else if("skip"===P){F();return}}var X=U.instanceConfig.complete;U.instanceConfig.complete=function(S){v(X)&&X(S,U.file,U.inputElem);F()};w.parse(U.file,U.instanceConfig)}}function u(U,P,X,S){v(J.error)&&J.error({name:U},P,X,S)}function F(){B.splice(0,1);K()}var I=J.config||{},B=[];this.each(function(U){if("INPUT"!==f(this).prop("tagName").toUpperCase()||
"file"!==f(this).attr("type").toLowerCase()||!l.FileReader||!this.files||0===this.files.length)return!0;for(U=0;U<this.files.length;U++)B.push({file:this.files[U],inputElem:this,instanceConfig:f.extend({},I)})});K();return this}}C&&(l.onmessage=y);c.prototype=Object.create(d.prototype);c.prototype.constructor=c;n.prototype=Object.create(d.prototype);n.prototype.constructor=n;t.prototype=Object.create(t.prototype);t.prototype.constructor=t;q.prototype=Object.create(d.prototype);q.prototype.constructor=
q;"undefined"===typeof PAPA_BROWSER_CONTEXT&&(h.prototype=Object.create(d.prototype),h.prototype.constructor=h);return w});
function parseHtml(a,d,c,n,t,q,h,b,m){function p(l){var e=0,C=0;l.split(/(\s*>\s*)|(\s+)/).forEach(function(F){if(""!=F&&"undefined"!=typeof F)if(F=F.trim(),""==F)C++;else if(">"==F)C++;else if(F=z(F),F.tags&&F.tags[0]||F.child&&F.child[0]||F.ids&&F.ids[0]||F.classes&&F.classes[0]||F.attrs&&F.attrs[0]&&F.attrs[0][0])e++,C++});if(!e)return!1;var N="^.*?",A=0,w=0,f="",J=0,K=0,u=[];l.split(/(\s*>\s*)|(\s+)/).forEach(function(F){if(!(A>e)&&""!=F&&"undefined"!=typeof F)if(F=F.trim(),""==F)w++,1<w&&(N+=
".*?");else if(">"==F)w++,1<w&&(N+="(?:(?!\\<[a-zA-Z][a-zA-Z0-9]*(?:[\\s\\/][^\\>]*)?\\>).)*",K=1);else{var I=z(F);if(I.tags&&I.tags[0]||I.child&&I.child[0]||I.ids&&I.ids[0]||I.classes&&I.classes[0]||I.attrs&&I.attrs[0]&&I.attrs[0][0]){A++;w++;if(A==e){var B=1;f=F}else B=0;J++;F=B?"":"(";K&&(I.child&&1<I.child[0]||(u[J]=1));var U=K=0;if(I.tags&&I.tags[0])if(I.child&&I.child[0]){I.child[0]-=0;for(var P=I.child[0]-1,X=0;X<I.child[0];X++)U=1,F=X?B&&P==X?F+(".*?(\\<"+I.tags[0]):F+(".*?\\<"+I.tags[0]):
B&&P==X?F+("(\\<"+I.tags[0]):F+("\\<"+I.tags[0]),F+="(?=[\\s\\>\\/])",F=k(I,F)}else F+="\\<"+I.tags[0],F=k(I,F+"(?=[\\s\\>\\/])");else if(I.child&&I.child[0])for(I.child[0]-=0,P=I.child[0]-1,X=0;X<I.child[0];X++)U=1,F=X?B&&P==X?F+".*?(\\<[a-zA-Z][a-zA-Z0-9]*":F+".*?\\<[a-zA-Z][a-zA-Z0-9]*":B&&P==X?F+"(\\<[a-zA-Z][a-zA-Z0-9]*":F+"\\<[a-zA-Z][a-zA-Z0-9]*",F+="(?=[\\s\\>\\/])",F=k(I,F);else F=k(I,F+"\\<[a-zA-Z][a-zA-Z0-9]*(?=[\\s\\>\\/])");F+="(?:[\\s\\/][^\\>]*)?\\>";N=B?U?N+(F+".*)"+Array(J).join(")")+
"$"):N+("("+F+".*)"+Array(J).join(")")+"$"):N+F}}});return{regexp:N,selector:f,selectorsnum:J,directchilds:u,fullselector:l}}function k(l,e){l.ids&&l.ids[0]&&(e+="(?=(?:[^\\<\\>]*)? id\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])"+l.ids[0]+")|(?:\\'"+l.ids[0]+"\\')|(?:\\\""+l.ids[0]+'\\"))[\\s\\>\\/])');if(l.classes&&l.classes[0])for(var C in l.classes)e+="(?=(?:[^\\<\\>]*)? class\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])"+l.classes[C]+")|(?:\\'\\s*(?:(?:[^\\'\\>\\<]* "+l.classes[C]+" [^\\'\\>\\<]*)|(?:"+l.classes[C]+" [^\\'\\>\\<]*)|(?:[^\\'\\>\\<]* "+
l.classes[C]+")|(?:"+l.classes[C]+'))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<]* '+l.classes[C]+' [^\\"\\>\\<]*)|(?:'+l.classes[C]+' [^\\"\\>\\<]*)|(?:[^\\"\\>\\<]* '+l.classes[C]+")|(?:"+l.classes[C]+'))\\s*\\"))[\\s\\>\\/])';if(l.attrs&&l.attrs[0]&&l.attrs[0][0])for(C in l.attrs)e=l.attrs[C][1]?"*"==l.attrs[C][2]?e+("(?=(?:[^\\<\\>]*)? "+l.attrs[C][0]+"\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])[^\\s\\>\\<]*"+l.attrs[C][1]+"[^\\s\\>\\<]*)|(?:\\'[^\\'\\>\\<]*"+l.attrs[C][1]+"[^\\'\\>\\<]*\\')|(?:\\\"[^\\\"\\>\\<]*"+
l.attrs[C][1]+'[^\\"\\>\\<]*\\"))[\\s\\>\\/])'):"^"==l.attrs[C][2]?e+("(?=(?:[^\\<\\>]*)? "+l.attrs[C][0]+"\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])"+l.attrs[C][1]+"[^\\s\\>\\<]*)|(?:\\'"+l.attrs[C][1]+"[^\\'\\>\\<]*s*\\')|(?:\\\""+l.attrs[C][1]+'[^\\"\\>\\<]*s*\\"))[\\s\\>\\/])'):"$"==l.attrs[C][2]?e+("(?=(?:[^\\<\\>]*)? "+l.attrs[C][0]+"\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])[^\\s\\>\\<]*"+l.attrs[C][1]+")|(?:\\'s*[^\\'\\>\\<]*"+l.attrs[C][1]+'\\\')|(?:\\"s*[^\\"\\>\\<]*'+l.attrs[C][1]+'\\"))[\\s\\>\\/])'):"|"==
l.attrs[C][2]?e+("(?=(?:[^\\<\\>]*)? "+l.attrs[C][0]+"\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])"+l.attrs[C][1]+"(?:[\\-][^\\s\\>\\<]*)?)|(?:\\'"+l.attrs[C][1]+"(?:[\\-][^\\'\\>\\<]*)?\\')|(?:\\\""+l.attrs[C][1]+'(?:[\\-][^\\"\\>\\<]*)?\\"))[\\s\\>\\/])'):"~"==l.attrs[C][2]?e+("(?=(?:[^\\<\\>]*)? "+l.attrs[C][0]+"\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])"+l.attrs[C][1]+")|(?:\\'\\s*(?:(?:[^\\'\\>\\<]* "+l.attrs[C][1]+" [^\\'\\>\\<]*)|(?:"+l.attrs[C][1]+" [^\\'\\>\\<]*)|(?:[^\\'\\>\\<]* "+l.attrs[C][1]+")|(?:"+l.attrs[C][1]+
'))\\s*\\\')|(?:\\"\\s*(?:(?:[^\\"\\>\\<]* '+l.attrs[C][1]+' [^\\"\\>\\<]*)|(?:'+l.attrs[C][1]+' [^\\"\\>\\<]*)|(?:[^\\"\\>\\<]* '+l.attrs[C][1]+")|(?:"+l.attrs[C][1]+'))\\s*\\"))[\\s\\>\\/])'):e+("(?=(?:[^\\<\\>]*)? "+l.attrs[C][0]+"\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])"+l.attrs[C][1]+")|(?:\\'"+l.attrs[C][1]+"\\')|(?:\\\""+l.attrs[C][1]+'\\"))[\\s\\>\\/])'):e+("(?=(?:[^\\<\\>]*)? "+l.attrs[C][0]+"(?:\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])[^\\s\\>\\<]+)|(?:\\'\\s*[^\\'\\s\\>\\<]+[^\\'\\>\\<]*\\s*\\')|(?:\\\"\\s*[^\\\"\\s\\>\\<]+[^\\\"\\>\\<]*\\s*\\\")))?[\\s\\>\\/])");
return e}function z(l){var e={tags:[],classes:[],ids:[],child:[],attrs:[]};l.split(/(?=\.[^\[\]]+(?:$|\[))|(?=#[^\[\]]+(?:$|\[))|(?=:[^\[\]]+(?:$|\[))|(?=\[)/).forEach(function(C){switch(C[0]){case "#":e.ids.push(C.slice(1));break;case ".":e.classes.push(C.slice(1));break;case ":":e.child.push(C.slice(11,-1));break;case "[":e.attrs.push(C.slice(1,-1).split(/\s*=\s*/,2));C=e.attrs.length-1;2==e.attrs[C].length&&(e.attrs[C][1]=e.attrs[C][1].replace(/^['"]*(.*?)['"]*$/,"$1"));var N=e.attrs[C][0].match(/^(.*)([~\^\$\*\|])$/);
N&&N[2]&&(e.attrs[C][0]=N[1],e.attrs[C][2]=N[2]);break;default:e.tags.push(C)}});return e}var G=function(){var l=/^([\S\s]+?)\.\.\.([\S\s]+)/,e=/[-[\]{}()*+?.\\^$|,]/g;return function(C,N){var A=l.exec(N);if(!A)throw Error("format must include start and end tokens separated by '...'");if(A[1]==A[2])throw Error("start and end format tokens cannot be identical");var w=A[1];A=A[2];A=new RegExp(5==N.length?"["+(w+A).replace(e,"\\$&")+"]":w.replace(e,"\\$&")+"|"+A.replace(e,"\\$&"),"ig");var f=[],J,K,
u=0;do for(J=0;K=A.exec(C);)if(K[0].toLowerCase()==w.toLowerCase()){if(!J)var F=A.lastIndex;if(!u){var I=A.lastIndex;u=1}J++}else if(J&&(J--,!J)){f.push(C.slice(I,K.index));break}while(J&&(A.lastIndex=F));u&&!f.length&&f.push(C.slice(I));return f}}();"undefined"==typeof d&&(d="");if("string"!=typeof a)return{errors:"Html is not string"+(b?", fieldName:"+b:""),result:!1};if("string"!=typeof d)return{errors:"parameter field_value_selector is not string"+(b?", fieldName:"+b:""),result:!1};m&&(a=a.replace(/\r/g,
" "),a=a.replace(/\n/g," "),a=a.replace(/\t/g," "),a=a.replace(/(<!\-\-.*?\-\->)/g,""),a=a.replace(/(<script.*?<\/script>)/igm,"<script>\x3c/script>"),a=a.replace(/(<noscript.*?<\/noscript>)/igm,"<noscript></noscript>"),a=a.replace(/(<link .*?>)/igm,"<link>"),a=a.replace(/(<style.*?<\/style>)/igm,"<style></style>"));a=a.trim();if(""==a)return{errors:"",html:"",result:""};var y=a.length,r=!1,g="";""!==d?d.split(/\s*,\s*/).forEach(function(l){var e=p(l);e||(g=b?g+("Error in selector: "+l+" fieldName:"+
b+"\n"):g+("Error in selector: "+l+"\n"));if(!g&&!r){l=new RegExp(e.regexp,"i");var C=null;try{C=a.match(l)}catch(K){}if(C&&C[e.selectorsnum]){for(var N=1,A=1;A<e.selectorsnum;A++)if(!e.directchilds[A+1]){l="^\\<([a-zA-Z][a-zA-Z0-9]*)[\\s\\<\\>\\/].*$";var w=C[A].replace(new RegExp(l,"i"),"$1");if(w==C[A]){g=b?g+("Error in selector reqexp for fieldName:"+b+"\n"):g+"Error in selector reqexp\n";N=0;break}var f=G(C[A],"<"+w+"...</"+w+">");if(!f.length){g=b?g+("Error in function matchRecursive for fieldName:"+
b+"\n"):g+"Error in function matchRecursive\n";N=0;break}f=f[0];l="^([^\\>]*\\>)(.*?)$";var J=f.match(new RegExp(l,"i"));if(!J||!J[1]){g=b?g+('Error: not found end tag symbol ">" for fieldName:'+b+"\n"):g+!0;N=0;break}f=J[2];l=RegExp("^(?:area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$","i");l.test(w)&&(l="^((?:(?:\\<area)|(?:\\<base)|(?:\\<basefont)|(?:\\<br)|(?:\\<col)|(?:\\<frame)|(?:\\<hr)|(?:\\<img)|(?:\\<input)|(?:\\<isindex)|(?:\\<link)|(?:\\<meta)|(?:\\<param)|(?:[^\\<]+))*).*?$",
f=f.replace(new RegExp(l,"i"),"$1"));f="<"+w+J[1]+f;if(y-C[A+1].length>y-C[A].length+f.length){N=0;break}}N&&(r=e,r.html=C[e.selectorsnum].trim())}}}):(r={},r.fullselector=d,r.html=a);if(g)return{errors:g,result:!1};if(!r)return{errors:"",html:"",result:""};if(!r.html)return r.result="",r.errors="",r;if("text"==c){d=r.html.replace(RegExp("^\\<([a-zA-Z][a-zA-Z0-9]*)[\\s\\<\\>\\/].*$","i"),"$1");if(d==r.html)return g=b?"Error in selector reqexp for fieldName:"+b+"\n":"Error in selector reqexp\n",r.result=
!1,r.errors=g,r;m=G(r.html,"<"+d+"...</"+d+">");if(!m.length)return g=b?"Error in function matchRecursive for fieldName:"+b+"\n":"Error in function matchRecursive\n",r.result=!1,r.errors=g,r;m=m[0];m=m.replace(RegExp("^[^\\>]*\\>(.*?)$","i"),"$1");if(m==r.html)return g=b?'Error: not found end tag symbol ">" for fieldName:'+b+"\n":!0,r.result=!1,r.errors=g,r;var v=RegExp("^(?:area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$","i");v.test(d)&&(v="^((?:(?:\\<area)|(?:\\<base)|(?:\\<basefont)|(?:\\<br)|(?:\\<col)|(?:\\<frame)|(?:\\<hr)|(?:\\<img)|(?:\\<input)|(?:\\<isindex)|(?:\\<link)|(?:\\<meta)|(?:\\<param)|(?:[^\\<]+))*).*?$",
m=m.replace(new RegExp(v,"i"),"$1"));r[c]=m.trim();if(""==r[c])return r.result="",r.errors="",r;r.result=r[c]}else if(c){v="^\\<[^\\<\\>]+ "+c+"(?:\\s*=\\s*(?:(?:(?=[^\\s\\'\\\"])([^\\s\\>\\<]+))|(?:\\'\\s*([^\\'\\s\\>\\<]+[^\\'\\>\\<]*)\\s*\\')|(?:\\\"\\s*([^\\\"\\s\\>\\<]+[^\\\"\\>\\<]*)\\s*\\\")))?[\\s\\>\\/].*$";d=r.html.replace(new RegExp(v,"i"),"$1$2$3");if(d==r.html)return r.result="",r.errors="",r;r[c]=d.trim();if(""==r[c])return r.result="",r.errors="",r;r.result=r[c]}else r.result=r.html;
if(n){c="";if("object"==typeof n){if(n.length)if("string"!=typeof n[0]||"string"!=typeof n[1]&&"function"!=typeof n[1]||"undefined"!=typeof n[2]&&"string"!=typeof n[1])c="bad parameter field_replace, selector="+r.fullselector;else try{v=n[2]?new RegExp(n[0],n[2]):new RegExp(n[0]);if(v.test(r.result))r.field_replace=r.result.replace(v,n[1]),r.field_replace=r.field_replace.trim();else return r.field_replace="",r.result="",r.errors="",r;r.result=r.field_replace}catch(l){c="bad parameter field_replace:"+
l.message+" , selector="+r.fullselector}}else c="bad parameter field_replace, selector="+r.fullselector;if(c)return r.result=!1,r.errors=c+(b?", fieldName:"+b:""),r}if(t){c="";if("function"==typeof t)try{r.htmlClear=t(r.result,r.fullselector,q,b,h),"string"!=typeof r.htmlClear?c="bad return from function field_Fun, selector="+r.fullselector:(r.htmlClear=r.htmlClear.trim(),r.result=r.htmlClear)}catch(l){c="bad function field_Fun:"+l.message+" , selector="+r.fullselector}else c="parameter field_Fun is not function, selector="+
r.fullselector;c&&(r.result=!1,r.errors=c+(b?", fieldName:"+b:""))}return r}
function parseHtmlFUN(a,d,c,n,t,q,h){"undefined"==typeof d&&(d="");if("string"!=typeof a)return{errors:"Html is not string"+(h?", fieldName:"+h:""),result:!1};if("string"!=typeof d)return{errors:"parameter field_value_selector is not string"+(h?", fieldName:"+h:""),result:!1};selector={};selector.fullselector=d;selector.result=a;selector.html=a;if(!selector.html)return selector.result="",selector.errors="",selector;if(c){a="";if("object"==typeof c){if(c.length)if("string"!=typeof c[0]||"string"!=
typeof c[1]&&"function"!=typeof c[1]||"undefined"!=typeof c[2]&&"string"!=typeof c[1])a="bad parameter field_replace, selector="+selector.fullselector;else try{var b=c[2]?new RegExp(c[0],c[2]):new RegExp(c[0]);if(b.test(selector.result))selector.field_replace=selector.result.replace(b,c[1]),selector.field_replace=selector.field_replace.trim();else return selector.field_replace="",selector.result="",selector.errors="",selector;selector.result=selector.field_replace}catch(m){a="bad parameter field_replace:"+
m.message+" , selector="+selector.fullselector}}else a="bad parameter field_replace, selector="+selector.fullselector;if(a)return selector.result=!1,selector.errors=a+(h?", fieldName:"+h:""),selector}if(n){a="";if("function"==typeof n)try{selector.htmlClear=n(selector.result,selector.fullselector,t,h,q),"string"!=typeof selector.htmlClear?a="bad return from function field_Fun, selector="+selector.fullselector:(selector.htmlClear=selector.htmlClear.trim(),selector.result=selector.htmlClear)}catch(m){a=
"bad function field_Fun:"+m.message+" , selector="+selector.fullselector}else a="parameter field_Fun is not function, selector="+selector.fullselector;a&&(selector.result=!1,selector.errors=a+(h?", fieldName:"+h:""))}return selector}
function ItemHeaders(a,d,c,n,t,q,h,b,m,p,k,z,G,y,r,g,v,l,e){function C(da,D,Q,R,Z,sa){R=Number(R);if(3>R)return da;e?(R=Q.replace(/\{[^\{:]+:([^\}\{]*)\}/gm,"$1"),R=R.replace(/\{[^\{]+\}/gm,"{ERROR!!!}")):(da=String(J.length),R=da+Array(R+1-da.length).join("\u00bf"),J[da]=Q,K[R]=Q);return D+R}function N(da,D,Q,R,Z,sa){return/\d/.test(Q)||/[^\s]\s+[^\s]/.test(Q)?D+" "+R:D+" "+Q+" "+R}function A(da,D){function Q(Z,sa,V,fa,oa,ha,ia){"string"==typeof V?(Z=oa.toLowerCase().replace(/^(["'\(]*\s*[^"'\(\s]).*$/,
"$1").toUpperCase(),oa=Z+oa.toLowerCase().replace(/^["'\(]*\s*[^"'\(\s](.*)$/,"$1")):1==oa.length?oa=oa.toLowerCase():(Z=oa.toLowerCase().replace(/^(["'\(]*\s*[^"'\(\s]).*$/,"$1").toUpperCase(),oa=Z+oa.toLowerCase().replace(/^["'\(]*\s*[^"'\(\s](.*)$/,"$1"));return sa+oa}function R(Z,sa,V,fa,oa,ha,ia){Z="string"==typeof V?oa.toLowerCase().replace(/^(["'\(]*\s*[^"'\(\s]).*$/,"$1").toUpperCase()+oa.toLowerCase().replace(/^["'\(]*\s*[^"'\(\s](.*)$/,"$1"):oa.toLowerCase();return sa+Z}D&&("Keyword"==D?
da&&(da=da.replace(/(((?:^\s*)|(?:\.\s*)|(?:!\s*)|(?:\|\s*))|([,\s]+))(["'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:["'\)\s\.!\|,])|(?:$)))/g,R)):"KeyWord"==D?da&&(da=da.replace(/(((?:^\s*)|(?:\.\s*)|(?:!\s*)|(?:\|\s*))|([,\s]+))(["'\(]*\s*[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=(?:(?:["'\)\s\.!\|,])|(?:$)))/g,Q)):"keyword"==D?da&&(da=da.toLowerCase()):"KEYWORD"==D&&da&&(da=da.toUpperCase()));return da}function w(da,D,Q,R,Z){R=Q.length;if(3>R)return da;da=String(J.length);R=da+Array(R+1-
da.length).join("\u00bf");J[da]=Q;K[R]=Q;return D+R}function f(da,D,Q,R,Z){Q=K[Q]?K[Q].toLowerCase():Q.toLowerCase();return d[Q]?da:D}if(a&&n&&t&&"string"===typeof a&&"string"===typeof n&&"string"===typeof t&&(!c||"string"===typeof c)&&(!l||k)){G||(G=0);var J=[],K={};a=a.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,C);n=n.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,C);h=h.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,C);b=b.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,C);p=p.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,
C);k=k.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,C);z=z.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,C);a=a.replace(/^([^\(]*)\(([^\)]*)\)(.*)$/,N);a=a.replace(/\(([^\)]*)\)/g," ");a=a.replace(/[\(\)]+/g,"");var u=a.split(/[,\.\|](?![^\s\-_\\\/\d]*[\-_\\\/\d])/);if(1<u.length&&u[0].length&&u[1].length&&10<=u[0].length+u[1].length){var F=u[0].length/u[1].length,I=10/13;a=F<=1/I&&F>=I?/[\d]/.test(u[0])?/[\d]/.test(u[1])?/^\s*[^\s\d]+\s[^\s]+/.test(u[0])&&/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(u[1])?
u[0]:u[0].length>u[1].length?u[0]:u[1]:u[0]:/[\d]/.test(u[1])?u[1]:u[0].length>u[1].length?u[0]:u[1]:/[\d]/.test(u[0])&&/^\s*[^\s\d]+\s[^\s]+/.test(u[0])&&/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(u[1])?u[0]:u[0].length>u[1].length?u[0]:u[1]}a=a.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'\(\)%]+/g," ");a=a.replace(/['"]+/g,"");a=a.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,"");a=a.replace(/([!\|\.,;])(?:\s*[!\|\.,;]+)+/g,"$1");a=a.replace(/([\|])(?:\s*[\|]+)+/g,"$1");a=a.replace(/\s+/g,
" ");a=a.trim();if(!/^\s*$/.test(a)){a=a.replace(/([\u00C0-\u1FFF\u2C00-\uD7FF\wa-z]\s*[\.!,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig,"$1 $2");a=a.replace(/^[\s\.,!]+/,"");a=A(a,q);a=a.replace(/(^|\s)([\d\.,]*\d\s[\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=\s|$)/g,w);l=[];var B=2,U=0,P=[],X=0,S=[],O=0;g&&(B=1);var aa=[],T=[];F=a.split(/\s+/);for(I=0;I<F.length;I++)if(u=K[F[I]]?K[F[I]]:F[I],U)if(30>=F[I].length)if(30>=F[I].length+1+U)l[l.length-1]+=" "+u,aa[aa.length-1]+=" "+F[I],U+=F[I].length+1;else{if(l.length>=
B)break;l[l.length]=u;aa[aa.length]=F[I];U=F[I].length}else{if(l.length>=B)break;break}else if(30>=F[I].length)l[l.length]=u,aa[aa.length]=F[I],U=F[I].length;else{if(l.length>=B)break;return}if(l.length){if((u=aa[aa.length-1].match(/^(.*?)\s+([^\s\d_\\\.!\|]{1,3})\s*$/))&&u[1]&&u[2]&&(F=K[u[2]]?K[u[2]].toLowerCase():u[2].toLowerCase(),!(d[F]||u[2]==u[2].toUpperCase()&&1<u[2].length||(F=u[1].match(/^(.*?)\s+([^\s\d_\\\.!\|]{1,3})\s*$/),F&&F[1]&&F[2])))){B="";F=u[1].split(/\s+/);for(I=0;I<F.length;I++)u=
K[F[I]]?K[F[I]]:F[I],B&&(B+=" "),B+=u;l[l.length-1]=B}l[0]=l[0].replace(/(?:^|(?:\s+))[^\s\d\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+\s*$/,"");if(!l[0]&&1==l.length)return;for(I=1;I<l.length;I++)l[I]=l[I].replace(/(?:^|(?:\s+))[^\s\d\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+\s*$/,""),l[I]||(l.splice(I,1),I--)}r?u="":(c?(c=c.replace(/(^|\s)(\{[^\{]+\})\[(\d+)\](?=\s|$)/g,C),c=c.replace(/^([^\(]*)\(([^\)]*)\)(.*)$/,N),c=c.replace(/\(([^\)]*)\)/g," "),c=c.replace(/[\(\)]+/g,""),u=c.split(/[,\.\|](?![^\s\-_\\\/\d]*[\-_\\\/\d])/),
1<u.length&&u[0].length&&u[1].length&&10<=u[0].length+u[1].length&&(F=u[0].length/u[1].length,I=10/13,c=F<=1/I&&F>=I?/[\d]/.test(u[0])?/[\d]/.test(u[1])?/^\s*[^\s\d]+\s[^\s]+/.test(u[0])&&/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(u[1])?u[0]:u[0].length>u[1].length?u[0]:u[1]:u[0]:/[\d]/.test(u[1])?u[1]:u[0].length>u[1].length?u[0]:u[1]:/[\d]/.test(u[0])&&/^\s*[^\s\d]+\s[^\s]+/.test(u[0])&&/^\s*[^\s]*[\d][^\s]*\s[^\s]+/.test(u[1])?u[0]:u[0].length>u[1].length?u[0]:u[1]),c=c.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'\(\)%]+/g,
" "),c=c.replace(/['"]+/g,""),c=c.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,""),c=c.replace(/([!\|\.,;])(?:\s*[!\|\.,;]+)+/g,"$1"),c=c.replace(/([\|])(?:\s*[\|]+)+/g,"$1"),c=c.replace(/\s+/g," "),c=c.trim(),/^\s*$/.test(c)||(c=c.replace(/([\u00C0-\u1FFF\u2C00-\uD7FFa-z]\s*[\.!,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig,"$1 $2"),c=c.replace(/^[\s\.,!]+/,""),c=A(c,q),c=c.replace(/(^|\s)([\d\.,]*\d\s[\u00C0-\u1FFF\u2C00-\uD7FFA-Za-z]+)(?=\s|$)/g,w)),u=c):u=a,u=u.replace(/^(.*?)\s+[^\s]\s+.*$/,
"$1"));F=u.split(/\s+/);for(I=c=0;I<F.length;I++){u=K[F[I]]?K[F[I]]:F[I];if(O)if(15>=F[I].length)if(15>=F[I].length+1+O)S[S.length-1]+="_"+u,O+=F[I].length+1;else{if(2<=S.length)break;S[S.length]=u;O=F[I].length}else break;else if(15>=F[I].length)S[S.length]=u,O=F[I].length;else break;c=O?!d[u.toLowerCase()]&&5>F[I].length?/[\d\/]/.test(u)?0:F[I].length:0:0}if(c){for(I=O=0;2>I;I++)if(u=K[F[I]]?K[F[I]]:F[I])if(I)if(15<F[I].length)break;else O=!d[u.toLowerCase()]&&5>F[I].length?/[\d\/]/.test(u)?0:F[I].length:
0;else O=0;if(c&&3>=c&&O&&3>=O)S=[];else if(!O||O>c)for(S=[],I=0;2>I;I++)if(u=K[F[I]]?K[F[I]]:F[I])if(I)if(15<F[I].length)break;else!d[u.toLowerCase()]&&5>F[I].length&&/[\d\/]/.test(u),S[I]=u;else S[I]=u}for(I=0;I<S.length;I++)S[I]=S[I].replace(/[:\.,\/\\_]+/g,"_");u=O="";m&&(m=m.replace(/<[^>]>/g,""),m=m.replace(/[\d\.,][\d\.,\s]+[\d\.,]/g,function(da,D,Q){return da=da.replace(/\s+/g,"")}),m=m.toLowerCase(),(m=m.match(/([\d\.,]+)\s*([^\d\s]*(?:\s*[\.,!\|])?)/))&&m[1]?(O=m[1],u=m[2],"number"==typeof y&&
Number(O.replace(/[\s,]+/g,""))>=y&&(O=O.replace(/\..*$/,"")),m=O,u&&(u=u.replace(/[>\*<\^=~`]+/g,""),u=u.replace(/([!\.,;])(?:\s*[!\.,;]+)+/g,"$1"),u=u.replace(/([\|])(?:\s*[\|]+)+/g,"$1"),u=u.replace(/\s+(?![\.,!\|])/g,"")),u&&(m+=" "+u)):m="");m&&(m=m.replace(/\s+/g," "),m=m.trim());y="";if(m){c=y=e?String(O):"{param1:"+O+"}";r=O;if(F=u.replace(/\s*[,!\|]$/,""))r+=" "+F,c+=" "+F;u&&(y+=" "+u);F=u=0;!g&&0<G&&4>G&&(1==l.length||30>=r.length+3+l[1].length)&&(l[1]=l[1]?l[1]+(" | "+c):c,F=u=1);4==G||
1==G||2==G&&!u?F=1:u=O=b=y="";F&&(T[0]=O)}else b="";k&&(k=k.replace(/[^!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'%]+/g," "),k=k.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,""),k=k.replace(/([!\.,;])(?:\s*[!\.,;]+)+/g,"$1"),k=k.replace(/([\|])(?:\s*[\|]+)+/g,"$1"));p&&(p=p.replace(/[^!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'%]+/g," "),p=p.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,""),p=p.replace(/([!\.,;])(?:\s*[!\.,;]+)+/g,"$1"),p=p.replace(/([\|])(?:\s*[\|]+)+/g,
"$1"));b&&(b=b.replace(/[^!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'%]+/g," "),b=b.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,""),b=b.replace(/([!\.,;])(?:\s*[!\.,;]+)+/g,"$1"),b=b.replace(/([\|])(?:\s*[\|]+)+/g,"$1"));h&&(h=h.replace(/[^!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'%]+/g," "),h=h.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,""),h=h.replace(/([!\.,;])(?:\s*[!\.,;]+)+/g,"$1"),h=h.replace(/([\|])(?:\s*[\|]+)+/g,"$1"));z&&(z=z.replace(/[^!\|\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'%]+/g,
" "),z=z.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,""),z=z.replace(/([!\.,;])(?:\s*[!\.,;]+)+/g,"$1"),z=z.replace(/([\|])(?:\s*[\|]+)+/g,"$1"));k?(k=k.replace(/\s+/g," "),k=k.trim(),k=A(k,q)):null===k&&(k=a);h&&/[!]/.test(h)?(b&&(b=b.replace(/[!]/g,".")),m&&(m=m.replace(/[!]/g,".")),k&&(k=k.replace(/[!]/g,".")),z&&(z=z.replace(/[!]/g,".")),p&&(p=p.replace(/[!]/g,"."))):b&&/[!]/.test(b)?(m&&(m=m.replace(/[!]/g,".")),k&&(k=k.replace(/[!]/g,".")),z&&(z=z.replace(/[!]/g,".")),p&&(p=
p.replace(/[!]/g,"."))):m&&/[!]/.test(m)?(k&&(k=k.replace(/[!]/g,".")),z&&(z=z.replace(/[!]/g,".")),p&&(p=p.replace(/[!]/g,"."))):p&&/[!]/.test(p)?(k&&(k=k.replace(/[!]/g,".")),z&&(z=z.replace(/[!]/g,"."))):k&&/[!]/.test(k)&&z&&(z=z.replace(/[!]/g,"."));z&&(z=z.replace(/\s+/g," "),z=z.trim());z&&(z=A(z,q),k&&(/[\.,\|!]\s*$/.test(k)||(k+=".")));p&&(p=p.replace(/\s+/g," "),p=p.trim());p&&(p=A(p,q),k=k?/[\.,\|!]\s*$/.test(p)||/^\s*[\.,\|!]/.test(k)?p+" "+k:p+". "+k:/[\.,\|!]\s*$/.test(p)?p:p+".");m&&
y&&(a=Array(m.length+1).join("`"),k=k?/[\.,\|!]\s*$/.test(m)||/^\s*[\.,\|!]/.test(k)?a+" "+k:a+", "+k:a);b&&(b=b.replace(/\s+/g," "),b=b.trim());b&&(b=A(b,q),k=k?b+" "+k:b);h&&(h=h.replace(/\s+/g," "),h=h.trim());h&&(h=A(h,q),k=k?/[\.,\|!]\s*$/.test(h)||/^\s*[\.,\|!]/.test(k)?h+" "+k:h+". "+k:/[\.,\|!]\s*$/.test(h)?h:h+".");k=k.replace(/['"]+/g,"");k=k.replace(/(?:(?:^\s*)|(?:\s+))([\.,!])(?:\s*[\.,!])*(?=(?:\s+)|(?:\s*$))/g,"$1");k=k.replace(/([!\.,;])(?:\s*[!\.,;]+)+/g,"$1");k=k.replace(/([\|])(?:\s*[\|]+)+/g,
"$1");k=k.replace(/([\u00C0-\u1FFF\u2C00-\uD7FFa-z]\s*[\.!,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig,"$1 $2");k=k.replace(/^[\s\.,!]+/,"");k=A(k,q);F=k.split(/\s+/);z&&(z=z.replace(/['"]+/g,""),/[!\.,;]\s*$/.test(k)&&(z=z.replace(/^(?:\s*[!\.,;]+\s*)+/,"")),/[\|]\s*$/.test(k)&&(z=z.replace(/^(?:\s*[\|]+\s*)+/,"")),z=z.replace(/(?:(?:^\s*)|(?:\s+))([\.,!])[\.,!]*(?=(?:\s+)|(?:\s*$))/g,"$1"),z=z.replace(/([\u00C0-\u1FFF\u2C00-\uD7FFa-z]\s*[\.!,])([\u00C0-\u1FFF\u2C00-\uD7FFa-z])/ig,"$1 $2"),z=z.replace(/^[\s\.,!]+/,
""),z=A(z,q),v||(F[F.length]=z));q=z.length;if(v){if(90<q)return;q=q?q+3:0}for(I=0;I<F.length;I++)if(u=K[F[I]]?K[F[I]]:F[I],v)if(P.length)if(1==P.length)if(90>=F[I].length)if(90>=F[I].length+1+X)P[P.length-1]=y?P[P.length-1]+(" "+u.replace(/`+/g,y)):P[P.length-1]+(" "+u),X+=F[I].length+1;else{if(90<F[I].length+q)break;P[P.length]=y?u.replace(/`+/g,y):u;X=F[I].length}else break;else if(1>P.length)if(90>=F[I].length)90>=F[I].length+1+X?(P[P.length-1]=y?P[P.length-1]+(" "+u.replace(/`+/g,y)):P[P.length-
1]+(" "+u),X+=F[I].length+1):(P[P.length]=y?u.replace(/`+/g,y):u,X=F[I].length);else break;else if(90>=F[I].length+q)if(90>=F[I].length+1+X+q)P[P.length-1]=y?P[P.length-1]+(" "+u.replace(/`+/g,y)):P[P.length-1]+(" "+u),X+=F[I].length+1;else break;else break;else if(90>=F[I].length)P[P.length]=y?u.replace(/`+/g,y):u,X=F[I].length;else break;else if(X)if(90>=F[I].length)if(90>=F[I].length+1+X)P[P.length-1]=y?P[P.length-1]+(" "+u.replace(/`+/g,y)):P[P.length-1]+(" "+u),X+=F[I].length+1;else{if(2<=P.length)break;
P[P.length]=y?u.replace(/`+/g,y):u;X=F[I].length}else{if(2<=P.length)break;break}else if(90>=F[I].length)P[P.length]=y?u.replace(/`+/g,y):u,X=F[I].length;else{if(2<=P.length)break;return}P.length&&(h=P.length-1,/^(.*?)\s+[^\s\d_\\\.!\|]{1,3}\s*$/.test(P[h])&&(P[h]=P[h].replace(/^(.*?)\s+([^\s\d_\\\.!\|]{1,3})\s*$/,f)),P[h]=P[h].replace(/[\s:,\/\\_]+$/,""));v&&(u=K[z]?K[z]:z,X&&90>=X+q?(h=P.length-1,z&&!/[\.!\|]$/.test(P[h])&&(z=P[h].match("^.+[\\.\\!\\|](?=\\s|$)"),P[h]=null!==z?z[0]:P[h]+" |"),P[h]=
y?P[h]+(" "+u.replace(/`+/g,y)):P[h]+(" "+u)):P[P.length]=y?u.replace(/`+/g,y):u);if(1==l.length){z=0;n=n.replace(/^[\s\.,!]+/,"");n=n.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'\(\)%]+/g," ");n=n.replace(/(?:(?:^\s*)|(?:\s))[\+\-\.,]+(?=(?:\s)|(?:\s*$))/g,"");n=n.replace(/([!\|\.,;])(?:\s*[!\|\.,;]+)+/g,"$1");n=n.replace(/([\|])(?:\s*[\|]+)+/g,"$1");n=n.replace(/\s+/g," ");n=n.trim();if(/^\s*$/.test(n))return;v="";F=n.split(/\s+/);for(I=0;I<F.length;I++)if(u=K[F[I]]?K[F[I]]:F[I],z)if(30>=
F[I].length)if(30>=F[I].length+1+z)v+=" "+u,z+=F[I].length+1;else break;else break;else if(30>=F[I].length)v=u,z=F[I].length;else return;l[1]=v}2==l.length&&(l[2]=t);if(1==P.length){if((n=P[0].match(/^(.*)(\{[^\}\{]+\}[\s\.!]*)$/))&&n[1]&&n[2])P[0]=n[1].trim(),P[1]=n[2];else if((n=P[0].match(/^(.*[\.!])(?![ ]+[^\}\{]+\})([ ]+[^\s].*)$/))&&n[1]&&n[2])P[0]=n[1],P[1]=n[2].trim();else if((n=P[0].match(/^(.*)[,](?![ ]+[^\}\{]+\})([ ]+[^\s].*)$/))&&n[1]&&n[2])P[0]=n[1].trim(),P[1]=n[2].trim();else if((n=
P[0].match(/^(.*[^\s][^\s][^\s])(?![ ]+[^\}\{]+\})([ ]+[^\s].*)$/))&&n[1]&&n[2])P[0]=n[1],P[1]=n[2].trim();else return;if(/^\s*$/.test(P[0])||/^\s*$/.test(P[1]))return}if(!(3>l.length||2>P.length))return{Headlines:l,Descriptions:P,Paths:S,Params:T}}}}
function ItemKeys(a,d,c,n,t,q,h){function b(C,N){if(C.length){for(var A=0;A<C.length;A++)if(C[A].min>C[A].max||0>C[A].min||0>C[A].max)return;var w=C.map(function(f){return f.min});for(A=C.length;0<=A;)for(N.call(null,w.slice()),A=C.length;A--;){if(w[A]<C[A].max){++w[A];break}w[A]=C[A].min}}}function m(C,N,A,w){if(!/\d.*\d.*\d/.test(N))return C;A=N.trim();/^\d+([x\u0445]\d+)+$/i.test(A)||(r[r.length]=A);w=N.replace(/([^\s])\s+(?=[^\s])/g,"$1");return N!=w&&(A=w.trim(),A.length&&80>=A.length&&!/^\d+([x\u0445]\d+)+$/i.test(A)&&
(r[r.length]=A),/^\d+$/.test(A)||/(^|\s)[^\s](\s|$)/.test(N))?w:C}if(a&&"string"===typeof a&&!("number"!==typeof n||3>n)){if(t&&"string"===typeof t)if(t=t.trim(),t=t.split(/[\s,]+[\+]*/),t.length)for(var p={},k=/[-[\]{}()*+?.\\^$|,]/g,z=[],G=0;G<t.length;G++){var y=t[G].toLowerCase();p[y]?(t.splice(G,1),G--):(t[G]=y,z[G]=new RegExp("(?:^|\\s)"+t[G].replace(k,"\\$&")+"(?:\\s|$)","i"),p[y]=1)}else t=null;else t=null;p=a.toLowerCase();G=p.split(/[,\|](?![^\s\-_\\\/\d]*[\-_\\\/\d])/);1<G.length&&G[0].length&&
G[1].length&&10<=G[0].length+G[1].length&&(a=G[0].length/G[1].length,p=10/13,p=a<=1/p&&a>=p?/[\d]/.test(G[0])?/[\d]/.test(G[1])?G[0].length>G[1].length?G[0]:G[1]:G[0]:/[\d]/.test(G[1])?G[1]:G[0].length>G[1].length?G[0]:G[1]:G[0].length>G[1].length?G[0]:G[1]);p=p.replace(/((^\s*)|(\s))\-[^\s\+]+/g,"");if(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+./:\-\[\]'\(\)]/.test(p)&&(p=p.replace(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w#$&_ "+.,/:\-\[\]'\(\)]+/g," "),p=p.replace(/[,]+/g,"."),!/[^\s\[\]"\-\+]/.test(p)))return;
p=p.replace(/["\[\]]+/g,"");p=p.replace(/((^\s*)|(\s))[\+\-]+([^\s\+\-]+)/g,"$1$4");p=p.replace(/((^\s*)|(\s))[\+\-]+((\s)|(\s*$))/g," ");p=p.replace(/^\s*(.*?)\s*$/,"$1");p=p.replace(/\s+\.(?=\s)/g,"");if(!/^\s*$/.test(p)){var r=[],g=[],v=[];a=[];if(h&&"string"===typeof h){h=h.trim();h=h.split(/[\s,]+[\+]*/);if(h.length){k={};for(G=0;G<h.length;G++)y=h[G].toLowerCase(),k[y]||(k[y]=1);h=Object.keys(k)}else h=[];for(G=0;G<h.length;G++)a[a.length]=h[G]}var l="";p=p.replace(/(\([^\(\)]*)\([^\(\)]*\)([^\(\)]*\))/g,
"$1$2");p=p.replace(/^([^\(]*)\(([^\)]*)\)(.*)$/,function(C,N,A,w,f,J){w=w.replace(/\(([^\)]*)\)/g," ");l=w=w.replace(/[\(\)]+/g,"");w="";A=A.replace(/\(([^\)]*)\)/g," ");A=A.replace(/[\(\)]+/g,"");if(/\d.*\d.*\d.*\d.*\d/.test(A)||/(?=[^\s]*\d[^\s]*\d[^\s]*\d)[a-zA-Z0-9\.\-_\/]{7,}/.test(A))return C=A.trim(),/^\d+([x\u0445]\d+)+$/i.test(C)||(r[r.length]=C),A=C.replace(/\s+/g,""),C!=A&&A.length&&80>=A.length&&!/^\d+([x\u0445]\d+)+$/i.test(A)&&(r[r.length]=A),N+" "+w;if(/\d.*\d/.test(A))return A=A.replace(/\s+/g,
""),5<=A.length&&A.length&&80>=A.length&&!/^\d+([x\u0445]\d+)+$/i.test(A)&&(r[r.length]=A),N+" `"+A+" "+w;A=A.replace(/\s+/g,"");return N+" "+A+" "+w});p=p.replace(/[\(\)]+/g,"");p=p.replace(/((?:^|\s)(?:(?:(?=[^`\s\d]*\d+)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)*)|(?:[a-zA-Z0-9\.\-_\/]{7,}))(?=\s|$))/g,m);l.replace(/((?:^|\s)(?:(?:(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)(?:[^`\s\d]*\d+[^`\s\d]*\s*)*)|(?:[a-zA-Z0-9\.\-_\/]{7,}))(?=\s|$))/g,
m);p=p.replace(/[`]+/g,"");p=p.replace(/(?:^|(?:\s+))[^\s\d\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]+(?=\s|$)/g,"");p=p.trim();G=2;c&&(G=1);y=0;/^[^\s]+\s+[\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]{1,3}(\s+|$)/.test(p)&&(G=y=1);p=p.replace(/\s+([\u00BF-\u1FFF\u2C00-\uD7FFA-Za-z]{1,3})(?=\s+)/g,function(C,N,A,w){N=N.toLowerCase();return d[N]?C:""});p=p.replace(/\s+/g," ");if(p=p.trim()){var e=p.split(/\s+/);h=e.length;y&&(h=2,h=e.length>=h?h:e.length);p=G>=e.length?e.length:G;y=[];if(2==c||4==c)for(y.push({min:0,
max:0<p-1?0:p-1}),y.push({min:1,max:1<h-1?1:h-1}),G=2;G<n;G++)y.push({min:G,max:e.length-1>G?G:e.length-1});else for(3==c?(y.push({min:0,max:0<p-1?0:p-1}),y.push({min:1,max:1<h-1?1:h-1})):(y.push({min:0,max:p-1}),y.push({min:1,max:h-1})),G=2;G<n;G++)y.push({min:G,max:e.length-1});b(y,function(C){for(var N=e.slice(),A="",w={},f=0;f<C.length;f++){if(f&&C[f]<=C[f-1])return;N[C[f]]="";if(w[e[C[f]]])return;w[e[C[f]]]=1;A=A?A+(" "+e[C[f]]):e[C[f]]}if((4!=c||""===N.join(""))&&A&&-1==r.indexOf(A)&&-1==v.indexOf(A)&&
-1==g.indexOf(A)&&A.length&&80>=A.length)if(t){for(N=C=0;N<t.length;N++)z[N].test(A)&&(g[g.length]=A,C=1);q&&!C&&(g[g.length]=A)}else g[g.length]=A});y=[];if(2==c||4==c)for(y.push({min:0,max:0<p-1?0:p-1}),y.push({min:1,max:1<h-1?1:h-1}),G=2;G<n-1;G++)y.push({min:G,max:e.length-1>G?G:e.length-1});else for(3==c?(y.push({min:0,max:0<p-1?0:p-1}),y.push({min:1,max:1<h-1?1:h-1})):(y.push({min:0,max:p-1}),y.push({min:1,max:h-1})),G=2;G<n-1;G++)y.push({min:G,max:e.length-1});b(y,function(C){for(var N=e.slice(),
A="",w={},f=0;f<C.length;f++){if(f&&C[f]<=C[f-1])return;N[C[f]]="";if(w[e[C[f]]])return;w[e[C[f]]]=1;A=A?A+(" "+e[C[f]]):e[C[f]]}if((4!=c||""===N.join(""))&&A&&-1==r.indexOf(A)&&-1==v.indexOf(A)&&-1==g.indexOf(A)&&A.length&&80>=A.length)if(t){for(N=C=0;N<t.length;N++)z[N].test(A)?(v[v.length]=A,C=1):(w=A+" "+t[N],-1==r.indexOf(w)&&-1==v.indexOf(w)&&-1==g.indexOf(w)&&w.length&&80>=w.length&&(g[g.length]=w));q&&!C&&(v[v.length]=A)}else v[v.length]=A});if(t){y=[];if(2==c||4==c){if(y.push({min:0,max:0<
p-1?0:p-1}),4<=n)for(y.push({min:1,max:1<h-1?1:h-1}),G=2;G<n-2;G++)y.push({min:G,max:e.length-1>G?G:e.length-1})}else if(3==c){if(y.push({min:0,max:0<p-1?0:p-1}),4<=n)for(y.push({min:1,max:1<h-1?1:h-1}),G=2;G<n-2;G++)y.push({min:G,max:e.length-1})}else if(y.push({min:0,max:p-1}),4<=n)for(y.push({min:1,max:h-1}),G=2;G<n-2;G++)y.push({min:G,max:e.length-1});b(y,function(C){for(var N=e.slice(),A="",w={},f=0;f<C.length;f++){if(f&&C[f]<=C[f-1])return;N[C[f]]="";if(w[e[C[f]]])return;w[e[C[f]]]=1;A=A?A+
(" "+e[C[f]]):e[C[f]]}if((4!=c||""===N.join(""))&&A)for(C=0;C<t.length;C++)z[C].test(A)||(N=A+" "+t[C],-1==r.indexOf(N)&&-1==v.indexOf(N)&&-1==g.indexOf(N)&&A.length&&80>=A.length&&(v[v.length]=N))})}}if(r.length||v.length||g.length||a.length)return[r,g,v,a]}}}
function checkSaveFile(a,d,c){if(1E7<=d.length){var n=DriveApp.getFileById(a.getId());try{FileLength=c?n.getBlob().getBytes().length:n.getBlob().getDataAsString().length}catch(q){a="";var t=n.getParents();t.hasNext()&&(a=t.next().getName()+"/");throw Error("found not correct saved "+(c?"binary":"text")+" file data in checkSaveFile for "+a+n.getName()+", Error: "+q.message);}if(FileLength!=d.length)throw a="",t=n.getParents(),t.hasNext()&&(a=t.next().getName()+"/"),Error("found not correct saved "+
(c?"binary":"text")+" file data in checkSaveFile for "+a+n.getName()+", correct Data Size: "+d.length+", not correct fileSize: "+FileLength);return a}for(t=0;;){n=DriveApp.getFileById(a.getId());try{FileLength=c?n.getBlob().getBytes().length:n.getBlob().getDataAsString().length}catch(q){throw a="",t=n.getParents(),t.hasNext()&&(a=t.next().getName()+"/"),c=c?"binary":"text",Error("found not correct saved "+c+" file data in checkSaveFile for "+a+n.getName()+", Error: "+q.message);}if(FileLength!=d.length)n.setContent(d);
else break;t++;if(10<t)throw a="",t=n.getParents(),t.hasNext()&&(a=t.next().getName()+"/"),c=c?"binary":"text",Error("found not correct saved "+c+" file data in checkSaveFile for "+a+n.getName()+", correct Data Size: "+d.length+", not correct fileSize: "+FileLength);}return n}
function deleteOrRemoveFile(a,d){try{a.setTrashed(!0)}catch(n){var c=0;if("undefined"!=typeof GLtrashedfolder&&GLtrashedfolder)try{a.moveTo(GLtrashedfolder)}catch(t){c=1}else c=1;if(c)for(c=a.getParents();c.hasNext();)c.next().removeFile(a)}d||Utilities.sleep(300)}
function JSONparsestringifyStopInit(){this.JSON&&(this.JSON.oldstringify&&this.JSON.stringify&&(this.JSON.stringify=this.JSON.oldstringify,delete this.JSON.oldstringify),this.JSON.oldparse&&this.JSON.parse&&(this.JSON.parse=this.JSON.oldparse,delete this.JSON.oldparse))}
function JSONparsestringifyInit(){this.JSON&&"[object JSON]"=={}.toString.call(this.JSON)||(this.JSON={});(function(a){function d(t){return c.test(t)?'"'+t.replace(c,function(q){var h=n[q];return"string"===typeof h?h:"\\u"+("0000"+q.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+t+'"'}var c=/[\\"\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};
a.JSON.oldstringify=a.JSON.stringify;a.JSON.stringify=function(t){var q=typeof t;if("object"==q&&t){var h,b=[],m=t&&t.constructor==Array;for(h in t){var p=t[h];q={}.toString.call(p);switch(q){case "[object String]":p=d(p);break;case "[object Number]":p=isFinite(p)?String(p):"null";break;case "[object Date]":p='new Date("'+p.toString()+'")';break;case "[object RegExp]":case "[object Function]":p=p.toString();break;case "[object Array]":case "[object Object]":p=JSON.stringify(p);break;default:p=String(p)}b.push((m?
"":'"'+h+'":')+p)}return(m?"[":"{")+String(b)+(m?"]":"}")}switch(q){case "string":return d(t);case "number":return isFinite(t)?String(t):"null";default:return String(t)}};a.JSON.oldparse=a.JSON.parse;a.JSON.parse=function(t){return eval("("+t+")")}})(this)};



Контейнер SSMFD 1 (конец)


==========================================================================================================


Копирование настроек кампаний





//копировать настройки кампании
var Id = '276-912-2293';

//если непусто и раскомментировано, то копировать из кампании 0 (SourceGasID) в ее дополнительные кампании
//var SourceGasID = 'vinkodcomua.feed.id0';

//если нет SourceGasID, то копируем из одной в другую кампанию с жестко заданными названиями
var SourceName = 'vinkodcomua_old.feed.id0.0. MCLSET1:2:0.3';
var TargetName = 'vinkodcomua.feed.id0.0. MCLSET1:2:0.3';


//код ниже сжимаем


function main() {
	MccApp.accounts().withIds([Id]).executeInParallel('TestScript'); 
}
     
function TestScript() {


	if ((typeof SourceGasID == 'string')&&SourceGasID) {
		copyGasID(SourceGasID);
	} else {
		if (((typeof SourceName == 'string')&&SourceName)&&((typeof TargetName == 'string')&&TargetName))
			copySourceToTarget(SourceName,TargetName);
	}


}




function copySourceToTarget(SourceName,TargetName) {

					if (TargetName == SourceName) {
						Logger.log('Campaigns Names equal. Stopped. Return');
						return;
					}

					var caIter = AdWordsApp.campaigns()
						.withCondition("CampaignName = '" + SourceName.replace(/\'/gm, '\\\'') + "'")
						.withCondition('CampaignStatus != REMOVED')
						.withCondition("CampaignTrialType IN ['BASE']")
						.get();

					if (caIter.hasNext()) {
						var Scampaign = caIter.next();

						var ScampaignId = Scampaign.getId();
						var ScampaignName = Scampaign.getName();
					} else {
						Logger.log('Campaign ' + SourceName +  ' not exist. Stopped. Return');
						return;

					}


					var caIter = AdWordsApp.campaigns()
						.withCondition("CampaignName = '" + TargetName.replace(/\'/gm, '\\\'') + "'")
						.withCondition('CampaignStatus != REMOVED')
						.withCondition("CampaignTrialType IN ['BASE']")
						.get();

					if (caIter.hasNext()) {
						var Tcampaign = caIter.next();

						var TcampaignId = Tcampaign.getId();
						var TcampaignName = Tcampaign.getName();
					} else {
						Logger.log('Campaign ' + TargetName +  ' not exist. Stopped. Return');
						return;

					}


					var err = CopyCampaignSettings(Scampaign,Tcampaign)
					if (err) {
						Logger.log('Campaign ' + TargetName +  " have errors when copy audiences:\n" + err);
						return;
					}
					Logger.log('Campaign Settings copy from ' + SourceName + ' to ' + TargetName);
					Logger.log('Ok');

}




function copyGasID(SourceGasID) {

//копирование в пределах одной кампании
//скрипт не проверяет активность кампаний, сразу копирует настройки из основной в остальные

var ScanCreateFeedsGlobalVars = {}

ScanCreateFeedsGlobalVars.GASearchCampaigns = {}

var feed_id = 'id0';
ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id] = []




					var caIter = AdWordsApp.campaigns()
						.withCondition("CampaignName CONTAINS '" + SourceGasID.replace(/\'/gm, '\\\'') + '.' + "'")
						.withCondition('CampaignStatus != REMOVED')
						.withCondition("CampaignTrialType IN ['BASE']")
						.get();


					while (caIter.hasNext()) {
						var campaign = caIter.next();

						var campaignId = campaign.getId();
						var campaignName = campaign.getName();


  						var match = campaignName.match(new RegExp('(?:^|\\s)' + escapeRegExp(SourceGasID) + '\\.(\\d+)\\.'));
						if (match&&match[1]) {
							//подходит под шаблон названия кампании

							var canum = Number(match[1])

							var agNum = campaign.adGroups().withCondition('CampaignStatus != REMOVED').withCondition('AdGroupStatus != REMOVED').get().totalNumEntities();


							if (!ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][canum]) {

								ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][canum] = [campaign,agNum];

								if (!canum) {
									//для кампании 0 ставим или проверяем подробное круглосуточное расписание
									SetCampaignadSchedules(campaign);
								}


							} else {

								Logger.log('Campaign (' + canum +  ') with GASearch Id ' + SourceGasID + " have duplicate company name in account. Stopped. Return\n");
								return;

								//надо все остановить, здесь однозначно непонятно, что наковыряли
								//ScanCreateFeedsGlobalVars.errors += 'Campaign (' + canum +  ') with GASearch Id ' + SourceGasID + " have duplicate company name in account\n";
								//Logger.log(ScanCreateFeedsGlobalVars.errors);
							}

						} else {


							//короче здесь ничего не делаем - может быть совсем другая кампания, а мы ее удалим
							//выдаем только предупреждение в лог
							Logger.log('Campaign have Name: ' + campaignName + " similar with GASearch Id: ' + SourceGasID + '. Better change this name. Stopped. Return\n");

							return;


						}

					}



						if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0]) {
							//если была/появилась базовая кампания 0, то
							//копируем в остальные кампании фида
								for (var ii = 1; ii < ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id].length; ii++) {
									if (ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii]) {
											var err = CopyCampaignSettings(ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0][0],ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][ii][0])
											if (err) {
												Logger.log('Campaign (' + ii +  ') with GASearch Id ' + SourceGasID + " have errors when copy audiences:\n" + err);
											} else {
												Logger.log('In campaign (' + ii +  ') with GASearch Id ' + SourceGasID + " set settings from campaign (0)\n");
											}
									}
								}
						} else {

							Logger.log('Campaign (0) with GASearch Id ' + SourceGasID + " not exist. Stopped. Return\n");
							return;

						}

					Logger.log('Campaign Settings copy from ' + ScanCreateFeedsGlobalVars.GASearchCampaigns[feed_id][0][0].getName());
					Logger.log('Ok');


}


function SetCampaignadSchedules(campaign) {
//при создании кампании 0 устанавливаем ей подробное круглосуточное расписание каждый день по всем часам, что бы можно было потом легко управлять


	var adScheduleIterator = campaign.targeting().adSchedules().get();
	if (adScheduleIterator.hasNext()) {
		//есть расписание
		return;
	}


	var weekday = new Array(7);
	weekday[0] = "SUNDAY";
	weekday[1] = "MONDAY";
	weekday[2] = "TUESDAY";
	weekday[3] = "WEDNESDAY";
	weekday[4] = "THURSDAY";
	weekday[5] = "FRIDAY";
	weekday[6] = "SATURDAY";



	for (var i = 0; i < weekday.length; i++) {
//не больше 6 периодов в сутки может быть, делаем каждые 4 часа
		for (var ii = 0; ii < 6; ii++) {
			campaign.addAdSchedule({
			   dayOfWeek: weekday[i],
			   startHour: ii*4,
			   startMinute: 0,
			   endHour: ii*4 + 4,
			   endMinute: 0,
			   bidModifier: 1
			 });
		}
	}


}

//https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions
//строка экранирования символов
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
}


function CopyCampaignSettings(SourceCampaign,campaign) {
//копируем настройки кампании 0 в другую кампанию (новую или остановленную)
//все настройки, кроме языков и ставки, если есть она

	var errors = '';

	var targeting = SourceCampaign.targeting();
	var campaigntargeting = campaign.targeting();


        var scheduleIter = campaigntargeting.adSchedules().get();
	while (scheduleIter.hasNext()) {
		var schedule = scheduleIter.next();
		schedule.remove();
	}
	var scheduleIter = targeting.adSchedules().get();
	while (scheduleIter.hasNext()) {
		var schedule = scheduleIter.next();
		campaign.addAdSchedule(schedule);
	}



//к сожалению невозможно установить/скопировать "Люди из целевых местоположений"
        var locationIter = campaigntargeting.targetedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		location.remove();
	}
	var locationIter = targeting.targetedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		campaign.addLocation(location);
	}


	var locationIter = campaigntargeting.excludedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		location.remove();
	}
	var locationIter = targeting.excludedLocations().get();
	while (locationIter.hasNext()) {
		var location = locationIter.next();
		campaign.excludeLocation(location);
	}


	var proximityIter = campaigntargeting.targetedProximities().get();
	while (proximityIter.hasNext()) {
		var proximity = proximityIter.next();
		proximity.remove();
	}
	var proximityIter = targeting.targetedProximities().get();
	while (proximityIter.hasNext()) {
		var proximity = proximityIter.next();
		campaign.addProximity(proximity);
	}



        var platformIter = targeting.platforms().get();
	var platformBid = {};
	while (platformIter.hasNext()) {
		var platform = platformIter.next();
		var BidModifier = platform.getBidModifier();
		var Name = platform.getName();
		platformBid[Name] = BidModifier;
	}
	var platformIter = campaigntargeting.platforms().get();
	while (platformIter.hasNext()) {
		var platform = platformIter.next();
		var Name = platform.getName();
		if (platformBid.hasOwnProperty(Name)) {
			platform.setBidModifier(platformBid[Name]);
		} else {
			platform.setBidModifier(0);
		}												
	}



	campaign.setAdRotationType(SourceCampaign.getAdRotationType())


	var budget = SourceCampaign.getBudget().getAmount();
	if (campaign.getBudget().getAmount() != budget)
		campaign.getBudget().setAmount(budget)



	var Strategy = SourceCampaign.bidding().getStrategy();
	if (!Strategy) {
		//это не гибкая стратегия, а анонимная
		var Strategy = SourceCampaign.bidding().getStrategyType();
		if (Strategy) {
			try {
				campaign.bidding().setStrategy(Strategy);
			} catch(e) {
				//эта анонимная стратегия здесь не может быть установлена, применяем что-то стандартное TARGET_SPEND или MANUAL_CPC
				campaign.bidding().setStrategy("MANUAL_CPC");
			}
		} else {
			campaign.bidding().setStrategy("MANUAL_CPC");
		}
	} else {
		campaign.bidding().setStrategy(Strategy);
	}


	var sEndDate = SourceCampaign.getEndDate();
	var caEndDate = campaign.getEndDate();
	if (JSON.stringify(sEndDate) != JSON.stringify(caEndDate)) {
		if (sEndDate === null) {
			//null - поэтому делаем максимум
			campaign.setEndDate("20371230");
		} else {
			var now = getcurrentTime();
			var todayAtMidn = new Date(now.getFullYear(), now.getMonth(), now.getDate());
			var EndDate = awDateToDate(sEndDate);
			if (EndDate.getTime() < todayAtMidn.getTime()) {
				//нельзя устанавливать дату меньше сегодняшней - выдаст ошибку
				campaign.setEndDate(DateToawDate(todayAtMidn));
			} else {
				campaign.setEndDate(sEndDate);
			}
		}
	}


	var campaignextensions = campaign.extensions();
	var extensions = SourceCampaign.extensions();


	//уточнения
	var CampaignCalloutIter = campaignextensions.callouts().get()
	while (CampaignCalloutIter.hasNext()) {
		var CampaignCallout = CampaignCalloutIter.next();
		campaign.removeCallout(CampaignCallout);
	}
	var CampaignCalloutIter = extensions.callouts().get()
	while (CampaignCalloutIter.hasNext()) {
		var CampaignCallout = CampaignCalloutIter.next();
		campaign.addCallout(CampaignCallout)  
	}



	var PhoneNumberIter = campaignextensions.phoneNumbers().get()
	while (PhoneNumberIter.hasNext()) {
		var PhoneNumber = PhoneNumberIter.next();
		campaign.removePhoneNumber(PhoneNumber);
	}
	var PhoneNumberIter = extensions.phoneNumbers().get()
	while (PhoneNumberIter.hasNext()) {
		var PhoneNumber = PhoneNumberIter.next();
		campaign.addPhoneNumber(PhoneNumber)  
	}
										


	var MobileAppIter = campaignextensions.mobileApps().get()
	while (MobileAppIter.hasNext()) {
		var MobileApp = MobileAppIter.next();
		campaign.removeMobileApp(MobileApp);
	}
	var MobileAppIter = extensions.mobileApps().get()
	while (MobileAppIter.hasNext()) {
		var MobileApp = MobileAppIter.next();
		campaign.addMobileApp(MobileApp)  
	}



	var CampaignSitelinkIter = campaignextensions.sitelinks().get()
	while (CampaignSitelinkIter.hasNext()) {
		var CampaignSitelink = CampaignSitelinkIter.next();
		campaign.removeSitelink(CampaignSitelink);
	}
	var CampaignSitelinkIter = extensions.sitelinks().get()
	while (CampaignSitelinkIter.hasNext()) {
		var CampaignSitelink = CampaignSitelinkIter.next();
		campaign.addSitelink(CampaignSitelink)  
	}


	//структурированные описания
	var CampaignSnippetIter = campaignextensions.snippets().get()
	while (CampaignSnippetIter.hasNext()) {
		var CampaignSnippet = CampaignSnippetIter.next();
		campaign.removeSnippet(CampaignSnippet);
	}
	var CampaignSnippetIter = extensions.snippets().get()
	while (CampaignSnippetIter.hasNext()) {
		var CampaignSnippet = CampaignSnippetIter.next();
		campaign.addSnippet(CampaignSnippet)  
	}



	var negativeKeywordListIterator = campaign.negativeKeywordLists().get();
	while (negativeKeywordListIterator.hasNext()) {
		var negativeKeywordList = negativeKeywordListIterator.next();
		campaign.removeNegativeKeywordList(negativeKeywordList);
	}
	var negativeKeywordListIterator = SourceCampaign.negativeKeywordLists().get();
	while (negativeKeywordListIterator.hasNext()) {
		var negativeKeywordList = negativeKeywordListIterator.next();
		campaign.addNegativeKeywordList(negativeKeywordList);
	}



	var ExcludedPlacementListIterator = campaign.excludedPlacementLists().get();
	while (ExcludedPlacementListIterator.hasNext()) {
		var ExcludedPlacementList = ExcludedPlacementListIterator.next();
		campaign.removeExcludedPlacementList(ExcludedPlacementList);
	}
	var ExcludedPlacementListIterator = SourceCampaign.excludedPlacementLists().get();
	while (ExcludedPlacementListIterator.hasNext()) {
		var ExcludedPlacementList = ExcludedPlacementListIterator.next();
		campaign.addExcludedPlacementList(ExcludedPlacementList);
	}


//нашел скрипт для копирования аудиторий https://www.brainlabsdigital.com/copy-audiences-to-campaigns/
//https://searchengineland.com/heres-script-copies-audiences-campaigns-271089
//кое-что взял оттуда
	var Audiences = campaigntargeting.audiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		var AudienceType = audience.getAudienceType()
		//выдает ошибку при копировании "внутренних" аудиторий, только можно из общей библиотеки
		if (AudienceType == 'USER_INTEREST') continue;
		audience.remove()
	}
	var Audiences = campaigntargeting.excludedAudiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		audience.remove()
	}

	var targetingSetting = targeting.getTargetingSetting("USER_INTEREST_AND_LIST");
	campaigntargeting.setTargetingSetting("USER_INTEREST_AND_LIST", targetingSetting);

	var Audiences = targeting.audiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		var audienceId = audience.getAudienceId()
		var BidModifier = audience.bidding().getBidModifier()
		var AudienceType = audience.getAudienceType()
		//выдает ошибку при копировании "внутренних" аудиторий, только можно из общей библиотеки
		if (AudienceType == 'USER_INTEREST') continue;
	
		var audienceBuilder = campaigntargeting.newUserListBuilder()
		.withAudienceId(audienceId)
		.withBidModifier(BidModifier)
		.build()

		if (audienceBuilder.isSuccessful()) {
			var campaignaudience = audienceBuilder.getResult();
		} else {
			errors += audienceBuilder.getErrors() + "\n";
		}
	}
	var Audiences = targeting.excludedAudiences().get();
	while (Audiences.hasNext()) {
		var audience = Audiences.next();
		var audienceId = audience.getAudienceId()

		var audienceBuilder = campaigntargeting.newUserListBuilder()
		.withAudienceId(audienceId)
		.exclude()

		if (audienceBuilder.isSuccessful()) {
			var campaignaudience = audienceBuilder.getResult();
		} else {
			errors += audienceBuilder.getErrors() + "\n";
		}
	}

	return errors;

}

function floorN(x, n) {
	x = parseFloat(x);
	return parseFloat(x.toFixed(n));
}

function getcurrentTime() {
	var now = new Date(Utilities.formatDate(new Date(),
		AdWordsApp.currentAccount().getTimeZone(), "MMM dd,yyyy HH:mm:ss"));
	var today = new Date(now.getTime());
	return today;
}

function awDateToDate(awDate) {
	return new Date(awDate.year,
		floorN(awDate.month, 0) - 1,
		awDate.day, 0, 0, 0);
}


function DateToawDate(Date) {
	return {
		year: Date.getFullYear(),
		month: floorN(Date.getMonth(), 0) + 1,
		day: Date.getDate()
	};
}




Контейнер CAMP CP


//копировать настройки кампании
var Id = '276-912-2293';

//если непусто и раскомментировано, то копировать из кампании 0 (SourceGasID) в ее дополнительные кампании
//var SourceGasID = 'vinkodcomua.feed.id0';

//если нет SourceGasID, то копируем из одной в другую кампанию с жестко заданными названиями
//var SourceName = 'vinkodcomua_old.feed.id0.0. MCLSET1:2:0.3';
//var TargetName = 'vinkodcomua.feed.id0.0. MCLSET1:2:0.3';




function main(){MccApp.accounts().withIds([Id]).executeInParallel("TestScript")}function TestScript(){"string"==typeof SourceGasID&&SourceGasID?copyGasID(SourceGasID):"string"==typeof SourceName&&SourceName&&"string"==typeof TargetName&&TargetName&&copySourceToTarget(SourceName,TargetName)}
function copySourceToTarget(e,c){if(c==e)Logger.log("Campaigns Names equal. Stopped. Return");else{var f=AdWordsApp.campaigns().withCondition("CampaignName = '"+e.replace(/'/gm,"\\'")+"'").withCondition("CampaignStatus != REMOVED").withCondition("CampaignTrialType IN ['BASE']").get();if(f.hasNext()){var g=f.next();g.getId();g.getName();f=AdWordsApp.campaigns().withCondition("CampaignName = '"+c.replace(/'/gm,"\\'")+"'").withCondition("CampaignStatus != REMOVED").withCondition("CampaignTrialType IN ['BASE']").get();
f.hasNext()?(f=f.next(),f.getId(),f.getName(),(g=CopyCampaignSettings(g,f))?Logger.log("Campaign "+c+" have errors when copy audiences:\n"+g):(Logger.log("Campaign Settings copy from "+e+" to "+c),Logger.log("Ok"))):Logger.log("Campaign "+c+" not exist. Stopped. Return")}else Logger.log("Campaign "+e+" not exist. Stopped. Return")}}
function copyGasID(e){var c={id0:[]};for(var f=AdWordsApp.campaigns().withCondition("CampaignName CONTAINS '"+e.replace(/'/gm,"\\'")+".'").withCondition("CampaignStatus != REMOVED").withCondition("CampaignTrialType IN ['BASE']").get();f.hasNext();){var g=f.next();g.getId();var k=g.getName(),a=k.match(new RegExp("(?:^|\\s)"+escapeRegExp(e)+"\\.(\\d+)\\."));if(a&&a[1]){k=Number(a[1]);a=g.adGroups().withCondition("CampaignStatus != REMOVED").withCondition("AdGroupStatus != REMOVED").get().totalNumEntities();
if(c.id0[k]){Logger.log("Campaign ("+k+") with GASearch Id "+e+" have duplicate company name in account. Stopped. Return\n");return}c.id0[k]=[g,a];k||SetCampaignadSchedules(g)}else{Logger.log("Campaign have Name: "+k+" similar with GASearch Id: ' + SourceGasID + '. Better change this name. Stopped. Return\n");return}}if(c.id0[0]){for(f=1;f<c.id0.length;f++)c.id0[f]&&((g=CopyCampaignSettings(c.id0[0][0],c.id0[f][0]))?Logger.log("Campaign ("+f+") with GASearch Id "+e+" have errors when copy audiences:\n"+
g):Logger.log("In campaign ("+f+") with GASearch Id "+e+" set settings from campaign (0)\n"));Logger.log("Campaign Settings copy from "+c.id0[0][0].getName());Logger.log("Ok")}else Logger.log("Campaign (0) with GASearch Id "+e+" not exist. Stopped. Return\n")}
function SetCampaignadSchedules(e){if(!e.targeting().adSchedules().get().hasNext()){var c=Array(7);c[0]="SUNDAY";c[1]="MONDAY";c[2]="TUESDAY";c[3]="WEDNESDAY";c[4]="THURSDAY";c[5]="FRIDAY";c[6]="SATURDAY";for(var f=0;f<c.length;f++)for(var g=0;6>g;g++)e.addAdSchedule({dayOfWeek:c[f],startHour:4*g,startMinute:0,endHour:4*g+4,endMinute:0,bidModifier:1})}}function escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}
function CopyCampaignSettings(e,c){for(var f="",g=e.targeting(),k=c.targeting(),a=k.adSchedules().get();a.hasNext();){var b=a.next();b.remove()}for(a=g.adSchedules().get();a.hasNext();)b=a.next(),c.addAdSchedule(b);for(a=k.targetedLocations().get();a.hasNext();)b=a.next(),b.remove();for(a=g.targetedLocations().get();a.hasNext();)b=a.next(),c.addLocation(b);for(a=k.excludedLocations().get();a.hasNext();)b=a.next(),b.remove();for(a=g.excludedLocations().get();a.hasNext();)b=a.next(),c.excludeLocation(b);
for(a=k.targetedProximities().get();a.hasNext();)b=a.next(),b.remove();for(a=g.targetedProximities().get();a.hasNext();)b=a.next(),c.addProximity(b);b=g.platforms().get();for(var d={};b.hasNext();){var h=b.next();a=h.getBidModifier();var l=h.getName();d[l]=a}for(b=k.platforms().get();b.hasNext();)h=b.next(),l=h.getName(),d.hasOwnProperty(l)?h.setBidModifier(d[l]):h.setBidModifier(0);c.setAdRotationType(e.getAdRotationType());a=e.getBudget().getAmount();c.getBudget().getAmount()!=a&&c.getBudget().setAmount(a);
if(a=e.bidding().getStrategy())c.bidding().setStrategy(a);else if(a=e.bidding().getStrategyType())try{c.bidding().setStrategy(a)}catch(m){c.bidding().setStrategy("MANUAL_CPC")}else c.bidding().setStrategy("MANUAL_CPC");a=e.getEndDate();b=c.getEndDate();JSON.stringify(a)!=JSON.stringify(b)&&(null===a?c.setEndDate("20371230"):(b=getcurrentTime(),b=new Date(b.getFullYear(),b.getMonth(),b.getDate()),awDateToDate(a).getTime()<b.getTime()?c.setEndDate(DateToawDate(b)):c.setEndDate(a)));b=c.extensions();
a=e.extensions();for(d=b.callouts().get();d.hasNext();)h=d.next(),c.removeCallout(h);for(d=a.callouts().get();d.hasNext();)h=d.next(),c.addCallout(h);for(d=b.phoneNumbers().get();d.hasNext();)h=d.next(),c.removePhoneNumber(h);for(d=a.phoneNumbers().get();d.hasNext();)h=d.next(),c.addPhoneNumber(h);for(d=b.mobileApps().get();d.hasNext();)h=d.next(),c.removeMobileApp(h);for(d=a.mobileApps().get();d.hasNext();)h=d.next(),c.addMobileApp(h);for(d=b.sitelinks().get();d.hasNext();)h=d.next(),c.removeSitelink(h);
for(d=a.sitelinks().get();d.hasNext();)h=d.next(),c.addSitelink(h);for(b=b.snippets().get();b.hasNext();)d=b.next(),c.removeSnippet(d);for(b=a.snippets().get();b.hasNext();)d=b.next(),c.addSnippet(d);for(a=c.negativeKeywordLists().get();a.hasNext();)b=a.next(),c.removeNegativeKeywordList(b);for(a=e.negativeKeywordLists().get();a.hasNext();)b=a.next(),c.addNegativeKeywordList(b);for(a=c.excludedPlacementLists().get();a.hasNext();)b=a.next(),c.removeExcludedPlacementList(b);for(a=e.excludedPlacementLists().get();a.hasNext();)b=
a.next(),c.addExcludedPlacementList(b);for(b=k.audiences().get();b.hasNext();)d=b.next(),h=d.getAudienceType(),"USER_INTEREST"!=h&&d.remove();for(b=k.excludedAudiences().get();b.hasNext();)d=b.next(),d.remove();a=g.getTargetingSetting("USER_INTEREST_AND_LIST");k.setTargetingSetting("USER_INTEREST_AND_LIST",a);for(b=g.audiences().get();b.hasNext();)d=b.next(),l=d.getAudienceId(),a=d.bidding().getBidModifier(),h=d.getAudienceType(),"USER_INTEREST"!=h&&(a=k.newUserListBuilder().withAudienceId(l).withBidModifier(a).build(),
a.isSuccessful()?a.getResult():f+=a.getErrors()+"\n");for(b=g.excludedAudiences().get();b.hasNext();)d=b.next(),l=d.getAudienceId(),a=k.newUserListBuilder().withAudienceId(l).exclude(),a.isSuccessful()?a.getResult():f+=a.getErrors()+"\n";return f}function floorN(e,c){e=parseFloat(e);return parseFloat(e.toFixed(c))}function getcurrentTime(){var e=new Date(Utilities.formatDate(new Date,AdWordsApp.currentAccount().getTimeZone(),"MMM dd,yyyy HH:mm:ss"));return new Date(e.getTime())}
function awDateToDate(e){return new Date(e.year,floorN(e.month,0)-1,e.day,0,0,0)}function DateToawDate(e){return{year:e.getFullYear(),month:floorN(e.getMonth(),0)+1,day:e.getDate()}};



Контейнер CAMP CP (конец)
